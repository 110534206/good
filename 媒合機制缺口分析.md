# 媒合機制四階段流程 — 缺口分析

> 對照「第一階段：廠商初步排序與勾選 → 第二階段：系統自動衝突偵測 → 第三階段：主任審核與手動調度 → 第四階段：廠商媒合最後確認 → 科助最後確認即公告」的理想流程，整理**目前已有**與**仍缺少**的項目。

---

## 一、各階段對照表

| 階段 | 理想流程 | 目前已有 | 仍缺少 |
|------|----------|----------|--------|
| **第一階段** | 廠商進入「媒合排序」頁，查看所有應徵學生；正取排序（正取 1、正取 2…）；備取勾選（新增候補，不需序位）。 | 廠商在 `vendor_review_resume` / `company_resume_review` 可做「媒合排序」，選學生並標註正取 1、2…與候補，存至 `vendor_preference_history`（`slot_index`、`is_reserve`）。 | 流程上已大致具備；可再確認「媒合排序」頁是否等同「查看所有應徵學生」且操作動線清楚。 |
| **第二階段** | 系統即時比對所有廠商送出的名單，偵測學生是否重複出現在兩家以上廠商的「正取」；彙整該生的 5 個志願序，在主任介面標示「! 衝突」。 | **無**。目前沒有「全系統正取名單比對」與「衝突學生 + 志願序彙整」。 | ① 後端 API：彙總所有廠商正取名單（依學期/職缺），找出「被多間廠商正取」的學生；② 對每位衝突學生撈取 `student_preferences`（5 個志願序）；③ 主任專用介面（或擴充現有頁面）顯示衝突清單並標示「! 衝突」與志願序。 |
| **第三階段** | 主任進入「媒合核定」介面，看到所有廠商正取名單與重複中選；手動將衝突學生判定給一家廠商，另一家正取位變「空缺」；點擊空缺可從該廠商備取名單手選遞補；名單確認無缺額後「核定發布」；系統同步通知廠商與學生，前端即時更新。 | **無**。目前沒有主任專用的「媒合核定」頁，也沒有「空缺」「備取遞補」「核定發布」的狀態與流程。 | ① 主任「媒合核定」頁：總表顯示各廠商正取/備取名單、衝突學生、空缺位；② 解決衝突：主任將衝突學生判定給 A 廠商後，B 廠商該正取位改為「空缺」；③ 備取遞補：點擊空缺 → 彈出該廠商備取名單 → 主任選一人遞補為正取，畫面即時更新；④ 「核定發布」按鈕：寫入核定狀態（或鎖定名單），觸發通知（廠商+學生），前端可依此狀態顯示「已核定」結果。 |
| **第四階段** | 廠商點「媒合確認」→ 彈出彙整視窗（正取含順序 + 備取名單）→ 廠商「正式送出」→ 送交科助最後確認 → 科助確認後公告。 | 廠商有「媒合結果」頁（`confirm_matching`），可看到已審核通過的學生並「確認媒合結果」，會直接呼叫 `record_admission` 寫入 `internship_offers`。科助/老師有 `final_results` 可看媒合結果與正取/候補。 | ① **送交科助**：廠商「正式送出」後，資料應先進入「待科助確認」狀態，而非直接寫入 `internship_offers`；② **科助最後確認即公告**：科助在專用頁（可擴充 `final_results`）確認名單無誤後，執行「確認即公告」→ 此時才寫入錄取、發送媒合成功通知給廠商與學生，並可同步更新公告或前端結果頁。 |
| **狀態與資料** | 媒合流程有明確狀態：廠商已送出 → 待主任核定 → 主任已核定（含衝突處理）→ 待科助公告 → 科助已公告。 | 目前 `vendor_preference_history` 存正取/候補，`internship_offers` 在廠商確認後即寫入；沒有「待主任核定」「待科助公告」等中間狀態。 | ① 新增或沿用表欄位記錄「媒合狀態」（例如：廠商已送出、主任已核定、科助已公告）；② 僅在「科助已公告」時才寫入 `internship_offers` 並發通知，或保留現行寫入時機但以狀態控制「是否對學生/廠商顯示為正式結果」。 |

---

## 二、建議優先補齊項目

1. **第二階段**：衝突偵測 API + 主任介面顯示衝突學生與 5 個志願序。
2. **第三階段**：主任「媒合核定」頁（總表、衝突處理、空缺、備取遞補、核定發布、通知）。
3. **第四階段**：廠商「正式送出」改為送交科助；科助「最後確認即公告」後才寫入錄取／發通知／更新前端。
4. **資料/狀態**：媒合狀態欄位與流程一致（廠商送出 → 主任核定 → 科助公告）。

---

## 三、與系統功能統整的對應

- 本文件內容可併入 `系統功能統整.md` 的 **5.3 媒合機制** 底下，作為「5.3.1 媒合機制四階段流程缺口分析」小節。
- 實作時可與 5.3 表格中的「錄取時帶入志願序」「重複錄取檢查」「志願序與錄取結果對應顯示」等一併規劃。

---

## 四、規劃與實作建議（依你的要求）

### 4.1 規劃階段（先做再寫程式）

| 項目 | 內容 |
|------|------|
| **1. 媒合狀態定義** | 定義單一來源的「媒合流程狀態」，建議：`draft`（廠商僅存排序，未送出）→ `vendor_submitted`（廠商已正式送出）→ `director_approved`（主任已核定，含衝突處理與備取遞補）→ `ta_published`（科助已公告，此時才寫入錄取並發通知）。 |
| **2. 資料要存哪裡** | ① **狀態存哪**：可新增表 `matching_round` 或 `matching_session`（學期、狀態、送出/核定/公告時間）；或先在既有表加欄位（例如某筆「代表本學期媒合」的設定）。② **空缺與遞補**：主任把衝突學生判給 A 後，B 的正取位要能標為「空缺」、之後從 B 的備取選一人遞補；需能區分「正取／空缺／已遞補」並可依廠商+職缺+序位更新。③ **誰已送出**：要能查「哪些廠商已按正式送出」，方便主任/科助只看已送出的名單。 |
| **3. API 清單（後端）** | ① 廠商「正式送出」：將狀態改為 `vendor_submitted`（不呼叫 `record_admission`）。② 衝突偵測：彙總所有已送出廠商的正取名單，回傳「衝突學生列表 + 每人 5 個志願序」。③ 主任「媒合核定」：取得總表（各廠商正取/備取/空缺）、解決衝突（指定學生歸屬廠商、另一家該位變空缺）、備取遞補（指定空缺由某備取遞補）、核定發布（狀態改為 `director_approved`）。④ 科助「確認即公告」：狀態改為 `ta_published`，批次寫入 `internship_offers`、發送媒合成功通知給廠商與學生。⑤ 查詢：主任/科助可查當前狀態、總表、衝突列表。 |
| **4. 頁面與權限** | ① **廠商**：現有「媒合排序」+「媒合確認」；「確認」改為彈出正取/備取彙整 → 「正式送出」只改狀態、不寫錄取。② **主任**：新增「媒合核定」頁（總表、衝突警示、空缺、備取遞補、核定發布）。③ **科助**：擴充「媒合結果確認」頁（`final_results`），增加「待科助公告」名單與「確認即公告」按鈕。 |
| **5. 與現有流程的銜接** | 現行廠商「確認媒合結果」會直接 `record_admission`；改為新流程後，只有在科助「確認即公告」時才寫入 `internship_offers` 並發通知。若希望過渡期並存，可用「媒合狀態」判斷：未啟用新流程時維持原樣；啟用後一律走「廠商送出 → 主任核定 → 科助公告」。 |

---

### 4.2 實作分波建議（建議順序）

| 波次 | 目標 | 具體工作 | 產出 |
|------|------|----------|------|
| **第一波** | 資料與狀態、廠商「正式送出」不寫錄取 | ① 新增媒合狀態儲存（表或欄位），預設為 draft。② 廠商「正式送出」API：僅更新狀態為 vendor_submitted（不呼叫 record_admission）。③ 廠商「媒合確認」頁：按鈕改為「正式送出」、送交後顯示「已送交科助確認」等文案。 | 廠商送出後不會再直接寫入錄取；科助/主任可依狀態判斷「待處理」。 |
| **第二波** | 衝突偵測 + 主任看得到衝突與志願序 | ① 衝突偵測 API：彙總所有 vendor_submitted 廠商的正取名單（依學期），找出被 ≥2 家正取的學生；回傳每人 5 個志願序。② 主任「媒合核定」頁（僅檢視）：總表顯示各廠商正取/備取、衝突學生標示「! 衝突」與志願序。 | 主任可看到全貌與衝突，尚未能操作。 |
| **第三波** | 主任可解決衝突、空缺、備取遞補、核定發布 | ① API：解決衝突（指定學生歸屬廠商、另一家該位標為空缺）、備取遞補（指定空缺由某備取遞補）、核定發布（狀態改為 director_approved，發通知可選本波或下一波）。② 主任「媒合核定」頁：衝突處理按鈕、點擊空缺選備取遞補、「核定發布」按鈕。 | 主任可完成手動調度與核定。 |
| **第四波** | 科助「確認即公告」+ 寫入錄取與通知 | ① API：科助「確認即公告」→ 狀態改為 ta_published，依核定名單批次寫入 internship_offers（或呼叫既有 record_admission 邏輯），發送媒合成功通知給廠商與學生。② 科助「媒合結果確認」頁：顯示待公告名單、「確認即公告」按鈕、公告後更新畫面。 | 完整四階段跑通；學生/廠商在公告後才看到正式結果。 |

---

### 4.3 依賴關係與建議順序（一圖看懂）

```
第一波（狀態 + 廠商送出）
    ↓
第二波（衝突偵測 + 主任總表檢視）
    ↓
第三波（主任衝突處理 + 空缺 + 備取遞補 + 核定發布）
    ↓
第四波（科助確認即公告 + 寫入錄取 + 通知）
```

- **第一波** 是基礎：沒有狀態與「廠商只送出不寫錄取」，後面無法區分「待主任核定」與「已公告」。
- **第二波** 可與第三波拆成「先只看、再操作」，或合併做，視人力而定。
- **第四波** 必須在第三波之後（主任核定後科助才能公告）。

---

### 4.4 實作檢查清單（可勾選追蹤）

- [ ] **規劃**：狀態定義、資料表/欄位、API 清單、頁面權限 已定案
- [ ] **第一波**：媒合狀態儲存、廠商「正式送出」只改狀態、廠商頁文案/按鈕
- [ ] **第二波**：衝突偵測 API、主任「媒合核定」頁（總表 + 衝突 + 志願序）
- [ ] **第三波**：解決衝突 API、空缺標示、備取遞補 API + UI、「核定發布」API + 按鈕
- [ ] **第四波**：科助「確認即公告」API、寫入錄取、發送通知、科助頁「確認即公告」按鈕
- [ ] **收尾**：學期與媒合綁定（若有多學期）、通知內容與連結、學生/廠商前端「正式結果」顯示時機
