<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>æ™ºæ…§å¯¦ç¿’å¹³å° | å¯¦ç¿’å…¬å¸å¿—é¡˜åºå¡«å¯«</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: "Noto Sans TC", sans-serif;
            background: #f7f9fc;
            margin: 0;
            padding: 0;
        }

        header {
            background: #0454a3;
            color: white;
            padding: 1rem 2rem;
            text-align: center;
            font-size: 1.5rem;
        }

        .container {
            max-width: 800px;
            margin: 2rem auto;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #004d99;
            margin-bottom: 50px;
            font-weight: 700;
            font-size: 2rem;
            border-bottom: 3px solid #1a73e8;
            display: inline-block;
            padding-bottom: 8px;
        }

        .preference-card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            padding: 20px;
            margin-bottom: 30px;
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .preference-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .card-header-rank {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #e9ecef;
        }

        .rank-number {
            font-size: 1.8rem;
            font-weight: 900;
            color: #ffffff;
            background-color: #1a73e8;
            border-radius: 0.5rem;
            padding: 5px 15px;
            margin-right: 15px;
            line-height: 1;
            box-shadow: 0 4px 10px rgba(26, 115, 232, 0.4);
        }

        .badge-remaining {
            position: absolute;
            right: 30px;
            top: 30px;
            border-radius: 50rem;
            padding: 8px 15px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .badge-remaining.bg-primary {
            background-color: #1a73e8 !important;
            color: white;
        }

        .badge-remaining.bg-secondary {
            background-color: #6c757d !important;
        }

        .form-select,
        .form-label {
            font-size: 1rem;
        }

        .form-label {
            font-weight: 600;
            color: #343a40;
            margin-bottom: 8px;
        }

        .form-select {
            border: 1px solid #ced4da;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem 0.75rem 0.75rem;
            transition: all 0.2s ease;
        }

        .form-select:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 0.25rem rgba(26, 115, 232, 0.25);
        }

        .btn {
            border-radius: 0.6rem;
            font-weight: 600;
            padding: 10px 20px;
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn-success {
            background-color: #00a651;
            border-color: #00a651;
        }

        .btn-success:hover {
            background-color: #008f45;
            border-color: #008f45;
            transform: translateY(-1px);
        }

        .btn-outline-primary {
            margin-top: 10px;
            color: #1a73e8;
            border-color: #1a73e8;
            background-color: transparent;
            padding: 8px 15px;
        }

        .btn-outline-primary:hover:not([disabled]) {
            color: white;
            background-color: #1a73e8;
        }

        .btn-outline-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <header>å¯¦ç¿’å…¬å¸å¿—é¡˜åºå¡«å¯«</header>
    <div class="container">
        {% if preview %}
        <div class="alert alert-warning text-center" role="alert" style="max-width: 900px;">
            <i class="bi bi-eye-fill me-2"></i>
            **æ‚¨ç›®å‰è™•æ–¼é è¦½æ¨¡å¼ï¼Œç„¡æ³•å„²å­˜å¿—é¡˜åºã€‚è«‹ä»¥å­¸ç”Ÿèº«ä»½ç™»å…¥ä»¥å¡«å¯«ã€‚**
        </div>
        {% endif %}

        <form id="preferencesForm" class="mx-auto" style="max-width: 900px;">

            {% for rank in range(1, 5+1) %}
            <div class="preference-card" data-rank="{{ rank }}">
                <div class="card-header-rank">
                    <span class="rank-number">{{ rank }}</span>
                    <h5 class="fw-bold m-0 p-0">ç¬¬ {{ rank }} å¿—é¡˜</h5>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label"><i class="bi bi-building me-1"></i> é¸æ“‡å…¬å¸</label>
                        <select class="form-select company-select" required
                            data-initial-company="{{ submitted.get(rank, {}).company_id or '' }}">
                            <option value="">-- è«‹é¸æ“‡å…¬å¸ --</option>
                            {% for company in companies %}
                            <option value="{{ company.id }}" {% if submitted.get(rank, {}).company_id==company.id
                                %}selected{% endif %}>
                                {{ company.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <button type="button" class="btn btn-outline-primary btn-sm download-company-btn mt-2" disabled>
                            <i class="bi bi-file-earmark-arrow-down-fill me-1"></i>ä¸‹è¼‰å…¬å¸è³‡æ–™ (DOCX)
                        </button>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><i class="bi bi-briefcase me-1"></i> é¸æ“‡è·ç¼º</label>
                        <select class="form-select job-select" required
                            data-initial-job="{{ submitted.get(rank, {}).job_id or '' }}">
                            <option value="">
                                {% if submitted.get(rank, {}).company_id %}-- è¼‰å…¥ä¸­... --{% else %}-- è«‹å…ˆé¸æ“‡å…¬å¸
                                --{% endif %}
                            </option>
                            {% if submitted.get(rank, {}).job_id %}
                            <option value="{{ submitted[rank].job_id }}" selected>{{ submitted[rank].job_title }}
                            </option>
                            {% endif %}
                        </select>
                    </div>
                </div>
                <span class="badge-remaining bg-secondary">å°šæœªé¸æ“‡å…¬å¸</span>
            </div>
            {% endfor %}

            <div class="text-center mt-5">
                {% if preview %}
                <button type="submit" class="btn btn-success px-5 py-2" disabled>
                    <i class="bi bi-lock-fill me-2"></i>ç™»å…¥å¾Œå¯å„²å­˜
                </button>
                {% else %}
                
                <button id="aiRecommendBtnNew" type="button" class="btn btn-warning px-5 py-2 me-3" style="background-color: #ffc107; border-color: #ffc107; color: #343a40;">
                    <i class="bi bi-robot me-2"></i>AI æ¨è–¦å¿—é¡˜åº
                </button>

                <button id="toggleEditBtn" type="button" class="btn btn-primary px-5 py-2 me-3">
                    <i class="bi bi-pencil-square me-2"></i>ä¿®æ”¹å¿—é¡˜åº
                </button>
                <button id="saveBtn" type="submit" class="btn btn-success px-5 py-2">
                    <i class="bi bi-save-fill me-2"></i>é€å‡ºå¿—é¡˜åº
                </button>
                {% endif %}
            </div>
        </form>
    </div>

    <div class="modal fade" id="aiPreferenceModal" tabindex="-1" aria-labelledby="aiPreferenceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aiPreferenceModalLabel"><i class="bi bi-robot me-2"></i>AI æ¨è–¦ç¯©é¸æ¢ä»¶</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3 fw-bold">è«‹é¸æ“‡æ‚¨çš„å¯¦ç¿’æ¢ä»¶ï¼ŒAI å°‡æ ¹æ“šé€™äº›æ¢ä»¶æ¨è–¦æœ€é©åˆçš„å¿—é¡˜åºï¼š</p>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="distance-filter" class="form-label">è·é›¢é è¿‘</label>
                            <select class="form-select" id="distance-filter">
                                <option selected value="any">ä¸é™è·é›¢</option>
                                <option value="close">é€šå‹¤ 30 åˆ†é˜å…§</option>
                                <option value="medium">é€šå‹¤ 1 å°æ™‚å…§</option>
                                <option value="far">è¶…é 1 å°æ™‚</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="transportation-filter" class="form-label">äº¤é€šå·¥å…·</label>
                            <select class="form-select" id="transportation-filter">
                                <option selected value="any">ä¸é™äº¤é€šæ–¹å¼</option>
                                <option value="public">å¤§çœ¾é‹è¼¸</option>
                                <option value="car">æ±½/æ©Ÿè»Š</option>
                                <option value="bike">è‡ªè¡Œè»Š/æ­¥è¡Œ</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="salary-filter" class="form-label">å¯¦ç¿’è–ªè³‡</label>
                            <select class="form-select" id="salary-filter">
                                <option selected value="any">ä¸é™è–ªè³‡</option>
                                <option value="monthly">æœˆè–ª</option>
                                <option value="hourly">æ™‚è–ª</option>
                                <option value="stipend">çé‡‘/æ´¥è²¼</option>
                                <option value="unpaid">ç„¡è–ªè³‡</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label for="system-prompt" class="form-label">ç³»çµ±æç¤ºè©ï¼ˆé¸å¡«ï¼Œæœƒå‚³çµ¦ AI ä½œç‚ºè§’è‰²èˆ‡æ ¼å¼æŒ‡ç¤ºï¼‰</label>
                        <textarea id="system-prompt" class="form-control" rows="4" placeholder="ä¾‹ï¼šä½ æ˜¯å¯¦ç¿’åª’åˆé¡§å•ã€‚è«‹æ ¹æ“šå­¸ç”Ÿå±¥æ­·èˆ‡è·é›¢/äº¤é€š/è–ªè³‡åå¥½ï¼Œå¾å¯é¸å…¬å¸è·ç¼ºä¸­ç”¢ç”Ÿæœ€å¤š 5 å€‹å¿—é¡˜ï¼Œè¼¸å‡ºåŒ…å« orderã€company_idã€job_idã€company_nameã€job_titleã€reasonï¼ˆ20-40 å­—ï¼‰ï¼Œä¸å¾—é‡è¤‡å…¬å¸æˆ–è·ç¼ºï¼Œè‹¥ç„¡åˆé©å‰‡å›å‚³ç©ºé™£åˆ—ã€‚">ä½ æ˜¯å¯¦ç¿’åª’åˆé¡§å•ã€‚è«‹æ ¹æ“šå­¸ç”Ÿå±¥æ­·èˆ‡è·é›¢/äº¤é€š/è–ªè³‡åå¥½ï¼Œå¾å¯é¸å…¬å¸è·ç¼ºä¸­ç”¢ç”Ÿæœ€å¤š 5 å€‹å¿—é¡˜ï¼Œè¼¸å‡ºåŒ…å« orderã€company_idã€job_idã€company_nameã€job_titleã€reasonï¼ˆ20-40 å­—ï¼‰ï¼Œä¸å¾—é‡è¤‡å…¬å¸æˆ–è·ç¼ºï¼Œè‹¥ç„¡åˆé©å‰‡å›å‚³ç©ºé™£åˆ—ã€‚</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" id="confirmAiPreferenceBtn" class="btn btn-warning" style="background-color: #ffc107; border-color: #ffc107; color: #343a40;">
                        <i class="bi bi-lightning-charge-fill me-2"></i>é–‹å§‹æ¨è–¦
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="application/json" id="companies-data">{{ companies | tojson | safe }}</script>
    <script type="application/json" id="submitted-data">{{ submitted | tojson | safe }}</script>
    <script type="application/json" id="preview-data">{{ preview | tojson | safe }}</script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        /* eslint-disable */
        // ... (åˆå§‹åŒ–å’Œç‹€æ…‹æ§åˆ¶ç­‰é‚è¼¯ä¿æŒä¸è®Š) ...
        const companies = JSON.parse(document.getElementById("companies-data").textContent || "[]");
        const submitted = JSON.parse(document.getElementById("submitted-data").textContent || "{}");
        const preview = JSON.parse(document.getElementById("preview-data").textContent || "false");
        const aiPreferenceModalEl = document.getElementById("aiPreferenceModal");
        const aiPreferenceModal = aiPreferenceModalEl ? new bootstrap.Modal(aiPreferenceModalEl) : null;

        const selectedJobIds = new Set();
        const companyJobsCache = {};

        async function loadJobs(companyId) {
            if (companyJobsCache[companyId]) return companyJobsCache[companyId];
            try {
                const response = await fetch(`/api/get_jobs_by_company?company_id=${companyId}`);
                const data = await response.json();
                if (data.success) {
                    companyJobsCache[companyId] = data.jobs.map(j => ({ id: String(j.id), title: j.title }));
                    return companyJobsCache[companyId];
                }
            } catch (error) { console.error(error); }
            return [];
        }

        function updateSelections() {
            const allPreferenceCards = document.querySelectorAll(".preference-card");
            selectedJobIds.clear();
            const excludedCompanyIds = new Set();

            allPreferenceCards.forEach(card => {
                const jobSelect = card.querySelector(".job-select");
                if (jobSelect.value) selectedJobIds.add(jobSelect.value);
            });

            companies.forEach(company => {
                const jobs = companyJobsCache[String(company.id)];
                if (!jobs) return;
                const selectedCount = jobs.filter(j => selectedJobIds.has(String(j.id))).length;
                if (selectedCount >= jobs.length) excludedCompanyIds.add(String(company.id));
            });

            allPreferenceCards.forEach(card => {
                const companySelect = card.querySelector(".company-select");
                const jobSelect = card.querySelector(".job-select");
                const badge = card.querySelector(".badge-remaining");
                const downloadBtn = card.querySelector(".download-company-btn");
                const selectedCompany = companySelect.value;
                const currentJobValue = jobSelect.value;

                downloadBtn.disabled = !selectedCompany;

                companySelect.innerHTML = `<option value="">-- è«‹é¸æ“‡å…¬å¸ --</option>`;
                companies.forEach(c => {
                    const cId = String(c.id);
                    if (excludedCompanyIds.has(cId) && cId !== selectedCompany) return;
                    const opt = document.createElement("option");
                    opt.value = cId; opt.textContent = c.name;
                    if (cId === selectedCompany) opt.selected = true;
                    companySelect.appendChild(opt);
                });

                const finalCompanyId = companySelect.value;
                if (finalCompanyId && companyJobsCache[finalCompanyId]) {
                    const availableJobs = companyJobsCache[finalCompanyId];
                    jobSelect.innerHTML = `<option value="">-- è«‹é¸æ“‡è·ç¼º --</option>`;
                    availableJobs.forEach(j => {
                        const isExcluded = selectedJobIds.has(String(j.id)) && String(j.id) !== currentJobValue;
                        if (!isExcluded)
                            jobSelect.innerHTML += `<option value="${j.id}" ${j.id === currentJobValue ? 'selected' : ''}>${j.title}</option>`;
                    });
                } else jobSelect.innerHTML = `<option value="">-- è«‹å…ˆé¸æ“‡å…¬å¸ --</option>`;

                if (finalCompanyId) {
                    badge.textContent = "å·²é¸æ“‡å…¬å¸";
                    badge.classList.replace("bg-secondary", "bg-primary");
                } else {
                    badge.textContent = "å°šæœªé¸æ“‡å…¬å¸";
                    badge.classList.replace("bg-primary", "bg-secondary");
                }
            });
        }

        async function initializeSubmittedPreferences() {
            const companySelects = document.querySelectorAll(".company-select");
            const loadPromises = [];
            companySelects.forEach(select => {
                const companyId = select.dataset.initialCompany;
                if (companyId) loadPromises.push(loadJobs(companyId));
            });
            companies.forEach(c => { if (!companyJobsCache[c.id]) loadPromises.push(loadJobs(c.id)); });
            await Promise.all(loadPromises);
            updateSelections();
        }

        document.querySelectorAll(".company-select").forEach(select => {
            select.addEventListener("change", async e => {
                const card = e.target.closest(".preference-card");
                const jobSelect = card.querySelector(".job-select");
                const companyId = e.target.value;
                jobSelect.innerHTML = `<option>-- è¼‰å…¥ä¸­... --</option>`;
                if (companyId) {
                    const jobs = await loadJobs(companyId);
                    jobSelect.innerHTML = jobs.length ? `<option value="">-- è«‹é¸æ“‡è·ç¼º --</option>` +
                        jobs.map(j => `<option value="${j.id}">${j.title}</option>`).join("") :
                        `<option value="">ï¼ˆç„¡å¯ç”¨è·ç¼ºï¼‰</option>`;
                } else jobSelect.innerHTML = `<option value="">-- è«‹å…ˆé¸æ“‡å…¬å¸ --</option>`;
                setTimeout(updateSelections, 100);
            });
        });

        document.querySelectorAll(".job-select").forEach(select => {
            select.addEventListener("change", updateSelections);
        });

        document.querySelectorAll(".download-company-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const companyId = btn.closest(".preference-card").querySelector(".company-select").value;
                if (companyId) window.location.href = `/api/download_company_file/${companyId}`;
            });
        });

        initializeSubmittedPreferences().then(updateSelections);

        // ---------- ç‹€æ…‹æ§åˆ¶ ----------
        let isEditing = false;
        const hasSubmitted = Object.keys(submitted || {}).length > 0;
        const saveBtn = document.getElementById("saveBtn");
        const toggleEditBtn = document.getElementById("toggleEditBtn");
        const allSelects = document.querySelectorAll(".company-select, .job-select");

        function setReadOnlyMode(readonly) {
            allSelects.forEach(sel => sel.disabled = readonly);
            document.querySelectorAll(".download-company-btn").forEach(btn => btn.disabled = readonly ? false : !btn.closest(".preference-card").querySelector(".company-select").value);
            if (readonly) {
                saveBtn.style.display = "none";
                toggleEditBtn.innerHTML = `<i class="bi bi-pencil-square me-2"></i>ä¿®æ”¹å¿—é¡˜åº`;
                toggleEditBtn.classList.replace("btn-secondary", "btn-primary");
            } else {
                saveBtn.style.display = "inline-block";
                toggleEditBtn.innerHTML = `<i class="bi bi-x-circle me-2"></i>å–æ¶ˆä¿®æ”¹`;
                toggleEditBtn.classList.replace("btn-primary", "btn-secondary");
            }
        }

        if (toggleEditBtn) {
            toggleEditBtn.addEventListener("click", () => {
                isEditing = !isEditing;
                setReadOnlyMode(!isEditing);
            });
        }

        if (hasSubmitted) setReadOnlyMode(true);
        else toggleEditBtn.style.display = "none";

        // ---------- AI æ¨è–¦å¿—é¡˜åŠŸèƒ½ (é‡è¦ä¿®æ”¹) ----------
        const aiRecommendBtn = document.getElementById("aiRecommendBtnNew"); 
        if (aiRecommendBtn && aiPreferenceModal) {
            aiRecommendBtn.addEventListener("click", () => {
                aiPreferenceModal.show();
            });
        }

        const confirmAiPreferenceBtn = document.getElementById("confirmAiPreferenceBtn");
        if (confirmAiPreferenceBtn) {
            confirmAiPreferenceBtn.addEventListener("click", async () => {
                aiPreferenceModal.hide();

                // ğŸ’¡ å–å¾—ä¸‰å€‹ç¯©é¸å™¨å€¼
                const distanceFilter = document.getElementById('distance-filter').value;
                const transportationFilter = document.getElementById('transportation-filter').value;
                const salaryFilter = document.getElementById('salary-filter').value;
                const systemPrompt = (document.getElementById('system-prompt')?.value || '').trim();

                // é¡¯ç¤ºè¼‰å…¥ä¸­ (ä¸å†å½ˆå‡ºå±¥æ­·æ—¥è¨˜è¼¸å…¥æ¡†)
                Swal.fire({
                    title: 'AI æ­£åœ¨åˆ†æä¸­...',
                    html: `
                        <p>å°‡æ ¹æ“šæ‚¨çš„å±¥æ­·èˆ‡ä¸‹åˆ—æ¢ä»¶æ¨è–¦å¿—é¡˜åºï¼š</p>
                        <ul class="text-start mb-0" style="list-style-type: none; padding-left: 0;">
                            <li>è·é›¢åå¥½: <strong>${document.getElementById('distance-filter').options[document.getElementById('distance-filter').selectedIndex].text}</strong></li>
                            <li>äº¤é€šåå¥½: <strong>${document.getElementById('transportation-filter').options[document.getElementById('transportation-filter').selectedIndex].text}</strong></li>
                            <li>è–ªè³‡åå¥½: <strong>${document.getElementById('salary-filter').options[document.getElementById('salary-filter').selectedIndex].text}</strong></li>
                        </ul>
                    `,
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                try {
                    // ğŸ’¡ å‘¼å«å¾Œç«¯ APIï¼Œåªå‚³éç¯©é¸æ¢ä»¶ï¼Œä¸å‚³é resumeText
                    const response = await fetch("/api/recommend-preferences", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ 
                            distanceFilter: distanceFilter, 
                            transportationFilter: transportationFilter,
                            salaryFilter: salaryFilter,
                            systemPrompt: systemPrompt
                        })
                    });

                    const result = await response.json();

                    if (!result.success) {
                        return Swal.fire({
                            icon: 'error',
                            title: 'æ¨è–¦å¤±æ•—',
                            text: result.error || 'ç„¡æ³•å–å¾—AIæ¨è–¦ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚'
                        });
                    }

                    const recommendations = result.recommendations || [];
                    if (recommendations.length === 0) {
                        return Swal.fire({
                            icon: 'warning',
                            title: 'ç„¡æ¨è–¦çµæœ',
                            text: 'AI ç„¡æ³•ç”Ÿæˆæ¨è–¦ï¼Œè«‹å˜—è©¦æ”¾å¯¬ç¯©é¸æ¢ä»¶ã€‚'
                        });
                    }

                    // é¡¯ç¤ºæ¨è–¦çµæœ
                    let recommendationsHtml = '<div class="text-start" style="max-height: 400px; overflow-y: auto;">';
                    recommendations.forEach((rec, idx) => {
                        recommendationsHtml += `
                            <div class="mb-3 p-3" style="border: 1px solid #ddd; border-radius: 8px; background-color: #f8f9fa;">
                                <h6 class="mb-2"><strong>ç¬¬ ${rec.order} å¿—é¡˜æ¨è–¦</strong></h6>
                                <p class="mb-1"><strong>å…¬å¸ï¼š</strong>${rec.company_name}</p>
                                <p class="mb-1"><strong>è·ç¼ºï¼š</strong>${rec.job_title}</p>
                                <p class="mb-0 text-muted"><small><strong>æ¨è–¦ç†ç”±ï¼š</strong>${rec.reason || 'ç„¡'}</small></p>
                            </div>
                        `;
                    });
                    recommendationsHtml += '</div>';

                    const { isConfirmed } = await Swal.fire({
                        icon: 'success',
                        title: `AI æ¨è–¦äº† ${recommendations.length} å€‹å¿—é¡˜`,
                        html: recommendationsHtml,
                        showCancelButton: true,
                        confirmButtonText: 'å¥—ç”¨åˆ°å¿—é¡˜åº',
                        cancelButtonText: 'å–æ¶ˆ',
                        width: '600px'
                    });

                    if (isConfirmed) {
                        const allCards = document.querySelectorAll(".preference-card");

                        if (hasSubmitted && !isEditing) {
                            isEditing = true;
                            setReadOnlyMode(false);
                        }
                        
                        const applyPromises = recommendations.map((rec, idx) => {
                            return new Promise((resolve) => {
                                if (idx >= allCards.length) {
                                    resolve();
                                    return;
                                }
                                
                                const card = allCards[idx];
                                const companySelect = card.querySelector(".company-select");
                                const jobSelect = card.querySelector(".job-select");
                                
                                companySelect.value = String(rec.company_id);
                                
                                loadJobs(String(rec.company_id)).then(() => {
                                    setTimeout(() => {
                                        jobSelect.value = String(rec.job_id);
                                        jobSelect.dispatchEvent(new Event('change'));
                                        resolve();
                                    }, 300);
                                });
                                
                                companySelect.dispatchEvent(new Event('change'));
                            });
                        });

                        Promise.all(applyPromises).then(() => {
                            updateSelections();
                            Swal.fire({
                                icon: 'success',
                                title: 'å·²å¥—ç”¨æ¨è–¦',
                                text: `å·²å°‡ ${recommendations.length} å€‹æ¨è–¦å¥—ç”¨åˆ°å¿—é¡˜åºä¸­ï¼Œæ‚¨å¯ä»¥é€²ä¸€æ­¥èª¿æ•´å¾Œå†é€å‡ºã€‚`,
                                timer: 2000
                            });
                        });
                    }
                } catch (error) {
                    console.error('AI æ¨è–¦éŒ¯èª¤:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'ç¶²è·¯éŒ¯èª¤',
                        text: 'ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚'
                    });
                }
            });
        }

        // ---------- è¡¨å–®é€å‡º (ä¿æŒä¸è®Š) ----------
        document.getElementById("preferencesForm").addEventListener("submit", async e => {
            e.preventDefault();
            if (preview) return Swal.fire({ icon: 'warning', title: 'æœªæˆæ¬Š', text: 'æ­¤ç‚ºé è¦½æ¨¡å¼ï¼Œè«‹ç™»å…¥å­¸ç”Ÿå¸³è™Ÿå¾Œå†å„²å­˜å¿—é¡˜åºã€‚' });
            const preferences = [];
            let isValid = true;
            document.querySelectorAll(".preference-card").forEach((card, idx) => {
                const companyId = card.querySelector(".company-select").value;
                const jobId = card.querySelector(".job-select").value;
                if (companyId && !jobId) {
                    isValid = false;
                    Swal.fire({ icon: 'error', title: 'å¿—é¡˜éŒ¯èª¤', text: `ç¬¬ ${idx + 1} å¿—é¡˜å·²é¸æ“‡å…¬å¸ä½†æœªé¸è·ç¼ºã€‚` });
                }
                if (companyId && jobId) preferences.push({ order: idx + 1, company_id: companyId, job_id: jobId });
            });
            if (!isValid) return;
            if (preferences.length === 0)
                return Swal.fire({ icon: 'warning', title: 'å°šæœªå¡«å¯«å¿—é¡˜', text: 'è‡³å°‘é¸æ“‡ä¸€å€‹å®Œæ•´å¿—é¡˜ã€‚' });

            try {
                const res = await fetch("/api/save_preferences", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ preferences })
                });
                const result = await res.json();
                if (result.success) {
                    Swal.fire({ icon: 'success', title: 'é€å‡ºæˆåŠŸï¼', text: result.message })
                        .then(() => { setReadOnlyMode(true); updateSelections(); });
                } else Swal.fire({ icon: 'error', title: 'å„²å­˜å¤±æ•—', text: result.message });
            } catch {
                Swal.fire({ icon: 'error', title: 'ç¶²è·¯éŒ¯èª¤', text: 'ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨ã€‚' });
            }
        });
    </script>
</body>

</html>