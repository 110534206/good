<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>實習公司志願序填寫</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
      background-color: #f8f9fa;
      padding: 20px;
    }

    h2 {
      text-align: center;
      color: #0066cc;
      margin-bottom: 20px;
    }

    .preference-card {
      background-color: #fff;
      border-radius: 1rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 16px;
      position: relative;
    }

    .badge-remaining {
      position: absolute;
      right: 20px;
      top: 20px;
      background-color: #0d6efd;
      color: white;
      border-radius: 12px;
      padding: 4px 10px;
      font-size: 0.8rem;
    }

    .company-preview {
      font-size: 15px;
      color: #333;
    }

    .company-preview .section {
      background: #f9fbfd;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 18px 20px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .company-preview .section h5 {
      color: #0056b3;
      font-weight: 600;
      margin-bottom: 15px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px 20px;
    }

    .info-grid .full {
      grid-column: 1 / -1;
    }

    .info-grid div {
      background: #fff;
      border: 1px solid #e2e6ea;
      border-radius: 5px;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .info-grid strong {
      color: #0056b3;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .info-grid span {
      font-size: 15px;
      color: #444;
      white-space: pre-wrap;
    }

    .modal-body {
      max-height: 70vh;
      overflow-y: auto;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2 class="mb-4 text-center fw-bold">實習公司志願序填寫</h2>

    <form id="preferencesForm" class="mx-auto" style="max-width: 700px;">
      {% for i in range(1, 6) %}
      <div class="preference-card" data-rank="{{ i }}">
        <h5 class="fw-bold">第 {{ i }} 志願</h5>

        <div class="mb-3">
          <label class="form-label">選擇公司</label>
          <select class="form-select company-select" required>
            <option value="">-- 請選擇公司 --</option>
            {% for c in companies %}
            <option value="{{ c['id'] }}">{{ c['name'] }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">選擇職缺</label>
          <select class="form-select job-select" required>
            <option value="">-- 請先選擇公司 --</option>
          </select>
        </div>
        <button type="button" class="btn btn-outline-info btn-sm view-company-btn" disabled>查看公司詳情</button>

        <span class="badge-remaining">尚未選擇公司</span>
      </div>
      {% endfor %}

      <div class="text-center mt-4">
        <button type="submit" class="btn btn-success px-4">儲存志願序</button>
      </div>
    </form>
  </div>

  <!-- Modal 預覽 -->
  <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="previewContent"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const companySlots = {{ job_slots | tojson }};
    const selectedCounts = {};

    // 綁定公司下拉變化，動態載入職缺
    document.querySelectorAll(".company-select").forEach(select => {
      select.addEventListener("change", async (e) => {
        const selectedCompany = e.target.value;
        const card = e.target.closest(".preference-card");
        const jobSelect = card.querySelector(".job-select");
        const badge = card.querySelector(".badge-remaining");
        const viewBtn = card.querySelector(".view-company-btn");

        viewBtn.disabled = !selectedCompany;
        jobSelect.innerHTML = `<option value="">-- 請先選擇公司 --</option>`;

        if (!selectedCompany) {
          badge.textContent = "尚未選擇公司";
          return;
        }

        try {
          const res = await fetch(`/api/get_jobs_by_company?company_id=${selectedCompany}`);
          const data = await res.json();

          if (data.success && data.jobs.length > 0) {
            jobSelect.innerHTML = data.jobs.map(j =>
              `<option value="${j.id}">${j.title}</option>`
            ).join('');
          } else {
            jobSelect.innerHTML = `<option value="">（無可用職缺）</option>`;
          }
        } catch (err) {
          console.error(err);
        }

        updateRemainingDisplay();
      });
    });

    // 查看公司詳情 Modal 功能
    document.querySelectorAll(".preference-card").forEach(card => {
      const companySelect = card.querySelector(".company-select");
      const viewBtn = card.querySelector(".view-company-btn");

      viewBtn.addEventListener("click", async () => {
        const companyId = companySelect.value;
        if (!companyId) return;

        try {
          const res = await fetch(`/api/get_company_detail?company_id=${companyId}`);
          const data = await res.json();

          if (!data.success) {
            alert("查無公司資料");
            return;
          }

          const c = data.company;
          const jobs = data.jobs || [];

          const content = `
      <div class="company-preview">
        <div class="section">
          <h5>公司基本資料</h5>
          <div class="info-grid">
            <div><strong>公司名稱</strong><span>${c.company_name || '-'}</span></div>
            <div><strong>公司地址</strong><span>${c.company_address || '-'}</span></div>
          </div>
        </div>
        <div class="section">
          <h5>聯絡資訊</h5>
          <div class="info-grid">
            <div><strong>聯絡人姓名</strong><span>${c.contact_name || '-'}</span></div>
            <div><strong>聯絡電話</strong><span>${c.contact_phone || '-'}</span></div>
            <div class="full"><strong>電子郵件</strong><span>${c.contact_email || '-'}</span></div>
          </div>
        </div>
        <div class="section">
            <h5>實習職缺資訊</h5>
            ${(c.internship_jobs || []).map(job => `
              <div class="info-grid">
                <div><strong>實習職位</strong><span>${job.internship_unit || '-'}</span></div>
                <div><strong>所屬部門</strong><span>${job.department || '-'}</span></div>
                <div><strong>期間</strong><span>${job.internship_period || '-'}</span></div>
                <div><strong>時段</strong><span>${job.internship_time || '-'}</span></div>
                <div><strong>名額</strong><span>${job.internship_quota || '-'}</span></div>
                <div class="full"><strong>實習內容</strong><span>${job.internship_content || '-'}</span></div>
                <div class="full"><strong>備註</strong><span>${job.remark || '-'}</span></div>
              </div>
            `).join('')}
          </div>
        </div>
        `;

        document.getElementById("previewContent").innerHTML = content;
        new bootstrap.Modal(document.getElementById("previewModal")).show();
      } catch (err) {
          console.error(err);
        alert("取得公司資料失敗");
      }
    });
  });
    // 更新剩餘可選名額
    function updateRemainingDisplay() {
      const allCompanies = document.querySelectorAll(".company-select");
      const countMap = {};

      allCompanies.forEach(s => {
        const cid = s.value;
        if (cid) countMap[cid] = (countMap[cid] || 0) + 1;
      });

      allCompanies.forEach(select => {
        const card = select.closest(".preference-card");
        const badge = card.querySelector(".badge-remaining");
        const cid = select.value;
        const cidStr = String(cid);
        const totalSlots = Number(companySlots[cidStr] || 0);
        const used = countMap[cidStr] || 0;
        const remain = Math.max(totalSlots - used, 0);

        if (cid) {
          badge.textContent = remain > 0 ? `剩餘可選：${remain}` : `已填寫完畢`;
          badge.classList.toggle("bg-danger", remain === 0);
          badge.classList.toggle("bg-primary", remain > 0);
        } else {
          badge.textContent = "尚未選擇公司";
        }
      });

      // 禁用選項：公司已達上限（除非使用者已選）
      allCompanies.forEach(select => {
        const currentValue = select.value;
        Array.from(select.options).forEach(option => {
          const cidStr = String(option.value);
          if (!cidStr) return;

          const total = Number(companySlots[cidStr] || 0);
          const used = countMap[cidStr] || 0;
          const remaining = total - used;

          if (remaining <= 0 && option.value !== currentValue) {
            option.disabled = true;
            option.title = "此公司名額已用完";
          } else {
            option.disabled = false;
            option.title = "";
          }
        });
      });
    }

    // 表單儲存
    document.getElementById("preferencesForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const preferences = [];
      document.querySelectorAll(".preference-card").forEach((card, idx) => {
        const companyId = card.querySelector(".company-select").value;
        const jobId = card.querySelector(".job-select").value;
        if (companyId && jobId) {
          preferences.push({ order: idx + 1, company_id: companyId, job_id: jobId });
        }
      });

      const res = await fetch("/api/save_preferences", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ preferences })
      });

      const data = await res.json();
      alert(data.message);
      if (data.success) location.reload();
    });

    // 初始
    updateRemainingDisplay();

  </script>
</body>

</html>