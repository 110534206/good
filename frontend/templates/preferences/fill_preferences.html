<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>智慧實習平台 | 實習公司志願序填寫</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* 基礎排版與字體 */
        body {
            font-family: "Noto Sans TC", sans-serif;
            background-color: #f8f9fa;
            /* 輕微的淺灰色背景 */
            padding: 30px;
        }

        /* 標題優化 */
        h2 {
            /* 移除 text-align: center; 因為我們使用父層 div 置中 */
            color: #004d99;
            margin-bottom: 50px;
            font-weight: 700;
            font-size: 2rem;
            border-bottom: 3px solid #1a73e8;
            display: inline-block;
            padding-bottom: 8px;
        }

        /* 卡片設計優化 */
        .preference-card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            padding: 30px;
            margin-bottom: 30px;
            /* 間距加大 */
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .preference-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        /* 強化志願序號的視覺重要性 */
        .card-header-rank {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            /* 增加與內容的間距 */
            padding-bottom: 15px;
            border-bottom: 1px dashed #e9ecef;
        }

        /* 志願數字徽章 */
        .rank-number {
            font-size: 1.8rem;
            font-weight: 900;
            color: #ffffff;
            background-color: #1a73e8;
            /* 藍色背景 */
            border-radius: 0.5rem;
            padding: 5px 15px;
            margin-right: 15px;
            line-height: 1;
            box-shadow: 0 4px 10px rgba(26, 115, 232, 0.4);
        }

        /* 徽章 (狀態提示) */
        .badge-remaining {
            position: absolute;
            right: 30px;
            top: 30px;
            border-radius: 50rem;
            padding: 8px 15px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .badge-remaining.bg-primary {
            background-color: #1a73e8 !important;
            color: white;
        }

        .badge-remaining.bg-secondary {
            background-color: #6c757d !important;
        }

        /* 表單元素設計 */
        .form-select,
        .form-label {
            font-size: 1rem;
        }

        .form-label {
            font-weight: 600;
            /* 標籤加粗 */
            color: #343a40;
            margin-bottom: 8px;
        }

        .form-select {
            border: 1px solid #ced4da;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem 0.75rem 0.75rem;
            transition: all 0.2s ease;
        }

        .form-select:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 0.25rem rgba(26, 115, 232, 0.25);
        }

        /* 按鈕設計 */
        .btn {
            border-radius: 0.6rem;
            font-weight: 600;
            padding: 10px 20px;
            transition: background-color 0.2s, transform 0.1s;
        }

        /* 主要儲存按鈕 */
        .btn-success {
            background-color: #00a651;
            border-color: #00a651;
        }

        .btn-success:hover {
            background-color: #008f45;
            border-color: #008f45;
            transform: translateY(-1px);
        }

        /* 次要下載按鈕 */
        .btn-outline-primary {
            margin-top: 10px;
            color: #1a73e8;
            border-color: #1a73e8;
            background-color: transparent;
            padding: 8px 15px;
        }

        .btn-outline-primary:hover:not([disabled]) {
            color: white;
            background-color: #1a73e8;
        }

        .btn-outline-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="text-center">
            <h2><i class="bi bi-person-workspace me-2"></i>實習公司志願序填寫</h2>
        </div>

        {% if preview %}
        <div class="alert alert-warning text-center" role="alert" style="max-width: 900px;">
            <i class="bi bi-eye-fill me-2"></i>
            **您目前處於預覽模式，無法儲存志願序。請以學生身份登入以填寫。**
        </div>
        {% endif %}

        <form id="preferencesForm" class="mx-auto" style="max-width: 900px;">
            {% for rank in range(1, 6) %}
            <div class="preference-card" data-rank="{{ rank }}">
                <div class="card-header-rank">
                    <span class="rank-number">{{ rank }}</span>
                    <h5 class="fw-bold m-0 p-0">第 {{ rank }} 志願</h5>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label"><i class="bi bi-building me-1"></i> 選擇公司</label>
                        <select class="form-select company-select" required
                            data-initial-company="{{ submitted.get(rank, {}).company_id or '' }}">
                            <option value="">-- 請選擇公司 --</option>
                            {% for company in companies %}
                            <option value="{{ company.id }}" {% if submitted.get(rank, {}).company_id==company.id
                                %}selected{% endif %}>
                                {{ company.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <button type="button" class="btn btn-outline-primary btn-sm download-company-btn mt-2" disabled>
                            <i class="bi bi-file-earmark-arrow-down-fill me-1"></i>下載公司資料 (DOCX)
                        </button>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><i class="bi bi-briefcase me-1"></i> 選擇職缺</label>
                        <select class="form-select job-select" required
                            data-initial-job="{{ submitted.get(rank, {}).job_id or '' }}">
                            <option value="">
                                {% if submitted.get(rank, {}).company_id %}-- 載入中... --{% else %}-- 請先選擇公司
                                --{% endif %}
                            </option>
                            {% if submitted.get(rank, {}).job_id %}
                            <option value="{{ submitted[rank].job_id }}" selected>{{ submitted[rank].job_title }}
                            </option>
                            {% endif %}
                        </select>
                    </div>
                </div>
                <span class="badge-remaining bg-secondary">尚未選擇公司</span>
            </div>
            {% endfor %}

            <div class="text-center mt-5">
                <button type="submit" class="btn btn-success px-5 py-2" {% if preview %}disabled{% endif %}>
                    <i class="bi bi-save-fill me-2"></i>{% if preview %}登入後可儲存{% else %}儲存志願序{% endif %}
                </button>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 後端傳輸的動態數據
        const companies = {{ companies | tojson }};
        const submitted = {{ submitted | tojson }};
        const preview = {{ preview | tojson }};

        // 核心 JavaScript 狀態與快取
        const selectedJobIds = new Set();
        const companyJobsCache = {};

        /**
         * 呼叫後端 API 載入特定公司的職缺
         * @param {string} companyId - 公司 ID
         * @returns {Promise<Array<Object>>} 職缺列表
         */
        async function loadJobs(companyId) {
            if (companyJobsCache[companyId]) return companyJobsCache[companyId];

            try {
                // 假設 API 路由是 /api/get_jobs_by_company?company_id=<id>
                const response = await fetch(`/api/get_jobs_by_company?company_id=${companyId}`);
                const data = await response.json();

                if (data.success) {
                    // 將 id 轉為字串以確保 Set 比較一致性
                    companyJobsCache[companyId] = data.jobs.map(j => ({ id: String(j.id), title: j.title }));
                    return companyJobsCache[companyId];
                } else {
                    console.error("Failed to load jobs:", data.message);
                    return [];
                }
            } catch (error) {
                console.error("API error during job load:", error);
                return [];
            }
        }

        /**
         * 更新所有志願卡的狀態、職缺下拉選單，並檢查職缺重複。
         * 實作公司排他性邏輯：當公司所有職缺都被選走時，該公司將被排除在其他選單之外。
         */
        function updateSelections() {
            const allPreferenceCards = document.querySelectorAll(".preference-card");
            selectedJobIds.clear();
            const excludedCompanyIds = new Set(); // 儲存需要排除的公司 ID

            // 1. 收集當前所有已選職缺
            allPreferenceCards.forEach(card => {
                const jobSelect = card.querySelector(".job-select");
                const selectedJob = jobSelect.value;
                if (selectedJob) {
                    selectedJobIds.add(selectedJob);
                }
            });

            // 2. 識別需要排除的公司 (所有職缺都被選走的公司)
            companies.forEach(company => {
                const companyId = String(company.id);
                const availableJobs = companyJobsCache[companyId]; // 從快取中取得該公司的職缺列表

                // 檢查該公司的職缺是否已經載入
                if (!availableJobs || availableJobs.length === 0) {
                    return; // 如果職缺未載入或無職缺，則跳過
                }

                const totalJobs = availableJobs.length;
                let selectedCount = 0;

                // 統計該公司有多少職缺已被選中
                availableJobs.forEach(j => {
                    if (selectedJobIds.has(String(j.id))) {
                        selectedCount++;
                    }
                });

                // 條件：已選職缺數等於總職缺數
                if (selectedCount >= totalJobs) {
                    excludedCompanyIds.add(companyId);
                }
            });


            // 3. 遍歷所有志願卡，更新 UI (公司選單、職缺選單、徽章)
            allPreferenceCards.forEach(card => {
                const companySelect = card.querySelector(".company-select");
                const jobSelect = card.querySelector(".job-select");
                const badge = card.querySelector(".badge-remaining");
                const downloadBtn = card.querySelector(".download-company-btn");

                const selectedCompany = companySelect.value; // 當前志願卡已選的公司 ID
                const currentJobValue = jobSelect.value; // 當前志願卡已選的職缺 ID

                downloadBtn.disabled = !selectedCompany;

                // --- 3A. 更新公司選單 (應用排除邏輯) ---
                companySelect.innerHTML = `<option value="">-- 請選擇公司 --</option>`;
                
                companies.forEach(c => {
                    const cId = String(c.id);
                    const isExcluded = excludedCompanyIds.has(cId);

                    // 排除條件：該公司所有職缺已被選走 AND 不是當前卡片已選的公司
                    if (isExcluded && cId !== selectedCompany) {
                        return; // 跳過此公司選項
                    }

                    const opt = document.createElement("option");
                    opt.value = cId;
                    opt.textContent = c.name;

                    if (cId === selectedCompany) {
                        opt.selected = true;
                    }
                    companySelect.appendChild(opt);
                });

                // 如果當前選中的公司在重新渲染後不存在於列表中，則清空公司選取
                if (selectedCompany && !companySelect.value) {
                    companySelect.value = ""; 
                }
                
                // --- 3B. 更新職缺選單 (原排他性邏輯：職缺不重複) ---

                const finalCompanyId = companySelect.value; // 使用更新後的公司 ID

                if (finalCompanyId && companyJobsCache[finalCompanyId]) {
                    const availableJobs = companyJobsCache[finalCompanyId];
                    jobSelect.innerHTML = `<option value="">-- 請選擇職缺 --</option>`;

                    let jobFound = false;
                    let hasAvailableOptions = false;

                    availableJobs.forEach(j => {
                        const jId = String(j.id);
                        // 排除已在其他志願選中的職缺，但允許當前職缺被選中
                        const isExcluded = selectedJobIds.has(jId) && jId !== currentJobValue;

                        if (!isExcluded) {
                            const opt = document.createElement("option");
                            opt.value = jId;
                            opt.textContent = j.title;
                            if (jId === currentJobValue) {
                                opt.selected = true;
                                jobFound = true;
                            }
                            jobSelect.appendChild(opt);
                            hasAvailableOptions = true;
                        }
                    });

                    if (!hasAvailableOptions) {
                        jobSelect.innerHTML = `<option value="">（無可用職缺）</option>`;
                        if (currentJobValue) jobSelect.value = ""; // 清除選中的無效職缺
                    } else if (!jobFound && currentJobValue) {
                        jobSelect.value = ""; // 清除無效職缺
                    }

                } else if (!finalCompanyId) {
                    jobSelect.innerHTML = `<option value="">-- 請先選擇公司 --</option>`;
                    // 如果公司被清空，職缺也必須清空
                    jobSelect.value = "";
                }

                // --- 3C. 更新徽章狀態 ---
                if (finalCompanyId) {
                    badge.textContent = "已選擇公司";
                    badge.classList.remove("bg-secondary");
                    badge.classList.add("bg-primary");
                } else {
                    badge.textContent = "尚未選擇公司";
                    badge.classList.remove("bg-primary");
                    badge.classList.add("bg-secondary");
                }
            });
        }

        /**
         * 初始化已填寫的志願 (載入資料並應用排他性邏輯)
         */
        async function initializeSubmittedPreferences() {
            const companySelects = document.querySelectorAll(".company-select");
            const loadPromises = [];

            // 1. 預載入所有公司（所有志願卡片中的公司）的職缺
            companySelects.forEach(select => {
                const companyId = select.dataset.initialCompany;
                if (companyId) {
                    loadPromises.push(loadJobs(companyId));
                }
            });
            // 由於公司列表 `companies` 是靜態的，我們也需要載入列表中所有公司的職缺，以計算總職缺數
            companies.forEach(company => {
                const companyId = String(company.id);
                 // 避免重複載入
                if (!companyJobsCache[companyId]) {
                     loadPromises.push(loadJobs(companyId));
                }
            });


            // 等待所有公司的職缺都載入完成
            await Promise.all(loadPromises);

            // 2. 第二階段：設定職缺選單的值（依賴已載入的快取）
            companySelects.forEach(select => {
                const companyId = select.dataset.initialCompany;
                const initialJobId = select.dataset.initialJob;
                const jobSelect = select.closest(".preference-card").querySelector(".job-select");

                if (companyId) {
                    const jobs = companyJobsCache[companyId] || [];

                    // 重新建構選項，並將初始值設定為 selected
                    jobSelect.innerHTML =
                        `<option value="">-- 請選擇職缺 --</option>` +
                        jobs
                            .map(j => `<option value="${j.id}" ${String(j.id) === String(initialJobId) ? "selected" : ""}>${j.title}</option>`)
                            .join("");
                }
            });

            // 3. 最後更新所有選項狀態，應用排他性邏輯
            updateSelections();
        }

        // --- 事件監聽器 ---

        document.querySelectorAll(".company-select").forEach(select => {
            select.addEventListener("change", async e => {
                const companyId = e.target.value;
                const jobSelect = e.target.closest(".preference-card").querySelector(".job-select");

                jobSelect.value = ""; // 清除舊的職缺選擇

                if (companyId) {
                    jobSelect.innerHTML = `<option value="">-- 載入中... --</option>`;
                    const jobs = await loadJobs(companyId); // 確保職缺已載入

                    if (jobs.length > 0) {
                        jobSelect.innerHTML = `<option value="">-- 請選擇職缺 --</option>`;
                        jobs.forEach(j => {
                            const opt = document.createElement("option");
                            opt.value = j.id;
                            opt.textContent = j.title;
                            jobSelect.appendChild(opt);
                        });
                    } else {
                        jobSelect.innerHTML = `<option value="">（無可用職缺）</option>`;
                    }
                } else {
                    jobSelect.innerHTML = `<option value="">-- 請先選擇公司 --</option>`;
                    jobSelect.value = ""; // 確保沒有選中值
                }
                updateSelections(); // 更改公司或載入職缺後，更新全部排他性邏輯
            });
        });

        document.querySelectorAll(".job-select").forEach(select => {
            select.addEventListener("change", updateSelections); // 更改職缺後，更新排他性邏輯
        });

        // 檔案下載按鈕
        document.querySelectorAll(".preference-card").forEach(card => {
            const downloadBtn = card.querySelector(".download-company-btn");
            const companySelect = card.querySelector(".company-select");
            downloadBtn.addEventListener("click", () => {
                const companyId = companySelect.value;
                if (!companyId) return;

                // 使用後端 Flask 程式碼中指定的路由
                window.location.href = `/api/download_company_file/${companyId}`;
            });
        });

        // 表單提交處理
        document.getElementById("preferencesForm").addEventListener("submit", async e => {
            e.preventDefault();
            if (preview) {
                Swal.fire({ icon: 'warning', title: '未授權', text: '此為預覽模式，請登入學生帳號後再儲存志願序。', confirmButtonText: '確定' });
                return;
            }

            const preferences = [];
            let isValid = true;
            document.querySelectorAll(".preference-card").forEach((card, idx) => {
                const companyId = card.querySelector(".company-select").value;
                const jobId = card.querySelector(".job-select").value;

                // 檢查是否只選了公司但未選職缺
                if (companyId && !jobId) {
                    isValid = false;
                    Swal.fire({ icon: 'error', title: '志願錯誤', text: `第 ${idx + 1} 志願已選擇公司，但尚未選擇職缺。`, confirmButtonText: '確定' });
                }

                if (companyId && jobId)
                    preferences.push({ order: idx + 1, company_id: companyId, job_id: jobId });
            });

            if (!isValid) return;

            // 檢查是否至少選擇一個完整的志願
            if (preferences.length === 0) {
                Swal.fire({ icon: 'warning', title: '尚未填寫志願', text: '您必須至少選擇一個完整的志願（公司與職缺）。', confirmButtonText: '確定' });
                return;
            }

            // 提交數據到後端 API
            try {
                const response = await fetch("/api/save_preferences", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ preferences: preferences })
                });

                const result = await response.json();

                if (result.success) {
                    Swal.fire({ icon: 'success', title: '儲存成功！', text: result.message, confirmButtonText: '確定' }).then(() => {
                        window.location.reload();
                    });
                } else {
                    Swal.fire({ icon: 'error', title: '儲存失敗', text: result.message, confirmButtonText: '確定' });
                }
            } catch (error) {
                Swal.fire({ icon: 'error', title: '網路錯誤', text: '無法連線到伺服器，請稍後再試。', confirmButtonText: '確定' });
                console.error("Fetch error:", error);
            }
        });

        // 頁面載入時初始化
        initializeSubmittedPreferences();
    </script>
</body>

</html>