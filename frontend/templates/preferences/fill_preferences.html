<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>智慧實習平台 | 實習公司志願序填寫</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: "Noto Sans TC", sans-serif;
            background: #f7f9fc;
            margin: 0;
            padding: 0;
        }

        header {
            background: #0454a3;
            color: white;
            padding: 1rem 2rem;
            text-align: center;
            font-size: 1.5rem;
        }

        .container {
            max-width: 800px;
            margin: 2rem auto;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #004d99;
            margin-bottom: 50px;
            font-weight: 700;
            font-size: 2rem;
            border-bottom: 3px solid #1a73e8;
            display: inline-block;
            padding-bottom: 8px;
        }

        .preference-card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            padding: 20px;
            margin-bottom: 30px;
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .preference-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .card-header-rank {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #e9ecef;
        }

        .rank-number {
            font-size: 1.8rem;
            font-weight: 900;
            color: #ffffff;
            background-color: #1a73e8;
            border-radius: 0.5rem;
            padding: 5px 15px;
            margin-right: 15px;
            line-height: 1;
            box-shadow: 0 4px 10px rgba(26, 115, 232, 0.4);
        }

        .badge-remaining {
            position: absolute;
            right: 30px;
            top: 30px;
            border-radius: 50rem;
            padding: 8px 15px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .badge-remaining.bg-primary {
            background-color: #1a73e8 !important;
            color: white;
        }

        .badge-remaining.bg-secondary {
            background-color: #6c757d !important;
        }

        .form-select,
        .form-label {
            font-size: 1rem;
        }

        .form-label {
            font-weight: 600;
            color: #343a40;
            margin-bottom: 8px;
        }

        .form-select {
            border: 1px solid #ced4da;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem 0.75rem 0.75rem;
            transition: all 0.2s ease;
        }

        .form-select:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 0.25rem rgba(26, 115, 232, 0.25);
        }

        .btn {
            border-radius: 0.6rem;
            font-weight: 600;
            padding: 10px 20px;
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn-success {
            background-color: #00a651;
            border-color: #00a651;
        }

        .btn-success:hover {
            background-color: #008f45;
            border-color: #008f45;
            transform: translateY(-1px);
        }

        .btn-outline-primary {
            margin-top: 10px;
            color: #1a73e8;
            border-color: #1a73e8;
            background-color: transparent;
            padding: 8px 15px;
        }

        .btn-outline-primary:hover:not([disabled]) {
            color: white;
            background-color: #1a73e8;
        }

        .btn-outline-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <header>實習公司志願序填寫</header>
    <div class="container">
        {% if preview %}
        <div class="alert alert-warning text-center" role="alert" style="max-width: 900px;">
            <i class="bi bi-eye-fill me-2"></i>
            **您目前處於預覽模式，無法儲存志願序。請以學生身份登入以填寫。**
        </div>
        {% endif %}

        <form id="preferencesForm" class="mx-auto" style="max-width: 900px;">
            {% for rank in range(1, 5+1) %}
            <div class="preference-card" data-rank="{{ rank }}">
                <div class="card-header-rank">
                    <span class="rank-number">{{ rank }}</span>
                    <h5 class="fw-bold m-0 p-0">第 {{ rank }} 志願</h5>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label"><i class="bi bi-building me-1"></i> 選擇公司</label>
                        <select class="form-select company-select" required
                            data-initial-company="{{ submitted.get(rank, {}).company_id or '' }}">
                            <option value="">-- 請選擇公司 --</option>
                            {% for company in companies %}
                            <option value="{{ company.id }}" {% if submitted.get(rank, {}).company_id==company.id
                                %}selected{% endif %}>
                                {{ company.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <button type="button" class="btn btn-outline-primary btn-sm download-company-btn mt-2" disabled>
                            <i class="bi bi-file-earmark-arrow-down-fill me-1"></i>下載公司資料 (DOCX)
                        </button>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><i class="bi bi-briefcase me-1"></i> 選擇職缺</label>
                        <select class="form-select job-select" required
                            data-initial-job="{{ submitted.get(rank, {}).job_id or '' }}">
                            <option value="">
                                {% if submitted.get(rank, {}).company_id %}-- 載入中... --{% else %}-- 請先選擇公司
                                --{% endif %}
                            </option>
                            {% if submitted.get(rank, {}).job_id %}
                            <option value="{{ submitted[rank].job_id }}" selected>{{ submitted[rank].job_title }}
                            </option>
                            {% endif %}
                        </select>
                    </div>
                </div>
                <span class="badge-remaining bg-secondary">尚未選擇公司</span>
            </div>
            {% endfor %}

            <div class="text-center mt-5">
                {% if preview %}
                <button type="submit" class="btn btn-success px-5 py-2" disabled>
                    <i class="bi bi-lock-fill me-2"></i>登入後可儲存
                </button>
                {% else %}
                <button id="aiRecommendBtn" type="button" class="btn btn-info px-5 py-2 me-3" style="background-color: #17a2b8; border-color: #17a2b8; color: white;">
                    <i class="bi bi-robot me-2"></i>AI 推薦志願
                </button>
                <button id="toggleEditBtn" type="button" class="btn btn-primary px-5 py-2 me-3">
                    <i class="bi bi-pencil-square me-2"></i>修改志願序
                </button>
                <button id="saveBtn" type="submit" class="btn btn-success px-5 py-2">
                    <i class="bi bi-save-fill me-2"></i>送出志願序
                </button>
                {% endif %}
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const companies = {{ companies | tojson }};
        const submitted = {{ submitted | tojson }};
        const preview = {{ preview | tojson }};

        const selectedJobIds = new Set();
        const companyJobsCache = {};

        async function loadJobs(companyId) {
            if (companyJobsCache[companyId]) return companyJobsCache[companyId];
            try {
                const response = await fetch(`/api/get_jobs_by_company?company_id=${companyId}`);
                const data = await response.json();
                if (data.success) {
                    companyJobsCache[companyId] = data.jobs.map(j => ({ id: String(j.id), title: j.title }));
                    return companyJobsCache[companyId];
                }
            } catch (error) { console.error(error); }
            return [];
        }

        function updateSelections() {
            const allPreferenceCards = document.querySelectorAll(".preference-card");
            selectedJobIds.clear();
            const excludedCompanyIds = new Set();

            allPreferenceCards.forEach(card => {
                const jobSelect = card.querySelector(".job-select");
                if (jobSelect.value) selectedJobIds.add(jobSelect.value);
            });

            companies.forEach(company => {
                const jobs = companyJobsCache[String(company.id)];
                if (!jobs) return;
                const selectedCount = jobs.filter(j => selectedJobIds.has(String(j.id))).length;
                if (selectedCount >= jobs.length) excludedCompanyIds.add(String(company.id));
            });

            allPreferenceCards.forEach(card => {
                const companySelect = card.querySelector(".company-select");
                const jobSelect = card.querySelector(".job-select");
                const badge = card.querySelector(".badge-remaining");
                const downloadBtn = card.querySelector(".download-company-btn");
                const selectedCompany = companySelect.value;
                const currentJobValue = jobSelect.value;

                downloadBtn.disabled = !selectedCompany;

                companySelect.innerHTML = `<option value="">-- 請選擇公司 --</option>`;
                companies.forEach(c => {
                    const cId = String(c.id);
                    if (excludedCompanyIds.has(cId) && cId !== selectedCompany) return;
                    const opt = document.createElement("option");
                    opt.value = cId; opt.textContent = c.name;
                    if (cId === selectedCompany) opt.selected = true;
                    companySelect.appendChild(opt);
                });

                const finalCompanyId = companySelect.value;
                if (finalCompanyId && companyJobsCache[finalCompanyId]) {
                    const availableJobs = companyJobsCache[finalCompanyId];
                    jobSelect.innerHTML = `<option value="">-- 請選擇職缺 --</option>`;
                    availableJobs.forEach(j => {
                        const isExcluded = selectedJobIds.has(String(j.id)) && String(j.id) !== currentJobValue;
                        if (!isExcluded)
                            jobSelect.innerHTML += `<option value="${j.id}" ${j.id === currentJobValue ? 'selected' : ''}>${j.title}</option>`;
                    });
                } else jobSelect.innerHTML = `<option value="">-- 請先選擇公司 --</option>`;

                if (finalCompanyId) {
                    badge.textContent = "已選擇公司";
                    badge.classList.replace("bg-secondary", "bg-primary");
                } else {
                    badge.textContent = "尚未選擇公司";
                    badge.classList.replace("bg-primary", "bg-secondary");
                }
            });
        }

        async function initializeSubmittedPreferences() {
            const companySelects = document.querySelectorAll(".company-select");
            const loadPromises = [];
            companySelects.forEach(select => {
                const companyId = select.dataset.initialCompany;
                if (companyId) loadPromises.push(loadJobs(companyId));
            });
            companies.forEach(c => { if (!companyJobsCache[c.id]) loadPromises.push(loadJobs(c.id)); });
            await Promise.all(loadPromises);
            updateSelections();
        }

        document.querySelectorAll(".company-select").forEach(select => {
            select.addEventListener("change", async e => {
                const card = e.target.closest(".preference-card");
                const jobSelect = card.querySelector(".job-select");
                const companyId = e.target.value;
                jobSelect.innerHTML = `<option>-- 載入中... --</option>`;
                if (companyId) {
                    const jobs = await loadJobs(companyId);
                    jobSelect.innerHTML = jobs.length ? `<option value="">-- 請選擇職缺 --</option>` +
                        jobs.map(j => `<option value="${j.id}">${j.title}</option>`).join("") :
                        `<option value="">（無可用職缺）</option>`;
                } else jobSelect.innerHTML = `<option value="">-- 請先選擇公司 --</option>`;
                setTimeout(updateSelections, 100);
            });
        });

        document.querySelectorAll(".job-select").forEach(select => {
            select.addEventListener("change", updateSelections);
        });

        document.querySelectorAll(".download-company-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const companyId = btn.closest(".preference-card").querySelector(".company-select").value;
                if (companyId) window.location.href = `/api/download_company_file/${companyId}`;
            });
        });

        initializeSubmittedPreferences().then(updateSelections);

        // ---------- 狀態控制 ----------
        let isEditing = false;
        const hasSubmitted = Object.keys(submitted || {}).length > 0;
        const saveBtn = document.getElementById("saveBtn");
        const toggleEditBtn = document.getElementById("toggleEditBtn");
        const allSelects = document.querySelectorAll(".company-select, .job-select");

        function setReadOnlyMode(readonly) {
            allSelects.forEach(sel => sel.disabled = readonly);
            document.querySelectorAll(".download-company-btn").forEach(btn => btn.disabled = readonly ? false : !btn.closest(".preference-card").querySelector(".company-select").value);
            if (readonly) {
                saveBtn.style.display = "none";
                toggleEditBtn.innerHTML = `<i class="bi bi-pencil-square me-2"></i>修改志願序`;
                toggleEditBtn.classList.replace("btn-secondary", "btn-primary");
            } else {
                saveBtn.style.display = "inline-block";
                toggleEditBtn.innerHTML = `<i class="bi bi-x-circle me-2"></i>取消修改`;
                toggleEditBtn.classList.replace("btn-primary", "btn-secondary");
            }
        }

        if (toggleEditBtn) {
            toggleEditBtn.addEventListener("click", () => {
                isEditing = !isEditing;
                setReadOnlyMode(!isEditing);
            });
        }

        if (hasSubmitted) setReadOnlyMode(true);
        else toggleEditBtn.style.display = "none";

        // ---------- AI 推薦志願功能 ----------
        const aiRecommendBtn = document.getElementById("aiRecommendBtn");
        if (aiRecommendBtn) {
            aiRecommendBtn.addEventListener("click", async () => {
                // 顯示輸入履歷文字的彈窗
                const { value: resumeText } = await Swal.fire({
                    title: 'AI 推薦志願序',
                    html: `
                        <p class="text-start mb-3">請輸入您的履歷內容，將推薦你最適合的志願序。</p>
                        <textarea id="resumeTextArea" class="swal2-textarea" placeholder="請貼上您的履歷內容，包含：\n- 個人基本資料\n- 學歷背景\n- 技能專長\n- 工作經驗\n- 專案經歷\n- 其他相關資訊..." style="width: 100%; min-height: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"></textarea>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: '開始推薦',
                    cancelButtonText: '取消',
                    preConfirm: () => {
                        const textarea = document.getElementById('resumeTextArea');
                        return textarea ? textarea.value.trim() : '';
                    },
                    didOpen: () => {
                        const textarea = document.getElementById('resumeTextArea');
                        if (textarea) textarea.focus();
                    }
                });

                if (!resumeText) return; // 用戶取消或沒有輸入內容

                // 顯示載入中
                Swal.fire({
                    title: 'AI 正在分析中...',
                    html: '請稍候，這可能需要幾秒鐘時間',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                try {
                    const response = await fetch("/api/recommend-preferences", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ resumeText })
                    });

                    const result = await response.json();

                    if (!result.success) {
                        return Swal.fire({
                            icon: 'error',
                            title: '推薦失敗',
                            text: result.error || '無法取得AI推薦，請稍後再試。'
                        });
                    }

                    const recommendations = result.recommendations || [];
                    if (recommendations.length === 0) {
                        return Swal.fire({
                            icon: 'warning',
                            title: '無推薦結果',
                            text: 'AI 無法生成推薦，請確認履歷內容是否足夠詳細。'
                        });
                    }

                    // 顯示推薦結果
                    let recommendationsHtml = '<div class="text-start" style="max-height: 400px; overflow-y: auto;">';
                    recommendations.forEach((rec, idx) => {
                        recommendationsHtml += `
                            <div class="mb-3 p-3" style="border: 1px solid #ddd; border-radius: 8px; background-color: #f8f9fa;">
                                <h6 class="mb-2"><strong>第 ${rec.order} 志願推薦</strong></h6>
                                <p class="mb-1"><strong>公司：</strong>${rec.company_name}</p>
                                <p class="mb-1"><strong>職缺：</strong>${rec.job_title}</p>
                                <p class="mb-0 text-muted"><small><strong>推薦理由：</strong>${rec.reason || '無'}</small></p>
                            </div>
                        `;
                    });
                    recommendationsHtml += '</div>';

                    const { isConfirmed } = await Swal.fire({
                        icon: 'success',
                        title: `AI 推薦了 ${recommendations.length} 個志願`,
                        html: recommendationsHtml,
                        showCancelButton: true,
                        confirmButtonText: '套用到志願序',
                        cancelButtonText: '取消',
                        width: '600px'
                    });

                    if (isConfirmed) {
                        // 套用推薦到志願序
                        const allCards = document.querySelectorAll(".preference-card");
                        
                        // 使用 Promise 來確保每個推薦都正確套用
                        const applyPromises = recommendations.map((rec, idx) => {
                            return new Promise((resolve) => {
                                if (idx >= allCards.length) {
                                    resolve();
                                    return;
                                }
                                
                                const card = allCards[idx];
                                const companySelect = card.querySelector(".company-select");
                                const jobSelect = card.querySelector(".job-select");
                                
                                // 設定公司
                                companySelect.value = String(rec.company_id);
                                
                                // 載入該公司的職缺
                                loadJobs(String(rec.company_id)).then(() => {
                                    // 等待職缺選單更新
                                    setTimeout(() => {
                                        jobSelect.value = String(rec.job_id);
                                        jobSelect.dispatchEvent(new Event('change'));
                                        resolve();
                                    }, 300);
                                });
                                
                                // 觸發公司選擇事件以載入職缺
                                companySelect.dispatchEvent(new Event('change'));
                            });
                        });

                        // 等待所有推薦套用完成
                        Promise.all(applyPromises).then(() => {
                            updateSelections();
                            Swal.fire({
                                icon: 'success',
                                title: '已套用推薦',
                                text: `已將 ${recommendations.length} 個推薦套用到志願序中，您可以進一步調整後再送出。`,
                                timer: 2000
                            });
                        });
                    }
                } catch (error) {
                    console.error('AI 推薦錯誤:', error);
                    Swal.fire({
                        icon: 'error',
                        title: '網路錯誤',
                        text: '無法連線到伺服器，請稍後再試。'
                    });
                }
            });
        }

        // ---------- 表單送出 ----------
        document.getElementById("preferencesForm").addEventListener("submit", async e => {
            e.preventDefault();
            if (preview) return Swal.fire({ icon: 'warning', title: '未授權', text: '此為預覽模式，請登入學生帳號後再儲存志願序。' });
            const preferences = [];
            let isValid = true;
            document.querySelectorAll(".preference-card").forEach((card, idx) => {
                const companyId = card.querySelector(".company-select").value;
                const jobId = card.querySelector(".job-select").value;
                if (companyId && !jobId) {
                    isValid = false;
                    Swal.fire({ icon: 'error', title: '志願錯誤', text: `第 ${idx + 1} 志願已選擇公司但未選職缺。` });
                }
                if (companyId && jobId) preferences.push({ order: idx + 1, company_id: companyId, job_id: jobId });
            });
            if (!isValid) return;
            if (preferences.length === 0)
                return Swal.fire({ icon: 'warning', title: '尚未填寫志願', text: '至少選擇一個完整志願。' });

            try {
                const res = await fetch("/api/save_preferences", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ preferences })
                });
                const result = await res.json();
                if (result.success) {
                    Swal.fire({ icon: 'success', title: '送出成功！', text: result.message })
                        .then(() => { setReadOnlyMode(true); updateSelections(); });
                } else Swal.fire({ icon: 'error', title: '儲存失敗', text: result.message });
            } catch {
                Swal.fire({ icon: 'error', title: '網路錯誤', text: '無法連線到伺服器。' });
            }
        });
    </script>
</body>

</html>