<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>智慧實習平台 | 實習公司志願序填寫</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: "Noto Sans TC", sans-serif;
            background: #f7f9fc;
            margin: 0;
            padding: 0;
        }

        header {
            background: #0454a3;
            color: white;
            padding: 1rem 2rem;
            text-align: center;
            font-size: 1.5rem;
        }

        .container {
            max-width: 800px;
            margin: 2rem auto;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #004d99;
            margin-bottom: 50px;
            font-weight: 700;
            font-size: 2rem;
            border-bottom: 3px solid #1a73e8;
            display: inline-block;
            padding-bottom: 8px;
        }

        .preference-card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            padding: 20px;
            margin-bottom: 30px;
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .preference-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .card-header-rank {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #e9ecef;
        }

        .rank-number {
            font-size: 1.8rem;
            font-weight: 900;
            color: #ffffff;
            background-color: #1a73e8;
            border-radius: 0.5rem;
            padding: 5px 15px;
            margin-right: 15px;
            line-height: 1;
            box-shadow: 0 4px 10px rgba(26, 115, 232, 0.4);
        }

        .badge-remaining {
            position: absolute;
            right: 30px;
            top: 30px;
            border-radius: 50rem;
            padding: 8px 15px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .badge-remaining.bg-primary {
            background-color: #1a73e8 !important;
            color: white;
        }

        .badge-remaining.bg-secondary {
            background-color: #6c757d !important;
        }

        .form-select,
        .form-label {
            font-size: 1rem;
        }

        .form-label {
            font-weight: 600;
            color: #343a40;
            margin-bottom: 8px;
        }

        .form-select {
            border: 1px solid #ced4da;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem 0.75rem 0.75rem;
            transition: all 0.2s ease;
        }

        .form-select:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 0.25rem rgba(26, 115, 232, 0.25);
        }

        .btn {
            border-radius: 0.6rem;
            font-weight: 600;
            padding: 10px 20px;
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn-success {
            background-color: #00a651;
            border-color: #00a651;
        }

        .btn-success:hover {
            background-color: #008f45;
            border-color: #008f45;
            transform: translateY(-1px);
        }

        .btn-outline-primary {
            margin-top: 10px;
            color: #1a73e8;
            border-color: #1a73e8;
            background-color: transparent;
            padding: 8px 15px;
        }

        .btn-outline-primary:hover:not([disabled]) {
            color: white;
            background-color: #1a73e8;
        }

        .btn-outline-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <header>實習公司志願序填寫</header>
    <div class="container">
        {% if preview %}
        <div class="alert alert-warning text-center" role="alert" style="max-width: 900px;">
            <i class="bi bi-eye-fill me-2"></i>
            **您目前處於預覽模式，無法儲存志願序。請以學生身份登入以填寫。**
        </div>
        {% endif %}

        <form id="preferencesForm" class="mx-auto" style="max-width: 900px;">

            {% for rank in range(1, 5+1) %}
            <div class="preference-card" data-rank="{{ rank }}">
                <div class="card-header-rank">
                    <span class="rank-number">{{ rank }}</span>
                    <h5 class="fw-bold m-0 p-0">第 {{ rank }} 志願</h5>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label"><i class="bi bi-building me-1"></i> 選擇公司</label>
                        <select class="form-select company-select" required
                            data-initial-company="{{ submitted.get(rank, {}).company_id or '' }}">
                            <option value="">-- 請選擇公司 --</option>
                            {% for company in companies %}
                            <option value="{{ company.id }}" {% if submitted.get(rank, {}).company_id==company.id
                                %}selected{% endif %}>
                                {{ company.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <button type="button" class="btn btn-outline-primary btn-sm download-company-btn mt-2" disabled>
                            <i class="bi bi-file-earmark-arrow-down-fill me-1"></i>下載公司資料 (DOCX)
                        </button>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><i class="bi bi-briefcase me-1"></i> 選擇職缺</label>
                        <select class="form-select job-select" required
                            data-initial-job="{{ submitted.get(rank, {}).job_id or '' }}">
                            <option value="">
                                {% if submitted.get(rank, {}).company_id %}-- 載入中... --{% else %}-- 請先選擇公司
                                --{% endif %}
                            </option>
                            {% if submitted.get(rank, {}).job_id %}
                            <option value="{{ submitted[rank].job_id }}" selected>{{ submitted[rank].job_title }}
                            </option>
                            {% endif %}
                        </select>
                    </div>
                </div>
                <span class="badge-remaining bg-secondary">尚未選擇公司</span>
            </div>
            {% endfor %}

            <div class="text-center mt-5">
                {% if preview %}
                <button type="submit" class="btn btn-success px-5 py-2" disabled>
                    <i class="bi bi-lock-fill me-2"></i>登入後可儲存
                </button>
                {% else %}
                
                <button id="aiRecommendBtnNew" type="button" class="btn btn-warning px-5 py-2 me-3" style="background-color: #ffc107; border-color: #ffc107; color: #343a40;">
                    <i class="bi bi-robot me-2"></i>AI 推薦志願序
                </button>

                <button id="toggleEditBtn" type="button" class="btn btn-primary px-5 py-2 me-3">
                    <i class="bi bi-pencil-square me-2"></i>修改志願序
                </button>
                <button id="saveBtn" type="submit" class="btn btn-success px-5 py-2">
                    <i class="bi bi-save-fill me-2"></i>送出志願序
                </button>
                {% endif %}
            </div>
        </form>
    </div>

    <div class="modal fade" id="aiPreferenceModal" tabindex="-1" aria-labelledby="aiPreferenceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aiPreferenceModalLabel"><i class="bi bi-robot me-2"></i>AI 推薦篩選條件</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3 fw-bold">請選擇您的實習條件，AI 將根據這些條件推薦最適合的志願序：</p>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="distance-filter" class="form-label">距離遠近</label>
                            <select class="form-select" id="distance-filter">
                                <option selected value="any">不限距離</option>
                                <option value="close">通勤 30 分鐘內</option>
                                <option value="medium">通勤 1 小時內</option>
                                <option value="far">超過 1 小時</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="transportation-filter" class="form-label">交通工具</label>
                            <select class="form-select" id="transportation-filter">
                                <option selected value="any">不限交通方式</option>
                                <option value="public">以大眾運輸為主</option>
                                <option value="car">以汽車或機車為主</option>
                                <option value="bike">以自行車或步行為主</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="salary-filter" class="form-label">實習薪資類型</label>
                            <select class="form-select" id="salary-filter">
                                <option selected value="any">不限薪資類型</option>
                                <option value="monthly">月薪</option>
                                <option value="hourly">時薪</option>
                                <option value="stipend">獎金或津貼</option>
                                <option value="unpaid">無薪資</option>
                            </select>
                        </div>
                    </div>
                    <hr class="my-4">
                    <p class="mb-3 fw-bold">請輸入您的履歷重點與學業成績摘要，AI 將依此推薦最適合的實習志願序：</p>
                    <div class="mb-3">
                        <label for="resume-text" class="form-label">履歷重點 (可貼上段落或條列重點)</label>
                        <textarea class="form-control" id="resume-text" rows="5"
                            placeholder="例：專長技能、專題/實習經驗、拿手技術、比賽獎項、證照等"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="gpa-scores" class="form-label">學業成績摘要 (例如 GPA、關鍵課程成績、名次或加權)</label>
                        <textarea class="form-control" id="gpa-scores" rows="3"
                            placeholder="例：GPA 3.8/4.3、演算法 A、資料結構 A+、資料庫 A、班排前 10%"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button id="confirmAiPreferenceBtn" type="button" class="btn btn-warning">
                        <i class="bi bi-robot me-2"></i>開始推薦
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script type="application/json" id="companies-data">{{ companies | tojson | safe }}</script>
    <script type="application/json" id="submitted-data">{{ submitted | tojson | safe }}</script>
    <script type="application/json" id="job-slots-data">{{ job_slots | tojson | safe }}</script>
    <script type="application/json" id="preview-data">{{ preview | tojson | safe }}</script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        /* eslint-disable */
        const companies = JSON.parse(document.getElementById("companies-data").textContent || "[]");
        const submitted = JSON.parse(document.getElementById("submitted-data").textContent || "{}");
        const jobSlots = JSON.parse(document.getElementById("job-slots-data").textContent || "{}");
        const preview = JSON.parse(document.getElementById("preview-data").textContent || "false");

        const aiPreferenceModalEl = document.getElementById("aiPreferenceModal");
        const aiPreferenceModal = aiPreferenceModalEl ? new bootstrap.Modal(aiPreferenceModalEl) : null;
        
        const selectedJobIds = new Set();
        const companyJobsCache = {};

        // -------------------------
        // 職缺載入與狀態更新
        // -------------------------
        async function loadJobs(companyId) {
            companyId = String(companyId);
            if (companyJobsCache[companyId]) return companyJobsCache[companyId];

            try {
                const response = await fetch(`/api/get_jobs_by_company?company_id=${companyId}`);
                const data = await response.json();
                if (data.success) {
                    companyJobsCache[companyId] = data.jobs.map(j => ({ id: String(j.id), title: j.title }));
                    return companyJobsCache[companyId];
                }
            } catch (error) {
                console.error("載入職缺失敗:", error);
            }
            return [];
        }

        function updateSelections() {
            const allPreferenceCards = document.querySelectorAll(".preference-card");
            selectedJobIds.clear();

            // 1. 收集所有已選的職缺 ID
            allPreferenceCards.forEach(card => {
                const jobSelect = card.querySelector(".job-select");
                if (jobSelect.value) selectedJobIds.add(jobSelect.value);
            });

            const excludedCompanyIds = new Set();
            // 2. 判斷哪些公司的職缺已被選光
            companies.forEach(company => {
                const cId = String(company.id);
                const jobs = companyJobsCache[cId];
                
                if (!jobs || jobs.length === 0) return; // 無職缺的公司不需判斷

                const selectedCount = jobs.filter(j => selectedJobIds.has(String(j.id))).length;
                
                // 假設一個公司只能選擇一次，或者所有職缺都被選完才排除
                // 這裡簡化為：如果所有職缺都已經被選走，則排除該公司
                if (selectedCount >= jobs.length && jobs.length > 0) {
                    excludedCompanyIds.add(cId);
                }
            });

            // 3. 根據選中的職缺更新公司選單和職缺選單
            allPreferenceCards.forEach(card => {
                const companySelect = card.querySelector(".company-select");
                const jobSelect = card.querySelector(".job-select");
                const badge = card.querySelector(".badge-remaining");
                const downloadBtn = card.querySelector(".download-company-btn");
                
                const selectedCompany = companySelect.value;
                const currentJobValue = jobSelect.value;
                
                downloadBtn.disabled = !selectedCompany;

                // 重新渲染公司選單 (排除已被選完的公司，但保留當前選擇的公司)
                const currentCompanyInnerHTML = companySelect.innerHTML;
                companySelect.innerHTML = `<option value="">-- 請選擇公司 --</option>`;
                companies.forEach(c => {
                    const cId = String(c.id);
                    // 排除已被選光且非當前選擇的公司
                    if (excludedCompanyIds.has(cId) && cId !== selectedCompany) return; 

                    const opt = document.createElement("option");
                    opt.value = cId;
                    opt.textContent = c.name;
                    if (cId === selectedCompany) opt.selected = true;
                    companySelect.appendChild(opt);
                });
                
                const finalCompanyId = companySelect.value;
                
                // 更新職缺選單
                if (finalCompanyId && companyJobsCache[finalCompanyId]) {
                    const availableJobs = companyJobsCache[finalCompanyId];
                    let jobOptions = availableJobs.map(j => {
                        const isSelectedByOther = selectedJobIds.has(String(j.id)) && String(j.id) !== currentJobValue;
                        // 排除已被其他志願選走的職缺
                        if (isSelectedByOther) return null;
                        
                        const opt = document.createElement("option");
                        opt.value = j.id;
                        opt.textContent = j.title;
                        if (String(j.id) === currentJobValue) opt.selected = true;
                        return opt.outerHTML;
                    }).filter(o => o !== null).join("");
                    
                    jobSelect.innerHTML = `<option value="">-- 請選擇職缺 --</option>` + jobOptions;

                    // 確保職缺選單的值仍在選項中，否則重設
                    if (currentJobValue && !jobSelect.querySelector(`option[value="${currentJobValue}"]`)) {
                        jobSelect.value = "";
                    }
                    
                    // 更新剩餘名額 (簡化：顯示已選/總職缺數)
                    const totalJobs = availableJobs.length;
                    const remainingJobs = totalJobs - availableJobs.filter(j => selectedJobIds.has(String(j.id))).length;
                    
                    badge.classList.remove("bg-secondary", "bg-primary");
                    if (totalJobs === 0) {
                        badge.textContent = `無職缺`;
                        badge.classList.add("bg-secondary");
                    } else if (remainingJobs > 0) {
                        badge.textContent = `尚餘 ${remainingJobs} / ${totalJobs} 職缺`;
                        badge.classList.add("bg-primary");
                    } else {
                        badge.textContent = `職缺已選完`;
                        badge.classList.add("bg-secondary");
                    }

                } else {
                    jobSelect.innerHTML = `<option value="">-- 請先選擇公司 --</option>`;
                    badge.textContent = `尚未選擇公司`;
                    badge.classList.remove("bg-primary");
                    badge.classList.add("bg-secondary");
                }
            });
        }


        // -------------------------
        // 初始化載入已填寫志願
        // -------------------------
        async function initializeSubmittedPreferences() {
            const allPreferenceCards = document.querySelectorAll(".preference-card");
            const loadPromises = [];

            allPreferenceCards.forEach(card => {
                const companySelect = card.querySelector(".company-select");
                const jobSelect = card.querySelector(".job-select");
                const initialCompanyId = companySelect.dataset.initialCompany;
                const initialJobId = jobSelect.dataset.initialJob;

                if (initialCompanyId) {
                    loadPromises.push(loadJobs(initialCompanyId).then(jobs => {
                        // 初始化時，將職缺 ID 和名稱塞回去，防止載入延遲導致資訊丟失
                        if (initialJobId && jobs.length > 0) {
                            const initialJob = jobs.find(j => String(j.id) === initialJobId);
                            if (initialJob) {
                                // 確保初始選單中有這個選項（即使它可能已被選）
                                if (!jobSelect.querySelector(`option[value="${initialJobId}"]`)) {
                                    const opt = document.createElement("option");
                                    opt.value = initialJobId;
                                    opt.textContent = initialJob.title;
                                    opt.selected = true;
                                    jobSelect.innerHTML += opt.outerHTML;
                                }
                                jobSelect.value = initialJobId;
                            }
                        }
                    }));
                }
            });

            await Promise.all(loadPromises);
        }

        // -------------------------
        // 事件監聽器
        // -------------------------

        // 監聽公司選擇變動
        document.querySelectorAll(".company-select").forEach(select => {
            select.addEventListener("change", async (e) => {
                const card = e.target.closest(".preference-card");
                const jobSelect = card.querySelector(".job-select");
                const companyId = e.target.value;

                jobSelect.value = ""; // 清空職缺選擇

                if (companyId) {
                    jobSelect.innerHTML = `<option value="">-- 載入中... --</option>`;
                    await loadJobs(companyId);
                }
                
                // 延遲執行 updateSelections 確保 DOM 渲染完成
                setTimeout(updateSelections, 100); 
            });
        });

        // 監聽職缺選擇變動
        document.querySelectorAll(".job-select").forEach(select => {
            select.addEventListener("change", updateSelections);
        });

        // 監聽下載公司資料按鈕
        document.querySelectorAll(".download-company-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const companyId = btn.closest(".preference-card").querySelector(".company-select").value;
                if (companyId) {
                    // 假設有此 API 端點
                    window.location.href = `/api/download_company_file/${companyId}`; 
                }
            });
        });

        // 初始化
        initializeSubmittedPreferences().then(updateSelections);


        // -------------------------
        // 狀態控制 (鎖定/修改模式)
        // -------------------------
        let isEditing = false;
        const hasSubmitted = Object.keys(submitted || {}).length > 0;
        const saveBtn = document.getElementById("saveBtn");
        const toggleEditBtn = document.getElementById("toggleEditBtn");
        const aiRecommendBtn = document.getElementById("aiRecommendBtnNew");
        const allSelects = document.querySelectorAll(".company-select, .job-select");

        function setReadOnlyMode(readonly) {
            allSelects.forEach(sel => sel.disabled = readonly);
            document.querySelectorAll(".download-company-btn").forEach(btn => 
                // 下載按鈕在唯讀模式下應可用，但如果沒選公司仍應禁用
                btn.disabled = readonly ? !btn.closest(".preference-card").querySelector(".company-select").value : !btn.closest(".preference-card").querySelector(".company-select").value
            );
            
            if (readonly) {
                saveBtn.style.display = "none";
                toggleEditBtn.innerHTML = `<i class="bi bi-pencil-square me-2"></i>修改志願序`;
                toggleEditBtn.classList.replace("btn-secondary", "btn-primary");
                if(aiRecommendBtn) aiRecommendBtn.style.display = "none";
            } else {
                saveBtn.style.display = "inline-block";
                toggleEditBtn.innerHTML = `<i class="bi bi-x-circle me-2"></i>取消修改`;
                toggleEditBtn.classList.replace("btn-primary", "btn-secondary");
                if(aiRecommendBtn) aiRecommendBtn.style.display = "inline-block";
            }
        }

        if (toggleEditBtn) {
            toggleEditBtn.addEventListener("click", () => {
                isEditing = !isEditing;
                setReadOnlyMode(!isEditing);
            });
        }
        
        // 頁面載入時根據是否有已填寫資料決定初始模式
        if (hasSubmitted) {
            setReadOnlyMode(true);
        } else {
            // 如果沒有提交過，預設為編輯模式
            isEditing = true;
            setReadOnlyMode(false); 
            if(toggleEditBtn) toggleEditBtn.style.display = "none";
        }


        // -------------------------
        // 表單儲存志願序 (送出志願序)
        // -------------------------
        document.getElementById("preferencesForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            if (preview) return; // 預覽模式禁用

            let isValid = true;
            const preferences = [];

            // 檢查並收集已填寫的志願
            document.querySelectorAll(".preference-card").forEach((card, idx) => {
                const companySelect = card.querySelector(".company-select");
                const jobSelect = card.querySelector(".job-select");
                const companyId = companySelect.value;
                const jobId = jobSelect.value;
                
                // 檢查是否選了公司但沒選職缺
                if (companyId && !jobId) {
                    isValid = false;
                    Swal.fire({ icon: 'error', title: '志願錯誤', text: `第 ${idx + 1} 志願已選擇公司但未選職缺。` });
                }
                
                // 只提交完整填寫的志願
                if (companyId && jobId) {
                    preferences.push({ order: idx + 1, company_id: companyId, job_id: jobId });
                }
            });
            
            if (!isValid) return;

            if (preferences.length === 0)
                return Swal.fire({ icon: 'warning', title: '尚未填寫志願', text: '至少選擇一個完整志願。' });

            Swal.fire({
                title: '確認送出志願序嗎？',
                text: `您將送出 ${preferences.length} 個志願。`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '確認送出',
                cancelButtonText: '取消',
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const res = await fetch("/api/save_preferences", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ preferences })
                        });
                        const result = await res.json();
                        if (result.success) {
                            Swal.fire({ icon: 'success', title: '送出成功！', text: result.message })
                                .then(() => { 
                                    setReadOnlyMode(true); 
                                    isEditing = false;
                                    updateSelections(); 
                                });
                        } else {
                            Swal.fire({ icon: 'error', title: '儲存失敗', text: result.message });
                        }
                    } catch (e) {
                        console.error(e);
                        Swal.fire({ icon: 'error', title: '連線錯誤', text: '無法連線到伺服器，請檢查網路。' });
                    }
                }
            });
        });


        // -------------------------
        // AI 推薦志願功能
        // -------------------------
        if (aiRecommendBtn && aiPreferenceModal) {
            aiRecommendBtn.addEventListener("click", () => {
                // 如果已經填寫過但不在編輯模式，自動切換到編輯模式
                if (hasSubmitted && !isEditing) {
                    isEditing = true;
                    setReadOnlyMode(false);
                }
                aiPreferenceModal.show();
            });
        }
        
        const confirmAiPreferenceBtn = document.getElementById("confirmAiPreferenceBtn");
        if (confirmAiPreferenceBtn) {
            confirmAiPreferenceBtn.addEventListener("click", async () => {
                const distanceFilter = document.getElementById("distance-filter").value;
                const transportationFilter = document.getElementById("transportation-filter").value;
                const salaryFilter = document.getElementById("salary-filter").value;
                const resumeText = document.getElementById("resume-text").value;
                const gpaScores = document.getElementById("gpa-scores").value;

                if (!resumeText && !gpaScores) {
                     Swal.fire({ icon: 'warning', title: '資料不足', text: '請至少提供履歷重點或學業成績摘要，以利 AI 進行推薦。' });
                     return;
                }
                
                aiPreferenceModal.hide();
                Swal.fire({
                    title: 'AI 正在分析與推薦...',
                    text: '這可能需要幾秒鐘，請稍候。',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                try {
                    const res = await fetch("/api/recommend-preferences", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            distance_filter: distanceFilter,
                            transportation_filter: transportationFilter,
                            salary_filter: salaryFilter,
                            resume_text: resumeText,
                            gpa_scores: gpaScores
                        })
                    });
                    
                    Swal.close();

                    const result = await res.json();
                    if (result.success) {
                        const recommendations = result.recommendations || [];
                        if (recommendations.length === 0) {
                            Swal.fire({ icon: 'info', title: '無推薦結果', text: 'AI 未能找到符合您條件的職缺。請嘗試放寬篩選條件。' });
                            return;
                        }

                        // 產生推薦結果的 HTML 列表
                        const recommendationsHtml = `
                            <p class="text-start fw-bold">AI 推薦了以下 ${recommendations.length} 個志願，請確認後套用：</p>
                            <ul class="list-group list-group-flush text-start">
                            ${recommendations.map((rec, idx) => `
                                <li class="list-group-item d-flex justify-content-between align-items-start">
                                    <div class="ms-2 me-auto">
                                        <div class="fw-bold">第 ${idx + 1} 志願: ${rec.company_name} - ${rec.job_title}</div>
                                        <small class="text-muted">${rec.reason || 'AI 匹配推薦'}</small>
                                    </div>
                                </li>
                            `).join('')}
                            </ul>
                        `;

                        // 顯示 SweetAlert 確認是否套用
                        const { isConfirmed } = await Swal.fire({
                            icon: 'success',
                            title: `AI 推薦了 ${recommendations.length} 個志願`,
                            html: recommendationsHtml,
                            showCancelButton: true,
                            confirmButtonText: '套用到志願序',
                            cancelButtonText: '取消',
                            width: '600px'
                        });

                        if (isConfirmed) {
                            const allCards = document.querySelectorAll(".preference-card");
                            
                            // 清空所有志願
                            allCards.forEach(card => {
                                card.querySelector(".company-select").value = "";
                                card.querySelector(".job-select").value = "";
                            });
                            
                            // 逐一設定推薦結果
                            const applyPromises = recommendations.map((rec, idx) => {
                                return new Promise((resolve) => {
                                    if (idx >= allCards.length) {
                                        resolve();
                                        return;
                                    }
                                    const card = allCards[idx];
                                    const companySelect = card.querySelector(".company-select");
                                    const jobSelect = card.querySelector(".job-select");
                                    
                                    // 1. 設定公司
                                    companySelect.value = String(rec.company_id);
                                    
                                    // 2. 載入職缺並設定職缺
                                    loadJobs(String(rec.company_id)).then(() => {
                                        // 由於 loadJobs 是非同步的，需要一點延遲確保 updateSelections 能夠正確取得 job list
                                        setTimeout(() => {
                                            jobSelect.value = String(rec.job_id);
                                            resolve();
                                        }, 50); 
                                    });
                                });
                            });

                            await Promise.all(applyPromises);
                            updateSelections(); // 最後統一更新 UI
                            Swal.fire({ icon: 'info', title: '套用成功', text: 'AI 推薦的志願序已填入表單，請確認後點擊「送出志願序」。' });

                        }
                    } else {
                        Swal.fire({ icon: 'error', title: 'AI 推薦失敗', text: result.error || '無法取得 AI 推薦結果。' });
                    }

                } catch (e) {
                    Swal.close();
                    console.error("AI 推薦連線錯誤:", e);
                    Swal.fire({ icon: 'error', title: '連線錯誤', text: '無法連線到 AI 服務。' });
                }
            });
        }
    </script>
</body>
</html>