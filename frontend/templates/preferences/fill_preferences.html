<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å¯¦ç¿’å…¬å¸å¿—é¡˜åºå¡«å¯«</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
      background-color: #ffffff;
      padding: 20px;
    }

    h2 {
      text-align: center;
      color: #1a73e8;
      margin-bottom: 30px;
      font-weight: 700;
    }

    .preference-card {
      background-color: #ffffff;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      padding: 25px;
      margin-bottom: 20px;
      position: relative;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .preference-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }

    .badge-remaining {
      position: absolute;
      right: 25px;
      top: 25px;
      background-color: #0d6efd;
      color: white;
      border-radius: 15px;
      padding: 5px 12px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .company-preview {
      font-size: 15px;
      color: #333;
    }

    .company-preview .section {
      background: #f9fbfd;
      border: 1px solid #e0e6ed;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
    }

    .company-preview .section h5 {
      color: #0d6efd;
      font-weight: 600;
      margin-bottom: 15px;
      border-bottom: 1px solid #e0e6ed;
      padding-bottom: 8px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px 20px;
    }

    .info-grid .full {
      grid-column: 1 / -1;
    }

    .info-grid div {
      background: #fff;
      border: 1px solid #e2e6ea;
      border-radius: 8px;
      padding: 12px 15px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      transition: background 0.2s;
    }

    .info-grid div:hover {
      background: #f1f5f9;
    }

    .info-grid strong {
      color: #0d6efd;
      font-size: 14px;
      margin-bottom: 5px;
    }

    .info-grid span {
      font-size: 15px;
      color: #444;
      white-space: pre-wrap;
    }

    .form-select {
      border-radius: 0.5rem;
      transition: box-shadow 0.2s;
    }

    .form-select:focus {
      box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }

    .btn {
      border-radius: 0.6rem;
      font-weight: 500;
    }

    .btn-outline-info {
      margin-top: 10px;
    }

    .modal-body {
      max-height: 75vh;
      overflow-y: auto;
      padding: 20px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>å¯¦ç¿’å…¬å¸å¿—é¡˜åºå¡«å¯«</h2>

    <form id="preferencesForm" class="mx-auto" style="max-width: 700px;">
      {% for i in range(1, 6) %}
      <div class="preference-card" data-rank="{{ i }}">
        <h5 class="fw-bold">ç¬¬ {{ i }} å¿—é¡˜</h5>

        <div class="mb-3">
          <label class="form-label">é¸æ“‡å…¬å¸</label>
          <select class="form-select company-select" required>
            <option value="">-- è«‹é¸æ“‡å…¬å¸ --</option>
            {% for c in companies %}
            <option value="{{ c['id'] }}">{{ c['name'] }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">é¸æ“‡è·ç¼º</label>
          <select class="form-select job-select" required>
            <option value="">-- è«‹å…ˆé¸æ“‡å…¬å¸ --</option>
          </select>
        </div>
        <button type="button" class="btn btn-outline-info btn-sm view-company-btn" disabled>æŸ¥çœ‹å…¬å¸è©³æƒ…</button>

        <span class="badge-remaining">å°šæœªé¸æ“‡å…¬å¸</span>
      </div>
      {% endfor %}

      <div class="text-center mt-4">
        <button type="submit" class="btn btn-success px-5 py-2">å„²å­˜å¿—é¡˜åº</button>
      </div>
    </form>
  </div>

  <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="previewContent"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // å¾ Flask æ¨¡æ¿ä¸­å–å¾—è³‡æ–™
    const preview = {{ 'true' if preview else 'false' }};
    const companySlots = {{ job_slots | tojson }};
    const companies = {{ companies | tojson }};

    // ç¶å®šå…¬å¸ä¸‹æ‹‰è®ŠåŒ–ï¼Œå‹•æ…‹è¼‰å…¥è·ç¼º
    document.querySelectorAll(".company-select").forEach(select => {
      select.addEventListener("change", async (e) => {
        const selectedCompany = e.target.value;
        const card = e.target.closest(".preference-card");
        const jobSelect = card.querySelector(".job-select");
        const badge = card.querySelector(".badge-remaining");
        const viewBtn = card.querySelector(".view-company-btn");

        viewBtn.disabled = !selectedCompany;

        // åˆå§‹è·ç¼ºé¸å–®
        jobSelect.innerHTML = `<option value="">-- è«‹å…ˆé¸æ“‡å…¬å¸ --</option>`;

        if (!selectedCompany) {
          badge.textContent = "å°šæœªé¸æ“‡å…¬å¸";
          updateRemainingDisplay();
          return;
        }

        try {
          // å–å¾—è·ç¼º API å‘¼å«
          const res = await fetch(`/api/get_jobs_by_company?company_id=${selectedCompany}`);
          const data = await res.json();

          if (data.success && data.jobs.length > 0) {
            // è¼‰å…¥è·ç¼ºé¸é …
            jobSelect.innerHTML = data.jobs.map(j =>
              `<option value="${j.id}">${j.title}</option>`
            ).join('');
          } else {
            jobSelect.innerHTML = `<option value="">ï¼ˆç„¡å¯ç”¨è·ç¼ºï¼‰</option>`;
          }
        } catch (err) {
          console.error(err);
        }

        updateRemainingDisplay();
      });
    });

    // æŸ¥çœ‹å…¬å¸è©³æƒ… Modal (é‚è¼¯ä¸è®Š)
    document.querySelectorAll(".preference-card").forEach(card => {
      const viewBtn = card.querySelector(".view-company-btn");
      const companySelect = card.querySelector(".company-select");

      viewBtn.addEventListener("click", async () => {
        const companyId = companySelect.value;
        if (!companyId) return;

        try {
          const res = await fetch(`/api/get_company_detail?company_id=${companyId}`);
          const data = await res.json();
          if (!data.success) { alert("æŸ¥ç„¡å…¬å¸è³‡æ–™"); return; }

          const c = data.company;
          const content = `
<div class="company-preview">
  <div class="section">
    <h5>å…¬å¸åŸºæœ¬è³‡æ–™</h5>
    <div class="info-grid">
      <div><strong>å…¬å¸åç¨±</strong><span>${c.company_name || '-'}</span></div>
      <div><strong>å…¬å¸åœ°å€</strong><span>${c.company_address || '-'}</span></div>
    </div>
  </div>
  <div class="section">
    <h5>è¯çµ¡è³‡è¨Š</h5>
    <div class="info-grid">
      <div><strong>è¯çµ¡äººå§“å</strong><span>${c.contact_name || '-'}</span></div>
      <div><strong>è¯çµ¡é›»è©±</strong><span>${c.contact_phone || '-'}</span></div>
      <div class="full"><strong>é›»å­éƒµä»¶</strong><span>${c.contact_email || '-'}</span></div>
    </div>
  </div>
  <div class="section">
    <h5>å¯¦ç¿’è·ç¼ºè³‡è¨Š</h5>
    ${(c.internship_jobs || []).map(job => `
      <div class="info-grid">
        <div><strong>å¯¦ç¿’è·ä½</strong><span>${job.internship_unit || '-'}</span></div>
        <div><strong>æ‰€å±¬éƒ¨é–€</strong><span>${job.department || '-'}</span></div>
        <div><strong>æœŸé–“</strong><span>${job.internship_period || '-'}</span></div>
        <div><strong>æ™‚æ®µ</strong><span>${job.internship_time || '-'}</span></div>
        <div><strong>åé¡</strong><span>${job.internship_quota || '-'}</span></div>
        <div class="full"><strong>å¯¦ç¿’å…§å®¹</strong><span>${job.internship_content || '-'}</span></div>
        <div class="full"><strong>å‚™è¨»</strong><span>${job.remark || '-'}</span></div>
      </div>
    `).join('')}
  </div>
</div>
          `;
          document.getElementById("previewContent").innerHTML = content;
          new bootstrap.Modal(document.getElementById("previewModal")).show();
        } catch (err) {
          console.error(err);
          alert("å–å¾—å…¬å¸è³‡æ–™å¤±æ•—");
        }
      });
    });

    // =========================================================================
    // ğŸ’¥ æ ¸å¿ƒä¿®æ”¹ï¼šæ›´æ–°å‰©é¤˜é¡åº¦åŠé¸å–®é¡¯ç¤ºé‚è¼¯
    //    - å¯¦ç¾å…¬å¸åç¨±åªå‡ºç¾ä¸€æ¬¡ã€‚
    //    - å¯¦ç¾å…¬å¸å¯é¸æ¬¡æ•¸ç­‰æ–¼è·ç¼ºæ•¸ (N)ã€‚
    // =========================================================================
    function updateRemainingDisplay() {
      const allCompanies = document.querySelectorAll(".company-select");
      
      // 1. çµ±è¨ˆæ¯å€‹å…¬å¸åœ¨æ‰€æœ‰å¿—é¡˜ä¸­å·²è¢«é¸æ“‡çš„æ¬¡æ•¸ (used)
      const companyUsage = {};
      // åˆå§‹åŒ–è¨ˆæ•¸å™¨ï¼Œç¢ºä¿æ‰€æœ‰å…¬å¸ ID éƒ½åœ¨ map è£¡
      Object.keys(companySlots).forEach(cid => {
          companyUsage[cid] = 0; 
      });

      allCompanies.forEach(s => { 
          const cid = s.value; 
          if (cid) {
              companyUsage[cid]++;
          }
      });

      // 2. éæ­·æ¯ä¸€å€‹å…¬å¸é¸æ“‡ä¸‹æ‹‰é¸å–®
      allCompanies.forEach(select => {
          const card = select.closest(".preference-card");
          const badge = card.querySelector(".badge-remaining");
          const currentValue = select.value; // ç•¶å‰å¿—é¡˜å·²é¸çš„å…¬å¸ ID

          // æ¸…ç©ºé¸é …ä½†ä¿ç•™ "--è«‹é¸æ“‡å…¬å¸--"
          const firstOption = select.querySelector('option[value=""]');
          select.innerHTML = '';
          select.appendChild(firstOption);

          // 3. éæ­·æ‰€æœ‰å…¬å¸ï¼Œæ±ºå®šå“ªäº›å…¬å¸å¯ä»¥è¢«åˆ—å‡º
          companies.forEach(c => {
              const cid = String(c.id); // ç¢ºä¿æ˜¯å­—ä¸²æ¯”è¼ƒ
              const companyName = c.name;
              // å–å¾—ç¸½è·ç¼ºæ•¸ (N)ï¼Œæ­¤å€¼ä¾†è‡ª company.py çš„ slots æ¬„ä½
              const totalSlots = Number(companySlots[cid] || 0); 

              const usedSlots = companyUsage[cid] || 0; // è©²å…¬å¸å·²è¢«é¸æ¬¡æ•¸
              
              // è©²å…¬å¸é‚„å¯ä»¥è¢«é¸æ“‡çš„å‰©é¤˜æ¬¡æ•¸
              // å¦‚æœç•¶å‰å¿—é¡˜å·²ç¶“é¸æ“‡è©²å…¬å¸ (currentValue === cid)ï¼Œå‰‡å®ƒçš„ usedSlots å·²ç¶“å¤šç®—äº† 1 æ¬¡ï¼Œè¦æ‰£å›ä¾†
              let remaining = totalSlots - usedSlots + (currentValue === cid ? 1 : 0);

              // è¦å‰‡ï¼š
              // åªè¦ (æœ‰å‰©é¤˜æ¬¡æ•¸ remaining > 0) æˆ–æ˜¯ (ç•¶å‰å¿—é¡˜å°±æ˜¯é¸ä¸­è©²å…¬å¸ currentValue === cid) å°±é¡¯ç¤ºã€‚
              // ç”±æ–¼ companies é™£åˆ—æœ¬èº«æ˜¯å”¯ä¸€çš„å…¬å¸åˆ—è¡¨ï¼Œåªæœƒå»ºç«‹ä¸€æ¬¡é¸é …ï¼Œå¯¦ç¾ã€Œå‡ºç¾ä¸€æ¬¡ã€ã€‚
              if (remaining > 0 || currentValue === cid) {
                  const opt = document.createElement('option');
                  opt.value = cid;
                  opt.textContent = companyName; 
                  if (currentValue === cid) opt.selected = true;
                  
                  // é¡¯ç¤ºå‰©é¤˜é¡åº¦
                  opt.textContent += ` (${remaining} å€‹é¡åº¦)`;

                  select.appendChild(opt);
              }
          });

          // 4. æ›´æ–° badge é¡¯ç¤ºç‹€æ…‹
          if (currentValue) {
              const total = Number(companySlots[currentValue] || 0);
              const used = companyUsage[currentValue] || 0;
              // ä¿®æ­£å¾Œçš„å‰©é¤˜æ¬¡æ•¸
              const currentRemaining = total - used + (currentValue === select.value ? 1 : 0); 
              
              badge.textContent = `å‰©é¤˜é¡åº¦ï¼š${currentRemaining}`;
              badge.classList.remove("bg-primary", "bg-danger");
              if (currentRemaining > 0) {
                   badge.classList.add("bg-primary");
              } else {
                   badge.classList.add("bg-danger"); 
              }
          } else {
              badge.textContent = "å°šæœªé¸æ“‡å…¬å¸";
              badge.classList.remove("bg-primary", "bg-danger");
          }
      });
    }
    // =========================================================================
    // ğŸ’¥ æ ¸å¿ƒä¿®æ”¹çµæŸ
    // =========================================================================

    // è¡¨å–®å„²å­˜ (é‚è¼¯ä¸è®Š)
    document.getElementById("preferencesForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (preview) {
        alert("æ­¤ç‚ºé è¦½æ¨¡å¼ï¼Œè«‹ç™»å…¥å­¸ç”Ÿå¸³è™Ÿå¾Œå†å„²å­˜å¿—é¡˜åºã€‚");
        return;
      }
      const preferences = [];
      document.querySelectorAll(".preference-card").forEach((card, idx) => {
        const companyId = card.querySelector(".company-select").value;
        const jobId = card.querySelector(".job-select").value;
        if (companyId && jobId) preferences.push({ order: idx + 1, company_id: companyId, job_id: jobId });
      });

      const res = await fetch("/api/save_preferences", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ preferences })
      });

      const data = await res.json();
      alert(data.message);
      if (data.success) location.reload();
    });

    // åˆå§‹
    updateRemainingDisplay();

    // é è¦½æ¨¡å¼ï¼šåœç”¨æ“ä½œèˆ‡æäº¤ (é‚è¼¯ä¸è®Š)
    (function applyPreviewMode(){
      if (!preview) return;
      document.querySelectorAll(".company-select, .job-select, .view-company-btn").forEach(el => {
        if (el.tagName === 'BUTTON') {
          el.disabled = true;
        } else {
          el.setAttribute('disabled', 'disabled');
        }
      });
      const submitBtn = document.querySelector('#preferencesForm button[type="submit"]');
      if (submitBtn) {
        submitBtn.textContent = 'ç™»å…¥å¾Œå¯å„²å­˜';
        submitBtn.setAttribute('disabled', 'disabled');
      }
    })();
  </script>
</body>

</html>