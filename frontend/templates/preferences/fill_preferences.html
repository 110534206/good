<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>實習公司志願序填寫</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
      background-color: #ffffff;
      padding: 20px;
    }

    h2 {
      text-align: center;
      color: #1a73e8;
      margin-bottom: 30px;
      font-weight: 700;
    }

    .preference-card {
      background-color: #ffffff;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      padding: 25px;
      margin-bottom: 20px;
      position: relative;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .preference-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }

    .badge-remaining {
      position: absolute;
      right: 25px;
      top: 25px;
      background-color: #6c757d;
      color: white;
      border-radius: 15px;
      padding: 5px 12px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .form-select {
      border-radius: 0.5rem;
      transition: box-shadow 0.2s;
    }

    .form-select:focus {
      box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }

    .btn {
      border-radius: 0.6rem;
      font-weight: 500;
    }

    .btn-outline-primary {
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>實習公司志願序填寫</h2>

    <form id="preferencesForm" class="mx-auto" style="max-width: 700px;">
      {% for i in range(1, 6) %}
      <div class="preference-card" data-rank="{{ i }}">
        <h5 class="fw-bold">第 {{ i }} 志願</h5>

        <div class="mb-3">
          <label class="form-label">選擇公司</label>
          <select class="form-select company-select" required>
            <option value="">-- 請選擇公司 --</option>
            {% for c in companies %}
            <option value="{{ c['id'] }}">{{ c['name'] }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">選擇職缺</label>
          <select class="form-select job-select" required>
            <option value="">-- 請先選擇公司 --</option>
          </select>
        </div>

        <!-- 按鈕：下載公司資料 -->
        <button type="button" class="btn btn-outline-primary btn-sm download-company-btn" disabled>
          下載公司資料 (DOCX)
        </button>

        <span class="badge-remaining">尚未選擇公司</span>
      </div>
      {% endfor %}

      <div class="text-center mt-4">
        <button type="submit" class="btn btn-success px-5 py-2">儲存志願序</button>
      </div>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const preview = {{ 'true' if preview else 'false' }};
    const companies = {{ companies | tojson }};
    const companySlots = {{ job_slots | tojson }};
    const submitted = {{ submitted | tojson }};

    const selectedJobIds = new Set();
    const companyJobsCache = {};

    // 更新所有公司與職缺選單狀態
    function updateSelections() {
      const allCompanySelects = document.querySelectorAll(".company-select");
      selectedJobIds.clear();

      // 1. 統計目前所有已選職缺
      allCompanySelects.forEach(select => {
        const jobSelect = select.closest(".preference-card").querySelector(".job-select");
        const selectedJob = jobSelect.value;
        if (selectedJob) selectedJobIds.add(selectedJob);
      });

      // 2. 計算每家公司剩餘可選職缺數量 (用於排除已滿公司)
      const companyRemainingJobs = {};
      for (const company of companies) { 
          const companyId = String(company.id);
          if (companyJobsCache[companyId]) {
              const totalJobs = companyJobsCache[companyId].length;
              let selectedCount = 0;
              companyJobsCache[companyId].forEach(job => {
                  if (selectedJobIds.has(String(job.id))) {
                      selectedCount++;
                  }
              });
              companyRemainingJobs[companyId] = totalJobs - selectedCount;
          } else {
              // 尚未載入職缺的公司，視為還有名額，不應被排除
              companyRemainingJobs[companyId] = 1; 
          }
      }

      // 3. 重新更新每張卡片的可選項與狀態
      allCompanySelects.forEach(select => {
        const card = select.closest(".preference-card");
        const jobSelect = card.querySelector(".job-select");
        const badge = card.querySelector(".badge-remaining");
        const downloadBtn = card.querySelector(".download-company-btn");

        const selectedCompany = select.value; // 當前選擇的公司 ID
        const currentJobValue = jobSelect.value; // 當前選擇的職缺 ID (若有)

        downloadBtn.disabled = !selectedCompany;

        // 更新徽章顏色與內容
        if (selectedCompany) {
          badge.textContent = "已選擇公司";
          badge.classList.remove("bg-danger", "bg-secondary");
          badge.classList.add("bg-primary");
        } else {
          badge.textContent = "尚未選擇公司";
          badge.classList.remove("bg-danger", "bg-primary");
          badge.classList.add("bg-secondary");
        }
        
        // --- 職缺下拉更新邏輯 (目標 1) ---
        if (selectedCompany && companyJobsCache[selectedCompany]) {
          const availableJobs = companyJobsCache[selectedCompany];
          jobSelect.innerHTML = `<option value="">-- 請選擇職缺 --</option>`;

          let jobFound = false;
          let hasAvailableOptions = false;
          
          availableJobs.forEach(j => {
            // 排除已被其他志願選走，且不是當前志願的職缺
            const isExcluded = selectedJobIds.has(String(j.id)) && String(j.id) !== currentJobValue;
            
            if (!isExcluded) {
              const opt = document.createElement("option");
              opt.value = j.id;
              opt.textContent = j.title;
              if (String(j.id) === currentJobValue) {
                opt.selected = true;
                jobFound = true;
              }
              jobSelect.appendChild(opt);
              hasAvailableOptions = true;
            }
          });

          if (!hasAvailableOptions) {
            jobSelect.innerHTML = `<option value="">（無可用職缺）</option>`;
            // 清空職缺選取，避免選擇到無效職缺
            if (currentJobValue) jobSelect.value = "";
          } else if (!jobFound && currentJobValue) {
             // 如果原本選的職缺現在被排除，則清除選中的職缺
             jobSelect.value = ""; 
          }
        
        } else if (!selectedCompany) {
          jobSelect.innerHTML = `<option value="">-- 請先選擇公司 --</option>`;
        }
        
        // --- 公司下拉更新邏輯 (目標 2) ---
        // 重建公司下拉選單
        select.innerHTML = `<option value="">-- 請選擇公司 --</option>`;
        companies.forEach(c => {
          const cId = String(c.id);
          const isCurrentSelected = cId === selectedCompany; // 允許顯示當前已選的公司
          
          // 判斷是否為「已滿且非當前選中」的公司
          const isFullyOccupiedAndNotSelected = 
              companyJobsCache[cId] && // 職缺資料已載入
              !isCurrentSelected && // 且不是當前卡片選中的公司
              companyRemainingJobs[cId] <= 0; // 且剩餘職缺為 0 (已滿)


          if (!isFullyOccupiedAndNotSelected) {
            const opt = document.createElement("option");
            opt.value = c.id;
            opt.textContent = c.name;
            if (isCurrentSelected) opt.selected = true;
            select.appendChild(opt);
          }
        });

      });
    }

    // 載入公司職缺
    async function loadJobs(companyId) {
      if (companyJobsCache[companyId]) return companyJobsCache[companyId];
      try {
        const res = await fetch(`/api/get_jobs_by_company?company_id=${companyId}`);
        const data = await res.json();
        if (data.success && data.jobs.length > 0) {
          companyJobsCache[companyId] = data.jobs.map(j => ({ id: String(j.id), title: j.title }));
          return companyJobsCache[companyId];
        } else {
          companyJobsCache[companyId] = [];
          return [];
        }
      } catch (err) {
        console.error("載入職缺失敗:", err);
        return [];
      }
    }

    // 綁定公司選單變化
    document.querySelectorAll(".company-select").forEach(select => {
  select.addEventListener("change", async e => {
    const companyId = e.target.value;
    const jobSelect = e.target.closest(".preference-card").querySelector(".job-select");
    
    if (companyId) {
      // 顯示載入中
      jobSelect.innerHTML = `<option value="">-- 載入中... --</option>`;
      
      // 載入公司職缺
      const jobs = await loadJobs(companyId);
      
      if (jobs.length > 0) {
        jobSelect.innerHTML = `<option value="">-- 請選擇職缺 --</option>`;
        jobs.forEach(j => {
          const opt = document.createElement("option");
          opt.value = j.id;
          opt.textContent = j.title;
          jobSelect.appendChild(opt);
        });
      } else {
        jobSelect.innerHTML = `<option value="">（無可用職缺）</option>`;
      }
    } else {
      jobSelect.innerHTML = `<option value="">-- 請先選擇公司 --</option>`;
    }
    updateSelections(); // 更新所有下拉選單狀態
  });
});

    // 綁定職缺選單變化
    document.querySelectorAll(".job-select").forEach(select => {
      select.addEventListener("change", updateSelections);
    });

    // 下載公司資料
    document.querySelectorAll(".preference-card").forEach(card => {
      const downloadBtn = card.querySelector(".download-company-btn");
      const companySelect = card.querySelector(".company-select");
      downloadBtn.addEventListener("click", () => {
        const companyId = companySelect.value;
        if (!companyId) return;
        const url = `/api/download_company_file/${companyId}`;
        window.open(url, "_blank");
      });
    });

    // 初始化：載入已提交志願
    async function initializeSubmittedPreferences() {
      const allCompanySelects = document.querySelectorAll(".company-select");
      const loadPromises = [];

      allCompanySelects.forEach(select => {
        const rank = parseInt(select.closest(".preference-card").dataset.rank);
        const savedPref = submitted[rank];
        if (savedPref) {
          // 確保公司選項存在且被選中
          select.value = savedPref.company_id;
          loadPromises.push(loadJobs(savedPref.company_id));
        }
      });

      await Promise.all(loadPromises);

      // 第二階段：設定職缺
      allCompanySelects.forEach(select => {
        const rank = parseInt(select.closest(".preference-card").dataset.rank);
        const savedPref = submitted[rank];
        const jobSelect = select.closest(".preference-card").querySelector(".job-select");
        if (savedPref) {
          const jobs = companyJobsCache[savedPref.company_id] || [];
          
          // 重建職缺選項
          jobSelect.innerHTML =
            `<option value="">-- 請選擇職缺 --</option>` +
            jobs
              .map(j => `<option value="${j.id}" ${String(j.id) === String(savedPref.job_id) ? "selected" : ""}>${j.title}</option>`)
              .join("");
        }
      });

      updateSelections();
    }

    initializeSubmittedPreferences();

    // 預覽模式：停用互動
    (function applyPreviewMode() {
      if (!preview) return;
      document.querySelectorAll(".company-select, .job-select, .download-company-btn").forEach(el => {
        el.disabled = true;
      });
      const submitBtn = document.querySelector("#preferencesForm button[type='submit']");
      if (submitBtn) {
        submitBtn.textContent = "登入後可儲存";
        submitBtn.disabled = true;
      }
    })();

    // 儲存志願序
    document.getElementById("preferencesForm").addEventListener("submit", async e => {
      e.preventDefault();
      if (preview) {
        alert("此為預覽模式，請登入學生帳號後再儲存志願序。");
        return;
      }

      const preferences = [];
      document.querySelectorAll(".preference-card").forEach((card, idx) => {
        const companyId = card.querySelector(".company-select").value;
        const jobId = card.querySelector(".job-select").value;
        if (companyId && jobId)
          preferences.push({ order: idx + 1, company_id: companyId, job_id: jobId });
      });

      const res = await fetch("/api/save_preferences", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ preferences })
      });

      const data = await res.json();
      alert(data.message);
      if (data.success) location.reload();
    });
  </script>
</body>
</html>
