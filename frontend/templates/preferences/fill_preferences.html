<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>實習公司志願序填寫</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
      background-color: #ffffff;
      padding: 20px;
    }

    h2 {
      text-align: center;
      color: #1a73e8;
      margin-bottom: 30px;
      font-weight: 700;
    }

    .preference-card {
      background-color: #ffffff;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      padding: 25px;
      margin-bottom: 20px;
      position: relative;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .preference-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }

    .badge-remaining {
      position: absolute;
      right: 25px;
      top: 25px;
      background-color: #0d6efd;
      color: white;
      border-radius: 15px;
      padding: 5px 12px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .company-preview {
      font-size: 15px;
      color: #333;
    }

    .company-preview .section {
      background: #f9fbfd;
      border: 1px solid #e0e6ed;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
    }

    .company-preview .section h5 {
      color: #0d6efd;
      font-weight: 600;
      margin-bottom: 15px;
      border-bottom: 1px solid #e0e6ed;
      padding-bottom: 8px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px 20px;
    }

    .info-grid .full {
      grid-column: 1 / -1;
    }

    .info-grid div {
      background: #fff;
      border: 1px solid #e2e6ea;
      border-radius: 8px;
      padding: 12px 15px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      transition: background 0.2s;
    }

    .info-grid div:hover {
      background: #f1f5f9;
    }

    .info-grid strong {
      color: #0d6efd;
      font-size: 14px;
      margin-bottom: 5px;
    }

    .info-grid span {
      font-size: 15px;
      color: #444;
      white-space: pre-wrap;
    }

    .form-select {
      border-radius: 0.5rem;
      transition: box-shadow 0.2s;
    }

    .form-select:focus {
      box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }

    .btn {
      border-radius: 0.6rem;
      font-weight: 500;
    }

    .btn-outline-info {
      margin-top: 10px;
    }

    .modal-body {
      max-height: 75vh;
      overflow-y: auto;
      padding: 20px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>實習公司志願序填寫</h2>

    <form id="preferencesForm" class="mx-auto" style="max-width: 700px;">
      {% for i in range(1, 6) %}
      <div class="preference-card" data-rank="{{ i }}">
        <h5 class="fw-bold">第 {{ i }} 志願</h5>

        <div class="mb-3">
          <label class="form-label">選擇公司</label>
          <select class="form-select company-select" required>
            <option value="">-- 請選擇公司 --</option>
            {% for c in companies %}
            <option value="{{ c['id'] }}">{{ c['name'] }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">選擇職缺</label>
          <select class="form-select job-select" required>
            <option value="">-- 請先選擇公司 --</option>
          </select>
        </div>
        <button type="button" class="btn btn-outline-info btn-sm view-company-btn" disabled>查看公司詳情</button>

        <span class="badge-remaining">尚未選擇公司</span>
      </div>
      {% endfor %}

      <div class="text-center mt-4">
        <button type="submit" class="btn btn-success px-5 py-2">儲存志願序</button>
      </div>
    </form>
  </div>

  <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="previewContent"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // 從 Flask 模板中取得資料
    const preview = {{ 'true' if preview else 'false' }};
    const companySlots = {{ job_slots | tojson }};
    const companies = {{ companies | tojson }};

    // 綁定公司下拉變化，動態載入職缺
    document.querySelectorAll(".company-select").forEach(select => {
      select.addEventListener("change", async (e) => {
        const selectedCompany = e.target.value;
        const card = e.target.closest(".preference-card");
        const jobSelect = card.querySelector(".job-select");
        const badge = card.querySelector(".badge-remaining");
        const viewBtn = card.querySelector(".view-company-btn");

        viewBtn.disabled = !selectedCompany;

        // 初始職缺選單
        jobSelect.innerHTML = `<option value="">-- 請先選擇公司 --</option>`;

        if (!selectedCompany) {
          badge.textContent = "尚未選擇公司";
          updateRemainingDisplay();
          return;
        }

        try {
          // 取得職缺 API 呼叫
          const res = await fetch(`/api/get_jobs_by_company?company_id=${selectedCompany}`);
          const data = await res.json();

          if (data.success && data.jobs.length > 0) {
            // 載入職缺選項
            jobSelect.innerHTML = data.jobs.map(j =>
              `<option value="${j.id}">${j.title}</option>`
            ).join('');
          } else {
            jobSelect.innerHTML = `<option value="">（無可用職缺）</option>`;
          }
        } catch (err) {
          console.error(err);
        }

        updateRemainingDisplay();
      });
    });

    // 查看公司詳情 Modal (邏輯不變)
    document.querySelectorAll(".preference-card").forEach(card => {
      const viewBtn = card.querySelector(".view-company-btn");
      const companySelect = card.querySelector(".company-select");

      viewBtn.addEventListener("click", async () => {
        const companyId = companySelect.value;
        if (!companyId) return;

        try {
          const res = await fetch(`/api/get_company_detail?company_id=${companyId}`);
          const data = await res.json();
          if (!data.success) { alert("查無公司資料"); return; }

          const c = data.company;
          const content = `
<div class="company-preview">
  <div class="section">
    <h5>公司基本資料</h5>
    <div class="info-grid">
      <div><strong>公司名稱</strong><span>${c.company_name || '-'}</span></div>
      <div><strong>公司地址</strong><span>${c.company_address || '-'}</span></div>
    </div>
  </div>
  <div class="section">
    <h5>聯絡資訊</h5>
    <div class="info-grid">
      <div><strong>聯絡人姓名</strong><span>${c.contact_name || '-'}</span></div>
      <div><strong>聯絡電話</strong><span>${c.contact_phone || '-'}</span></div>
      <div class="full"><strong>電子郵件</strong><span>${c.contact_email || '-'}</span></div>
    </div>
  </div>
  <div class="section">
    <h5>實習職缺資訊</h5>
    ${(c.internship_jobs || []).map(job => `
      <div class="info-grid">
        <div><strong>實習職位</strong><span>${job.internship_unit || '-'}</span></div>
        <div><strong>所屬部門</strong><span>${job.department || '-'}</span></div>
        <div><strong>期間</strong><span>${job.internship_period || '-'}</span></div>
        <div><strong>時段</strong><span>${job.internship_time || '-'}</span></div>
        <div><strong>名額</strong><span>${job.internship_quota || '-'}</span></div>
        <div class="full"><strong>實習內容</strong><span>${job.internship_content || '-'}</span></div>
        <div class="full"><strong>備註</strong><span>${job.remark || '-'}</span></div>
      </div>
    `).join('')}
  </div>
</div>
          `;
          document.getElementById("previewContent").innerHTML = content;
          new bootstrap.Modal(document.getElementById("previewModal")).show();
        } catch (err) {
          console.error(err);
          alert("取得公司資料失敗");
        }
      });
    });

    // =========================================================================
    // 💥 核心修改：更新剩餘額度及選單顯示邏輯
    //    - 實現公司名稱只出現一次。
    //    - 實現公司可選次數等於職缺數 (N)。
    // =========================================================================
    function updateRemainingDisplay() {
      const allCompanies = document.querySelectorAll(".company-select");
      
      // 1. 統計每個公司在所有志願中已被選擇的次數 (used)
      const companyUsage = {};
      // 初始化計數器，確保所有公司 ID 都在 map 裡
      Object.keys(companySlots).forEach(cid => {
          companyUsage[cid] = 0; 
      });

      allCompanies.forEach(s => { 
          const cid = s.value; 
          if (cid) {
              companyUsage[cid]++;
          }
      });

      // 2. 遍歷每一個公司選擇下拉選單
      allCompanies.forEach(select => {
          const card = select.closest(".preference-card");
          const badge = card.querySelector(".badge-remaining");
          const currentValue = select.value; // 當前志願已選的公司 ID

          // 清空選項但保留 "--請選擇公司--"
          const firstOption = select.querySelector('option[value=""]');
          select.innerHTML = '';
          select.appendChild(firstOption);

          // 3. 遍歷所有公司，決定哪些公司可以被列出
          companies.forEach(c => {
              const cid = String(c.id); // 確保是字串比較
              const companyName = c.name;
              // 取得總職缺數 (N)，此值來自 company.py 的 slots 欄位
              const totalSlots = Number(companySlots[cid] || 0); 

              const usedSlots = companyUsage[cid] || 0; // 該公司已被選次數
              
              // 該公司還可以被選擇的剩餘次數
              // 如果當前志願已經選擇該公司 (currentValue === cid)，則它的 usedSlots 已經多算了 1 次，要扣回來
              let remaining = totalSlots - usedSlots + (currentValue === cid ? 1 : 0);

              // 規則：
              // 只要 (有剩餘次數 remaining > 0) 或是 (當前志願就是選中該公司 currentValue === cid) 就顯示。
              // 由於 companies 陣列本身是唯一的公司列表，只會建立一次選項，實現「出現一次」。
              if (remaining > 0 || currentValue === cid) {
                  const opt = document.createElement('option');
                  opt.value = cid;
                  opt.textContent = companyName; 
                  if (currentValue === cid) opt.selected = true;
                  
                  // 顯示剩餘額度
                  opt.textContent += ` (${remaining} 個額度)`;

                  select.appendChild(opt);
              }
          });

          // 4. 更新 badge 顯示狀態
          if (currentValue) {
              const total = Number(companySlots[currentValue] || 0);
              const used = companyUsage[currentValue] || 0;
              // 修正後的剩餘次數
              const currentRemaining = total - used + (currentValue === select.value ? 1 : 0); 
              
              badge.textContent = `剩餘額度：${currentRemaining}`;
              badge.classList.remove("bg-primary", "bg-danger");
              if (currentRemaining > 0) {
                   badge.classList.add("bg-primary");
              } else {
                   badge.classList.add("bg-danger"); 
              }
          } else {
              badge.textContent = "尚未選擇公司";
              badge.classList.remove("bg-primary", "bg-danger");
          }
      });
    }
    // =========================================================================
    // 💥 核心修改結束
    // =========================================================================

    // 表單儲存 (邏輯不變)
    document.getElementById("preferencesForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (preview) {
        alert("此為預覽模式，請登入學生帳號後再儲存志願序。");
        return;
      }
      const preferences = [];
      document.querySelectorAll(".preference-card").forEach((card, idx) => {
        const companyId = card.querySelector(".company-select").value;
        const jobId = card.querySelector(".job-select").value;
        if (companyId && jobId) preferences.push({ order: idx + 1, company_id: companyId, job_id: jobId });
      });

      const res = await fetch("/api/save_preferences", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ preferences })
      });

      const data = await res.json();
      alert(data.message);
      if (data.success) location.reload();
    });

    // 初始
    updateRemainingDisplay();

    // 預覽模式：停用操作與提交 (邏輯不變)
    (function applyPreviewMode(){
      if (!preview) return;
      document.querySelectorAll(".company-select, .job-select, .view-company-btn").forEach(el => {
        if (el.tagName === 'BUTTON') {
          el.disabled = true;
        } else {
          el.setAttribute('disabled', 'disabled');
        }
      });
      const submitBtn = document.querySelector('#preferencesForm button[type="submit"]');
      if (submitBtn) {
        submitBtn.textContent = '登入後可儲存';
        submitBtn.setAttribute('disabled', 'disabled');
      }
    })();
  </script>
</body>

</html>