<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>學生志願序檢視</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin-top: 80px; font-family: "Noto Sans TC", sans-serif; background: #fff; }
    h2 { text-align: center; margin-bottom: 30px; color: #0066cc; font-weight: 700; }
    .student-section {
      background: #fff; margin-bottom: 2rem; padding: 1.5rem;
      border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .student-section h3 { color: #0066cc; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h2>學生志願序檢視</h2>

    {% if student_data %}
      {% for student_name, preferences in student_data.items() %}
        <div class="student-section">
          <h3>{{ student_name }}</h3>
          <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
              <thead>
                <tr>
                  <th>志願序</th>
                  <th>公司名稱</th>
                  <th>送出時間</th>
                </tr>
              </thead>
              <tbody>
                {% for p in preferences %}
                <tr>
                  <td>{{ p.order }}</td>
                  <td>{{ p.company }}</td>
                  <td>{{ p.submitted_at }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <!-- 圖表畫布 -->
          <canvas id="chart-{{ loop.index }}"></canvas>
        </div>
      {% endfor %}
    {% else %}
      <p class="text-muted text-center">目前尚無學生填寫志願。</p>
    {% endif %}
  </div>

  <script>
    // 從後端模板把資料轉換給前端 (示範用，實際要在 Flask/Jinja2 傳 JSON 出來)
    const studentCharts = {{ student_data | tojson }};

    // 繪製每位學生的圓餅圖
    Object.keys(studentCharts).forEach((name, idx) => {
      const ctx = document.getElementById(`chart-${idx+1}`);
      if (!ctx) return;

      const data = studentCharts[name];
      const labels = data.map(d => d.company);
      const orders = data.map(d => d.order);

      new Chart(ctx, {
        type: "pie",
        data: {
          labels: labels,
          datasets: [{
            label: `${name} 的志願序`,
            data: orders,
            backgroundColor: [
              "#4e79a7","#f28e2b","#e15759","#76b7b2","#59a14f",
              "#edc949","#af7aa1","#ff9da7","#9c755f","#bab0ac"
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: {
              callbacks: {
                label: (context) => `${context.label} - 志願序 ${context.parsed}`
              }
            },
            legend: { position: "bottom" }
          }
        }
      });
    });
  </script>
</body>
</html>
