<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>智慧實習平台 | 學生履歷</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    header {
      background: linear-gradient(135deg, #0055a8 0%, #006acb 50%, #004f94 100%);
      border-bottom: none; position: sticky; top: 0; z-index: 10;
      box-shadow: 0 8px 20px rgba(0, 68, 148, 0.35);
    }
    .topbar {
      max-width: 1800px; margin: 0 auto; padding: 18px 24px;
      display: flex; align-items: center; justify-content: space-between; color: #fff;
    }
    .topbar-left { display: flex; align-items: center; }
    .topbar-left #menu-btn {
      width: 30px; height: 22px; cursor: pointer; display: flex; flex-direction: column;
      justify-content: space-between; background: none; border: none; padding: 0;
    }
    .topbar-left #menu-btn span {
      display: block; width: 100%; height: 3px; background-color: white; border-radius: 2px; transition: all 0.3s ease;
    }
    .topbar h1 { font-size: 1.5rem; margin: 0; text-align: center; color: #fff; flex: 1; }
    body { font-family: "Noto Sans TC", sans-serif; background: #ffffff; margin: 0; padding: 0; }
    main { max-width: 1800px; margin: 24px auto 60px; padding: 0 24px; display: flex; flex-direction: column; gap: 24px; }
    .panel {
      background: #ffffff; border-radius: 16px; padding: 24px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08); border: 1px solid #e2e8f0; margin-bottom: 32px;
    }
    .panel-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 16px; }
    .panel-header h2 { font-size: 1.2rem; margin: 0; }
    .table-wrapper { overflow-x: visible; width: 100%; }
    .table-wrapper table tbody tr:hover { background: rgba(15, 23, 42, 0.02); }
    .table thead th { text-align: left; background-color: #fafafb; }
    .table tbody td { text-align: left; vertical-align: middle; }
    .table tbody tr td:nth-child(1), .table tbody tr td:nth-child(2), 
    .table tbody tr td:nth-child(3), .table tbody tr td:nth-child(4) { vertical-align: top; }
    
    /* --- 狀態標籤樣式設定 --- */
    .status-badge { font-size: 0.9em; padding: 0.3em 0.6em; border-radius: 0.5rem; display: inline-block; font-weight: 600; }
    
    /* 通過：綠底白字 */
    .status-badge.bg-success { color: #fff; background-color: #198754; }
    
    /* 退件：紅底白字 */
    .status-badge.bg-danger { color: #fff; background-color: #dc3545; }
    
    /* 待審核：藍底白字 */
    .status-badge.bg-info { color: #fff; background-color: #0dcaf0; }
    
    .status-badge.bg-secondary { color: #fff; background-color: #6c757d; }
    
    #side-menu {
      position: fixed; top: 0; left: 0; height: 100vh; width: 320px; max-width: 80vw;
      background-color: rgba(10, 10, 10, 0.95); backdrop-filter: blur(6px);
      box-shadow: 3px 0 12px rgba(0, 0, 0, 0.6); padding: 2rem 1.5rem;
      transform: translateX(-100%); transition: transform 0.3s ease-in-out; z-index: 1300;
      display: flex; flex-direction: column; align-items: flex-start; color: #fff; user-select: none;
    }
    #side-menu.open { transform: translateX(0); }
    #side-menu h2 { margin: 0 0 1.5rem 0; font-weight: 700; font-size: 1.6rem; color: #fff; }
    #close-btn {
      position: absolute; top: 2rem; right: 1.6rem; font-size: 2.2rem; background: none;
      border: none; color: #fff; cursor: pointer;
    }
    #side-menu a {
      display: block; width: 100%; padding: 0.6rem 0; font-size: 1.1rem; color: #e2e8f0;
      text-decoration: none; border-radius: 4px; transition: background-color 0.2s ease;
    }
    #side-menu a:hover { background-color: rgba(255, 255, 255, 0.18); color: #fff; }
  </style>
</head>

<body>
  <header>
    <div class="topbar">
      <div class="topbar-left">
        <button id="menu-btn" title="選單" role="button" tabindex="0" aria-label="開啟側邊選單">
          <span></span><span></span><span></span>
        </button>
      </div>
      <h1>學生履歷</h1>
      <div style="width: 30px;"></div>
    </div>
  </header>
  <main>
    <section class="panel" aria-label="履歷列表">
      <div class="panel-header">
        <h2 id="resumeListTitle">履歷列表</h2>
      </div>
      <div style="display: flex; flex-wrap: wrap; gap: 16px; align-items: center; margin-bottom: 16px;">
        <select id="departmentFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">所有學年</option>
        </select>
        <select id="classFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">所有班級</option>
        </select>
        <select id="companyNameFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">所有公司</option>
        </select>
        <select id="companyFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">所有職缺</option>
        </select>
        <select id="statusFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">所有狀態</option>
          <option value="pending">待審核</option>
          <option value="approved">通過</option>
          <option value="rejected">退件</option>
        </select>
        <input type="text" id="searchBox" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 200px; flex: 1;" placeholder="搜尋帳號/檔案" />
      </div>

      <div class="table-wrapper">
        <table style="width: 100%; border-collapse: collapse;">
          <thead style="background: #f1f5f9;">
            <tr>
              <th style="padding: 14px 16px; font-weight: 600;">學生帳號</th>
              <th style="padding: 14px 16px; font-weight: 600;">姓名</th>
              <th style="padding: 14px 16px; font-weight: 600;">上傳時間</th>
              <th style="padding: 14px 16px; font-weight: 600;">檔案名稱</th>
              <th style="padding: 14px 16px; font-weight: 600;">選擇公司</th>
              <th style="padding: 14px 16px; font-weight: 600;">職缺</th>
              <th style="padding: 14px 16px; font-weight: 600;">狀態</th>
              <th style="padding: 14px 16px; font-weight: 600;">操作</th>
            </tr>
          </thead>
          <tbody id="resumeTableBody">
            <tr><td colspan="8" style="padding: 14px 16px; text-align: center; color: #64748b;">載入中...</td></tr>
          </tbody>
        </table>
      </div>
      <nav><ul class="pagination justify-content-center mt-3" id="pagination"></ul></nav>
    </section>
  </main>

  <nav id="side-menu" aria-hidden="true">
    <button id="close-btn">×</button>
    <h2>功能選單</h2>
    <a href="/class_teacher_home">首頁</a>
    <a href="/profile">個人資料</a>
    <a href="/class_review_resume">查看學生履歷</a>
    <a href="/review_preferences">審核志願序</a>
    <a href="/admission/results">查詢學生錄取結果</a>
    <a href="/notifications">通知</a>
  </nav>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let allResumes = [];
    let currentPage = 1;
    const rowsPerPage = 10;
    let userRole = null;
    let currentUserId = null;

    // 定義狀態顏色
    function statusColor(status) {
      return { 'pending': 'info', 'approved': 'success', 'rejected': 'danger', 'submitted': 'info', 'uploaded': 'info' }[status] || 'secondary';
    }

    // 定義狀態文字
    function mapStatus(status) {
      return { 'pending': '待審核', 'approved': '通過', 'rejected': '退件', 'submitted': '待審核', 'uploaded': '待審核' }[status] || '待審核';
    }

    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    document.addEventListener("DOMContentLoaded", () => {
      fetch('/api/profile')
        .then(res => res.json())
        .then(profileData => {
          userRole = profileData.success && profileData.user ? profileData.user.role : 'class_teacher';
          currentUserId = profileData.success && profileData.user ? profileData.user.id : null;

          // --- [修改開始]：同時載入已審核公司和學生履歷 ---

          // 1. 載入已審核公司列表 (從科助後台使用的 API 獲取)
          const fetchReviewedCompanies = fetch('/api/get_reviewed_companies')
            .then(res => res.json())
            // 只在成功時返回公司列表，失敗則返回空陣列
            .then(data => data.success ? (data.companies || []) : [])
            .catch(err => { 
                console.error("Error fetching reviewed companies:", err); 
                return []; 
            });

          // 2. 載入學生履歷列表
          const fetchClassResumes = fetch('/api/get_class_resumes')
            .then(res => res.ok ? res.json() : {success:false})
            .then(resumeData => resumeData.success ? (resumeData.resumes || []) : [])
            .catch(err => { 
                console.error("Error fetching class resumes:", err); 
                return []; 
            });

          // 等待兩個 API 請求都完成
          Promise.all([fetchReviewedCompanies, fetchClassResumes])
            .then(([reviewedCompanies, resumes]) => {
              allResumes = resumes;
              // 將已審核公司資料傳入，用於填充篩選器
              populateFilters(allResumes, reviewedCompanies);
              applyFilters();
            });

          // --- [修改結束] ---
        });

      document.getElementById("departmentFilter").addEventListener("change", applyFilters);
      document.getElementById("classFilter").addEventListener("change", applyFilters);
      document.getElementById("companyNameFilter").addEventListener("change", applyFilters);
      document.getElementById("companyFilter").addEventListener("change", applyFilters);
      document.getElementById("statusFilter").addEventListener("change", applyFilters);
      document.getElementById("searchBox").addEventListener("input", applyFilters);
      
      const sideMenu = document.getElementById('side-menu');
      document.getElementById('menu-btn').onclick = () => { sideMenu.classList.add('open'); sideMenu.setAttribute('aria-hidden', 'false'); };
      document.getElementById('close-btn').onclick = () => { sideMenu.classList.remove('open'); sideMenu.setAttribute('aria-hidden', 'true'); };
    });

    // --- [修改開始]：populateFilters 函式接受 reviewedCompanies 參數 ---
    function populateFilters(data, reviewedCompanies = []) {
      const deptSelect = document.getElementById("departmentFilter");
      // 學生所屬學年列表 (目前寫死)
      deptSelect.innerHTML = `<option value="">所有學年</option><option value="1132">1132</option><option value="1142">1142</option>`;
      
      const classSelect = document.getElementById("classFilter");
      classSelect.innerHTML = `<option value="">所有班級</option>`;
      const classSet = new Set();
      data.forEach(r => { if(r.className) classSet.add(r.className); });
      Array.from(classSet).sort().forEach(c => {
         classSelect.innerHTML += `<option value="${c}">${c}</option>`;
      });

      // 填充公司名稱下拉選單 (使用已審核公司列表)
      const companyNameSelect = document.getElementById("companyNameFilter");
      companyNameSelect.innerHTML = `<option value="">所有公司</option>`;
      const companySet = new Set();
      
      // 使用從科助 API 抓取的已審核公司列表
      reviewedCompanies.forEach(c => {
          // 篩選條件：已核准 (approved) 且本學期開放 (is_open_current_semester)
          if (c.company_name && c.company_name.trim() && c.status === 'approved' && c.is_open_current_semester) {
              companySet.add(c.company_name.trim());
          }
      });
      
      Array.from(companySet).sort().forEach(companyName => {
          companyNameSelect.innerHTML += `<option value="${escapeHtml(companyName)}">${escapeHtml(companyName)}</option>`;
      });

      // 填充職缺下拉選單 (目前仍從學生履歷資料抓取)
      const companySelect = document.getElementById("companyFilter");
      companySelect.innerHTML = `<option value="">所有職缺</option>`;
      const jobSet = new Set();
      data.forEach(r => {
         // 這裡假設 job_title 格式為 "公司名稱 | 職缺名稱 - 職缺代碼" 或類似
         const titles = (r.job_title || r.jobTitle || '').split(' | ');
         titles.forEach(t => { 
             const parts = t.split(' - ');
             // 嘗試提取職缺名稱
             if(parts.length > 1) jobSet.add(parts[1].trim());
             else if(t.trim()) jobSet.add(t.trim());
         });
      });
      Array.from(jobSet).sort().forEach(j => companySelect.innerHTML += `<option value="${j}">${j}</option>`);
    }
    // --- [修改結束]：populateFilters 函式 ---

    function applyFilters() {
      currentPage = 1;
      const dept = document.getElementById("departmentFilter").value.trim();
      const cls = document.getElementById("classFilter").value.trim();
      const companyName = document.getElementById("companyNameFilter").value.trim();
      const jobFilter = document.getElementById("companyFilter").value.trim();
      const status = document.getElementById("statusFilter").value.trim();
      const keyword = document.getElementById("searchBox").value.trim().toLowerCase();

      const filtered = allResumes.filter(r => {
        const matchesDept = !dept || r.department === dept;
        const matchesClass = !cls || r.className === cls;
        const matchesKeyword = (r.username && r.username.toLowerCase().includes(keyword)) ||
                               (r.original_filename && r.original_filename.toLowerCase().includes(keyword));
        
        let matchesCompanyName = true;
        if (companyName) {
            const companyNameStr = (r.company_name || '').trim();
            // 由於篩選器是從已審核公司列表中填充，這裡直接比對名稱
            matchesCompanyName = companyNameStr === companyName;
        }
        
        let matchesJob = true;
        if (jobFilter) {
            const jobs = (r.job_title || r.jobTitle || '').toLowerCase();
            matchesJob = jobs.includes(jobFilter.toLowerCase()) || (r.job_id && String(r.job_id) === jobFilter);
        }

        let matchesStatus = true;
        if (status) {
           const statusStr = r.application_statuses || r.display_status || r.status || '';
           matchesStatus = statusStr.includes(status);
        }

        return matchesDept && matchesClass && matchesCompanyName && matchesJob && matchesStatus && matchesKeyword;
      });

      renderTable(filtered);
    }

    function renderTable(resumes) {
      const tbody = document.getElementById("resumeTableBody");
      tbody.innerHTML = "";
      if (resumes.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; color: #64748b; padding: 16px;">目前沒有資料</td></tr>`;
        document.getElementById("pagination").innerHTML = "";
        return;
      }

      const filterStatus = document.getElementById("statusFilter").value.trim(); 
      const filterJob = document.getElementById("companyFilter").value.trim(); 

      let allRowsData = [];

      resumes.forEach(r => {
        const comp = r.company_name || '—';
        const job = r.job_title || r.jobTitle || '—';
        const st = r.application_statuses || r.display_status || r.status || 'pending';

        // 狀態篩選
        if (filterStatus && st !== filterStatus) return;
        
        // 職缺篩選
        if (filterJob && !job.includes(filterJob) && filterJob !== (r.job_id ? String(r.job_id) : '')) return;

        allRowsData.push({
            ...r,
            display_company: comp,
            display_job: job,
            display_status: st
        });
      });

      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pageData = allRowsData.slice(start, end);

      pageData.forEach(row => {
        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid #e2e8f0';
        tr.innerHTML = `
           <td style="padding: 14px 16px;">${row.username}</td>
           <td style="padding: 14px 16px;">${escapeHtml(row.name)}</td>
           <td style="padding: 14px 16px;">${row.upload_time}</td>
           <td style="padding: 14px 16px; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(row.original_filename)}</td>
           <td style="padding: 14px 16px;">${escapeHtml(row.display_company)}</td>
           <td style="padding: 14px 16px;">${escapeHtml(row.display_job)}</td>
           <td style="padding: 14px 16px;">
             <span class="status-badge bg-${statusColor(row.display_status)}">${mapStatus(row.display_status)}</span>
           </td>
           <td style="padding: 14px 16px;">
             <a href="/api/download_resume/${row.id}" class="btn btn-sm btn-outline-primary" target="_blank">下載</a>
           </td>
        `;
        tbody.appendChild(tr);
      });

      renderPagination(allRowsData.length);
    }

    function renderPagination(totalItems) {
      const totalPages = Math.ceil(totalItems / rowsPerPage);
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";
      if (totalPages <= 1) return;
      for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement("li");
        li.className = `page-item ${i === currentPage ? "active" : ""}`;
        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        li.onclick = (e) => { e.preventDefault(); currentPage = i; applyFilters(); }; 
        pagination.appendChild(li);
      }
    }
  </script>
</body>
</html>