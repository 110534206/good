<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ™ºæ…§å¯¦ç¿’å¹³å° | å±¥æ­·ç®¡ç†å¹³å°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    header {
      background: #0454a3;
      color: white;
      padding: 1rem 2rem;
      text-align: center;
      font-size: 1.5rem;
    }

    body {
      font-family: "Noto Sans TC", sans-serif;
      background: #f7f9fc;
    }

    .container {
      max-width: 1000px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .card {
      border-radius: 10px;
    }

    /* èª¿æ•´è¡¨æ ¼å­—é«”å¤§å°å’Œæ¬„ä½æœ€å°å¯¬åº¦ä»¥å®¹ç´å®Œæ•´æ–‡å­— */
    table {
      font-size: 1rem;
      table-layout: fixed;
      width: 100%;
    }


    /* è­‰ç…§è¡¨æ ¼ä¸éœ€è¦é€™éº¼å¯¬ï¼Œè®“å®ƒè‡ªå‹•åˆ†é… */
    .card:has(h5.text-secondary) table th:not(:last-child) {
      min-width: unset;
    }

    .language-group label {
      font-weight: 600;
    }

    .course-scroll-container {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 5px;
    }

    /* æ–°å¢æ¨£å¼ï¼šè®“è¡¨æ ¼åœ¨æ»¾å‹•å®¹å™¨å…§é¡¯ç¤ºæ­£å¸¸ */
    .course-scroll-container table {
      margin-bottom: 0;
    }
  </style>
</head>

<body>
  <header>æ™ºæ…§å¯¦ç¿’å¹³å° | å±¥æ­·ç®¡ç†</header>

  <div class="container">
    <div class="card p-4">
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="form-tab" data-bs-toggle="tab" data-bs-target="#form-pane" type="button"
            role="tab" aria-controls="form-pane" aria-selected="true">è¡¨å–®å¡«å¯«</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="records-tab" data-bs-toggle="tab" data-bs-target="#records-pane" type="button"
            role="tab" aria-controls="records-pane" aria-selected="false">æ­·å²ç´€éŒ„</button>
        </li>
      </ul>

      <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="form-pane" role="tabpanel" aria-labelledby="form-tab" tabindex="0">
          <form id="resumeForm" enctype="multipart/form-data">

            <h5 class="mt-4 mb-3">å€‹äººåŸºæœ¬è³‡æ–™</h5>
            <input type="hidden" id="conduct_score" name="conduct_score">

            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">å§“å</label>
                <input type="text" name="name" class="form-control" required />
              </div>
              <div class="col-md-4">
                <label class="form-label">å‡ºç”Ÿæ—¥æœŸ</label>
                <input type="date" name="birth_date" class="form-control" required />
              </div>
              <div class="col-md-4">
                <label for="gender" class="form-label">æ€§åˆ¥</label>
                <select class="form-select" id="gender" name="gender" required>
                  <option value="">é¸æ“‡...</option>
                  <option value="ç”·">ç”·</option>
                  <option value="å¥³">å¥³</option>
                  <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">è¯çµ¡é›»è©±</label>
                <input type="tel" name="phone" class="form-control" required />
              </div>
              <div class="col-md-6">
                <label class="form-label">é›»å­ä¿¡ç®±</label>
                <input type="email" name="email" class="form-control" required />
              </div>
              <div class="col-12">
                <label class="form-label">åœ°å€</label>
                <input type="text" name="address" class="form-control" required />
              </div>
              <div class="col-md-6 mt-3">
                <label class="form-label">æ“è¡Œæˆç¸¾åˆ†æ•¸ (0-100)</label>
                <input type="number" name="conduct_score_numeric" class="form-control" min="0" max="100" required>
              </div>
              <div class="col-md-6 mt-3">
                <label for="photo" class="form-label">å€‹äººå¤§é ­ç…§ (JPG/PNG)</label>
                <input class="form-control" type="file" id="photo" name="photo" accept="image/*" />
              </div>
            </div>

            <div class="mb-4"></div>

            <div class="container py-4">
              <h5 class="mb-3">å·²ä¿®ç¿’å°ˆæ¥­æ ¸å¿ƒç§‘ç›®</h5>

              <div class="mb-3">
                <button type="button" class="btn btn-outline-primary btn-sm" id="load-template-btn">æŸ¥çœ‹æˆ‘çš„èª²ç¨‹</button>
                <button type="button" class="btn btn-outline-success btn-sm" id="save-template-btn">å„²å­˜</button>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <input type="text" id="course-search" class="form-control form-control-sm" placeholder="ğŸ” æŸ¥è©¢èª²ç¨‹åç¨±">
                </div>
                <div class="col-md-6">
                  <select id="credit-filter" class="form-select form-select-sm">
                    <option value="">æ‰€æœ‰å­¸åˆ†æ•¸</option>
                    <option value="1">1 å­¸åˆ†</option>
                    <option value="2">2 å­¸åˆ†</option>
                    <option value="3">3 å­¸åˆ†</option>
                  </select>
                </div>
              </div>

              <div class="course-scroll-container">
                <table class="table table-bordered align-middle">
                  <thead>
                    <tr>
                      <th style="width: 50%;">èª²ç¨‹åç¨±</th>
                      <th style="width: 25%;">å­¸åˆ†æ•¸</th>
                      <th style="width: 25%;">ç‹€æ…‹</th>
                    </tr>
                  </thead>
                  <tbody id="courseTableBody">
                    <tr>
                      <td colspan="3" class="text-muted text-center">è¼‰å…¥ä¸­...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>


            <div class="card p-4 mb-3">
              <h5 class="text-secondary">ç›¸é—œè­‰ç…§</h5>
              <table class="table table-bordered text-center align-middle">
                <thead class="table-light">
                  <tr>
                    <th>å‹å‹•éƒ¨è­‰ç…§</th>
                    <th>åœ‹éš›è­‰ç…§</th>
                    <th>åœ‹å…§è­‰ç…§</th>
                    <th>å…¶ä»–è­‰ç…§</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="certificate-table-body">
                </tbody>
              </table> <button type="button" class="btn btn-sm btn-outline-success"
                id="add-certificate-row">ï¼‹æ–°å¢ä¸€åˆ—</button>
            </div>
            <h5 class="mt-4 mb-3">èªæ–‡èƒ½åŠ›</h5>
            <div class="row mb-3">
              <div class="col-md-3 language-group">
                <label>è‹±èª</label>
                <select class="form-select form-select-sm" name="lang_en_level">
                  <option value="">æœªé¸</option>
                  <option value="ç²¾é€š">ç²¾é€š</option>
                  <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                  <option value="ç•¥æ‡‚">ç•¥æ‡‚</option>
                </select>
              </div>
              <div class="col-md-3 language-group">
                <label>å°èª</label>
                <select class="form-select form-select-sm" name="lang_tw_level">
                  <option value="">æœªé¸</option>
                  <option value="ç²¾é€š">ç²¾é€š</option>
                  <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                  <option value="ç•¥æ‡‚">ç•¥æ‡‚</option>
                </select>
              </div>
              <div class="col-md-3 language-group">
                <label>æ—¥èª</label>
                <select class="form-select form-select-sm" name="lang_jp_level">
                  <option value="">æœªé¸</option>
                  <option value="ç²¾é€š">ç²¾é€š</option>
                  <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                  <option value="ç•¥æ‡‚">ç•¥æ‡‚</option>
                </select>
              </div>
              <div class="col-md-3 language-group">
                <label>å®¢èª</label>
                <select class="form-select form-select-sm" name="lang_hk_level">
                  <option value="">æœªé¸</option>
                  <option value="ç²¾é€š">ç²¾é€š</option>
                  <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                  <option value="ç•¥æ‡‚">ç•¥æ‡‚</option>
                </select>
              </div>
            </div>

            <div class="mb-4"></div>

            <div class="card p-4 mb-3">
              <h5 class="mb-3">è‡ªå‚³</h5>
              <textarea name="autobiography" rows="6" class="form-control" placeholder="è«‹æè¿°å®¶åº­ç”Ÿæ´»ã€æ±‚å­¸ç¶“éã€å€‹äººå°ˆé•·ã€æœªä¾†è¦åŠƒç­‰..."
                required></textarea>
            </div>

            <div class="card p-4 mb-3">
              <h5 class="text-secondary">æˆç¸¾å–®ä¸Šå‚³</h5>
              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label">ä¸Šå‚³å­¸æœŸæˆç¸¾å–® (JPG/PNG)</label>
                  <input type="file" name="transcript_file" class="form-control" accept="image/jpeg, image/png"
                    required />
                </div>
              </div>
            </div>

            <div class="card my-4">
              <div class="card-header bg-primary text-white">
                <h5>è­‰ç…§è³‡è¨Š</h5>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label for="certificateImage" class="form-label">è­‰ç…§åœ–ç‰‡ä¸Šå‚³</label>
                  <input class="form-control" type="file" id="certificateImage" name="certificate_image"
                    accept="image/*">
                  <div class="form-text">è«‹ä¸Šå‚³å–®ä¸€åœ–ç‰‡æª” (PNG, JPG)</div>
                </div>
                <div class="mb-3">
                  <label for="certificateDescription" class="form-label">è­‰ç…§åç¨±</label>
                  <textarea class="form-control" id="certificateDescription" name="certificate_description" rows="3"
                    placeholder="ä¾‹:é›»è…¦è»Ÿé«”æ‡‰ç”¨ä¹™ç´š"></textarea>
                </div>
              </div>
            </div>

            <div class="card mb-4">
              <div class="card-header bg-primary text-white">
                <h5>æ–°å¢ç¼ºå‹¤è³‡è¨Š</h5>
              </div>
              <div class="card-body">
                <div id="absenceSavedMsg" class="alert alert-success d-none">
                  ç¼ºå‹¤ç´€éŒ„å·²å„²å­˜ï¼Œå¯æ–¼ä¸‹æ–¹çµ±è¨ˆè¡¨æŸ¥çœ‹ã€‚
                </div>
                <div id="absenceRecordContainer">
                  <div class="mb-3">
                    <label for="absence_date" class="form-label">ç¼ºå‹¤æ—¥æœŸ</label>
                    <input type="date" class="form-control" id="absence_date" name="absence_date" required>
                  </div>

                  <div class="mb-3">
                    <label for="absence_type" class="form-label">ç¼ºå‹¤é¡å‹</label>
                    <select class="form-select" id="absence_type" name="absence_type" required>
                      <option value="">è«‹é¸æ“‡</option>
                      <option value="æ› èª²">æ› èª²</option>
                      <option value="é²åˆ°">é²åˆ°</option>
                      <option value="äº‹å‡">äº‹å‡</option>
                      <option value="ç—…å‡">ç—…å‡</option>
                      <option value="ç”Ÿç†å‡">ç”Ÿç†å‡</option>
                      <option value="å…¬å‡">å…¬å‡</option>
                      <option value="å–ªå‡">å–ªå‡</option>
                    </select>
                  </div>

                  <div class="mb-3">
                    <label for="duration_units" class="form-label">è«‹å‡/ç¼ºå‹¤ç¯€æ•¸</label>
                    <input type="number" min="1" class="form-control" id="duration_units" name="duration_units"
                      required>
                    <div class="form-text">è«‹è¼¸å…¥ç¼ºå‹¤æˆ–è«‹å‡ç¯€æ•¸ (ä¾‹å¦‚ï¼š3ç¯€èª²è«‹è¼¸å…¥ 3)ã€‚</div>
                  </div>

                  <div class="mb-3">
                    <label for="reason" class="form-label">äº‹ç”±èªªæ˜</label>
                    <textarea class="form-control" id="reason" name="reason" rows="3" required></textarea>
                  </div>

                  <div class="card mb-4 mt-3">
                    <div class="card-header bg-warning text-dark">
                      <h5>ç¼ºå‹¤ç´€éŒ„çµ±è¨ˆ (ç¸½ç¯€æ•¸)</h5>
                    </div>
                    <div class="card-body p-3">
                      <table class="table table-bordered table-sm text-center">
                        <thead class="table-light">
                          <tr>
                            <th>æ› èª²</th>
                            <th>é²åˆ°</th>
                            <th>äº‹å‡</th>
                            <th>ç—…å‡</th>
                            <th>ç”Ÿç†å‡</th>
                            <th>å…¬å‡</th>
                            <th>å–ªå‡</th>
                          </tr>
                        </thead>
                        <tbody id="absenceStatsBody">
                          <tr>
                            <td><span id="stat_æ› èª²">0</span> ç¯€</td>
                            <td><span id="stat_é²åˆ°">0</span> ç¯€</td>
                            <td><span id="stat_äº‹å‡">0</span> ç¯€</td>
                            <td><span id="stat_ç—…å‡">0</span> ç¯€</td>
                            <td><span id="stat_ç”Ÿç†å‡">0</span> ç¯€</td>
                            <td><span id="stat_å…¬å‡">0</span> ç¯€</td>
                            <td><span id="stat_å–ªå‡">0</span> ç¯€</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>

                    <input type="hidden" name="all_absence_details_json" id="all_absence_details_json" value="[]">
                    <button type="button" id="updateAbsenceStatsBtn" class="btn btn-primary">
                      æ›´æ–°ç¼ºå‹¤è³‡è¨Š
                    </button>
                  </div>

                  <div class="mb-3"></div>

                  <div class="mb-3">
                    <label for="proof_image" class="form-label">ç¼ºå‹¤è¨˜éŒ„ä½è­‰åœ–ä¸Šå‚³</label>
                    <input class="form-control" type="file" id="proof_image" name="proof_image" accept="image/*">
                    <div class="form-text">æ¥å—åœ–ç‰‡æª”æ¡ˆ (PNG, JPG, JPEG)ã€‚</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="text-center mt-4">
              <button type="submit" class="btn btn-primary btn-lg">æäº¤ä¸¦ç”Ÿæˆå±¥æ­·</button>
            </div>
          </form>
        </div>

        <div class="tab-pane fade" id="records-pane" role="tabpanel" aria-labelledby="records-tab" tabindex="0">
          <div id="resumeRecords" class="p-3">
            <table class="table table-striped align-middle text-center">
              <thead class="table-light">
                <tr>
                  <th>ç”Ÿæˆæ™‚é–“</th>
                  <th>æª”å</th>
                  <th>å¯©æ ¸ç‹€æ…‹</th>
                  <th>ä¸‹è¼‰</th>
                </tr>
              </thead>
              <tbody id="recordsBody">
                <tr>
                  <td colspan="4" class="text-muted">å°šç„¡å±¥æ­·ç´€éŒ„</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // å„²å­˜æ‰€æœ‰èª²ç¨‹çš„åŸå§‹è³‡æ–™ï¼Œç”¨æ–¼ç¯©é¸å’ŒæŸ¥è©¢
    let disableAutoSave = false;
    let allCoursesData = [];
    let allAbsenceRecords = [];


    // ç¼ºå‹¤çµ±è¨ˆåˆå§‹å€¼
    let absenceStats = {
      "æ› èª²": 0, "é²åˆ°": 0, "äº‹å‡": 0, "ç—…å‡": 0,
      "ç”Ÿç†å‡": 0, "å…¬å‡": 0, "å–ªå‡": 0, "å…¶ä»–": 0
    };

    // æ–°å¢: LocalStorage Key
    const AUTO_SAVE_KEY = 'resumeFormData';

    // ğŸ§© å»ºç«‹èª²ç¨‹åˆ— (å­¸åˆ†æ•¸æ¬„ä½å·²ç‚º type="text" ä»¥å®¹ç´ "3/3" ç­‰åˆ†æ•¸)
    function createCourseRow(course) {
      // èª²ç¨‹è³‡æ–™å‚™ä»½ï¼Œç”¨æ–¼ã€Œæœªä¿®èª²ã€æ™‚æ¢å¾©åŸå§‹å­¸åˆ†
      const creditsDisplay = course.credits || "";
      const isNotTaken = course.isNotTaken || false;
      const displayCredits = isNotTaken ? "0" : creditsDisplay;
      const buttonClass = isNotTaken ? "btn-warning" : "btn-outline-warning";
      const buttonText = isNotTaken ? "å·²æ¨™è¨˜æœªä¿®èª²" : "æœªä¿®èª²";

      const tr = document.createElement("tr");
      // å„²å­˜åŸå§‹å­¸åˆ†æ•¸åœ¨ data-original-credits å±¬æ€§ä¸­
      tr.dataset.originalCredits = creditsDisplay;
      // å„²å­˜æœªä¿®èª²ç‹€æ…‹
      tr.dataset.isNotTaken = isNotTaken;

      tr.innerHTML = `
      <td><input type="text" name="course_name[]" class="form-control form-control-sm" value="${course.name || ""}" placeholder="è¼¸å…¥èª²ç¨‹åç¨±"></td>
      <td><input type="text" name="course_credits[]" class="form-control form-control-sm course-credits-input" value="${displayCredits}" placeholder="å­¸åˆ†" readonly></td>
      <td><button type="button" class="btn ${buttonClass} btn-sm toggle-not-taken">${buttonText}</button></td>
      `;
      return tr;
    }

    // ğŸ§© æ¸²æŸ“èª²ç¨‹è¡¨æ ¼
    function renderCourseTable(courses) {
      const tbody = document.getElementById("courseTableBody");
      tbody.innerHTML = "";

      if (courses.length === 0) {
        const row = document.createElement("tr");
        row.innerHTML = `<td colspan="3" class="text-muted text-center">æŸ¥ç„¡èª²ç¨‹æˆ–å°šæœªæ–°å¢èª²ç¨‹</td>`;
        tbody.appendChild(row);
        return;
      }

      courses.forEach(course => {
        tbody.appendChild(createCourseRow(course));
      });
      // é‡æ–°æ¸²æŸ“å¾Œï¼Œå„²å­˜ç•¶å‰èª²ç¨‹ç‹€æ…‹ (åŒ…æ‹¬æœªä¿®èª²æ¨™è¨˜)
      saveFormData();
    }

    // ğŸ§© åŸ·è¡ŒæŸ¥è©¢å’Œç¯©é¸
    function applyFilterAndSearch() {
      const searchTerm = document.getElementById("course-search").value.toLowerCase();
      const creditFilter = document.getElementById("credit-filter").value;

      const filteredCourses = allCoursesData.filter(course => {
        // 1. èª²ç¨‹åç¨±æŸ¥è©¢
        const nameMatch = course.name.toLowerCase().includes(searchTerm);
        if (!nameMatch) return false;

        // 2. å­¸åˆ†æ•¸ç¯©é¸
        if (!creditFilter) return true; // æœªé¸å–ç¯©é¸æ¢ä»¶

        // ç”±æ–¼è³‡æ–™å¯èƒ½ç‚º "3/3"ï¼Œä½¿ç”¨ parseFloat åªæœƒå–åˆ° "3"ï¼Œé€™å°ç¯©é¸æ˜¯æ­£ç¢ºçš„
        const credits = parseFloat(course.credits);
        if (isNaN(credits)) return false;

        switch (creditFilter) {
          case "1":
            return credits === 1;
          case "2":
            return credits === 2;
          case "3":
            return credits === 3;
          case "4+": // é›–ç„¶é¸é …æ²’æœ‰ 4+ï¼Œä½†ä¿ç•™é‚è¼¯ä»¥é˜²æœªä¾†æ“´å……
            return credits >= 4;
          default:
            return true;
        }
      });

      // ã€é—œéµä¿®æ­£ã€‘ç¢ºä¿éæ¿¾å¾Œçš„åˆ—è¡¨ç¸½æ˜¯æŒ‰ç…§èª²ç¨‹åç¨±æ’åº
      filteredCourses.sort((a, b) => a.name.localeCompare(b.name, 'zh-TW', {
        sensitivity: 'base'
      }));

      renderCourseTable(filteredCourses);
    }

    // ğŸ§© å¾å¾Œç«¯è¼‰å…¥å­¸ç”Ÿå€‹äººæ¨¡æ¿
    async function loadPersonalTemplate() {
      const tbody = document.getElementById("courseTableBody");
      tbody.innerHTML = '<tr><td colspan="3" class="text-muted text-center">è¼‰å…¥ä¸­...</td></tr>';
      try {
        const res = await fetch("/api/load_personal_template");
        const result = await res.json();

        if (result.success && Array.isArray(result.courses) && result.courses.length > 0) {
          // è¼‰å…¥æ™‚ï¼Œå˜—è©¦èˆ‡ LocalStorage ä¸­å„²å­˜çš„èª²ç¨‹ç‹€æ…‹åˆä½µ
          const savedData = JSON.parse(localStorage.getItem(AUTO_SAVE_KEY) || '{ }');
          const savedCourses = savedData.courses || [];

          allCoursesData = result.courses.map(course => {
            const savedCourse = savedCourses.find(c => c.name === course.name);
            // å„ªå…ˆä½¿ç”¨ LocalStorage å„²å­˜çš„ isNotTaken ç‹€æ…‹
            return {
              ...course,
              isNotTaken: savedCourse ? savedCourse.isNotTaken : (course.isNotTaken || false)
            };
          });

          // æ­¥é©Ÿ 1: ä¾ç…§èª²ç¨‹åç¨±æ’åº
          allCoursesData.sort((a, b) => a.name.localeCompare(b.name, 'zh-TW', {
            sensitivity: 'base'
          }));

          renderCourseTable(allCoursesData);
        } else {
          console.log("ç„¡å€‹äººæ¨¡æ¿ï¼Œæ”¹è¼‰å…¥æ¨™æº–èª²ç¨‹");
          await loadStandardCourses();
        }
      } catch (err) {
        console.error("âŒ è¼‰å…¥å€‹äººæ¨¡æ¿å¤±æ•—:", err);
        tbody.innerHTML = '<tr><td colspan="3" class="text-danger text-center">è¼‰å…¥å¤±æ•—</td></tr>';
        allCoursesData = [];
      }
    }

    // ğŸ§© è‹¥ç„¡å€‹äººæ¨¡æ¿ï¼Œè¼‰å…¥ç³»çµ±é è¨­èª²ç¨‹
    async function loadStandardCourses() {
      const tbody = document.getElementById("courseTableBody");
      tbody.innerHTML = '<tr><td colspan="3" class="text-muted text-center">è¼‰å…¥æ¨™æº–èª²ç¨‹ä¸­...</td></tr>';
      try {
        const res = await fetch("/api/get_standard_courses");
        const result = await res.json();
        if (result.success && result.courses?.length > 0) {
          allCoursesData = result.courses;

          // æ­¥é©Ÿ 1: ä¾ç…§èª²ç¨‹åç¨±æ’åº
          allCoursesData.sort((a, b) => a.name.localeCompare(b.name, 'zh-TW', {
            sensitivity: 'base'
          }));

          renderCourseTable(allCoursesData);
        } else {
          tbody.innerHTML = '<tr><td colspan="3" class="text-muted text-center">ç›®å‰ç„¡æ¨™æº–èª²ç¨‹</td></tr>';
          allCoursesData = [];
        }
      } catch (err) {
        console.error("âŒ è¼‰å…¥æ¨™æº–èª²ç¨‹å¤±æ•—:", err);
        tbody.innerHTML = '<tr><td colspan="3" class="text-danger text-center">è¼‰å…¥å¤±æ•—</td></tr>';
        allCoursesData = [];
      }
    }

    // ğŸ§© å„²å­˜ç‚ºå€‹äººæ¨¡æ¿
    async function savePersonalTemplate() {
      // ä½¿ç”¨ allCoursesData ç¢ºä¿å„²å­˜æ‰€æœ‰èª²ç¨‹ï¼Œç„¡è«–ç¯©é¸ç‹€æ…‹
      const courses = allCoursesData.map(course => ({
        name: course.name,
        credits: course.credits,
        isNotTaken: course.isNotTaken || false // ç¢ºä¿æœ‰ isNotTaken å±¬æ€§
      }));

      if (courses.length === 0) {
        alert("è«‹å…ˆæ–°å¢è‡³å°‘ä¸€é–€èª²ç¨‹ï¼");
        return;
      }

      const res = await fetch("/api/save_personal_template", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          display_name: "æˆ‘çš„èª²ç¨‹æ¨¡æ¿",
          courses: courses
        })
      });
      const result = await res.json();
      if (result.success) {
        alert("âœ… æ¨¡æ¿å·²å„²å­˜ï¼");
      } else {
        alert("âŒ å„²å­˜å¤±æ•—ï¼š" + (result.message || ""));
      }
    }

    // ğŸ§© åˆªé™¤/æœªä¿®èª² ç›¸é—œçš„äº‹ä»¶è™•ç†
    document.getElementById("courseTableBody").addEventListener("click", e => {
      if (e.target.classList.contains("toggle-not-taken")) {
        const tr = e.target.closest("tr");
        const creditsInput = tr.querySelector(".course-credits-input");
        let isNotTaken = tr.dataset.isNotTaken === 'true';

        if (isNotTaken) {
          // æ¢å¾©åŸå§‹å­¸åˆ†æ•¸
          creditsInput.value = tr.dataset.originalCredits;
          e.target.classList.remove("btn-warning");
          e.target.classList.add("btn-outline-warning");
          e.target.textContent = "æœªä¿®èª²";
          tr.dataset.isNotTaken = false;
        } else {
          // æ¨™è¨˜ç‚ºæœªä¿®èª²ï¼Œå­¸åˆ†æ•¸è¨­ç‚º 0
          creditsInput.value = "0";
          e.target.classList.remove("btn-outline-warning");
          e.target.classList.add("btn-warning");
          e.target.textContent = "å·²æ¨™è¨˜æœªä¿®èª²";
          tr.dataset.isNotTaken = true;
        }

        // **é‡è¦ï¼š** åŒæ­¥æ›´æ–° allCoursesData ä¸­çš„ç‹€æ…‹
        const courseName = tr.querySelector('input[name="course_name[]"]').value;
        const index = allCoursesData.findIndex(c => c.name === courseName);
        if (index > -1) {
          allCoursesData[index].isNotTaken = !isNotTaken;
        }

        // ç‹€æ…‹æ”¹è®Šå¾Œå„²å­˜è¡¨å–®
        saveFormData();
      }
    });

    // ğŸ§© ç¶å®šæŸ¥è©¢å’Œç¯©é¸äº‹ä»¶
    document.getElementById("course-search").addEventListener("input", applyFilterAndSearch);
    document.getElementById("credit-filter").addEventListener("change", applyFilterAndSearch);

    // ğŸ§© ç¶å®šæŒ‰éˆ•äº‹ä»¶
    document.getElementById("load-template-btn").addEventListener("click", loadPersonalTemplate);
    document.getElementById("save-template-btn").addEventListener("click", savePersonalTemplate);

    // =========================================================================
    // AutoSave and Load é‚è¼¯
    // =========================================================================

    // ğŸ§© è­‰ç…§è¡¨æ ¼æ–°å¢åˆ—çš„é€šç”¨å‡½æ•¸ (ç”¨æ–¼ load å’Œ add button)
    function addNewCertificateRow(certData = {
      labor: "",
      international: "",
      domestic: "",
      other: ""
    }) {
      const tbody = document.getElementById("certificate-table-body");
      const newRowHTML = `
      <tr>
        <td><input type="text" name="labor_cert[]" class="form-control" placeholder="ä¾‹:é›»è…¦è»Ÿé«”æ‡‰ç”¨ä¹™ç´š" value="${certData.labor || ""}"></td>
        <td><input type="text" name="international_cert[]" class="form-control" placeholder="ä¾‹:TOEIC 800åˆ†" value="${certData.international || ""}"></td>
        <td><input type="text" name="domestic_cert[]" class="form-control" placeholder="ä¾‹:ä¸­é¤ä¸™ç´š" value="${certData.domestic || ""}"></td>
        <td><input type="text" name="other_cert[]" class="form-control" placeholder="ä¾‹:å°ˆé¡Œç«¶è³½" value="${certData.other || ""}"></td>
        <td><button type="button" class="btn btn-outline-danger btn-sm remove-row">ç§»é™¤</button></td>
      </tr>`;
      tbody.insertAdjacentHTML("beforeend", newRowHTML);

      // æ–°å¢: ç‚ºæ–°åŠ å…¥çš„æ¬„ä½æ·»åŠ è‡ªå‹•å„²å­˜ç›£è½å™¨
      const newRow = tbody.lastElementChild;
      newRow.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', saveFormData);
      });
    }

    // ğŸ§© å„²å­˜è¡¨å–®è³‡æ–™åˆ° LocalStorage
    function saveFormData() {
      if (disableAutoSave) return;
      const data = {};
      const form = document.getElementById("resumeForm");

      // 1. æ”¶é›†æ‰€æœ‰å–®ä¸€æ¬„ä½çš„å€¼ (æ’é™¤æª”æ¡ˆå’ŒæŒ‰éˆ•)
      form.querySelectorAll('input, select, textarea').forEach(input => {
        const name = input.name;
        const type = input.type;
        if (name && type !== 'file' && type !== 'submit') {
          data[name] = input.value;
        }
      });

      // 2. æ”¶é›†è­‰ç…§è³‡æ–™ (å‹•æ…‹è¡¨æ ¼)
      const certificateRows = document.querySelectorAll("#certificate-table-body tr");
      const certificates = [];
      certificateRows.forEach(row => {
        const certData = {
          labor: row.querySelector('input[name="labor_cert[]"]').value,
          international: row.querySelector('input[name="international_cert[]"]').value,
          domestic: row.querySelector('input[name="domestic_cert[]"]').value,
          other: row.querySelector('input[name="other_cert[]"]').value
        };
        certificates.push(certData);
      });
      data['certificates'] = certificates;

      // 3. æ”¶é›†èª²ç¨‹è³‡æ–™ (èª²ç¨‹æ¸…å–®ï¼Œåªå„²å­˜ allCoursesData ä¸­çš„ isNotTaken ç‹€æ…‹)
      data['courses'] = allCoursesData.map(course => ({
        name: course.name,
        credits: course.credits, // å„²å­˜åŸå§‹ credit
        isNotTaken: course.isNotTaken || false
      }));


      localStorage.setItem(AUTO_SAVE_KEY, JSON.stringify(data));
      console.log("âœ… è¡¨å–®å·²è‡ªå‹•å„²å­˜åˆ° LocalStorage");
    }

    // ğŸ§© å¾ LocalStorage è¼‰å…¥è¡¨å–®è³‡æ–™
    function loadFormData() {
      const savedData = localStorage.getItem(AUTO_SAVE_KEY);
      if (!savedData) {
        // å¦‚æœæ²’æœ‰å„²å­˜çš„è³‡æ–™ï¼Œå‰‡æ–°å¢ä¸€æ¢ç©ºç™½çš„è­‰ç…§åˆ—
        addNewCertificateRow();
        return;
      }

      try {
        const data = JSON.parse(savedData);
        const form = document.getElementById("resumeForm");

        // 1. è¼‰å…¥å–®ä¸€æ¬„ä½
        Object.keys(data).forEach(key => {
          // æ’é™¤å‹•æ…‹è¡¨æ ¼ data['certificates'] å’Œ data['courses']
          if (key !== 'certificates' && key !== 'courses') {
            const input = form.querySelector(`[name="${key}"]`);
            if (input) {
              input.value = data[key];
              // è¼‰å…¥æ“è¡Œæˆç¸¾åˆ†æ•¸å¾Œï¼Œè§¸ç™¼ input äº‹ä»¶ï¼Œè®“è½‰æ›é‚è¼¯åŸ·è¡Œ
              if (key === 'conduct_score_numeric') {
                input.dispatchEvent(new Event('input'));
              }
            }
          }
        });

        // 2. è¼‰å…¥è­‰ç…§è³‡æ–™ (å‹•æ…‹è¡¨æ ¼)
        const tbody = document.getElementById("certificate-table-body");
        tbody.innerHTML = ""; // æ¸…ç©º HTML ä¸­å¯èƒ½çš„æ®˜ç•™

        if (data.certificates && Array.isArray(data.certificates) && data.certificates.length > 0) {
          data.certificates.forEach(cert => {
            // æª¢æŸ¥æ‰€æœ‰æ¬„ä½æ˜¯å¦çš†ç‚ºç©ºï¼Œè‹¥çš†ç‚ºç©ºå‰‡ä¸è¼‰å…¥
            const isEmpty = Object.values(cert).every(val => !val || val.trim() === '');
            if (!isEmpty) {
              addNewCertificateRow(cert);
            }
          });
        }

        // ç¢ºä¿è‡³å°‘æœ‰ä¸€æ¢è­‰ç…§ç©ºç™½åˆ—
        if (document.querySelectorAll("#certificate-table-body tr").length === 0) {
          addNewCertificateRow();
        }

        // 3. èª²ç¨‹è³‡æ–™æœƒåœ¨ loadPersonalTemplate ä¸­åˆä½µè™•ç†

      } catch (e) {
        console.error("âŒ è¼‰å…¥ LocalStorage è³‡æ–™å¤±æ•—:", e);
        localStorage.removeItem(AUTO_SAVE_KEY); // æ¸…é™¤ç„¡æ•ˆè³‡æ–™
        addNewCertificateRow(); // è¼‰å…¥å¤±æ•—ä¹Ÿç¢ºä¿æœ‰ä¸€æ¢ç©ºç™½è­‰ç…§åˆ—
      }
    }

    // ğŸ§© è¼‰å…¥å±¥æ­·ç´€éŒ„
    async function loadResumeRecords() {
      const res = await fetch("/api/get_my_resumes");
      const result = await res.json();
      const tbody = document.getElementById("recordsBody");
      tbody.innerHTML = "";
      if (!result.success || !result.resumes?.length)
        return tbody.innerHTML = `<tr><td colspan="4" class="text-muted">å°šç„¡å±¥æ­·ç´€éŒ„</td></tr>`;

      result.resumes.forEach(r => {
        tbody.insertAdjacentHTML("beforeend", `
                    <tr>
                      <td>${r.upload_time || "-"}</td>
                      <td>${r.original_filename || "æœªå‘½å"}</td>
                      <td>
                        ${r.status === 'submitted' ? '<span class="text-secondary">å·²æäº¤</span>' : ''}
                        ${r.status === 'under_review' ? '<span class="text-warning">å¯©æ ¸ä¸­</span>' : ''}
                        ${r.status === 'approved' ? '<span class="text-success">å¯©æ ¸é€šé</span>' : ''}
                        ${r.status === 'rejected' ? '<span class="text-danger">é€€ä»¶</span>' : ''}
                      </td>
                      <td><a href="/api/download_resume/${r.id}" class="btn btn-outline-primary btn-sm">ä¸‹è¼‰</a></td>
                    </tr>
                    `);
      });
    }

    // =========================================================================
    // ã€ç¼ºå‹¤ç´€éŒ„ã€‘ç›¸é—œé‚è¼¯
    // =========================================================================

    // ğŸ§© è¼”åŠ©å‡½å¼ï¼šæ¸…ç©ºç¼ºå‹¤ç´€éŒ„è¡¨å–®æ¬„ä½ (æ­¤å‡½æ•¸åœ¨æ‚¨çš„è…³æœ¬ä¸­æ²’æœ‰è¢«ä½¿ç”¨ï¼Œä½†ç‚ºäº†å®Œæ•´æ€§ä¿ç•™)
    function clearAbsenceForm() {
      const container = document.getElementById('absenceRecordContainer');
      if (container) {
        container.querySelector('#absence_date').value = '';
        container.querySelector('#absence_type').value = 'æ› èª²';
        container.querySelector('#duration_units').value = '';
        container.querySelector('#reason').value = ''; // åŠ ä¸Šäº‹ç”±
        const proofImageInput = container.querySelector('#proof_image');
        if (proofImageInput) {
          proofImageInput.value = '';
        }
      }
    }

    // ğŸ§© è¼‰å…¥ç¼ºå‹¤çµ±è¨ˆè³‡æ–™
    async function loadAbsenceStats() {
      const statsBody = document.getElementById("absenceStatsBody");

      const orderedKeys = ["æ› èª²", "é²åˆ°", "äº‹å‡", "ç—…å‡", "ç”Ÿç†å‡", "å…¬å‡", "å–ªå‡"];

      // é é¢è¼‰å…¥æ™‚çš„åˆå§‹ç‹€æ…‹ (å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œå°±é¡¯ç¤º 0)
      orderedKeys.forEach(key => {
        const statElement = document.getElementById(`stat_${key}`);
        if (statElement) {
          statElement.textContent = absenceStats[key] || 0;
        }
      });

      try {
        const res = await fetch("/api/get_absence_stats");
        const result = await res.json();

        if (result.success && result.stats) {
          const stats = result.stats;

          // 1. æ›´æ–°å…¨åŸŸè®Šæ•¸ absenceStats
          orderedKeys.forEach(key => {
            // ç²å–å¾Œç«¯çµ±è¨ˆçš„å–®ä½æ•¸ï¼Œå¦‚æœæ²’æœ‰å‰‡ç‚º 0
            const totalUnits = stats[key] || 0;
            absenceStats[key] = totalUnits;
          });

          // 2. æ ¹æ“šæ›´æ–°å¾Œçš„å…¨åŸŸè®Šæ•¸ï¼Œæ›´æ–° HTML é¡¯ç¤º
          orderedKeys.forEach(key => {
            const statElement = document.getElementById(`stat_${key}`);
            if (statElement) {
              statElement.textContent = absenceStats[key];
            }
          });

        } else {
          // å¦‚æœå¾Œç«¯è¿”å›å¤±æ•—ï¼Œæˆ‘å€‘ä¿æŒåŸæœ¬çš„ 0/è¼‰å…¥ä¸­ ç‹€æ…‹ (å¦‚æœ HTML å·²ç¶“è¢«æ­£ç¢ºå®šç¾©)
          // ç‚ºäº†é¿å…æ··äº‚ï¼Œé€™è£¡ä¸ä¿®æ”¹ HTML çµæ§‹ï¼Œåªä¿ç•™åŸæœ¬çš„æ•¸å­— (0)
        }

      } catch (error) {
        console.error('è¼‰å…¥ç¼ºå‹¤çµ±è¨ˆå¤±æ•—:', error);
        // å¦‚æœè¼‰å…¥å¤±æ•—ï¼Œæˆ‘å€‘ä¿æŒæ•¸å­—ç‚º 0 æˆ–åŸæœ¬çš„ absenceStats[key]
      }
    }

    // ğŸ§© è¼‰å…¥è©³ç´°ç¼ºå‹¤ç´€éŒ„åˆ—è¡¨ (åœ¨æ­·å²ç´€éŒ„é ç±¤)
    async function loadAbsenceRecordsList() {
      const listBody = document.getElementById("absenceRecordsListBody");
      if (!listBody) return;  // â­ é¿å…å ±éŒ¯ï¼ŒHTML æ²’æœ‰å°±ä¸æ›´æ–°
      listBody.innerHTML = '<tr><td colspan="5">è¼‰å…¥ä¸­...</td></tr>';

      try {
        const res = await fetch("/api/get_absence_records");
        const result = await res.json();

        listBody.innerHTML = ""; // æ¸…ç©ºè¼‰å…¥ä¸­æç¤º

        if (result.success && result.records?.length) {
          result.records.forEach(r => {
            const unitsText = `${r.duration_units || '0'} ç¯€`;
            // åˆ¤æ–·æ˜¯å¦æœ‰ä½è­‰åœ–ç‰‡
            const imageStatus = r.image_path ?
              '<span class="text-success">æœ‰</span>' :
              '<span class="text-secondary">ç„¡</span>';

            listBody.insertAdjacentHTML("beforeend", `
                                    <tr>
                                        <td>${r.absence_date || '-'}</td>
                                        <td>${r.absence_type || '-'}</td>
                                        <td>${unitsText}</td>
                                        <td>${r.reason || '-'}</td>
                                        <td>${imageStatus}</td>
                                    </tr>
                                `);
          });
        } else {
          listBody.innerHTML = '<tr><td colspan="5" class="text-muted">å°šç„¡è©³ç´°ç¼ºå‹¤ç´€éŒ„</td></tr>';
        }
      } catch (error) {
        console.error('è¼‰å…¥è©³ç´°ç¼ºå‹¤ç´€éŒ„å¤±æ•—:', error);
        listBody.innerHTML = '<tr><td colspan="5" class="text-danger">åˆ—è¡¨è¼‰å…¥å¤±æ•—</td></tr>';
      }
    }
    // ğŸ§© æ›´æ–°ç¼ºå‹¤çµ±è¨ˆï¼ˆä¸å¯«å…¥è³‡æ–™åº«ã€ä¸æ¸…ç©ºæ¬„ä½ï¼‰
    document.getElementById('updateAbsenceStatsBtn').addEventListener('click', function (e) {
      e.preventDefault();

      const btn = this;
      const originalText = btn.textContent;

      // é–å®šæŒ‰éˆ•
      btn.disabled = true;
      btn.textContent = "æ›´æ–°ä¸­...";

      const container = document.getElementById('absenceRecordContainer');

      // å–å¾—æ¬„ä½å€¼
      const absence_date = container.querySelector('#absence_date').value;
      const absence_type = container.querySelector('#absence_type').value;
      const duration_units_str = container.querySelector('#duration_units').value;
      const reason = container.querySelector('#reason').value;
      const proof_image_input = container.querySelector('#proof_image'); // ä½¿ç”¨ input å…ƒç´ 

      // é€²è¡Œæ•¸å€¼è½‰æ›å’Œæª”æ¡ˆç²å–
      const duration_units_int = parseInt(duration_units_str);
      const proof_image_file = proof_image_input.files[0];
      const image_filename = proof_image_file ? proof_image_file.name : null;


      // 1. é©—è­‰
      if (!absence_date || !absence_type || isNaN(duration_units_int) || duration_units_int <= 0 || !reason) {
        alert("è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼ˆæ—¥æœŸã€é¡å‹ã€ç¯€æ•¸å¿…é ˆç‚ºæ­£æ•´æ•¸ã€äº‹ç”±ï¼‰");
        btn.disabled = false;
        btn.textContent = originalText;
        return;
      }

      // ------------------------------------------------------------------
      // â­ æ ¸å¿ƒé‚è¼¯ï¼šåˆ†é …ç´¯è¨ˆèˆ‡æ›´æ–°è¡¨æ ¼ â­
      // ------------------------------------------------------------------

      // 2. ç¢ºå®šè¦ç´¯åŠ çš„é¡å‹ Key (å¦‚æœä¸åœ¨å®šç¾©ç¯„åœï¼Œå‰‡æ­¸é¡ç‚ºã€Œå…¶ä»–ã€)
      let typeToUpdate = absence_type;
      if (absenceStats[typeToUpdate] === undefined) {
        typeToUpdate = "å…¶ä»–";
      }

      // 3. æª¢æŸ¥çµ±è¨ˆé¡¯ç¤ºå…ƒç´ æ˜¯å¦å­˜åœ¨
      const statElement = document.getElementById(`stat_${typeToUpdate}`);

      if (!statElement) {
        // å¦‚æœ HTML çµæ§‹æ­£ç¢ºï¼Œé€™è£¡ä¸æ‡‰è©²ç™¼ç”Ÿã€‚
        alert(`éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°çµ±è¨ˆé¡¯ç¤ºæ¬„ä½ ID: stat_${typeToUpdate}ã€‚è«‹æª¢æŸ¥ HTML è¡¨æ ¼ï¼`);
        btn.disabled = false;
        btn.textContent = originalText;
        return;
      }

      // 4. æ›´æ–° JS è¨˜æ†¶é«”ä¸­çš„åˆ†é …æ•¸å­—
      absenceStats[typeToUpdate] += duration_units_int;

      // 5. æ›´æ–° HTML é¡¯ç¤º
      statElement.textContent = absenceStats[typeToUpdate];

      // 6. æš«å­˜è©³ç´°ç´€éŒ„åˆ°å…¨åŸŸè®Šæ•¸
      const newRecord = {
        date: absence_date,
        type: absence_type,
        units: duration_units_int,
        reason: reason,
        image_filename: image_filename
      };
      allAbsenceRecords.push(newRecord);

      // 7. å°‡è©³ç´°ç´€éŒ„é™£åˆ—å¯«å…¥éš±è—æ¬„ä½ (ä¾›æœ€çµ‚æäº¤çµ¦å¾Œç«¯)
      const hiddenInput = document.getElementById('all_absence_details_json');
      if (hiddenInput) {
        hiddenInput.value = JSON.stringify(allAbsenceRecords);
      }

      // 8. æ¸…ç©ºåœ–ç‰‡è¼¸å…¥ï¼Œæ–¹ä¾¿ä¸‹ä¸€æ¬¡ä¸Šå‚³
      proof_image_input.value = '';
      // ------------------------------------------------------------------


      // é¡¯ç¤ºæœ¬åœ°æ›´æ–°æˆåŠŸæç¤º
      const msgBox = document.getElementById('absenceSavedMsg');
      msgBox.textContent = `æˆåŠŸæ–°å¢ ${typeToUpdate} ç´€éŒ„ï¼Œç´¯è¨ˆç¸½æ•¸ç‚º ${absenceStats[typeToUpdate]} ç¯€ã€‚`;
      msgBox.classList.remove('d-none');

      setTimeout(() => {
        msgBox.classList.add('d-none');
      }, 3000);

      // é‚„åŸæŒ‰éˆ•
      btn.disabled = false;
      btn.textContent = originalText;
    });

    // =========================================================================
    // äº‹ä»¶ç¶å®šå’Œåˆå§‹åŒ–
    // =========================================================================
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("resumeForm");

      // å…ˆè¼‰å…¥ LocalStorage è³‡æ–™åˆ°è¡¨å–® (ä½†èª²ç¨‹è¼‰å…¥æœƒåœ¨ loadPersonalTemplate ä¹‹å¾Œ)
      loadFormData();

      // é‡å°éå‹•æ…‹ç”Ÿæˆçš„æ¬„ä½ï¼Œè¨­å®šç›£è½å™¨
      form.querySelectorAll('input:not([type="file"]), select, textarea').forEach(input => {
        // æª”æ¡ˆæ¬„ä½ä¸å„²å­˜ï¼Œå‹•æ…‹ç”Ÿæˆçš„è­‰ç…§æ¬„ä½åœ¨ addNewCertificateRow ä¸­è™•ç†
        input.addEventListener('input', saveFormData);
        input.addEventListener('change', saveFormData);
      });
    });

    // ğŸ§© ã€Œç›¸é—œè­‰ç…§ã€æ–°å¢

    // åŸæœ¬çš„æ–°å¢è­‰ç…§åˆ—
    document.getElementById("add-certificate-row").addEventListener("click", () => {
      addNewCertificateRow(); // ä¸å¸¶åƒæ•¸å³ç‚ºæ–°å¢ç©ºç™½åˆ—
      saveFormData(); // æ–°å¢å¾Œå„²å­˜ç‹€æ…‹
    });

    // æ›¿æ›åŸæœ¬çš„ç§»é™¤è­‰ç…§åˆ—ç›£è½å™¨
    document.getElementById("certificate-table-body").addEventListener("click", e => {
      if (e.target.classList.contains("remove-row")) {
        e.target.closest("tr").remove();
        saveFormData(); // ç§»é™¤å¾Œå„²å­˜ç‹€æ…‹

        // å¦‚æœç§»é™¤åˆ°æ²’æœ‰ä»»ä½•ä¸€åˆ—ï¼Œå‰‡æ–°å¢ä¸€æ¢ç©ºç™½åˆ—
        if (document.querySelectorAll("#certificate-table-body tr").length === 0) {
          addNewCertificateRow();
        }
      }
    });

    // æ“è¡Œæˆç¸¾è½‰æ› (åŠ å…¥ saveFormData)
    const scoreInput = document.querySelector('input[name="conduct_score_numeric"]');
    const hiddenGrade = document.getElementById("conduct_score");
    const conductScoreHandler = () => {
      const score = parseInt(scoreInput.value);
      let grade = "";
      if (score >= 90) grade = "å„ª";
      else if (score >= 80) grade = "ç”²";
      else if (score >= 70) grade = "ä¹™";
      else if (score >= 60) grade = "ä¸™";
      else if (score >= 0) grade = "ä¸";
      hiddenGrade.value = grade;
      saveFormData(); // è½‰æ›å¾Œä¹Ÿå„²å­˜
    };
    scoreInput.addEventListener("input", conductScoreHandler);


    // ğŸ§© è¡¨å–®é€å‡º (æäº¤æˆåŠŸå¾Œæ¸…é™¤ LocalStorage ä¸¦åˆ‡æ›é ç±¤)
    document.getElementById("resumeForm").addEventListener("submit", async e => {
      e.preventDefault();
      const submitBtn = e.submitter;
      const originalText = submitBtn.textContent;

      submitBtn.disabled = true;
      submitBtn.textContent = 'ç”Ÿæˆä¸­...';

      const formData = new FormData(e.target);

      // æ”¶é›†å‹•æ…‹çš„èª²ç¨‹è³‡æ–™ä¸¦æ·»åŠ åˆ° FormData
      const courseRows = document.querySelectorAll("#courseTableBody tr");
      const courses = [];

      courseRows.forEach(row => {
        const nameInput = row.querySelector('input[name="course_name[]"]');
        const creditsInput = row.querySelector('input[name="course_credits[]"]');
        const isNotTaken = row.dataset.isNotTaken === 'true';

        if (nameInput && creditsInput) {
          const name = nameInput.value.trim();
          // æäº¤æ™‚ï¼Œç„¡è«–æ˜¯å¦æœªä¿®èª²ï¼Œéƒ½ä½¿ç”¨é¡¯ç¤ºçš„å€¼ (0 æˆ–å¯¦éš›å­¸åˆ†)
          const credits = creditsInput.value.trim();

          if (name && credits) {
            courses.push({
              name: name,
              credits: credits,
              isNotTaken: isNotTaken // å‚³éç‹€æ…‹çµ¦å¾Œç«¯
            });
          }
        }
      });

      formData.append("courses", JSON.stringify(courses));

      // ç§»é™¤èˆŠçš„èª²ç¨‹ç›¸é—œæ¬„ä½ï¼Œå› ç‚ºæˆ‘å€‘çµ±ä¸€ç”¨ JSON å‚³é
      formData.delete("course_name[]");
      formData.delete("course_credits[]");
      formData.append("absence_date", document.getElementById("absence_date").value);
      formData.append("absence_type", document.getElementById("absence_type").value);
      formData.append("duration_units", document.getElementById("duration_units").value);
      formData.append("reason", document.getElementById("reason").value);


      try {
        const res = await fetch("/api/submit_and_generate", {
          method: "POST",
          body: formData
        });
        const result = await res.json();

        if (result.success) {
          alert("âœ… å±¥æ­·å·²ç”Ÿæˆï¼Œå¯æ–¼ç´€éŒ„é ç±¤ä¸‹è¼‰");
          // æäº¤æˆåŠŸå¾Œæ¸…é™¤ LocalStorage
          localStorage.removeItem(AUTO_SAVE_KEY);

          // ğŸš¨ æ ¸å¿ƒè¦æ±‚ï¼šåˆ‡æ›åˆ°ç´€éŒ„é ç±¤
          const recordsTab = document.querySelector('[data-bs-target="#records-pane"]');
          new bootstrap.Tab(recordsTab).show();

          // é‡æ–°è¼‰å…¥æ­·å²ç´€éŒ„åˆ—è¡¨
          await loadResumeRecords();

        } else {
          alert("âŒ æäº¤å¤±æ•—ï¼š" + (result.message || "æœªçŸ¥éŒ¯èª¤"));
        }
      } catch (error) {
        console.error('Error submitting form:', error);
        alert("âŒ ç¶²è·¯æˆ–ä¼ºæœå™¨éŒ¯èª¤");
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    });

    // =========================================================================
    // é é¢åˆæ¬¡è¼‰å…¥æ™‚å‘¼å«
    // =========================================================================
    loadPersonalTemplate();
    loadResumeRecords();
    loadAbsenceStats();
    loadAbsenceRecordsList();
  </script>
</body>

</html>