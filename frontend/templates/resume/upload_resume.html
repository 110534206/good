<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å±¥æ­·ç®¡ç†å¹³å°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    header {
      background: #0454a3;
      color: white;
      padding: 1rem 2rem;
      text-align: center;
      font-size: 1.5rem;
    }

    body {
      font-family: "Noto Sans TC", sans-serif;
      background: #f7f9fc;
    }

    .container {
      max-width: 1000px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .card {
      border-radius: 10px;
    }

    /* èª¿æ•´è¡¨æ ¼å­—é«”å¤§å°å’Œæ¬„ä½æœ€å°å¯¬åº¦ä»¥å®¹ç´å®Œæ•´æ–‡å­— */
    table {
      font-size: 1rem;
      table-layout: fixed;
      width: 100%;
    }


    /* è­‰ç…§è¡¨æ ¼ä¸éœ€è¦é€™éº¼å¯¬ï¼Œè®“å®ƒè‡ªå‹•åˆ†é… */
    .card:has(h5.text-secondary) table th:not(:last-child) {
      min-width: unset;
    }

    .language-group label {
      font-weight: 600;
    }

    /* æ–°å¢æ¨£å¼ï¼šè®“è¡¨æ ¼åœ¨æ»¾å‹•å®¹å™¨å…§é¡¯ç¤ºæ­£å¸¸ */
    .course-scroll-container table {
      margin-bottom: 0;
    }

    .certificate-entry {
      background: #f8fbff;
    }

    .certificate-entry .cert-index-badge {
      min-width: 32px;
      text-align: center;
      font-weight: 600;
    }

    /* è¡¨å–®åœ–ç‰‡é è¦½æ¡†ï¼šå€‹äººç…§ç‰‡ã€æˆç¸¾å–®ã€ç¼ºå‹¤ä½è­‰ã€è­‰ç…§ç­‰ */
    .image-preview-box {
      width: 100%;
      max-width: 200px;
      min-height: 140px;
      border: 2px dashed #dee2e6;
      border-radius: 8px;
      background: #f8f9fa;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      margin-top: 8px;
    }
    .image-preview-box img {
      max-width: 100%;
      max-height: 200px;
      object-fit: contain;
    }
    .image-preview-box .placeholder-text {
      color: #6c757d;
      font-size: 0.875rem;
      padding: 1rem;
      text-align: center;
    }

    /* é¸å–®æŒ‰éˆ•æ¨£å¼ */
    .top-bar-left {
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 1000;
    }

    #menu-btn {
      width: 30px;
      height: 22px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    #menu-btn span {
      height: 4px;
      background-color: white;
      border-radius: 2px;
      transition: all 0.3s ease;
    }

    /* å´é‚Šé¸å–® */
    #side-menu {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 320px;
      max-width: 80vw;
      background-color: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(6px);
      box-shadow: 3px 0 12px rgb(0 0 0 / 0.7);
      padding: 2rem 1.5rem;
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
      z-index: 1100;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      color: white;
      user-select: none;
    }

    #side-menu.open {
      transform: translateX(0);
    }

    #close-btn {
      position: absolute;
      top: 2rem;
      right: 1.6rem;
      font-size: 2.2rem;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      line-height: 1;
      width: 2.5rem;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #side-menu h2 {
      width: 100%;
      margin-bottom: 1.5rem;
      font-weight: 700;
      font-size: 1.5rem;
      text-align: left;
    }

    #side-menu a {
      display: block;
      width: 100%;
      padding: 0.5rem 0;
      font-size: 1.1rem;
      color: #ddd;
      text-decoration: none;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }

    #side-menu a:hover {
      background-color: rgba(255, 255, 255, 0.15);
      color: white;
    }

    /* å…è²¬è²æ˜å½ˆè·³è¦–çª— Modal æ¨£å¼ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 99999;
      backdrop-filter: blur(4px);
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 0;
      max-width: 600px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
      color: #856404;
      padding: 25px 30px;
      border-radius: 20px 20px 0 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      font-size: 22px;
      font-weight: bold;
    }

    .modal-header::before {
      content: "âš ï¸";
      font-size: 28px;
    }

    .modal-body {
      padding: 30px;
      color: #333;
    }

    .modal-body h3 {
      color: #d68910;
      margin: 0 0 20px 0;
      font-size: 18px;
    }

    .modal-body ul {
      margin: 15px 0;
      padding-left: 25px;
      line-height: 2;
    }

    .modal-body li {
      margin: 10px 0;
      color: #555;
    }

    .modal-body strong {
      color: #d68910;
    }

    .modal-checkbox-container {
      background-color: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 10px;
      padding: 20px;
      margin: 25px 0;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .modal-checkbox-container input[type="checkbox"] {
      width: 22px;
      height: 22px;
      cursor: pointer;
      margin-top: 2px;
      flex-shrink: 0;
    }

    .modal-checkbox-container label {
      cursor: pointer;
      font-size: 15px;
      color: #856404;
      font-weight: 600;
      line-height: 1.6;
      user-select: none;
    }

    .modal-footer {
      padding: 20px 30px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      justify-content: flex-end;
      gap: 15px;
    }

    .modal-btn {
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      width: auto;
    }

    .modal-btn-primary {
      background: linear-gradient(90deg, #007BFF, #0069ff);
      color: white;
    }

    .modal-btn-primary:hover:not(:disabled) {
      opacity: 0.9;
      box-shadow: 0 4px 12px rgba(0, 105, 255, 0.3);
    }

    .modal-btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .modal-overlay.hidden {
      display: none !important;
    }
  </style>
</head>

<body>
  <!-- å…è²¬è²æ˜å½ˆè·³è¦–çª— -->
  <div id="disclaimerModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        é‡è¦æé†’ï¼šAI ç”Ÿæˆå…§å®¹å…è²¬è²æ˜
      </div>
      <div class="modal-body">
        <h3>ä½¿ç”¨æœ¬æœå‹™å‰ï¼Œè«‹å‹™å¿…ä»”ç´°é–±è®€ä¸¦ç†è§£ä»¥ä¸‹äº‹é …ï¼š</h3>
        <ul>
          <li><strong>AI ç”Ÿæˆçš„è‡ªå‚³å…§å®¹å¯èƒ½éæ–¼ç¾åŒ–</strong>ï¼Œä¸ä¸€å®šå®Œå…¨ç¬¦åˆæ‚¨çš„å¯¦éš›æƒ…æ³</li>
          <li><strong>ç”Ÿæˆå…§å®¹åƒ…ä¾›åƒè€ƒ</strong>ï¼Œè«‹å‹™å¿…ä»”ç´°å¯©æ ¸ä¸¦æ ¹æ“šæ‚¨çš„çœŸå¯¦ç¶“æ­·é€²è¡Œèª¿æ•´</li>
          <li><strong>è«‹ç¢ºä¿ç”Ÿæˆå…§å®¹ä¸­çš„æŠ€èƒ½ã€ç¶“é©—ã€æˆå°±ç­‰è³‡è¨Šèˆ‡æ‚¨çš„å¯¦éš›æƒ…æ³ç›¸ç¬¦</strong></li>
          <li><strong>éåº¦ç¾åŒ–çš„å…§å®¹å¯èƒ½å°è‡´é¢è©¦æ™‚ç„¡æ³•å›ç­”ç›¸é—œå•é¡Œ</strong>ï¼Œè«‹è¬¹æ…ä½¿ç”¨</li>
          <li><strong>ç³»çµ±ä¸å°ç”Ÿæˆå…§å®¹çš„æº–ç¢ºæ€§æˆ–é©ç”¨æ€§æ‰¿æ“”ä»»ä½•è²¬ä»»</strong></li>
          <li><strong>æ‚¨æœ‰è²¬ä»»ç¢ºä¿æäº¤çš„å±¥æ­·å…§å®¹çœŸå¯¦ã€æº–ç¢ºä¸”ç¬¦åˆå¯¦éš›æƒ…æ³</strong></li>
        </ul>
        <div class="modal-checkbox-container">
          <input type="checkbox" id="disclaimerCheckbox" autocomplete="off" />
          <label for="disclaimerCheckbox">
            æˆ‘å·²ä»”ç´°é–±è®€ä¸¦ç†è§£ä¸Šè¿°å…è²¬è²æ˜ï¼Œæˆ‘äº†è§£ AI ç”Ÿæˆå…§å®¹å¯èƒ½éæ–¼ç¾åŒ–ï¼Œæˆ‘å°‡ä»”ç´°å¯©æ ¸æ‰€æœ‰ç”Ÿæˆå…§å®¹ä¸¦ç¢ºä¿å…¶èˆ‡æˆ‘çš„å¯¦éš›æƒ…æ³ç›¸ç¬¦ã€‚æˆ‘åŒæ„ä½¿ç”¨æœ¬æœå‹™ä¸¦æ‰¿æ“”ç›¸æ‡‰è²¬ä»»ã€‚
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn modal-btn-primary" id="confirmDisclaimerBtn" disabled>
          æˆ‘å·²äº†è§£ä¸¦åŒæ„
        </button>
      </div>
    </div>
  </div>

  <header>å±¥æ­·ç®¡ç†</header>
  <div class="top-bar-left">
    <div id="menu-btn" title="é¸å–®" role="button" tabindex="0">
      <span></span><span></span><span></span>
    </div>
  </div>
  <div class="container">
    <div class="card p-4">
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="form-tab" data-bs-toggle="tab" data-bs-target="#form-pane" type="button"
            role="tab" aria-controls="form-pane" aria-selected="true">è¡¨å–®å¡«å¯«</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="ai-edit-tab" data-bs-toggle="tab" data-bs-target="#ai-edit-pane" type="button"
            role="tab" aria-controls="ai-edit-pane" aria-selected="false" onclick="return handleAITabClick(event)">AI å±¥æ­·ä¿®æ”¹</button>
        </li>
      </ul>

      <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="form-pane" role="tabpanel" aria-labelledby="form-tab" tabindex="0">
          <form id="resumeForm" enctype="multipart/form-data">

            <h5 class="mt-4 mb-3">å€‹äººåŸºæœ¬è³‡æ–™</h5>
            <input type="hidden" id="conduct_score" name="conduct_score">

            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">å§“å</label>
                <input type="text" name="name" class="form-control" required />
              </div>
              <div class="col-md-4">
                <label class="form-label">å‡ºç”Ÿæ—¥æœŸ</label>
                <input type="date" name="birth_date" class="form-control" required />
              </div>
              <div class="col-md-4">
                <label for="gender" class="form-label">æ€§åˆ¥</label>
                <select class="form-select" id="gender" name="gender" required>
                  <option value="">é¸æ“‡...</option>
                  <option value="ç”·">ç”·</option>
                  <option value="å¥³">å¥³</option>
                  <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">è¯çµ¡é›»è©±</label>
                <input type="tel" name="phone" class="form-control" required />
              </div>
              <div class="col-md-6">
                <label class="form-label">é›»å­ä¿¡ç®±</label>
                <input type="email" name="email" class="form-control" required />
              </div>
              <div class="col-12">
                <label class="form-label">åœ°å€</label>
                <input type="text" name="address" class="form-control" required />
              </div>
              <div class="col-md-6 mt-3">
                <label class="form-label">æ“è¡Œæˆç¸¾åˆ†æ•¸ (0-100)</label>
                <input type="number" name="conduct_score_numeric" class="form-control" min="0" max="100" required>
              </div>
              <div class="col-md-6 mt-3">
                <label for="photo" class="form-label">å€‹äººå¤§é ­ç…§ (JPG/PNG)</label>
                <div class="image-preview-box" id="photoPreviewBox">
                  <span class="placeholder-text">é¸æ“‡æˆ–ä¸Šå‚³å¾Œé¡¯ç¤ºé è¦½</span>
                </div>
                <input class="form-control mt-2" type="file" id="photo" name="photo" accept="image/*" />
              </div>
            </div>

            <div class="mb-4"></div>

            <table class="table table-bordered align-middle">

              <!-- è¡¨æ ¼ä¸Šæ–¹åŠŸèƒ½å€ -->
              <thead>
                <tr>
                  <th colspan="4">
                    <h5 class="mb-3">å·²ä¿®ç¿’å°ˆæ¥­æ ¸å¿ƒç§‘ç›®</h5>

                    <div class="mb-3">
                      <button type="button" class="btn btn-outline-info btn-sm" id="download-excel-template-btn">
                        â‡© ä¸‹è¼‰Excelç¯„æœ¬
                      </button>
                      <button type="button" class="btn btn-outline-warning btn-sm" id="upload-excel-btn">
                        â‡ª åŒ¯å…¥Excelè³‡æ–™
                      </button>
                      <button type="button" class="btn btn-outline-success btn-sm" id="save-template-btn">
                        å„²å­˜
                      </button>
                      <input type="file" id="excel-file-input" accept=".xlsx,.xls" style="display:none;">
                    </div>

                    <div class="row g-2">
                      <div class="col-md-6">
                        <input type="text" id="course-search" class="form-control form-control-sm"
                          placeholder="ğŸ” æŸ¥è©¢èª²ç¨‹åç¨±">
                      </div>
                      <div class="col-md-6">
                        <select id="credit-filter" class="form-select form-select-sm">
                          <option value="">æ‰€æœ‰å­¸åˆ†æ•¸</option>
                          <option value="1">1 å­¸åˆ†</option>
                          <option value="2">2 å­¸åˆ†</option>
                          <option value="3">3 å­¸åˆ†</option>
                        </select>
                      </div>
                    </div>
                  </th>
                </tr>

                <!-- æ¬„ä½æ¨™é¡Œ -->
                <tr>
                  <th style="width:40%">èª²ç¨‹åç¨±</th>
                  <th style="width:15%">å­¸åˆ†æ•¸</th>
                  <th style="width:20%">æˆç¸¾</th>
                  <th style="width:25%">ç‹€æ…‹</th>
                </tr>
              </thead>

              <!-- èª²ç¨‹è³‡æ–™ -->
              <tbody id="courseTableBody">
                <tr>
                  <td colspan="4" class="text-muted text-center">
                    è«‹å…ˆä¸‹è¼‰ Excel ç¯„æœ¬ï¼Œå¡«å¯«å®Œæˆå¾Œä¸Šå‚³ä»¥é¡¯ç¤ºèª²ç¨‹è³‡æ–™
                  </td>
                </tr>
              </tbody>

              <!-- åˆ†é  -->
              <tfoot>
                <tr>
                  <td colspan="4">
                    <div class="d-flex justify-content-center">
                      <nav>
                        <ul class="pagination pagination-sm mb-0" id="course-pagination"></ul>
                      </nav>
                    </div>
                  </td>
                </tr>
              </tfoot>

            </table>

            <div class="card p-4 mb-3">
              <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mb-3">
                <div>
                  <h5 class="text-secondary mb-1">ç›¸é—œè­‰ç…§</h5>
                  <p class="text-muted small mb-0">è¼¸å…¥è­‰ç…§ä»£ç¢¼å¯è‡ªå‹•å¸¶å‡ºåç¨±èˆ‡é¡åˆ¥ï¼Œæœ€å¤š 32 ç­†ï¼›æ¯ç­†å¯ç›´æ¥ä¸Šå‚³å°æ‡‰åœ–ç‰‡ã€‚</p>
                </div>
                <span class="badge bg-light text-dark">å·²æ–°å¢ <span id="cert-count">0</span> / 32</span>
              </div>

              <div id="certificatesContainer"></div>
              <button type="button" class="btn btn-sm btn-outline-success mt-2" id="addCertificateBtn">ï¼‹æ–°å¢è­‰ç…§</button>
            </div>
            <h5 class="mt-4 mb-3">èªæ–‡èƒ½åŠ›</h5>
            <div class="row mb-3">
              <div class="col-md-3 language-group">
                <label>è‹±èª</label>
                <select class="form-select form-select-sm" name="lang_en_level">
                  <option value="">å°šæœªè¨­å®š</option>
                  <option value="ç²¾é€š">ç²¾é€š</option>
                  <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                  <option value="ç•¥æ‡‚">ç•¥æ‡‚</option>
                </select>
              </div>
              <div class="col-md-3 language-group">
                <label>å°èª</label>
                <select class="form-select form-select-sm" name="lang_tw_level">
                  <option value="">å°šæœªè¨­å®š</option>
                  <option value="ç²¾é€š">ç²¾é€š</option>
                  <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                  <option value="ç•¥æ‡‚">ç•¥æ‡‚</option>
                </select>
              </div>
              <div class="col-md-3 language-group">
                <label>æ—¥èª</label>
                <select class="form-select form-select-sm" name="lang_jp_level">
                  <option value="">å°šæœªè¨­å®š</option>
                  <option value="ç²¾é€š">ç²¾é€š</option>
                  <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                  <option value="ç•¥æ‡‚">ç•¥æ‡‚</option>
                </select>
              </div>
              <div class="col-md-3 language-group">
                <label>å®¢èª</label>
                <select class="form-select form-select-sm" name="lang_hk_level">
                  <option value="">å°šæœªè¨­å®š</option>
                  <option value="ç²¾é€š">ç²¾é€š</option>
                  <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                  <option value="ç•¥æ‡‚">ç•¥æ‡‚</option>
                </select>
              </div>
            </div>

            <div class="mb-4"></div>

            <div class="card p-4 mb-3">
              <h5 class="mb-3">è‡ªå‚³</h5>
              <textarea name="autobiography" rows="6" class="form-control" placeholder="è«‹æè¿°å®¶åº­ç”Ÿæ´»ã€æ±‚å­¸ç¶“éã€å€‹äººå°ˆé•·ã€æœªä¾†è¦åŠƒç­‰..."
                required></textarea>
            </div>

            <div class="card p-4 mb-3">
              <h5 class="text-secondary">æˆç¸¾å–®ä¸Šå‚³</h5>
              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label">ä¸Šå‚³å­¸æœŸæˆç¸¾å–® (JPG/PNG)</label>
                  <div class="image-preview-box" id="transcriptPreviewBox">
                    <span class="placeholder-text">é¸æ“‡æˆ–ä¸Šå‚³å¾Œé¡¯ç¤ºé è¦½</span>
                  </div>
                  <input type="file" id="transcript_file" name="transcript_file" class="form-control mt-2" accept="image/jpeg, image/png"
                    required />
                </div>
              </div>
            </div>

            <div class="card mb-4">
              <div class="card-header bg-primary text-white">
                <h5>æ–°å¢ç¼ºå‹¤è³‡è¨Š</h5>
              </div>
              <div class="card-body">
                <div id="absenceSavedMsg" class="alert alert-success d-none">
                  ç¼ºå‹¤ç´€éŒ„å·²å„²å­˜ï¼Œå¯æ–¼ä¸‹æ–¹çµ±è¨ˆè¡¨æŸ¥çœ‹ã€‚
                </div>
                <div id="absenceRecordContainer">
                  <!-- å­¸æœŸç¯„åœç¯©é¸å™¨ -->
                  <div class="mb-3">
                    <label class="form-label">ğŸ“… ç¼ºå‹¤ç´€éŒ„ç¯©é¸ï¼ˆå­¸æœŸç¯„åœï¼‰</label>
                    <div class="card-body">
                      <div class="row g-3 align-items-end">
                        <div class="col-md-5">
                          <label for="startSemester" class="form-label">é–‹å§‹å­¸æœŸ</label>
                          <select class="form-select" id="startSemester">
                            <option value="">è¼‰å…¥ä¸­...</option>
                          </select>
                        </div>
                        <div class="col-md-5">
                          <label for="endSemester" class="form-label">çµæŸå­¸æœŸ</label>
                          <select class="form-select" id="endSemester">
                            <option value="">è¼‰å…¥ä¸­...</option>
                          </select>
                        </div>
                        <div class="col-md-2">
                          <button type="button" id="filterAbsenceBtn" class="btn btn-info w-100">ç¯©é¸</button>
                        </div>
                      </div>
                      <div class="form-text mt-2">ğŸ’¡ æç¤ºï¼šé¸æ“‡å­¸æœŸç¯„åœä»¥ç¯©é¸ç¼ºå‹¤è¨˜éŒ„ï¼Œä¾‹å¦‚ï¼šå¾ã€Œ1122ã€åˆ°ã€Œ1131ã€ã€‚</div>
                    </div>
                  </div>

                  <!-- ç¼ºå‹¤è¨˜éŒ„åˆ—è¡¨ï¼ˆå¾è³‡æ–™åº«è®€å–ï¼‰ -->
                  <div class="mb-3">
                    <label class="form-label">ç¼ºå‹¤è¨˜éŒ„åˆ—è¡¨</label>
                    <div class="form-text mb-2">ğŸ’¡ æç¤ºï¼šä»¥ä¸‹ç‚ºæ‚¨ç´¯ç©çš„ç¼ºå‹¤è¨˜éŒ„ï¼ˆæ—¥æœŸã€é¡å‹ã€ç¯€æ•¸ã€äº‹ç”±ï¼‰ã€‚</div>
                    <div id="absenceRecordsDisplay" class="border rounded p-3"
                      style="max-height: 500px; overflow-y: auto;">
                      <p class="text-muted text-center">è«‹é¸æ“‡å­¸æœŸä»¥è¼‰å…¥ç¼ºå‹¤è¨˜éŒ„</p>
                    </div>
                  </div>

                  <!-- ç¼ºå‹¤çµ±è¨ˆè¡¨æ ¼ -->
                  <div class="mb-3">
                    <label class="form-label">ç¼ºå‹¤ç´€éŒ„çµ±è¨ˆ (ç¸½ç¯€æ•¸)</label>
                  </div>
                  <table class="table table-bordered table-sm text-center">
                    <thead class="table-light">
                      <tr>
                        <th>æ› èª²</th>
                        <th>é²åˆ°</th>
                        <th>äº‹å‡</th>
                        <th>ç—…å‡</th>
                        <th>ç”Ÿç†å‡</th>
                        <th>å…¬å‡</th>
                        <th>å–ªå‡</th>
                      </tr>
                    </thead>
                    <tbody id="absenceStatsBody">
                      <tr>
                        <td><span id="stat_æ› èª²">0</span> ç¯€</td>
                        <td><span id="stat_é²åˆ°">0</span> ç¯€</td>
                        <td><span id="stat_äº‹å‡">0</span> ç¯€</td>
                        <td><span id="stat_ç—…å‡">0</span> ç¯€</td>
                        <td><span id="stat_ç”Ÿç†å‡">0</span> ç¯€</td>
                        <td><span id="stat_å…¬å‡">0</span> ç¯€</td>
                        <td><span id="stat_å–ªå‡">0</span> ç¯€</td>
                      </tr>
                    </tbody>
                  </table>

                  <div class="mt-3"></div>

                  <!-- ç¼ºå‹¤è¨˜éŒ„ä½è­‰åœ–ä¸Šå‚³ -->
                  <div class="mb-3">
                    <label for="proof_image" class="form-label">ç¼ºå‹¤è¨˜éŒ„ä½è­‰åœ–ä¸Šå‚³</label>
                    <div class="image-preview-box" id="proofImagePreviewBox">
                      <span class="placeholder-text">é¸æ“‡æˆ–ä¸Šå‚³å¾Œé¡¯ç¤ºé è¦½</span>
                    </div>
                    <input class="form-control mt-2" type="file" id="proof_image" name="proof_image" accept="image/*">
                    <div class="form-text">ğŸ’¡ æç¤ºï¼šæ¥å—åœ–ç‰‡æª”æ¡ˆ (PNG, JPG, JPEG)ã€‚</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- éš±è—æ¬„ä½ï¼šå„²å­˜ç¼ºå‹¤ç´€éŒ„å’Œçµ±è¨ˆçš„ JSON -->
            <input type="hidden" id="all_absence_details_json" name="all_absence_details_json" value="[]">
            <input type="hidden" id="absence_stats_json" name="absence_stats_json" value="{}">

            <div class="text-center mt-4">
              <button type="submit" id="submitResumeBtn" class="btn btn-primary btn-lg">æäº¤ä¸¦ç”Ÿæˆå±¥æ­·</button>
              <button type="button" id="editResumeBtn" class="btn btn-warning btn-lg d-none">ä¿®æ”¹å±¥æ­·</button>
            </div>
          </form>
        </div>

        <!-- AI å±¥æ­·ä¿®æ”¹é ç±¤ -->
        <div class="tab-pane fade" id="ai-edit-pane" role="tabpanel" aria-labelledby="ai-edit-tab" tabindex="0">
          <div class="p-4">
            <h5 class="mb-3">AI å±¥æ­·ä¿®æ”¹æœå‹™</h5>
            
            <div class="mb-3">
              <label class="form-label fw-semibold">è¼¸å…¥æ‚¨çš„å±¥æ­·è‰ç¨¿ï¼š</label>
              <textarea id="ai-resume-input" class="form-control" rows="8" 
                placeholder="ç³»çµ±å°‡è‡ªå‹•è¼‰å…¥æ‚¨å·²ä¸Šå‚³å±¥æ­·ä¸­çš„è‡ªå‚³å…§å®¹ï¼Œæ‚¨ä¹Ÿå¯ä»¥æ‰‹å‹•ç·¨è¼¯..." 
                style="resize: vertical; font-size: 1rem; line-height: 1.6;"></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label fw-semibold">è«‹é¸æ“‡ä¿®æ”¹é¸é …ï¼š</label>
              <div class="row g-2">
                <div class="col-md-6">
                  <select id="ai-edit-style" class="form-select">
                    <option value="polish">ä»»å‹™ï¼šå±¥æ­·ç¾åŒ–</option>
                    <option value="concise">ä»»å‹™ï¼šæ–‡æ¡ˆç²¾ç°¡</option>
                    <option value="keyword_focus">ä»»å‹™ï¼šé—œéµå­—å°å‘</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <select id="ai-tone-style" class="form-select">
                    <option value="professional">èªæ°£ï¼šå°ˆæ¥­æ­£å¼</option>
                    <option value="friendly">èªæ°£ï¼šè¦ªåˆ‡éš¨å’Œ</option>
                    <option value="cautious">èªæ°£ï¼šè¬¹æ…çš„</option>
                    <option value="academic">èªæ°£ï¼šå­¸è¡“çš„</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="d-grid gap-2 mb-3">
              <button type="button" class="btn btn-primary btn-lg" onclick="reviseResumeInTab()">
                âš¡ ä½¿ç”¨ AI ä¿®æ”¹å±¥æ­·
              </button>
            </div>

            <div class="mb-3">
              <label class="form-label fw-semibold">ä¿®æ”¹å¾Œçš„å±¥æ­·ï¼š</label>
              <div id="ai-loading-spinner" class="text-center py-4" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                </div>
                <p class="mt-2 text-muted">AI æ­£åœ¨è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</p>
              </div>
              <div id="ai-revised-resume" class="form-control" 
                style="min-height: 150px; white-space: pre-wrap; background-color: #f8f9fa; line-height: 1.7; font-size: 1rem;">
                AI ä¿®æ”¹å¾Œçš„å…§å®¹å°‡é¡¯ç¤ºåœ¨é€™è£¡...
              </div>
            </div>

            <div class="d-grid gap-2">
              <button type="button" class="btn btn-success btn-lg" onclick="importAIResultToForm()">
                ğŸ“¥ å°å…¥è‡³è¡¨å–®å¡«å¯«
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    // ==========================================================
    // å…è²¬è²æ˜ Modal æ§åˆ¶é‚è¼¯
    // ==========================================================
    const DISCLAIMER_ACCEPTED_KEY = 'ai_disclaimer_accepted_v1';
    
    function hasAcceptedDisclaimer() {
      return localStorage.getItem(DISCLAIMER_ACCEPTED_KEY) === 'true';
    }
    
    function markDisclaimerAccepted() {
      localStorage.setItem(DISCLAIMER_ACCEPTED_KEY, 'true');
    }
    
    function showDisclaimerModal() {
      console.log('ğŸ“¢ é¡¯ç¤ºå…è²¬è²æ˜ Modal');
      
      const modal = document.getElementById('disclaimerModal');
      const checkbox = document.getElementById('disclaimerCheckbox');
      const confirmBtn = document.getElementById('confirmDisclaimerBtn');
      
      if (!modal) {
        console.error('âŒ æ‰¾ä¸åˆ° disclaimerModal');
        alert('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°å…è²¬è²æ˜è¦–çª—');
        return;
      }
      
      if (!checkbox) {
        console.error('âŒ æ‰¾ä¸åˆ° disclaimerCheckbox');
        return;
      }
      
      if (!confirmBtn) {
        console.error('âŒ æ‰¾ä¸åˆ° confirmDisclaimerBtn');
        return;
      }
      
      console.log('âœ… æ‰¾åˆ°æ‰€æœ‰å…ƒç´ ï¼Œé¡¯ç¤º modal');
      
      // é¡¯ç¤º modal - ä½¿ç”¨å¤šç¨®æ–¹å¼ç¢ºä¿é¡¯ç¤º
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
      modal.style.zIndex = '99999';
      modal.style.visibility = 'visible';
      
      // é‡ç½®ç‹€æ…‹
      checkbox.checked = false;
      confirmBtn.disabled = true;
      
      // Checkbox è®ŠåŒ–æ™‚æ›´æ–°æŒ‰éˆ•
      checkbox.onchange = function() {
        confirmBtn.disabled = !this.checked;
        console.log('Checkbox ç‹€æ…‹:', this.checked, 'æŒ‰éˆ• disabled:', confirmBtn.disabled);
      };
      
      // ç¢ºèªæŒ‰éˆ•é»æ“Š
      confirmBtn.onclick = function() {
        console.log('ç¢ºèªæŒ‰éˆ•è¢«é»æ“Šï¼Œcheckbox:', checkbox.checked);
        if (checkbox.checked) {
          // ä¸è¨˜éŒ„åˆ° localStorageï¼Œè®“æ¯æ¬¡é»æ“ŠæŒ‰éˆ•éƒ½è¦é¡¯ç¤º
          modal.classList.add('hidden');
          modal.style.display = 'none';
          
          // åˆ‡æ›åˆ° AI æ¨™ç±¤é ï¼ˆå¦‚æœæ˜¯å¾æŒ‰éˆ•é»æ“Šè§¸ç™¼çš„ï¼‰
          setTimeout(function() {
            const aiEditTab = document.getElementById('ai-edit-tab');
            if (aiEditTab && !aiEditTab.classList.contains('active')) {
              const tab = new bootstrap.Tab(aiEditTab);
              tab.show();
            }
          }, 100);
        } else {
          alert('è«‹å…ˆå‹¾é¸ç¢ºèªæ¡†ã€‚');
        }
      };
      
      // é˜²æ­¢é»æ“Šå¤–éƒ¨é—œé–‰
      modal.onclick = function(e) {
        if (e.target === modal) {
          alert('è«‹å…ˆå‹¾é¸ç¢ºèªæ¡†ä¸¦é»æ“Šã€Œæˆ‘å·²äº†è§£ä¸¦åŒæ„ã€æŒ‰éˆ•ã€‚');
        }
      };
      
      console.log('âœ… Modal å·²é¡¯ç¤º');
    }
    
    // æ¸¬è©¦å‡½æ•¸
    window.testShowModal = function() {
      localStorage.removeItem(DISCLAIMER_ACCEPTED_KEY);
      showDisclaimerModal();
    };

    // å„²å­˜æ‰€æœ‰èª²ç¨‹çš„åŸå§‹è³‡æ–™ï¼Œç”¨æ–¼ç¯©é¸å’ŒæŸ¥è©¢
    let disableAutoSave = false;
    let allCoursesData = [];
    let resumeDataLoaded = false; // æ¨™èªŒï¼šæ˜¯å¦å·²å¾è³‡æ–™åº«è¼‰å…¥å±¥æ­·è³‡æ–™
    // å„²å­˜æ‰€æœ‰ç¼ºå‹¤è¨˜éŒ„ï¼ˆç”¨æ–¼å‰ç«¯ç¯©é¸ï¼‰
    let allAbsenceRecords = [];
    // ç·¨è¼¯ç‹€æ…‹æ¨™èªŒï¼ˆåƒè€ƒ fill_preferences é é¢ï¼‰
    let isEditing = false;

    const CERT_MAX_COUNT = 32;
    const CERT_CONTAINER_ID = 'certificatesContainer';
    const CERT_ADD_BTN_ID = 'addCertificateBtn';
    let certEntries = [];
    let certIdSeed = 0;
    let currentPage = 1;
    const PAGE_SIZE = 10;
    let filteredCoursesCache = [];

    // ğŸ§© å°‡å„²å­˜è·¯å¾‘è½‰ç‚ºå‰ç«¯å¯é¡¯ç¤ºçš„ URLï¼ˆæ”¯æ´åæ–œç·šè·¯å¾‘ï¼‰
    // ç¢ºä¿ uploads/absence_proofs/ ç­‰è·¯å¾‘æ­£ç¢ºæŒ‡å‘ /uploads/absence_proofs/xxx
    function imagePathToUrl(path) {
      if (!path || typeof path !== 'string') return '';
      let normalized = (path + '').replace(/\\/g, '/').replace(/^\/+/, '').trim();
      if (!normalized) return '';
      // è‹¥è·¯å¾‘å« absence_proofs ä½†æœªä»¥ uploads/ é–‹é ­ï¼Œè£œä¸Š
      if (normalized.includes('absence_proofs') && !normalized.startsWith('uploads/')) {
        normalized = 'uploads/' + normalized;
      }
      return '/' + normalized;
    }

    // ğŸ§© æ›´æ–°åœ–ç‰‡é è¦½æ¡†ï¼šé¡¯ç¤ºæ—¢æœ‰è·¯å¾‘æˆ–ä½”ä½æ–‡å­—
    function updateImagePreviewBox(boxId, imageUrl) {
      const box = document.getElementById(boxId);
      if (!box) return;
      if (imageUrl) {
        box.innerHTML = '';
        const img = document.createElement('img');
        img.alt = 'é è¦½';
        img.src = imageUrl;
        box.appendChild(img);
      } else {
        box.innerHTML = '<span class="placeholder-text">é¸æ“‡æˆ–ä¸Šå‚³å¾Œé¡¯ç¤ºé è¦½</span>';
      }
    }

    // ğŸ§© å¾ users è¡¨å¸¶å…¥å§“åã€é›»å­ä¿¡ç®±ã€å€‹äººé ­è²¼ï¼ˆavatar_urlï¼‰
    async function fillBasicInfoFromUser() {
      const form = document.getElementById('resumeForm');
      if (!form) return;
      try {
        const res = await fetch('/api/current_user_profile');
        const result = await res.json();
        if (!result.success || !result.data) return;
        const d = result.data;
        const nameInput = form.querySelector('input[name="name"]');
        if (nameInput && (d.name != null && d.name !== '')) nameInput.value = d.name;
        const emailInput = form.querySelector('input[name="email"]');
        if (emailInput && (d.email != null && d.email !== '')) emailInput.value = d.email;
        if (d.avatar_url) {
          const photoInput = form.querySelector('input[name="photo"]');
          if (photoInput) {
            photoInput.setAttribute('data-image-path', d.avatar_url);
            updateImagePreviewBox('photoPreviewBox', imagePathToUrl(d.avatar_url));
          }
        }
        console.log('âœ… å·²å¾ users å¸¶å…¥å§“åã€é›»å­ä¿¡ç®±ã€å€‹äººé ­è²¼');
      } catch (e) {
        console.warn('å–å¾—ä½¿ç”¨è€…åŸºæœ¬è³‡æ–™å¤±æ•—:', e);
      }
    }

    // ğŸ§© æ¸…ç©ºæ‰€æœ‰åœ–ç‰‡é è¦½èˆ‡æª”æ¡ˆã€è­‰ç…§ï¼ˆç”¨æ–¼ã€Œæ–°å¢å±¥æ­·ã€ï¼‰ï¼Œå«æ¯ç­†è­‰ç…§çš„ä½è­‰åœ–
    async function clearAllImagesAndCertificates() {
      const form = document.getElementById('resumeForm');
      if (!form) return;

      // å€‹äººç…§ç‰‡
      const photoInput = form.querySelector('input[name="photo"]');
      if (photoInput) {
        photoInput.value = '';
        photoInput.removeAttribute('data-image-path');
      }
      updateImagePreviewBox('photoPreviewBox', '');

      // æˆç¸¾å–®
      const transcriptInput = document.getElementById('transcript_file');
      if (transcriptInput) {
        transcriptInput.value = '';
        transcriptInput.removeAttribute('data-image-path');
      }
      updateImagePreviewBox('transcriptPreviewBox', '');

      // ç¼ºå‹¤ä½è­‰åœ–
      const proofInput = document.getElementById('proof_image');
      if (proofInput) proofInput.value = '';
      updateImagePreviewBox('proofImagePreviewBox', '');

      // è­‰ç…§æ¸…ç©ºï¼ˆç§»é™¤æ‰€æœ‰è­‰ç…§æ¢ç›®ï¼Œå«æ¯ç­†è­‰ç…§çš„ä½è­‰åœ–ç‰‡ï¼‰
      await initializeCertificatesUI([]);

      // æ–°å¢å±¥æ­·æ™‚ä¸€ä½µæ¸…ç©ºç¼ºå‹¤ç´€éŒ„å€å¡Šèˆ‡ä½è­‰åœ–ï¼ˆé¿å…è¼‰å…¥ç¼ºå‹¤å¾Œåˆå¸¶å›èˆŠåœ–ï¼‰
      if (window.isNewResume) {
        const absenceDisplay = document.getElementById('absenceRecordsDisplay');
        if (absenceDisplay) {
          absenceDisplay.innerHTML = '<p class="text-muted text-center">è«‹é¸æ“‡å­¸æœŸç¯„åœä¸¦é»æ“Šã€Œç¯©é¸ã€æŒ‰éˆ•ä»¥è¼‰å…¥ç¼ºå‹¤è¨˜éŒ„</p>';
        }
        document.querySelectorAll('.absence-proof-image').forEach(function (input) {
          input.value = '';
        });
      }
      console.log('âœ… å·²æ¸…ç©ºæ‰€æœ‰åœ–ç‰‡èˆ‡è­‰ç…§');
    }

    // ğŸ§© ç¶å®šæª”æ¡ˆé¸æ“‡æ™‚å³æ™‚é è¦½ï¼ˆå€‹äººç…§ç‰‡ã€æˆç¸¾å–®ã€ç¼ºå‹¤ä½è­‰ï¼‰
    function bindImagePreview(inputId, boxId) {
      const input = document.getElementById(inputId);
      const box = document.getElementById(boxId);
      if (!input || !box) return;
      input.addEventListener('change', function () {
        const file = this.files && this.files[0];
        if (file && file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function (e) {
            updateImagePreviewBox(boxId, e.target.result);
          };
          reader.readAsDataURL(file);
        } else if (!file) {
          const existingPath = input.getAttribute('data-image-path');
          updateImagePreviewBox(boxId, imagePathToUrl(existingPath));
        }
      });
    }

    // ğŸ§© åˆ†é ç›¸é—œå‡½æ•¸ï¼ˆç§»åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä»¥ä¾¿å…¶ä»–å‡½æ•¸å¯ä»¥è¨ªå•ï¼‰
    function renderPagedCourses() {
      // ç¢ºä¿ä½¿ç”¨æ­£ç¢ºçš„æ•¸æ“šæºï¼šå„ªå…ˆä½¿ç”¨ filteredCoursesCacheï¼Œå¦‚æœç‚ºç©ºå‰‡ä½¿ç”¨ allCoursesData
      const sourceData = filteredCoursesCache.length > 0 ? filteredCoursesCache : allCoursesData;
      const start = (currentPage - 1) * PAGE_SIZE;
      const end = start + PAGE_SIZE;
      const pageCourses = sourceData.slice(start, end);
      console.log(`ğŸ“„ æ¸²æŸ“åˆ†é : ç•¶å‰é =${currentPage}, é¡¯ç¤ºèª²ç¨‹ ${start + 1}-${Math.min(end, sourceData.length)}/${sourceData.length}, æ•¸æ“šæº=${filteredCoursesCache.length > 0 ? 'filteredCoursesCache' : 'allCoursesData'}`);
      renderCourseTable(pageCourses);
    }

    // 2ï¸âƒ£ ç”¢ç”Ÿåˆ†é æŒ‰éˆ•
    function renderPagination() {
      const pagination = document.getElementById("course-pagination");
      if (!pagination) {
        console.warn("âš ï¸ æ‰¾ä¸åˆ°åˆ†é å…ƒç´  #course-pagination");
        return;
      }
      
      pagination.innerHTML = "";

      // ç¢ºä¿ä½¿ç”¨æ­£ç¢ºçš„æ•¸æ“šæº
      const sourceData = filteredCoursesCache.length > 0 ? filteredCoursesCache : allCoursesData;
      const totalCourses = sourceData.length;
      const totalPages = Math.ceil(totalCourses / PAGE_SIZE);
      
      console.log(`ğŸ“„ åˆ†é è³‡è¨Š: ç¸½èª²ç¨‹æ•¸=${totalCourses}, æ¯é =${PAGE_SIZE}, ç¸½é æ•¸=${totalPages}, filteredCoursesCache=${filteredCoursesCache.length}, allCoursesData=${allCoursesData.length}`);
      
      if (totalPages <= 1) {
        // åªæœ‰1é æ™‚ä¸é¡¯ç¤ºåˆ†é æ§ä»¶
        return;
      }

      // å°å·¥å…·ï¼šåˆ†é æŒ‰éˆ•å…ƒä»¶
      function createPageItem(label, enabled, onClick) {
        const li = document.createElement("li");
        li.className = `page-item ${enabled ? "" : "disabled"}`;
        li.innerHTML = `<button class="page-link">${label}</button>`;
        if (enabled) li.onclick = onClick;
        return li;
      }

      // ä¸Šä¸€é 
      pagination.appendChild(createPageItem("Â«", currentPage > 1, () => {
        currentPage--;
        renderPagedCourses();
        renderPagination();
      }));

      // é ç¢¼
      for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement("li");
        li.className = `page-item ${i === currentPage ? "active" : ""}`;
        li.innerHTML = `<button class="page-link">${i}</button>`;
        li.onclick = () => {
          currentPage = i;
          renderPagedCourses();
          renderPagination();
        };
        pagination.appendChild(li);
      }

      // ä¸‹ä¸€é 
      pagination.appendChild(createPageItem("Â»", currentPage < totalPages, () => {
        currentPage++;
        renderPagedCourses();
        renderPagination();
      }));
    }


    // ç¼ºå‹¤çµ±è¨ˆåˆå§‹å€¼
    let absenceStats = {
      "æ› èª²": 0, "é²åˆ°": 0, "äº‹å‡": 0, "ç—…å‡": 0,
      "ç”Ÿç†å‡": 0, "å…¬å‡": 0, "å–ªå‡": 0
    };

    // æ–°å¢: LocalStorage Key
    const AUTO_SAVE_KEY = 'resumeFormData';

    // ğŸ§© å»ºç«‹èª²ç¨‹åˆ— (å­¸åˆ†æ•¸æ¬„ä½å·²ç‚º type="text" ä»¥å®¹ç´ "3/3" ç­‰åˆ†æ•¸)
    function createCourseRow(course) {
      // èª²ç¨‹è³‡æ–™å‚™ä»½ï¼Œç”¨æ–¼ã€Œæœªä¿®èª²ã€æ™‚æ¢å¾©åŸå§‹å­¸åˆ†
      const creditsDisplay = course.credits || "";
      // é è¨­ç‚ºå·²ä¿®èª²ï¼ˆisNotTaken = falseï¼‰ï¼Œåªæœ‰æ˜ç¢ºæ¨™è¨˜ç‚ºæœªä¿®èª²æ™‚æ‰ç‚º true
      const isNotTaken = course.isNotTaken === true;  // åªæœ‰æ˜ç¢ºç‚º true æ™‚æ‰æ˜¯æœªä¿®èª²
      const displayCredits = isNotTaken ? "0" : creditsDisplay;
      const buttonClass = isNotTaken ? "btn-warning" : "btn-success";
      const buttonText = isNotTaken ? "æœªä¿®èª²" : "å·²ä¿®èª²";

      const tr = document.createElement("tr");
      // å„²å­˜åŸå§‹å­¸åˆ†æ•¸åœ¨ data-original-credits å±¬æ€§ä¸­
      tr.dataset.originalCredits = creditsDisplay;
      // å„²å­˜æœªä¿®èª²ç‹€æ…‹
      tr.dataset.isNotTaken = isNotTaken;

      tr.innerHTML = `
      <td><input type="text" name="course_name[]" class="form-control form-control-sm" value="${course.name || ""}" placeholder="è¼¸å…¥èª²ç¨‹åç¨±"></td>
      <td><input type="text" name="course_credits[]" class="form-control form-control-sm course-credits-input" value="${displayCredits}" placeholder="å­¸åˆ†"></td>
      <td><input type="text" name="course_grade[]" class="form-control form-control-sm course-grade-input" value="${course.grade || ""}" placeholder="è¼¸å…¥æˆç¸¾"></td>
      <td><button type="button" class="btn ${buttonClass} btn-sm toggle-not-taken">${buttonText}</button></td>
      `;

      // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼Œå½“æˆç»©è¾“å…¥æ”¹å˜æ—¶åŒæ­¥åˆ° allCoursesData
      const gradeInput = tr.querySelector('input[name="course_grade[]"]');
      if (gradeInput) {
        gradeInput.addEventListener('input', () => {
          const courseName = tr.querySelector('input[name="course_name[]"]').value;
          const index = allCoursesData.findIndex(c => c.name === courseName);
          if (index > -1) {
            allCoursesData[index].grade = gradeInput.value.trim();
            saveFormData();
          }
        });
      }

      return tr;
    }

    // ğŸ§© æ¸²æŸ“èª²ç¨‹è¡¨æ ¼
    function renderCourseTable(courses) {
      const tbody = document.getElementById("courseTableBody");
      tbody.innerHTML = "";

      if (courses.length === 0) {
        const row = document.createElement("tr");
        row.innerHTML = `<td colspan="4" class="text-muted text-center">è«‹å…ˆä¸‹è¼‰Excelç¯„æœ¬ï¼Œå¡«å¯«å®Œæˆå¾Œä¸Šå‚³ä»¥é¡¯ç¤ºèª²ç¨‹è³‡æ–™</td>`;
        tbody.appendChild(row);
        return;
      }

      courses.forEach(course => {
        tbody.appendChild(createCourseRow(course));
      });
      // é‡æ–°æ¸²æŸ“å¾Œï¼Œå„²å­˜ç•¶å‰èª²ç¨‹ç‹€æ…‹ (åŒ…æ‹¬æœªä¿®èª²æ¨™è¨˜)
      saveFormData();
    }

    // ğŸ§© åŸ·è¡ŒæŸ¥è©¢å’Œç¯©é¸
    function applyFilterAndSearch() {
      const searchTerm = document.getElementById("course-search").value.toLowerCase();
      const creditFilter = document.getElementById("credit-filter").value;

      const filteredCourses = allCoursesData.filter(course => {
        // 1. èª²ç¨‹åç¨±æŸ¥è©¢
        const nameMatch = course.name.toLowerCase().includes(searchTerm);
        if (!nameMatch) return false;

        // 2. å­¸åˆ†æ•¸ç¯©é¸
        if (!creditFilter) return true; // æœªé¸å–ç¯©é¸æ¢ä»¶

        // ç”±æ–¼è³‡æ–™å¯èƒ½ç‚º "3/3"ï¼Œä½¿ç”¨ parseFloat åªæœƒå–åˆ° "3"ï¼Œé€™å°ç¯©é¸æ˜¯æ­£ç¢ºçš„
        const credits = parseFloat(course.credits);
        if (isNaN(credits)) return false;

        switch (creditFilter) {
          case "1":
            return credits === 1;
          case "2":
            return credits === 2;
          case "3":
            return credits === 3;
          case "4+": // é›–ç„¶é¸é …æ²’æœ‰ 4+ï¼Œä½†ä¿ç•™é‚è¼¯ä»¥é˜²æœªä¾†æ“´å……
            return credits >= 4;
          default:
            return true;
        }
      });

      // ã€é—œéµä¿®æ­£ã€‘ç¢ºä¿éæ¿¾å¾Œçš„åˆ—è¡¨ç¸½æ˜¯æŒ‰ç…§èª²ç¨‹åç¨±æ’åº
      filteredCourses.sort((a, b) => a.name.localeCompare(b.name, 'zh-TW', {
        sensitivity: 'base'
      }));

      filteredCoursesCache = filteredCourses;
      currentPage = 1; // æ¯æ¬¡æœå°‹/ç¯©é¸éƒ½å›åˆ°ç¬¬ä¸€é 
      renderPagedCourses();
      renderPagination();
    }

    // ğŸ§© å¾å¾Œç«¯è¼‰å…¥å­¸ç”Ÿå€‹äººæ¨¡æ¿
    async function loadPersonalTemplate() {
      const tbody = document.getElementById("courseTableBody");
      if (!tbody) return;

      // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰èª²ç¨‹è³‡æ–™ï¼ˆå¦‚æœå·²ç¶“è¼‰å…¥ä¸”è¡¨æ ¼ä¸ç‚ºç©ºï¼Œå‰‡è·³éï¼‰
      if (resumeDataLoaded && allCoursesData.length > 0) {
        console.log("ğŸ“‹ å·²å¾è³‡æ–™åº«è¼‰å…¥å±¥æ­·è³‡æ–™ï¼Œè·³éè¼‰å…¥å€‹äººæ¨¡æ¿");
        return;
      }

      // å¦‚æœè¡¨æ ¼é‚„åœ¨é¡¯ç¤º"è¼‰å…¥ä¸­"æˆ–ç‚ºç©ºï¼Œå‰‡éœ€è¦è¼‰å…¥
      const currentContent = tbody.innerHTML.trim();
      if (currentContent && !currentContent.includes("è¼‰å…¥ä¸­") && !currentContent.includes("ç›®å‰ç„¡")) {
        // è¡¨æ ¼å·²ç¶“æœ‰å…§å®¹ï¼Œä¸éœ€è¦é‡æ–°è¼‰å…¥
        return;
      }

      tbody.innerHTML = '<tr><td colspan="4" class="text-muted text-center">è¼‰å…¥ä¸­...</td></tr>';
      try {
        const res = await fetch("/api/load_personal_template");
        const result = await res.json();

        if (result.success && Array.isArray(result.courses) && result.courses.length > 0) {
          // è¼‰å…¥æ™‚ï¼Œå˜—è©¦èˆ‡ LocalStorage ä¸­å„²å­˜çš„èª²ç¨‹ç‹€æ…‹åˆä½µ
          const savedData = JSON.parse(localStorage.getItem(AUTO_SAVE_KEY) || '{ }');
          const savedCourses = savedData.courses || [];

          allCoursesData = result.courses.map(course => {
            const savedCourse = savedCourses.find(c => c.name === course.name);
            // å„ªå…ˆä½¿ç”¨ LocalStorage å„²å­˜çš„ isNotTaken ç‹€æ…‹
            return {
              ...course,
              isNotTaken: savedCourse ? savedCourse.isNotTaken : (course.isNotTaken || false)
            };
          });

          // æ­¥é©Ÿ 1: ä¾ç…§èª²ç¨‹åç¨±æ’åº
          allCoursesData.sort((a, b) => a.name.localeCompare(b.name, 'zh-TW', {
            sensitivity: 'base'
          }));

          // ä½¿ç”¨åˆ†é æ–¹å¼æ¸²æŸ“
          filteredCoursesCache = [...allCoursesData];
          currentPage = 1;
          renderPagedCourses();
          renderPagination();
        } else {
          console.log("ç„¡å€‹äººæ¨¡æ¿ï¼Œæ”¹è¼‰å…¥æ¨™æº–èª²ç¨‹");
          await loadStandardCourses();
        }
      } catch (err) {
        console.error("âŒ è¼‰å…¥å€‹äººæ¨¡æ¿å¤±æ•—:", err);
        tbody.innerHTML = '<tr><td colspan="4" class="text-danger text-center">è¼‰å…¥å¤±æ•—</td></tr>';
        allCoursesData = [];
      }
    }

    // ğŸ§© è‹¥ç„¡å€‹äººæ¨¡æ¿ï¼Œè¼‰å…¥ç³»çµ±é è¨­èª²ç¨‹
    async function loadStandardCourses() {
      const tbody = document.getElementById("courseTableBody");
      tbody.innerHTML = '<tr><td colspan="4" class="text-muted text-center">è¼‰å…¥æ¨™æº–èª²ç¨‹ä¸­...</td></tr>';
      try {
        const res = await fetch("/api/get_standard_courses");
        const result = await res.json();
        if (result.success && result.courses?.length > 0) {
          allCoursesData = result.courses;

          // æ­¥é©Ÿ 1: ä¾ç…§èª²ç¨‹åç¨±æ’åº
          allCoursesData.sort((a, b) => a.name.localeCompare(b.name, 'zh-TW', {
            sensitivity: 'base'
          }));

          // ä½¿ç”¨åˆ†é æ–¹å¼æ¸²æŸ“
          filteredCoursesCache = [...allCoursesData];
          currentPage = 1;
          renderPagedCourses();
          renderPagination();
        } else {
          tbody.innerHTML = '<tr><td colspan="4" class="text-muted text-center">ç›®å‰ç„¡æ¨™æº–èª²ç¨‹</td></tr>';
          allCoursesData = [];
        }
      } catch (err) {
        console.error("âŒ è¼‰å…¥æ¨™æº–èª²ç¨‹å¤±æ•—:", err);
        tbody.innerHTML = '<tr><td colspan="4" class="text-danger text-center">è¼‰å…¥å¤±æ•—</td></tr>';
        allCoursesData = [];
      }
    }

    // ğŸ§© å„²å­˜ç‚ºå€‹äººæ¨¡æ¿
    async function savePersonalTemplate() {
      // å…ˆå¾è¡¨æ ¼ä¸­åŒæ­¥æœ€æ–°çš„ç‹€æ…‹åˆ° allCoursesData
      const courseRows = document.querySelectorAll('#courseTableBody tr');
      courseRows.forEach(row => {
        const nameInput = row.querySelector('input[name="course_name[]"]');
        const creditsInput = row.querySelector('input[name="course_credits[]"]');
        const gradeInput = row.querySelector('input[name="course_grade[]"]');
        const isNotTaken = row.dataset.isNotTaken === 'true';

        if (nameInput) {
          const courseName = nameInput.value.trim();
          const index = allCoursesData.findIndex(c => c.name === courseName);
          
          if (index > -1) {
            // æ›´æ–°ç¾æœ‰èª²ç¨‹çš„ç‹€æ…‹
            allCoursesData[index].name = courseName;
            allCoursesData[index].credits = creditsInput ? creditsInput.value.trim() : allCoursesData[index].credits;
            allCoursesData[index].grade = gradeInput ? gradeInput.value.trim() : allCoursesData[index].grade;
            allCoursesData[index].isNotTaken = isNotTaken;
          } else if (courseName) {
            // å¦‚æœæ˜¯æ–°èª²ç¨‹ï¼Œæ·»åŠ åˆ° allCoursesData
            allCoursesData.push({
              name: courseName,
              credits: creditsInput ? creditsInput.value.trim() : '',
              grade: gradeInput ? gradeInput.value.trim() : '',
              isNotTaken: isNotTaken
            });
          }
        }
      });

      // ä½¿ç”¨ allCoursesData ç¢ºä¿å„²å­˜æ‰€æœ‰èª²ç¨‹ï¼Œç„¡è«–ç¯©é¸ç‹€æ…‹
      const courses = allCoursesData.map(course => ({
        name: course.name,
        credits: course.credits,
        grade: course.grade || '',
        isNotTaken: course.isNotTaken || false // ç¢ºä¿æœ‰ isNotTaken å±¬æ€§
      }));

      if (courses.length === 0) {
        alert("è«‹å…ˆæ–°å¢è‡³å°‘ä¸€é–€èª²ç¨‹ï¼");
        return;
      }

      try {
        const res = await fetch("/api/save_personal_template", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            display_name: "æˆ‘çš„èª²ç¨‹æ¨¡æ¿",
            courses: courses
          })
        });
        const result = await res.json();
        if (result.success) {
          alert("âœ… æ¨¡æ¿å·²å„²å­˜ï¼");
          // é‡æ–°è¼‰å…¥å€‹äººæ¨¡æ¿ä»¥ç¢ºä¿é¡¯ç¤ºæœ€æ–°ç‹€æ…‹
          await loadPersonalTemplate();
        } else {
          alert("âŒ å„²å­˜å¤±æ•—ï¼š" + (result.message || ""));
        }
      } catch (err) {
        console.error("âŒ å„²å­˜æ¨¡æ¿éŒ¯èª¤:", err);
        alert("âŒ å„²å­˜å¤±æ•—ï¼š" + err.message);
      }
    }

    // ğŸ§© åˆªé™¤/æœªä¿®èª² ç›¸é—œçš„äº‹ä»¶è™•ç†
    document.getElementById("courseTableBody").addEventListener("click", e => {
      if (e.target.classList.contains("toggle-not-taken")) {
        const tr = e.target.closest("tr");
        const creditsInput = tr.querySelector(".course-credits-input");
        let isNotTaken = tr.dataset.isNotTaken === 'true';

        if (isNotTaken) {
          // å¾æœªä¿®èª²åˆ‡æ›å›å·²ä¿®èª²ï¼Œæ¢å¾©åŸå§‹å­¸åˆ†æ•¸
          creditsInput.value = tr.dataset.originalCredits;
          e.target.classList.remove("btn-warning");
          e.target.classList.add("btn-success");
          e.target.textContent = "å·²ä¿®èª²";
          tr.dataset.isNotTaken = false;
        } else {
          // å¾å·²ä¿®èª²åˆ‡æ›ç‚ºæœªä¿®èª²ï¼Œå­¸åˆ†æ•¸è¨­ç‚º 0
          creditsInput.value = "0";
          e.target.classList.remove("btn-success");
          e.target.classList.add("btn-warning");
          e.target.textContent = "æœªä¿®èª²";
          tr.dataset.isNotTaken = true;
        }

        // **é‡è¦ï¼š** åŒæ­¥æ›´æ–° allCoursesData ä¸­çš„ç‹€æ…‹
        const courseName = tr.querySelector('input[name="course_name[]"]').value;
        const index = allCoursesData.findIndex(c => c.name === courseName);
        if (index > -1) {
          allCoursesData[index].isNotTaken = !isNotTaken;
        }

        // ç‹€æ…‹æ”¹è®Šå¾Œå„²å­˜è¡¨å–®
        saveFormData();
      }
    });

    // ğŸ§© ç¶å®šæŸ¥è©¢å’Œç¯©é¸äº‹ä»¶
    document.getElementById("course-search").addEventListener("input", applyFilterAndSearch);
    document.getElementById("credit-filter").addEventListener("change", applyFilterAndSearch);

    async function downloadExcelTemplate() {
      try {
        // ç›´æ¥ä¸‹è¼‰ç¯„æœ¬æ–‡ä»¶
        const url = '/api/download_course_template';
        window.location.href = url;
        alert("ğŸ“¥ æ­£åœ¨ä¸‹è¼‰ç¯„æœ¬...");
      } catch (err) {
        console.error("âŒ ä¸‹è¼‰ç¯„æœ¬éŒ¯èª¤:", err);
        alert("âŒ ä¸‹è¼‰å¤±æ•—ï¼š" + err.message);
      }
    }

    // ğŸ§© åŒ¯å…¥Excelè³‡æ–™
    async function uploadExcelData() {
      const fileInput = document.getElementById('excel-file-input');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('è«‹å…ˆé¸æ“‡Excelæª”æ¡ˆ');
        return;
      }
      
      if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
        alert('è«‹é¸æ“‡Excelæª”æ¡ˆï¼ˆ.xlsx æˆ– .xlsï¼‰');
        return;
      }
      
      const formData = new FormData();
      formData.append('file', file);
      
      try {
        const tbody = document.getElementById("courseTableBody");
        tbody.innerHTML = '<tr><td colspan="4" class="text-muted text-center">æ­£åœ¨åŒ¯å…¥Excelè³‡æ–™...</td></tr>';
        
        const res = await fetch('/api/student/upload_course_excel', {
          method: 'POST',
          body: formData
        });
        
        const result = await res.json();
        
        if (!result.success) {
          alert('âŒ åŒ¯å…¥å¤±æ•—ï¼š' + (result.message || 'æœªçŸ¥éŒ¯èª¤'));
          tbody.innerHTML = '<tr><td colspan="4" class="text-danger text-center">åŒ¯å…¥å¤±æ•—</td></tr>';
          return;
        }
        
        if (!result.courses || result.courses.length === 0) {
          alert('âš ï¸ Excelæ–‡ä»¶ä¸­æ²’æœ‰æ‰¾åˆ°èª²ç¨‹è³‡æ–™');
          tbody.innerHTML = '<tr><td colspan="4" class="text-muted text-center">æ²’æœ‰æ‰¾åˆ°èª²ç¨‹è³‡æ–™</td></tr>';
          return;
        }
        
        // æ›´æ–°èª²ç¨‹è³‡æ–™
        allCoursesData = result.courses.map(course => ({
          name: course.name || '',
          credits: course.credits || '0',
          grade: course.grade || '',
          isNotTaken: course.isNotTaken || false
        }));
        
        // æ’åº
        allCoursesData.sort((a, b) => a.name.localeCompare(b.name, 'zh-TW', {
          sensitivity: 'base'
        }));
        
        // æ¸²æŸ“èª²ç¨‹è¡¨æ ¼
        filteredCoursesCache = [...allCoursesData];
        currentPage = 1;
        renderPagedCourses();
        renderPagination();
        
        alert(`âœ… æˆåŠŸåŒ¯å…¥ ${result.courses.length} é–€èª²ç¨‹ï¼`);
        
        // æ¸…ç©ºæ–‡ä»¶è¼¸å…¥
        fileInput.value = '';
        
      } catch (err) {
        console.error("âŒ åŒ¯å…¥ExceléŒ¯èª¤:", err);
        alert("âŒ åŒ¯å…¥å¤±æ•—ï¼š" + err.message);
        const tbody = document.getElementById("courseTableBody");
        tbody.innerHTML = '<tr><td colspan="4" class="text-danger text-center">åŒ¯å…¥å¤±æ•—</td></tr>';
      }
    }
    // =========================================================================
    // è­‰ç…§å‹•æ…‹ç®¡ç†ï¼ˆä»£ç¢¼ + åç¨± + é¡åˆ¥ + åœ–ç‰‡ï¼‰
    // =========================================================================

    // è¼”åŠ©å‡½æ•¸ï¼šæ ¼å¼åŒ–æ—¥æœŸç‚º yyyy-MM-dd æ ¼å¼ï¼ˆç”¨æ–¼ HTML5 date è¼¸å…¥æ¡†ï¼‰
    function formatDateForInput(dateValue) {
      if (!dateValue) return '';

      // å¦‚æœå·²ç¶“æ˜¯ yyyy-MM-dd æ ¼å¼ï¼Œç›´æ¥è¿”å›
      if (/^\d{4}-\d{2}-\d{2}$/.test(dateValue)) {
        return dateValue;
      }

      try {
        // å˜—è©¦è§£æå„ç¨®æ—¥æœŸæ ¼å¼
        const date = new Date(dateValue);
        if (isNaN(date.getTime())) {
          console.warn('ç„¡æ³•è§£ææ—¥æœŸ:', dateValue);
          return '';
        }

        // æ ¼å¼åŒ–ç‚º yyyy-MM-dd
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      } catch (e) {
        console.warn('æ—¥æœŸæ ¼å¼åŒ–å¤±æ•—:', dateValue, e);
        return '';
      }
    }

    // è¼”åŠ©å‡½æ•¸ï¼šå¾è­‰ç…§åç¨±ä¸­è§£æè·é¡å’Œç´šåˆ¥
    function parseCertNameToJobCategoryAndLevel(certName) {
      if (!certName) return { jobCategory: '', level: '' };

      // å¸¸è¦‹ç´šåˆ¥ï¼šç”²ç´šã€ä¹™ç´šã€ä¸™ç´šã€ä¸ç´š
      const levelPattern = /(ç”²ç´š|ä¹™ç´š|ä¸™ç´š|ä¸ç´š|ç”²|ä¹™|ä¸™|ä¸)/;
      const match = certName.match(levelPattern);

      if (match) {
        const level = match[1];
        // å°‡ç°¡å¯«è½‰æ›ç‚ºå®Œæ•´å½¢å¼
        const levelMap = { 'ç”²': 'ç”²ç´š', 'ä¹™': 'ä¹™ç´š', 'ä¸™': 'ä¸™ç´š', 'ä¸': 'ä¸ç´š' };
        const fullLevel = levelMap[level] || level;
        const jobCategory = certName.replace(levelPattern, '').trim();
        return { jobCategory, level: fullLevel };
      }

      // å¦‚æœæ²’æœ‰æ‰¾åˆ°ç´šåˆ¥ï¼Œæ•´å€‹åç¨±ä½œç‚ºè·é¡ï¼Œç´šåˆ¥ç‚ºç©º
      return { jobCategory: certName, level: '' };
    }

    function updateCertificateControlsState() {
      const countEl = document.getElementById("cert-count");
      if (countEl) countEl.textContent = certEntries.length;
      const addBtn = document.getElementById(CERT_ADD_BTN_ID);
      if (addBtn) addBtn.disabled = certEntries.length >= CERT_MAX_COUNT;
    }

    function createCertificateEntryElement(entryId) {
      const wrapper = document.createElement('div');
      wrapper.className = 'certificate-entry border rounded p-3 mb-3';
      wrapper.dataset.entryId = entryId;
      wrapper.innerHTML = `
       <div class="row g-2 align-items-end">
         <div class="col-12 d-flex align-items-center gap-2">
           <span class="badge bg-primary-subtle text-primary cert-index-badge">#</span>
           <div class="text-muted small">è­‰ç…§é …ç›®</div>
           <div class="ms-auto">
             <button type="button" class="btn btn-outline-danger btn-sm remove-cert">ç§»é™¤</button>
           </div>
         </div>
         <div class="col-md-4">
           <label class="form-label form-label-sm">ç™¼è­‰ä¸­å¿ƒ <span class="text-danger">*</span></label>
           <select class="form-select form-select-sm cert-authority-select" 
                  name="cert_authority[]" id="cert_authority_${entryId}" required>
             <option value="">è«‹é¸æ“‡ç™¼è­‰ä¸­å¿ƒ...</option>
           </select>
         </div>
         <div class="col-md-4 cert-authority-name-wrapper" style="display: none;">
           <label class="form-label form-label-sm">ç™¼è­‰ä¸­å¿ƒåç¨± <span class="text-danger">*</span></label>
           <input type="text" class="form-control form-control-sm cert-authority-name-input" 
                  name="cert_authority_name[]" id="cert_authority_name_${entryId}" 
                  placeholder="è«‹è¼¸å…¥ç™¼è­‰ä¸­å¿ƒåç¨±">
         </div>
         <div class="col-md-4 cert-job-category-wrapper">
           <label class="form-label form-label-sm">è·é¡(é …)åç¨± <span class="text-danger">*</span></label>
           <select class="form-select form-select-sm cert-job-category-select" 
                  name="cert_job_category[]" id="cert_job_category_${entryId}" required>
             <option value="">è«‹å…ˆé¸æ“‡ç™¼è­‰ä¸­å¿ƒ</option>
           </select>
           <input type="hidden" class="cert-code-input" name="cert_code[]" id="cert_code_${entryId}">
           <input type="hidden" class="cert-name-input" name="cert_names[]" id="cert_name_${entryId}">
           <input type="hidden" class="cert-category-input" name="cert_type[]" id="cert_type_${entryId}">
         </div>
         <div class="col-md-4 cert-level-wrapper">
           <label class="form-label form-label-sm">ç´šåˆ¥ <span class="text-danger">*</span></label>
           <select class="form-select form-select-sm cert-level-select" 
                  name="cert_level[]" id="cert_level_${entryId}" required>
             <option value="">è«‹å…ˆé¸æ“‡è·é¡</option>
           </select>
         </div>
         <div class="col-md-4 cert-custom-name-wrapper" style="display: none;">
           <label class="form-label form-label-sm">è­‰ç…§åç¨±ï¼ˆè‡ªå¡«ï¼‰ <span class="text-danger">*</span></label>
           <input type="text" class="form-control form-control-sm cert-custom-name-input" 
                  name="cert_custom_name[]" id="cert_custom_name_${entryId}" 
                  placeholder="è«‹è¼¸å…¥è­‰ç…§åç¨±" required>
         </div>
         <div class="col-md-4 cert-other-job-category-wrapper" style="display: none;">
           <label class="form-label form-label-sm">è·é¡(é …)åç¨±ï¼ˆè‡ªå¡«ï¼‰ <span class="text-danger">*</span></label>
           <input type="text" class="form-control form-control-sm cert-other-job-category-input" 
                  name="cert_other_job_category[]" id="cert_other_job_category_${entryId}" 
                  placeholder="ä¾‹ï¼šé›»è…¦è»Ÿé«”æ‡‰ç”¨">
         </div>
         <div class="col-md-4 cert-other-level-wrapper" style="display: none;">
           <label class="form-label form-label-sm">ç´šåˆ¥ï¼ˆè‡ªå¡«ï¼‰ <span class="text-danger">*</span></label>
           <input type="text" class="form-control form-control-sm cert-other-level-input" 
                  name="cert_other_level[]" id="cert_other_level_${entryId}" 
                  placeholder="ä¾‹ï¼šä¸™ç´šã€ä¹™ç´š">
         </div>
         <div class="col-md-4">
           <label class="form-label form-label-sm">å–å¾—æ—¥æœŸ <span class="text-danger">*</span></label>
           <input type="date" class="form-control form-control-sm cert-acquisition-date-input" 
                  name="cert_acquisition_date[]" id="cert_acquisition_date_${entryId}" required>
         </div>
         <div class="col-md-4">
           <label class="form-label form-label-sm">ç™¼è­‰äºº (é¸å¡«)</label>
           <input type="text" class="form-control form-control-sm cert-issuer-input" 
                  name="cert_issuer[]" id="cert_issuer_${entryId}" placeholder="è«‹è¼¸å…¥ç™¼è­‰äººå§“å">
         </div>
         <div class="col-md-6 col-lg-4">
           <label class="form-label form-label-sm">ä½è­‰åœ–ç‰‡ (å¯é¸)</label>
           <div class="image-preview-box small" id="cert_photo_preview_${entryId}" style="max-width:120px;min-height:80px;">
             <span class="placeholder-text">å¯é¸</span>
           </div>
           <input type="file" class="form-control form-control-sm cert-photo-input mt-1" 
                  name="cert_photos[]" id="cert_photo_${entryId}" accept="image/*">
         </div>
       </div>
     `;
      return wrapper;
    }

    async function addCertificateEntry(prefill = {}, options = {}) {
      const { silent = false } = options;
      if (certEntries.length >= CERT_MAX_COUNT) {
        alert(`æœ€å¤šåªèƒ½è¼¸å…¥ ${CERT_MAX_COUNT} é …è­‰ç…§`);
        return;
      }

      const entryId = `cert-${Date.now()}-${certIdSeed++}`;
      const container = document.getElementById(CERT_CONTAINER_ID);
      if (!container) return;

      const element = createCertificateEntryElement(entryId);
      const authoritySelect = element.querySelector('.cert-authority-select');
      const authorityNameWrapper = element.querySelector('.cert-authority-name-wrapper');
      const authorityNameInput = element.querySelector('.cert-authority-name-input');
      const jobCategoryWrapper = element.querySelector('.cert-job-category-wrapper');
      const jobCategorySelect = element.querySelector('.cert-job-category-select');
      const levelWrapper = element.querySelector('.cert-level-wrapper');
      const levelSelect = element.querySelector('.cert-level-select');
      const customNameWrapper = element.querySelector('.cert-custom-name-wrapper');
      const customNameInput = element.querySelector('.cert-custom-name-input');
      const otherJobCategoryWrapper = element.querySelector('.cert-other-job-category-wrapper');
      const otherJobCategoryInput = element.querySelector('.cert-other-job-category-input');
      const otherLevelWrapper = element.querySelector('.cert-other-level-wrapper');
      const otherLevelInput = element.querySelector('.cert-other-level-input');
      const codeInput = element.querySelector('.cert-code-input');
      const nameInput = element.querySelector('.cert-name-input');
      const categoryInput = element.querySelector('.cert-category-input');
      const acquisitionDateInput = element.querySelector('.cert-acquisition-date-input');
      const issuerInput = element.querySelector('.cert-issuer-input');
      const fileInput = element.querySelector('.cert-photo-input');
      const removeBtn = element.querySelector('.remove-cert');
      const indexBadge = element.querySelector('.cert-index-badge');

      // å…ˆè¼‰å…¥ç™¼è­‰ä¸­å¿ƒåˆ—è¡¨ï¼ˆå¿…é ˆå…ˆè¼‰å…¥é¸é …ï¼Œæ‰èƒ½è¨­ç½®å€¼ï¼‰
      await loadCertAuthorities(authoritySelect);

      // é å¡«å……è³‡æ–™ï¼ˆå¦‚æœæœ‰ï¼‰
      if (prefill.authority_id) {
        authoritySelect.value = prefill.authority_id;

        // é©—è­‰æ˜¯å¦è¨­ç½®æˆåŠŸ
        if (authoritySelect.value !== prefill.authority_id) {
          console.warn(`âš ï¸ ç™¼è­‰ä¸­å¿ƒè¨­ç½®å¤±æ•—: æœŸæœ›=${prefill.authority_id}, å¯¦éš›=${authoritySelect.value}`);
        } else {
          console.log(`âœ… ç™¼è­‰ä¸­å¿ƒè¨­ç½®æˆåŠŸ: ${prefill.authority_id}`);
        }

        if (prefill.authority_id === 'OTHER') {
          // é¸æ“‡ã€Œå…¶ä»–ã€ç™¼è­‰ä¸­å¿ƒæ™‚ï¼Œé¡¯ç¤ºè‡ªå¡«è¼¸å…¥æ¡†
          if (prefill.authority_name) {
            authorityNameInput.value = prefill.authority_name;
          }
          authorityNameWrapper.style.display = 'block';
          authorityNameInput.required = true;

          // éš±è—è·é¡å’Œç´šåˆ¥ä¸‹æ‹‰æ¡†ï¼Œé¡¯ç¤ºè‡ªå¡«è¼¸å…¥æ¡†ï¼ˆä¸é¡¯ç¤ºè­‰ç…§åç¨±è‡ªå¡«ï¼‰
          jobCategoryWrapper.style.display = 'none';
          jobCategorySelect.required = false;
          levelWrapper.style.display = 'none';
          levelSelect.required = false;
          customNameWrapper.style.display = 'none';
          customNameInput.required = false;
          otherJobCategoryWrapper.style.display = 'block';
          otherJobCategoryInput.required = true;
          otherLevelWrapper.style.display = 'block';
          otherLevelInput.required = true;

          if (prefill.custom_cert_name) {
            customNameInput.value = prefill.custom_cert_name;
            nameInput.value = prefill.custom_cert_name;
          }

          // é å¡«å……è·é¡å’Œç´šåˆ¥ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
          if (prefill.job_category) {
            otherJobCategoryInput.value = prefill.job_category;
          }
          if (prefill.level) {
            otherLevelInput.value = prefill.level;
          }

          // è¨­ç½®éš±è—æ¬„ä½
          codeInput.value = 'OTHER';
          categoryInput.value = 'other';
        } else {
          // éã€Œå…¶ä»–ã€ç™¼è­‰ä¸­å¿ƒæ™‚ï¼Œé¡¯ç¤ºè·é¡å’Œç´šåˆ¥ä¸‹æ‹‰æ¡†
          jobCategoryWrapper.style.display = 'block';
          jobCategorySelect.required = true;
          levelWrapper.style.display = 'block';
          levelSelect.required = true;
          customNameWrapper.style.display = 'none';
          customNameInput.required = false;

          // å¦‚æœæœ‰é å¡«å……çš„è·é¡å’Œç´šåˆ¥ï¼Œå°‡åœ¨è¼‰å…¥è·é¡åˆ—è¡¨å¾Œè¨­ç½®
          const prefillJobCategory = prefill.job_category || (prefill.name ? parseCertNameToJobCategoryAndLevel(prefill.name).jobCategory : null);
          const prefillLevel = prefill.level || (prefill.name ? parseCertNameToJobCategoryAndLevel(prefill.name).level : null);

          console.log(`ğŸ” è­‰ç…§é å¡«å……è³‡æ–™: authority_id=${prefill.authority_id}, job_category=${prefillJobCategory || '(ç©º)'}, level=${prefillLevel || '(ç©º)'}, prefill.level=${prefill.level || '(ç©º)'}, prefill.name=${prefill.name || '(ç©º)'}`);

          if (prefill.code || prefill.cert_code) {
            codeInput.value = prefill.code || prefill.cert_code;
          }
          if (prefill.name || prefill.cert_name) {
            nameInput.value = prefill.name || prefill.cert_name;
          }

          // è¼‰å…¥è·é¡å’Œç´šåˆ¥åˆ—è¡¨ï¼ˆå¦‚æœæœ‰é å¡«å……å€¼ï¼Œæœƒè‡ªå‹•è¨­ç½®ï¼‰
          if (prefill.authority_id && prefill.authority_id !== 'OTHER') {
            console.log(`ğŸ“¥ æº–å‚™è¼‰å…¥è·é¡å’Œç´šåˆ¥: authority_id=${prefill.authority_id}, job_category=${prefillJobCategory || '(ç©º)'}, level=${prefillLevel || '(ç©º)'}`);
            await loadJobCategoriesAndLevels(prefill.authority_id, jobCategorySelect, levelSelect, codeInput, nameInput, categoryInput, prefillJobCategory, prefillLevel);
          } else {
            console.log(`âš ï¸ ç„¡æ³•è¼‰å…¥è·é¡å’Œç´šåˆ¥: authority_id=${prefill.authority_id || '(ç©º)'}, è·³éè¼‰å…¥`);
          }
        }
      }

      // è™•ç†å–å¾—æ—¥æœŸï¼šæª¢æŸ¥å¤šå€‹å¯èƒ½çš„å­—æ®µå
      const dateValue = prefill.acquire_date || prefill.acquisition_date || '';
      if (dateValue) {
        // æ ¼å¼åŒ–æ—¥æœŸç‚º yyyy-MM-dd æ ¼å¼
        const formattedAcqDate = formatDateForInput(dateValue);
        if (formattedAcqDate) {
          acquisitionDateInput.value = formattedAcqDate;
          console.log(`âœ… å–å¾—æ—¥æœŸè¨­ç½®æˆåŠŸ: ${dateValue} â†’ ${formattedAcqDate}`);
        } else {
          console.warn(`âš ï¸ æ—¥æœŸæ ¼å¼åŒ–å¤±æ•—: ${dateValue}`);
        }
      } else {
        console.log(`â„¹ï¸ æ²’æœ‰å–å¾—æ—¥æœŸè³‡æ–™: acquire_date=${prefill.acquire_date || '(ç©º)'}, acquisition_date=${prefill.acquisition_date || '(ç©º)'}`);
      }

      if (prefill.issuer) {
        issuerInput.value = prefill.issuer;
      }

      // å¦‚æœæœ‰è­‰ç…§åœ–ç‰‡è·¯å¾‘ï¼Œä¿å­˜åˆ° data å±¬æ€§ä¸¦è¨­ç½®æŒ‰éˆ•
      // æª¢æŸ¥å¤šå€‹å¯èƒ½çš„å­—æ®µåï¼šcert_path, CertPath, certPath
      let certImagePath = prefill.cert_path || prefill.CertPath || prefill.certPath || '';

      // å°‡ Windows è·¯å¾‘æ ¼å¼ï¼ˆåæ–œæ ï¼‰è½‰æ›ç‚º Web è·¯å¾‘æ ¼å¼ï¼ˆæ­£æ–œæ ï¼‰
      if (certImagePath) {
        certImagePath = certImagePath.replace(/\\/g, '/');
      }

      console.log(`ğŸ” è­‰ç…§åœ–ç‰‡è·¯å¾‘æª¢æŸ¥: cert_path=${prefill.cert_path || '(ç©º)'}, CertPath=${prefill.CertPath || '(ç©º)'}, certPath=${prefill.certPath || '(ç©º)'}, æœ€çµ‚å€¼=${certImagePath || '(ç©º)'}`);

      if (certImagePath && certImagePath.trim()) {
        fileInput.setAttribute('data-image-path', certImagePath);
        // ç§»é™¤èˆŠçš„æç¤ºï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        const oldHint = fileInput.parentElement.querySelector('.cert-photo-hint');
        if (oldHint) oldHint.remove();
      } else {
        console.log(`âš ï¸ æ²’æœ‰è­‰ç…§åœ–ç‰‡è·¯å¾‘ï¼Œè·³éè¨­ç½®æŒ‰éˆ•`);
      }

      // è­‰ç…§ä½è­‰åœ–ç‰‡é¸æ“‡æ™‚å³æ™‚é è¦½
      fileInput.addEventListener('change', function () {
        const boxId = 'cert_photo_preview_' + entryId;
        const file = this.files && this.files[0];
        if (file && file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function (e) {
            updateImagePreviewBox(boxId, e.target.result);
          };
          reader.readAsDataURL(file);
        } else if (!file) {
          const path = this.getAttribute('data-image-path');
          updateImagePreviewBox(boxId, imagePathToUrl(path || ''));
        }
      });

      // ç™¼è­‰ä¸­å¿ƒé¸æ“‡æ”¹è®Šæ™‚ï¼Œè¼‰å…¥è©²ä¸­å¿ƒçš„è·é¡å’Œç´šåˆ¥åˆ—è¡¨
      authoritySelect.addEventListener('change', async () => {
        const authorityId = authoritySelect.value;

        // é¡¯ç¤º/éš±è—ã€Œå…¶ä»–ã€ç™¼è­‰ä¸­å¿ƒåç¨±è¼¸å…¥æ¬„ä½
        if (authorityId === 'OTHER') {
          authorityNameWrapper.style.display = 'block';
          authorityNameInput.required = true;

          // é¸æ“‡ã€Œå…¶ä»–ã€ç™¼è­‰ä¸­å¿ƒæ™‚ï¼Œéš±è—è·é¡å’Œç´šåˆ¥ä¸‹æ‹‰æ¡†ï¼Œç›´æ¥é¡¯ç¤ºè‡ªå¡«è¼¸å…¥æ¡†ï¼ˆä¸é¡¯ç¤ºè­‰ç…§åç¨±è‡ªå¡«ï¼‰
          jobCategoryWrapper.style.display = 'none';
          jobCategorySelect.required = false;
          levelWrapper.style.display = 'none';
          levelSelect.required = false;
          customNameWrapper.style.display = 'none';
          customNameInput.required = false;
          otherJobCategoryWrapper.style.display = 'block';
          otherJobCategoryInput.required = true;
          otherLevelWrapper.style.display = 'block';
          otherLevelInput.required = true;

          // æ¸…ç©ºè·é¡å’Œç´šåˆ¥
          jobCategorySelect.value = '';
          levelSelect.value = '';

          // è¨­ç½®éš±è—æ¬„ä½
          codeInput.value = 'OTHER';
          nameInput.value = '';
          categoryInput.value = 'other';
        } else {
          authorityNameWrapper.style.display = 'none';
          authorityNameInput.required = false;
          authorityNameInput.value = '';

          // é¡¯ç¤ºè·é¡å’Œç´šåˆ¥ä¸‹æ‹‰æ¡†ï¼Œéš±è—è‡ªå¡«è¼¸å…¥æ¡†
          jobCategoryWrapper.style.display = 'block';
          jobCategorySelect.required = true;
          levelWrapper.style.display = 'block';
          levelSelect.required = true;
          customNameWrapper.style.display = 'none';
          customNameInput.required = false;
          otherJobCategoryWrapper.style.display = 'none';
          otherJobCategoryInput.required = false;
          otherLevelWrapper.style.display = 'none';
          otherLevelInput.required = false;
          otherJobCategoryInput.value = '';
          otherLevelInput.value = '';
          customNameInput.value = '';

          // æ¸…ç©ºè·é¡å’Œç´šåˆ¥
          jobCategorySelect.innerHTML = '<option value="">è¼‰å…¥ä¸­...</option>';
          levelSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡è·é¡</option>';
          codeInput.value = '';
          nameInput.value = '';
          categoryInput.value = '';

          if (authorityId) {
            await loadJobCategoriesAndLevels(authorityId, jobCategorySelect, levelSelect, codeInput, nameInput, categoryInput);
          } else {
            jobCategorySelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡ç™¼è­‰ä¸­å¿ƒ</option>';
          }
        }
        saveFormData();
      });

      // è·é¡é¸æ“‡æ”¹è®Šæ™‚ï¼Œè¼‰å…¥å°æ‡‰çš„ç´šåˆ¥åˆ—è¡¨
      jobCategorySelect.addEventListener('change', () => {
        const selectedJobCategory = jobCategorySelect.value;
        levelSelect.innerHTML = '<option value="">è«‹é¸æ“‡ç´šåˆ¥</option>';
        codeInput.value = '';
        nameInput.value = '';
        categoryInput.value = '';

        if (selectedJobCategory) {
          // å¾ dataset ä¸­ç²å–è©²è·é¡å°æ‡‰çš„ç´šåˆ¥åˆ—è¡¨
          const levelsDataStr = jobCategorySelect.dataset.levelsData;
          if (levelsDataStr) {
            try {
              const levelsData = JSON.parse(levelsDataStr);
              const levels = levelsData[selectedJobCategory] || [];

              levels.forEach(level => {
                const option = document.createElement('option');
                option.value = level;
                option.textContent = level;
                levelSelect.appendChild(option);
              });

              // è§¸ç™¼è‡ªå®šç¾©äº‹ä»¶ï¼Œé€šçŸ¥ç´šåˆ¥é¸é …å·²è¼‰å…¥
              levelSelect.dispatchEvent(new CustomEvent('levelsLoaded', { bubbles: true }));
              console.log(`âœ… è·é¡ã€Œ${selectedJobCategory}ã€çš„ç´šåˆ¥é¸é …å·²è¼‰å…¥: ${levels.join(', ')}`);
            } catch (e) {
              console.error("è§£æç´šåˆ¥æ•¸æ“šå¤±æ•—:", e);
            }
          }
        }
        saveFormData();
      });

      // ç´šåˆ¥é¸æ“‡æ”¹è®Šæ™‚ï¼ŒæŸ¥æ‰¾å°æ‡‰çš„è­‰ç…§ä»£ç¢¼
      levelSelect.addEventListener('change', async () => {
        const selectedJobCategory = jobCategorySelect.value;
        const selectedLevel = levelSelect.value;
        const authorityId = authoritySelect.value;

        if (selectedJobCategory && selectedLevel && authorityId && authorityId !== 'OTHER') {
          // æŸ¥æ‰¾å°æ‡‰çš„è­‰ç…§ä»£ç¢¼
          await findCertCodeByJobCategoryAndLevel(authorityId, selectedJobCategory, selectedLevel, codeInput, nameInput, categoryInput);
        }
        saveFormData();
      });

      // å–å¾—æ—¥æœŸã€ç™¼è­‰äººã€è‡ªå¡«æ¬„ä½è¼¸å…¥æ”¹è®Šæ™‚ä¿å­˜
      acquisitionDateInput.addEventListener('change', saveFormData);
      issuerInput.addEventListener('input', saveFormData);
      authorityNameInput.addEventListener('input', saveFormData);
      customNameInput.addEventListener('input', () => {
        // ç•¶è‡ªå¡«è­‰ç…§åç¨±æ”¹è®Šæ™‚ï¼Œæ›´æ–°éš±è—æ¬„ä½ï¼ˆç”¨æ–¼ã€Œå…¶ä»–ã€ç™¼è­‰ä¸­å¿ƒçš„æƒ…æ³ï¼‰
        if (customNameInput.value) {
          nameInput.value = customNameInput.value;
        }
        saveFormData();
      });
      otherJobCategoryInput.addEventListener('input', saveFormData);
      otherLevelInput.addEventListener('input', saveFormData);

      removeBtn.addEventListener('click', () => removeCertificateEntry(entryId));

      container.appendChild(element);

      // è­‰ç…§åœ–ç‰‡é è¦½é ˆåœ¨å…ƒç´ å·²åŠ å…¥ DOM å¾Œå†æ›´æ–°ï¼Œå¦å‰‡ getElementById æ‰¾ä¸åˆ°
      if (certImagePath && certImagePath.trim()) {
        updateImagePreviewBox('cert_photo_preview_' + entryId, imagePathToUrl(certImagePath));
      }

      certEntries.push({
        id: entryId,
        certId: prefill && prefill.id ? prefill.id : null,
        wrapper: element,
        authoritySelect,
        authorityNameWrapper,
        authorityNameInput,
        jobCategoryWrapper,
        jobCategorySelect,
        levelWrapper,
        levelSelect,
        customNameWrapper,
        customNameInput,
        otherJobCategoryWrapper,
        otherJobCategoryInput,
        otherLevelWrapper,
        otherLevelInput,
        codeInput,
        nameInput,
        categoryInput,
        acquisitionDateInput,
        issuerInput,
        fileInput,
        indexBadge
      });

      refreshCertificateIndices();
      if (!silent) saveFormData();
    }

    function refreshCertificateIndices() {
      certEntries.forEach((entry, idx) => {
        if (entry.indexBadge) {
          entry.indexBadge.textContent = idx + 1;
        }
      });
      updateCertificateControlsState();
    }

    // ğŸ§© è¼‰å…¥ç™¼è­‰ä¸­å¿ƒåˆ—è¡¨
    async function loadCertAuthorities(authoritySelect) {
      try {
        const res = await fetch("/api/get_cert_authorities");
        const result = await res.json();

        // ä¿ç•™ç¬¬ä¸€å€‹é¸é …ï¼ˆè«‹é¸æ“‡...ï¼‰
        const firstOption = authoritySelect.querySelector('option[value=""]');

        // æ¸…ç©ºæ‰€æœ‰é¸é …ï¼ˆåŒ…æ‹¬å¯èƒ½å­˜åœ¨çš„ã€Œå…¶ä»–ã€é¸é …ï¼‰
        authoritySelect.innerHTML = '';
        if (firstOption) {
          authoritySelect.appendChild(firstOption);
        }

        if (result.success && result.authorities) {
          // æ·»åŠ ç™¼è­‰ä¸­å¿ƒé¸é …ï¼ˆéæ¿¾æ‰è³‡æ–™åº«ä¸­çš„ã€Œå…¶ä»–ã€é¸é …ï¼Œå› ç‚ºæˆ‘å€‘æœƒåœ¨æœ€å¾Œæ·»åŠ ï¼‰
          result.authorities.forEach(auth => {
            // è·³é name ç‚ºã€Œå…¶ä»–ã€çš„è¨˜éŒ„ï¼Œé¿å…é‡è¤‡
            if (auth.name && auth.name.trim() === 'å…¶ä»–') {
              return;
            }
            const option = document.createElement('option');
            option.value = auth.id;
            option.textContent = auth.name;
            authoritySelect.appendChild(option);
          });
        }

        // åœ¨æ‰€æœ‰ç™¼è­‰ä¸­å¿ƒé¸é …ä¹‹å¾Œï¼Œæ·»åŠ ã€Œå…¶ä»–ã€é¸é …ï¼ˆä½¿ç”¨ value='OTHER' ä»¥å€åˆ†ï¼‰
        // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡è¤‡ï¼ˆé›–ç„¶å·²ç¶“æ¸…ç©ºï¼Œä½†ä»¥é˜²è¬ä¸€ï¼‰
        if (!authoritySelect.querySelector('option[value="OTHER"]')) {
          const otherOption = document.createElement('option');
          otherOption.value = 'OTHER';
          otherOption.textContent = 'å…¶ä»–';
          authoritySelect.appendChild(otherOption);
        }
      } catch (error) {
        console.error("âŒ è¼‰å…¥ç™¼è­‰ä¸­å¿ƒåˆ—è¡¨å¤±æ•—:", error);
        // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ã€Œå…¶ä»–ã€é¸é …ï¼Œé¿å…é‡è¤‡æ·»åŠ 
        if (!authoritySelect.querySelector('option[value="OTHER"]')) {
          const otherOption = document.createElement('option');
          otherOption.value = 'OTHER';
          otherOption.textContent = 'å…¶ä»–';
          authoritySelect.appendChild(otherOption);
        }
      }
    }

    // ğŸ§© æ ¹æ“šç™¼è­‰ä¸­å¿ƒè¼‰å…¥è·é¡å’Œç´šåˆ¥åˆ—è¡¨
    async function loadJobCategoriesAndLevels(authorityId, jobCategorySelect, levelSelect, codeInput, nameInput, categoryInput, prefillJobCategory = null, prefillLevel = null) {
      try {
        const res = await fetch(`/api/get_job_categories_and_levels?authority_id=${encodeURIComponent(authorityId)}`);
        const result = await res.json();

        jobCategorySelect.innerHTML = '<option value="">è«‹é¸æ“‡è·é¡...</option>';
        levelSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡è·é¡</option>';

        if (result.success && result.job_categories) {
          // å„²å­˜è·é¡å’Œç´šåˆ¥çš„å°æ‡‰é—œä¿‚åˆ°é¸æ“‡å™¨çš„ dataset
          const jobCategoryLevelsData = result.job_category_levels || {};
          jobCategorySelect.dataset.levelsData = JSON.stringify(jobCategoryLevelsData);

          // å¡«å……è·é¡ä¸‹æ‹‰æ¡†
          result.job_categories.forEach(jobCategory => {
            const option = document.createElement('option');
            option.value = jobCategory;
            option.textContent = jobCategory;
            jobCategorySelect.appendChild(option);
          });

          // å¦‚æœæœ‰é å¡«å……çš„è·é¡ï¼Œè¨­ç½®å®ƒ
          if (prefillJobCategory) {
            console.log(`ğŸ” è¨­ç½®è·é¡: ${prefillJobCategory}, ç´šåˆ¥: ${prefillLevel || '(ç„¡)'}`);
            console.log(`ğŸ” jobCategoryLevelsData:`, jobCategoryLevelsData);

            // å…ˆè¨­ç½®è·é¡å€¼
            jobCategorySelect.value = prefillJobCategory;

            // å¦‚æœæœ‰é å¡«å……çš„ç´šåˆ¥ï¼Œéœ€è¦å…ˆè¼‰å…¥ç´šåˆ¥é¸é …ï¼Œç„¶å¾Œè¨­ç½®å€¼
            if (prefillLevel) {
              console.log(`â³ æº–å‚™è¨­ç½®ç´šåˆ¥: ${prefillLevel}`);

              // ç›´æ¥å¾ jobCategoryLevelsData ç²å–ç´šåˆ¥é¸é …ï¼ˆä¸ç­‰å¾…äº‹ä»¶ï¼‰
              const levelsForCategory = jobCategoryLevelsData[prefillJobCategory] || [];
              console.log(`ğŸ” è·é¡ã€Œ${prefillJobCategory}ã€å°æ‡‰çš„ç´šåˆ¥é¸é …: [${levelsForCategory.join(', ')}]`);

              if (levelsForCategory.length > 0) {
                // å…ˆå¡«å……ç´šåˆ¥é¸é …
                levelSelect.innerHTML = '<option value="">è«‹é¸æ“‡ç´šåˆ¥</option>';
                levelsForCategory.forEach(level => {
                  const option = document.createElement('option');
                  option.value = level;
                  option.textContent = level;
                  levelSelect.appendChild(option);
                });

                // è¨­ç½®ç´šåˆ¥å€¼
                if (levelsForCategory.includes(prefillLevel)) {
                  levelSelect.value = prefillLevel;
                  console.log(`âœ… ç´šåˆ¥è¨­ç½®æˆåŠŸï¼ˆç›´æ¥è¨­ç½®ï¼‰: ${prefillLevel}, å¯¦éš›å€¼=${levelSelect.value}`);

                  // è§¸ç™¼ç´šåˆ¥é¸æ“‡äº‹ä»¶ä»¥è¨­ç½®è­‰ç…§ä»£ç¢¼
                  const levelChangeEvent = new Event('change', { bubbles: true });
                  levelSelect.dispatchEvent(levelChangeEvent);
                } else {
                  console.warn(`âš ï¸ ç´šåˆ¥ã€Œ${prefillLevel}ã€ä¸åœ¨å¯ç”¨é¸é …ä¸­: [${levelsForCategory.join(', ')}]`);
                }
              } else {
                console.warn(`âš ï¸ è·é¡ã€Œ${prefillJobCategory}ã€æ²’æœ‰å°æ‡‰çš„ç´šåˆ¥é¸é …`);

                // è¨­ç½®ä¸€æ¬¡æ€§ç›£è½å™¨ï¼Œç•¶ç´šåˆ¥é¸é …è¼‰å…¥å®Œæˆå¾Œè¨­ç½®å€¼ï¼ˆå‚™ç”¨æ–¹æ¡ˆï¼‰
                const setLevelWhenLoaded = () => {
                  const levelOptions = Array.from(levelSelect.options).map(opt => opt.value);
                  if (levelOptions.includes(prefillLevel)) {
                    levelSelect.value = prefillLevel;
                    console.log(`âœ… ç´šåˆ¥è¨­ç½®æˆåŠŸï¼ˆäº‹ä»¶è§¸ç™¼ï¼‰: ${prefillLevel}, å¯¦éš›å€¼=${levelSelect.value}`);

                    // è§¸ç™¼ç´šåˆ¥é¸æ“‡äº‹ä»¶ä»¥è¨­ç½®è­‰ç…§ä»£ç¢¼
                    const levelChangeEvent = new Event('change', { bubbles: true });
                    levelSelect.dispatchEvent(levelChangeEvent);
                  }
                  levelSelect.removeEventListener('levelsLoaded', setLevelWhenLoaded);
                };

                // ç›£è½ç´šåˆ¥é¸é …è¼‰å…¥å®Œæˆäº‹ä»¶
                levelSelect.addEventListener('levelsLoaded', setLevelWhenLoaded, { once: true });

                // è§¸ç™¼è·é¡é¸æ“‡äº‹ä»¶ä»¥è¼‰å…¥ç´šåˆ¥é¸é …
                const changeEvent = new Event('change', { bubbles: true });
                jobCategorySelect.dispatchEvent(changeEvent);

                // å‚™ç”¨æ–¹æ¡ˆï¼šå¦‚æœäº‹ä»¶æ²’æœ‰è§¸ç™¼ï¼Œä½¿ç”¨å»¶é²æª¢æŸ¥
                setTimeout(() => {
                  if (levelSelect.value !== prefillLevel) {
                    const levelOptions = Array.from(levelSelect.options).map(opt => opt.value);
                    console.log(`ğŸ” å‚™ç”¨æ–¹æ¡ˆæª¢æŸ¥: æœŸæœ›ç´šåˆ¥=${prefillLevel}, ç•¶å‰å€¼=${levelSelect.value}, å¯ç”¨é¸é …=[${levelOptions.join(', ')}]`);
                    if (levelOptions.includes(prefillLevel)) {
                      levelSelect.value = prefillLevel;
                      console.log(`âœ… ç´šåˆ¥è¨­ç½®æˆåŠŸï¼ˆå‚™ç”¨æ–¹æ¡ˆï¼‰: ${prefillLevel}, å¯¦éš›å€¼=${levelSelect.value}`);
                      const levelChangeEvent = new Event('change', { bubbles: true });
                      levelSelect.dispatchEvent(levelChangeEvent);
                    } else {
                      console.warn(`âš ï¸ ç´šåˆ¥é¸é …ä¸­æ²’æœ‰æ‰¾åˆ°ã€Œ${prefillLevel}ã€ï¼Œå¯ç”¨é¸é …: [${levelOptions.join(', ')}]`);
                    }
                  } else {
                    console.log(`âœ… ç´šåˆ¥å·²æ­£ç¢ºè¨­ç½®: ${prefillLevel}`);
                  }
                }, 500);
              }
            } else {
              console.log(`â„¹ï¸ æ²’æœ‰é å¡«å……çš„ç´šåˆ¥`);
              // æ²’æœ‰é å¡«å……çš„ç´šåˆ¥ï¼Œåªè§¸ç™¼è·é¡é¸æ“‡äº‹ä»¶
              const changeEvent = new Event('change', { bubbles: true });
              jobCategorySelect.dispatchEvent(changeEvent);
            }
          } else {
            console.log(`â„¹ï¸ æ²’æœ‰é å¡«å……çš„è·é¡`);
          }
        }
      } catch (error) {
        console.error("âŒ è¼‰å…¥è·é¡å’Œç´šåˆ¥åˆ—è¡¨å¤±æ•—:", error);
        jobCategorySelect.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>';
      }
    }

    // ğŸ§© æ ¹æ“šè·é¡å’Œç´šåˆ¥æŸ¥æ‰¾å°æ‡‰çš„è­‰ç…§ä»£ç¢¼
    async function findCertCodeByJobCategoryAndLevel(authorityId, jobCategory, level, codeInput, nameInput, categoryInput) {
      try {
        // å…ˆç²å–è©²ç™¼è­‰ä¸­å¿ƒçš„æ‰€æœ‰è­‰ç…§
        const res = await fetch(`/api/get_certificates_by_authority?authority_id=${encodeURIComponent(authorityId)}`);
        const result = await res.json();

        if (result.success && result.certificates) {
          // çµ„åˆå®Œæ•´è­‰ç…§åç¨±
          const fullCertName = `${jobCategory}${level}`;

          // æŸ¥æ‰¾åŒ¹é…çš„è­‰ç…§ï¼ˆç²¾ç¢ºåŒ¹é…æˆ–åŒ…å«åŒ¹é…ï¼‰
          const matchedCert = result.certificates.find(cert => {
            return cert.name === fullCertName ||
              (cert.name.includes(jobCategory) && cert.name.includes(level));
          });

          if (matchedCert) {
            codeInput.value = matchedCert.code;
            nameInput.value = matchedCert.name;
            categoryInput.value = matchedCert.category || 'other';
            return true;
          }
        }
        return false;
      } catch (error) {
        console.error("âŒ æŸ¥æ‰¾è­‰ç…§ä»£ç¢¼å¤±æ•—:", error);
        return false;
      }
    }

    // ğŸ§© è™•ç†è­‰ç…§ä»£ç¢¼è¼¸å…¥ï¼šå‘å¾Œç«¯æŸ¥è©¢è­‰ç…§åç¨±å’Œé¡åˆ¥ (ä¿ç•™ä»¥å…¼å®¹èˆŠä»£ç¢¼ï¼Œä½†æ–°ç‰ˆæœ¬ä½¿ç”¨ä¸‹æ‹‰é¸å–®)
    async function handleCertificateCodeInput(codeInput, currentNameInput, categorySelect) {
      const raw = (codeInput.value || '').toUpperCase().trim();
      codeInput.value = raw;
      saveFormData();

      // ç¢ºå®šç•¶å‰ä½¿ç”¨çš„ Name æ¬„ä½ï¼ˆå¯èƒ½æ˜¯ input æˆ– selectï¼‰
      let nameElement = currentNameInput;
      if (nameElement.tagName === 'SELECT') {
        // å¦‚æœç•¶å‰æ˜¯ <select>ï¼Œæˆ‘å€‘è¦å°‡å®ƒæ›å› <input>ï¼Œä¸¦é‡æ–°ç²å– DOM å¼•ç”¨
        const originalInput = document.createElement('input');
        originalInput.type = 'text';
        originalInput.className = nameElement.className;
        originalInput.id = nameElement.id; // ä¾è³´ createCertificateEntryElement ä¸­è¨­å®šçš„å”¯ä¸€ ID
        originalInput.name = nameElement.name;
        originalInput.required = nameElement.required;
        originalInput.value = ''; // æ¸…ç©ºå€¼

        nameElement.replaceWith(originalInput);
        nameElement = originalInput; // å°‡ nameElement é‡æ–°æŒ‡å‘æ–°çš„ <input>
      }

      // 1. â— æŸ¥è©¢å‰ï¼Œå…ˆæ¸…é™¤æ¬„ä½ç‹€æ…‹ (é—œéµä¿®æ­£ï¼Œé¿å…èˆŠå€¼æ®˜ç•™)
      nameElement.value = '';
      categorySelect.value = 'other';
      nameElement.readOnly = false;

      // 2. å¦‚æœä»£ç¢¼ç‚ºç©ºï¼Œå‰‡ä¸åšæŸ¥è©¢ä¸¦è¿”å›
      if (!raw) {
        // ç‹€æ…‹åœ¨å‰é¢å·²ç¶“è¢«æ¸…é™¤ï¼Œç›´æ¥è¿”å›
        return;
      }

      // 3. åŸ·è¡ŒæŸ¥è©¢
      try {
        const res = await fetch(`/api/get_certificate_info?code=${encodeURIComponent(raw)}`);
        const result = await res.json();

        // ç¢ºä¿æˆåŠŸä¸”æœ‰è³‡æ–™
        if (result.success && result.info && result.info.length > 0) {
          const certs = result.info;

          if (certs.length === 1) {
            // æƒ…æ³ 1: åªæœ‰ä¸€å€‹çµæœ (è‡ªå‹•å¡«å…¥ï¼Œè¦†è“‹å‰é¢çš„ç©ºå€¼)
            const info = certs[0];
            nameElement.value = info.name || '';
            categorySelect.value = info.category || 'other';
            nameElement.readOnly = false;

          } else {
            // æƒ…æ³ 2: æœ‰å¤šå€‹çµæœ (æ›¿æ›ç‚ºä¸‹æ‹‰é¸å–®)

            const selectId = nameElement.id + '-select';
            const newSelect = document.createElement('select');
            newSelect.className = nameElement.className;
            newSelect.id = selectId;
            newSelect.name = nameElement.name;
            newSelect.required = nameElement.required;

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'è«‹é¸æ“‡è­‰ç…§åç¨±...';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            newSelect.appendChild(defaultOption);

            certs.forEach(cert => {
              const option = document.createElement('option');
              option.value = cert.name;
              option.textContent = cert.name;
              option.dataset.category = cert.category;
              newSelect.appendChild(option);
            });

            // æ›¿æ›åŸä¾†çš„ <input>
            nameElement.replaceWith(newSelect);

            // é‡æ–°è¨­ç½® nameElement è®Šæ•¸å¼•ç”¨
            nameElement = newSelect;

            // ç‚ºä¸‹æ‹‰é¸å–®æ·»åŠ äº‹ä»¶ç›£è½å™¨ï¼Œä»¥æ›´æ–° Category
            newSelect.addEventListener('change', function () {
              const selectedOption = this.options[this.selectedIndex];
              const selectedCategory = selectedOption.dataset.category;

              if (selectedCategory) {
                categorySelect.value = selectedCategory;
              } else {
                categorySelect.value = 'other';
              }
              saveFormData();
            });
          }
        } else {
          // å¾Œç«¯æŸ¥ä¸åˆ°ï¼Œå€¼åœ¨å‰é¢å·²ç¶“æ¸…ç©ºï¼Œä¿æŒç¾ç‹€å³å¯ (è®“ä½¿ç”¨è€…æ‰‹å‹•è¼¸å…¥)
          console.log(`âš ï¸ å¾Œç«¯æŸ¥ç„¡ä»£ç¢¼ ${raw}ï¼Œè«‹æ‰‹å‹•è¼¸å…¥åç¨±`);
        }
      } catch (error) {
        console.error("âŒ æŸ¥è©¢è­‰ç…§ä»£ç¢¼å¤±æ•—:", error);
      }

      saveFormData();
    }

    // ä¿®æ­£å¾Œçš„ removeCertificateEntry å‡½æ•¸
    function removeCertificateEntry(entryId) {
      // ç²å–å®¹å™¨å’Œç›¸é—œå…ƒç´ ï¼ˆéœ€è¦é¡å¤–é‚è¼¯ä¾†ç²å–ç•¶å‰æ­£ç¢ºçš„ nameElementï¼‰
      const index = certEntries.findIndex(entry => entry.id === entryId);
      if (index === -1) return;

      const entry = certEntries[index]; // ç²å–ç•¶å‰é …ç›®çš„ç‰©ä»¶

      // --- æƒ…æ³ 1: åƒ…å‰©ä¸€ç­†è­‰ç…§æ™‚ï¼Œæ¸…ç©ºæ¬„ä½è€Œéç§»é™¤æ•´å€‹ wrapper ---
      if (certEntries.length === 1) {
        // æ¸…ç©ºæ‰€æœ‰æ¬„ä½
        if (entry.authoritySelect) entry.authoritySelect.value = '';
        if (entry.authorityNameWrapper) entry.authorityNameWrapper.style.display = 'none';
        if (entry.authorityNameInput) {
          entry.authorityNameInput.value = '';
          entry.authorityNameInput.required = false;
        }
        if (entry.jobCategoryWrapper) entry.jobCategoryWrapper.style.display = 'block';
        if (entry.jobCategorySelect) {
          entry.jobCategorySelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡ç™¼è­‰ä¸­å¿ƒ</option>';
          entry.jobCategorySelect.required = true;
        }
        if (entry.levelWrapper) entry.levelWrapper.style.display = 'block';
        if (entry.levelSelect) {
          entry.levelSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡è·é¡</option>';
          entry.levelSelect.required = true;
        }
        if (entry.customNameWrapper) entry.customNameWrapper.style.display = 'none';
        if (entry.customNameInput) {
          entry.customNameInput.value = '';
          entry.customNameInput.required = false;
        }
        if (entry.jobCategorySelect) entry.jobCategorySelect.value = '';
        if (entry.levelSelect) entry.levelSelect.value = '';
        if (entry.codeInput) entry.codeInput.value = '';
        if (entry.nameInput) entry.nameInput.value = '';
        if (entry.categoryInput) entry.categoryInput.value = '';
        if (entry.acquisitionDateInput) entry.acquisitionDateInput.value = '';
        if (entry.issuerInput) entry.issuerInput.value = '';
        if (entry.fileInput) entry.fileInput.value = '';
        saveFormData();
        return;
      }

      // --- æƒ…æ³ 2: å¤šæ–¼ä¸€ç­†è­‰ç…§æ™‚ï¼Œç§»é™¤æ•´å€‹ wrapper ---

      // åŸä¾†çš„ç§»é™¤é‚è¼¯
      const [removedEntry] = certEntries.splice(index, 1);
      removedEntry.wrapper.remove();

      refreshCertificateIndices();
      saveFormData();
    }

    async function initializeCertificatesUI(initialCerts = []) {
      const container = document.getElementById(CERT_CONTAINER_ID);
      if (!container) return;
      container.innerHTML = '';
      certEntries = [];

      // å¦‚æœæ²’æœ‰è­‰ç…§è³‡æ–™ï¼Œé¡¯ç¤ºã€Œå°šæœªè¨­å®šã€æç¤ºï¼Œä¸å‰µå»ºç©ºæ¢ç›®ï¼ˆè®“ç”¨æˆ¶æ‰‹å‹•æ·»åŠ ï¼‰
      if (!initialCerts || initialCerts.length === 0) {
        console.log('ğŸ“‹ æ²’æœ‰è­‰ç…§è³‡æ–™ï¼Œä¸å‰µå»ºç©ºæ¢ç›®');
        container.innerHTML = '<p class="text-muted small mb-0 py-2">å°šç„¡è­‰ç…§ï¼Œè«‹é»æ“Šã€Œï¼‹æ–°å¢è­‰ç…§ã€æ·»åŠ </p>';
        refreshCertificateIndices();
        return;
      }

      // åªæ·»åŠ å¯¦éš›æœ‰è³‡æ–™çš„è­‰ç…§æ¢ç›®
      const data = initialCerts.slice(0, CERT_MAX_COUNT);
      console.log(`ğŸ“‹ åˆå§‹åŒ–è­‰ç…§UI: ${data.length} ç­†è­‰ç…§è³‡æ–™`);

      // ä½¿ç”¨ for...of å¾ªç’°ä¸¦ awaitï¼Œç¢ºä¿æŒ‰é †åºè¼‰å…¥
      for (const cert of data) {
        await addCertificateEntry(cert, { silent: true });
      }

      refreshCertificateIndices();

    }

    // =========================================================================
    // LocalStorage å„²å­˜
    // =========================================================================

    function saveFormData() {
      // åªæœ‰åœ¨ç·¨è¼¯æ¨¡å¼ä¸‹æ‰ä¿å­˜åˆ° LocalStorageï¼ˆåƒè€ƒ fill_preferences é é¢ï¼‰
      if (disableAutoSave || !isEditing) return;

      const form = document.getElementById("resumeForm");
      const data = {
        fields: {},
        courses: allCoursesData.map(course => ({
          name: course.name,
          credits: course.credits,
          grade: course.grade || '',
          isNotTaken: course.isNotTaken || false
        })),
        certificates: certEntries.map(entry => {
          const authorityId = entry.authoritySelect ? entry.authoritySelect.value : '';
          const isOther = authorityId === 'OTHER';
          return {
            authority_id: authorityId,
            authority_name: entry.authorityNameInput ? entry.authorityNameInput.value.trim() : '',
            code: entry.codeInput ? entry.codeInput.value.trim() : '',
            name: entry.nameInput ? entry.nameInput.value.trim() : '',
            custom_cert_name: entry.customNameInput ? entry.customNameInput.value.trim() : '',
            job_category: isOther && entry.otherJobCategoryInput ? entry.otherJobCategoryInput.value.trim() : (entry.jobCategorySelect ? entry.jobCategorySelect.value.trim() : ''),
            level: isOther && entry.otherLevelInput ? entry.otherLevelInput.value : (entry.levelSelect ? entry.levelSelect.value : ''),
            category: entry.categoryInput ? entry.categoryInput.value : 'other',
            acquisition_date: entry.acquisitionDateInput ? entry.acquisitionDateInput.value : '',
            issuer: entry.issuerInput ? entry.issuerInput.value.trim() : ''
          };
        })
      };

      const skip = new Set(["cert_names[]", "cert_type[]", "cert_code[]", "course_name[]", "course_credits[]", "course_grade[]"]);

      form.querySelectorAll('input, select, textarea').forEach(input => {
        const name = input.name;
        if (!name || input.type === 'file' || skip.has(name)) return;
        data.fields[name] = input.value;
      });

      localStorage.setItem(AUTO_SAVE_KEY, JSON.stringify(data));
      console.log("ğŸ’¾ è¡¨å–®å·²è‡ªå‹•å„²å­˜ï¼ˆç·¨è¼¯æ¨¡å¼ï¼‰", {
        fieldsCount: Object.keys(data.fields).length,
        coursesCount: data.courses.length,
        certificatesCount: data.certificates.length
      });
    }

    function loadFormData() {
      const savedDataString = localStorage.getItem(AUTO_SAVE_KEY);
      const form = document.getElementById("resumeForm");
      if (!form) {
        console.warn("âš ï¸ æ‰¾ä¸åˆ°è¡¨å–®å…ƒç´ ï¼Œå»¶é²è¼‰å…¥");
        setTimeout(loadFormData, 100);
        return;
      }

      disableAutoSave = true;

      if (!savedDataString) {
        console.log("ğŸ“­ LocalStorage ä¸­æ²’æœ‰ä¿å­˜çš„è³‡æ–™");
        // ä¸è¦æ¸…ç©ºè­‰ç…§è³‡æ–™ï¼Œä¿ç•™å¾è³‡æ–™åº«è¼‰å…¥çš„è³‡æ–™
        // initializeCertificatesUI([]);
        disableAutoSave = false;
        return;
      }

      try {
        const data = JSON.parse(savedDataString);
        console.log("ğŸ“¥ å¾ LocalStorage è¼‰å…¥è³‡æ–™:", data);

        // å…ˆè¼‰å…¥åŸºæœ¬æ¬„ä½
        if (data.fields) {
          let loadedCount = 0;
          Object.entries(data.fields).forEach(([name, value]) => {
            const input = form.querySelector(`[name="${name}"]`);
            if (input) {
              // ç¢ºä¿ä¸æœƒè¦†è“‹å·²å­˜åœ¨çš„å€¼ï¼ˆé™¤éæ˜¯ç©ºå€¼ï¼‰
              if (value !== null && value !== undefined && value !== '') {
                input.value = value;
                loadedCount++;
                if (name === 'conduct_score_numeric') {
                  input.dispatchEvent(new Event('input'));
                }
              }
            } else {
              console.warn(`âš ï¸ æ‰¾ä¸åˆ°æ¬„ä½: ${name}`);
            }
          });
          console.log(`âœ… æˆåŠŸè¼‰å…¥ ${loadedCount} å€‹æ¬„ä½`);
        }

        // è¼‰å…¥è­‰ç…§è³‡æ–™ï¼ˆåªæœ‰åœ¨ LocalStorage ä¸­æœ‰è­‰ç…§è³‡æ–™æ™‚æ‰è¦†è“‹ï¼‰
        let certificateData = [];
        if (Array.isArray(data.certificates) && data.certificates.length) {
          certificateData = data.certificates;
        } else if (Array.isArray(data.certNames) && data.certNames.length) {
          certificateData = data.certNames.map(name => ({ name }));
        } else if (Array.isArray(data.certificatesLegacy)) {
          certificateData = data.certificatesLegacy;
        }

        // åªæœ‰åœ¨ LocalStorage ä¸­æœ‰è­‰ç…§è³‡æ–™æ™‚æ‰åˆå§‹åŒ–è­‰ç…§ UIï¼ˆä¿ç•™ç”¨æˆ¶çš„è‡¨æ™‚ä¿®æ”¹ï¼‰
        // å¦‚æœæ²’æœ‰ï¼Œå‰‡ä¿ç•™å¾è³‡æ–™åº«è¼‰å…¥çš„è­‰ç…§è³‡æ–™
        if (certificateData.length > 0) {
          console.log(`ğŸ“œ å¾ LocalStorage è¼‰å…¥ ${certificateData.length} ç­†è­‰ç…§è³‡æ–™ï¼ˆè¦†è“‹è³‡æ–™åº«è³‡æ–™ï¼‰`);
          initializeCertificatesUI(certificateData);
        } else {
          console.log("ğŸ“œ LocalStorage ä¸­æ²’æœ‰è­‰ç…§è³‡æ–™ï¼Œä¿ç•™å¾è³‡æ–™åº«è¼‰å…¥çš„è­‰ç…§è³‡æ–™");
        }

        // è¼‰å…¥èª²ç¨‹è³‡æ–™ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
        if (data.courses && Array.isArray(data.courses)) {
          // èª²ç¨‹è³‡æ–™æœƒåœ¨ loadPersonalTemplate ä¸­è™•ç†ï¼Œé€™è£¡å…ˆä¿å­˜
          console.log(`ğŸ“š å·²ä¿å­˜ ${data.courses.length} å€‹èª²ç¨‹ç‹€æ…‹`);
        }

        // è¼‰å…¥ç¼ºå‹¤è¨˜éŒ„è¡¨å–®è³‡æ–™ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
        loadAbsenceFormData();
      } catch (error) {
        console.error("âŒ è¼‰å…¥ LocalStorage è³‡æ–™å¤±æ•—:", error);
        localStorage.removeItem(AUTO_SAVE_KEY);
        initializeCertificatesUI([]);
      } finally {
        disableAutoSave = false;
      }
    }

    const addCertBtn = document.getElementById(CERT_ADD_BTN_ID);
    if (addCertBtn) {
      addCertBtn.addEventListener('click', () => addCertificateEntry());
    }



    // ğŸ§© æª¢æŸ¥æ˜¯å¦æœ‰å·²æäº¤çš„å±¥æ­·ï¼ˆæœ€æ–°ä¸€ç­†ï¼‰ä¸¦è¼‰å…¥è³‡æ–™
    async function checkLatestResume() {
      try {
        const res = await fetch("/api/my_resumes");
        
        // å¦‚æœ API è¿”å› 404 æˆ–å…¶ä»–éŒ¯èª¤ï¼Œè¦–ç‚ºæ²’æœ‰å±¥æ­·è¨˜éŒ„
        if (!res.ok) {
          console.log("â„¹ï¸ API è¿”å›éŒ¯èª¤ç‹€æ…‹:", res.status, "è¦–ç‚ºæ²’æœ‰å±¥æ­·è¨˜éŒ„");
          return false;
        }
        
        const result = await res.json();

        if (result.success && result.resumes && result.resumes.length > 0) {
          // ç²å–æœ€æ–°çš„å±¥æ­·ï¼ˆç¬¬ä¸€ç­†ï¼Œå› ç‚ºå·²ç¶“æŒ‰æ™‚é–“å€’åºæ’åˆ—ï¼‰
          const latestResume = result.resumes[0];
          // å¦‚æœæœ‰å±¥æ­·è¨˜éŒ„ï¼Œè¼‰å…¥è³‡æ–™ä¸¦è¨­ç½®è¡¨å–®ç‚ºåªè®€
          if (latestResume) {
            console.log("ğŸ“‹ ç™¼ç¾å·²æäº¤çš„å±¥æ­·ï¼Œè¼‰å…¥è³‡æ–™ä¸¦è¨­ç½®è¡¨å–®ç‚ºåªè®€æ¨¡å¼");

            // è¼‰å…¥å±¥æ­·è³‡æ–™
            await loadResumeData();

            return true;
          }
        }
        return false;
      } catch (error) {
        console.error("âŒ æª¢æŸ¥å±¥æ­·è¨˜éŒ„å¤±æ•—:", error);
        // API èª¿ç”¨å¤±æ•—æ™‚ï¼Œè¦–ç‚ºæ²’æœ‰å±¥æ­·è¨˜éŒ„ï¼Œå…è¨±ç”¨æˆ¶ç·¨è¼¯
        return false;
      }
    }

    // ğŸ§© è¼‰å…¥å·²æäº¤å±¥æ­·çš„å®Œæ•´è³‡æ–™ä¸¦å¡«å……è¡¨å–®ï¼ˆè‹¥æœ‰ URL resume_id å‰‡è¼‰å…¥è©²ç­†å±¥æ­·çš„é—œè¯å…§å®¹ï¼‰
    async function loadResumeData() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const resumeId = urlParams.get('resume_id');
        const apiUrl = resumeId ? `/api/get_resume_data?resume_id=${encodeURIComponent(resumeId)}` : '/api/get_resume_data';
        console.log("ğŸ”„ é–‹å§‹è¼‰å…¥å±¥æ­·è³‡æ–™...", resumeId ? `resume_id=${resumeId}` : 'æœ€æ–°ä¸€ç­†');
        const res = await fetch(apiUrl);
        const result = await res.json();

        if (!result.success || !result.data) {
          console.warn("âš ï¸ ç„¡æ³•è¼‰å…¥å±¥æ­·è³‡æ–™:", result.message);
          return;
        }

        const data = result.data;
        console.log("ğŸ“¥ æ”¶åˆ°å±¥æ­·è³‡æ–™:", data);

        const form = document.getElementById("resumeForm");
        if (!form) {
          console.warn("âš ï¸ æ‰¾ä¸åˆ°è¡¨å–®å…ƒç´ ");
          return;
        }

        // æš«æ™‚ç¦ç”¨è‡ªå‹•ä¿å­˜ï¼Œé¿å…åœ¨è¼‰å…¥è³‡æ–™æ™‚è§¸ç™¼ä¿å­˜
        disableAutoSave = true;

        // 1. å¡«å……åŸºæœ¬è³‡æ–™
        const studentInfo = data.student_info || {};
        console.log("ğŸ“‹ æº–å‚™å¡«å……åŸºæœ¬è³‡æ–™:", studentInfo);

        const nameInput = form.querySelector('input[name="name"]');
        if (nameInput) {
          nameInput.value = studentInfo.name || '';
          console.log('âœ… å§“å:', studentInfo.name || '(ç©º)');
        }

        const birthDateInput = form.querySelector('input[name="birth_date"]');
        if (birthDateInput) {
          const formattedDate = formatDateForInput(studentInfo.birth_date);
          birthDateInput.value = formattedDate;
          console.log('âœ… å‡ºç”Ÿæ—¥æœŸ:', studentInfo.birth_date, 'â†’', formattedDate);
        }

        const genderSelect = form.querySelector('select[name="gender"]');
        if (genderSelect) {
          genderSelect.value = studentInfo.gender || '';
          console.log('âœ… æ€§åˆ¥:', studentInfo.gender || '(ç©º)');
        }

        const phoneInput = form.querySelector('input[name="phone"]');
        if (phoneInput) {
          phoneInput.value = studentInfo.phone || '';
          console.log('âœ… é›»è©±:', studentInfo.phone || '(ç©º)');
        }

        const emailInput = form.querySelector('input[name="email"]');
        if (emailInput) {
          emailInput.value = studentInfo.email || '';
          console.log('âœ… é›»å­éƒµä»¶:', studentInfo.email || '(ç©º)');
        }

        const addressInput = form.querySelector('input[name="address"]');
        if (addressInput) {
          addressInput.value = studentInfo.address || '';
          console.log('âœ… åœ°å€:', studentInfo.address || '(ç©º)');
        }

        // è™•ç†æ“è¡Œæˆç¸¾
        const conductScore = studentInfo.conduct_score || '';
        const conductScoreNumericInput = form.querySelector('input[name="conduct_score_numeric"]');
        const conductScoreHidden = document.getElementById("conduct_score");

        if (conductScoreNumericInput && conductScore) {
          // å°‡ç­‰ç´šè½‰æ›ç‚ºåˆ†æ•¸ï¼ˆå„ª=95, ç”²=85, ä¹™=75, ä¸™=65, ä¸=55ï¼‰
          const scoreMap = { "å„ª": 95, "ç”²": 85, "ä¹™": 75, "ä¸™": 65, "ä¸": 55 };
          const numericScore = scoreMap[conductScore] || parseInt(conductScore) || 0;
          conductScoreNumericInput.value = numericScore;
          if (conductScoreHidden) conductScoreHidden.value = conductScore;
          // è§¸ç™¼ input äº‹ä»¶ä»¥æ›´æ–°éš±è—æ¬„ä½
          conductScoreNumericInput.dispatchEvent(new Event('input'));
        }

        const autobiographyTextarea = form.querySelector('textarea[name="autobiography"]');
        if (autobiographyTextarea) autobiographyTextarea.value = studentInfo.autobiography || '';

        // 1.5 å¡«å……ç…§ç‰‡è·¯å¾‘ï¼ˆé¡¯ç¤ºæç¤ºï¼Œå› ç‚ºæ–‡ä»¶ä¸Šå‚³æ¬„ä½ç„¡æ³•ç›´æ¥è¨­ç½®å€¼ï¼‰
        if (studentInfo.photo_path) {
          console.log("ğŸ“· ç…§ç‰‡è·¯å¾‘:", studentInfo.photo_path);
          const photoInput = form.querySelector('input[name="photo"]');
          if (photoInput && photoInput.parentElement) {
            // ç§»é™¤èˆŠçš„æç¤ºï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const oldHint = photoInput.parentElement.querySelector('.photo-hint');
            if (oldHint) oldHint.remove();

            // ä¿å­˜åœ–ç‰‡è·¯å¾‘åˆ° data å±¬æ€§ï¼Œç”¨æ–¼ç€è¦½å’Œä¸‹è¼‰
            photoInput.setAttribute('data-image-path', studentInfo.photo_path);
            photoInput.removeAttribute('required');
            updateImagePreviewBox('photoPreviewBox', imagePathToUrl(studentInfo.photo_path));
          }
        }

        // 2. å¡«å……èª²ç¨‹è³‡æ–™
        if (data.courses && Array.isArray(data.courses) && data.courses.length > 0) {
          // å°‡èª²ç¨‹è³‡æ–™è½‰æ›ç‚º allCoursesData æ ¼å¼
          allCoursesData = data.courses.map(course => ({
            name: course.name || '',
            credits: course.credits || '0',
            grade: course.grade || '',
            isNotTaken: course.isNotTaken || false  // ä½¿ç”¨å¾Œç«¯è¿”å›çš„ isNotTaken ç‹€æ…‹
          }));

          // æ’åº
          allCoursesData.sort((a, b) => a.name.localeCompare(b.name, 'zh-TW', {
            sensitivity: 'base'
          }));

          // æ¸²æŸ“èª²ç¨‹è¡¨æ ¼ï¼ˆä½¿ç”¨åˆ†é ï¼‰
          filteredCoursesCache = [...allCoursesData];
          currentPage = 1;
          console.log(`ğŸ“‹ å¾è³‡æ–™åº«è¼‰å…¥ ${allCoursesData.length} é–€èª²ç¨‹ï¼Œæº–å‚™åˆ†é é¡¯ç¤º`);
          renderPagedCourses();
          renderPagination();

          // æ¨™è¨˜å·²å¾è³‡æ–™åº«è¼‰å…¥è³‡æ–™ï¼ˆåªæœ‰åœ¨æˆåŠŸè¼‰å…¥èª²ç¨‹å¾Œæ‰æ¨™è¨˜ï¼‰
          resumeDataLoaded = true;
        } else {
          // å¦‚æœæ²’æœ‰èª²ç¨‹è³‡æ–™ï¼Œä¸è‡ªå‹•è¼‰å…¥ï¼Œç­‰å¾…å­¸ç”Ÿä¸Šå‚³Excel
          console.log("âš ï¸ å±¥æ­·è³‡æ–™ä¸­æ²’æœ‰èª²ç¨‹è³‡æ–™ï¼Œè«‹ä¸Šå‚³Excelæ–‡ä»¶");
          // é¡¯ç¤ºæç¤ºä¿¡æ¯
          const tbody = document.getElementById("courseTableBody");
          if (tbody) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-muted text-center">è«‹å…ˆä¸‹è¼‰Excelç¯„æœ¬ï¼Œå¡«å¯«å®Œæˆå¾Œä¸Šå‚³ä»¥é¡¯ç¤ºèª²ç¨‹è³‡æ–™</td></tr>';
          }
        }


        // æ³¨æ„ï¼šrenderPagedCourses å’Œ renderPagination å‡½æ•¸å·²ç§»åˆ°å…¨å±€ä½œç”¨åŸŸ

        // 3. å¡«å……è­‰ç…§è³‡æ–™
        if (data.certifications && Array.isArray(data.certifications)) {
          console.log(`ğŸ” å¾Œç«¯è¿”å›çš„è­‰ç…§è³‡æ–™: ${data.certifications.length} ç­†`, data.certifications);

          if (data.certifications.length > 0) {
            const certData = data.certifications.map(cert => {
              // ç¢ºå®š authority_idï¼šå¦‚æœæœ‰å€¼å‰‡ä½¿ç”¨ï¼Œå¦‚æœç‚º NULL ä½† authority_name æœ‰å€¼å‰‡ç‚º 'OTHER'
              let authorityId = '';
              if (cert.authority_id !== null && cert.authority_id !== undefined && cert.authority_id !== '' && cert.authority_id !== 'null') {
                authorityId = String(cert.authority_id);
              } else if (cert.authority_name && cert.authority_name.trim()) {
                authorityId = 'OTHER';
              }

              // å–å¾—æ—¥æœŸï¼šå„ªå…ˆä½¿ç”¨ acquire_dateï¼ˆå¾Œç«¯å·²æ ¼å¼åŒ–ï¼‰ï¼Œå¦å‰‡ä½¿ç”¨ AcquisitionDate
              const acquireDate = cert.acquire_date || cert.AcquisitionDate || '';
              const formattedAcqDate = acquireDate ? formatDateForInput(acquireDate) : '';

              console.log(`ğŸ” è™•ç†è­‰ç…§: authority_id=${cert.authority_id}, authority_name=${cert.authority_name}, job_category=${cert.job_category || '(ç©º)'}, level=${cert.level || '(ç©º)'}, acquire_date=${acquireDate}, formatted=${formattedAcqDate}`);

              // ç²å–è­‰ç…§åœ–ç‰‡è·¯å¾‘ï¼šæª¢æŸ¥å¤šå€‹å¯èƒ½çš„å­—æ®µå
              let certImagePath = cert.cert_path || cert.CertPath || cert.certPath || '';

              // å°‡ Windows è·¯å¾‘æ ¼å¼ï¼ˆåæ–œæ ï¼‰è½‰æ›ç‚º Web è·¯å¾‘æ ¼å¼ï¼ˆæ­£æ–œæ ï¼‰
              if (certImagePath) {
                certImagePath = certImagePath.replace(/\\/g, '/');
              }

              console.log(`ğŸ” è­‰ç…§è³‡æ–™æ˜ å°„: id=${cert.id || '(ç©º)'}, cert_path=${cert.cert_path || '(ç©º)'}, CertPath=${cert.CertPath || '(ç©º)'}, æœ€çµ‚è·¯å¾‘=${certImagePath || '(ç©º)'}`);

              return {
                id: cert.id || null,
                authority_id: authorityId,
                authority_name: cert.authority_name || '',
                code: cert.cert_code || cert.code || '',
                name: cert.CertName || cert.name || '',
                custom_cert_name: cert.custom_cert_name || '',
                job_category: cert.job_category || '',
                level: cert.level || '',
                acquire_date: formattedAcqDate,
                issuer: cert.issuer || '',  // ç™¼è­‰äººï¼ˆé¸å¡«ï¼‰
                cert_path: certImagePath
              };
            });
            console.log(`ğŸ“‹ æº–å‚™è¼‰å…¥ ${certData.length} ç­†è­‰ç…§è³‡æ–™åˆ°UI`);
            await initializeCertificatesUI(certData);
            console.log(`âœ… å·²è¼‰å…¥ ${certData.length} ç­†è­‰ç…§è³‡æ–™`);
          } else {
            // æ²’æœ‰è­‰ç…§è³‡æ–™ï¼Œä¸å‰µå»ºç©ºæ¢ç›®
            console.log('ğŸ“‹ æ²’æœ‰è­‰ç…§è³‡æ–™ï¼Œæ¸…ç©ºè­‰ç…§UI');
            await initializeCertificatesUI([]);
          }
        } else {
          // æ²’æœ‰è­‰ç…§è³‡æ–™æ¬„ä½ï¼Œä¸å‰µå»ºç©ºæ¢ç›®
          console.log('ğŸ“‹ æ²’æœ‰è­‰ç…§è³‡æ–™æ¬„ä½ï¼Œæ¸…ç©ºè­‰ç…§UI');
          initializeCertificatesUI([]);
        }

        // 3.5 å¡«å……æˆç¸¾å–®è·¯å¾‘ï¼ˆå¾ course_grades.ProofImage ç²å–ï¼‰
        const transcriptPath = data.transcript_path || '';
        if (transcriptPath) {
          console.log("ğŸ“„ æˆç¸¾å–®è·¯å¾‘:", transcriptPath);
          const transcriptInput = form.querySelector('input[name="transcript_file"]');
          if (transcriptInput && transcriptInput.parentElement) {
            // ç§»é™¤èˆŠçš„æç¤ºï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const oldHint = transcriptInput.parentElement.querySelector('.transcript-hint');
            if (oldHint) oldHint.remove();

            // ä¿å­˜åœ–ç‰‡è·¯å¾‘åˆ° data å±¬æ€§ï¼Œç”¨æ–¼ç€è¦½å’Œä¸‹è¼‰
            transcriptInput.setAttribute('data-image-path', transcriptPath);
            transcriptInput.removeAttribute('required');
            updateImagePreviewBox('transcriptPreviewBox', imagePathToUrl(transcriptPath));
          }
        } else {
          console.log("âš ï¸ æ²’æœ‰æˆç¸¾å–®è·¯å¾‘");
        }

        // 3.5.5 è™•ç†ç¼ºå‹¤è¨˜éŒ„ä½è­‰åœ–è·¯å¾‘ï¼ˆå¦‚æœ API ç›´æ¥è¿”å›äº† absence_proof_pathï¼‰
        if (data.absence_proof_path && !data.absence_data) {
          console.log("ğŸ“· ç¼ºå‹¤è¨˜éŒ„ä½è­‰åœ–è·¯å¾‘ï¼ˆå¾ APIï¼‰:", data.absence_proof_path);
          const proofImageInput = document.getElementById('proof_image');
          if (proofImageInput) {
            proofImageInput.setAttribute('data-image-path', data.absence_proof_path);
            proofImageInput.removeAttribute('required');
            updateImagePreviewBox('proofImagePreviewBox', imagePathToUrl(data.absence_proof_path));
            const oldHint = proofImageInput.parentElement.querySelector('.proof-image-hint');
            if (oldHint) oldHint.remove();
          }
        }

        // 3.6 å¡«å……ç¼ºå‹¤è¨˜éŒ„ç›¸é—œè³‡æ–™
        // æ³¨æ„ï¼šéœ€è¦ç­‰å¾…å­¸æœŸåˆ—è¡¨è¼‰å…¥å®Œæˆå¾Œæ‰èƒ½è¨­ç½®å­¸æœŸç¯„åœ
        if (data.absence_data) {
          const absenceData = data.absence_data;

          // ç«‹å³å¯«å…¥ allAbsenceRecordsï¼Œç¢ºä¿æäº¤æ™‚ selected_absence_record_ids æœ‰å€¼ï¼ˆä¸ä¾è³´ setAbsenceData å»¶é²ï¼‰
          if (absenceData.records && Array.isArray(absenceData.records)) {
            allAbsenceRecords = absenceData.records.map(record => ({
              absence_date: record.absence_date || '',
              absence_type: record.absence_type || '',
              duration_units: record.duration_units || 0,
              reason: record.reason || '',
              id: record.id || null,
              image_path: record.image_path || ''
            }));
          }

          // è¨­ç½®å­¸æœŸç¯„åœï¼ˆéœ€è¦ç­‰å¾…å­¸æœŸåˆ—è¡¨è¼‰å…¥ï¼‰
          const setAbsenceData = () => {
            if (absenceData.start_semester_id && absenceData.end_semester_id) {
              const startSemesterSelect = document.getElementById('startSemester');
              const endSemesterSelect = document.getElementById('endSemester');

              // å¦‚æœå­¸æœŸé¸æ“‡å™¨å·²ç¶“è¼‰å…¥ï¼Œç›´æ¥è¨­ç½®
              if (startSemesterSelect && startSemesterSelect.options.length > 1) {
                startSemesterSelect.value = absenceData.start_semester_id;
              }
              if (endSemesterSelect && endSemesterSelect.options.length > 1) {
                endSemesterSelect.value = absenceData.end_semester_id;
              }

              console.log(`ğŸ“… å­¸æœŸç¯„åœ: ${absenceData.start_semester_id} - ${absenceData.end_semester_id}`);

              // è¼‰å…¥ç¼ºå‹¤è¨˜éŒ„åˆ—è¡¨å’Œçµ±è¨ˆï¼ˆallAbsenceRecords å·²åœ¨ä¸Šæ–¹å…ˆè¨­å¥½ï¼Œæ­¤è™•åªåšæ¸²æŸ“èˆ‡ä½è­‰åœ–ï¼‰
              if (absenceData.records && Array.isArray(absenceData.records)) {
                // è™•ç†ç¼ºå‹¤è¨˜éŒ„ä½è­‰åœ–è·¯å¾‘ï¼ˆå„ªå…ˆä½¿ç”¨ API è¿”å›çš„ absence_proof_pathï¼Œå¦å‰‡ä½¿ç”¨è¨˜éŒ„ä¸­çš„ image_pathï¼‰
                let absenceProofPath = data.absence_proof_path || '';
                if (!absenceProofPath) {
                  // å¦‚æœ API æ²’æœ‰è¿”å›ï¼Œå˜—è©¦å¾è¨˜éŒ„ä¸­ç²å–æœ€æ–°çš„
                  const latestRecordWithImage = absenceData.records.find(r => r.image_path);
                  if (latestRecordWithImage && latestRecordWithImage.image_path) {
                    absenceProofPath = latestRecordWithImage.image_path;
                  }
                }

                if (absenceProofPath) {
                  const proofImageInput = document.getElementById('proof_image');
                  if (proofImageInput) {
                    proofImageInput.setAttribute('data-image-path', absenceProofPath);
                    proofImageInput.removeAttribute('required');
                    updateImagePreviewBox('proofImagePreviewBox', imagePathToUrl(absenceProofPath));
                    const oldHint = proofImageInput.parentElement.querySelector('.proof-image-hint');
                    if (oldHint) oldHint.remove();
                  }
                } else {
                  console.log("âš ï¸ æ²’æœ‰ç¼ºå‹¤è¨˜éŒ„ä½è­‰åœ–è·¯å¾‘");
                }

                // æ¸²æŸ“ç¼ºå‹¤è¨˜éŒ„åˆ—è¡¨
                renderAbsenceList(allAbsenceRecords);

                // æ›´æ–°çµ±è¨ˆ
                updateAbsenceStats(allAbsenceRecords);

                console.log(`âœ… å·²è¼‰å…¥ ${allAbsenceRecords.length} ç­†ç¼ºå‹¤è¨˜éŒ„`);
              }

              // æ›´æ–°çµ±è¨ˆï¼ˆå¦‚æœå¾Œç«¯æœ‰æä¾›ï¼‰
              if (absenceData.stats) {
                const orderedKeys = ["æ› èª²", "é²åˆ°", "äº‹å‡", "ç—…å‡", "ç”Ÿç†å‡", "å…¬å‡", "å–ªå‡"];
                orderedKeys.forEach(key => {
                  const statElement = document.getElementById(`stat_${key}`);
                  if (statElement && absenceData.stats[key] !== undefined) {
                    statElement.textContent = absenceData.stats[key];
                    absenceStats[key] = absenceData.stats[key];
                  }
                });
              }
            }
          };

          // å¦‚æœå­¸æœŸåˆ—è¡¨é‚„æ²’è¼‰å…¥ï¼Œç­‰å¾…ä¸€ä¸‹
          const startSemesterSelect = document.getElementById('startSemester');
          if (startSemesterSelect && startSemesterSelect.options.length > 1) {
            setAbsenceData();
          } else {
            // ç­‰å¾…å­¸æœŸåˆ—è¡¨è¼‰å…¥å®Œæˆ
            setTimeout(setAbsenceData, 500);
          }

          // æ¨™è¨˜å·²å¾ loadResumeData ä¸­åŠ è¼‰äº†ç¼ºå‹¤è¨˜éŒ„
          window.absenceDataLoadedFromResume = true;
        } else {
          // æ²’æœ‰ absence_dataï¼Œæ¨™è¨˜ç‚ºæœªå¾å±¥æ­·åŠ è¼‰
          window.absenceDataLoadedFromResume = false;
        }

        // 4. å¡«å……èªè¨€èƒ½åŠ›
        if (data.languages && Array.isArray(data.languages) && data.languages.length > 0) {
          data.languages.forEach(lang => {
            const langName = lang.language || '';
            const langLevel = lang.level || '';

            // æ ¹æ“šèªè¨€åç¨±æ‰¾åˆ°å°æ‡‰çš„é¸æ“‡æ¡†
            let selectElement = null;
            if (langName.includes('è‹±èª') || langName.includes('English') || langName === 'en') {
              selectElement = form.querySelector('select[name="lang_en_level"]');
            } else if (langName.includes('æ—¥èª') || langName.includes('Japanese') || langName === 'ja') {
              selectElement = form.querySelector('select[name="lang_jp_level"]');
            } else if (langName.includes('å°èª') || langName.includes('Taiwanese') || langName === 'tw') {
              selectElement = form.querySelector('select[name="lang_tw_level"]');
            } else if (langName.includes('å®¢èª') || langName.includes('Hakka') || langName === 'hk') {
              selectElement = form.querySelector('select[name="lang_hk_level"]');
            } else if (langName.includes('éŸ“èª') || langName.includes('Korean') || langName === 'ko') {
              selectElement = form.querySelector('select[name="lang_ko_level"]');
            } else if (langName.includes('å…¶ä»–') || langName.includes('Other')) {
              selectElement = form.querySelector('select[name="lang_other_level"]');
            }

            if (selectElement) {
              selectElement.value = langLevel;
              if (lang.id) selectElement.setAttribute('data-language-id', String(lang.id));
            }
          });
        }
        
        // 4.5. å¦‚æœèªè¨€èƒ½åŠ›æ²’æœ‰é¸æ“‡ï¼Œé è¨­ç‚ºã€Œç•¥æ‡‚ã€ï¼ˆåƒ…åœ¨ç”Ÿæˆæ–‡ä»¶æ™‚ä½¿ç”¨ï¼Œä¸å½±éŸ¿è¡¨å–®é¡¯ç¤ºï¼‰
        // é€™å€‹é‚è¼¯åœ¨å¾Œç«¯ç”Ÿæˆæ–‡ä»¶æ™‚è™•ç†

        // æ¨™è¨˜å·²å¾è³‡æ–™åº«è¼‰å…¥è³‡æ–™ï¼ˆåªæœ‰åœ¨æˆåŠŸè¼‰å…¥èª²ç¨‹å¾Œæ‰æ¨™è¨˜ï¼Œé˜²æ­¢è¢«è¦†è“‹ï¼‰
        // æ³¨æ„ï¼šå¦‚æœèª²ç¨‹è³‡æ–™ç‚ºç©ºï¼Œæœƒåœ¨èª²ç¨‹è³‡æ–™è™•ç†éƒ¨åˆ†è¼‰å…¥æ¨™æº–èª²ç¨‹å¾Œå†æ¨™è¨˜
        // é€™è£¡ä¸éœ€è¦å†æ¬¡è¨­ç½® resumeDataLoadedï¼Œå› ç‚ºå·²ç¶“åœ¨èª²ç¨‹è³‡æ–™è™•ç†éƒ¨åˆ†è¨­ç½®äº†

        // é©—è­‰è³‡æ–™æ˜¯å¦æ­£ç¢ºå¡«å……ï¼ˆå»¶é²æª¢æŸ¥ï¼Œç¢ºä¿ DOM å·²æ›´æ–°ï¼‰
        setTimeout(() => {
          const form = document.getElementById("resumeForm");
          if (form) {
            const nameValue = form.querySelector('input[name="name"]')?.value || '';
            const birthValue = form.querySelector('input[name="birth_date"]')?.value || '';
            const phoneValue = form.querySelector('input[name="phone"]')?.value || '';
            const emailValue = form.querySelector('input[name="email"]')?.value || '';
            console.log("ğŸ” é©—è­‰è¡¨å–®è³‡æ–™å¡«å……ï¼ˆè¼‰å…¥å¾Œï¼‰:", {
              "å§“å": nameValue || "(ç©º)",
              "å‡ºç”Ÿæ—¥æœŸ": birthValue || "(ç©º)",
              "é›»è©±": phoneValue || "(ç©º)",
              "é›»å­éƒµä»¶": emailValue || "(ç©º)",
            });

            // å¦‚æœè³‡æ–™ç‚ºç©ºï¼Œç™¼å‡ºè­¦å‘Š
            if (!nameValue && !birthValue && !phoneValue && !emailValue) {
              console.warn("âš ï¸ è­¦å‘Šï¼šè¡¨å–®è³‡æ–™ä¼¼ä¹ç‚ºç©ºï¼Œå¯èƒ½æ˜¯è¼‰å…¥å¤±æ•—æˆ–è¢«æ¸…ç©º");
            }

          }
        }, 500); // å¢åŠ å»¶é²æ™‚é–“ï¼Œç¢ºä¿æ‰€æœ‰æ•¸æ“šéƒ½å·²è¼‰å…¥

        // æ¢å¾©è‡ªå‹•ä¿å­˜
        disableAutoSave = false;

        // è¼‰å…¥å±¥æ­·æ•¸æ“šå¾Œï¼Œå˜—è©¦æ¢å¾©ç¼ºå‹¤è¡¨å–®çš„è‡¨æ™‚è¼¸å…¥æ•¸æ“šï¼ˆå¾LocalStorageï¼‰
        // é€™å¯ä»¥ä¿ç•™ç”¨æˆ¶æ­£åœ¨è¼¸å…¥ä½†å°šæœªæäº¤çš„ç¼ºå‹¤è¨˜éŒ„
        setTimeout(() => {
          loadAbsenceFormData();
        }, 300);

        console.log("âœ… å±¥æ­·è³‡æ–™å·²æˆåŠŸè¼‰å…¥ä¸¦å¡«å……åˆ°è¡¨å–®");
        console.log("ğŸ“Š è¼‰å…¥çš„è³‡æ–™æ‘˜è¦:", {
          "åŸºæœ¬è³‡æ–™": data.student_info ? "æœ‰" : "ç„¡",
          "èª²ç¨‹æ•¸": data.courses ? data.courses.length : 0,
          "è­‰ç…§æ•¸": data.certifications ? data.certifications.length : 0,
          "èªè¨€èƒ½åŠ›æ•¸": data.languages ? data.languages.length : 0,
          "ç¼ºå‹¤è¨˜éŒ„æ•¸": data.absence_data && data.absence_data.records ? data.absence_data.records.length : 0
        });
      } catch (error) {
        console.error("âŒ è¼‰å…¥å±¥æ­·è³‡æ–™å¤±æ•—:", error);
        // ç¢ºä¿åœ¨éŒ¯èª¤æ™‚ä¹Ÿæ¢å¾©è‡ªå‹•ä¿å­˜
        disableAutoSave = false;
      }
    }

    // ğŸ§© è¼‰å…¥å±¥æ­·ç´€éŒ„
    async function loadResumeRecords() {
      const res = await fetch("/api/my_resumes");
      const result = await res.json();
      const tbody = document.getElementById("recordsBody");
      tbody.innerHTML = "";
      if (!result.success || !result.resumes?.length)
        return tbody.innerHTML = `<tr><td colspan="4" class="text-muted">å°šç„¡å±¥æ­·ç´€éŒ„</td></tr>`;

      result.resumes.forEach(r => {
        // ç‹€æ…‹é¡¯ç¤ºé‚è¼¯ï¼ˆå°æ‡‰è³‡æ–™åº« enum: 'uploaded', 'approved', 'rejected'ï¼‰
        let statusHtml = '';
        const status = r.status || '';
        if (status === 'uploaded') {
          statusHtml = '<span class="text-info">å·²ä¸Šå‚³</span>';
        } else if (status === 'approved') {
          statusHtml = '<span class="text-success">å¯©æ ¸é€šé</span>';
        } else if (status === 'rejected') {
          statusHtml = '<span class="text-danger">é€€ä»¶</span>';
        } else if (status === 'submitted') {
          // å‘å¾Œå…¼å®¹èˆŠç‹€æ…‹
          statusHtml = '<span class="text-secondary">å·²æäº¤</span>';
        } else if (status === 'under_review') {
          // å‘å¾Œå…¼å®¹èˆŠç‹€æ…‹
          statusHtml = '<span class="text-warning">å¯©æ ¸ä¸­</span>';
        } else if (status === 'pending') {
          // å‘å¾Œå…¼å®¹èˆŠç‹€æ…‹
          statusHtml = '<span class="text-warning">å¾…å¯©æ ¸</span>';
        } else {
          // å¦‚æœç‹€æ…‹ç‚ºç©ºæˆ–æœªçŸ¥ï¼Œé¡¯ç¤ºé è¨­å€¼
          statusHtml = '<span class="text-muted">æœªè¨­å®š</span>';
        }

        tbody.insertAdjacentHTML("beforeend", `
                    <tr>
                      <td>${r.upload_time || "-"}</td>
                      <td>${r.original_filename || "æœªå‘½å"}</td>
                      <td>${statusHtml}</td>
                      <td><a href="/api/download_resume/${r.id}" class="btn btn-outline-primary btn-sm">ä¸‹è¼‰</a></td>
                    </tr>
                    `);
      });
    }

    // =========================================================================
    // ã€ç¼ºå‹¤ç´€éŒ„ã€‘ç›¸é—œé‚è¼¯
    // =========================================================================

    // ğŸ§© è¼”åŠ©å‡½å¼ï¼šä¿å­˜ç¼ºå‹¤è¨˜éŒ„è¡¨å–®è³‡æ–™åˆ° LocalStorage
    function saveAbsenceFormData() {
      const container = document.getElementById('absenceRecordContainer');
      if (!container) return;

      const absenceData = {
        absence_date: container.querySelector('#absence_date')?.value || '',
        absence_type: container.querySelector('#absence_type')?.value || 'æ› èª²',
        duration_units: container.querySelector('#duration_units')?.value || '',
        reason: container.querySelector('#reason')?.value || ''
      };

      // ä¿å­˜åˆ° LocalStorageï¼ˆèˆ‡å…¶ä»–è¡¨å–®è³‡æ–™ä¸€èµ·ï¼‰
      const savedDataString = localStorage.getItem(AUTO_SAVE_KEY);
      let data = savedDataString ? JSON.parse(savedDataString) : { fields: {}, courses: [], certificates: [] };

      // å°‡ç¼ºå‹¤è¨˜éŒ„è³‡æ–™æ·»åŠ åˆ° fields ä¸­ï¼ˆä½¿ç”¨ ID ä½œç‚º keyï¼Œå› ç‚ºé€™äº›å­—æ®µå¯èƒ½æ²’æœ‰ name å±¬æ€§ï¼‰
      if (!data.fields) data.fields = {};
      data.fields['absence_date'] = absenceData.absence_date;
      data.fields['absence_type'] = absenceData.absence_type;
      data.fields['duration_units'] = absenceData.duration_units;
      data.fields['reason'] = absenceData.reason;

      localStorage.setItem(AUTO_SAVE_KEY, JSON.stringify(data));
      console.log('ğŸ’¾ ç¼ºå‹¤è¨˜éŒ„è¡¨å–®è³‡æ–™å·²ä¿å­˜åˆ° LocalStorage');
    }

    // ğŸ§© è¼”åŠ©å‡½å¼ï¼šå¾ LocalStorage æ¢å¾©ç¼ºå‹¤è¨˜éŒ„è¡¨å–®è³‡æ–™
    function loadAbsenceFormData() {
      const container = document.getElementById('absenceRecordContainer');
      if (!container) {
        console.log('âš ï¸ æ‰¾ä¸åˆ°ç¼ºå‹¤è¨˜éŒ„å®¹å™¨ï¼Œç¨å¾Œå†è©¦');
        // å¦‚æœå®¹å™¨ä¸å­˜åœ¨ï¼Œç¨å¾Œå†è©¦ï¼ˆå¯èƒ½æ˜¯DOMé‚„æ²’è¼‰å…¥å®Œæˆï¼‰
        setTimeout(loadAbsenceFormData, 200);
        return;
      }

      const savedDataString = localStorage.getItem(AUTO_SAVE_KEY);
      if (!savedDataString) {
        console.log('ğŸ“­ LocalStorage ä¸­æ²’æœ‰ç¼ºå‹¤è¨˜éŒ„è¡¨å–®è³‡æ–™');
        return;
      }

      try {
        const data = JSON.parse(savedDataString);
        if (data.fields) {
          // æ¢å¾©ç¼ºå‹¤è¨˜éŒ„è¡¨å–®æ¬„ä½ï¼ˆä½¿ç”¨ ID æŸ¥æ‰¾ï¼Œå› ç‚ºé€™äº›å­—æ®µå¯èƒ½æ²’æœ‰ name å±¬æ€§ï¼‰
          const absenceDateInput = container.querySelector('#absence_date');
          const absenceTypeInput = container.querySelector('#absence_type');
          const durationUnitsInput = container.querySelector('#duration_units');
          const reasonInput = container.querySelector('#reason');

          // åªæ¢å¾©éç©ºçš„å€¼ï¼Œé¿å…è¦†è“‹ç”¨æˆ¶æ­£åœ¨è¼¸å…¥çš„æ•¸æ“š
          if (absenceDateInput && data.fields['absence_date']) {
            // å¦‚æœè¼¸å…¥æ¡†ç‚ºç©ºï¼Œæ‰æ¢å¾©
            if (!absenceDateInput.value) {
              absenceDateInput.value = data.fields['absence_date'];
            }
          }
          if (absenceTypeInput && data.fields['absence_type']) {
            // å¦‚æœè¼¸å…¥æ¡†ç‚ºç©ºï¼Œæ‰æ¢å¾©
            if (!absenceTypeInput.value) {
              absenceTypeInput.value = data.fields['absence_type'];
            }
          }
          if (durationUnitsInput && data.fields['duration_units']) {
            // å¦‚æœè¼¸å…¥æ¡†ç‚ºç©ºï¼Œæ‰æ¢å¾©
            if (!durationUnitsInput.value) {
              durationUnitsInput.value = data.fields['duration_units'];
            }
          }
          if (reasonInput && data.fields['reason']) {
            // å¦‚æœè¼¸å…¥æ¡†ç‚ºç©ºï¼Œæ‰æ¢å¾©
            if (!reasonInput.value) {
              reasonInput.value = data.fields['reason'];
            }
          }

          console.log('ğŸ“¥ ç¼ºå‹¤è¨˜éŒ„è¡¨å–®è³‡æ–™å·²å¾ LocalStorage æ¢å¾©');
        }
      } catch (error) {
        console.error('âŒ è¼‰å…¥ç¼ºå‹¤è¨˜éŒ„è¡¨å–®è³‡æ–™å¤±æ•—:', error);
      }
    }

    // ğŸ§© è¼”åŠ©å‡½å¼ï¼šæ¸…ç©ºç¼ºå‹¤ç´€éŒ„è¡¨å–®æ¬„ä½ (æ­¤å‡½æ•¸åœ¨æ‚¨çš„è…³æœ¬ä¸­æ²’æœ‰è¢«ä½¿ç”¨ï¼Œä½†ç‚ºäº†å®Œæ•´æ€§ä¿ç•™)
    function clearAbsenceForm() {
      const container = document.getElementById('absenceRecordContainer');
      if (container) {
        container.querySelector('#absence_date').value = '';
        container.querySelector('#absence_type').value = 'æ› èª²';
        container.querySelector('#duration_units').value = '';
        container.querySelector('#reason').value = ''; // åŠ ä¸Šäº‹ç”±
        const proofImageInput = document.getElementById('proof_image');
        if (proofImageInput) {
          proofImageInput.value = '';
        }
      }
    }

    // ğŸ§© è¼‰å…¥ç¼ºå‹¤çµ±è¨ˆè³‡æ–™
    // ğŸ§© è¼‰å…¥å­¸æœŸåˆ—è¡¨
    // å„²å­˜æ‰€æœ‰å­¸æœŸè³‡æ–™ï¼ˆç”¨æ–¼å¡«å……ä¸‹æ‹‰æ¡†å’Œé©—è­‰ï¼‰
    let allSemesters = [];

    async function loadSemesters() {
      const startSemesterSelect = document.getElementById("startSemester");
      const endSemesterSelect = document.getElementById("endSemester");

      if (!startSemesterSelect || !endSemesterSelect) {
        console.error('æ‰¾ä¸åˆ°å­¸æœŸé¸æ“‡å™¨å…ƒç´ ');
        return;
      }

      try {
        // ä½¿ç”¨æ–°çš„APIï¼Œç²å–æ ¹æ“šé è¨­ç¯„åœå’Œå…¥å­¸å¹´åº¦éæ¿¾å¾Œçš„å­¸æœŸåˆ—è¡¨
        const res = await fetch("/api/absence/available_semesters");

        if (!res.ok) {
          throw new Error(`HTTPéŒ¯èª¤: ${res.status} ${res.statusText}`);
        }

        const result = await res.json();
        console.log('å¯ç”¨å­¸æœŸåˆ—è¡¨APIå›æ‡‰:', result);

        startSemesterSelect.innerHTML = '<option value="">è«‹é¸æ“‡é–‹å§‹å­¸æœŸ</option>';
        endSemesterSelect.innerHTML = '<option value="">è«‹é¸æ“‡çµæŸå­¸æœŸ</option>';

        if (result.success && result.semesters) {
          if (result.semesters.length === 0) {
            startSemesterSelect.innerHTML = '<option value="">æš«ç„¡å¯ç”¨å­¸æœŸè³‡æ–™ï¼ˆè«‹ç¢ºèªå·²è¨­å®šé è¨­å­¸æœŸç¯„åœï¼‰</option>';
            endSemesterSelect.innerHTML = '<option value="">æš«ç„¡å¯ç”¨å­¸æœŸè³‡æ–™ï¼ˆè«‹ç¢ºèªå·²è¨­å®šé è¨­å­¸æœŸç¯„åœï¼‰</option>';
            console.warn('å¯ç”¨å­¸æœŸåˆ—è¡¨ç‚ºç©º');
            return;
          }

          // ä¿å­˜å­¸æœŸè³‡æ–™ä¸¦æŒ‰ä»£ç¢¼æ’åº
          allSemesters = result.semesters.sort((a, b) => {
            // æŒ‰å­¸æœŸä»£ç¢¼æ’åºï¼ˆä¾‹å¦‚ï¼š1122 < 1131ï¼‰
            return a.code.localeCompare(b.code);
          });

          // å¡«å……å…©å€‹ä¸‹æ‹‰æ¡†ï¼ˆåªé¡¯ç¤ºéæ¿¾å¾Œçš„å­¸æœŸï¼‰
          allSemesters.forEach(semester => {
            const option1 = document.createElement("option");
            option1.value = semester.id;
            option1.textContent = `${semester.code}${semester.is_active ? ' ' : ''}`;
            startSemesterSelect.appendChild(option1);

            const option2 = document.createElement("option");
            option2.value = semester.id;
            option2.textContent = `${semester.code}${semester.is_active ? ' ' : ''}`;
            endSemesterSelect.appendChild(option2);
          });

          // è¼‰å…¥ä¸¦è¨­ç½®é è¨­å­¸æœŸç¯„åœ
          await loadDefaultSemesterRange();
        } else {
          console.error('å¯ç”¨å­¸æœŸåˆ—è¡¨APIè¿”å›å¤±æ•—:', result.message || 'æœªçŸ¥éŒ¯èª¤');
          startSemesterSelect.innerHTML = `<option value="">è¼‰å…¥å¤±æ•—: ${result.message || 'æœªçŸ¥éŒ¯èª¤'}</option>`;
          endSemesterSelect.innerHTML = `<option value="">è¼‰å…¥å¤±æ•—: ${result.message || 'æœªçŸ¥éŒ¯èª¤'}</option>`;
        }
      } catch (error) {
        console.error('è¼‰å…¥å¯ç”¨å­¸æœŸåˆ—è¡¨å¤±æ•—:', error);
        startSemesterSelect.innerHTML = `<option value="">è¼‰å…¥å¤±æ•—: ${error.message}</option>`;
        endSemesterSelect.innerHTML = `<option value="">è¼‰å…¥å¤±æ•—: ${error.message}</option>`;
      }
    }

    // ğŸ§© è¼‰å…¥é è¨­å­¸æœŸç¯„åœä¸¦è‡ªå‹•è¨­ç½®
    async function loadDefaultSemesterRange() {
      try {
        const res = await fetch('/api/get_absence_default_range');
        const result = await res.json();

        if (result.success && result.defaultStart && result.defaultEnd) {
          const startSemesterSelect = document.getElementById("startSemester");
          const endSemesterSelect = document.getElementById("endSemester");

          if (!startSemesterSelect || !endSemesterSelect) {
            console.warn('æ‰¾ä¸åˆ°å­¸æœŸé¸æ“‡å™¨ï¼Œç„¡æ³•è¨­ç½®é è¨­ç¯„åœ');
            return;
          }

          // æ ¹æ“šå­¸æœŸä»£ç¢¼æ‰¾åˆ°å°æ‡‰çš„å­¸æœŸID
          const startSemester = allSemesters.find(s => s.code === result.defaultStart);
          const endSemester = allSemesters.find(s => s.code === result.defaultEnd);

          if (startSemester && endSemester) {
            startSemesterSelect.value = startSemester.id;
            endSemesterSelect.value = endSemester.id;

            console.log(`âœ… å·²è¨­ç½®é è¨­å­¸æœŸç¯„åœ: ${result.defaultStart} - ${result.defaultEnd}`);

            // è‡ªå‹•è§¸ç™¼æŸ¥è©¢ç¼ºå‹¤è¨˜éŒ„
            await loadSemesterRangeAbsenceRecords(startSemester.id, endSemester.id);
            await loadAbsenceStats();
          } else {
            console.warn(`âš ï¸ æ‰¾ä¸åˆ°é è¨­å­¸æœŸç¯„åœå°æ‡‰çš„å­¸æœŸ: ${result.defaultStart} - ${result.defaultEnd}`);
          }
        }
      } catch (error) {
        console.error('âŒ è¼‰å…¥é è¨­å­¸æœŸç¯„åœå¤±æ•—:', error);
      }
    }

    // ğŸ§© æ›´æ–°ç¼ºå‹¤è¨˜éŒ„åˆ—è¡¨é¡¯ç¤º
    function renderAbsenceList(records) {
      const container = document.getElementById("absenceRecordsDisplay");
      if (!container) return;

      if (!records || records.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">æŸ¥ç„¡ç¼ºå‹¤ç´€éŒ„</p>';
        return;
      }

      let html = '<div class="table-responsive">';
      html += '<table class="table table-sm table-bordered align-middle">';
      html += '<thead class="table-light"><tr><th>æ—¥æœŸ</th><th>é¡å‹</th><th>ç¯€æ•¸</th><th>äº‹ç”±</th></tr></thead>';
      html += '<tbody>';

      records.forEach(record => {
        const date = record.absence_date || '';
        const type = record.absence_type || '';
        const units = record.duration_units || 0;
        const reason = record.reason || '';

        html += `<tr>
          <td>${date}</td>
          <td>${type}</td>
          <td>${units} ç¯€</td>
          <td>${reason}</td>
        </tr>`;
      });

      html += '</tbody></table>';
      html += '</div>';
      container.innerHTML = html;
    }

    // ğŸ§© æ›´æ–°ç¼ºå‹¤çµ±è¨ˆ
    function updateAbsenceStats(records) {
      // é‡ç½®çµ±è¨ˆ
      const stats = {
        "æ› èª²": 0, "é²åˆ°": 0, "äº‹å‡": 0, "ç—…å‡": 0,
        "ç”Ÿç†å‡": 0, "å…¬å‡": 0, "å–ªå‡": 0
      };

      // è¨ˆç®—çµ±è¨ˆ
      if (records && records.length > 0) {
        records.forEach(r => {
          if (stats[r.absence_type] !== undefined) {
            stats[r.absence_type] += Number(r.duration_units) || 0;
          }
        });
      }

      // æ›´æ–°ç•«é¢
      Object.keys(stats).forEach(type => {
        const statElement = document.getElementById(`stat_${type}`);
        if (statElement) {
          statElement.textContent = stats[type];
        }
      });
    }

    // ğŸ§© è¼‰å…¥å­¸æœŸç¯„åœçš„ç¼ºå‹¤è¨˜éŒ„
    async function loadSemesterRangeAbsenceRecords(startSemesterId, endSemesterId) {
      const displayDiv = document.getElementById("absenceRecordsDisplay");
      if (!displayDiv) return;

      displayDiv.innerHTML = '<p class="text-muted text-center">è¼‰å…¥ä¸­...</p>';

      try {
        // æ§‹å»ºæŸ¥è©¢åƒæ•¸
        let url = `/api/get_semester_absence_records`;
        const params = [];

        if (startSemesterId) {
          params.push(`start_semester_id=${startSemesterId}`);
        }
        if (endSemesterId) {
          params.push(`end_semester_id=${endSemesterId}`);
        }

        if (params.length > 0) {
          url += '?' + params.join('&');
        }

        const res = await fetch(url);
        const result = await res.json();

        if (result.success && result.records) {
          const records = result.records;

          // æ ¼å¼åŒ–ä¸¦ä¿å­˜æ‰€æœ‰è¨˜éŒ„åˆ°å…¨åŸŸè®Šæ•¸ï¼ˆç”¨æ–¼å‰ç«¯ç¯©é¸ï¼‰
          allAbsenceRecords = records.map(record => {
            // æ ¼å¼åŒ–æ—¥æœŸç‚º YYYY-MM-DD
            let date = record.absence_date || '';
            if (date) {
              try {
                // å¦‚æœå·²ç¶“æ˜¯ YYYY-MM-DD æ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨
                if (typeof date === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(date)) {
                  // å·²ç¶“æ˜¯æ­£ç¢ºæ ¼å¼ï¼Œä¸éœ€è¦è½‰æ›
                } else if (date instanceof Date) {
                  // å¦‚æœæ˜¯ Date å°è±¡ï¼Œè½‰æ›ç‚º YYYY-MM-DD
                  date = date.toISOString().split('T')[0];
                } else if (typeof date === 'string') {
                  // å˜—è©¦è§£æå„ç¨®æ—¥æœŸæ ¼å¼
                  const dateObj = new Date(date);
                  if (!isNaN(dateObj.getTime())) {
                    // æˆåŠŸè§£æï¼Œè½‰æ›ç‚º YYYY-MM-DD
                    const year = dateObj.getFullYear();
                    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const day = String(dateObj.getDate()).padStart(2, '0');
                    date = `${year}-${month}-${day}`;
                  }
                }
              } catch (e) {
                console.error('æ—¥æœŸæ ¼å¼åŒ–éŒ¯èª¤:', e, 'åŸå§‹æ—¥æœŸ:', date);
                // å¦‚æœè§£æå¤±æ•—ï¼Œå˜—è©¦æå–æ—¥æœŸéƒ¨åˆ†
                if (typeof date === 'string') {
                  const match = date.match(/(\d{4})-(\d{2})-(\d{2})/);
                  if (match) {
                    date = match[0];
                  }
                }
              }
            }

            return {
              absence_date: date,
              absence_type: record.absence_type || '',
              duration_units: record.duration_units || 0,
              reason: record.reason || '',
              id: record.id || null,
              image_path: record.image_path || ''
            };
          });

          // åˆå§‹é¡¯ç¤ºæ‰€æœ‰è¨˜éŒ„
          renderAbsenceList(allAbsenceRecords);
          updateAbsenceStats(allAbsenceRecords);

          // è¼‰å…¥ç¼ºå‹¤çµ±è¨ˆï¼ˆåŸºæ–¼ç¯©é¸çš„å­¸æœŸç¯„åœï¼‰
          await loadAbsenceStats();

          // æª¢æŸ¥ä¸¦è¨­ç½®ç¼ºå‹¤è¨˜éŒ„ä½è­‰åœ–ï¼ˆæ–°å¢å±¥æ­·æ¨¡å¼ä¸å¸¶å…¥èˆŠåœ–ï¼Œä¿æŒæ¸…ç©ºï¼‰
          if (!window.isNewResume) {
            const latestRecordWithImage = records.find(r => r.image_path);
            if (latestRecordWithImage && latestRecordWithImage.image_path) {
              const proofImageInput = document.getElementById('proof_image');
              if (proofImageInput) {
                proofImageInput.setAttribute('data-image-path', latestRecordWithImage.image_path);
                proofImageInput.removeAttribute('required');
                updateImagePreviewBox('proofImagePreviewBox', imagePathToUrl(latestRecordWithImage.image_path));
              }
            }
          }
        } else {
          // æ²’æœ‰è¨˜éŒ„æ™‚ï¼Œæ¸…ç©ºçµ±è¨ˆä¸¦é¡¯ç¤ºæç¤º
          displayDiv.innerHTML = '<p class="text-muted text-center">æŸ¥ç„¡ç¼ºå‹¤ç´€éŒ„</p>';
          // é‡ç½®çµ±è¨ˆç‚º 0
          const orderedKeys = ["æ› èª²", "é²åˆ°", "äº‹å‡", "ç—…å‡", "ç”Ÿç†å‡", "å…¬å‡", "å–ªå‡"];
          orderedKeys.forEach(key => {
            const statElement = document.getElementById(`stat_${key}`);
            if (statElement) {
              statElement.textContent = 0;
            }
          });
        }
      } catch (error) {
        console.error('è¼‰å…¥ç¼ºå‹¤è¨˜éŒ„å¤±æ•—:', error);
        displayDiv.innerHTML = '<p class="text-danger text-center">è¼‰å…¥å¤±æ•—</p>';
      }
    }

    async function loadAbsenceStats() {
      const statsBody = document.getElementById("absenceStatsBody");

      const orderedKeys = ["æ› èª²", "é²åˆ°", "äº‹å‡", "ç—…å‡", "ç”Ÿç†å‡", "å…¬å‡", "å–ªå‡"];

      // é é¢è¼‰å…¥æ™‚çš„åˆå§‹ç‹€æ…‹ (å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œå°±é¡¯ç¤º 0)
      orderedKeys.forEach(key => {
        const statElement = document.getElementById(`stat_${key}`);
        if (statElement) {
          statElement.textContent = absenceStats[key] || 0;
        }
      });

      try {
        // ä½¿ç”¨å­¸æœŸç¯„åœç²å–çµ±è¨ˆï¼ˆå¦‚æœå·²é¸æ“‡ï¼‰
        const startSemesterId = document.getElementById('startSemester')?.value || '';
        const endSemesterId = document.getElementById('endSemester')?.value || '';
        let url = "/api/get_absence_stats";
        if (startSemesterId && endSemesterId) {
          url += `?start_semester_id=${startSemesterId}&end_semester_id=${endSemesterId}`;
        }
        const res = await fetch(url);
        const result = await res.json();

        if (result.success && result.stats) {
          const stats = result.stats;

          // 1. æ›´æ–°å…¨åŸŸè®Šæ•¸ absenceStats
          orderedKeys.forEach(key => {
            // ç²å–å¾Œç«¯çµ±è¨ˆçš„å–®ä½æ•¸ï¼Œå¦‚æœæ²’æœ‰å‰‡ç‚º 0
            const totalUnits = stats[key] || 0;
            absenceStats[key] = totalUnits;
          });

          // 2. æ ¹æ“šæ›´æ–°å¾Œçš„å…¨åŸŸè®Šæ•¸ï¼Œæ›´æ–° HTML é¡¯ç¤º
          orderedKeys.forEach(key => {
            const statElement = document.getElementById(`stat_${key}`);
            if (statElement) {
              statElement.textContent = absenceStats[key];
            }
          });

        } else {
          // å¦‚æœå¾Œç«¯è¿”å›å¤±æ•—ï¼Œæˆ‘å€‘ä¿æŒåŸæœ¬çš„ 0/è¼‰å…¥ä¸­ ç‹€æ…‹ (å¦‚æœ HTML å·²ç¶“è¢«æ­£ç¢ºå®šç¾©)
          // ç‚ºäº†é¿å…æ··äº‚ï¼Œé€™è£¡ä¸ä¿®æ”¹ HTML çµæ§‹ï¼Œåªä¿ç•™åŸæœ¬çš„æ•¸å­— (0)
        }

      } catch (error) {
        console.error('è¼‰å…¥ç¼ºå‹¤çµ±è¨ˆå¤±æ•—:', error);
        // å¦‚æœè¼‰å…¥å¤±æ•—ï¼Œæˆ‘å€‘ä¿æŒæ•¸å­—ç‚º 0 æˆ–åŸæœ¬çš„ absenceStats[key]
      }
    }

    // ğŸ§© è¼‰å…¥è©³ç´°ç¼ºå‹¤ç´€éŒ„åˆ—è¡¨ (åœ¨æ­·å²ç´€éŒ„é ç±¤)
    async function loadAbsenceRecordsList() {
      const listBody = document.getElementById("absenceRecordsListBody");
      if (!listBody) return;  // â­ é¿å…å ±éŒ¯ï¼ŒHTML æ²’æœ‰å°±ä¸æ›´æ–°
      listBody.innerHTML = '<tr><td colspan="5">è¼‰å…¥ä¸­...</td></tr>';

      try {
        const res = await fetch("/api/get_absence_records");
        const result = await res.json();

        listBody.innerHTML = ""; // æ¸…ç©ºè¼‰å…¥ä¸­æç¤º

        if (result.success && result.records?.length) {
          result.records.forEach(r => {
            const unitsText = `${r.duration_units || '0'} ç¯€`;
            // åˆ¤æ–·æ˜¯å¦æœ‰ä½è­‰åœ–ç‰‡
            const imageStatus = r.image_path ?
              '<span class="text-success">æœ‰</span>' :
              '<span class="text-secondary">ç„¡</span>';

            listBody.insertAdjacentHTML("beforeend", `
                                    <tr>
                                        <td>${r.absence_date || '-'}</td>
                                        <td>${r.absence_type || '-'}</td>
                                        <td>${unitsText}</td>
                                        <td>${r.reason || '-'}</td>
                                        <td>${imageStatus}</td>
                                    </tr>
                                `);
          });
        } else {
          listBody.innerHTML = '<tr><td colspan="5" class="text-muted">å°šç„¡è©³ç´°ç¼ºå‹¤ç´€éŒ„</td></tr>';
        }
      } catch (error) {
        console.error('è¼‰å…¥è©³ç´°ç¼ºå‹¤ç´€éŒ„å¤±æ•—:', error);
        listBody.innerHTML = '<tr><td colspan="5" class="text-danger">åˆ—è¡¨è¼‰å…¥å¤±æ•—</td></tr>';
      }
    }
    // ğŸ§© é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {
      // è¼‰å…¥å­¸æœŸåˆ—è¡¨
      loadSemesters();

      // ç¯©é¸æŒ‰éˆ•é»æ“Šäº‹ä»¶ï¼ˆå­¸æœŸç¯„åœç¯©é¸ï¼‰
      const filterBtn = document.getElementById("filterAbsenceBtn");
      if (filterBtn) {
        filterBtn.addEventListener("click", async function (e) {
          e.preventDefault(); // é˜»æ­¢è¡¨å–®æäº¤
          e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡

          // ç²å–å­¸æœŸç¯„åœ
          const startSemesterId = document.getElementById("startSemester")?.value || '';
          const endSemesterId = document.getElementById("endSemester")?.value || '';

          // æª¢æŸ¥æ˜¯å¦é¸æ“‡äº†å­¸æœŸ
          if (!startSemesterId || !endSemesterId) {
            alert('è«‹é¸æ“‡é–‹å§‹å­¸æœŸå’ŒçµæŸå­¸æœŸ');
            return;
          }

          // æª¢æŸ¥å­¸æœŸé †åºï¼ˆé–‹å§‹å­¸æœŸæ‡‰è©²åœ¨çµæŸå­¸æœŸä¹‹å‰ï¼‰
          const startSemester = allSemesters.find(s => s.id == startSemesterId);
          const endSemester = allSemesters.find(s => s.id == endSemesterId);

          if (startSemester && endSemester) {
            if (startSemester.code > endSemester.code) {
              alert('é–‹å§‹å­¸æœŸä¸èƒ½æ™šæ–¼çµæŸå­¸æœŸï¼Œè«‹é‡æ–°é¸æ“‡');
              return;
            }
          }

          // è¼‰å…¥å­¸æœŸç¯„åœçš„ç¼ºå‹¤è¨˜éŒ„ï¼ˆåŒæ™‚æ›´æ–°åˆ—è¡¨å’Œçµ±è¨ˆï¼‰
          await loadSemesterRangeAbsenceRecords(startSemesterId, endSemesterId);

          // è¼‰å…¥ç¼ºå‹¤çµ±è¨ˆï¼ˆåŸºæ–¼ç¯©é¸çš„å­¸æœŸç¯„åœï¼‰
          await loadAbsenceStats();
        });
      }
    });

    // ğŸ§© æ›´æ–°ç¼ºå‹¤çµ±è¨ˆï¼ˆå·²å»¢æ£„ï¼Œç¾åœ¨å¾è³‡æ–™åº«è®€å–ï¼‰
    // æ³¨æ„ï¼šæ­¤æŒ‰éˆ•å·²å¾ HTML ä¸­ç§»é™¤ï¼Œä½†ä¿ç•™æ­¤ä»£ç¢¼ä»¥é˜²å…¶ä»–åœ°æ–¹å¼•ç”¨
    const updateAbsenceStatsBtn = document.getElementById('updateAbsenceStatsBtn');
    if (updateAbsenceStatsBtn) {
      updateAbsenceStatsBtn.addEventListener('click', function (e) {
        e.preventDefault();

        const btn = this;
        const originalText = btn.textContent;

        // é–å®šæŒ‰éˆ•
        btn.disabled = true;
        btn.textContent = "æ›´æ–°ä¸­...";

        const container = document.getElementById('absenceRecordContainer');

        // å–å¾—æ¬„ä½å€¼
        const absence_date = container.querySelector('#absence_date').value;
        const absence_type = container.querySelector('#absence_type').value;
        const duration_units_str = container.querySelector('#duration_units').value;
        const reason = container.querySelector('#reason').value;
        const proof_image_input = document.getElementById('proof_image');

        // é€²è¡Œæ•¸å€¼è½‰æ›å’Œæª”æ¡ˆç²å–
        const duration_units_int = parseInt(duration_units_str);
        const proof_image_file = proof_image_input ? proof_image_input.files[0] : null;
        const image_filename = proof_image_file ? proof_image_file.name : null;


        // 1. é©—è­‰
        if (!absence_date || !absence_type || isNaN(duration_units_int) || duration_units_int <= 0 || !reason) {
          alert("è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼ˆæ—¥æœŸã€é¡å‹ã€ç¯€æ•¸å¿…é ˆç‚ºæ­£æ•´æ•¸ã€äº‹ç”±ï¼‰");
          btn.disabled = false;
          btn.textContent = originalText;
          return;
        }

        // ------------------------------------------------------------------
        // â­ æ ¸å¿ƒé‚è¼¯ï¼šåˆ†é …ç´¯è¨ˆèˆ‡æ›´æ–°è¡¨æ ¼ â­
        // ------------------------------------------------------------------

        // 2. ç¢ºå®šè¦ç´¯åŠ çš„é¡å‹ Key (å¦‚æœä¸åœ¨å®šç¾©ç¯„åœï¼Œå‰‡æ­¸é¡ç‚ºã€Œå…¶ä»–ã€)
        let typeToUpdate = absence_type;
        if (absenceStats[typeToUpdate] === undefined) {
          typeToUpdate = "å…¶ä»–";
        }

        // 3. æª¢æŸ¥çµ±è¨ˆé¡¯ç¤ºå…ƒç´ æ˜¯å¦å­˜åœ¨
        const statElement = document.getElementById(`stat_${typeToUpdate}`);

        if (!statElement) {
          // å¦‚æœ HTML çµæ§‹æ­£ç¢ºï¼Œé€™è£¡ä¸æ‡‰è©²ç™¼ç”Ÿã€‚
          alert(`éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°çµ±è¨ˆé¡¯ç¤ºæ¬„ä½ ID: stat_${typeToUpdate}ã€‚è«‹æª¢æŸ¥ HTML è¡¨æ ¼ï¼`);
          btn.disabled = false;
          btn.textContent = originalText;
          return;
        }

        // 4. æ›´æ–° JS è¨˜æ†¶é«”ä¸­çš„åˆ†é …æ•¸å­—
        absenceStats[typeToUpdate] += duration_units_int;

        // 5. æ›´æ–° HTML é¡¯ç¤º
        statElement.textContent = absenceStats[typeToUpdate];

        // 6. æš«å­˜è©³ç´°ç´€éŒ„åˆ°å…¨åŸŸè®Šæ•¸
        const newRecord = {
          date: absence_date,
          type: absence_type,
          units: duration_units_int,
          reason: reason,
          image_filename: image_filename
        };
        allAbsenceRecords.push(newRecord);

        // 7. å°‡è©³ç´°ç´€éŒ„é™£åˆ—å¯«å…¥éš±è—æ¬„ä½ (ä¾›æœ€çµ‚æäº¤çµ¦å¾Œç«¯)
        const hiddenInput = document.getElementById('all_absence_details_json');
        if (hiddenInput) {
          hiddenInput.value = JSON.stringify(allAbsenceRecords);
        }


        // â­ å¯«å…¥çµ±è¨ˆè³‡æ–™åˆ°éš±è—æ¬„ä½ï¼ˆä¾›æœ€çµ‚æäº¤æ™‚ä½¿ç”¨ï¼‰
        const statsInput = document.getElementById("absence_stats_json");
        if (statsInput) {
          statsInput.value = JSON.stringify(absenceStats);
        }

        // â­ ç«‹å³ä¿å­˜åˆ°è³‡æ–™åº«ï¼ˆé¿å…é‡æ–°è¼‰å…¥æ™‚è³‡æ–™ä¸Ÿå¤±ï¼‰
        const saveToDatabase = async () => {
          try {
            const formData = new FormData();
            formData.append('absence_date', absence_date);
            formData.append('absence_type', absence_type);
            formData.append('duration_units', duration_units_int);
            formData.append('reason', reason);

            // å¦‚æœæœ‰ä½è­‰åœ–ç‰‡ï¼Œæ·»åŠ åˆ° FormData
            if (proof_image_file) {
              formData.append('proof_image', proof_image_file);
            }

            const res = await fetch('/api/submit_absence_record', {
              method: 'POST',
              body: formData
            });

            const result = await res.json();

            if (result.success) {
              console.log('âœ… ç¼ºå‹¤è¨˜éŒ„å·²æˆåŠŸä¿å­˜åˆ°è³‡æ–™åº«');

              // ä¿å­˜ç•¶å‰è¡¨å–®è³‡æ–™åˆ° LocalStorageï¼ˆä¿ç•™ç”¨æˆ¶å¡«å¯«çš„è³‡æ–™ï¼‰
              saveAbsenceFormData();

              // ä¸æ¸…ç©ºè¡¨å–®ï¼Œä¿ç•™ç”¨æˆ¶å¡«å¯«çš„è³‡æ–™ï¼Œæ–¹ä¾¿ç¹¼çºŒæ–°å¢å…¶ä»–ç¼ºå‹¤è¨˜éŒ„
              // clearAbsenceForm(); // å·²ç§»é™¤ï¼Œæ”¹ç‚ºä¿ç•™è³‡æ–™

              // é‡æ–°è¼‰å…¥ç¼ºå‹¤è¨˜éŒ„åˆ—è¡¨å’Œçµ±è¨ˆï¼ˆå¾è³‡æ–™åº«ï¼‰
              await loadAbsenceRecordsList();
              await loadAbsenceStats();

              // å¦‚æœå­¸æœŸé¸æ“‡å™¨æœ‰å€¼ï¼Œé‡æ–°è¼‰å…¥è©²å­¸æœŸç¯„åœçš„ç¼ºå‹¤è¨˜éŒ„
              const startSemesterId = document.getElementById("startSemester")?.value || '';
              const endSemesterId = document.getElementById("endSemester")?.value || '';
              if (startSemesterId && endSemesterId) {
                await loadSemesterRangeAbsenceRecords(startSemesterId, endSemesterId);
              } else {
                // å¦‚æœæ²’æœ‰é¸æ“‡å­¸æœŸï¼Œé‡æ–°è¼‰å…¥æ‰€æœ‰ç¼ºå‹¤è¨˜éŒ„ï¼ˆç”¨æ–¼é¡¯ç¤ºæœ€æ–°ä¿å­˜çš„è¨˜éŒ„ï¼‰
                await loadSemesterRangeAbsenceRecords('', '');
              }

              // é‡æ–°è¼‰å…¥ç¼ºå‹¤è¨˜éŒ„å¾Œï¼Œæª¢æŸ¥ä¸¦è¨­ç½®ç¼ºå‹¤è¨˜éŒ„ä½è­‰åœ–çš„ç€è¦½å’Œä¸‹è¼‰æŒ‰éˆ•
              setTimeout(() => {
                const proofImageInput = document.getElementById('proof_image');
                if (proofImageInput) {
                  // å¾è³‡æ–™åº«é‡æ–°ç²å–æœ€æ–°çš„ç¼ºå‹¤è¨˜éŒ„ä½è­‰åœ–è·¯å¾‘
                  fetch('/api/get_resume_data')
                    .then(res => res.json())
                    .then(result => {
                      if (result.success && result.data.absence_proof_path) {
                        const absenceProofPath = result.data.absence_proof_path;
                        proofImageInput.setAttribute('data-image-path', absenceProofPath);
                        proofImageInput.removeAttribute('required');
                        updateImagePreviewBox('proofImagePreviewBox', imagePathToUrl(absenceProofPath));
                        const isCurrentlyReadonly = proofImageInput.disabled;
                      }
                    })
                    .catch(error => {
                      console.error('âŒ ç²å–ç¼ºå‹¤è¨˜éŒ„ä½è­‰åœ–è·¯å¾‘å¤±æ•—:', error);
                    });
                }
              }, 500);

              // é¡¯ç¤ºæˆåŠŸæç¤º
              const msgBox = document.getElementById('absenceSavedMsg');
              msgBox.textContent = `âœ… ç¼ºå‹¤è¨˜éŒ„å·²æˆåŠŸä¿å­˜ï¼${typeToUpdate} ç´¯è¨ˆç¸½æ•¸ç‚º ${absenceStats[typeToUpdate]} ç¯€ã€‚`;
              msgBox.classList.remove('d-none');
              msgBox.classList.remove('alert-danger');
              msgBox.classList.add('alert-success');

              setTimeout(() => {
                msgBox.classList.add('d-none');
              }, 3000);
            } else {
              console.error('âŒ ä¿å­˜ç¼ºå‹¤è¨˜éŒ„å¤±æ•—:', result.message);
              alert(`ä¿å­˜å¤±æ•—ï¼š${result.message || 'æœªçŸ¥éŒ¯èª¤'}`);
            }
          } catch (error) {
            console.error('âŒ ä¿å­˜ç¼ºå‹¤è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            alert('ä¿å­˜å¤±æ•—ï¼šç¶²è·¯æˆ–ä¼ºæœå™¨éŒ¯èª¤');
          } finally {
            // é‚„åŸæŒ‰éˆ•
            btn.disabled = false;
            btn.textContent = originalText;
          }
        };

        // åŸ·è¡Œä¿å­˜
        saveToDatabase();
      });
    }


    // =========================================================================
    // æª¢æŸ¥ä½œæ¥­æˆªæ­¢æ™‚é–“
    // =========================================================================
    async function checkDeadlineAndDisableForm() {
      try {
        const res = await fetch("/announcement/api/check_deadline?type=resume");
        const result = await res.json();

        if (result.success && result.has_deadline && result.is_expired) {
          // æˆªæ­¢æ™‚é–“å·²éï¼Œç¦ç”¨è¡¨å–®
          const form = document.getElementById("resumeForm");
          if (form) {
            // ç¦ç”¨æ‰€æœ‰è¼¸å…¥æ¬„ä½å’ŒæŒ‰éˆ•
            form.querySelectorAll('input, select, textarea, button').forEach(element => {
              element.disabled = true;
            });

            // ç¦ç”¨æäº¤æŒ‰éˆ•
            const submitBtn = document.getElementById("submitResumeBtn");
            if (submitBtn) {
              submitBtn.disabled = true;
              submitBtn.textContent = 'å·²è¶…éæˆªæ­¢æ™‚é–“';
            }

            // ç¦ç”¨ä¿®æ”¹æŒ‰éˆ•
            const editBtn = document.getElementById("editResumeBtn");
            if (editBtn) {
              editBtn.disabled = true;
            }
            
            // ç¦ç”¨æ‰€æœ‰å‹•æ…‹ç”Ÿæˆçš„æŒ‰éˆ•ï¼ˆå¦‚è­‰ç…§ç›¸é—œæŒ‰éˆ•ï¼‰
            document.querySelectorAll('.btn, button').forEach(btn => {
              if (!btn.closest('.alert')) { // ä¿ç•™ alert ä¸­çš„é—œé–‰æŒ‰éˆ•
                btn.disabled = true;
              }
            });
            
            // é¡¯ç¤ºæç¤ºè¨Šæ¯
            const container = document.querySelector(".container");
            if (container) {
              const alertDiv = document.createElement("div");
              alertDiv.className = "alert alert-danger alert-dismissible fade show";
              alertDiv.setAttribute("role", "alert");
              alertDiv.innerHTML = `
                <strong>âš ï¸ å·²è¶…éæˆªæ­¢æ™‚é–“</strong><br>
                ä¸Šå‚³å±¥æ­·çš„æˆªæ­¢æ™‚é–“ç‚ºï¼š${result.deadline}<br>
                ç›®å‰ç„¡æ³•å†ä¿®æ”¹æˆ–æäº¤å±¥æ­·ã€‚
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              `;
              container.insertBefore(alertDiv, container.firstChild);
            }

            // è¨­ç½®å…¨å±€æ¨™è¨˜ï¼Œé˜²æ­¢å¾ŒçºŒæ“ä½œ
            window.deadlineExpired = true;
            isEditing = false; // å¼·åˆ¶è¨­ç‚ºéç·¨è¼¯æ¨¡å¼
          }
        }
      } catch (error) {
        console.error("æª¢æŸ¥æˆªæ­¢æ™‚é–“å¤±æ•—:", error);
      }
    }

    // =========================================================================
    // äº‹ä»¶ç¶å®šå’Œåˆå§‹åŒ–
    // =========================================================================
    document.addEventListener("DOMContentLoaded", async () => {
      // é¦–å…ˆæª¢æŸ¥æˆªæ­¢æ™‚é–“
      await checkDeadlineAndDisableForm();

      // å¦‚æœå·²éæœŸï¼Œç›´æ¥è¿”å›ï¼Œä¸é€²è¡Œå¾ŒçºŒåˆå§‹åŒ–
      if (window.deadlineExpired) {
        return;
      }

      // ç¶å®šExcelç›¸é—œæŒ‰éˆ•
      const downloadTemplateBtn = document.getElementById('download-excel-template-btn');
      const uploadExcelBtn = document.getElementById('upload-excel-btn');
      const excelFileInput = document.getElementById('excel-file-input');
      
      if (downloadTemplateBtn) {
        downloadTemplateBtn.addEventListener('click', downloadExcelTemplate);
      }
      
      if (uploadExcelBtn && excelFileInput) {
        uploadExcelBtn.addEventListener('click', () => {
          excelFileInput.click();
        });
        
        excelFileInput.addEventListener('change', (e) => {
          if (e.target.files.length > 0) {
            uploadExcelData();
          }
        });
      }

      // ç¶å®šå„²å­˜æŒ‰éˆ•
      const saveTemplateBtn = document.getElementById('save-template-btn');
      if (saveTemplateBtn) {
        saveTemplateBtn.addEventListener('click', savePersonalTemplate);
      }

      const form = document.getElementById("resumeForm");

      // ç¶å®šåœ–ç‰‡é è¦½ï¼šå€‹äººç…§ç‰‡ã€æˆç¸¾å–®ã€ç¼ºå‹¤ä½è­‰ï¼ˆé¸æ“‡æª”æ¡ˆæ™‚å³æ™‚é¡¯ç¤ºï¼‰
      bindImagePreview('photo', 'photoPreviewBox');
      bindImagePreview('transcript_file', 'transcriptPreviewBox');
      bindImagePreview('proof_image', 'proofImagePreviewBox');

      // é‡å°éå‹•æ…‹ç”Ÿæˆçš„æ¬„ä½ï¼Œè¨­å®šç›£è½å™¨
      form.querySelectorAll('input:not([type="file"]), select, textarea').forEach(input => {
        // æª”æ¡ˆæ¬„ä½ä¸å„²å­˜ï¼Œå‹•æ…‹ç”Ÿæˆçš„è­‰ç…§æ¬„ä½åœ¨ addCertificateEntry ä¸­è‡ªè¡Œç¶å®š
        input.addEventListener('input', saveFormData);
        input.addEventListener('change', saveFormData);
      });

      // ç‚ºç¼ºå‹¤è¨˜éŒ„è¡¨å–®æ¬„ä½æ·»åŠ ç›£è½å™¨ï¼ˆä½¿ç”¨ ID æŸ¥æ‰¾ï¼Œå› ç‚ºé€™äº›å­—æ®µå¯èƒ½æ²’æœ‰ name å±¬æ€§ï¼‰
      const absenceContainer = document.getElementById('absenceRecordContainer');
      if (absenceContainer) {
        const absenceFields = [
          absenceContainer.querySelector('#absence_date'),
          absenceContainer.querySelector('#absence_type'),
          absenceContainer.querySelector('#duration_units'),
          absenceContainer.querySelector('#reason')
        ].filter(field => field !== null);

        absenceFields.forEach(field => {
          field.addEventListener('input', () => {
            saveAbsenceFormData();
            saveFormData(); // åŒæ™‚èª¿ç”¨ä¸»ä¿å­˜å‡½æ•¸
          });
          field.addEventListener('change', () => {
            saveAbsenceFormData();
            saveFormData(); // åŒæ™‚èª¿ç”¨ä¸»ä¿å­˜å‡½æ•¸
          });
        });
      }

      // åˆå§‹åŒ–ç¼ºå‹¤è¨˜éŒ„åŠ è¼‰æ¨™è¨˜ï¼ˆç¢ºä¿è®Šé‡å­˜åœ¨ï¼‰
      window.absenceDataLoadedFromResume = false;

      // âš ï¸ é‡è¦ï¼šå…ˆè¨­ç½® isEditing = trueï¼Œç¢ºä¿ç”¨æˆ¶è¼¸å…¥èƒ½ç«‹å³ä¿å­˜
      // å¦‚æœä¹‹å¾Œç™¼ç¾æœ‰å·²æäº¤çš„å±¥æ­·ï¼Œå†è¨­ç½®ç‚º false
      isEditing = true;

      // ã€Œæ–°å¢å±¥æ­·ã€æŒ‰éˆ•é€²å…¥æ™‚ï¼ˆ?new=1ï¼‰ï¼šæ¸…ç©ºæ‰€æœ‰åœ–ç‰‡èˆ‡è­‰ç…§ï¼Œä¸è¼‰å…¥æ—¢æœ‰å±¥æ­·
      const urlParams = new URLSearchParams(window.location.search);
      const isNewResume = urlParams.get('new') === '1';
      window.isNewResume = isNewResume;
      if (isNewResume) {
        localStorage.removeItem(AUTO_SAVE_KEY);
        await clearAllImagesAndCertificates();
        await fillBasicInfoFromUser();
      }

      // å…ˆæª¢æŸ¥æ˜¯å¦æœ‰å·²æäº¤çš„å±¥æ­·ï¼ˆæ–°å¢å±¥æ­·æ¨¡å¼å‰‡ä¸è¼‰å…¥ï¼‰
      const hasResume = isNewResume ? false : await checkLatestResume();

      if (!hasResume) {
        // å¦‚æœæ²’æœ‰å·²æäº¤çš„å±¥æ­·ï¼Œå¾ users å¸¶å…¥å§“åã€é›»å­ä¿¡ç®±ã€å€‹äººé ­è²¼
        await fillBasicInfoFromUser();
        // ä¿æŒç·¨è¼¯æ¨¡å¼ä¸¦è¼‰å…¥ LocalStorage è³‡æ–™
        loadFormData();
        // åœ¨è¼‰å…¥ LocalStorage è³‡æ–™å¾Œï¼Œå†è¼‰å…¥å…¶ä»–è³‡æ–™
        await loadPersonalTemplate();
      } else {
        // å¦‚æœæœ‰å·²æäº¤çš„å±¥æ­·ï¼Œè¨­ç½®ç‚ºåªè®€æ¨¡å¼ï¼ˆä¸è¼‰å…¥ LocalStorageï¼‰
        isEditing = false;
        // å·²ç¶“åœ¨ checkLatestResume ä¸­è¼‰å…¥äº†è³‡æ–™
        // ç­‰å¾… loadResumeData å®Œæˆå¾Œï¼Œå†è¼‰å…¥èª²ç¨‹æ¨¡æ¿ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰ï¼Œä½†ä¸æœƒè¦†è“‹å·²è¼‰å…¥çš„è³‡æ–™
        // æ³¨æ„ï¼šloadResumeData å·²ç¶“åœ¨ checkLatestResume ä¸­å®Œæˆï¼Œé€™è£¡åªéœ€è¦è¼‰å…¥èª²ç¨‹æ¨¡æ¿
        await loadPersonalTemplate();
        // å³ä½¿è™•æ–¼åªè®€æ¨¡å¼ï¼Œä¹Ÿå˜—è©¦æ¢å¾©ç¼ºå‹¤è¨˜éŒ„è¡¨å–®è³‡æ–™ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
        // å…ˆç­‰å¾…ä¸€ä¸‹ï¼Œç¢ºä¿æ‰€æœ‰æ•¸æ“šéƒ½å·²è¼‰å…¥ï¼Œå†æ¢å¾©ç¼ºå‹¤è¡¨å–®
        setTimeout(() => {
          loadAbsenceFormData();
        }, 500);
      }

      // æ­·å²è¨˜éŒ„é ç±¤å·²ç§»é™¤ï¼Œä¸å†è¼‰å…¥å±¥æ­·è¨˜éŒ„
      // loadResumeRecords();
      // è¼‰å…¥å­¸æœŸåˆ—è¡¨
      loadSemesters();

      // åˆå§‹åŒ–ç¼ºå‹¤è¨˜éŒ„é¡¯ç¤ºå€åŸŸï¼ˆé¡¯ç¤ºè¼‰å…¥ä¸­ï¼‰
      const absenceRecordsDisplay = document.getElementById("absenceRecordsDisplay");
      if (absenceRecordsDisplay) {
        absenceRecordsDisplay.innerHTML = '<p class="text-muted text-center">è¼‰å…¥ç¼ºå‹¤è¨˜éŒ„ä¸­...</p>';
      }

      // åˆå§‹åŒ–ç¼ºå‹¤çµ±è¨ˆï¼ˆé¡¯ç¤º 0ï¼‰- é€™å€‹æœƒåœ¨è¼‰å…¥ç¼ºå‹¤è¨˜éŒ„å¾Œè‡ªå‹•æ›´æ–°
      const orderedKeys = ["æ› èª²", "é²åˆ°", "äº‹å‡", "ç—…å‡", "ç”Ÿç†å‡", "å…¬å‡", "å–ªå‡"];
      orderedKeys.forEach(key => {
        const statElement = document.getElementById(`stat_${key}`);
        if (statElement) {
          statElement.textContent = 0;
        }
      });

      // ç­‰å¾…å­¸æœŸåˆ—è¡¨è¼‰å…¥å®Œæˆå¾Œï¼Œè‡ªå‹•è¼‰å…¥ç¼ºå‹¤è¨˜éŒ„ï¼ˆç„¡è«–æ˜¯å¦æœ‰å·²æäº¤å±¥æ­·ï¼‰
      // æ³¨æ„ï¼šloadDefaultSemesterRange æœƒåœ¨ loadSemesters å®Œæˆå¾Œè‡ªå‹•èª¿ç”¨ï¼Œä¸¦è‡ªå‹•æŸ¥è©¢ç¼ºå‹¤è¨˜éŒ„
      // æ‰€ä»¥é€™è£¡åªéœ€è¦è™•ç†æ²’æœ‰é è¨­ç¯„åœçš„æƒ…æ³
      setTimeout(async () => {
        try {
          // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰ç¼ºå‹¤è¨˜éŒ„è¢«è¼‰å…¥äº†ï¼ˆå¾ loadResumeData æˆ– loadDefaultSemesterRangeï¼‰
          const loadedFromResume = window.absenceDataLoadedFromResume === true;
          const currentRecordsCount = allAbsenceRecords.length;
          const startSemesterId = document.getElementById("startSemester")?.value || '';
          const endSemesterId = document.getElementById("endSemester")?.value || '';

          // å¦‚æœå·²ç¶“æœ‰é è¨­ç¯„åœè¢«è¨­ç½®ï¼Œå‰‡å·²ç¶“è‡ªå‹•è¼‰å…¥ï¼Œä¸éœ€è¦é‡è¤‡è¼‰å…¥
          if (startSemesterId && endSemesterId) {
            console.log('âœ… å·²ä½¿ç”¨é è¨­å­¸æœŸç¯„åœè¼‰å…¥ç¼ºå‹¤è¨˜éŒ„');
            return;
          }

          // å¦‚æœæ²’æœ‰å¾å±¥æ­·è³‡æ–™ä¸­è¼‰å…¥ï¼Œä¸”æ²’æœ‰é è¨­ç¯„åœï¼Œå‰‡è‡ªå‹•å¾è³‡æ–™åº«è¼‰å…¥æ‰€æœ‰ç¼ºå‹¤è¨˜éŒ„
          if (!loadedFromResume || currentRecordsCount === 0) {
            console.log('ğŸ“¥ æ²’æœ‰é è¨­ç¯„åœï¼Œè‡ªå‹•è¼‰å…¥æ‰€æœ‰ç¼ºå‹¤è¨˜éŒ„ï¼ˆå¾è³‡æ–™åº«ï¼‰...');
            // è‡ªå‹•è¼‰å…¥æ‰€æœ‰ç¼ºå‹¤è¨˜éŒ„ï¼ˆä¸ç¯©é¸å­¸æœŸï¼‰
            await loadSemesterRangeAbsenceRecords('', '');
            // è¼‰å…¥ç¼ºå‹¤çµ±è¨ˆ
            await loadAbsenceStats();
          } else {
            console.log(`âœ… ç¼ºå‹¤è¨˜éŒ„å·²å¾å±¥æ­·è³‡æ–™ä¸­è¼‰å…¥ï¼ˆ${currentRecordsCount} ç­†ï¼‰ï¼Œè·³éè‡ªå‹•è¼‰å…¥`);
          }
        } catch (error) {
          console.error('âŒ è‡ªå‹•è¼‰å…¥ç¼ºå‹¤è¨˜éŒ„å¤±æ•—:', error);
          if (absenceRecordsDisplay) {
            absenceRecordsDisplay.innerHTML = '<p class="text-muted text-center">è«‹é¸æ“‡å­¸æœŸç¯„åœä¸¦é»æ“Šã€Œç¯©é¸ã€æŒ‰éˆ•ä»¥è¼‰å…¥ç¼ºå‹¤è¨˜éŒ„</p>';
          }
        }
      }, 2500); // ç­‰å¾…å­¸æœŸåˆ—è¡¨å’Œé è¨­ç¯„åœè¼‰å…¥å®Œæˆ

      // ç¢ºä¿æ‰€æœ‰åœ–ç‰‡è·¯å¾‘åœ¨é é¢è¼‰å…¥æ™‚èƒ½å¤ æ¢å¾©ï¼ˆå¾è³‡æ–™åº«é‡æ–°è¼‰å…¥ï¼‰
      // ã€Œæ–°å¢å±¥æ­·ã€æ¨¡å¼ä¸æ¢å¾©ï¼Œä¿æŒæ¸…ç©º
      setTimeout(async () => {
        if (isNewResume) return;
        try {
          const res = await fetch('/api/get_resume_data');
          const result = await res.json();

          if (result.success && result.data) {
            const data = result.data;

            // æ¢å¾©ç…§ç‰‡è·¯å¾‘ä¸¦é¡¯ç¤ºé è¦½ï¼ˆæœ‰æ—¢æœ‰è·¯å¾‘æ™‚ç§»é™¤å¿…å¡«ï¼Œæ–¹ä¾¿å†æ¬¡é€å‡ºï¼‰
            if (data.student_info && data.student_info.photo_path) {
              const photoInput = form.querySelector('input[name="photo"]');
              if (photoInput && !photoInput.getAttribute('data-image-path')) {
                photoInput.setAttribute('data-image-path', data.student_info.photo_path);
                photoInput.removeAttribute('required');
                updateImagePreviewBox('photoPreviewBox', imagePathToUrl(data.student_info.photo_path));
                console.log(`âœ… ç…§ç‰‡è·¯å¾‘å·²æ¢å¾©: ${data.student_info.photo_path}`);
              }
            }

            // æ¢å¾©æˆç¸¾å–®è·¯å¾‘ä¸¦é¡¯ç¤ºé è¦½
            if (data.transcript_path) {
              const transcriptInput = form.querySelector('input[name="transcript_file"]');
              if (transcriptInput && !transcriptInput.getAttribute('data-image-path')) {
                transcriptInput.setAttribute('data-image-path', data.transcript_path);
                transcriptInput.removeAttribute('required');
                updateImagePreviewBox('transcriptPreviewBox', imagePathToUrl(data.transcript_path));
                console.log(`âœ… æˆç¸¾å–®è·¯å¾‘å·²æ¢å¾©: ${data.transcript_path}`);
              }
            }

            // æ¢å¾©ç¼ºå‹¤è¨˜éŒ„ä½è­‰åœ–è·¯å¾‘ä¸¦é¡¯ç¤ºé è¦½
            if (data.absence_proof_path) {
              const proofImageInput = document.getElementById('proof_image');
              if (proofImageInput && !proofImageInput.getAttribute('data-image-path')) {
                proofImageInput.setAttribute('data-image-path', data.absence_proof_path);
                proofImageInput.removeAttribute('required');
                updateImagePreviewBox('proofImagePreviewBox', imagePathToUrl(data.absence_proof_path));
                console.log(`âœ… ç¼ºå‹¤è¨˜éŒ„ä½è­‰åœ–è·¯å¾‘å·²æ¢å¾©: ${data.absence_proof_path}`);
              }
            }

            // æ¢å¾©è­‰ç…§åœ–ç‰‡è·¯å¾‘ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            if (data.certifications && Array.isArray(data.certifications)) {
              data.certifications.forEach((cert, index) => {
                const certImagePath = cert.cert_path || cert.CertPath || cert.certPath || '';
                if (certImagePath) {
                  // æŸ¥æ‰¾å°æ‡‰çš„è­‰ç…§è¼¸å…¥æ¡†ï¼ˆå¯èƒ½éœ€è¦æ ¹æ“šè­‰ç…§çš„ç´¢å¼•æˆ–å…¶ä»–æ¨™è­˜ï¼‰
                  // é€™è£¡æš«æ™‚è·³éï¼Œå› ç‚ºè­‰ç…§æ˜¯å‹•æ…‹ç”Ÿæˆçš„ï¼Œè·¯å¾‘æœƒåœ¨ initializeCertificatesUI ä¸­è™•ç†
                }
              });
            }
          }
        } catch (error) {
          console.error('âŒ æ¢å¾©åœ–ç‰‡è·¯å¾‘å¤±æ•—:', error);
        }
      }, 1000); // å»¶é²1ç§’ï¼Œç¢ºä¿å…¶ä»–åˆå§‹åŒ–å®Œæˆ
    });

    // ğŸ§© ä¿®æ”¹å±¥æ­·æŒ‰éˆ•é»æ“Šäº‹ä»¶ï¼ˆåƒè€ƒ fill_preferences é é¢ï¼‰
    const editResumeBtn = document.getElementById("editResumeBtn");
    if (editResumeBtn) {
      editResumeBtn.addEventListener("click", async function () {
        // æª¢æŸ¥æˆªæ­¢æ™‚é–“
        if (window.deadlineExpired) {
          return Swal.fire({ 
            icon: 'error', 
            title: 'å·²è¶…éæˆªæ­¢æ™‚é–“', 
            text: 'ç„¡æ³•å†ä¿®æ”¹å±¥æ­·ã€‚' 
          });
        }

        try {
          const deadlineCheck = await fetch("/announcement/api/check_deadline?type=resume");
          const deadlineResult = await deadlineCheck.json();
          if (deadlineResult.success && deadlineResult.has_deadline && deadlineResult.is_expired) {
            return Swal.fire({ 
              icon: 'error', 
              title: 'å·²è¶…éæˆªæ­¢æ™‚é–“', 
              text: `ä¸Šå‚³å±¥æ­·çš„æˆªæ­¢æ™‚é–“ç‚ºï¼š${deadlineResult.deadline}ï¼Œç„¡æ³•å†ä¿®æ”¹ã€‚` 
            });
          }
        } catch (error) {
          console.error("æª¢æŸ¥æˆªæ­¢æ™‚é–“å¤±æ•—:", error);
        }

        // åˆ‡æ›ç·¨è¼¯ç‹€æ…‹
        isEditing = !isEditing;

        if (isEditing) {
          // å¦‚æœé€²å…¥ç·¨è¼¯æ¨¡å¼ï¼Œå…ˆå¾è³‡æ–™åº«é‡æ–°è¼‰å…¥å®Œæ•´è³‡æ–™ï¼Œç¢ºä¿æ‰€æœ‰æ¬„ä½éƒ½æœ‰å€¼
          console.log("ğŸ”„ é€²å…¥ç·¨è¼¯æ¨¡å¼ï¼Œå¾è³‡æ–™åº«è¼‰å…¥å®Œæ•´è³‡æ–™...");
          disableAutoSave = true;

          // 1. å…ˆå¾è³‡æ–™åº«è¼‰å…¥å®Œæ•´è³‡æ–™ï¼ˆåŒ…æ‹¬è­‰ç…§ã€ç¼ºå‹¤ç­‰ï¼‰
          await loadResumeData();

          // 2. è¼‰å…¥ç¼ºå‹¤è¨˜éŒ„åˆ—è¡¨
          await loadAbsenceRecordsList();

          // 3. è¼‰å…¥ç¼ºå‹¤çµ±è¨ˆ
          await loadAbsenceStats();

          // 4. å¦‚æœå­¸æœŸé¸æ“‡å™¨æœ‰å€¼ï¼Œé‡æ–°è¼‰å…¥è©²å­¸æœŸç¯„åœçš„ç¼ºå‹¤è¨˜éŒ„
          const startSemesterId = document.getElementById("startSemester")?.value || '';
          const endSemesterId = document.getElementById("endSemester")?.value || '';
          if (startSemesterId && endSemesterId) {
            console.log(`ğŸ”„ é‡æ–°è¼‰å…¥å­¸æœŸç¯„åœçš„ç¼ºå‹¤è¨˜éŒ„: ${startSemesterId} - ${endSemesterId}`);
            await loadSemesterRangeAbsenceRecords(startSemesterId, endSemesterId);
          }

          // 5. ç„¶å¾Œè¼‰å…¥ LocalStorage è³‡æ–™ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œç”¨æ–¼è¦†è“‹ï¼ˆä¿ç•™ç”¨æˆ¶çš„è‡¨æ™‚ä¿®æ”¹ï¼‰
          loadFormData();

          disableAutoSave = false;

          // æ»¾å‹•åˆ°è¡¨å–®é ‚éƒ¨
          window.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
          // å¦‚æœå–æ¶ˆç·¨è¼¯ï¼Œæ¸…é™¤ LocalStorage ä¸¦é‡æ–°å¾è³‡æ–™åº«è¼‰å…¥è³‡æ–™
          console.log("ğŸ”„ å–æ¶ˆç·¨è¼¯æ¨¡å¼ï¼Œå¾è³‡æ–™åº«é‡æ–°è¼‰å…¥è³‡æ–™...");
          localStorage.removeItem(AUTO_SAVE_KEY);
          disableAutoSave = true;
          await loadResumeData();
          await loadAbsenceRecordsList();
          await loadAbsenceStats();

          // å¦‚æœå­¸æœŸé¸æ“‡å™¨æœ‰å€¼ï¼Œé‡æ–°è¼‰å…¥è©²å­¸æœŸç¯„åœçš„ç¼ºå‹¤è¨˜éŒ„
          const startSemesterId = document.getElementById("startSemester")?.value || '';
          const endSemesterId = document.getElementById("endSemester")?.value || '';
          if (startSemesterId && endSemesterId) {
            console.log(`ğŸ”„ é‡æ–°è¼‰å…¥å­¸æœŸç¯„åœçš„ç¼ºå‹¤è¨˜éŒ„: ${startSemesterId} - ${endSemesterId}`);
            await loadSemesterRangeAbsenceRecords(startSemesterId, endSemesterId);
          }

          disableAutoSave = false;
        }
      });
    }

    // æ“è¡Œæˆç¸¾è½‰æ› (åŠ å…¥ saveFormData)
    const scoreInput = document.querySelector('input[name="conduct_score_numeric"]');
    const hiddenGrade = document.getElementById("conduct_score");
    const conductScoreHandler = () => {
      const score = parseInt(scoreInput.value);
      let grade = "";
      if (score >= 90) grade = "å„ª";
      else if (score >= 80) grade = "ç”²";
      else if (score >= 70) grade = "ä¹™";
      else if (score >= 60) grade = "ä¸™";
      else if (score >= 0) grade = "ä¸";
      hiddenGrade.value = grade;
      saveFormData(); // è½‰æ›å¾Œä¹Ÿå„²å­˜
    };
    scoreInput.addEventListener("input", conductScoreHandler);


    // ğŸ§© è¡¨å–®é€å‡º (æäº¤æˆåŠŸå¾Œæ¸…é™¤ LocalStorage ä¸¦åˆ‡æ›é ç±¤)
    document.getElementById("resumeForm").addEventListener("submit", async e => {
      e.preventDefault();

      // å†æ¬¡æª¢æŸ¥æˆªæ­¢æ™‚é–“ï¼ˆé˜²æ­¢ç”¨æˆ¶ç¹éå‰ç«¯æª¢æŸ¥ï¼‰
      if (window.deadlineExpired) {
        return Swal.fire({ 
          icon: 'error', 
          title: 'å·²è¶…éæˆªæ­¢æ™‚é–“', 
          text: 'ç„¡æ³•å†æäº¤å±¥æ­·ã€‚' 
        });
      }

      try {
        const deadlineCheck = await fetch("/announcement/api/check_deadline?type=resume");
        const deadlineResult = await deadlineCheck.json();
        if (deadlineResult.success && deadlineResult.has_deadline && deadlineResult.is_expired) {
          return Swal.fire({ 
            icon: 'error', 
            title: 'å·²è¶…éæˆªæ­¢æ™‚é–“', 
            text: `ä¸Šå‚³å±¥æ­·çš„æˆªæ­¢æ™‚é–“ç‚ºï¼š${deadlineResult.deadline}ï¼Œç„¡æ³•å†æäº¤ã€‚` 
          });
        }
      } catch (error) {
        console.error("æª¢æŸ¥æˆªæ­¢æ™‚é–“å¤±æ•—:", error);
      }

      const submitBtn = e.submitter;
      const originalText = submitBtn.textContent;

      submitBtn.disabled = true;
      submitBtn.textContent = 'ç”Ÿæˆä¸­...';

      const formData = new FormData(e.target);

      // æ”¶é›†è­‰ç…§åœ–ç‰‡æ–‡ä»¶ï¼ˆç¢ºä¿æ‰€æœ‰è­‰ç…§åœ–ç‰‡éƒ½è¢«åŒ…å«ï¼‰
      const certPhotoInputs = document.querySelectorAll('input[name="cert_photos[]"]');
      certPhotoInputs.forEach((input, index) => {
        if (input.files && input.files[0]) {
          // FormData æœƒè‡ªå‹•è™•ç†åŒåçš„å¤šå€‹æ–‡ä»¶ï¼Œä½†æˆ‘å€‘ç¢ºä¿å®ƒå€‘è¢«æ­£ç¢ºæ·»åŠ 
          formData.append('cert_photos[]', input.files[0]);
          console.log(`ğŸ“¤ æ·»åŠ è­‰ç…§åœ–ç‰‡ ${index + 1}:`, input.files[0].name);
        }
      });

      // æ”¶é›†å‹•æ…‹çš„èª²ç¨‹è³‡æ–™ä¸¦æ·»åŠ åˆ° FormData
      // âš ï¸ é‡è¦ï¼šå…ˆå¾ç•¶å‰é é¢çš„è¡¨æ ¼ä¸­åŒæ­¥æœ€æ–°ç‹€æ…‹åˆ° allCoursesData
      const courseRows = document.querySelectorAll("#courseTableBody tr");
      courseRows.forEach(row => {
        const nameInput = row.querySelector('input[name="course_name[]"]');
        const creditsInput = row.querySelector('input[name="course_credits[]"]');
        const gradeInput = row.querySelector('input[name="course_grade[]"]');
        const isNotTaken = row.dataset.isNotTaken === 'true';

        if (nameInput && creditsInput) {
          const courseName = nameInput.value.trim();
          if (courseName) {
            const index = allCoursesData.findIndex(c => c.name === courseName);
            if (index > -1) {
              // æ›´æ–°ç¾æœ‰èª²ç¨‹çš„ç‹€æ…‹
              allCoursesData[index].name = courseName;
              allCoursesData[index].credits = creditsInput.value.trim();
              allCoursesData[index].grade = gradeInput ? gradeInput.value.trim() : '';
              allCoursesData[index].isNotTaken = isNotTaken;
            } else {
              // å¦‚æœæ˜¯æ–°èª²ç¨‹ï¼Œæ·»åŠ åˆ° allCoursesData
              allCoursesData.push({
                name: courseName,
                credits: creditsInput.value.trim(),
                grade: gradeInput ? gradeInput.value.trim() : '',
                isNotTaken: isNotTaken
              });
            }
          }
        }
      });

      // æœªä¸Šå‚³æ–°æˆç¸¾å–®æ™‚ï¼Œå¸¶å…¥æ—¢æœ‰æˆç¸¾å–®è·¯å¾‘ï¼ˆä¾›å¾Œç«¯ä¿ç•™ ProofImageï¼‰
      const transcriptInput = document.getElementById('transcript_file');
      const existingTranscriptPath = (transcriptInput && !(transcriptInput.files && transcriptInput.files[0]))
        ? (transcriptInput.getAttribute('data-image-path') || '').replace(/\\/g, '/')
        : '';

      // âš ï¸ é—œéµä¿®æ­£ï¼šä½¿ç”¨ allCoursesData æ”¶é›†æ‰€æœ‰èª²ç¨‹ï¼Œè€Œä¸æ˜¯åªæ”¶é›†ç•¶å‰é é¢çš„èª²ç¨‹
      // é€™æ¨£å¯ä»¥ç¢ºä¿æ‰€æœ‰30é–€èª²ç¨‹éƒ½è¢«æäº¤ï¼Œè€Œä¸åªæ˜¯ç•¶å‰é é¢é¡¯ç¤ºçš„10é–€
      const courses = allCoursesData
        .filter(course => course.name && course.name.trim()) // éæ¿¾æ‰ç©ºåç¨±çš„èª²ç¨‹
        .map(course => ({
          name: course.name.trim(),
          credits: course.credits || '0',
          grade: course.grade || '',
          isNotTaken: course.isNotTaken || false,
          proof_image: course.proof_image || existingTranscriptPath || ''
        }));

      console.log(`ğŸ“¤ æº–å‚™æäº¤ ${courses.length} é–€èª²ç¨‹ï¼ˆå¾ allCoursesData æ”¶é›†ï¼Œå…± ${allCoursesData.length} é–€ï¼‰`);
      formData.append("courses", JSON.stringify(courses));
      // course_grade_ids æ”¹ç”±å¾Œç«¯ä¾æ’å…¥çš„ course_grades å–å¾— id ä¸¦å¯«å…¥ resume_content_mapping
      formData.append("selected_course_grade_ids", JSON.stringify([]));

      // ç§»é™¤èˆŠçš„èª²ç¨‹ç›¸é—œæ¬„ä½ï¼Œå› ç‚ºæˆ‘å€‘çµ±ä¸€ç”¨ JSON å‚³é
      formData.delete("course_name[]");
      formData.delete("course_credits[]");
      formData.delete("course_grade[]");

      // æ”¶é›†ç¼ºå‹¤è¨˜éŒ„è³‡æ–™ï¼ˆå¾è³‡æ–™åº«è®€å–çš„è¨˜éŒ„ï¼‰
      // 1. æ”¶é›†æ‰€æœ‰ç¼ºå‹¤è¨˜éŒ„IDå’Œå°æ‡‰çš„ä½è­‰åœ–ç‰‡
      const absenceRecordsWithImages = [];
      const recordImageInputs = document.querySelectorAll('.absence-proof-image');
      recordImageInputs.forEach(input => {
        const recordId = input.getAttribute('data-record-id');
        const file = input.files[0];
        if (recordId && file) {
          absenceRecordsWithImages.push({
            record_id: recordId,
            image_file: file.name
          });
          // å°‡åœ–ç‰‡æ·»åŠ åˆ° FormDataï¼Œä½¿ç”¨ record_id ä½œç‚ºéµçš„ä¸€éƒ¨åˆ†
          formData.append(`proof_image_${recordId}`, file);
          console.log(`ğŸ“¤ ç‚ºè¨˜éŒ„ ${recordId} ä¸Šå‚³ä½è­‰åœ–ç‰‡:`, file.name);
        }
      });

      // 2. å¦‚æœæœ‰æ•´é«”ä½è­‰åœ–ç‰‡ï¼ˆä½œç‚ºå‚™ç”¨ï¼‰ï¼Œä¹Ÿæ·»åŠ 
      const proofImageInput = document.getElementById('proof_image');
      if (proofImageInput && proofImageInput.files && proofImageInput.files[0]) {
        formData.append("proof_image", proofImageInput.files[0]);
        console.log("ğŸ“¤ è¡¨å–®æäº¤æ™‚åŒ…å«æ•´é«”ç¼ºå‹¤ä½è­‰åœ–ç‰‡:", proofImageInput.files[0].name);
      }

      // 3. æ”¶é›†å­¸æœŸç¯„åœï¼ˆç”¨æ–¼å¾Œç«¯æŸ¥è©¢å’Œæ›´æ–°ï¼‰
      const startSemesterId = document.getElementById('startSemester')?.value || '';
      const endSemesterId = document.getElementById('endSemester')?.value || '';
      if (startSemesterId && endSemesterId) {
        formData.append("start_semester_id", startSemesterId);
        formData.append("end_semester_id", endSemesterId);
      }

      // 4. å°‡ç¼ºå‹¤è¨˜éŒ„å’Œåœ–ç‰‡å°æ‡‰é—œä¿‚ä»¥ JSON æ ¼å¼å‚³é€
      if (absenceRecordsWithImages.length > 0) {
        formData.append("absence_records_with_images", JSON.stringify(absenceRecordsWithImages));
      }

      // 5. æ”¶é›†ç¼ºå‹¤çµ±è¨ˆè³‡æ–™ï¼ˆå¾è³‡æ–™åº«è®€å–ï¼‰
      const orderedKeys = ["æ› èª²", "é²åˆ°", "äº‹å‡", "ç—…å‡", "ç”Ÿç†å‡", "å…¬å‡", "å–ªå‡"];
      const absenceStats = {};
      orderedKeys.forEach(key => {
        const statElement = document.getElementById(`stat_${key}`);
        if (statElement) {
          absenceStats[key] = parseInt(statElement.textContent) || 0;
        }
      });
      formData.append("absence_stats_json", JSON.stringify(absenceStats));

      // 5.5 é¸ç”¨çš„ç¼ºå‹¤ç´€éŒ„ ID åˆ—è¡¨ï¼ˆä¾› resume_content_mapping å„²å­˜ï¼Œæäº¤å¾Œå¯æ–¼ç·¨è¼¯æ™‚é‚„åŸåˆ—è¡¨èˆ‡ä½è­‰åœ–ï¼‰
      const selectedAbsenceRecordIds = Array.isArray(allAbsenceRecords) ? allAbsenceRecords.filter(r => r.id).map(r => r.id) : [];
      formData.append("selected_absence_record_ids", JSON.stringify(selectedAbsenceRecordIds));

      // 6. æ”¶é›†è­‰ç…§è³‡æ–™ï¼ˆstructured_certificationsï¼‰ï¼Œå« id ä¾› resume_content_mapping ä½¿ç”¨
      const structuredCertifications = certEntries.map(entry => {
        const authorityId = entry.authoritySelect ? entry.authoritySelect.value : '';
        const isOther = authorityId === 'OTHER';
        const codeInput = entry.codeInput ? entry.codeInput.value.trim() : '';
        const nameInput = entry.nameInput ? entry.nameInput.value.trim() : '';
        
        const cert = {
          cert_code: codeInput || 'OTHER',
          name: nameInput || (entry.customNameInput ? entry.customNameInput.value.trim() : ''),
          custom_cert_name: entry.customNameInput ? entry.customNameInput.value.trim() : '',
          authority_id: authorityId && authorityId !== 'OTHER' ? authorityId : null,
          authority_name: isOther && entry.authorityNameInput ? entry.authorityNameInput.value.trim() : '',
          job_category: isOther && entry.otherJobCategoryInput ? entry.otherJobCategoryInput.value.trim() : (entry.jobCategorySelect ? entry.jobCategorySelect.value.trim() : ''),
          level: isOther && entry.otherLevelInput ? entry.otherLevelInput.value : (entry.levelSelect ? entry.levelSelect.value : ''),
          category: entry.categoryInput ? entry.categoryInput.value : 'other',
          acquire_date: entry.acquisitionDateInput ? entry.acquisitionDateInput.value : '',
          issuer: entry.issuerInput ? entry.issuerInput.value.trim() : '',
          cert_path: entry.fileInput && entry.fileInput.dataset.imagePath ? entry.fileInput.dataset.imagePath : ''
        };
        if (entry.certId) cert.id = entry.certId;
        return cert;
      }).filter(cert => cert.name || cert.cert_code);

      const selectedCertIds = structuredCertifications.filter(c => c.id).map(c => c.id);
      const resumeIdFromQuery = new URLSearchParams(window.location.search).get('resume_id');
      if (resumeIdFromQuery && selectedCertIds.length) {
        formData.append("selected_certification_ids", JSON.stringify(selectedCertIds));
      }

      console.log(`ğŸ“¤ æº–å‚™æäº¤ ${structuredCertifications.length} é …è­‰ç…§`);
      formData.append("structured_certifications", JSON.stringify(structuredCertifications));

      // 7. æ”¶é›†èªæ–‡èƒ½åŠ›è³‡æ–™ï¼ˆæœªå¡«å¯«çš„èªæ–‡è‡ªå‹•ä»£å…¥ã€Œç•¥æ‡‚ã€ï¼ŒWord èˆ‡è³‡æ–™è¡¨éƒ½æœƒå¸¶å…¥ï¼‰
      const structuredLanguages = [];
      const languageFields = [
        { name: 'lang_en_level', language: 'è‹±èª' },
        { name: 'lang_tw_level', language: 'å°èª' },
        { name: 'lang_jp_level', language: 'æ—¥èª' },
        { name: 'lang_hk_level', language: 'å®¢èª' }
      ];

      languageFields.forEach(field => {
        const selectElement = document.querySelector(`select[name="${field.name}"]`);
        const level = (selectElement && selectElement.value) ? selectElement.value : 'ç•¥æ‡‚';
        structuredLanguages.push({
          language: field.language,
          level: level
        });
      });

      console.log(`ğŸ“¤ æº–å‚™æäº¤ ${structuredLanguages.length} é …èªæ–‡èƒ½åŠ›`);
      formData.append("structured_languages", JSON.stringify(structuredLanguages));

      const selectedLangIds = [];
      languageFields.forEach(field => {
        const el = document.querySelector(`select[name="${field.name}"]`);
        if (el && el.dataset.languageId) selectedLangIds.push(parseInt(el.dataset.languageId, 10));
      });
      if (resumeIdFromQuery && selectedLangIds.length) {
        formData.append("selected_language_skill_ids", JSON.stringify(selectedLangIds));
      }

      // ç·¨è¼¯æ¨¡å¼ï¼šè‹¥æœ‰ resume_id å‰‡ä¸€ä½µå‚³é€ï¼Œå¾Œç«¯æœƒè¦†è“‹æ—¢æœ‰æª”æ¡ˆè€Œéæ–°å¢ä¸€ç­†
      const urlParams = new URLSearchParams(window.location.search);
      const resumeIdFromUrl = urlParams.get('resume_id');
      if (resumeIdFromUrl) {
        formData.append("resume_id", resumeIdFromUrl);
        console.log("ğŸ“¤ ç·¨è¼¯æ¨¡å¼ï¼Œå‚³é€ resume_id:", resumeIdFromUrl);
      }

      try {
        const res = await fetch("/api/submit_and_generate", {
          method: "POST",
          body: formData
        });
        const result = await res.json();

        if (result.success) {
          // æäº¤æˆåŠŸå¾Œæ¸…é™¤ LocalStorageï¼ˆåƒè€ƒ fill_preferences é é¢ï¼‰
          localStorage.removeItem(AUTO_SAVE_KEY);

          // æ›´æ–°ç·¨è¼¯ç‹€æ…‹ç‚º false
          isEditing = false;

          // é¡¯ç¤ºæˆåŠŸè¨Šæ¯ä¸¦è·³è½‰åˆ°å±¥æ­·ç®¡ç†é é¢
          Swal.fire({
            icon: 'success',
            title: 'å±¥æ­·å·²æˆåŠŸç”Ÿæˆï¼',
            text: 'æ­£åœ¨è·³è½‰åˆ°å±¥æ­·ç®¡ç†é é¢...',
            timer: 2000,
            showConfirmButton: false
          }).then(() => {
            window.location.href = '/resume_folders';
          });

        } else {
          alert("âŒ æäº¤å¤±æ•—ï¼š" + (result.message || "æœªçŸ¥éŒ¯èª¤"));
        }
      } catch (error) {
        console.error('Error submitting form:', error);
        alert("âŒ ç¶²è·¯æˆ–ä¼ºæœå™¨éŒ¯èª¤");
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    });

    // å´é‚Šé¸å–®é–‹é—œ
    document.addEventListener('DOMContentLoaded', () => {
      const menuBtn = document.getElementById('menu-btn');
      const sideMenu = document.getElementById('side-menu');
      const closeBtn = document.getElementById('close-btn');

      if (menuBtn && sideMenu && closeBtn) {
        menuBtn.addEventListener('click', () => {
          sideMenu.classList.add('open');
          sideMenu.setAttribute('aria-hidden', 'false');
        });

        closeBtn.addEventListener('click', () => {
          sideMenu.classList.remove('open');
          sideMenu.setAttribute('aria-hidden', 'true');
        });

        // å¦‚æœé»æ“Šé¸å–®ä»¥å¤–çš„åœ°æ–¹å°±é—œé–‰é¸å–®
        document.addEventListener('click', (e) => {
          if (
            !sideMenu.contains(e.target) &&
            !menuBtn.contains(e.target)
          ) {
            sideMenu.classList.remove('open');
            sideMenu.setAttribute('aria-hidden', 'true');
          }
        });
      }
    });

    // ========================================
    // AI å±¥æ­·ä¿®æ”¹åŠŸèƒ½
    // ========================================
    
    // è™•ç† AI æ¨™ç±¤é é»æ“Š - å®šç¾©ç‚ºå…¨å±€å‡½æ•¸ä¾› onclick ä½¿ç”¨
    // æ¯æ¬¡é»æ“Šéƒ½è¦é¡¯ç¤ºå…è²¬è²æ˜
    window.handleAITabClick = function(e) {
      console.log('ğŸ–±ï¸ AI æ¨™ç±¤é è¢«é»æ“Š');
      
      // æ¯æ¬¡é»æ“Šéƒ½é˜»æ­¢åˆ‡æ›ä¸¦é¡¯ç¤º modal
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      showDisclaimerModal();
      return false;
    };
    
    // ç•¶åˆ‡æ›åˆ° AI ç·¨è¼¯é ç±¤æ™‚ï¼Œè‡ªå‹•è¼‰å…¥è‡ªå‚³å…§å®¹
    document.addEventListener('DOMContentLoaded', function() {
      const aiEditTab = document.getElementById('ai-edit-tab');
      if (aiEditTab) {
        aiEditTab.addEventListener('shown.bs.tab', async function() {
          const aiResumeInput = document.getElementById('ai-resume-input');
          const autobiographyTextarea = document.querySelector('textarea[name="autobiography"]');
          
          // å„ªå…ˆä½¿ç”¨è¡¨å–®ä¸­å·²å¡«å¯«çš„è‡ªå‚³å…§å®¹
          if (autobiographyTextarea && autobiographyTextarea.value.trim()) {
            if (aiResumeInput) {
              aiResumeInput.value = autobiographyTextarea.value;
              console.log('âœ… å·²è¼‰å…¥è¡¨å–®ä¸­çš„è‡ªå‚³å…§å®¹');
            }
          } else {
            // å¦‚æœè¡¨å–®ä¸­æ²’æœ‰å…§å®¹ï¼Œå˜—è©¦å¾è³‡æ–™åº«è¼‰å…¥
            try {
              const res = await fetch('/api/get_resume_data');
              const result = await res.json();
              
              if (result.success && result.data && result.data.studentInfo) {
                const autobiography = result.data.studentInfo.autobiography || '';
                if (autobiography && aiResumeInput) {
                  aiResumeInput.value = autobiography;
                  console.log('âœ… å·²è‡ªå‹•è¼‰å…¥è³‡æ–™åº«ä¸­çš„è‡ªå‚³å…§å®¹');
                } else {
                  console.log('â„¹ï¸ è³‡æ–™åº«ä¸­æš«ç„¡è‡ªå‚³å…§å®¹');
                }
              }
            } catch (error) {
              console.error('âŒ è¼‰å…¥è‡ªå‚³å…§å®¹å¤±æ•—:', error);
            }
          }
        });
      }
    });

    // AI ä¿®æ”¹å±¥æ­·å‡½æ•¸
    async function reviseResumeInTab() {
      const resumeInput = document.getElementById('ai-resume-input').value;
      const revisedResumeDiv = document.getElementById('ai-revised-resume');
      const loadingSpinner = document.getElementById('ai-loading-spinner');
      const editStyle = document.getElementById('ai-edit-style').value;
      const toneStyle = document.getElementById('ai-tone-style').value;

      // å¦‚æœè¼¸å…¥æ¡†ç‚ºç©ºï¼Œå¾Œç«¯æœƒè‡ªå‹•å¾è³‡æ–™åº«è®€å–è‡ªå‚³
      if (resumeInput.trim() === "") {
        console.log("â„¹ï¸ è¼¸å…¥æ¡†ç‚ºç©ºï¼Œå¾Œç«¯å°‡è‡ªå‹•å¾è³‡æ–™åº«è®€å–è‡ªå‚³å…§å®¹");
      }

      revisedResumeDiv.innerHTML = "";
      revisedResumeDiv.style.color = '';
      loadingSpinner.style.display = 'block';

      try {
        const response = await fetch('/api/revise-resume', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            resumeText: resumeInput,
            style: editStyle,
            tone: toneStyle
          })
        });

        if (!response.body) {
          throw new Error("ä¼ºæœå™¨æ²’æœ‰è¿”å›å¯è®€å–çš„ä¸²æµã€‚");
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let done = false;
        let fullText = '';

        while (!done) {
          const { value, done: readerDone } = await reader.read();
          done = readerDone;

          if (value) {
            const chunk = decoder.decode(value, { stream: true });
            fullText += chunk;
            revisedResumeDiv.innerHTML = fullText;
          }
        }
        fullText += decoder.decode();
        
        // éæ¿¾æ‰å¯èƒ½çš„è§£é‡‹æ€§æ–‡å­—
        const prefixesToRemove = [
          /^æ²’å•é¡Œ[ï¼!]?[ï¼Œ,]?é€™æ˜¯ç‚ºæ‚¨æ”¹å¯«çš„[ï¼š:]/i,
          /^é€™æ˜¯ç‚ºæ‚¨æ”¹å¯«çš„[ï¼š:]/i,
          /^ä»¥ä¸‹æ˜¯[ï¼š:]/i,
          /^ä»¥ä¸‹æ˜¯ç‚ºæ‚¨æ”¹å¯«çš„[ï¼š:]/i,
          /^é€™æ˜¯[ï¼š:]/i,
          /^ä»¥ä¸‹æ˜¯æ”¹å¯«å¾Œçš„ç‰ˆæœ¬[ï¼š:]/i,
          /^æ”¹å¯«å¾Œçš„ç‰ˆæœ¬[ï¼š:]/i,
          /^ä»¥ä¸‹æ˜¯æ”¹å¯«å…§å®¹[ï¼š:]/i,
          /^æ”¹å¯«å…§å®¹[ï¼š:]/i
        ];
        
        let cleanedText = fullText.trim();
        for (const prefix of prefixesToRemove) {
          cleanedText = cleanedText.replace(prefix, '').trim();
        }
        
        if (!cleanedText) {
          cleanedText = fullText.trim();
        }
        
        revisedResumeDiv.innerHTML = cleanedText;
        console.log('âœ… AI ä¿®æ”¹å®Œæˆ');

      } catch (error) {
        console.error('é€£ç·šæˆ–è®€å–ä¸²æµéŒ¯èª¤:', error);
        revisedResumeDiv.innerHTML = `AI æœå‹™é€£ç·šå¤±æ•—ï¼šç„¡æ³•é€£ç·šåˆ°å¾Œç«¯ä¼ºæœå™¨ã€‚è«‹æª¢æŸ¥ä¼ºæœå™¨ç‹€æ…‹ä¸¦ç¨å¾Œå†è©¦ã€‚`;
        revisedResumeDiv.style.color = 'red';
      } finally {
        loadingSpinner.style.display = 'none';
      }
    }

    // å°å…¥ AI ä¿®æ”¹çµæœåˆ°è¡¨å–®å¡«å¯«é ç±¤
    function importAIResultToForm() {
      const revisedResumeDiv = document.getElementById('ai-revised-resume');
      const placeholderText = 'AI ä¿®æ”¹å¾Œçš„å…§å®¹å°‡é¡¯ç¤ºåœ¨é€™è£¡...';
      
      let revisedText = revisedResumeDiv.textContent || revisedResumeDiv.innerText || '';
      
      if (revisedText.trim() === placeholderText || revisedText.trim() === '') {
        alert('âŒ è«‹å…ˆä½¿ç”¨ AI ç¾åŒ–è‡ªå‚³ï¼Œç„¶å¾Œå†å°å…¥ï¼');
        return;
      }
      
      if (revisedText.trim().length < 10) {
        alert('âŒ å°å…¥çš„å…§å®¹å¤ªçŸ­ï¼Œå¯èƒ½ä¸å®Œæ•´ã€‚è«‹ç¢ºèª AI ç¾åŒ–å·²å®Œæˆã€‚');
        return;
      }

      // å°‡ AI ä¿®æ”¹å¾Œçš„å…§å®¹å¡«å…¥è¡¨å–®çš„è‡ªå‚³æ¬„ä½
      const autobiographyTextarea = document.querySelector('textarea[name="autobiography"]');
      if (autobiographyTextarea) {
        autobiographyTextarea.value = revisedText.trim();
        
        // åˆ‡æ›åˆ°è¡¨å–®å¡«å¯«é ç±¤
        const formTab = document.getElementById('form-tab');
        if (formTab) {
          formTab.click();
          
          // æ»¾å‹•åˆ°è‡ªå‚³æ¬„ä½
          setTimeout(() => {
            autobiographyTextarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
            autobiographyTextarea.focus();
          }, 300);
        }
        
        alert('âœ… å·²æˆåŠŸå°å…¥ AI ä¿®æ”¹å¾Œçš„è‡ªå‚³åˆ°è¡¨å–®å¡«å¯«é ç±¤ï¼');
        console.log('âœ… å·²å°å…¥ AI ä¿®æ”¹å¾Œçš„è‡ªå‚³ï¼Œé•·åº¦:', revisedText.trim().length, 'å­—å…ƒ');
      } else {
        alert('âŒ ç„¡æ³•æ‰¾åˆ°è‡ªå‚³æ¬„ä½ï¼Œè«‹ç¢ºèªè¡¨å–®å·²æ­£ç¢ºè¼‰å…¥ã€‚');
      }
    }

  </script>

  <!-- å´é‚Šé¸å–® -->
  <nav id="side-menu" aria-hidden="true" role="navigation" aria-label="åŠŸèƒ½é¸å–®">
    <button id="close-btn" aria-label="é—œé–‰åŠŸèƒ½é¸å–®">Ã—</button>
    <h2>åŠŸèƒ½é¸å–®</h2>
    <a href="/student_home">é¦–é </a>
    <a href="/profile">å€‹äººè³‡æ–™</a>
    <a href="/look_company">æŠ•éå±¥æ­·</a>
    <a href="/fill_preferences">å¡«å¯«å¿—é¡˜åº</a>
    <a href="/notifications">é€šçŸ¥</a>
    <a href="/intern_achievement">å¯¦ç¿’æˆæœ</a>
    <a href="/intern_experience">å¯¦ç¿’å¿ƒå¾—</a>
  </nav>
</body>

</html>