<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ™ºæ…§å¯¦ç¿’å¹³å° | å±¥æ­·ç®¡ç†å¹³å°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    header {
      background: #0454a3;
      color: white;
      padding: 1rem 2rem;
      text-align: center;
      font-size: 1.5rem;
    }

    body {
      font-family: "Noto Sans TC", sans-serif;
      background: #f7f9fc;
    }

    .container {
      max-width: 1000px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .card {
      border-radius: 10px;
    }

    /* èª¿æ•´è¡¨æ ¼å­—é«”å¤§å°å’Œæ¬„ä½æœ€å°å¯¬åº¦ä»¥å®¹ç´å®Œæ•´æ–‡å­— */
    table {
      font-size: 1rem;
      table-layout: fixed;
      width: 100%;
    }


    /* è­‰ç…§è¡¨æ ¼ä¸éœ€è¦é€™éº¼å¯¬ï¼Œè®“å®ƒè‡ªå‹•åˆ†é… */
    .card:has(h5.text-secondary) table th:not(:last-child) {
      min-width: unset;
    }

    .language-group label {
      font-weight: 600;
    }

    .course-scroll-container {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 5px;
    }

    /* æ–°å¢æ¨£å¼ï¼šè®“è¡¨æ ¼åœ¨æ»¾å‹•å®¹å™¨å…§é¡¯ç¤ºæ­£å¸¸ */
    .course-scroll-container table {
      margin-bottom: 0;
    }
  </style>
</head>

<body>
  <header>æ™ºæ…§å¯¦ç¿’å¹³å° | å±¥æ­·ç®¡ç†</header>

  <div class="container">
    <div class="card p-4">
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="form-tab" data-bs-toggle="tab" data-bs-target="#form-pane" type="button"
            role="tab" aria-controls="form-pane" aria-selected="true">è¡¨å–®å¡«å¯«</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="records-tab" data-bs-toggle="tab" data-bs-target="#records-pane" type="button"
            role="tab" aria-controls="records-pane" aria-selected="false">ç´€éŒ„ä¸‹è¼‰</button>
        </li>
      </ul>

      <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="form-pane" role="tabpanel" aria-labelledby="form-tab" tabindex="0">
          <form id="resumeForm" enctype="multipart/form-data">

            <h5 class="mt-4 mb-3">å€‹äººåŸºæœ¬è³‡æ–™</h5>
            <input type="hidden" id="conduct_score" name="conduct_score">

            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">å§“å</label>
                <input type="text" name="name" class="form-control" required />
              </div>
              <div class="col-md-4">
                <label class="form-label">å‡ºç”Ÿæ—¥æœŸ</label>
                <input type="date" name="birth_date" class="form-control" required />
              </div>
              <div class="col-md-4">
                <label for="gender" class="form-label">æ€§åˆ¥</label>
                <select class="form-select" id="gender" name="gender" required>
                  <option value="">é¸æ“‡...</option>
                  <option value="ç”·">ç”·</option>
                  <option value="å¥³">å¥³</option>
                  <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">è¯çµ¡é›»è©±</label>
                <input type="tel" name="phone" class="form-control" required />
              </div>
              <div class="col-md-6">
                <label class="form-label">é›»å­ä¿¡ç®±</label>
                <input type="email" name="email" class="form-control" required />
              </div>
              <div class="col-12">
                <label class="form-label">åœ°å€</label>
                <input type="text" name="address" class="form-control" required />
              </div>
              <div class="col-md-6 mt-3">
                <label class="form-label">æ“è¡Œæˆç¸¾åˆ†æ•¸ (0-100)</label>
                <input type="number" name="conduct_score_numeric" class="form-control" min="0" max="100" required>
              </div>
              <div class="col-md-6 mt-3">
                <label for="photo" class="form-label">å€‹äººå¤§é ­ç…§ (JPG/PNG)</label>
                <input class="form-control" type="file" id="photo" name="photo" accept="image/*" />
              </div>
            </div>

            <div class="mb-4"></div>

            <div class="container py-4">
              <h5 class="mb-3">å·²ä¿®ç¿’å°ˆæ¥­æ ¸å¿ƒç§‘ç›®</h5>

              <div class="mb-3">
                <button type="button" class="btn btn-outline-primary btn-sm" id="load-template-btn">æŸ¥çœ‹æˆ‘çš„èª²ç¨‹</button>
                <button type="button" class="btn btn-outline-success btn-sm" id="save-template-btn">å„²å­˜</button>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <input type="text" id="course-search" class="form-control form-control-sm" placeholder="ğŸ” æŸ¥è©¢èª²ç¨‹åç¨±">
                </div>
                <div class="col-md-6">
                  <select id="credit-filter" class="form-select form-select-sm">
                    <option value="">æ‰€æœ‰å­¸åˆ†æ•¸</option>
                    <option value="1">1 å­¸åˆ†</option>
                    <option value="2">2 å­¸åˆ†</option>
                    <option value="3">3 å­¸åˆ†</option>
                  </select>
                </div>
              </div>

              <div class="course-scroll-container">
                <table class="table table-bordered align-middle">
                  <thead>
                    <tr>
                      <th style="width: 50%;">èª²ç¨‹åç¨±</th>
                      <th style="width: 25%;">å­¸åˆ†æ•¸</th>
                      <th style="width: 25%;">ç‹€æ…‹</th>
                    </tr>
                  </thead>
                  <tbody id="courseTableBody">
                    <tr>
                      <td colspan="3" class="text-muted text-center">è¼‰å…¥ä¸­...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>


            <div class="card p-4 mb-3">
              <h5 class="text-secondary">ç›¸é—œè­‰ç…§</h5>
              <table class="table table-bordered text-center align-middle">
                <thead class="table-light">
                  <tr>
                    <th>å‹å‹•éƒ¨è­‰ç…§</th>
                    <th>åœ‹éš›è­‰ç…§</th>
                    <th>åœ‹å…§è­‰ç…§</th>
                    <th>å…¶ä»–è­‰ç…§</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="certificate-table-body">
                </tbody>
              </table> <button type="button" class="btn btn-sm btn-outline-success"
                id="add-certificate-row">ï¼‹æ–°å¢ä¸€åˆ—</button>
            </div>
            <h5 class="mt-4 mb-3">èªæ–‡èƒ½åŠ›</h5>
            <div class="row mb-3">
              <div class="col-md-3 language-group">
                <label>è‹±èª</label>
                <select class="form-select form-select-sm" name="lang_en_level">
                  <option value="">æœªé¸</option>
                  <option value="ç²¾é€š">ç²¾é€š</option>
                  <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                  <option value="ç•¥æ‡‚">ç•¥æ‡‚</option>
                </select>
              </div>
              <div class="col-md-3 language-group">
                <label>å°èª</label>
                <select class="form-select form-select-sm" name="lang_tw_level">
                  <option value="">æœªé¸</option>
                  <option value="ç²¾é€š">ç²¾é€š</option>
                  <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                  <option value="ç•¥æ‡‚">ç•¥æ‡‚</option>
                </select>
              </div>
              <div class="col-md-3 language-group">
                <label>æ—¥èª</label>
                <select class="form-select form-select-sm" name="lang_jp_level">
                  <option value="">æœªé¸</option>
                  <option value="ç²¾é€š">ç²¾é€š</option>
                  <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                  <option value="ç•¥æ‡‚">ç•¥æ‡‚</option>
                </select>
              </div>
              <div class="col-md-3 language-group">
                <label>å®¢èª</label>
                <select class="form-select form-select-sm" name="lang_hk_level">
                  <option value="">æœªé¸</option>
                  <option value="ç²¾é€š">ç²¾é€š</option>
                  <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                  <option value="ç•¥æ‡‚">ç•¥æ‡‚</option>
                </select>
              </div>
            </div>

            <div class="mb-4"></div>

            <div class="card p-4 mb-3">
              <h5 class="text-info">è‡ªå‚³</h5>
              <textarea name="autobiography" rows="6" class="form-control" placeholder="è«‹æè¿°å®¶åº­ç”Ÿæ´»ã€æ±‚å­¸ç¶“éã€å€‹äººå°ˆé•·ã€æœªä¾†è¦åŠƒç­‰..."
                required></textarea>
            </div>

            <div class="card p-4 mb-3">
              <h5 class="text-primary">æˆç¸¾å–®ä¸Šå‚³</h5>
              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label">ä¸Šå‚³å­¸æœŸæˆç¸¾å–® (JPG/PNG)</label>
                  <input type="file" name="transcript_file" class="form-control" accept="image/jpeg, image/png"
                    required />
                </div>
              </div>
            </div>

            <div class="card my-4">
              <div class="card-header bg-primary text-white">
                <h5>è­‰ç…§è³‡è¨Š (é¸å¡«)</h5>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label for="certificateImage" class="form-label">è­‰ç…§åœ–ç‰‡ä¸Šå‚³</label>
                  <input class="form-control" type="file" id="certificateImage" name="certificate_image"
                    accept="image/*">
                  <div class="form-text">è«‹ä¸Šå‚³å–®ä¸€åœ–ç‰‡æª” (PNG, JPG)</div>
                </div>
                <div class="mb-3">
                  <label for="certificateDescription" class="form-label">è­‰ç…§åç¨±</label>
                  <textarea class="form-control" id="certificateDescription" name="certificate_description" rows="3"
                    placeholder="ä¾‹:é›»è…¦è»Ÿé«”æ‡‰ç”¨ä¹™ç´š"></textarea>
                </div>
              </div>
            </div>

            <div class="text-center mt-4">
              <button type="submit" id="submitBtn" class="btn btn-primary btn-lg">æäº¤ä¸¦ç”Ÿæˆå±¥æ­·</button>
            </div>
          </form>
        </div>

        <div class="tab-pane fade" id="records-pane">
          <div id="resumeRecords" class="p-3">
            <table class="table table-striped align-middle text-center">
              <thead class="table-light">
                <tr>
                  <th>ç”Ÿæˆæ™‚é–“</th>
                  <th>æª”å</th>
                  <th>ä¸‹è¼‰</th>
                </tr>
              </thead>
              <tbody id="recordsBody">
                <tr>
                  <td colspan="3" class="text-muted">å°šç„¡å±¥æ­·ç´€éŒ„</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ---------- å…¨åŸŸè®Šæ•¸ ---------- */
let allCoursesData = [];
const AUTO_SAVE_KEY = 'resumeFormData';

/* ---------- é–å®š/è§£é–è¡¨å–® ---------- */
function setFormReadOnly(isLocked) {
    const form = document.getElementById('resumeForm');
    if (!form) return;

    // ç¦ç”¨/å•Ÿç”¨æ‰€æœ‰è¼¸å…¥å…ƒç´ ï¼ˆä½†ä¸ç¦ç”¨ç´€éŒ„å€æŒ‰éˆ•ï¼‰
    const elements = form.querySelectorAll('input, select, textarea, button');
    elements.forEach(el => {
        // ä¸è¦æŠŠç´€éŒ„ tab çš„æŒ‰éˆ•ä¹Ÿç¦äº† (æŒ‰éˆ•å¸¶ data-bs-target çš„å¯ä»¥ä¿ç•™)
        if (el.hasAttribute('data-bs-toggle') || el.dataset.bsTarget) return;
        // Allow the submit-related button to be hidden/disabled separately
        if (el.id === 'submitBtn') return;
        el.disabled = isLocked;
    });

    // æª”æ¡ˆæ¬„ä½è¦–è¦ºä¸Šè¨­å®š
    form.querySelectorAll('input[type="file"]').forEach(f => {
        f.style.cursor = isLocked ? 'not-allowed' : '';
        f.style.backgroundColor = isLocked ? '#e9ecef' : '';
    });

    // submitBtn è™•ç†
    const submitBtn = document.getElementById('submitBtn');
    const lockMessageId = 'resumeLockMessage';
    let lockMessage = document.getElementById(lockMessageId);

    if (isLocked) {
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerText = 'å·²æäº¤ï¼ˆç­‰å¾…å¯©æ ¸ï¼‰';
        }
        if (!lockMessage) {
            lockMessage = document.createElement('div');
            lockMessage.id = lockMessageId;
            lockMessage.className = 'alert alert-info mt-3 text-center';
            lockMessage.textContent = 'å±¥æ­·å·²æäº¤ä¸¦é–å®šï¼Œç›®å‰ç‚ºå”¯è®€ç‹€æ…‹ã€‚å¦‚éœ€ä¿®æ”¹ï¼Œè«‹è¯ç¹«å°å¸«è§£é–ã€‚';
            form.appendChild(lockMessage);
        } else {
            lockMessage.style.display = 'block';
        }
    } else {
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerText = 'æäº¤ä¸¦ç”Ÿæˆå±¥æ­·';
            submitBtn.style.display = 'inline-block';
        }
        if (lockMessage) lockMessage.style.display = 'none';
    }
}

/* ---------- èª²ç¨‹è¡¨æ ¼ç›¸é—œï¼ˆä¿ç•™ä½ åŸæœ‰é‚è¼¯ï¼‰ ---------- */
function createCourseRow(course) {
    const creditsDisplay = course.credits || "";
    const isNotTaken = !!course.isNotTaken;
    const displayCredits = isNotTaken ? "0" : creditsDisplay;
    const buttonClass = isNotTaken ? "btn-warning" : "btn-outline-warning";
    const buttonText = isNotTaken ? "å·²æ¨™è¨˜æœªä¿®èª²" : "æœªä¿®èª²";

    const tr = document.createElement("tr");
    tr.dataset.originalCredits = creditsDisplay;
    tr.dataset.isNotTaken = isNotTaken;
    tr.innerHTML = `
        <td><input type="text" name="course_name[]" class="form-control form-control-sm" value="${(course.name||'').replace(/"/g,'&quot;')}" placeholder="è¼¸å…¥èª²ç¨‹åç¨±"></td>
        <td><input type="text" name="course_credits[]" class="form-control form-control-sm course-credits-input" value="${displayCredits}" placeholder="å­¸åˆ†" readonly></td>
        <td><button type="button" class="btn ${buttonClass} btn-sm toggle-not-taken">${buttonText}</button></td>
    `;
    return tr;
}
function renderCourseTable(courses) {
    const tbody = document.getElementById("courseTableBody");
    tbody.innerHTML = "";
    if (!courses || courses.length === 0) {
        const row = document.createElement("tr");
        row.innerHTML = `<td colspan="3" class="text-muted text-center">æŸ¥ç„¡èª²ç¨‹æˆ–å°šæœªæ–°å¢èª²ç¨‹</td>`;
        tbody.appendChild(row);
        return;
    }
    courses.forEach(course => tbody.appendChild(createCourseRow(course)));
    saveFormData();
}
function applyFilterAndSearch() {
    const searchTerm = document.getElementById("course-search").value.toLowerCase();
    const creditFilter = document.getElementById("credit-filter").value;
    const filteredCourses = allCoursesData.filter(course => {
        const nameMatch = (course.name || '').toLowerCase().includes(searchTerm);
        if (!nameMatch) return false;
        if (!creditFilter) return true;
        const credits = parseFloat(course.credits);
        if (isNaN(credits)) return false;
        switch (creditFilter) {
            case "1": return credits === 1;
            case "2": return credits === 2;
            case "3": return credits === 3;
            case "4+": return credits >= 4;
            default: return true;
        }
    });
    filteredCourses.sort((a,b)=> (a.name||'').localeCompare(b.name||'','zh-TW',{sensitivity:'base'}));
    renderCourseTable(filteredCourses);
}

/* ---------- è¼‰å…¥å€‹äººæ¨¡æ¿ï¼ˆå«é–å®šæª¢æŸ¥ï¼‰ ---------- */
async function loadPersonalTemplate() {
    const tbody = document.getElementById("courseTableBody");
    tbody.innerHTML = '<tr><td colspan="3" class="text-muted text-center">è¼‰å…¥ä¸­...</td></tr>';
    try {
        const res = await fetch("/api/load_personal_template");
        const result = await res.json();

        // å¦‚æœå¾Œç«¯å›å‚³ is_locked -> è¨­å®šè¡¨å–®ç‹€æ…‹
        if (result && typeof result.is_locked !== 'undefined') {
            setFormReadOnly(!!result.is_locked);
        }

        if (result.success && Array.isArray(result.courses) && result.courses.length > 0) {
            const savedData = JSON.parse(localStorage.getItem(AUTO_SAVE_KEY) || '{}');
            const savedCourses = savedData.courses || [];
            allCoursesData = result.courses.map(course => {
                const saved = savedCourses.find(c => c.name === course.name) || {};
                return {...course, isNotTaken: saved.isNotTaken || course.isNotTaken || false};
            });
            allCoursesData.sort((a,b)=> (a.name||'').localeCompare(b.name||'','zh-TW',{sensitivity:'base'}));
            renderCourseTable(allCoursesData);
        } else {
            await loadStandardCourses();
        }
    } catch (e) {
        console.error("è¼‰å…¥å€‹äººæ¨¡æ¿éŒ¯èª¤", e);
        tbody.innerHTML = '<tr><td colspan="3" class="text-danger text-center">è¼‰å…¥å¤±æ•—</td></tr>';
    }
}
async function loadStandardCourses() {
    const tbody = document.getElementById("courseTableBody");
    tbody.innerHTML = '<tr><td colspan="3" class="text-muted text-center">è¼‰å…¥æ¨™æº–èª²ç¨‹ä¸­...</td></tr>';
    try {
        const res = await fetch("/api/get_standard_courses");
        const result = await res.json();
        if (result.success && result.courses?.length) {
            allCoursesData = result.courses;
            allCoursesData.sort((a,b)=> (a.name||'').localeCompare(b.name||'','zh-TW',{sensitivity:'base'}));
            renderCourseTable(allCoursesData);
        } else {
            tbody.innerHTML = '<tr><td colspan="3" class="text-muted text-center">ç›®å‰ç„¡æ¨™æº–èª²ç¨‹</td></tr>';
        }
    } catch (e) {
        console.error(e);
        tbody.innerHTML = '<tr><td colspan="3" class="text-danger text-center">è¼‰å…¥å¤±æ•—</td></tr>';
    }
}

/* ---------- æ¨¡æ¿å„²å­˜ï¼ˆä¿ç•™ç°¡æ˜“ç‰ˆæœ¬ï¼‰ ---------- */
async function savePersonalTemplate() {
    const courses = allCoursesData.map(c => ({name:c.name, credits:c.credits, isNotTaken: c.isNotTaken||false}));
    if (courses.length === 0) return alert("è«‹å…ˆæ–°å¢è‡³å°‘ä¸€é–€èª²ç¨‹ï¼");
    try {
        const res = await fetch("/api/save_personal_template", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({display_name: "æˆ‘çš„èª²ç¨‹æ¨¡æ¿", courses})
        });
        const j = await res.json();
        if (j.success) alert("âœ… æ¨¡æ¿å·²å„²å­˜ï¼");
        else alert("âŒ å„²å­˜å¤±æ•—ï¼š" + (j.message || ""));
    } catch (e) {
        console.error(e);
        alert("âŒ å„²å­˜å¤±æ•—ï¼ˆç¶²è·¯éŒ¯èª¤ï¼‰");
    }
}

/* ---------- è­‰ç…§è¡¨æ ¼ã€LocalStorage ---------- */
function addNewCertificateRow(certData = { labor: "", international: "", domestic: "", other: "" }) {
    const tbody = document.getElementById("certificate-table-body");
    const html = `
        <tr>
          <td><input type="text" name="labor_cert[]" class="form-control" value="${(certData.labor||'').replace(/"/g,'&quot;')}" placeholder="ä¾‹:é›»è…¦è»Ÿé«”æ‡‰ç”¨ä¹™ç´š"></td>
          <td><input type="text" name="international_cert[]" class="form-control" value="${(certData.international||'').replace(/"/g,'&quot;')}" placeholder="ä¾‹:TOEIC 800åˆ†"></td>
          <td><input type="text" name="domestic_cert[]" class="form-control" value="${(certData.domestic||'').replace(/"/g,'&quot;')}" placeholder="ä¾‹:ä¸­é¤ä¸™ç´š"></td>
          <td><input type="text" name="other_cert[]" class="form-control" value="${(certData.other||'').replace(/"/g,'&quot;')}" placeholder="ä¾‹:å°ˆé¡Œç«¶è³½"></td>
          <td><button type="button" class="btn btn-outline-danger btn-sm remove-row">ç§»é™¤</button></td>
        </tr>`;
    tbody.insertAdjacentHTML("beforeend", html);
    const newRow = tbody.lastElementChild;
    newRow.querySelectorAll('input').forEach(i=>i.addEventListener('input', saveFormData));
}

function saveFormData() {
    const data = {};
    const form = document.getElementById("resumeForm");
    form.querySelectorAll('input, select, textarea').forEach(input=>{
        const name = input.name; const type = input.type;
        if (name && type !== 'file' && type !== 'submit') data[name] = input.value;
    });

    // certificates
    const certificates = [];
    document.querySelectorAll("#certificate-table-body tr").forEach(row=>{
        const get = (sel)=> (row.querySelector(sel) ? row.querySelector(sel).value : '');
        certificates.push({
            labor: get('input[name="labor_cert[]"]'),
            international: get('input[name="international_cert[]"]'),
            domestic: get('input[name="domestic_cert[]"]'),
            other: get('input[name="other_cert[]"]')
        });
    });
    data.certificates = certificates;

    // courses: only store name/credits/isNotTaken
    data.courses = allCoursesData.map(c => ({name:c.name, credits:c.credits, isNotTaken: c.isNotTaken||false}));

    localStorage.setItem(AUTO_SAVE_KEY, JSON.stringify(data));
    //console.log("Auto-saved");
}

function loadFormData() {
    const raw = localStorage.getItem(AUTO_SAVE_KEY);
    if (!raw) { addNewCertificateRow(); return; }
    try {
        const data = JSON.parse(raw);
        const form = document.getElementById("resumeForm");
        Object.keys(data).forEach(k=>{
            if (k === 'certificates' || k === 'courses') return;
            const el = form.querySelector(`[name="${k}"]`);
            if (el) { el.value = data[k]; if (k === 'conduct_score_numeric') el.dispatchEvent(new Event('input')); }
        });
        // certificates
        const tbody = document.getElementById("certificate-table-body");
        tbody.innerHTML = '';
        if (Array.isArray(data.certificates) && data.certificates.length>0) {
            data.certificates.forEach(cert=>{
                const allEmpty = Object.values(cert).every(v => !v || v.trim()==='');
                if (!allEmpty) addNewCertificateRow(cert);
            });
        }
        if (document.querySelectorAll("#certificate-table-body tr").length === 0) addNewCertificateRow();
    } catch (e) {
        console.error("è¼‰å…¥ LocalStorage å¤±æ•—", e);
        localStorage.removeItem(AUTO_SAVE_KEY);
        addNewCertificateRow();
    }
}

/* ---------- åˆ‡æ›æœªä¿®èª²æŒ‰éˆ•äº‹ä»¶ ---------- */
document.getElementById("courseTableBody").addEventListener("click", e=>{
    if (e.target.classList.contains("toggle-not-taken")) {
        const tr = e.target.closest('tr');
        const creditsInput = tr.querySelector('.course-credits-input');
        let isNotTaken = tr.dataset.isNotTaken === 'true';
        if (isNotTaken) {
            creditsInput.value = tr.dataset.originalCredits;
            e.target.classList.remove("btn-warning"); e.target.classList.add("btn-outline-warning");
            e.target.textContent = "æœªä¿®èª²"; tr.dataset.isNotTaken = false;
        } else {
            creditsInput.value = "0";
            e.target.classList.remove("btn-outline-warning"); e.target.classList.add("btn-warning");
            e.target.textContent = "å·²æ¨™è¨˜æœªä¿®èª²"; tr.dataset.isNotTaken = true;
        }
        const name = tr.querySelector('input[name="course_name[]"]').value;
        const idx = allCoursesData.findIndex(c=>c.name===name);
        if (idx>-1) allCoursesData[idx].isNotTaken = !isNotTaken;
        saveFormData();
    }
});

/* ---------- æ–°å¢/åˆªé™¤è­‰ç…§åˆ— ---------- */
document.getElementById("add-certificate-row").addEventListener("click", ()=>{ addNewCertificateRow(); saveFormData(); });
document.getElementById("certificate-table-body").addEventListener("click", e=>{
    if (e.target.classList.contains("remove-row")) {
        e.target.closest('tr').remove(); saveFormData();
        if (document.querySelectorAll("#certificate-table-body tr").length === 0) addNewCertificateRow();
    }
});

/* ---------- æ“è¡Œåˆ†æ•¸è½‰æ› ---------- */
const scoreInput = document.querySelector('input[name="conduct_score_numeric"]');
const hiddenGrade = document.getElementById("conduct_score");
function conductScoreHandler(){
    const score = parseInt(scoreInput.value);
    let grade="";
    if (score>=90) grade='å„ª'; else if (score>=80) grade='ç”²'; else if (score>=70) grade='ä¹™'; else if (score>=60) grade='ä¸™'; else if (!isNaN(score)) grade='ä¸';
    hiddenGrade.value = grade;
    saveFormData();
}
if (scoreInput) scoreInput.addEventListener('input', conductScoreHandler);

/* ---------- é€å‡ºè¡¨å–®ï¼ˆå«å‰ç«¯é–å®š / é˜²é‡è¤‡ï¼‰ ---------- */
document.getElementById("resumeForm").addEventListener("submit", async e=>{
    e.preventDefault();
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) { submitBtn.disabled = true; submitBtn.innerText = 'é€å‡ºä¸­...'; }

    const formData = new FormData(e.target);

    // collect courses
    const courseRows = document.querySelectorAll("#courseTableBody tr");
    const courses = [];
    courseRows.forEach(row=>{
        const n = row.querySelector('input[name="course_name[]"]');
        const c = row.querySelector('input[name="course_credits[]"]');
        const not = row.dataset.isNotTaken === 'true';
        if (n && c) {
            const name = n.value.trim(); const credits = c.value.trim();
            if (name && credits) courses.push({name, credits, isNotTaken: not});
        }
    });
    formData.append("courses", JSON.stringify(courses));
    formData.delete("course_name[]"); formData.delete("course_credits[]");

    try {
        const res = await fetch("/api/submit_and_generate", { method: "POST", body: formData });
        const j = await res.json();
        if (j.success) {
            // æˆåŠŸ -> é–å®šè¡¨å–®ä¸¦åˆ‡æ›åˆ°ç´€éŒ„åˆ†é 
            setFormReadOnly(true);
            // é‡æ–°è¼‰å…¥ç´€éŒ„
            await loadResumeRecords();
            // åˆ‡æ› tab
            new bootstrap.Tab(document.querySelector('[data-bs-target="#records-pane"]')).show();
            alert("âœ… å±¥æ­·å·²ç”Ÿæˆä¸¦æäº¤ï¼Œè¡¨å–®å·²é–å®šï¼ˆç­‰å¾…å¯©æ ¸ï¼‰");
        } else {
            alert("âŒ æäº¤å¤±æ•—ï¼š" + (j.message || "æœªçŸ¥éŒ¯èª¤"));
            if (submitBtn) { submitBtn.disabled = false; submitBtn.innerText = 'æäº¤ä¸¦ç”Ÿæˆå±¥æ­·'; }
        }
    } catch (e) {
        console.error(e);
        alert("âŒ ç¶²è·¯æˆ–ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦");
        if (submitBtn) { submitBtn.disabled = false; submitBtn.innerText = 'æäº¤ä¸¦ç”Ÿæˆå±¥æ­·'; }
    }
});

/* ---------- ç´€éŒ„è¼‰å…¥ï¼šå«ã€Œä¸‹è¼‰/æŸ¥çœ‹ç‹€æ…‹/åˆªé™¤ã€æŒ‰éˆ• ---------- */
async function loadResumeRecords() {
    try {
        const res = await fetch("/api/get_my_resumes");
        const result = await res.json();
        const tbody = document.getElementById("recordsBody");
        tbody.innerHTML = "";

        if (!result.success || !result.resumes?.length) {
            tbody.innerHTML = `<tr><td colspan="4" class="text-muted">å°šç„¡å±¥æ­·ç´€éŒ„</td></tr>`;
            return;
        }

        result.resumes.forEach(r=>{
            // æ ¹æ“šç‹€æ…‹æ±ºå®šæ˜¯å¦é¡¯ç¤ºåˆªé™¤æŒ‰éˆ•ï¼ˆåƒ…ã€Œrejected/é€€å›ã€æ™‚å¯åˆªé™¤ï¼‰
            const canDelete = (r.status === 'rejected' || r.status === 'é€€å›' || r.status === 'rejected-by-director'); // å®¹éŒ¯
            const statusLabel = r.status || 'unknown';
            const statusBadge = `<span class="badge bg-secondary">${statusLabel}</span>`;

            tbody.insertAdjacentHTML("beforeend", `
                <tr id="resume-row-${r.id}">
                    <td>${r.upload_time || "-"}</td>
                    <td>${r.original_filename || "æœªå‘½å"}</td>
                    <td>
                      <a href="/api/download_resume/${r.id}" class="btn btn-outline-primary btn-sm">ä¸‹è¼‰</a>
                      <button type="button" class="btn btn-info btn-sm ms-1" onclick="checkStatus(${r.id})">æŸ¥çœ‹ç‹€æ…‹</button>
                      ${ canDelete ? `<button type="button" class="btn btn-danger btn-sm ms-1" onclick="deleteResume(${r.id})">åˆªé™¤</button>` : '' }
                    </td>
                    <td>${statusBadge}</td>
                </tr>
            `);
        });
    } catch (e) {
        console.error("è¼‰å…¥ç´€éŒ„å¤±æ•—", e);
        const tbody = document.getElementById("recordsBody");
        tbody.innerHTML = `<tr><td colspan="4" class="text-danger">è¼‰å…¥ç´€éŒ„å¤±æ•—</td></tr>`;
    }
}

/* ---------- æŸ¥çœ‹å¯©æ ¸ç‹€æ…‹ï¼ˆæŒ‰éˆ•ï¼‰ ---------- */
async function checkStatus(resumeId) {
    try {
        const res = await fetch(`/api/resume_status/${resumeId}`);
        const j = await res.json();
        if (!j.success) return alert(j.message || "æŸ¥è©¢å¤±æ•—");
        const d = j.data || {};
        const status = d.status || 'æœªçŸ¥';
        const reviewed = d.reviewed_at || 'å°šæœªå¯©æ ¸';
        const comment = d.comment || d.note || 'ç„¡å‚™è¨»';
        alert(`ç‹€æ…‹ï¼š${status}\nå¯©æ ¸æ™‚é–“ï¼š${reviewed}\nå‚™è¨»ï¼š${comment}`);
    } catch (e) {
        console.error(e);
        alert("æŸ¥è©¢å¯©æ ¸ç‹€æ…‹å¤±æ•—");
    }
}

/* ---------- åˆªé™¤å±¥æ­·ï¼ˆåƒ…å…è¨±å¯åˆªé™¤çš„æƒ…æ³ï¼‰ ---------- */
async function deleteResume(resumeId) {
    if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ä»½å±¥æ­·ï¼Ÿï¼ˆåƒ…èƒ½åˆªé™¤å·²é€€å›çš„å±¥æ­·ï¼‰")) return;
    try {
        const res = await fetch(`/api/delete_resume/${resumeId}`, { method: 'DELETE' });
        const j = await res.json();
        alert(j.message || (j.success ? "å·²åˆªé™¤" : "åˆªé™¤å¤±æ•—"));
        if (j.success) {
            // ç§»é™¤åˆ—æˆ–é‡æ–°è¼‰å…¥
            const row = document.getElementById(`resume-row-${resumeId}`);
            if (row) row.remove();
            else await loadResumeRecords();
        }
    } catch (e) {
        console.error(e);
        alert("åˆªé™¤å¤±æ•—ï¼ˆç¶²è·¯éŒ¯èª¤ï¼‰");
    }
}

/* ---------- åˆå§‹åŒ– ---------- */
document.addEventListener("DOMContentLoaded", ()=>{
    // è¼‰å…¥ LocalStorage
    loadFormData();

    // ç¶å®šæœå°‹å’Œç¯©é¸
    document.getElementById("course-search").addEventListener("input", applyFilterAndSearch);
    document.getElementById("credit-filter").addEventListener("change", applyFilterAndSearch);

    // ç¶å®šè¼‰å…¥/å„²å­˜æ¨¡æ¿æŒ‰éˆ•
    document.getElementById("load-template-btn").addEventListener("click", loadPersonalTemplate);
    document.getElementById("save-template-btn").addEventListener("click", savePersonalTemplate);

    // æ–°å¢/åˆªé™¤è­‰ç…§æŒ‰éˆ•
    document.getElementById("add-certificate-row").addEventListener("click", ()=>{ addNewCertificateRow(); saveFormData(); });

    // åˆå§‹è¼‰å…¥
    loadPersonalTemplate();
    loadResumeRecords();
});
</script>
</body>
</html>