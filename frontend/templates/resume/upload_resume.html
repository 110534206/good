<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ™ºæ…§å¯¦ç¿’å¹³å° | å±¥æ­·ç®¡ç†å¹³å°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    header {
      background: #0454a3;
      color: white;
      padding: 1rem 2rem;
      text-align: center;
      font-size: 1.5rem;
    }

    body {
      font-family: "Noto Sans TC", sans-serif;
      background: #f7f9fc;
    }

    .container {
      max-width: 1000px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .card {
      border-radius: 10px;
    }

    /* èª¿æ•´è¡¨æ ¼å­—é«”å¤§å°å’Œæ¬„ä½æœ€å°å¯¬åº¦ä»¥å®¹ç´å®Œæ•´æ–‡å­— */
    table {
      font-size: 1rem;
      table-layout: fixed;
      width: 100%;
    }


    /* è­‰ç…§è¡¨æ ¼ä¸éœ€è¦é€™éº¼å¯¬ï¼Œè®“å®ƒè‡ªå‹•åˆ†é… */
    .card:has(h5.text-secondary) table th:not(:last-child) {
      min-width: unset;
    }

    .language-group label {
      font-weight: 600;
    }

    .course-scroll-container {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 5px;
    }

    /* æ–°å¢æ¨£å¼ï¼šè®“è¡¨æ ¼åœ¨æ»¾å‹•å®¹å™¨å…§é¡¯ç¤ºæ­£å¸¸ */
    .course-scroll-container table {
      margin-bottom: 0;
    }
  </style>
</head>

<body>
  <header>æ™ºæ…§å¯¦ç¿’å¹³å° | å±¥æ­·ç®¡ç†</header>

  <div class="container">
    <div class="card p-4">
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="form-tab" data-bs-toggle="tab" data-bs-target="#form-pane" type="button"
            role="tab" aria-controls="form-pane" aria-selected="true">è¡¨å–®å¡«å¯«</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="records-tab" data-bs-toggle="tab" data-bs-target="#records-pane" type="button"
            role="tab" aria-controls="records-pane" aria-selected="false">æ­·å²ç´€éŒ„</button>
        </li>
      </ul>

      <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="form-pane" role="tabpanel" aria-labelledby="form-tab" tabindex="0">
          <form id="resumeForm" enctype="multipart/form-data">

            <h5 class="mt-4 mb-3">å€‹äººåŸºæœ¬è³‡æ–™</h5>
            <input type="hidden" id="conduct_score" name="conduct_score">

            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">å§“å</label>
                <input type="text" name="name" class="form-control" required />
              </div>
              <div class="col-md-4">
                <label class="form-label">å‡ºç”Ÿæ—¥æœŸ</label>
                <input type="date" name="birth_date" class="form-control" required />
              </div>
              <div class="col-md-4">
                <label for="gender" class="form-label">æ€§åˆ¥</label>
                <select class="form-select" id="gender" name="gender" required>
                  <option value="">é¸æ“‡...</option>
                  <option value="ç”·">ç”·</option>
                  <option value="å¥³">å¥³</option>
                  <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">è¯çµ¡é›»è©±</label>
                <input type="tel" name="phone" class="form-control" required />
              </div>
              <div class="col-md-6">
                <label class="form-label">é›»å­ä¿¡ç®±</label>
                <input type="email" name="email" class="form-control" required />
              </div>
              <div class="col-12">
                <label class="form-label">åœ°å€</label>
                <input type="text" name="address" class="form-control" required />
              </div>
              <div class="col-md-6 mt-3">
                <label class="form-label">æ“è¡Œæˆç¸¾åˆ†æ•¸ (0-100)</label>
                <input type="number" name="conduct_score_numeric" class="form-control" min="0" max="100" required>
              </div>
              <div class="col-md-6 mt-3">
                <label for="photo" class="form-label">å€‹äººå¤§é ­ç…§ (JPG/PNG)</label>
                <input class="form-control" type="file" id="photo" name="photo" accept="image/*" />
              </div>
            </div>

            <div class="mb-4"></div>

            <div class="container py-4">
              <h5 class="mb-3">å·²ä¿®ç¿’å°ˆæ¥­æ ¸å¿ƒç§‘ç›®</h5>

              <div class="mb-3">
                <button id="update-template-btn" class="btn btn-warning"
                  style="display:none; font-size: 1rem;"> âš ï¸ è«‹æ›´æ–°æœ€æ–°èª²ç¨‹è³‡æ–™
                </button>
                <button type="button" class="btn btn-outline-primary btn-sm" id="load-template-btn">æŸ¥çœ‹æˆ‘çš„èª²ç¨‹</button>
                <button type="button" class="btn btn-outline-success btn-sm" id="save-template-btn">å„²å­˜</button>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <input type="text" id="course-search" class="form-control form-control-sm" placeholder="ğŸ” æŸ¥è©¢èª²ç¨‹åç¨±">
                </div>
                <div class="col-md-6">
                  <select id="credit-filter" class="form-select form-select-sm">
                    <option value="">æ‰€æœ‰å­¸åˆ†æ•¸</option>
                    <option value="1">1 å­¸åˆ†</option>
                    <option value="2">2 å­¸åˆ†</option>
                    <option value="3">3 å­¸åˆ†</option>
                    <option value="4+">4 å­¸åˆ†åŠä»¥ä¸Š</option>
                  </select>
                </div>
              </div>

              <div class="course-scroll-container">
                <table class="table table-bordered align-middle">
                  <thead>
                    <tr>
                      <th style="width: 50%;">èª²ç¨‹åç¨±</th>
                      <th style="width: 25%;">å­¸åˆ†æ•¸</th>
                      <th style="width: 25%;">ç‹€æ…‹</th>
                    </tr>
                  </thead>
                  <tbody id="courseTableBody">
                    <tr>
                      <td colspan="3" class="text-muted text-center">è¼‰å…¥ä¸­...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>


            <div class="card p-4 mb-3">
              <h5 class="text-secondary">ç›¸é—œè­‰ç…§</h5>
              <table class="table table-bordered text-center align-middle">
                <thead class="table-light">
                  <tr>
                    <th>å‹å‹•éƒ¨è­‰ç…§</th>
                    <th>åœ‹éš›è­‰ç…§</th>
                    <th>åœ‹å…§è­‰ç…§</th>
                    <th>å…¶ä»–è­‰ç…§</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="certificate-table-body">
                  <tr>
                    <td><input type="text" name="labor_cert[]" class="form-control" placeholder="ä¾‹:é›»è…¦è»Ÿé«”æ‡‰ç”¨ä¹™ç´š"></td>
                    <td><input type="text" name="international_cert[]" class="form-control" placeholder="ä¾‹:TOEIC 800åˆ†">
                    </td>
                    <td><input type="text" name="domestic_cert[]" class="form-control" placeholder="ä¾‹:ä¸­é¤ä¸™ç´š"></td>
                    <td><input type="text" name="other_cert[]" class="form-control" placeholder="ä¾‹:å°ˆé¡Œç«¶è³½"></td>
                    <td><button type="button" class="btn btn-outline-danger btn-sm remove-row">ç§»é™¤</button></td>
                  </tr>
                </tbody>
              </table> <button type="button" class="btn btn-sm btn-outline-success"
                id="add-certificate-row">ï¼‹æ–°å¢ä¸€åˆ—</button>
            </div>
            <h5 class="mt-4 mb-3">èªæ–‡èƒ½åŠ›</h5>
            <div class="row mb-3">
              <div class="col-md-3 language-group">
                <label>è‹±èª</label>
                <select class="form-select form-select-sm" name="lang_en_level">
                  <option value="">æœªé¸</option>
                  <option value="ç²¾é€š">ç²¾é€š</option>
                  <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                  <option value="ç•¥æ‡‚">ç•¥æ‡‚</option>
                </select>
              </div>
              <div class="col-md-3 language-group">
                <label>å°èª</label>
                <select class="form-select form-select-sm" name="lang_tw_level">
                  <option value="">æœªé¸</option>
                  <option value="ç²¾é€š">ç²¾é€š</option>
                  <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                  <option value="ç•¥æ‡‚">ç•¥æ‡‚</option>
                </select>
              </div>
              <div class="col-md-3 language-group">
                <label>æ—¥èª</label>
                <select class="form-select form-select-sm" name="lang_jp_level">
                  <option value="">æœªé¸</option>
                  <option value="ç²¾é€š">ç²¾é€š</option>
                  <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                  <option value="ç•¥æ‡‚">ç•¥æ‡‚</option>
                </select>
              </div>
              <div class="col-md-3 language-group">
                <label>å®¢èª</label>
                <select class="form-select form-select-sm" name="lang_hk_level">
                  <option value="">æœªé¸</option>
                  <option value="ç²¾é€š">ç²¾é€š</option>
                  <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                  <option value="ç•¥æ‡‚">ç•¥æ‡‚</option>
                </select>
              </div>
            </div>

            <div class="mb-4"></div>

            <div class="card p-4 mb-3">
              <h5 class="text-info">è‡ªå‚³</h5>
              <textarea name="autobiography" rows="6" class="form-control" placeholder="è«‹æè¿°å®¶åº­ç”Ÿæ´»ã€æ±‚å­¸ç¶“éã€å€‹äººå°ˆé•·ã€æœªä¾†è¦åŠƒç­‰..."
                required></textarea>
            </div>

            <div class="card p-4 mb-3">
              <h5 class="text-primary">æˆç¸¾å–®ä¸Šå‚³</h5>
              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label">ä¸Šå‚³å­¸æœŸæˆç¸¾å–® (JPG/PNG)</label>
                  <input type="file" name="transcript_file" class="form-control" accept="image/jpeg, image/png"
                    required />
                </div>
              </div>
            </div>

            <div class="card my-4">
              <div class="card-header bg-primary text-white">
                <h5>è­‰ç…§è³‡è¨Š (é¸å¡«)</h5>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label for="certificateImage" class="form-label">è­‰ç…§åœ–ç‰‡ä¸Šå‚³</label>
                  <input class="form-control" type="file" id="certificateImage" name="certificate_image"
                    accept="image/*">
                  <div class="form-text">è«‹ä¸Šå‚³å–®ä¸€åœ–ç‰‡æª” (PNG, JPG)</div>
                </div>
                <div class="mb-3">
                  <label for="certificateDescription" class="form-label">è­‰ç…§åç¨±</label>
                  <textarea class="form-control" id="certificateDescription" name="certificate_description" rows="3"
                    placeholder="ä¾‹:é›»è…¦è»Ÿé«”æ‡‰ç”¨ä¹™ç´š"></textarea>
                </div>
              </div>
            </div>

            <div class="text-center mt-4">
              <button type="submit" class="btn btn-primary btn-lg">æäº¤ä¸¦ç”Ÿæˆå±¥æ­·</button>
            </div>
          </form>
        </div>

        <div class="tab-pane fade" id="records-pane">
          <div id="resumeRecords" class="p-3">
            <table class="table table-striped align-middle text-center">
              <thead class="table-light">
                <tr>
                  <th>ç”Ÿæˆæ™‚é–“</th>
                  <th>æª”å</th>
                  <th>ä¸‹è¼‰</th>
                </tr>
              </thead>
              <tbody id="recordsBody">
                <tr>
                  <td colspan="3" class="text-muted">å°šç„¡å±¥æ­·ç´€éŒ„</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const STORAGE_KEY = 'resumeFormDraft';
    let allCoursesData = []; // å„²å­˜æ‰€æœ‰èª²ç¨‹çš„åŸå§‹è³‡æ–™ï¼Œç”¨æ–¼ç¯©é¸å’ŒæŸ¥è©¢

    // -----------------------------------------------------------
    // ğŸ§© å‡½å¼ï¼šç€è¦½å™¨è‡ªå‹•å„²å­˜ (localStorage)
    // -----------------------------------------------------------

    // è¼”åŠ©å‡½å¼ï¼šæ–°å¢ä¸€åˆ—ç©ºçš„è­‰ç…§è¡¨æ ¼è¡Œ
    function addEmptyCertificateRow() {
      const tbody = document.getElementById("certificate-table-body");
      tbody.insertAdjacentHTML("beforeend", `
        <tr>
            <td><input type="text" name="labor_cert[]" class="form-control" placeholder="ä¾‹:é›»è…¦è»Ÿé«”æ‡‰ç”¨ä¹™ç´š"></td>
            <td><input type="text" name="international_cert[]" class="form-control" placeholder="ä¾‹:TOEIC 800åˆ†"></td>
            <td><input type="text" name="domestic_cert[]" class="form-control" placeholder="ä¾‹:ä¸­é¤ä¸™ç´š"></td>
            <td><input type="text" name="other_cert[]" class="form-control" placeholder="ä¾‹:å°ˆé¡Œç«¶è³½"></td>
            <td><button type="button" class="btn btn-outline-danger btn-sm remove-row">ç§»é™¤</button></td>
        </tr>`);
    }

    // å„²å­˜è‰ç¨¿
    function saveDraft() {
      const form = document.getElementById('resumeForm');
      const data = {};

      // å„²å­˜åŸºæœ¬è¡¨å–®æ¬„ä½ (æ’é™¤ file æ¬„ä½)
      const inputs = form.querySelectorAll('input:not([type="file"]), select, textarea');
      inputs.forEach(input => {
        if (input.name) {
          data[input.name] = input.value;
        }
      });

      // å„²å­˜å‹•æ…‹è­‰ç…§è¡¨æ ¼è³‡æ–™
      const certRows = document.querySelectorAll('#certificate-table-body tr');
      data.certificates = [];
      certRows.forEach(row => {
        const rowData = {
          labor: row.querySelector('input[name="labor_cert[]"]').value,
          international: row.querySelector('input[name="international_cert[]"]').value,
          domestic: row.querySelector('input[name="domestic_cert[]"]').value,
          other: row.querySelector('input[name="other_cert[]"]').value
        };
        // åªæœ‰åœ¨ä»»ä¸€æ¬„ä½æœ‰å€¼æ™‚æ‰å„²å­˜è©²è¡Œ
        if (Object.values(rowData).some(val => val.trim() !== '')) {
          data.certificates.push(rowData);
        }
      });

      // å„²å­˜ç•¶å‰èª²ç¨‹è³‡æ–™ (allCoursesData)
      data.allCoursesData = allCoursesData;

      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        // console.log("âœ… è¡¨å–®è‰ç¨¿å·²è‡ªå‹•å„²å­˜ã€‚"); // é¿å…åˆ·é »
      } catch (e) {
        console.error("âŒ å„²å­˜è‰ç¨¿å¤±æ•—:", e);
      }
    }

    // è¼‰å…¥è‰ç¨¿
    function loadDraft() {
      try {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (!savedData) return false;

        const data = JSON.parse(savedData);
        const form = document.getElementById('resumeForm');
        let courseDataLoaded = false;

        // è¼‰å…¥åŸºæœ¬è¡¨å–®æ¬„ä½
        for (const name in data) {
          if (name === 'certificates' || name === 'allCoursesData') continue;

          const input = form.querySelector(`[name="${name}"]`);
          if (input) {
            input.value = data[name];
          }
        }

        // è§¸ç™¼æ“è¡Œæˆç¸¾è½‰æ›
        const scoreInput = form.querySelector('input[name="conduct_score_numeric"]');
        if (scoreInput) {
          scoreInput.dispatchEvent(new Event('input'));
        }

        // è¼‰å…¥å‹•æ…‹è­‰ç…§è¡¨æ ¼è³‡æ–™
        if (data.certificates) {
          const tbody = document.getElementById('certificate-table-body');
          // æ¸…ç©ºé è¨­çš„ç¬¬ä¸€è¡Œ (ä»¥åŠæ‰€æœ‰ç¾æœ‰è¡Œ)
          tbody.innerHTML = '';

          if (data.certificates.length > 0) {
            data.certificates.forEach(rowData => {
              const newRowHTML = `
                  <tr>
                      <td><input type="text" name="labor_cert[]" class="form-control" value="${rowData.labor || ''}" placeholder="ä¾‹:é›»è…¦è»Ÿé«”æ‡‰ç”¨ä¹™ç´š"></td>
                      <td><input type="text" name="international_cert[]" class="form-control" value="${rowData.international || ''}" placeholder="ä¾‹:TOEIC 800åˆ†"></td>
                      <td><input type="text" name="domestic_cert[]" class="form-control" value="${rowData.domestic || ''}" placeholder="ä¾‹:ä¸­é¤ä¸™ç´š"></td>
                      <td><input type="text" name="other_cert[]" class="form-control" value="${rowData.other || ''}" placeholder="ä¾‹:å°ˆé¡Œç«¶è³½"></td>
                      <td><button type="button" class="btn btn-outline-danger btn-sm remove-row">ç§»é™¤</button></td>
                  </tr>`;
              tbody.insertAdjacentHTML('beforeend', newRowHTML);
            });
          } else {
            // å¦‚æœè‰ç¨¿ä¸­æ²’æœ‰è­‰ç…§ (ç©ºé™£åˆ—)ï¼Œå‰‡æ–°å¢ä¸€åˆ—ç©ºçš„çµ¦ä½¿ç”¨è€…å¡«å¯«
            addEmptyCertificateRow();
          }
        }


        // è¼‰å…¥èª²ç¨‹è³‡æ–™
        if (data.allCoursesData && data.allCoursesData.length > 0) {
          allCoursesData = data.allCoursesData;
          renderCourseTable(allCoursesData);
          courseDataLoaded = true;
          console.log("âœ… èª²ç¨‹è‰ç¨¿å·²è¼‰å…¥ã€‚");
        }

        console.log("âœ… è¡¨å–®è‰ç¨¿å·²è¼‰å…¥ã€‚");
        return courseDataLoaded;

      } catch (e) {
        console.error("âŒ è¼‰å…¥è‰ç¨¿å¤±æ•—:", e);
        localStorage.removeItem(STORAGE_KEY);
        return false;
      }
    }

    // æ¸…é™¤è‰ç¨¿
    function clearDraft() {
      localStorage.removeItem(STORAGE_KEY);
      console.log("ğŸ—‘ï¸ è¡¨å–®è‰ç¨¿å·²æ¸…é™¤ã€‚");
    }

    // -----------------------------------------------------------
    // ğŸ§© èª²ç¨‹ç›¸é—œå‡½å¼ (ä¿æŒä¸è®Š)
    // -----------------------------------------------------------

    // ğŸ§© å»ºç«‹èª²ç¨‹åˆ—
    function createCourseRow(course) {
      const creditsDisplay = course.credits || "";
      const isNotTaken = course.isNotTaken || false;
      const displayCredits = isNotTaken ? "0" : creditsDisplay;
      const buttonClass = isNotTaken ? "btn-warning" : "btn-outline-warning";
      const buttonText = isNotTaken ? "å·²æ¨™è¨˜æœªä¿®èª²" : "æœªä¿®èª²";

      const tr = document.createElement("tr");
      tr.dataset.originalCredits = creditsDisplay;
      tr.dataset.isNotTaken = isNotTaken;

      tr.innerHTML = `
        <td><input type="text" name="course_name[]" class="form-control form-control-sm" value="${course.name || ""}" placeholder="è¼¸å…¥èª²ç¨‹åç¨±"></td>
        <td><input type="text" name="course_credits[]" class="form-control form-control-sm course-credits-input" value="${displayCredits}" placeholder="å­¸åˆ†" readonly></td>
        <td><button type="button" class="btn ${buttonClass} btn-sm toggle-not-taken">${buttonText}</button></td>
      `;
      return tr;
    }

    // ğŸ§© æ¸²æŸ“èª²ç¨‹è¡¨æ ¼
    function renderCourseTable(courses) {
      const tbody = document.getElementById("courseTableBody");
      tbody.innerHTML = "";

      if (courses.length === 0) {
        const row = document.createElement("tr");
        row.innerHTML = `<td colspan="3" class="text-muted text-center">æŸ¥ç„¡èª²ç¨‹æˆ–å°šæœªæ–°å¢èª²ç¨‹</td>`;
        tbody.appendChild(row);
        return;
      }

      courses.forEach(course => {
        tbody.appendChild(createCourseRow(course));
      });
    }

    // ğŸ§© åŸ·è¡ŒæŸ¥è©¢å’Œç¯©é¸
    function applyFilterAndSearch() {
      const searchTerm = document.getElementById("course-search").value.toLowerCase();
      const creditFilter = document.getElementById("credit-filter").value;

      const filteredCourses = allCoursesData.filter(course => {
        const nameMatch = course.name.toLowerCase().includes(searchTerm);
        if (!nameMatch) return false;

        if (!creditFilter) return true;

        const credits = parseFloat(course.credits);
        if (isNaN(credits)) return false;

        switch (creditFilter) {
          case "1":
            return credits === 1;
          case "2":
            return credits === 2;
          case "3":
            return credits === 3;
          case "4+":
            return credits >= 4;
          default:
            return true;
        }
      });
      renderCourseTable(filteredCourses);
    }

    // ğŸ§© å¾å¾Œç«¯è¼‰å…¥å­¸ç”Ÿå€‹äººæ¨¡æ¿ (å·²æ–°å¢æ§åˆ¶æ›´æ–°æŒ‰éˆ•é‚è¼¯)
    async function loadPersonalTemplate() {
      const tbody = document.getElementById("courseTableBody");
      // ã€æ–°å¢ã€‘å–å¾—æ›´æ–°æŒ‰éˆ•çš„ DOM å…ƒç´ 
      const updateButton = document.getElementById('update-template-btn');

      tbody.innerHTML = '<tr><td colspan="3" class="text-muted text-center">è¼‰å…¥ä¸­...</td></tr>';
      updateButton.style.display = 'none'; // ã€æ–°å¢ã€‘è¼‰å…¥æ™‚å…ˆéš±è—æŒ‰éˆ•

      try {
        const res = await fetch("api/load_personal_template");
        const result = await res.json();

        if (result.success && Array.isArray(result.courses)) {

          // ã€æ–°å¢ã€‘æ ¹æ“šå¾Œç«¯ needs_update æ——æ¨™é¡¯ç¤ºæˆ–éš±è—æŒ‰éˆ•
          if (result.needs_update) {
            updateButton.style.display = '';
          } else {
            updateButton.style.display = 'none';
          }

          if (result.courses.length > 0) {
            allCoursesData = result.courses.map((course) => ({
              ...course,
              isNotTaken: course.isNotTaken || false // ç¢ºä¿ç‹€æ…‹å­˜åœ¨
            }));
            renderCourseTable(allCoursesData);
          } else {
            console.log("ç„¡å€‹äººæ¨¡æ¿ï¼Œæ”¹è¼‰å…¥æ¨™æº–èª²ç¨‹");
            await loadStandardCourses();
          }
        } else {
          console.log("ç„¡å€‹äººæ¨¡æ¿æˆ–è¼‰å…¥éŒ¯èª¤ï¼Œå˜—è©¦è¼‰å…¥æ¨™æº–èª²ç¨‹");
          await loadStandardCourses();
        }
      } catch (err) {
        console.error("âŒ è¼‰å…¥å€‹äººæ¨¡æ¿å¤±æ•—:", err);
        tbody.innerHTML = '<tr><td colspan="3" class="text-danger text-center">è¼‰å…¥å¤±æ•—</td></tr>';
        allCoursesData = [];
      }
    }

    // é»æ“Šæ›´æ–°æŒ‰éˆ• â†’ é‡æ–°è¼‰å…¥æ¨™æº–èª²ç¨‹ä¸¦è¦†è“‹æ¨¡æ¿
    document.getElementById('update-template-btn').addEventListener('click', async () => {
      if (!confirm('è«‹æ›´æ–°è‡³æœ€æ–°èª²ç¨‹')) return;

      const res = await fetch('/api/get_standard_courses');
      const data = await res.json();

      if (data.success) {
        // æ›´æ–° allCoursesData
        allCoursesData = data.courses.map((course, index) => ({
          ...course,
          id: `std_${index}`,
          isNotTaken: course.isNotTaken || false
        }));
        renderCourseTable(allCoursesData);
        document.getElementById('update-template-btn').style.display = 'none';
      }
    });

    // ğŸ§© è‹¥ç„¡å€‹äººæ¨¡æ¿ï¼Œè¼‰å…¥ç³»çµ±é è¨­èª²ç¨‹
    async function loadStandardCourses() {
      const tbody = document.getElementById("courseTableBody");
      tbody.innerHTML = '<tr><td colspan="3" class="text-muted text-center">è¼‰å…¥æ¨™æº–èª²ç¨‹ä¸­...</td></tr>';
      try {
        const res = await fetch("/api/get_standard_courses");
        const result = await res.json();
        if (result.success && result.courses?.length > 0) {
          allCoursesData = result.courses.map((course, index) => ({
            ...course,
            id: `std_${index}`,
            isNotTaken: course.isNotTaken || false
          }));
          applyFilterAndSearch();
        } else {
          tbody.innerHTML = '<tr><td colspan="3" class="text-muted text-center">ç›®å‰ç„¡æ¨™æº–èª²ç¨‹</td></tr>';
          allCoursesData = [];
        }
      } catch (err) {
        console.error("âŒ è¼‰å…¥æ¨™æº–èª²ç¨‹å¤±æ•—:", err);
        tbody.innerHTML = '<tr><td colspan="3" class="text-danger text-center">è¼‰å…¥å¤±æ•—</td></tr>';
        allCoursesData = [];
      }
    }

    // ğŸ§© å„²å­˜ç‚ºå€‹äººæ¨¡æ¿ 
    async function savePersonalTemplate() {
      const rows = document.querySelectorAll("#courseTableBody tr");
      const courses = [];
      rows.forEach(row => {
        const nameInput = row.querySelector('input[name="course_name[]"]');
        const creditsInput = row.querySelector('input[name="course_credits[]"]');
        const isNotTaken = row.dataset.isNotTaken === 'true';

        if (nameInput && creditsInput) {
          const name = nameInput.value.trim();
          const credits = row.dataset.originalCredits; // å¾ data-original-credits ç²å–åŸå§‹å­¸åˆ†æ•¸

          if (name) courses.push({ name, credits, isNotTaken });
        }
      });

      if (courses.length === 0) {
        alert("è«‹å…ˆæ–°å¢è‡³å°‘ä¸€é–€èª²ç¨‹ï¼");
        return;
      }

      const res = await fetch("/api/save_personal_template", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          display_name: "æˆ‘çš„èª²ç¨‹æ¨¡æ¿",
          courses: courses
        })
      });
      const result = await res.json();
      if (result.success) {
        alert("âœ… æ¨¡æ¿å·²å„²å­˜ï¼");
      } else {
        alert("âŒ å„²å­˜å¤±æ•—ï¼š" + (result.message || ""));
      }
    }

    // ğŸ§© åˆªé™¤/æœªä¿®èª² ç›¸é—œçš„äº‹ä»¶è™•ç†
    document.getElementById("courseTableBody").addEventListener("click", e => {
      if (e.target.classList.contains("toggle-not-taken")) {
        const tr = e.target.closest("tr");
        const creditsInput = tr.querySelector(".course-credits-input");
        let isNotTaken = tr.dataset.isNotTaken === 'true';

        if (isNotTaken) {
          creditsInput.value = tr.dataset.originalCredits;
          e.target.classList.remove("btn-warning");
          e.target.classList.add("btn-outline-warning");
          e.target.textContent = "æœªä¿®èª²";
          tr.dataset.isNotTaken = false;
        } else {
          creditsInput.value = "0";
          e.target.classList.remove("btn-outline-warning");
          e.target.classList.add("btn-warning");
          e.target.textContent = "å·²æ¨™è¨˜æœªä¿®èª²";
          tr.dataset.isNotTaken = true;
        }

        // åŒæ­¥æ›´æ–° allCoursesData ä¸­çš„ç‹€æ…‹ä¸¦å„²å­˜è‰ç¨¿
        const courseName = tr.querySelector('input[name="course_name[]"]').value;
        const index = allCoursesData.findIndex(c => c.name === courseName);
        if (index > -1) {
          allCoursesData[index].isNotTaken = !isNotTaken;
        } else {
          tr.dataset.isNotTaken = !isNotTaken;
        }
        saveDraft(); // æ–°å¢: æ¯æ¬¡ä¿®æ”¹èª²ç¨‹ç‹€æ…‹å¾Œè‡ªå‹•å„²å­˜
      }
    });

    // ğŸ§© ç¶å®šæŸ¥è©¢å’Œç¯©é¸äº‹ä»¶
    document.getElementById("course-search").addEventListener("input", applyFilterAndSearch);
    document.getElementById("credit-filter").addEventListener("change", applyFilterAndSearch);

    // ğŸ§© ç¶å®šæŒ‰éˆ•äº‹ä»¶
    document.getElementById("load-template-btn").addEventListener("click", loadPersonalTemplate);
    document.getElementById("save-template-btn").addEventListener("click", savePersonalTemplate);


    // æ–°å¢ / ç§»é™¤ã€Œç›¸é—œè­‰ç…§ã€åˆ— (å¢åŠ è‡ªå‹•å„²å­˜)
    document.getElementById("add-certificate-row").addEventListener("click", () => {
      addEmptyCertificateRow();
      saveDraft(); // æ–°å¢: æ–°å¢åˆ—å¾Œè‡ªå‹•å„²å­˜
    });

    document.getElementById("certificate-table-body").addEventListener("click", e => {
      if (e.target.classList.contains("remove-row")) {
        e.target.closest("tr").remove();
        saveDraft(); // æ–°å¢: ç§»é™¤åˆ—å¾Œè‡ªå‹•å„²å­˜
      }
    });

    // æ“è¡Œæˆç¸¾è½‰æ›
    const scoreInput = document.querySelector('input[name="conduct_score_numeric"]');
    const hiddenGrade = document.getElementById("conduct_score");
    scoreInput.addEventListener("input", () => {
      const score = parseInt(scoreInput.value);
      let grade = "";
      if (score >= 90) grade = "å„ª";
      else if (score >= 80) grade = "ç”²";
      else if (score >= 70) grade = "ä¹™";
      else if (score >= 60) grade = "ä¸™";
      else if (score >= 0) grade = "ä¸";
      hiddenGrade.value = grade;
    });

    // è¡¨å–®é€å‡º (å¢åŠ æ¸…é™¤è‰ç¨¿)
    document.getElementById("resumeForm").addEventListener("submit", async e => {
      e.preventDefault();
      const formData = new FormData(e.target);

      // æ”¶é›†å‹•æ…‹çš„èª²ç¨‹è³‡æ–™ä¸¦æ·»åŠ åˆ° FormData
      const courseRows = document.querySelectorAll("#courseTableBody tr");
      const courses = [];

      courseRows.forEach(row => {
        const nameInput = row.querySelector('input[name="course_name[]"]');
        const creditsInput = row.querySelector('input[name="course_credits[]"]');
        const isNotTaken = row.dataset.isNotTaken === 'true';

        if (nameInput && creditsInput) {
          const name = nameInput.value.trim();
          const credits = creditsInput.value.trim();

          if (name && credits) {
            courses.push({
              name: name,
              credits: credits,
              isNotTaken: isNotTaken
            });
          }
        }
      });


      formData.append("courses", JSON.stringify(courses));

      // ç§»é™¤èˆŠçš„èª²ç¨‹ç›¸é—œæ¬„ä½ï¼Œå› ç‚ºæˆ‘å€‘çµ±ä¸€ç”¨ JSON å‚³é
      formData.delete("course_name[]");
      formData.delete("course_credits[]");

      const res = await fetch("/api/submit_and_generate", {
        method: "POST",
        body: formData
      });
      const result = await res.json();
      if (result.success) {
        alert("âœ… å±¥æ­·å·²ç”Ÿæˆï¼Œå¯æ–¼ç´€éŒ„é ç±¤ä¸‹è¼‰");
        clearDraft(); // <--- æˆåŠŸæäº¤å¾Œï¼Œæ¸…é™¤è‰ç¨¿
        // åˆ‡æ›åˆ°ç´€éŒ„é ç±¤
        new bootstrap.Tab(document.querySelector('[data-bs-target="#records-pane"]')).show();
        await loadResumeRecords();
      } else alert("âŒ æäº¤å¤±æ•—ï¼š" + (result.message || "æœªçŸ¥éŒ¯èª¤"));
    });

    // è¼‰å…¥å±¥æ­·ç´€éŒ„
    async function loadResumeRecords() {
      const res = await fetch("/api/get_my_resumes");
      const result = await res.json();
      const tbody = document.getElementById("recordsBody");
      tbody.innerHTML = "";
      if (!result.success || !result.resumes?.length)
        return tbody.innerHTML = `<tr><td colspan="3" class="text-muted">å°šç„¡å±¥æ­·ç´€éŒ„</td></tr>`;

      result.resumes.forEach(r => {
        tbody.insertAdjacentHTML("beforeend", `
            <tr>
              <td>${r.upload_time || "-"}</td>
              <td>${r.original_filename || "æœªå‘½å"}</td>
              <td><a href="/api/download_resume/${r.id}" class="btn btn-outline-primary btn-sm">ä¸‹è¼‰</a></td>
            </tr>
          `);
      });
    }

    // -----------------------------------------------------------
    // ğŸ§© é é¢åˆå§‹åŒ–
    // -----------------------------------------------------------

    document.addEventListener("DOMContentLoaded", () => {
      // 1. è¼‰å…¥è¡¨å–®è‰ç¨¿ (å€‹äººè³‡æ–™ã€è­‰ç…§ã€èªæ–‡ã€è‡ªå‚³)
      const coursesLoadedFromDraft = loadDraft();

      // 2. å¦‚æœèª²ç¨‹è³‡æ–™ *æ²’æœ‰* å¾è‰ç¨¿è¼‰å…¥ï¼Œæ‰åŸ·è¡ŒåŸæœ¬çš„ loadPersonalTemplate() é‚è¼¯
      if (!coursesLoadedFromDraft) {
        loadPersonalTemplate();
      }

      // 3. ç¶å®šè¡¨å–®è¼¸å…¥äº‹ä»¶ä»¥è§¸ç™¼è‡ªå‹•å„²å­˜ (å¿½ç•¥åœ–ç‰‡æª”æ¡ˆ)
      const form = document.getElementById('resumeForm');
      form.addEventListener('input', saveDraft);
      form.addEventListener('change', saveDraft); // è™•ç† select, date ç­‰æ¬„ä½

      // 4. è¼‰å…¥å±¥æ­·ä¸‹è¼‰ç´€éŒ„
      loadResumeRecords();
    });
  </script>
</body>

</html>