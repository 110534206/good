<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§å¯¦ç¿’å¹³å° | AI å±¥æ­·ä¿®æ”¹å¹³å°</title>
    <style>
        :root {
            --primary-blue: #0069ff;
            --light-gray-border: #e0e0e0;
            --bg-color: #f9f9f9;
            --container-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            color: #333;
        }

        .main-header {
            background: #0454a3;
            color: white;
            text-align: center;
            font-size: 1.5rem;
            padding: 1rem 0; 
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
        }

        .ai-container {
            width: 100%;
            max-width: 800px;
            background-color: #ffffff;
            border-radius: 24px;
            padding: 32px;
            box-shadow: var(--container-shadow);
            border: 1px solid var(--light-gray-border);
            margin-top: 65px;
        }

        textarea {
            width: 100%;
            height: 200px;
            margin-bottom: 10px;
            padding: 15px;
            box-sizing: border-box;
            border: 1px solid var(--light-gray-border);
            border-radius: 12px;
            resize: vertical;
            font-size: 16px;
            line-height: 1.6;
            background-color: #fafafa;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(0, 105, 255, 0.1);
        }

        /* ğŸŒŸ [æ–°æ¨£å¼] ç¯©é¸å™¨å®¹å™¨ (è®“è—¥ä¸¸ä¸¦æ’) */
        .filter-container {
            display: flex;
            flex-wrap: wrap;
            /* åœ¨å°è¢å¹•ä¸Šæ›è¡Œ */
            gap: 10px;
            /* è—¥ä¸¸ä¹‹é–“çš„é–“è· */
            margin-bottom: 20px;
        }

        /* ğŸŒŸ [æ–°æ¨£å¼] æ¨¡ä»¿ Canva çš„ã€Œè—¥ä¸¸ã€ä¸‹æ‹‰é¸å–® */
        .filter-pill {
            flex-grow: 1;
            /* è®“å®ƒå€‘å¹³å‡åˆ†é…å¯¬åº¦ */
            min-width: 180px;
            /* æœ€å°å¯¬åº¦ */
            padding: 10px 15px;
            padding-right: 40px;
            /* ç‚ºç®­é ­é¨°å‡ºç©ºé–“ */
            font-size: 14px;
            font-weight: 500;
            color: #333;
            border: 1px solid var(--light-gray-border);
            border-radius: 20px;
            /* è—¥ä¸¸çš„åœ“è§’ */
            background-color: #f5f5f5;
            /* è—¥ä¸¸èƒŒæ™¯è‰² */
            appearance: none;
            /* ç§»é™¤ç€è¦½å™¨é è¨­ç®­é ­ */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23666%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-13%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2013l128%20128c3.6%203.6%207.8%205.4%2013%205.4s9.4-1.8%2013-5.4l128-128c3.6-3.6%205.4-7.8%205.4-13%200-5-1.8-9.4-5.4-13z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 15px top 50%;
            background-size: 10px auto;
            cursor: pointer;
        }

        .filter-pill:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        button {
            width: 100%;
            padding: 14px 25px;
            cursor: pointer;
            background: linear-gradient(90deg, #007BFF, var(--primary-blue));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        button:hover {
            opacity: 0.9;
            box-shadow: 0 4px 8px rgba(0, 105, 255, 0.2);
        }

        .section-title {
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.1em;
            font-weight: 600;
            color: #555;
        }

        #revisedResume {
            white-space: pre-wrap;
            background-color: #f5f5f5;
            padding: 15px;
            border: 1px solid #e0e0e0;
            min-height: 100px;
            margin-top: 10px;
            border-radius: 12px;
            line-height: 1.7;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-blue);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <header class="main-header">AI å±¥æ­·ä¿®æ”¹æœå‹™</header>
    <div class="ai-container">
        <div class="section-title">è¼¸å…¥æ‚¨çš„å±¥æ­·è‰ç¨¿ï¼š</div>
        <textarea id="resumeInput" placeholder="ç³»çµ±å°‡è‡ªå‹•è¼‰å…¥æ‚¨å·²ä¸Šå‚³å±¥æ­·ä¸­çš„è‡ªå‚³å…§å®¹ï¼Œæ‚¨ä¹Ÿå¯ä»¥æ‰‹å‹•ç·¨è¼¯..."></textarea>

        <div class="section-title">è«‹é¸æ“‡ä¿®æ”¹é¸é …ï¼š</div>

        <div class="filter-container">
            <select id="editStyle" class="filter-pill">
                <option value="polish">ä»»å‹™ï¼šå±¥æ­·ç¾åŒ–</option>
                <option value="concise">ä»»å‹™ï¼šæ–‡æ¡ˆç²¾ç°¡</option>
                <option value="keyword_focus">ä»»å‹™ï¼šé—œéµå­—å°å‘</option>
            </select>

            <select id="toneStyle" class="filter-pill">
                <option value="professional">èªæ°£ï¼šå°ˆæ¥­æ­£å¼</option>
                <option value="friendly">èªæ°£ï¼šè¦ªåˆ‡éš¨å’Œ</option>
                <option value="cautious">èªæ°£ï¼šè¬¹æ…çš„</option>
                <option value="academic">èªæ°£ï¼šå­¸è¡“çš„</option>
            </select>
        </div>

        <button onclick="reviseResume()">âš¡ ä½¿ç”¨ AI ä¿®æ”¹å±¥æ­·</button>

        <div class="section-title">ä¿®æ”¹å¾Œçš„å±¥æ­·ï¼š</div>

        <div id="loadingSpinner" class="loader"></div>

        <div id="revisedResume">AI ä¿®æ”¹å¾Œçš„å…§å®¹å°‡é¡¯ç¤ºåœ¨é€™è£¡...</div>
        
        <div style="margin-top: 20px;">
            <button onclick="importToResumeForm()" style="background: linear-gradient(90deg, #007BFF, #0069ff); width: 100%; padding: 14px 25px; cursor: pointer; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; transition: all 0.3s ease;">
                ğŸ“¥ å°å…¥è‡³å±¥æ­·ä¸Šå‚³é é¢
            </button>
        </div>
    </div>

    <script>
        // ğŸŒŸ [æ–°åŠŸèƒ½] é é¢è¼‰å…¥æ™‚è‡ªå‹•å¾è³‡æ–™åº«ç²å–è‡ªå‚³å…§å®¹
        async function loadAutobiography() {
            try {
                const res = await fetch('/api/get_resume_data');
                const result = await res.json();
                
                if (result.success && result.data && result.data.studentInfo) {
                    const autobiography = result.data.studentInfo.autobiography || '';
                    const resumeInput = document.getElementById('resumeInput');
                    
                    if (autobiography && resumeInput) {
                        resumeInput.value = autobiography;
                        console.log('âœ… å·²è‡ªå‹•è¼‰å…¥è³‡æ–™åº«ä¸­çš„è‡ªå‚³å…§å®¹');
                    } else if (!autobiography) {
                        console.log('â„¹ï¸ è³‡æ–™åº«ä¸­æš«ç„¡è‡ªå‚³å…§å®¹ï¼Œè«‹æ‰‹å‹•è¼¸å…¥æˆ–å…ˆä¸Šå‚³å±¥æ­·');
                    }
                } else {
                    console.log('â„¹ï¸ å°šæœªä¸Šå‚³å±¥æ­·ï¼Œè«‹å…ˆå®Œæˆå±¥æ­·ä¸Šå‚³');
                }
            } catch (error) {
                console.error('âŒ è¼‰å…¥è‡ªå‚³å…§å®¹å¤±æ•—:', error);
            }
        }

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        window.addEventListener('DOMContentLoaded', loadAutobiography);

        async function reviseResume() {
            const resumeInput = document.getElementById('resumeInput').value;
            const revisedResumeDiv = document.getElementById('revisedResume');
            const loadingSpinner = document.getElementById('loadingSpinner');

            // ğŸŒŸ [æ–°åŠŸèƒ½] è®€å–å…©å€‹ä¸‹æ‹‰é¸å–®çš„å€¼
            const editStyle = document.getElementById('editStyle').value;
            const toneStyle = document.getElementById('toneStyle').value;

            // ğŸŒŸ [æ–°åŠŸèƒ½] å¦‚æœ textarea ç‚ºç©ºï¼Œä»ç„¶å…è¨±ç™¼é€è«‹æ±‚ï¼ˆå¾Œç«¯æœƒè‡ªå‹•å¾è³‡æ–™åº«è®€å–è‡ªå‚³ï¼‰
            // å¦‚æœç”¨æˆ¶æ‰‹å‹•æ¸…ç©ºäº† textareaï¼Œå¾Œç«¯æœƒè‡ªå‹•å¾è³‡æ–™åº«è®€å–è‡ªå‚³
            if (resumeInput.trim() === "") {
                console.log("â„¹ï¸ è¼¸å…¥æ¡†ç‚ºç©ºï¼Œå¾Œç«¯å°‡è‡ªå‹•å¾è³‡æ–™åº«è®€å–è‡ªå‚³å…§å®¹");
            }

            revisedResumeDiv.innerHTML = "";
            loadingSpinner.style.display = 'block';

            try {
                // ========================================================
                // ğŸ”´ [å·²ä¿®æ­£]
                // éŒ¯èª¤å¯«æ³•: 'http://localhost:5000/api/revise-resume'
                // æ­£ç¢ºå¯«æ³•: ä½¿ç”¨ç›¸å°è·¯å¾‘ï¼Œè®“ç€è¦½å™¨è‡ªå‹•æŠ“å–ç•¶å‰ç¶²åŸŸ
                // =================================M=======================
                const response = await fetch('/api/revise-resume', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    // ğŸŒŸ [æ–°åŠŸèƒ½] å°‡å±¥æ­·å’Œå…©å€‹é¸é …ä¸€èµ·ç™¼é€åˆ°å¾Œç«¯
                    body: JSON.stringify({
                        resumeText: resumeInput,
                        style: editStyle,
                        tone: toneStyle
                    })
                });

                if (!response.body) {
                    throw new Error("ä¼ºæœå™¨æ²’æœ‰è¿”å›å¯è®€å–çš„ä¸²æµã€‚");
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let done = false;
                let fullText = '';

                while (!done) {
                    const { value, done: readerDone } = await reader.read();
                    done = readerDone;

                    if (value) {
                        const chunk = decoder.decode(value, { stream: true });
                        fullText += chunk;
                        revisedResumeDiv.innerHTML = fullText;
                    }
                }
                fullText += decoder.decode();
                
                // ğŸŒŸ [æ–°åŠŸèƒ½] éæ¿¾æ‰å¯èƒ½çš„è§£é‡‹æ€§æ–‡å­—
                // ç§»é™¤å¸¸è¦‹çš„è§£é‡‹æ€§å‰ç¶´
                const prefixesToRemove = [
                    /^æ²’å•é¡Œ[ï¼!]?[ï¼Œ,]?é€™æ˜¯ç‚ºæ‚¨æ”¹å¯«çš„[ï¼š:]/i,
                    /^é€™æ˜¯ç‚ºæ‚¨æ”¹å¯«çš„[ï¼š:]/i,
                    /^ä»¥ä¸‹æ˜¯[ï¼š:]/i,
                    /^ä»¥ä¸‹æ˜¯ç‚ºæ‚¨æ”¹å¯«çš„[ï¼š:]/i,
                    /^é€™æ˜¯[ï¼š:]/i,
                    /^ä»¥ä¸‹æ˜¯æ”¹å¯«å¾Œçš„ç‰ˆæœ¬[ï¼š:]/i,
                    /^æ”¹å¯«å¾Œçš„ç‰ˆæœ¬[ï¼š:]/i,
                    /^ä»¥ä¸‹æ˜¯æ”¹å¯«å…§å®¹[ï¼š:]/i,
                    /^æ”¹å¯«å…§å®¹[ï¼š:]/i
                ];
                
                let cleanedText = fullText.trim();
                for (const prefix of prefixesToRemove) {
                    cleanedText = cleanedText.replace(prefix, '').trim();
                }
                
                // å¦‚æœéæ¿¾å¾Œå…§å®¹ç‚ºç©ºï¼Œä½¿ç”¨åŸå§‹å…§å®¹
                if (!cleanedText) {
                    cleanedText = fullText.trim();
                }
                
                revisedResumeDiv.innerHTML = cleanedText;

            } catch (error) {
                // ========================================================
                // ğŸ”´ [å·²ä¿®æ­£]
                // ä¿®æ­£éŒ¯èª¤è¨Šæ¯ï¼Œç§»é™¤éŒ¯èª¤çš„ "localhost:3000" æç¤º
                // ========================================================
                console.error('é€£ç·šæˆ–è®€å–ä¸²æµéŒ¯èª¤:', error);
                revisedResumeDiv.innerHTML = `AI æœå‹™é€£ç·šå¤±æ•—ï¼šç„¡æ³•é€£ç·šåˆ°å¾Œç«¯ä¼ºæœå™¨ã€‚è«‹æª¢æŸ¥ä¼ºæœå™¨ç‹€æ…‹ä¸¦ç¨å¾Œå†è©¦ã€‚`;
                revisedResumeDiv.style.color = 'red';
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }

        // ğŸŒŸ [æ–°åŠŸèƒ½] å°‡ç¾åŒ–å¾Œçš„è‡ªå‚³å°å…¥è‡³å±¥æ­·ä¸Šå‚³é é¢
        function importToResumeForm() {
            const revisedResumeDiv = document.getElementById('revisedResume');
            // å˜—è©¦å¤šç¨®æ–¹å¼ç²å–æ–‡æœ¬å…§å®¹ï¼ˆåªç²å–æ–°çš„ç¾åŒ–å¾Œå…§å®¹ï¼‰
            let revisedText = '';
            if (revisedResumeDiv) {
                // æª¢æŸ¥æ˜¯å¦åŒ…å«æç¤ºæ–‡å­—ï¼Œå¦‚æœæœ‰å‰‡è¡¨ç¤ºé‚„æ²’æœ‰ç¾åŒ–çµæœ
                const placeholderText = 'AI ä¿®æ”¹å¾Œçš„å…§å®¹å°‡é¡¯ç¤ºåœ¨é€™è£¡...';
                const currentContent = revisedResumeDiv.textContent || revisedResumeDiv.innerText || '';
                
                if (currentContent.trim() === placeholderText || currentContent.trim() === '') {
                    alert('âŒ è«‹å…ˆä½¿ç”¨ AI ç¾åŒ–è‡ªå‚³ï¼Œç„¶å¾Œå†å°å…¥ï¼');
                    return;
                }
                
                revisedText = currentContent;
                // å¦‚æœåŒ…å« HTML æ¨™ç±¤ï¼Œå˜—è©¦æå–ç´”æ–‡æœ¬
                if (revisedResumeDiv.innerHTML && revisedResumeDiv.innerHTML.includes('<')) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = revisedResumeDiv.innerHTML;
                    revisedText = tempDiv.textContent || tempDiv.innerText || '';
                }
            }
            
            const trimmedText = revisedText.trim();
            
            if (!trimmedText || trimmedText === 'AI ä¿®æ”¹å¾Œçš„å…§å®¹å°‡é¡¯ç¤ºåœ¨é€™è£¡...') {
                alert('âŒ æ²’æœ‰å¯å°å…¥çš„å…§å®¹ï¼è«‹å…ˆä½¿ç”¨ AI ç¾åŒ–è‡ªå‚³ã€‚');
                return;
            }

            // å°‡ç¾åŒ–å¾Œçš„æ–°è‡ªå‚³ä¿å­˜åˆ° LocalStorageï¼Œä¾›å±¥æ­·ä¸Šå‚³é é¢ä½¿ç”¨
            const importData = {
                autobiography: trimmedText,
                timestamp: Date.now(),
                source: 'ai_edit_resume',
                isNew: true  // æ¨™è¨˜ç‚ºæ–°çš„è‡ªå‚³
            };
            
            try {
                localStorage.setItem('ai_polished_autobiography', JSON.stringify(importData));
                console.log('âœ… æ–°çš„è‡ªå‚³å·²ä¿å­˜åˆ° LocalStorageï¼Œé•·åº¦:', trimmedText.length);
                
                // é©—è­‰ä¿å­˜æ˜¯å¦æˆåŠŸ
                const savedData = localStorage.getItem('ai_polished_autobiography');
                if (!savedData) {
                    throw new Error('LocalStorage ä¿å­˜å¤±æ•—');
                }
                
                // è©¢å•ç”¨æˆ¶æ˜¯å¦è¦è·³è½‰åˆ°å±¥æ­·ä¸Šå‚³é é¢
                if (confirm('âœ… æ–°çš„è‡ªå‚³å·²æº–å‚™å°å…¥ï¼\n\næ˜¯å¦è¦è·³è½‰åˆ°å±¥æ­·ä¸Šå‚³é é¢ï¼Ÿ')) {
                    // æ·»åŠ  URL åƒæ•¸æ¨™è¨˜ï¼Œç¢ºä¿é é¢çŸ¥é“è¦å°å…¥æ–°çš„è‡ªå‚³
                    window.location.href = '/upload_resume?import_autobiography=true';
                } else {
                    alert('âœ… æ–°çš„è‡ªå‚³å·²ä¿å­˜ï¼Œæ‚¨å¯ä»¥åœ¨å±¥æ­·ä¸Šå‚³é é¢æŸ¥çœ‹å°å…¥çš„è‡ªå‚³å…§å®¹ã€‚\n\næç¤ºï¼šåˆ·æ–°å±¥æ­·ä¸Šå‚³é é¢å³å¯è‡ªå‹•å°å…¥ã€‚');
                }
            } catch (error) {
                console.error('ä¿å­˜å°å…¥æ•¸æ“šå¤±æ•—:', error);
                alert('âŒ ä¿å­˜å¤±æ•—ï¼š' + error.message + '\n\nè«‹æª¢æŸ¥ç€è¦½å™¨çš„ LocalStorage æ˜¯å¦å¯ç”¨ã€‚');
            }
        }
    </script>

</body>

</html>