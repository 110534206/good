<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>智慧實習平台 | 廠商履歷審查</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    header {
      background: linear-gradient(135deg, #0055a8 0%, #006acb 50%, #004f94 100%);
      border-bottom: none; position: sticky; top: 0; z-index: 10;
      box-shadow: 0 8px 20px rgba(0, 68, 148, 0.35);
    }
    .topbar {
      max-width: 1800px; margin: 0 auto; padding: 18px 24px;
      display: flex; align-items: center; justify-content: space-between; color: #fff;
    }
    .topbar-left { display: flex; align-items: center; }
    .topbar-left #menu-btn {
      width: 30px; height: 22px; cursor: pointer; display: flex; flex-direction: column;
      justify-content: space-between; background: none; border: none; padding: 0;
    }
    .topbar-left #menu-btn span {
      display: block; width: 100%; height: 3px; background-color: white; border-radius: 2px; transition: all 0.3s ease;
    }
    .topbar h1 { font-size: 1.5rem; margin: 0; text-align: center; color: #fff; flex: 1; }
    body { font-family: "Noto Sans TC", sans-serif; background: #ffffff; margin: 0; padding: 0; }
    main { max-width: 1800px; margin: 24px auto 60px; padding: 0 24px; display: flex; flex-direction: column; gap: 24px; }
    .panel {
      background: #ffffff; border-radius: 16px; padding: 24px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08); border: 1px solid #e2e8f0; margin-bottom: 32px;
    }
    .panel-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 16px; }
    .panel-header h2 { font-size: 1.2rem; margin: 0; }
    .table-wrapper { overflow-x: visible; width: 100%; }
    .table-wrapper table tbody tr:hover { background: rgba(15, 23, 42, 0.02); }
    .table thead th { text-align: left; background-color: #fafafb; }
    .table tbody td { text-align: left; vertical-align: middle; }
    .table tbody tr td:nth-child(1), .table tbody tr td:nth-child(2), 
    .table tbody tr td:nth-child(3), .table tbody tr td:nth-child(4) { vertical-align: top; }
    
    /* --- 狀態標籤樣式設定 --- */
    .status-badge { font-size: 0.9em; padding: 0.3em 0.6em; border-radius: 0.5rem; display: inline-block; font-weight: 600; }
    
    /* 通過：綠底白字 */
    .status-badge.bg-success { color: #fff; background-color: #198754; }
    
    /* 退件：紅底白字 */
    .status-badge.bg-danger { color: #fff; background-color: #dc3545; }
    
    /* 待審核：藍底白字 */
    .status-badge.bg-info { color: #fff; background-color: #0dcaf0; }
    
    .status-badge.bg-secondary { color: #fff; background-color: #6c757d; }
    
    /* 面試中：中橙色底白字 */
    .status-badge.bg-interviewing { color: #fff; background-color: #ff8c42; }
    
    /* 已面試：中藍色底白字 */
    .status-badge.bg-completed { color: #fff; background-color: #4a9eff; }
    
    #commentInput { width: 100%; height: 180px; resize: vertical; padding: 0.5rem; font-size: 1rem; line-height: 1.4; }
    
    /* 學生選單樣式 */
    #interviewStudents {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
    }
    .student-checkbox-item {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .student-checkbox-item:hover {
      background-color: #f0f9ff;
    }
    .student-checkbox-item input[type="checkbox"] {
      margin-right: 10px;
      cursor: pointer;
      width: 18px;
      height: 18px;
    }
    .student-checkbox-item label {
      margin: 0;
      cursor: pointer;
      flex: 1;
      user-select: none;
    }
    
    #side-menu {
      position: fixed; top: 0; left: 0; height: 100vh; width: 320px; max-width: 80vw;
      background-color: rgba(10, 10, 10, 0.95); backdrop-filter: blur(6px);
      box-shadow: 3px 0 12px rgba(0, 0, 0, 0.6); padding: 2rem 1.5rem;
      transform: translateX(-100%); transition: transform 0.3s ease-in-out; z-index: 1300;
      display: flex; flex-direction: column; align-items: flex-start; color: #fff; user-select: none;
    }
    #side-menu.open { transform: translateX(0); }
    #side-menu h2 {
      margin: 0.5rem 0 1.5rem;
      font-weight: 700;
      font-size: 1.6rem;
    }

    #close-btn {
      position: absolute;
      top: 2rem;
      right: 1.6rem;
      font-size: 2.2rem;
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      line-height: 1;
      width: 2.4rem;
      height: 2.4rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #side-menu a {
      display: block; width: 100%; padding: 0.6rem 0; font-size: 1.1rem; color: #e2e8f0;
      text-decoration: none; border-radius: 4px; transition: background-color 0.2s ease;
    }
    #side-menu a:hover { background-color: rgba(255, 255, 255, 0.18); color: #fff; }
    
    /* 模態框背景遮罩樣式 - 灰黑色 */
    .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.6) !important;
      opacity: 1 !important;
    }
    
    .modal-backdrop.show {
      opacity: 1 !important;
      background-color: rgba(0, 0, 0, 0.6) !important;
    }
    
    /* 確保模態框顯示時背景變暗 */
    body.modal-open {
      overflow: hidden;
    }
    
    /* 當面試表單模態框打開時，確保背景遮罩正確顯示 */
    #interviewFormModal.show ~ .modal-backdrop,
    #interviewFormModal.show + .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.6) !important;
      opacity: 1 !important;
    }
  </style>
</head>

<body>
  <header>
    <div class="topbar">
      <div class="topbar-left">
        <button id="menu-btn" title="選單" role="button" tabindex="0" aria-label="開啟側邊選單">
          <span></span><span></span><span></span>
        </button>
      </div>
      <h1>廠商履歷審查</h1>
      <div style="width: 30px;"></div>
    </div>
  </header>
  <main>
    <section class="panel" aria-label="履歷列表">
      <div class="panel-header">
      </div>
      <div style="display: flex; flex-wrap: wrap; gap: 16px; align-items: center; margin-bottom: 16px;">
        <select id="departmentFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">所有學年</option>
        </select>
        <select id="classFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">所有班級</option>
        </select>
        <select id="companyNameFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">所有公司</option>
        </select>
        <select id="companyFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">所有職缺</option>
        </select>
        <select id="statusFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">所有狀態</option>
          <option value="pending">待審核</option>
          <option value="approved">通過</option>
          <option value="rejected">退件</option>
        </select>
        <select id="interviewStatusFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">所有面試狀態</option>
          <option value="none">未面試</option>
          <option value="interviewing">面試中</option>
          <option value="completed">已面試</option>
        </select>
        <input type="text" id="searchBox" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 200px; flex: 1;" placeholder="搜尋帳號/檔案" />
      </div>
      
      <div style="margin-bottom: 16px;">
        <button id="interviewScheduleBtn" class="btn btn-primary" style="padding: 10px 20px; border-radius: 8px; font-weight: 600;">
          面試排程
        </button>
      </div>

      <div class="table-wrapper">
        <table style="width: 100%; border-collapse: collapse;">
          <thead style="background: #f1f5f9;">
            <tr>
              <th style="padding: 14px 16px; font-weight: 600; width: 50px;">
                <input type="checkbox" id="selectAllCheckbox" title="全選/取消全選" style="cursor: pointer; width: 18px; height: 18px;">
              </th>
              <th style="padding: 14px 16px; font-weight: 600;">學生帳號</th>
              <th style="padding: 14px 16px; font-weight: 600;">姓名</th>
              <th style="padding: 14px 16px; font-weight: 600;">上傳時間</th>
              <th style="padding: 14px 16px; font-weight: 600;">檔案名稱</th>
              <th style="padding: 14px 16px; font-weight: 600;">職缺</th>
              <th style="padding: 14px 16px; font-weight: 600;">狀態</th>
              <th style="padding: 14px 16px; font-weight: 600;" id="commentHeader">廠商留言</th>
              <th style="padding: 14px 16px; font-weight: 600;">操作</th>
            </tr>
          </thead>
          <tbody id="resumeTableBody">
            <tr><td colspan="9" style="padding: 14px 16px; text-align: center; color: #64748b;">載入中...</td></tr>
          </tbody>
        </table>
      </div>
      <nav><ul class="pagination justify-content-center mt-3" id="pagination"></ul></nav>
    </section>
  </main>

  <div class="modal fade" id="commentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="commentModalLabel">編輯留言</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body"><textarea id="commentInput"></textarea></div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button class="btn btn-primary" id="saveCommentBtn">送出</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="interviewScheduleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">面試排程</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="calendarContainer" style="padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <button id="prevMonthBtn" class="btn btn-outline-secondary" style="padding: 8px 16px;">‹ 上個月</button>
              <h4 id="currentMonthYear" style="margin: 0; font-weight: 600;"></h4>
              <button id="nextMonthBtn" class="btn btn-outline-secondary" style="padding: 8px 16px;">下個月 ›</button>
            </div>
            <div id="calendar" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="interviewFormModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">新增面試排程</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="interviewForm">
            <div class="mb-3">
              <label for="interviewDate" class="form-label" style="font-weight: 600;">面試日期</label>
              <input type="text" class="form-control" id="interviewDate" readonly style="background-color: #f9fafb;">
            </div>
            <div class="mb-3">
              <label class="form-label" style="font-weight: 600;">面試時間</label>
              <div style="display: flex; gap: 12px; align-items: center;">
                <div style="flex: 1;">
                  <label for="interviewTimeStart" class="form-label" style="font-weight: 500; font-size: 0.9rem; margin-bottom: 4px;">開始時間</label>
                  <input type="time" class="form-control" id="interviewTimeStart" required>
                </div>
                <div style="flex: 1;">
                  <label for="interviewTimeEnd" class="form-label" style="font-weight: 500; font-size: 0.9rem; margin-bottom: 4px;">結束時間</label>
                  <input type="time" class="form-control" id="interviewTimeEnd" required>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                <label for="interviewStudents" class="form-label" style="font-weight: 600; margin: 0;">面試學生</label>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="selectAllStudentsBtn" style="font-size: 0.85rem; padding: 4px 12px;">全選</button>
              </div>
              <div id="interviewStudents" style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; max-height: 200px; overflow-y: auto; background-color: #fff;">
                <!-- 學生選項將由 JavaScript 動態填充 -->
              </div>
              <small class="form-text text-muted" style="font-size: 0.85rem; margin-top: 4px; display: block;">
                已選擇 <span id="selectedStudentsCount">0</span> 位學生
              </small>
            </div>
            <div class="mb-3">
              <label for="interviewLocation" class="form-label" style="font-weight: 600;">面試地點</label>
              <select class="form-control" id="interviewLocation" required>
                <option value="">請選擇面試地點</option>
                <option value="康寧大學科辦">康寧大學科辦</option>
                <option value="other">其他</option>
              </select>
              <input type="text" class="form-control mt-2" id="interviewLocationOther" placeholder="請輸入其他面試地點" style="display: none;">
            </div>
            <div class="mb-3">
              <label for="interviewNotes" class="form-label" style="font-weight: 600;">面試須知</label>
              <textarea class="form-control" id="interviewNotes" rows="5" placeholder="請輸入面試須知，例如：攜帶文件、注意事項等..." style="resize: vertical;"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="saveInterviewBtn">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <nav id="side-menu" aria-hidden="true" role="navigation" aria-label="功能選單">
    <button id="close-btn" aria-label="關閉功能選單">×</button>
    <h2>功能選單</h2>
    <a href="/vendor_home">首頁</a>
    <a href="/profile">個人資料</a>
    <a href="/vendor_review_resume">學生履歷審核</a>
    <a href="/manage_positions">職位需求管理</a>
    <a href="/confirm_matching">媒合結果</a>
    <a href="/publish_announcements">發布公告</a>
    <a href="/reviews_resumes_notifications">查看履歷與通知</a>
    <a href="/logout">登出</a>
  </nav>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let allResumes = [];
    let currentResumeId = null;
    let currentPreferenceId = null; 
    let currentPage = 1;
    const rowsPerPage = 10;
    // 紀錄已經按下「面試」的申請（以 preferenceId 或 resumeId 作為 key）
    const interviewedSet = new Set();
    // 面試地點下拉選單用的公司名稱列表（從履歷資料收集）
    let interviewCompanyNames = [];

    // 定義狀態顏色，approved 對應 success (綠色)
    function statusColor(status) {
      return { 'pending': 'info', 'approved': 'success', 'rejected': 'danger', 'submitted': 'info', 'uploaded': 'info' }[status] || 'secondary';
    }

    // 定義狀態文字，approved 對應 "通過"
    function mapStatus(status) {
      return { 'pending': '待審核', 'approved': '通過', 'rejected': '退件', 'submitted': '待審核', 'uploaded': '待審核' }[status] || '待審核';
    }

    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    // 獲取包含 company_id 的 API URL
    function getResumeApiUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const targetCompanyId = urlParams.get('company_id');
      let apiUrl = '/vendor/api/resumes';
      if (targetCompanyId) {
        apiUrl += `?company_id=${targetCompanyId}`;
      }
      return apiUrl;
    }

    let userRole = null;

    document.addEventListener("DOMContentLoaded", () => {
      const urlParams = new URLSearchParams(window.location.search);
      const targetCompanyId = urlParams.get('company_id');
      const targetStatus = urlParams.get('status');

      initMenu();

      // 先獲取用戶角色，然後載入資料
      fetch('/api/profile')
        .then(res => res.json())
        .then(profileData => {
          userRole = profileData.success && profileData.user ? profileData.user.role : 'vendor';
          
          // 廠商專用 API（老師也可以訪問）
          const apiUrl = getResumeApiUrl();

          // 根據角色決定如何獲取職缺列表
          let positionsPromise;
          if (userRole === 'vendor') {
            // 廠商調用 vendor API
            positionsPromise = fetch('/vendor/api/positions').then(res => res.ok ? res.json() : {success:true, items:[]});
          } else if (userRole === 'teacher' || userRole === 'ta') {
            // 老師調用 public API
            if (targetCompanyId) {
              // 如果有 company_id，獲取該公司的職缺
              positionsPromise = fetch(`/api/public/company/${targetCompanyId}`).then(async res => {
                if (!res.ok) return {success:true, items:[]};
                const r = await res.json();
                return {success:true, items: (r.jobs||[]).map(j=>({id:j.id, title:j.title}))};
              });
            } else {
              // 否則獲取所有職缺
              positionsPromise = fetch('/api/public/positions').then(res => res.ok ? res.json() : {success:true, items:[]});
            }
          } else {
            positionsPromise = Promise.resolve({success:true, items:[]});
          }
          
          return Promise.all([
            fetch(apiUrl).then(res => res.ok ? res.json() : {success:false}),
            Promise.resolve({success:true, companies:[]}),
            positionsPromise
          ]);
        })
        .then(([resumeData, companyData, positionData]) => {
          if (resumeData.success) {
            allResumes = resumeData.resumes || [];
            
            // 根據後端返回的資料初始化 interviewedSet
            interviewedSet.clear();
            allResumes.forEach(r => {
              if (r.has_interview || r.interview_completed) {
                const key = String(r.preference_id || r.preferenceId || r.id);
                interviewedSet.add(key);
              }
            });

            // 從履歷資料蒐集公司名稱（用於面試地點下拉選單）
            const companyNameSet = new Set();
            allResumes.forEach(r => {
              if (r.company_name && r.company_name.trim()) {
                companyNameSet.add(r.company_name.trim());
              }
            });
            interviewCompanyNames = Array.from(companyNameSet);
            
            populateFilters(allResumes, companyData, positionData);

            if (targetStatus) {
               const statusSelect = document.getElementById('statusFilter');
               const mapped = (targetStatus === 'submitted' || targetStatus === 'uploaded') ? 'pending' : targetStatus;
               if(statusSelect) statusSelect.value = mapped;
            }

            applyFilters();
          } else {
            allResumes = [];
            renderTable([]);
          }
        });

      document.getElementById("departmentFilter").addEventListener("change", applyFilters);
      document.getElementById("classFilter").addEventListener("change", applyFilters);
      document.getElementById("companyNameFilter").addEventListener("change", applyFilters);
      document.getElementById("companyFilter").addEventListener("change", applyFilters);
      document.getElementById("statusFilter").addEventListener("change", applyFilters);
      document.getElementById("interviewStatusFilter").addEventListener("change", applyFilters);
      document.getElementById("searchBox").addEventListener("input", applyFilters);
      document.getElementById("saveCommentBtn").addEventListener("click", saveComment);
      document.getElementById("interviewScheduleBtn").addEventListener("click", openInterviewSchedule);
      document.getElementById("prevMonthBtn").addEventListener("click", () => changeMonth(-1));
      document.getElementById("nextMonthBtn").addEventListener("click", () => changeMonth(1));
      document.getElementById("saveInterviewBtn").addEventListener("click", saveInterviewSchedule);
      
      // 全選/取消全選功能
      const selectAllCheckbox = document.getElementById("selectAllCheckbox");
      if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener("change", function() {
          const rowCheckboxes = document.querySelectorAll(".row-checkbox");
          rowCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
          });
        });
      }
      
      // 當個別 checkbox 改變時，更新全選 checkbox 狀態
      document.addEventListener("change", function(e) {
        if (e.target.classList.contains("row-checkbox")) {
          const rowCheckboxes = document.querySelectorAll(".row-checkbox");
          const checkedCount = document.querySelectorAll(".row-checkbox:checked").length;
          if (selectAllCheckbox) {
            selectAllCheckbox.checked = checkedCount === rowCheckboxes.length && rowCheckboxes.length > 0;
            selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < rowCheckboxes.length;
          }
        }
      });
      
      // 全選/取消全選學生功能
      const selectAllStudentsBtn = document.getElementById("selectAllStudentsBtn");
      if (selectAllStudentsBtn) {
        selectAllStudentsBtn.addEventListener("click", function() {
          const studentsContainer = document.getElementById("interviewStudents");
          if (studentsContainer) {
            const checkboxes = studentsContainer.querySelectorAll('.student-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            // 如果全部已選中，則取消全選；否則全選
            checkboxes.forEach(checkbox => {
              checkbox.checked = !allChecked;
            });
            updateSelectedStudentsCount();
          }
        });
      }
    });

    function initMenu() {
      const sideMenu = document.getElementById('side-menu');
      const menuBtn = document.getElementById('menu-btn');
      const closeBtn = document.getElementById('close-btn');
      
      if (menuBtn) {
        menuBtn.addEventListener('click', () => {
          sideMenu.classList.add('open');
          sideMenu.setAttribute('aria-hidden', 'false');
        });
      }
      
      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          sideMenu.classList.remove('open');
          sideMenu.setAttribute('aria-hidden', 'true');
        });
      }
      
      document.addEventListener('click', (event) => {
        if (sideMenu && !sideMenu.contains(event.target) && menuBtn && !menuBtn.contains(event.target)) {
          sideMenu.classList.remove('open');
          sideMenu.setAttribute('aria-hidden', 'true');
        }
      });
    }

    function populateFilters(data, companyData, positionData) {
      const deptSelect = document.getElementById("departmentFilter");
      deptSelect.innerHTML = `<option value="">所有學年</option><option value="1132">1132</option><option value="1142">1142</option>`;
      
      const classSelect = document.getElementById("classFilter");
      classSelect.innerHTML = `<option value="">所有班級</option>`;
      const classSet = new Set();
      data.forEach(r => { if(r.className) classSet.add(r.className); });
      classSet.add("忠班"); classSet.add("孝班");
      Array.from(classSet).sort().forEach(c => {
         if(c !== '五孝') classSelect.innerHTML += `<option value="${c}">${c}</option>`;
      });

      const companyNameSelect = document.getElementById("companyNameFilter");
      companyNameSelect.innerHTML = `<option value="">所有公司</option>`;
      const companySet = new Set();
      data.forEach(r => { 
        if(r.company_name && r.company_name.trim()) {
          companySet.add(r.company_name.trim());
        }
      });
      Array.from(companySet).sort().forEach(company => {
        companyNameSelect.innerHTML += `<option value="${escapeHtml(company)}">${escapeHtml(company)}</option>`;
      });

      const companySelect = document.getElementById("companyFilter");
      companySelect.innerHTML = `<option value="">所有職缺</option>`;
      const jobSet = new Set();
      
      // 從 API 返回的職缺資料中提取職缺（直接從 internship_companies 和 internship_jobs 資料表抓取）
      // positionData.items 已經過濾了該廠商的公司，所以只會出現自己的職缺
      if (positionData && positionData.items && positionData.items.length > 0) {
          positionData.items.forEach(job => {
              const jobTitle = job.title || job.job_title || '';
              if (jobTitle && jobTitle.trim()) {
                  jobSet.add(jobTitle.trim());
              }
          });
      }
      
      // 將所有職缺排序後加入選單
      Array.from(jobSet).sort().forEach(j => {
          companySelect.innerHTML += `<option value="${escapeHtml(j)}">${escapeHtml(j)}</option>`;
      });
    }

    function applyFilters() {
      currentPage = 1;
      const dept = document.getElementById("departmentFilter").value.trim();
      const cls = document.getElementById("classFilter").value.trim();
      const companyNameFilter = document.getElementById("companyNameFilter").value.trim();
      const jobFilter = document.getElementById("companyFilter").value.trim();
      const status = document.getElementById("statusFilter").value.trim();
      const interviewStatus = document.getElementById("interviewStatusFilter").value.trim();
      const keyword = document.getElementById("searchBox").value.trim().toLowerCase();

      const filtered = allResumes.filter(r => {
        const matchesDept = !dept || r.department === dept;
        const matchesClass = !cls || r.className === cls;
        const matchesKeyword = (r.username && r.username.toLowerCase().includes(keyword)) ||
                               (r.original_filename && r.original_filename.toLowerCase().includes(keyword));
        
        let matchesCompanyName = true;
        if (companyNameFilter) {
          const companyName = (r.company_name || '').trim();
          matchesCompanyName = companyName === companyNameFilter;
        }
        
        let matchesJob = true;
        if (jobFilter) {
            const jobs = (r.job_title || r.jobTitle || '').toLowerCase();
            matchesJob = jobs.includes(jobFilter.toLowerCase()) || (r.job_id && String(r.job_id) === jobFilter);
        }

        let matchesStatus = true;
        if (status) {
           const statusStr = r.application_statuses || r.display_status || r.status || '';
           matchesStatus = statusStr === status;  // 使用嚴格相等，確保精確匹配
        }

        // 面試狀態篩選
        let matchesInterviewStatus = true;
        if (interviewStatus) {
          const key = (r.preference_id || r.preferenceId || r.id);
          const hasInterviewed = interviewedSet.has(String(key)) || r.has_interview || false;
          const isInterviewCompleted = r.interview_completed || false;
          
          if (interviewStatus === 'none') {
            // 未面試：沒有面試記錄
            matchesInterviewStatus = !hasInterviewed && !isInterviewCompleted;
          } else if (interviewStatus === 'interviewing') {
            // 面試中：有面試記錄但未完成
            matchesInterviewStatus = hasInterviewed && !isInterviewCompleted;
          } else if (interviewStatus === 'completed') {
            // 已面試：已完成面試
            matchesInterviewStatus = isInterviewCompleted;
          }
        }

        return matchesDept && matchesClass && matchesCompanyName && matchesJob && matchesStatus && matchesInterviewStatus && matchesKeyword;
      });

      renderTable(filtered);
    }

    function renderTable(resumes) {
      const tbody = document.getElementById("resumeTableBody");
      tbody.innerHTML = "";
      if (resumes.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; color: #64748b; padding: 16px;">目前沒有資料</td></tr>`;
        document.getElementById("pagination").innerHTML = "";
        return;
      }

      const filterStatus = document.getElementById("statusFilter").value.trim(); 
      const filterJob = document.getElementById("companyFilter").value.trim(); 

      let allRowsData = [];

      resumes.forEach(r => {
        // 直接使用最新的志願序資料（後端已處理）
        const comp = r.company_name || '—';
        const job = r.job_title || r.jobTitle || '—';
        const pid = r.preference_id || null;
        const st = r.application_statuses || r.display_status || r.status || 'pending';
        const cm = r.comment || '';

        // 狀態篩選
        if (filterStatus && st !== filterStatus) return;
        
        // 職缺篩選
        if (filterJob && !job.includes(filterJob) && filterJob !== (r.job_id ? String(r.job_id) : '')) return;

        allRowsData.push({
            ...r,
            display_company: comp,
            display_job: job,
            preference_id: pid,
            display_status: st,
            comment: cm,
            isMultiRow: true
        });
      });

      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pageData = allRowsData.slice(start, end);

      pageData.forEach(row => {
        const pid = row.preference_id || null;
        
        // 渲染每一行，statusColor(row.display_status) 會決定背景色，mapStatus 決定文字
        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid #e2e8f0';
        const key = (row.preference_id || row.preferenceId || row.id);
        const hasInterviewed = interviewedSet.has(String(key)) || row.has_interview || false;
        const isInterviewCompleted = row.interview_completed || false;
        const rowId = `checkbox-${row.id}-${pid || 'no-pid'}`;
        tr.innerHTML = `
           <td style="padding: 14px 16px; text-align: center;">
             <input type="checkbox" class="row-checkbox" id="${rowId}" data-resume-id="${row.id}" data-preference-id="${pid || ''}" style="cursor: pointer; width: 18px; height: 18px;">
           </td>
           <td style="padding: 14px 16px;">${row.username || row.student_number || '—'}</td>
           <td style="padding: 14px 16px;">${escapeHtml(row.name || row.student_name || '—')}</td>
           <td style="padding: 14px 16px;">${row.upload_time || '—'}</td>
           <td style="padding: 14px 16px; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(row.original_filename || '—')}</td>
          <td style="padding: 14px 16px;">${escapeHtml(row.display_job)}</td>
          <td style="padding: 14px 16px;">
            <div style="display:flex; gap:6px; flex-wrap:wrap; align-items:center;">
              <span class="status-badge bg-${statusColor(row.display_status)}">${mapStatus(row.display_status)}</span>
              ${
                isInterviewCompleted
                  ? `<span class="status-badge bg-completed">已面試</span>`
                  : (hasInterviewed || row.has_interview)
                    ? `<span class="status-badge bg-interviewing">面試中</span>`
                    : `<span class="status-badge bg-secondary" style="background-color: #94a3b8;">未面試</span>`
              }
            </div>
          </td>
           <td style="padding: 14px 16px;">
             ${ renderCommentBtn(row, pid) }
           </td>
           <td style="padding: 14px 16px;">
             ${ renderActionBtns(row, pid) }
           </td>
        `;
        tbody.appendChild(tr);
      });

      renderPagination(allRowsData.length);
    }

    function renderCommentBtn(row, pid) {
        const hasComment = row.comment && row.comment.trim() !== '';
        const btnClass = hasComment ? 'text-success' : '';
        const btnText = hasComment ? '已填寫' : '未填寫';
        
        // 如果是老師，只顯示查看模式（只讀）
        const isReadOnly = userRole && userRole !== 'vendor';
        if (isReadOnly) {
            if (hasComment) {
                return `<button class="btn btn-sm btn-outline-secondary text-success" onclick="openCommentModal(${row.id}, '${escapeHtml(row.comment || '')}', ${pid ? pid : 'null'}, true)">已填寫</button>`;
            } else {
                return `<span style="color:#aaa; font-size:0.9em;">未填寫</span>`;
            }
        }
        
        return `<button class="btn btn-sm btn-outline-secondary ${btnClass}" onclick="openCommentModal(${row.id}, '${escapeHtml(row.comment || '')}', ${pid ? pid : 'null'}, false)">${btnText}</button>`;
    }

    function renderActionBtns(row, pid) {
        const dlBtn = `<a href="/api/download_resume/${row.id}" class="btn btn-sm btn-outline-primary" target="_blank" style="margin-right:4px;">下載</a>`;
        
        // 如果是老師，只顯示下載按鈕（只讀模式）
        if (userRole && userRole !== 'vendor') {
            return dlBtn;
        }
        
        const key = (pid || row.preference_id || row.preferenceId || row.id);
        const hasInterviewed = interviewedSet.has(String(key)) || row.has_interview || false;
        const isInterviewCompleted = row.interview_completed || false;

        // 廠商可以進行審核操作
        const approveClick = `approveResume(${row.id}, ${pid ? `'${pid}'` : 'null'})`;
        const rejectClick = `rejectResume(${row.id}, ${pid ? `'${pid}'` : 'null'})`;
        const interviewClick = `sendInterview(${row.student_id || 'null'}, ${row.company_id || 'null'}, ${row.id}, ${pid ? `'${pid}'` : 'null'})`;
        const markCompletedClick = `markInterviewCompleted(${row.id}, ${pid ? `'${pid}'` : 'null'})`;

        // 無論狀態為何，保留按鈕
        let btns = `<div style="display:flex; align-items:center; flex-wrap:wrap; gap:4px;">${dlBtn}`;
        btns += `<button class="btn btn-sm btn-outline-danger" style="margin-right:4px;" onclick="${rejectClick}">退件</button>`;
        btns += `<button class="btn btn-sm btn-outline-success" onclick="${approveClick}">通過</button>`;
        btns += `</div>`;
        return btns;
    }

    // 廠商送出面試通知
    function sendInterview(studentId, companyId, resumeId, preferenceId) {
      if (!studentId) {
        alert("找不到學生資料，無法發送面試通知");
        return;
      }
      const contentRaw = prompt("請輸入要給學生的面試通知內容（可留空，按「取消」則不送出）：");
      if (contentRaw === null) {
        // 使用者按下取消，不送出通知
        return;
      }
      const content = contentRaw.trim();
      const payload = {
        student_id: studentId,
        company_id: companyId || null,
        notification_type: "interview",
        content: content,
        preference_id: preferenceId || null
      };

      fetch("/vendor/api/send_notification", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("✅ 面試通知已發送給學生和指導老師");
          // 重新載入資料
          fetch(getResumeApiUrl()).then(r=>r.json()).then(d=>{
            if(d.success) { 
              allResumes=d.resumes;
              // 根據後端返回的資料更新 interviewedSet
              interviewedSet.clear();
              allResumes.forEach(r => {
                if (r.has_interview || r.interview_completed) {
                  const key = String(r.preference_id || r.preferenceId || r.id);
                  interviewedSet.add(key);
                }
              });
              applyFilters(); 
            }
          });
        } else {
          alert("發送失敗：" + (data.message || "未知錯誤"));
        }
      })
      .catch(err => {
        console.error("sendInterview error:", err);
        alert("發送失敗，請稍後再試");
      });
    }

    // 標記面試已完成
    function markInterviewCompleted(resumeId, preferenceId) {
      if (!preferenceId || preferenceId === 'null') {
        alert("找不到志願序資料，無法標記面試完成");
        return;
      }
      
      if (!confirm("確定要標記為已面試嗎？")) {
        return;
      }

      fetch("/vendor/api/mark_interview_completed", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          preference_id: preferenceId
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("✅ 已標記為面試完成");
          // 重新載入資料
          fetch(getResumeApiUrl()).then(r=>r.json()).then(d=>{
            if(d.success) { 
              allResumes=d.resumes;
              // 根據後端返回的資料更新 interviewedSet
              interviewedSet.clear();
              allResumes.forEach(r => {
                if (r.has_interview || r.interview_completed) {
                  const key = String(r.preference_id || r.preferenceId || r.id);
                  interviewedSet.add(key);
                }
              });
              applyFilters(); 
            }
          });
        } else {
          alert("操作失敗：" + (data.message || "未知錯誤"));
        }
      })
      .catch(err => {
        console.error("markInterviewCompleted error:", err);
        alert("操作失敗，請稍後再試");
      });
    }

    function renderPagination(totalItems) {
      const totalPages = Math.ceil(totalItems / rowsPerPage);
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";
      if (totalPages <= 1) return;
      for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement("li");
        li.className = `page-item ${i === currentPage ? "active" : ""}`;
        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        li.onclick = (e) => { e.preventDefault(); currentPage = i; applyFilters(); }; 
        pagination.appendChild(li);
      }
    }

    // 更新狀態函式
    function approveResume(resumeId, preferenceId) {
      if (!confirm("確定要將此職缺申請標記為通過嗎？")) return;
      
      const body = { status: 'approved' };
      if (preferenceId && preferenceId !== 'null') body.preference_id = preferenceId;

      fetch(`/api/review_resume/${resumeId}`, { 
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(body)
      }).then(res => res.json()).then(data => {
          if (data.success) {
              alert("✅ 狀態更新成功");
              // 重新載入資料
              fetch(getResumeApiUrl()).then(r=>r.json()).then(d=>{
                  if(d.success) { 
                    allResumes=d.resumes;
                    // 根據後端返回的資料更新 interviewedSet
                    interviewedSet.clear();
                    allResumes.forEach(r => {
                      if (r.has_interview || r.interview_completed) {
                        const key = String(r.preference_id || r.preferenceId || r.id);
                        interviewedSet.add(key);
                      }
                    });
                    applyFilters(); 
                  }
              });
          } else {
              alert("失敗：" + data.message);
          }
      });
    }

    function rejectResume(resumeId, preferenceId) {
       if (!confirm("確定要退件此申請？")) return;
       currentResumeId = resumeId;
       currentPreferenceId = preferenceId && preferenceId !== 'null' ? preferenceId : null;
       
       document.getElementById("commentInput").value = "";
       document.getElementById("commentModalLabel").textContent = "❌ 填寫退件原因";
       document.getElementById("saveCommentBtn").textContent = "確認退件";
       const modal = new bootstrap.Modal(document.getElementById("commentModal"));
       modal.show();
       
       const saveBtn = document.getElementById("saveCommentBtn");
       saveBtn.onclick = () => {
           const reason = document.getElementById("commentInput").value.trim();
           if(!reason) { alert("請填寫退件原因"); return; }
           
           const body = { status: 'rejected', comment: reason };
           if (currentPreferenceId) body.preference_id = currentPreferenceId;

           fetch(`/api/review_resume/${currentResumeId}`, {
               method: 'POST',
               headers: {'Content-Type': 'application/json'},
               body: JSON.stringify(body)
           }).then(res => res.json()).then(data => {
               if(data.success) {
                   alert("✅ 已退件");
                   modal.hide();
                   fetch(getResumeApiUrl()).then(r=>r.json()).then(d=>{
                       if(d.success) { 
                         allResumes=d.resumes;
                         // 根據後端返回的資料更新 interviewedSet
                         interviewedSet.clear();
                         allResumes.forEach(r => {
                           if (r.has_interview) {
                             const key = String(r.preference_id || r.preferenceId || r.id);
                             interviewedSet.add(key);
                           }
                         });
                         applyFilters(); 
                       }
                   });
               } else {
                   alert("失敗：" + data.message);
               }
           });
       };
    }

    function openCommentModal(id, comment, pid, readonly) {
        document.getElementById("commentInput").value = comment || '';
        document.getElementById("commentInput").readOnly = readonly;
        document.getElementById("commentModalLabel").textContent = readonly ? "查看留言" : "編輯留言";
        const saveBtn = document.getElementById("saveCommentBtn");
        saveBtn.style.display = readonly ? 'none' : 'block';
        saveBtn.textContent = "儲存";
        
        if (!readonly) {
            currentResumeId = id;
            currentPreferenceId = pid && pid !== 'null' ? pid : null;
            saveBtn.onclick = saveComment; 
        }
        new bootstrap.Modal(document.getElementById("commentModal")).show();
    }

    function saveComment() {
        const val = document.getElementById("commentInput").value.trim();
        const body = { field: 'comment', value: val, resume_id: currentResumeId };
        if(currentPreferenceId) body.preference_id = currentPreferenceId;

        fetch("/api/update_resume_field", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        }).then(res => res.json()).then(data => {
             if(data.success) {
                 alert("留言已更新");
                 bootstrap.Modal.getInstance(document.getElementById("commentModal")).hide();
                 fetch(getResumeApiUrl()).then(r=>r.json()).then(d=>{
                     if(d.success) { 
                       allResumes=d.resumes;
                       // 根據後端返回的資料更新 interviewedSet
                       interviewedSet.clear();
                       allResumes.forEach(r => {
                         if (r.has_interview) {
                           const key = String(r.preference_id || r.preferenceId || r.id);
                           interviewedSet.add(key);
                         }
                       });
                       applyFilters(); 
                     }
                 });
             } else {
                 alert("失敗");
             }
        });
    }

    // 月曆相關變數
    let currentCalendarDate = new Date();
    let selectedInterviewDate = null;
    // 存儲面試排程（格式：'YYYY-MM-DD' => {timeStart: 'HH:MM', timeEnd: 'HH:MM', location: '...', notes: '...'}）
    const interviewSchedules = new Map();
    
    // 從本地存儲載入面試排程
    function loadInterviewSchedules() {
      const saved = localStorage.getItem('interviewSchedules');
      if (saved) {
        try {
          const schedules = JSON.parse(saved);
          Object.keys(schedules).forEach(date => {
            interviewSchedules.set(date, schedules[date]);
          });
        } catch (e) {
          console.error('載入面試排程失敗:', e);
        }
      }
    }
    
    // 保存面試排程到本地存儲
    function saveInterviewSchedulesToStorage() {
      const schedules = {};
      interviewSchedules.forEach((value, key) => {
        schedules[key] = value;
      });
      localStorage.setItem('interviewSchedules', JSON.stringify(schedules));
    }
    
    // 初始化時載入
    loadInterviewSchedules();

    // 填充面試地點下拉選單（包含固定地點與公司名稱）
    function populateLocationDropdown() {
      const locationSelect = document.getElementById('interviewLocation');
      if (!locationSelect) return;
      
      // 清空現有選項（保留第一個「請選擇」選項）
      locationSelect.innerHTML = '<option value=\"\">請選擇面試地點</option>';
      
      // 固定加入「康寧大學科辦」
      const schoolOption = document.createElement('option');
      schoolOption.value = '康寧大學科辦';
      schoolOption.textContent = '康寧大學科辦';
      locationSelect.appendChild(schoolOption);
      
      // 使用 Set 避免重複公司名稱
      const added = new Set(['康寧大學科辦']);
      interviewCompanyNames.forEach(name => {
        if (name && !added.has(name)) {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          locationSelect.appendChild(opt);
          added.add(name);
        }
      });
      
      // 添加「其他」選項
      const otherOption = document.createElement('option');
      otherOption.value = 'other';
      otherOption.textContent = '其他';
      locationSelect.appendChild(otherOption);
      
      // 監聽地點選擇變化，顯示/隱藏「其他」輸入框
      locationSelect.addEventListener('change', function() {
        const otherInput = document.getElementById('interviewLocationOther');
        if (otherInput) {
          if (this.value === 'other') {
            otherInput.style.display = 'block';
            otherInput.required = true;
          } else {
            otherInput.style.display = 'none';
            otherInput.required = false;
            otherInput.value = '';
          }
        }
      });
    }
    
    // 填充學生下拉選單（可複選）
    function populateStudentsDropdown() {
      const studentsContainer = document.getElementById('interviewStudents');
      if (!studentsContainer) return;
      
      // 清空現有選項
      studentsContainer.innerHTML = '';
      
      // 從 allResumes 中提取學生資料（去重）
      const studentMap = new Map();
      allResumes.forEach(r => {
        const studentId = r.student_id || r.id;
        const studentName = r.name || r.student_name || '未知';
        const studentUsername = r.username || r.student_number || '';
        const key = String(studentId);
        
        // 如果該學生尚未加入，則加入
        if (!studentMap.has(key) && studentId) {
          studentMap.set(key, {
            id: studentId,
            name: studentName,
            username: studentUsername,
            displayText: `${studentName} (${studentUsername})`
          });
        }
      });
      
      // 按姓名排序後加入選單
      const sortedStudents = Array.from(studentMap.values()).sort((a, b) => {
        return a.name.localeCompare(b.name, 'zh-Hant');
      });
      
      sortedStudents.forEach(student => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'student-checkbox-item';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `student-checkbox-${student.id}`;
        checkbox.value = String(student.id);
        checkbox.className = 'student-checkbox';
        
        const label = document.createElement('label');
        label.htmlFor = `student-checkbox-${student.id}`;
        label.textContent = student.displayText;
        
        itemDiv.appendChild(checkbox);
        itemDiv.appendChild(label);
        
        // 點擊整個項目也可以切換 checkbox
        itemDiv.addEventListener('click', function(e) {
          if (e.target !== checkbox && e.target !== label) {
            checkbox.checked = !checkbox.checked;
            updateSelectedStudentsCount();
          }
        });
        
        // checkbox 改變時更新計數
        checkbox.addEventListener('change', updateSelectedStudentsCount);
        
        studentsContainer.appendChild(itemDiv);
      });
      
      // 更新選中學生計數
      updateSelectedStudentsCount();
    }
    
    // 更新選中學生計數
    function updateSelectedStudentsCount() {
      const studentsContainer = document.getElementById('interviewStudents');
      const countSpan = document.getElementById('selectedStudentsCount');
      if (studentsContainer && countSpan) {
        const checkboxes = studentsContainer.querySelectorAll('.student-checkbox:checked');
        const selectedCount = checkboxes.length;
        countSpan.textContent = selectedCount;
        
        // 更新全選按鈕文字
        const selectAllBtn = document.getElementById('selectAllStudentsBtn');
        if (selectAllBtn) {
          const allCheckboxes = studentsContainer.querySelectorAll('.student-checkbox');
          if (selectedCount === allCheckboxes.length && allCheckboxes.length > 0) {
            selectAllBtn.textContent = '取消全選';
          } else {
            selectAllBtn.textContent = '全選';
          }
        }
      }
    }
    
    // 開啟面試排程月曆
    function openInterviewSchedule() {
      currentCalendarDate = new Date();
      renderCalendar();
      const modal = new bootstrap.Modal(document.getElementById("interviewScheduleModal"));
      modal.show();
    }

    // 改變月份
    function changeMonth(direction) {
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
      renderCalendar();
    }
    
    // 開啟面試表單
    function openInterviewForm(date) {
      selectedInterviewDate = date;
      const dateStr = formatDate(date);
      const dateDisplay = formatDateDisplay(date);
      
      document.getElementById('interviewDate').value = dateDisplay;
      document.getElementById('interviewTimeStart').value = '';
      document.getElementById('interviewTimeEnd').value = '';
      document.getElementById('interviewLocation').value = '';
      const locationOtherInput = document.getElementById('interviewLocationOther');
      if (locationOtherInput) {
        locationOtherInput.value = '';
        locationOtherInput.style.display = 'none';
        locationOtherInput.required = false;
      }
      document.getElementById('interviewNotes').value = '';
      
      // 依照目前履歷資料重建地點下拉選單（包含公司名稱）
      populateLocationDropdown();
      
      // 填充學生選單
      populateStudentsDropdown();
      
      // 如果已有排程，載入現有資料
      if (interviewSchedules.has(dateStr)) {
        const schedule = interviewSchedules.get(dateStr);
        // 處理舊格式（單一時間）和新格式（開始/結束時間）
        if (schedule.timeStart && schedule.timeEnd) {
          document.getElementById('interviewTimeStart').value = schedule.timeStart || '';
          document.getElementById('interviewTimeEnd').value = schedule.timeEnd || '';
        } else if (schedule.time) {
          // 兼容舊格式：如果只有單一時間，設為開始時間
          document.getElementById('interviewTimeStart').value = schedule.time || '';
        }
        
        // 處理地點：檢查是否為預設選項或「其他」
        const locationSelect = document.getElementById('interviewLocation');
        const locationOtherInput = document.getElementById('interviewLocationOther');
        const savedLocation = schedule.location || '';
        
        if (savedLocation) {
          // 檢查保存的地點是否在選單中
          const locationOption = Array.from(locationSelect.options).find(opt => opt.value === savedLocation);
          if (locationOption) {
            // 如果是預設選項，直接設置
            locationSelect.value = savedLocation;
            if (locationOtherInput) {
              locationOtherInput.style.display = 'none';
              locationOtherInput.value = '';
            }
          } else {
            // 如果不在選單中，設置為「其他」並填入輸入框
            locationSelect.value = 'other';
            if (locationOtherInput) {
              locationOtherInput.style.display = 'block';
              locationOtherInput.value = savedLocation;
              locationOtherInput.required = true;
            }
          }
        }
        
        document.getElementById('interviewNotes').value = schedule.notes || '';
        
        // 恢復選中的學生
        const studentsContainer = document.getElementById('interviewStudents');
        if (studentsContainer && schedule.students && Array.isArray(schedule.students)) {
          // 清除所有選中狀態
          const checkboxes = studentsContainer.querySelectorAll('.student-checkbox');
          checkboxes.forEach(checkbox => {
            checkbox.checked = false;
          });
          
          // 恢復選中的學生
          schedule.students.forEach(studentId => {
            const checkbox = studentsContainer.querySelector(`.student-checkbox[value="${studentId}"]`);
            if (checkbox) {
              checkbox.checked = true;
            }
          });
          updateSelectedStudentsCount();
        }
      } else {
        // 如果沒有排程，清除所有選中狀態
        const studentsContainer = document.getElementById('interviewStudents');
        if (studentsContainer) {
          const checkboxes = studentsContainer.querySelectorAll('.student-checkbox');
          checkboxes.forEach(checkbox => {
            checkbox.checked = false;
          });
          updateSelectedStudentsCount();
        }
      }
      
      // 先關閉月曆模態框
      const scheduleModal = bootstrap.Modal.getInstance(document.getElementById("interviewScheduleModal"));
      if (scheduleModal) {
        scheduleModal.hide();
      }
      
      // 等待月曆模態框完全關閉後再打開表單模態框
      setTimeout(() => {
        const formModal = new bootstrap.Modal(document.getElementById("interviewFormModal"));
        formModal.show();
        
        // 確保背景遮罩正確顯示
        setTimeout(() => {
          const backdrop = document.querySelector('.modal-backdrop');
          if (backdrop) {
            backdrop.style.backgroundColor = 'rgba(0, 0, 0, 0.6)';
            backdrop.style.opacity = '1';
          }
        }, 100);
      }, 300);
    }
    
    // 格式化日期為 YYYY-MM-DD
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    // 格式化日期顯示
    function formatDateDisplay(date) {
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const weekDays = ["日", "一", "二", "三", "四", "五", "六"];
      const weekDay = weekDays[date.getDay()];
      return `${year}年${month}月${day}日（${weekDay}）`;
    }
    
    // 保存面試排程
    function saveInterviewSchedule() {
      if (!selectedInterviewDate) {
        alert('請選擇日期');
        return;
      }
      
      const timeStart = document.getElementById('interviewTimeStart').value.trim();
      const timeEnd = document.getElementById('interviewTimeEnd').value.trim();
      
      if (!timeStart) {
        alert('請輸入開始時間');
        document.getElementById('interviewTimeStart').focus();
        return;
      }
      
      if (!timeEnd) {
        alert('請輸入結束時間');
        document.getElementById('interviewTimeEnd').focus();
        return;
      }
      
      // 驗證結束時間必須晚於開始時間
      if (timeEnd <= timeStart) {
        alert('結束時間必須晚於開始時間');
        document.getElementById('interviewTimeEnd').focus();
        return;
      }
      
      const locationSelect = document.getElementById('interviewLocation');
      const locationOtherInput = document.getElementById('interviewLocationOther');
      let location = '';
      
      if (locationSelect.value === 'other') {
        // 如果選擇「其他」，使用輸入框的值
        location = locationOtherInput ? locationOtherInput.value.trim() : '';
        if (!location) {
          alert('請輸入其他面試地點');
          if (locationOtherInput) {
            locationOtherInput.focus();
          }
          return;
        }
      } else {
        // 使用選單中的值
        location = locationSelect.value.trim();
        if (!location) {
          alert('請選擇面試地點');
          locationSelect.focus();
          return;
        }
      }
      
      const notes = document.getElementById('interviewNotes').value.trim();
      const dateStr = formatDate(selectedInterviewDate);
      
      // 獲取選中的學生 ID
      const studentsContainer = document.getElementById('interviewStudents');
      const selectedStudents = [];
      if (studentsContainer) {
        const checkboxes = studentsContainer.querySelectorAll('.student-checkbox:checked');
        checkboxes.forEach(checkbox => {
          selectedStudents.push(checkbox.value);
        });
      }
      
      // 保存到 Map（本地存儲）
      interviewSchedules.set(dateStr, {
        timeStart: timeStart,
        timeEnd: timeEnd,
        location: location,
        notes: notes,
        students: selectedStudents
      });
      
      // 保存到本地存儲
      saveInterviewSchedulesToStorage();
      
      // 如果有選中學生，調用後端 API 記錄到 vendor_preference_history 資料表
      if (selectedStudents.length > 0) {
        const interviewData = {
          student_ids: selectedStudents,
          interview_date: dateStr,
          interview_time_start: timeStart,
          interview_time_end: timeEnd,
          interview_location: location,
          interview_notes: notes
        };
        
        fetch("/vendor/api/schedule_interviews", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(interviewData)
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            // 立即更新前端狀態顯示
            selectedStudents.forEach(studentId => {
              allResumes.forEach(resume => {
                const resumeStudentId = String(resume.student_id || resume.id || '');
                if (resumeStudentId === String(studentId)) {
                  resume.has_interview = true;
                  const key = String(resume.preference_id || resume.preferenceId || resume.id);
                  interviewedSet.add(key);
                }
              });
            });
            
            // 立即重新渲染表格以顯示「面試中」狀態
            applyFilters();
            
            // 重新載入資料以確保狀態同步
            fetch(getResumeApiUrl()).then(r=>r.json()).then(d=>{
              if(d.success) { 
                allResumes = d.resumes;
                interviewedSet.clear();
                allResumes.forEach(r => {
                  if (r.has_interview || r.interview_completed) {
                    const key = String(r.preference_id || r.preferenceId || r.id);
                    interviewedSet.add(key);
                  }
                });
                applyFilters();
              }
            });
          } else {
            console.error("記錄面試排程到資料庫失敗:", data.message);
            // 即使後端記錄失敗，也更新前端狀態
            selectedStudents.forEach(studentId => {
              allResumes.forEach(resume => {
                const resumeStudentId = String(resume.student_id || resume.id || '');
                if (resumeStudentId === String(studentId)) {
                  resume.has_interview = true;
                  const key = String(resume.preference_id || resume.preferenceId || resume.id);
                  interviewedSet.add(key);
                }
              });
            });
            applyFilters();
          }
        })
        .catch(err => {
          console.error("調用面試排程 API 失敗:", err);
          // 即使 API 調用失敗，也更新前端狀態
          selectedStudents.forEach(studentId => {
            allResumes.forEach(resume => {
              const resumeStudentId = String(resume.student_id || resume.id || '');
              if (resumeStudentId === String(studentId)) {
                resume.has_interview = true;
                const key = String(resume.preference_id || resume.preferenceId || resume.id);
                interviewedSet.add(key);
              }
            });
          });
          applyFilters();
        });
      } else {
        // 如果沒有選中學生，仍然需要重新渲染以確保狀態正確
        applyFilters();
      }
      
      // 關閉表單模態框
      const formModal = bootstrap.Modal.getInstance(document.getElementById("interviewFormModal"));
      formModal.hide();
      
      // 重新渲染月曆以顯示新標記
      renderCalendar();
      
      // 確保狀態更新後再顯示提示
      setTimeout(() => {
        alert('✅ 面試排程已儲存');
      }, 100);
    }

    // 渲染月曆
    function renderCalendar() {
      const calendar = document.getElementById("calendar");
      const monthYear = document.getElementById("currentMonthYear");
      
      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();
      
      // 設置月份年份標題
      const monthNames = ["一月", "二月", "三月", "四月", "五月", "六月", 
                          "七月", "八月", "九月", "十月", "十一月", "十二月"];
      monthYear.textContent = `${year}年 ${monthNames[month]}`;
      
      // 獲取當月第一天和最後一天
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay(); // 0 = 星期日, 1 = 星期一, ...
      
      // 清空月曆
      calendar.innerHTML = "";
      
      // 添加星期標題
      const weekDays = ["日", "一", "二", "三", "四", "五", "六"];
      weekDays.forEach(day => {
        const dayHeader = document.createElement("div");
        dayHeader.style.cssText = "padding: 12px; text-align: center; font-weight: 600; background-color: #f1f5f9; border-radius: 8px;";
        dayHeader.textContent = day;
        calendar.appendChild(dayHeader);
      });
      
      // 添加空白格子（月初）
      for (let i = 0; i < startingDayOfWeek; i++) {
        const emptyCell = document.createElement("div");
        emptyCell.style.cssText = "padding: 12px; min-height: 80px; border: 1px solid #e2e8f0; border-radius: 8px; background-color: #f9fafb;";
        calendar.appendChild(emptyCell);
      }
      
      // 添加日期格子
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      for (let day = 1; day <= daysInMonth; day++) {
        const dateCell = document.createElement("div");
        const cellDate = new Date(year, month, day);
        cellDate.setHours(0, 0, 0, 0);
        
        const isToday = cellDate.getTime() === today.getTime();
        const isPast = cellDate < today;
        
        dateCell.style.cssText = `
          padding: 12px;
          min-height: 80px;
          border: 1px solid #e2e8f0;
          border-radius: 8px;
          background-color: ${isToday ? '#e3f2fd' : isPast ? '#f9fafb' : '#ffffff'};
          cursor: ${isPast ? 'not-allowed' : 'pointer'};
          transition: background-color 0.2s;
        `;
        
        // 日期數字
        const dayNumber = document.createElement("div");
        dayNumber.style.cssText = `
          font-weight: ${isToday ? '700' : '600'};
          font-size: 1rem;
          color: ${isToday ? '#0055a8' : isPast ? '#94a3b8' : '#1e293b'};
          margin-bottom: 4px;
        `;
        dayNumber.textContent = day;
        dateCell.appendChild(dayNumber);
        
        // 檢查是否有面試安排（從本地存儲或後端獲取）
        const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const hasInterview = interviewSchedules.has(dateKey);
        
        if (hasInterview) {
          const schedule = interviewSchedules.get(dateKey);
          const timeStart = schedule.timeStart || '';
          const timeEnd = schedule.timeEnd || '';
          
          // 格式化時間顯示（只顯示時分，去掉秒）
          let timeDisplay = '';
          if (timeStart && timeEnd) {
            const startTime = timeStart.substring(0, 5); // 取 HH:MM
            const endTime = timeEnd.substring(0, 5); // 取 HH:MM
            timeDisplay = ` ${startTime}-${endTime}`;
          } else if (timeStart) {
            // 兼容舊格式
            const startTime = timeStart.substring(0, 5);
            timeDisplay = ` ${startTime}`;
          }
          
          const interviewBadge = document.createElement("div");
          interviewBadge.style.cssText = `
            font-size: 0.75rem;
            color: #fff;
            background-color: #0dcaf0;
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 4px;
            display: inline-block;
            white-space: nowrap;
          `;
          interviewBadge.textContent = `面試${timeDisplay}`;
          dateCell.appendChild(interviewBadge);
        }
        
        // 添加點選事件（非過去的日期）
        if (!isPast) {
          dateCell.addEventListener('click', () => {
            openInterviewForm(cellDate);
          });
          dateCell.addEventListener('mouseenter', () => {
            dateCell.style.backgroundColor = '#f0f9ff';
          });
          dateCell.addEventListener('mouseleave', () => {
            dateCell.style.backgroundColor = isToday ? '#e3f2fd' : '#ffffff';
          });
        } else {
          dateCell.style.opacity = '0.6';
        }
        
        calendar.appendChild(dateCell);
      }
      
      // 添加空白格子（月末）
      const totalCells = calendar.children.length - 7; // 減去星期標題
      const remainingCells = 42 - totalCells; // 6行 x 7列 = 42格
      for (let i = 0; i < remainingCells; i++) {
        const emptyCell = document.createElement("div");
        emptyCell.style.cssText = "padding: 12px; min-height: 80px; border: 1px solid #e2e8f0; border-radius: 8px; background-color: #f9fafb;";
        calendar.appendChild(emptyCell);
      }
    }

  </script>
</body>
</html>
