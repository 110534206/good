<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ™ºæ…§å¯¦ç¿’å¹³å° | å» å•†å±¥æ­·å¯©æŸ¥</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    header {
      background: linear-gradient(135deg, #0055a8 0%, #006acb 50%, #004f94 100%);
      border-bottom: none; position: sticky; top: 0; z-index: 10;
      box-shadow: 0 8px 20px rgba(0, 68, 148, 0.35);
    }
    .topbar {
      max-width: 1800px; margin: 0 auto; padding: 18px 24px;
      display: flex; align-items: center; justify-content: space-between; color: #fff;
    }
    .topbar-left { display: flex; align-items: center; }
    .topbar-left #menu-btn {
      width: 30px; height: 22px; cursor: pointer; display: flex; flex-direction: column;
      justify-content: space-between; background: none; border: none; padding: 0;
    }
    .topbar-left #menu-btn span {
      display: block; width: 100%; height: 3px; background-color: white; border-radius: 2px; transition: all 0.3s ease;
    }
    .topbar h1 { font-size: 1.5rem; margin: 0; text-align: center; color: #fff; flex: 1; }
    body { font-family: "Noto Sans TC", sans-serif; background: #ffffff; margin: 0; padding: 0; }
    main { max-width: 1800px; margin: 24px auto 60px; padding: 0 24px; display: flex; flex-direction: column; gap: 24px; }
    .panel {
      background: #ffffff; border-radius: 16px; padding: 24px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08); border: 1px solid #e2e8f0; margin-bottom: 32px;
    }
    .panel-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 16px; }
    .panel-header h2 { font-size: 1.2rem; margin: 0; }
    .table-wrapper { overflow-x: visible; width: 100%; }
    .table-wrapper table tbody tr:hover { background: rgba(15, 23, 42, 0.02); }
    .table thead th { text-align: left; background-color: #fafafb; }
    .table tbody td { text-align: left; vertical-align: middle; }
    .table tbody tr td:nth-child(1), .table tbody tr td:nth-child(2), 
    .table tbody tr td:nth-child(3), .table tbody tr td:nth-child(4) { vertical-align: top; }
    
    /* --- ç‹€æ…‹æ¨™ç±¤æ¨£å¼è¨­å®š --- */
    .status-badge { font-size: 0.9em; padding: 0.3em 0.6em; border-radius: 0.5rem; display: inline-block; font-weight: 600; }
    
    /* é€šéï¼šç¶ åº•ç™½å­— */
    .status-badge.bg-success { color: #fff; background-color: #198754; }
    
    /* é€€ä»¶ï¼šç´…åº•ç™½å­— */
    .status-badge.bg-danger { color: #fff; background-color: #dc3545; }
    
    /* å¾…å¯©æ ¸ï¼šè—åº•ç™½å­— */
    .status-badge.bg-info { color: #fff; background-color: #0dcaf0; }
    
    .status-badge.bg-secondary { color: #fff; background-color: #6c757d; }
    
    /* é¢è©¦ä¸­ï¼šä¸­æ©™è‰²åº•ç™½å­— */
    .status-badge.bg-interviewing { color: #fff; background-color: #ff8c42; }
    
    /* å·²é¢è©¦ï¼šä¸­è—è‰²åº•ç™½å­— */
    .status-badge.bg-completed { color: #fff; background-color: #4a9eff; }
    
    #commentInput { width: 100%; height: 180px; resize: vertical; padding: 0.5rem; font-size: 1rem; line-height: 1.4; }
    
    /* å­¸ç”Ÿé¸å–®æ¨£å¼ */
    #interviewStudents {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
    }
    .student-checkbox-item {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .student-checkbox-item:hover {
      background-color: #f0f9ff;
    }
    .student-checkbox-item input[type="checkbox"] {
      margin-right: 10px;
      cursor: pointer;
      width: 18px;
      height: 18px;
    }
    .student-checkbox-item label {
      margin: 0;
      cursor: pointer;
      flex: 1;
      user-select: none;
    }
    
    #side-menu {
      position: fixed; top: 0; left: 0; height: 100vh; width: 320px; max-width: 80vw;
      background-color: rgba(10, 10, 10, 0.95); backdrop-filter: blur(6px);
      box-shadow: 3px 0 12px rgba(0, 0, 0, 0.6); padding: 2rem 1.5rem;
      transform: translateX(-100%); transition: transform 0.3s ease-in-out; z-index: 1300;
      display: flex; flex-direction: column; align-items: flex-start; color: #fff; user-select: none;
    }
    #side-menu.open { transform: translateX(0); }
    #side-menu h2 {
      margin: 0.5rem 0 1.5rem;
      font-weight: 700;
      font-size: 1.6rem;
    }

    #close-btn {
      position: absolute;
      top: 2rem;
      right: 1.6rem;
      font-size: 2.2rem;
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      line-height: 1;
      width: 2.4rem;
      height: 2.4rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #side-menu a {
      display: block; width: 100%; padding: 0.6rem 0; font-size: 1.1rem; color: #e2e8f0;
      text-decoration: none; border-radius: 4px; transition: background-color 0.2s ease;
    }
    #side-menu a:hover { background-color: rgba(255, 255, 255, 0.18); color: #fff; }
    
    /* æ¨¡æ…‹æ¡†èƒŒæ™¯é®ç½©æ¨£å¼ - ç°é»‘è‰² */
    .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.6) !important;
      opacity: 1 !important;
    }
    
    .modal-backdrop.show {
      opacity: 1 !important;
      background-color: rgba(0, 0, 0, 0.6) !important;
    }
    
    /* ç¢ºä¿æ¨¡æ…‹æ¡†é¡¯ç¤ºæ™‚èƒŒæ™¯è®Šæš— */
    body.modal-open {
      overflow: hidden;
    }
    
    /* ç•¶é¢è©¦è¡¨å–®æ¨¡æ…‹æ¡†æ‰“é–‹æ™‚ï¼Œç¢ºä¿èƒŒæ™¯é®ç½©æ­£ç¢ºé¡¯ç¤º */
    #interviewFormModal.show ~ .modal-backdrop,
    #interviewFormModal.show + .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.6) !important;
      opacity: 1 !important;
    }
  </style>
</head>

<body>
  <header>
    <div class="topbar">
      <div class="topbar-left">
        <button id="menu-btn" title="é¸å–®" role="button" tabindex="0" aria-label="é–‹å•Ÿå´é‚Šé¸å–®">
          <span></span><span></span><span></span>
        </button>
      </div>
      <h1>å» å•†å±¥æ­·å¯©æŸ¥</h1>
      <div style="width: 30px;"></div>
    </div>
  </header>
  <main>
    <section class="panel" aria-label="å±¥æ­·åˆ—è¡¨">
      <div class="panel-header">
      </div>
      <div style="display: flex; flex-wrap: wrap; gap: 16px; align-items: center; margin-bottom: 16px;">
        <select id="departmentFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">æ‰€æœ‰å­¸å¹´</option>
        </select>
        <select id="classFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">æ‰€æœ‰ç­ç´š</option>
        </select>
        <select id="companyNameFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">æ‰€æœ‰å…¬å¸</option>
        </select>
        <select id="companyFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">æ‰€æœ‰è·ç¼º</option>
        </select>
        <select id="statusFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">æ‰€æœ‰ç‹€æ…‹</option>
          <option value="pending">å¾…å¯©æ ¸</option>
          <option value="approved">é€šé</option>
          <option value="rejected">é€€ä»¶</option>
        </select>
        <select id="interviewStatusFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">æ‰€æœ‰é¢è©¦ç‹€æ…‹</option>
          <option value="none">æœªé¢è©¦</option>
          <option value="interviewing">é¢è©¦ä¸­</option>
          <option value="completed">å·²é¢è©¦</option>
        </select>
        <input type="text" id="searchBox" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 200px; flex: 1;" placeholder="æœå°‹å¸³è™Ÿ/æª”æ¡ˆ" />
      </div>
      
      <div style="margin-bottom: 16px;">
        <select id="interviewScheduleMenu" class="form-select" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">æ‰€æœ‰åŠŸèƒ½</option>
          <option value="schedule">é¢è©¦æ’ç¨‹</option>
          <option value="completed">å·²é¢è©¦</option>
          <option value="download">ä¸‹è¼‰</option>
          <option value="matching_sort">åª’åˆæ’åº</option>
        </select>
      </div>

      <div class="table-wrapper">
        <table style="width: 100%; border-collapse: collapse;">
          <thead style="background: #f1f5f9;">
            <tr>
              <th style="padding: 14px 16px; font-weight: 600; width: 50px;">
                <input type="checkbox" id="selectAllCheckbox" title="å…¨é¸/å–æ¶ˆå…¨é¸" style="cursor: pointer; width: 18px; height: 18px;">
              </th>
              <th style="padding: 14px 16px; font-weight: 600;">å­¸ç”Ÿå¸³è™Ÿ</th>
              <th style="padding: 14px 16px; font-weight: 600;">å§“å</th>
              <th style="padding: 14px 16px; font-weight: 600;">ä¸Šå‚³æ™‚é–“</th>
              <th style="padding: 14px 16px; font-weight: 600;">æª”æ¡ˆåç¨±</th>
              <th style="padding: 14px 16px; font-weight: 600;">è·ç¼º</th>
              <th style="padding: 14px 16px; font-weight: 600;">ç‹€æ…‹</th>
              <th style="padding: 14px 16px; font-weight: 600;" id="commentHeader">å» å•†ç•™è¨€</th>
              <th style="padding: 14px 16px; font-weight: 600;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="resumeTableBody">
            <tr><td colspan="9" style="padding: 14px 16px; text-align: center; color: #64748b;">è¼‰å…¥ä¸­...</td></tr>
          </tbody>
        </table>
      </div>
      <nav><ul class="pagination justify-content-center mt-3" id="pagination"></ul></nav>
    </section>
  </main>

  <div class="modal fade" id="commentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="commentModalLabel">ç·¨è¼¯ç•™è¨€</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body"><textarea id="commentInput"></textarea></div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button class="btn btn-primary" id="saveCommentBtn">é€å‡º</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="interviewScheduleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">é¢è©¦æ’ç¨‹</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="calendarContainer" style="padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <button id="prevMonthBtn" class="btn btn-outline-secondary" style="padding: 8px 16px;">â€¹ ä¸Šå€‹æœˆ</button>
              <h4 id="currentMonthYear" style="margin: 0; font-weight: 600;"></h4>
              <button id="nextMonthBtn" class="btn btn-outline-secondary" style="padding: 8px 16px;">ä¸‹å€‹æœˆ â€º</button>
            </div>
            <div id="calendar" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="matchingSortModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">åª’åˆæ’åº</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div style="padding: 20px;">
            <!-- æ¯å€‹å­—æ¯å’Œå°æ‡‰çš„ä¸‹æ‹‰é¸å–® -->
            <div id="matchingSortLetters" style="display: flex; flex-direction: column; gap: 16px;">
              <!-- å­—æ¯æŒ‰éˆ•å’Œä¸‹æ‹‰é¸å–®å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </div>
            <!-- å­¸ç”Ÿè©³ç´°è³‡è¨Šé¡¯ç¤ºå€åŸŸ -->
            <div id="matchingSortContent" style="margin-top: 20px; max-height: 400px; overflow-y: auto;">
              <!-- æ’åºçµæœå°‡åœ¨æ­¤è™•é¡¯ç¤º -->
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" id="saveMatchingSortBtn">å„²å­˜</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="interviewFormModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">æ–°å¢é¢è©¦æ’ç¨‹</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="interviewForm">
            <div class="mb-3">
              <label for="interviewDate" class="form-label" style="font-weight: 600;">é¢è©¦æ—¥æœŸ</label>
              <input type="text" class="form-control" id="interviewDate" readonly style="background-color: #f9fafb;">
            </div>
            <div class="mb-3">
              <label class="form-label" style="font-weight: 600;">é¢è©¦æ™‚é–“</label>
              <div id="bookedTimeSlotsWarning" style="display: none; margin-bottom: 12px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; color: #856404;">
                <strong>âš ï¸ è©²æ—¥æœŸä»¥ä¸‹æ™‚é–“æ®µå·²è¢«å…¶ä»–å» å•†é ç´„ï¼Œè«‹é¸æ“‡å…¶ä»–æ™‚é–“ï¼š</strong>
                <div id="bookedTimeSlotsList" style="margin-top: 6px; font-size: 0.9rem;"></div>
              </div>
              <div style="display: flex; gap: 12px; align-items: center;">
                <div style="flex: 1;">
                  <label for="interviewTimeStart" class="form-label" style="font-weight: 500; font-size: 0.9rem; margin-bottom: 4px;">é–‹å§‹æ™‚é–“</label>
                  <input type="time" class="form-control" id="interviewTimeStart" required>
                </div>
                <div style="flex: 1;">
                  <label for="interviewTimeEnd" class="form-label" style="font-weight: 500; font-size: 0.9rem; margin-bottom: 4px;">çµæŸæ™‚é–“</label>
                  <input type="time" class="form-control" id="interviewTimeEnd" required>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                <label for="interviewStudents" class="form-label" style="font-weight: 600; margin: 0;">é¢è©¦å­¸ç”Ÿ</label>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="selectAllStudentsBtn" style="font-size: 0.85rem; padding: 4px 12px;">å…¨é¸</button>
              </div>
              <div id="interviewStudents" style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; max-height: 200px; overflow-y: auto; background-color: #fff;">
                <!-- å­¸ç”Ÿé¸é …å°‡ç”± JavaScript å‹•æ…‹å¡«å…… -->
              </div>
              <small class="form-text text-muted" style="font-size: 0.85rem; margin-top: 4px; display: block;">
                å·²é¸æ“‡ <span id="selectedStudentsCount">0</span> ä½å­¸ç”Ÿ
              </small>
            </div>
            <div class="mb-3">
              <label for="interviewLocation" class="form-label" style="font-weight: 600;">é¢è©¦åœ°é»</label>
              <select class="form-control" id="interviewLocation" required>
                <option value="">è«‹é¸æ“‡é¢è©¦åœ°é»</option>
                <option value="åº·å¯§å¤§å­¸ç§‘è¾¦">åº·å¯§å¤§å­¸ç§‘è¾¦</option>
                <option value="other">å…¶ä»–</option>
              </select>
              <input type="text" class="form-control mt-2" id="interviewLocationOther" placeholder="è«‹è¼¸å…¥å…¶ä»–é¢è©¦åœ°é»" style="display: none;">
            </div>
            <div class="mb-3">
              <label for="interviewNotes" class="form-label" style="font-weight: 600;">é¢è©¦é ˆçŸ¥</label>
              <textarea class="form-control" id="interviewNotes" rows="5" placeholder="è«‹è¼¸å…¥é¢è©¦é ˆçŸ¥ï¼Œä¾‹å¦‚ï¼šæ”œå¸¶æ–‡ä»¶ã€æ³¨æ„äº‹é …ç­‰..." style="resize: vertical;"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-danger" id="deleteInterviewBtn" style="display: none;">åˆªé™¤</button>
          <button type="button" class="btn btn-primary" id="saveInterviewBtn">å„²å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <nav id="side-menu" aria-hidden="true" role="navigation" aria-label="åŠŸèƒ½é¸å–®">
    <button id="close-btn" aria-label="é—œé–‰åŠŸèƒ½é¸å–®">Ã—</button>
    <h2>åŠŸèƒ½é¸å–®</h2>
    <a href="/vendor_home">é¦–é </a>
    <a href="/profile">å€‹äººè³‡æ–™</a>
    <a href="/vendor_review_resume">å­¸ç”Ÿå±¥æ­·å¯©æ ¸</a>
    <a href="/manage_positions">è·ä½éœ€æ±‚ç®¡ç†</a>
    <a href="/confirm_matching">åª’åˆçµæœ</a>
    <a href="/publish_announcements">ç™¼å¸ƒå…¬å‘Š</a>
    <a href="/reviews_resumes_notifications">æŸ¥çœ‹å±¥æ­·èˆ‡é€šçŸ¥</a>
    <a href="/logout">ç™»å‡º</a>
  </nav>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let allResumes = [];
    let allPositions = []; // å„²å­˜æ‰€æœ‰è·ç¼ºè³‡æ–™ï¼ˆåŒ…å«åé¡ï¼‰
    let currentResumeId = null;
    let currentPreferenceId = null; 
    let currentPage = 1;
    const rowsPerPage = 10;
    // ç´€éŒ„å·²ç¶“æŒ‰ä¸‹ã€Œé¢è©¦ã€çš„ç”³è«‹ï¼ˆä»¥ preferenceId æˆ– resumeId ä½œç‚º keyï¼‰
    const interviewedSet = new Set();
    // é¢è©¦åœ°é»ä¸‹æ‹‰é¸å–®ç”¨çš„å…¬å¸åç¨±åˆ—è¡¨ï¼ˆå¾å±¥æ­·è³‡æ–™æ”¶é›†ï¼‰
    let interviewCompanyNames = [];
    // å¾ profile API ç²å–çš„å» å•†å…¬å¸åç¨±
    let vendorCompanyName = null;
    // é¢è©¦æ’ç¨‹è‡ªå‹•åˆ·æ–° interval ID
    let scheduleRefreshInterval = null;

    // å®šç¾©ç‹€æ…‹é¡è‰²ï¼Œapproved å°æ‡‰ success (ç¶ è‰²)
    function statusColor(status) {
      return { 'pending': 'info', 'approved': 'success', 'rejected': 'danger', 'submitted': 'info', 'uploaded': 'info' }[status] || 'secondary';
    }

    // å®šç¾©ç‹€æ…‹æ–‡å­—ï¼Œapproved å°æ‡‰ "é€šé"
    function mapStatus(status) {
      return { 'pending': 'å¾…å¯©æ ¸', 'approved': 'é€šé', 'rejected': 'é€€ä»¶', 'submitted': 'å¾…å¯©æ ¸', 'uploaded': 'å¾…å¯©æ ¸' }[status] || 'å¾…å¯©æ ¸';
    }

    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    // ç²å–åŒ…å« company_id çš„ API URL
    function getResumeApiUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const targetCompanyId = urlParams.get('company_id');
      let apiUrl = '/vendor/api/resumes';
      if (targetCompanyId) {
        apiUrl += `?company_id=${targetCompanyId}`;
      }
      return apiUrl;
    }

    let userRole = null;

    document.addEventListener("DOMContentLoaded", () => {
      const urlParams = new URLSearchParams(window.location.search);
      const targetCompanyId = urlParams.get('company_id');
      const targetStatus = urlParams.get('status');

      initMenu();

      // å…ˆç²å–ç”¨æˆ¶è§’è‰²ï¼Œç„¶å¾Œè¼‰å…¥è³‡æ–™
      fetch('/api/profile')
        .then(res => res.json())
        .then(profileData => {
          userRole = profileData.success && profileData.user ? profileData.user.role : 'vendor';
          
          // å¦‚æœæ˜¯å» å•†ï¼Œå¾ profile ç²å–å…¬å¸åç¨±
          if (userRole === 'vendor' && profileData.success && profileData.user) {
            vendorCompanyName = profileData.user.name || null;
            console.log('ğŸ“‹ å¾ profile API ç²å–çš„å…¬å¸åç¨±ï¼š', vendorCompanyName);
          }
          
          // å» å•†å°ˆç”¨ APIï¼ˆè€å¸«ä¹Ÿå¯ä»¥è¨ªå•ï¼‰
          const apiUrl = getResumeApiUrl();

          // æ ¹æ“šè§’è‰²æ±ºå®šå¦‚ä½•ç²å–è·ç¼ºåˆ—è¡¨
          let positionsPromise;
          if (userRole === 'vendor') {
            // å» å•†èª¿ç”¨ vendor API
            positionsPromise = fetch('/vendor/api/positions').then(res => res.ok ? res.json() : {success:true, items:[]});
          } else if (userRole === 'teacher' || userRole === 'ta') {
            // è€å¸«èª¿ç”¨ public API
            if (targetCompanyId) {
              // å¦‚æœæœ‰ company_idï¼Œç²å–è©²å…¬å¸çš„è·ç¼º
              positionsPromise = fetch(`/api/public/company/${targetCompanyId}`).then(async res => {
                if (!res.ok) return {success:true, items:[]};
                const r = await res.json();
                return {success:true, items: (r.jobs||[]).map(j=>({id:j.id, title:j.title}))};
              });
            } else {
              // å¦å‰‡ç²å–æ‰€æœ‰è·ç¼º
              positionsPromise = fetch('/api/public/positions').then(res => res.ok ? res.json() : {success:true, items:[]});
            }
          } else {
            positionsPromise = Promise.resolve({success:true, items:[]});
          }
          
          return Promise.all([
            fetch(apiUrl).then(res => res.ok ? res.json() : {success:false}),
            Promise.resolve({success:true, companies:[]}),
            positionsPromise
          ]);
        })
        .then(([resumeData, companyData, positionData]) => {
          if (resumeData.success) {
            allResumes = resumeData.resumes || [];
            
            // å„²å­˜è·ç¼ºè³‡æ–™ï¼ˆåŒ…å«åé¡ï¼‰
            if (positionData && positionData.items && Array.isArray(positionData.items)) {
              allPositions = positionData.items;
              console.log('ğŸ“‹ è¼‰å…¥è·ç¼ºè³‡æ–™ï¼š', allPositions.length, 'å€‹è·ç¼º');
              allPositions.forEach(pos => {
                console.log('  - è·ç¼ºï¼š', pos.title || pos.job_title, 'IDï¼š', pos.id, 'åé¡ï¼š', pos.slots);
              });
            } else if (positionData && positionData.success && positionData.positions && Array.isArray(positionData.positions)) {
              allPositions = positionData.positions;
            } else {
              allPositions = [];
              console.warn('âš ï¸ ç„¡æ³•è¼‰å…¥è·ç¼ºè³‡æ–™ï¼ŒpositionDataï¼š', positionData);
            }
            
            // æ ¹æ“šå¾Œç«¯è¿”å›çš„è³‡æ–™åˆå§‹åŒ– interviewedSet
            // å„ªå…ˆä½¿ç”¨ interview_status å€¼ï¼ˆå¾ resume_applications è¡¨è®€å–ï¼‰
            interviewedSet.clear();
            allResumes.forEach(r => {
              const interviewStatus = r.interview_status || 'none';
              // å¦‚æœ interview_status ä¸æ˜¯ 'none'ï¼ŒåŠ å…¥ interviewedSet
              if (interviewStatus !== 'none' || r.has_interview || r.interview_completed) {
                const key = String(r.preference_id || r.preferenceId || r.id);
                interviewedSet.add(key);
              }
            });

            // å¾å±¥æ­·è³‡æ–™è’é›†å…¬å¸åç¨±ï¼ˆç”¨æ–¼é¢è©¦åœ°é»ä¸‹æ‹‰é¸å–®ï¼‰
            const companyNameSet = new Set();
            allResumes.forEach(r => {
              if (r.company_name && r.company_name.trim()) {
                companyNameSet.add(r.company_name.trim());
              }
            });
            interviewCompanyNames = Array.from(companyNameSet);
            
            populateFilters(allResumes, companyData, positionData);

            if (targetStatus) {
               const statusSelect = document.getElementById('statusFilter');
               const mapped = (targetStatus === 'submitted' || targetStatus === 'uploaded') ? 'pending' : targetStatus;
               if(statusSelect) statusSelect.value = mapped;
            }

            applyFilters();
          } else {
            allResumes = [];
            renderTable([]);
          }
        })
        .catch(err => {
          console.error('è¼‰å…¥å±¥æ­·è³‡æ–™å¤±æ•—:', err);
          allResumes = [];
          renderTable([]);
        });

      document.getElementById("departmentFilter").addEventListener("change", applyFilters);
      document.getElementById("classFilter").addEventListener("change", applyFilters);
      document.getElementById("companyNameFilter").addEventListener("change", applyFilters);
      document.getElementById("companyFilter").addEventListener("change", applyFilters);
      document.getElementById("statusFilter").addEventListener("change", applyFilters);
      document.getElementById("interviewStatusFilter").addEventListener("change", applyFilters);
      document.getElementById("searchBox").addEventListener("input", applyFilters);
      document.getElementById("saveCommentBtn").addEventListener("click", saveComment);
      document.getElementById("interviewScheduleMenu").addEventListener("change", function(e) {
        if (e.target.value === "schedule") {
          openInterviewSchedule();
          // é‡ç½®é¸å–®å€¼ç‚ºé è¨­å€¼
          setTimeout(() => {
            e.target.value = "";
          }, 100);
        } else if (e.target.value === "completed") {
          markSelectedAsCompleted();
          // é‡ç½®é¸å–®å€¼ç‚ºé è¨­å€¼
          setTimeout(() => {
            e.target.value = "";
          }, 100);
        } else if (e.target.value === "download") {
          downloadSelectedResumes();
          // é‡ç½®é¸å–®å€¼ç‚ºé è¨­å€¼
          setTimeout(() => {
            e.target.value = "";
          }, 100);
        } else if (e.target.value === "matching_sort") {
          sortByMatchingOrder();
          // é‡ç½®é¸å–®å€¼ç‚ºé è¨­å€¼
          setTimeout(() => {
            e.target.value = "";
          }, 100);
        }
      });
      document.getElementById("prevMonthBtn").addEventListener("click", () => changeMonth(-1));
      document.getElementById("nextMonthBtn").addEventListener("click", () => changeMonth(1));
      document.getElementById("saveInterviewBtn").addEventListener("click", saveInterviewSchedule);
      
      // åˆªé™¤é¢è©¦æ’ç¨‹æŒ‰éˆ•äº‹ä»¶
      const deleteInterviewBtn = document.getElementById("deleteInterviewBtn");
      if (deleteInterviewBtn) {
        deleteInterviewBtn.addEventListener("click", function() {
          if (selectedInterviewDate) {
            const dateStr = formatDate(selectedInterviewDate);
            deleteInterviewSchedule(dateStr);
          }
        });
      }
      
      // ç›£è½é¢è©¦æ’ç¨‹æœˆæ›† modal çš„é—œé–‰äº‹ä»¶ï¼Œæ¸…é™¤è‡ªå‹•åˆ·æ–°
      const interviewScheduleModal = document.getElementById("interviewScheduleModal");
      if (interviewScheduleModal) {
        interviewScheduleModal.addEventListener('hidden.bs.modal', function() {
          if (scheduleRefreshInterval) {
            clearInterval(scheduleRefreshInterval);
            scheduleRefreshInterval = null;
            console.log('ğŸ›‘ å·²åœæ­¢é¢è©¦æ’ç¨‹è‡ªå‹•åˆ·æ–°');
          }
        });
      }
      
      // å…¨é¸/å–æ¶ˆå…¨é¸åŠŸèƒ½
      const selectAllCheckbox = document.getElementById("selectAllCheckbox");
      if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener("change", function() {
          const rowCheckboxes = document.querySelectorAll(".row-checkbox");
          rowCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
          });
        });
      }
      
      // ç•¶å€‹åˆ¥ checkbox æ”¹è®Šæ™‚ï¼Œæ›´æ–°å…¨é¸ checkbox ç‹€æ…‹
      document.addEventListener("change", function(e) {
        if (e.target.classList.contains("row-checkbox")) {
          const rowCheckboxes = document.querySelectorAll(".row-checkbox");
          const checkedCount = document.querySelectorAll(".row-checkbox:checked").length;
          if (selectAllCheckbox) {
            selectAllCheckbox.checked = checkedCount === rowCheckboxes.length && rowCheckboxes.length > 0;
            selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < rowCheckboxes.length;
          }
        }
      });
      
      // å…¨é¸/å–æ¶ˆå…¨é¸å­¸ç”ŸåŠŸèƒ½
      const selectAllStudentsBtn = document.getElementById("selectAllStudentsBtn");
      if (selectAllStudentsBtn) {
        selectAllStudentsBtn.addEventListener("click", function() {
          const studentsContainer = document.getElementById("interviewStudents");
          if (studentsContainer) {
            const checkboxes = studentsContainer.querySelectorAll('.student-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            // å¦‚æœå…¨éƒ¨å·²é¸ä¸­ï¼Œå‰‡å–æ¶ˆå…¨é¸ï¼›å¦å‰‡å…¨é¸
            checkboxes.forEach(checkbox => {
              checkbox.checked = !allChecked;
            });
            updateSelectedStudentsCount();
          }
        });
      }
    });

    function initMenu() {
      const sideMenu = document.getElementById('side-menu');
      const menuBtn = document.getElementById('menu-btn');
      const closeBtn = document.getElementById('close-btn');
      
      if (menuBtn) {
        menuBtn.addEventListener('click', () => {
          sideMenu.classList.add('open');
          sideMenu.setAttribute('aria-hidden', 'false');
        });
      }
      
      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          sideMenu.classList.remove('open');
          sideMenu.setAttribute('aria-hidden', 'true');
        });
      }
      
      document.addEventListener('click', (event) => {
        if (sideMenu && !sideMenu.contains(event.target) && menuBtn && !menuBtn.contains(event.target)) {
          sideMenu.classList.remove('open');
          sideMenu.setAttribute('aria-hidden', 'true');
        }
      });
    }

    function populateFilters(data, companyData, positionData) {
      const deptSelect = document.getElementById("departmentFilter");
      deptSelect.innerHTML = `<option value="">æ‰€æœ‰å­¸å¹´</option><option value="1132">1132</option><option value="1142">1142</option>`;
      
      const classSelect = document.getElementById("classFilter");
      classSelect.innerHTML = `<option value="">æ‰€æœ‰ç­ç´š</option>`;
      const classSet = new Set();
      data.forEach(r => { if(r.className) classSet.add(r.className); });
      classSet.add("å¿ ç­"); classSet.add("å­ç­");
      Array.from(classSet).sort().forEach(c => {
         if(c !== 'äº”å­') classSelect.innerHTML += `<option value="${c}">${c}</option>`;
      });

      const companyNameSelect = document.getElementById("companyNameFilter");
      companyNameSelect.innerHTML = `<option value="">æ‰€æœ‰å…¬å¸</option>`;
      const companySet = new Set();
      
      // å¦‚æœæ˜¯å» å•†ï¼Œå„ªå…ˆå¾ profile API ç²å–çš„å…¬å¸åç¨±
      if (userRole === 'vendor' && vendorCompanyName && vendorCompanyName.trim()) {
        companySet.add(vendorCompanyName.trim());
        console.log('âœ… ä½¿ç”¨ profile API çš„å…¬å¸åç¨±ï¼š', vendorCompanyName);
      } else {
        // å¦‚æœä¸æ˜¯å» å•†æˆ–æ²’æœ‰å¾ profile ç²å–åˆ°ï¼Œå¾å±¥æ­·è³‡æ–™ä¸­æå–å…¬å¸åç¨±
        data.forEach(r => { 
          if(r.company_name && r.company_name.trim()) {
            companySet.add(r.company_name.trim());
          }
        });
        
        // å¦‚æœå±¥æ­·è³‡æ–™ä¸­æ²’æœ‰å…¬å¸åç¨±ï¼Œå˜—è©¦å¾è·ç¼ºè³‡æ–™ä¸­æå–
        if (companySet.size === 0 && positionData && positionData.items && Array.isArray(positionData.items)) {
          positionData.items.forEach(job => {
            const companyName = job.company_name || job.companyName || '';
            if (companyName && companyName.trim()) {
              companySet.add(companyName.trim());
            }
          });
        }
      }
      
      // æŒ‰å…¬å¸åç¨±æ’åºå¾ŒåŠ å…¥é¸å–®
      Array.from(companySet).sort().forEach(company => {
        companyNameSelect.innerHTML += `<option value="${escapeHtml(company)}">${escapeHtml(company)}</option>`;
      });

      const companySelect = document.getElementById("companyFilter");
      companySelect.innerHTML = `<option value="">æ‰€æœ‰è·ç¼º</option>`;
      const jobSet = new Set();
      
      // å¾ API è¿”å›çš„è·ç¼ºè³‡æ–™ä¸­æå–è·ç¼º
      // æ³¨æ„ï¼š/vendor/api/positions API å·²ç¶“éæ¿¾äº†è©²å» å•†å¯ä»¥æŸ¥çœ‹çš„è·ç¼º
      // ï¼ˆåªè¿”å›è©²å» å•†é—œè¯å…¬å¸çš„è·ç¼ºï¼Œä¸”åªé¡¯ç¤ºè©²å» å•†å»ºç«‹çš„è·ç¼ºæˆ–è€å¸«å»ºç«‹çš„è·ç¼ºï¼‰
      // æ‰€ä»¥ä¸éœ€è¦å†ç”¨å…¬å¸åç¨±ä¾†éæ¿¾ï¼Œç›´æ¥é¡¯ç¤ºæ‰€æœ‰è¿”å›çš„è·ç¼ºå³å¯
      if (positionData && positionData.items && Array.isArray(positionData.items) && positionData.items.length > 0) {
          console.log('ğŸ“‹ é–‹å§‹å¡«å……è·ç¼ºä¸‹æ‹‰é¸å–®ï¼Œè·ç¼ºæ•¸é‡ï¼š', positionData.items.length);
          positionData.items.forEach(job => {
              const jobTitle = job.title || job.job_title || '';
              if (jobTitle && jobTitle.trim()) {
                  jobSet.add(jobTitle.trim());
                  console.log('  âœ… æ·»åŠ è·ç¼ºï¼š', jobTitle.trim(), 'å…¬å¸ï¼š', job.company_name || job.companyName || 'æœªçŸ¥');
              } else {
                  console.warn('  âš ï¸ è·³éè·ç¼ºï¼ˆç„¡æ¨™é¡Œï¼‰ï¼š', job);
              }
          });
          console.log('ğŸ“‹ è·ç¼ºä¸‹æ‹‰é¸å–®å¡«å……å®Œæˆï¼Œå…±', jobSet.size, 'å€‹è·ç¼º');
      } else {
          console.warn('âš ï¸ æ²’æœ‰è·ç¼ºè³‡æ–™æˆ–è·ç¼ºè³‡æ–™æ ¼å¼éŒ¯èª¤ï¼š', positionData);
          // å¦‚æœæ²’æœ‰è·ç¼ºè³‡æ–™ï¼Œå˜—è©¦å¾å±¥æ­·è³‡æ–™ä¸­æå–è·ç¼ºåç¨±
          if (data && Array.isArray(data) && data.length > 0) {
              data.forEach(r => {
                  const jobTitle = r.job_title || r.jobTitle || '';
                  if (jobTitle && jobTitle.trim()) {
                      jobSet.add(jobTitle.trim());
                  }
              });
              console.log('ğŸ“‹ å¾å±¥æ­·è³‡æ–™ä¸­æå–è·ç¼ºï¼Œå…±', jobSet.size, 'å€‹è·ç¼º');
          }
      }
      
      // å°‡æ‰€æœ‰è·ç¼ºæ’åºå¾ŒåŠ å…¥é¸å–®
      Array.from(jobSet).sort().forEach(j => {
          companySelect.innerHTML += `<option value="${escapeHtml(j)}">${escapeHtml(j)}</option>`;
      });
      
      if (jobSet.size === 0) {
          console.warn('âš ï¸ è·ç¼ºä¸‹æ‹‰é¸å–®ç‚ºç©ºï¼Œè«‹æª¢æŸ¥ï¼š');
          console.warn('  1. /vendor/api/positions API æ˜¯å¦è¿”å›äº†è·ç¼ºè³‡æ–™');
          console.warn('  2. è·ç¼ºè³‡æ–™æ ¼å¼æ˜¯å¦æ­£ç¢ºï¼ˆæ‡‰åŒ…å« items é™£åˆ—ï¼‰');
          console.warn('  3. è·ç¼ºæ˜¯å¦å±¬æ–¼è©²å» å•†é—œè¯çš„å…¬å¸');
      }
    }

    function applyFilters() {
      currentPage = 1;
      const dept = document.getElementById("departmentFilter").value.trim();
      const cls = document.getElementById("classFilter").value.trim();
      const companyNameFilter = document.getElementById("companyNameFilter").value.trim();
      const jobFilter = document.getElementById("companyFilter").value.trim();
      const status = document.getElementById("statusFilter").value.trim();
      const interviewStatus = document.getElementById("interviewStatusFilter").value.trim();
      const keyword = document.getElementById("searchBox").value.trim().toLowerCase();

      const filtered = allResumes.filter(r => {
        const matchesDept = !dept || r.department === dept;
        const matchesClass = !cls || r.className === cls;
        const matchesKeyword = (r.username && r.username.toLowerCase().includes(keyword)) ||
                               (r.original_filename && r.original_filename.toLowerCase().includes(keyword));
        
        let matchesCompanyName = true;
        if (companyNameFilter) {
          const companyName = (r.company_name || '').trim();
          matchesCompanyName = companyName === companyNameFilter;
        }
        
        let matchesJob = true;
        if (jobFilter) {
            const jobs = (r.job_title || r.jobTitle || '').toLowerCase();
            matchesJob = jobs.includes(jobFilter.toLowerCase()) || (r.job_id && String(r.job_id) === jobFilter);
        }

        let matchesStatus = true;
        if (status) {
           const statusStr = r.application_statuses || r.display_status || r.status || '';
           matchesStatus = statusStr === status;  // ä½¿ç”¨åš´æ ¼ç›¸ç­‰ï¼Œç¢ºä¿ç²¾ç¢ºåŒ¹é…
        }

        // é¢è©¦ç‹€æ…‹ç¯©é¸
        let matchesInterviewStatus = true;
        if (interviewStatus) {
          // å„ªå…ˆä½¿ç”¨ interview_status å€¼ï¼ˆå¾ resume_applications è¡¨è®€å–ï¼‰
          const rInterviewStatus = r.interview_status || 'none';
          
          // å‘å¾Œå…¼å®¹ï¼šå¦‚æœæ²’æœ‰ interview_statusï¼Œä½¿ç”¨ has_interview å’Œ interview_completed
          const key = (r.preference_id || r.preferenceId || r.id);
          const hasInterviewed = rInterviewStatus !== 'none' || interviewedSet.has(String(key)) || r.has_interview || false;
          const isInterviewCompleted = rInterviewStatus === 'finished' || r.interview_completed || false;
          
          if (interviewStatus === 'none') {
            // æœªé¢è©¦ï¼šinterview_status = 'none'
            matchesInterviewStatus = rInterviewStatus === 'none';
          } else if (interviewStatus === 'interviewing') {
            // é¢è©¦ä¸­ï¼šinterview_status = 'scheduled'
            matchesInterviewStatus = rInterviewStatus === 'scheduled';
          } else if (interviewStatus === 'completed') {
            // å·²é¢è©¦ï¼šinterview_status = 'finished'
            matchesInterviewStatus = rInterviewStatus === 'finished';
          }
        }

        return matchesDept && matchesClass && matchesCompanyName && matchesJob && matchesStatus && matchesInterviewStatus && matchesKeyword;
      });

      renderTable(filtered);
    }

    function renderTable(resumes) {
      const tbody = document.getElementById("resumeTableBody");
      tbody.innerHTML = "";
      if (resumes.length === 0) {
        // é¡¯ç¤ºæ›´æ˜ç¢ºçš„æç¤ºè¨Šæ¯ï¼Œèªªæ˜ç‚ºä»€éº¼æ²’æœ‰è³‡æ–™
        tbody.innerHTML = `
          <tr>
            <td colspan="9" style="text-align: center; color: #64748b; padding: 24px;">
              <div style="display: flex; flex-direction: column; align-items: center; gap: 12px;">
                <div style="font-size: 1.1rem; font-weight: 600; color: #475569; margin-bottom: 8px;">
                  ç›®å‰æ²’æœ‰å¯å¯©æ ¸çš„å±¥æ­·
                </div>
                <div style="font-size: 0.95rem; color: #64748b; max-width: 600px; line-height: 1.6;">
                  <p style="margin: 0; padding-left: 20px;">
                    å¯©æ ¸æ©Ÿåˆ¶èªªæ˜ï¼šæŒ‡å°è€å¸«å¯©æ ¸é€šéå¾Œï¼Œæ‰æœƒé¡¯ç¤ºåœ¨æ­¤é é¢ä¾›å» å•†å¯©æ ¸ã€‚
                  </p>
                  <p style="margin: 12px 0 0 0; padding-left: 20px;">
                    è«‹ç­‰å¾…æŒ‡å°è€å¸«å®Œæˆå¯©æ ¸
                  </p>
                </div>
              </div>
            </td>
          </tr>
        `;
        document.getElementById("pagination").innerHTML = "";
        return;
      }

      const filterStatus = document.getElementById("statusFilter").value.trim(); 
      const filterJob = document.getElementById("companyFilter").value.trim(); 

      let allRowsData = [];

      resumes.forEach(r => {
        // ç›´æ¥ä½¿ç”¨æœ€æ–°çš„å¿—é¡˜åºè³‡æ–™ï¼ˆå¾Œç«¯å·²è™•ç†ï¼‰
        const comp = r.company_name || 'â€”';
        const job = r.job_title || r.jobTitle || 'â€”';
        const pid = r.preference_id || null;
        const st = r.application_statuses || r.display_status || r.status || 'pending';
        const cm = r.comment || '';

        // ç‹€æ…‹ç¯©é¸
        if (filterStatus && st !== filterStatus) return;
        
        // è·ç¼ºç¯©é¸
        if (filterJob && !job.includes(filterJob) && filterJob !== (r.job_id ? String(r.job_id) : '')) return;

        allRowsData.push({
            ...r,
            display_company: comp,
            display_job: job,
            preference_id: pid,
            display_status: st,
            comment: cm,
            isMultiRow: true
        });
      });

      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pageData = allRowsData.slice(start, end);

      pageData.forEach(row => {
        const pid = row.preference_id || null;
        
        // æ¸²æŸ“æ¯ä¸€è¡Œï¼ŒstatusColor(row.display_status) æœƒæ±ºå®šèƒŒæ™¯è‰²ï¼ŒmapStatus æ±ºå®šæ–‡å­—
        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid #e2e8f0';
        const key = (row.preference_id || row.preferenceId || row.id);
        // å„ªå…ˆä½¿ç”¨ interview_status å€¼ï¼ˆå¾ resume_applications è¡¨è®€å–ï¼‰
        // interview_status: 'none' | 'scheduled' | 'finished'
        const interviewStatus = row.interview_status || 'none';
        
        // å‘å¾Œå…¼å®¹ï¼šå¦‚æœæ²’æœ‰ interview_statusï¼Œä½¿ç”¨ has_interview å’Œ interview_completed
        const hasInterviewed = interviewStatus !== 'none' || interviewedSet.has(String(key)) || row.has_interview || false;
        const isInterviewCompleted = interviewStatus === 'finished' || row.interview_completed || false;
        
        const rowId = `checkbox-${row.id}-${pid || 'no-pid'}`;
        tr.innerHTML = `
           <td style="padding: 14px 16px; text-align: center;">
             <input type="checkbox" class="row-checkbox" id="${rowId}" data-resume-id="${row.id}" data-preference-id="${pid || ''}" style="cursor: pointer; width: 18px; height: 18px;">
           </td>
           <td style="padding: 14px 16px;">${row.username || row.student_number || 'â€”'}</td>
           <td style="padding: 14px 16px;">${escapeHtml(row.name || row.student_name || 'â€”')}</td>
           <td style="padding: 14px 16px;">${row.upload_time || 'â€”'}</td>
           <td style="padding: 14px 16px; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(row.original_filename || 'â€”')}</td>
          <td style="padding: 14px 16px;">${escapeHtml(row.display_job)}</td>
          <td style="padding: 14px 16px;">
            <div style="display:flex; gap:6px; flex-wrap:wrap; align-items:center;">
              <span class="status-badge bg-${statusColor(row.display_status)}">${mapStatus(row.display_status)}</span>
              ${
                interviewStatus === 'finished' || isInterviewCompleted
                  ? `<span class="status-badge bg-completed">å·²é¢è©¦</span>`
                  : (interviewStatus === 'scheduled' || hasInterviewed)
                    ? `<span class="status-badge bg-interviewing">é¢è©¦ä¸­</span>`
                    : `<span class="status-badge bg-secondary" style="background-color: #94a3b8;">æœªé¢è©¦</span>`
              }
            </div>
          </td>
           <td style="padding: 14px 16px;">
             ${ renderCommentBtn(row, pid) }
           </td>
           <td style="padding: 14px 16px;">
             ${ renderActionBtns(row, pid) }
           </td>
        `;
        tbody.appendChild(tr);
      });

      renderPagination(allRowsData.length);
    }

    function renderCommentBtn(row, pid) {
        const hasComment = row.comment && row.comment.trim() !== '';
        const btnClass = hasComment ? 'text-success' : '';
        const btnText = hasComment ? 'å·²å¡«å¯«' : 'æœªå¡«å¯«';
        
        // å¦‚æœæ˜¯è€å¸«ï¼Œåªé¡¯ç¤ºæŸ¥çœ‹æ¨¡å¼ï¼ˆåªè®€ï¼‰
        const isReadOnly = userRole && userRole !== 'vendor';
        if (isReadOnly) {
            if (hasComment) {
                return `<button class="btn btn-sm btn-outline-secondary text-success" onclick="openCommentModal(${row.id}, '${escapeHtml(row.comment || '')}', ${pid ? pid : 'null'}, true)">å·²å¡«å¯«</button>`;
            } else {
                return `<span style="color:#aaa; font-size:0.9em;">æœªå¡«å¯«</span>`;
            }
        }
        
        return `<button class="btn btn-sm btn-outline-secondary ${btnClass}" onclick="openCommentModal(${row.id}, '${escapeHtml(row.comment || '')}', ${pid ? pid : 'null'}, false)">${btnText}</button>`;
    }

    function renderActionBtns(row, pid) {
        const dlBtn = `<a href="/api/download_resume/${row.id}" class="btn btn-sm btn-outline-primary" target="_blank" style="margin-right:4px;">ä¸‹è¼‰</a>`;
        
        // å¦‚æœæ˜¯è€å¸«ï¼Œåªé¡¯ç¤ºä¸‹è¼‰æŒ‰éˆ•ï¼ˆåªè®€æ¨¡å¼ï¼‰
        if (userRole && userRole !== 'vendor') {
            return dlBtn;
        }
        
        const key = (pid || row.preference_id || row.preferenceId || row.id);
        const hasInterviewed = interviewedSet.has(String(key)) || row.has_interview || false;
        const isInterviewCompleted = row.interview_completed || false;

        // å» å•†å¯ä»¥é€²è¡Œå¯©æ ¸æ“ä½œ
        const approveClick = `approveResume(${row.id}, ${pid ? `'${pid}'` : 'null'})`;
        const rejectClick = `rejectResume(${row.id}, ${pid ? `'${pid}'` : 'null'})`;
        const interviewClick = `sendInterview(${row.student_id || 'null'}, ${row.company_id || 'null'}, ${row.id}, ${pid ? `'${pid}'` : 'null'})`;
        const markCompletedClick = `markInterviewCompleted(${row.id}, ${pid ? `'${pid}'` : 'null'})`;

        // ç„¡è«–ç‹€æ…‹ç‚ºä½•ï¼Œä¿ç•™æŒ‰éˆ•
        let btns = `<div style="display:flex; align-items:center; flex-wrap:wrap; gap:4px;">${dlBtn}`;
        btns += `<button class="btn btn-sm btn-outline-danger" style="margin-right:4px;" onclick="${rejectClick}">é€€ä»¶</button>`;
        btns += `<button class="btn btn-sm btn-outline-success" onclick="${approveClick}">é€šé</button>`;
        btns += `</div>`;
        return btns;
    }

    // å» å•†é€å‡ºé¢è©¦é€šçŸ¥
    function sendInterview(studentId, companyId, resumeId, preferenceId) {
      if (!studentId) {
        alert("æ‰¾ä¸åˆ°å­¸ç”Ÿè³‡æ–™ï¼Œç„¡æ³•ç™¼é€é¢è©¦é€šçŸ¥");
        return;
      }
      const contentRaw = prompt("è«‹è¼¸å…¥è¦çµ¦å­¸ç”Ÿçš„é¢è©¦é€šçŸ¥å…§å®¹ï¼ˆå¯ç•™ç©ºï¼ŒæŒ‰ã€Œå–æ¶ˆã€å‰‡ä¸é€å‡ºï¼‰ï¼š");
      if (contentRaw === null) {
        // ä½¿ç”¨è€…æŒ‰ä¸‹å–æ¶ˆï¼Œä¸é€å‡ºé€šçŸ¥
        return;
      }
      const content = contentRaw.trim();
      const payload = {
        student_id: studentId,
        company_id: companyId || null,
        notification_type: "interview",
        content: content,
        preference_id: preferenceId || null
      };

      fetch("/vendor/api/send_notification", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("âœ… é¢è©¦é€šçŸ¥å·²ç™¼é€çµ¦å­¸ç”Ÿå’ŒæŒ‡å°è€å¸«");
          // é‡æ–°è¼‰å…¥è³‡æ–™
          fetch(getResumeApiUrl()).then(r=>r.json()).then(d=>{
            if(d.success) { 
              allResumes=d.resumes;
              // æ ¹æ“šå¾Œç«¯è¿”å›çš„è³‡æ–™æ›´æ–° interviewedSet
              // å„ªå…ˆä½¿ç”¨ interview_status å€¼ï¼ˆå¾ resume_applications è¡¨è®€å–ï¼‰
              interviewedSet.clear();
              allResumes.forEach(r => {
                const interviewStatus = r.interview_status || 'none';
                if (interviewStatus !== 'none' || r.has_interview || r.interview_completed) {
                  const key = String(r.preference_id || r.preferenceId || r.id);
                  interviewedSet.add(key);
                }
              });
              applyFilters(); 
            }
          });
        } else {
          alert("ç™¼é€å¤±æ•—ï¼š" + (data.message || "æœªçŸ¥éŒ¯èª¤"));
        }
      })
      .catch(err => {
        console.error("sendInterview error:", err);
        alert("ç™¼é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
      });
    }

    // æ¨™è¨˜é¢è©¦å·²å®Œæˆ
    function markInterviewCompleted(resumeId, preferenceId) {
      if (!preferenceId || preferenceId === 'null') {
        alert("æ‰¾ä¸åˆ°å¿—é¡˜åºè³‡æ–™ï¼Œç„¡æ³•æ¨™è¨˜é¢è©¦å®Œæˆ");
        return;
      }
      
      if (!confirm("ç¢ºå®šè¦æ¨™è¨˜ç‚ºå·²é¢è©¦å—ï¼Ÿ")) {
        return;
      }

      fetch("/vendor/api/mark_interview_completed", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          preference_id: preferenceId
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("âœ… å·²æ¨™è¨˜ç‚ºé¢è©¦å®Œæˆ");
          // é‡æ–°è¼‰å…¥è³‡æ–™
          fetch(getResumeApiUrl()).then(r=>r.json()).then(d=>{
            if(d.success) { 
              allResumes=d.resumes;
              // æ ¹æ“šå¾Œç«¯è¿”å›çš„è³‡æ–™æ›´æ–° interviewedSet
              // å„ªå…ˆä½¿ç”¨ interview_status å€¼ï¼ˆå¾ resume_applications è¡¨è®€å–ï¼‰
              interviewedSet.clear();
              allResumes.forEach(r => {
                const interviewStatus = r.interview_status || 'none';
                if (interviewStatus !== 'none' || r.has_interview || r.interview_completed) {
                  const key = String(r.preference_id || r.preferenceId || r.id);
                  interviewedSet.add(key);
                }
              });
              applyFilters(); 
            }
          });
        } else {
          alert("æ“ä½œå¤±æ•—ï¼š" + (data.message || "æœªçŸ¥éŒ¯èª¤"));
        }
      })
      .catch(err => {
        console.error("markInterviewCompleted error:", err);
        alert("æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
      });
    }

    function renderPagination(totalItems) {
      const totalPages = Math.ceil(totalItems / rowsPerPage);
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";
      if (totalPages <= 1) return;
      for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement("li");
        li.className = `page-item ${i === currentPage ? "active" : ""}`;
        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        li.onclick = (e) => { e.preventDefault(); currentPage = i; applyFilters(); }; 
        pagination.appendChild(li);
      }
    }

    // æ›´æ–°ç‹€æ…‹å‡½å¼
    function approveResume(resumeId, preferenceId) {
      if (!confirm("ç¢ºå®šè¦å°‡æ­¤è·ç¼ºç”³è«‹æ¨™è¨˜ç‚ºé€šéå—ï¼Ÿ")) return;
      
      const body = { status: 'approved' };
      if (preferenceId && preferenceId !== 'null') body.preference_id = preferenceId;

      console.log('ğŸ“¤ ç™¼é€é€šéè«‹æ±‚:', { resumeId, preferenceId, body });

      fetch(`/vendor/api/review_resume/${resumeId}`, { 
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(body)
      })
      .then(res => {
          console.log('ğŸ“¥ æ”¶åˆ°éŸ¿æ‡‰:', res.status, res.statusText);
          if (!res.ok) {
              return res.text().then(text => {
                  console.error('âŒ éŸ¿æ‡‰éŒ¯èª¤:', text);
                  throw new Error(`HTTP ${res.status}: ${text}`);
              });
          }
          return res.json();
      })
      .then(data => {
          console.log('ğŸ“‹ éŸ¿æ‡‰æ•¸æ“š:', data);
          if (data.success) {
              alert("âœ… ç‹€æ…‹æ›´æ–°æˆåŠŸ");
              // é‡æ–°è¼‰å…¥è³‡æ–™
              fetch(getResumeApiUrl())
              .then(r => {
                  if (!r.ok) {
                      throw new Error(`HTTP ${r.status}`);
                  }
                  return r.json();
              })
              .then(d => {
                  if(d.success) { 
                    allResumes=d.resumes;
                    console.log('âœ… é‡æ–°è¼‰å…¥è³‡æ–™æˆåŠŸï¼Œå…±', allResumes.length, 'ç­†å±¥æ­·');
                    
                    // èª¿è©¦ï¼šæª¢æŸ¥ç‹€æ…‹æ˜¯å¦æ­£ç¢ºæ›´æ–°
                    allResumes.forEach((r, idx) => {
                      const status = r.display_status || r.status || r.application_statuses || 'unknown';
                      console.log(`å±¥æ­· ${idx + 1}: id=${r.id}, preference_id=${r.preference_id}, display_status=${status}, status=${r.status}`);
                    });
                    
                    // æ ¹æ“šå¾Œç«¯è¿”å›çš„è³‡æ–™æ›´æ–° interviewedSet
                    interviewedSet.clear();
                    allResumes.forEach(r => {
                      if (r.has_interview || r.interview_completed) {
                        const key = String(r.preference_id || r.preferenceId || r.id);
                        interviewedSet.add(key);
                      }
                    });
                    applyFilters(); 
                  } else {
                      console.error('âŒ é‡æ–°è¼‰å…¥è³‡æ–™å¤±æ•—:', d.message);
                      alert("ç‹€æ…‹å·²æ›´æ–°ï¼Œä½†é‡æ–°è¼‰å…¥è³‡æ–™å¤±æ•—ï¼š" + (d.message || 'æœªçŸ¥éŒ¯èª¤'));
                  }
              })
              .catch(err => {
                  console.error('âŒ é‡æ–°è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
                  alert("ç‹€æ…‹å·²æ›´æ–°ï¼Œä½†é‡æ–°è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message);
              });
          } else {
              alert("å¤±æ•—ï¼š" + (data.message || 'æœªçŸ¥éŒ¯èª¤'));
          }
      })
      .catch(err => {
          console.error('âŒ è«‹æ±‚å¤±æ•—:', err);
          alert("è«‹æ±‚å¤±æ•—ï¼š" + err.message);
      });
    }

    function rejectResume(resumeId, preferenceId) {
       if (!confirm("ç¢ºå®šè¦é€€ä»¶æ­¤ç”³è«‹ï¼Ÿ")) return;
       currentResumeId = resumeId;
       currentPreferenceId = preferenceId && preferenceId !== 'null' ? preferenceId : null;
       
       document.getElementById("commentInput").value = "";
       document.getElementById("commentModalLabel").textContent = "âŒ å¡«å¯«é€€ä»¶åŸå› ";
       document.getElementById("saveCommentBtn").textContent = "ç¢ºèªé€€ä»¶";
       const modal = new bootstrap.Modal(document.getElementById("commentModal"));
       modal.show();
       
       const saveBtn = document.getElementById("saveCommentBtn");
       saveBtn.onclick = () => {
           const reason = document.getElementById("commentInput").value.trim();
           if(!reason) { alert("è«‹å¡«å¯«é€€ä»¶åŸå› "); return; }
           
           const body = { status: 'rejected', comment: reason };
           if (currentPreferenceId) body.preference_id = currentPreferenceId;

           fetch(`/vendor/api/review_resume/${currentResumeId}`, {
               method: 'POST',
               headers: {'Content-Type': 'application/json'},
               body: JSON.stringify(body)
           }).then(res => res.json()).then(data => {
               if(data.success) {
                   alert("âœ… å·²é€€ä»¶");
                   modal.hide();
                   fetch(getResumeApiUrl()).then(r=>r.json()).then(d=>{
                       if(d.success) { 
                         allResumes=d.resumes;
                         // æ ¹æ“šå¾Œç«¯è¿”å›çš„è³‡æ–™æ›´æ–° interviewedSet
                         // å„ªå…ˆä½¿ç”¨ interview_status å€¼ï¼ˆå¾ resume_applications è¡¨è®€å–ï¼‰
                         interviewedSet.clear();
                         allResumes.forEach(r => {
                           const interviewStatus = r.interview_status || 'none';
                           if (interviewStatus !== 'none' || r.has_interview || r.interview_completed) {
                             const key = String(r.preference_id || r.preferenceId || r.id);
                             interviewedSet.add(key);
                           }
                         });
                         applyFilters(); 
                       }
                   });
               } else {
                   alert("å¤±æ•—ï¼š" + data.message);
               }
           });
       };
    }

    function openCommentModal(id, comment, pid, readonly) {
        document.getElementById("commentInput").value = comment || '';
        document.getElementById("commentInput").readOnly = readonly;
        document.getElementById("commentModalLabel").textContent = readonly ? "æŸ¥çœ‹ç•™è¨€" : "ç·¨è¼¯ç•™è¨€";
        const saveBtn = document.getElementById("saveCommentBtn");
        saveBtn.style.display = readonly ? 'none' : 'block';
        saveBtn.textContent = "å„²å­˜";
        
        if (!readonly) {
            currentResumeId = id;
            currentPreferenceId = pid && pid !== 'null' ? pid : null;
            saveBtn.onclick = saveComment; 
        }
        new bootstrap.Modal(document.getElementById("commentModal")).show();
    }

    function saveComment() {
        const val = document.getElementById("commentInput").value.trim();
        const body = { field: 'comment', value: val, resume_id: currentResumeId };
        if(currentPreferenceId) body.preference_id = currentPreferenceId;

        fetch("/api/update_resume_field", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        }).then(res => res.json()).then(data => {
             if(data.success) {
                 alert("ç•™è¨€å·²æ›´æ–°");
                 bootstrap.Modal.getInstance(document.getElementById("commentModal")).hide();
                 fetch(getResumeApiUrl()).then(r=>r.json()).then(d=>{
                     if(d.success) { 
                       allResumes=d.resumes;
                       // æ ¹æ“šå¾Œç«¯è¿”å›çš„è³‡æ–™æ›´æ–° interviewedSet
                       interviewedSet.clear();
                       allResumes.forEach(r => {
                         if (r.has_interview) {
                           const key = String(r.preference_id || r.preferenceId || r.id);
                           interviewedSet.add(key);
                         }
                       });
                       applyFilters(); 
                     }
                 });
             } else {
                 alert("å¤±æ•—");
             }
        });
    }

    // æœˆæ›†ç›¸é—œè®Šæ•¸
    let currentCalendarDate = new Date();
    let selectedInterviewDate = null;
    // å­˜å„²é¢è©¦æ’ç¨‹ï¼ˆæ ¼å¼ï¼š'YYYY-MM-DD' => {timeStart: 'HH:MM', timeEnd: 'HH:MM', location: '...', notes: '...', isOwn: true/false}ï¼‰
    const interviewSchedules = new Map();
    // å­˜å„²æ‰€æœ‰å» å•†çš„é¢è©¦æ’ç¨‹ï¼ˆç”¨æ–¼é¡¯ç¤ºå…¶ä»–å» å•†å·²é ç´„çš„æ™‚é–“ï¼‰
    const allVendorSchedules = new Map();
    
    // å¾æœ¬åœ°å­˜å„²è¼‰å…¥é¢è©¦æ’ç¨‹
    function loadInterviewSchedules() {
      const saved = localStorage.getItem('interviewSchedules');
      if (saved) {
        try {
          const schedules = JSON.parse(saved);
          Object.keys(schedules).forEach(date => {
            interviewSchedules.set(date, schedules[date]);
          });
        } catch (e) {
          console.error('è¼‰å…¥é¢è©¦æ’ç¨‹å¤±æ•—:', e);
        }
      }
    }
    
    // å…¬å¸åç¨±åŒ¹é…å‡½æ•¸ï¼ˆè™•ç†ã€Œæœ‰é™å…¬å¸ã€å’Œã€Œè‚¡ä»½æœ‰é™å…¬å¸ã€ç­‰å·®ç•°ï¼‰
    function isCompanyNameMatch(name1, name2) {
      if (!name1 || !name2) return false;
      
      const n1 = name1.trim();
      const n2 = name2.trim();
      
      // å®Œå…¨åŒ¹é…
      if (n1 === n2) return true;
      
      // ç§»é™¤å¸¸è¦‹çš„å¾Œç¶´å·®ç•°é€²è¡Œæ¯”è¼ƒ
      const normalize = (name) => {
        return name
          .replace(/è‚¡ä»½æœ‰é™å…¬å¸$/, '')
          .replace(/æœ‰é™å…¬å¸$/, '')
          .replace(/è‚¡ä»½å…¬å¸$/, '')
          .replace(/å…¬å¸$/, '')
          .trim();
      };
      
      const normalized1 = normalize(n1);
      const normalized2 = normalize(n2);
      
      // å¦‚æœæ¨™æº–åŒ–å¾Œçš„åç¨±ç›¸åŒï¼Œè¦–ç‚ºåŒ¹é…
      if (normalized1 && normalized2 && normalized1 === normalized2) {
        return true;
      }
      
      return false;
    }
    
    // å¾å¾Œç«¯è¼‰å…¥æ‰€æœ‰å» å•†çš„é¢è©¦æ’ç¨‹
    async function loadAllVendorSchedules() {
      try {
        console.log('ğŸ”„ é–‹å§‹è¼‰å…¥æ‰€æœ‰å» å•†çš„é¢è©¦æ’ç¨‹...');
        const res = await fetch('/vendor/api/all_interview_schedules');
        const data = await res.json();
        
        if (data.success && data.schedules) {
          // æ¸…ç©ºç¾æœ‰è³‡æ–™
          allVendorSchedules.clear();
          
          console.log(`ğŸ“‹ æ”¶åˆ° ${data.schedules.length} å€‹æ’ç¨‹è¨˜éŒ„`);
          
          // æŒ‰æ—¥æœŸåˆ†çµ„ï¼ŒåŒæ™‚å°‡è‡ªå·±çš„æ’ç¨‹ä¹ŸåŠ å…¥åˆ° interviewSchedules
          // å…ˆæ”¶é›†æ¯å€‹æ—¥æœŸè‡ªå·±çš„æ’ç¨‹ä¿¡æ¯ï¼ˆåŒ…æ‹¬å­¸ç”Ÿåˆ—è¡¨ï¼‰
          const ownSchedulesByDate = new Map();
          
          data.schedules.forEach(schedule => {
            const date = schedule.date;
            if (!date) {
              console.warn('âš ï¸ æ’ç¨‹è¨˜éŒ„ç¼ºå°‘æ—¥æœŸ:', schedule);
              return;
            }
            
            if (!allVendorSchedules.has(date)) {
              allVendorSchedules.set(date, []);
            }
            allVendorSchedules.get(date).push(schedule);
            
            // åˆ¤æ–·æ˜¯å¦ç‚ºè‡ªå·±çš„æ’ç¨‹ï¼šå„ªå…ˆé€šéå…¬å¸åç¨±åˆ¤æ–·ï¼ˆæœ€æº–ç¢ºï¼‰ï¼Œç„¶å¾Œæª¢æŸ¥ is_own
            let isOwnSchedule = false;
            if (vendorCompanyName && schedule.company_name) {
              // ä½¿ç”¨å¯¬é¬†çš„å…¬å¸åç¨±åŒ¹é…ï¼ˆè™•ç†ã€Œæœ‰é™å…¬å¸ã€å’Œã€Œè‚¡ä»½æœ‰é™å…¬å¸ã€ç­‰å·®ç•°ï¼‰
              isOwnSchedule = isCompanyNameMatch(schedule.company_name, vendorCompanyName);
              if (isOwnSchedule) {
                // å…¬å¸åç¨±åŒ¹é…ï¼Œå°±æ˜¯è‡ªå·±çš„æ’ç¨‹ï¼ˆå³ä½¿ is_own=falseï¼‰
                console.log(`âœ… [loadAllVendorSchedules] é€šéå…¬å¸åç¨±åˆ¤æ–·ç‚ºè‡ªå·±çš„æ’ç¨‹: ${schedule.company_name} â‰ˆ ${vendorCompanyName}`);
              } else if (schedule.is_own === true) {
                // å…¬å¸åç¨±ä¸åŒ¹é…ä½† is_own=trueï¼Œå¯èƒ½æ˜¯å¾Œç«¯åˆ¤æ–·éŒ¯èª¤ï¼Œè¦–ç‚ºå…¶ä»–å» å•†çš„æ’ç¨‹
                console.warn(`âš ï¸ [loadAllVendorSchedules] è­¦å‘Šï¼šæ’ç¨‹ is_own=true ä½†å…¬å¸åç¨±ä¸åŒ¹é… (${schedule.company_name} !== ${vendorCompanyName})ï¼Œè¦–ç‚ºå…¶ä»–å» å•†çš„æ’ç¨‹`);
              }
            } else {
              // å¦‚æœæ²’æœ‰å…¬å¸åç¨±ä¿¡æ¯ï¼Œå‰‡ä½¿ç”¨ is_own åˆ¤æ–·
              isOwnSchedule = schedule.is_own === true;
            }
            
            // å¦‚æœæ˜¯è‡ªå·±çš„æ’ç¨‹ï¼Œæ”¶é›†ä¿¡æ¯
            if (isOwnSchedule) {
              if (!ownSchedulesByDate.has(date)) {
                ownSchedulesByDate.set(date, {
                  timeStart: schedule.time_start || '',
                  timeEnd: schedule.time_end || '',
                  location: schedule.location || '',
                  notes: '',
                  students: []
                });
              } else {
                // å¦‚æœè©²æ—¥æœŸå·²æœ‰æ’ç¨‹ï¼Œæ›´æ–°æ™‚é–“å’Œåœ°é»ï¼ˆä½¿ç”¨ç¬¬ä¸€å€‹éç©ºå€¼ï¼‰
                const scheduleData = ownSchedulesByDate.get(date);
                if (!scheduleData.timeStart && schedule.time_start) {
                  scheduleData.timeStart = schedule.time_start;
                }
                if (!scheduleData.timeEnd && schedule.time_end) {
                  scheduleData.timeEnd = schedule.time_end;
                }
                if (!scheduleData.location && schedule.location) {
                  scheduleData.location = schedule.location;
                }
              }
              // æ”¶é›†è©²æ—¥æœŸçš„æ‰€æœ‰å­¸ç”ŸID
              if (schedule.student_id) {
                const scheduleData = ownSchedulesByDate.get(date);
                if (!scheduleData.students.includes(String(schedule.student_id))) {
                  scheduleData.students.push(String(schedule.student_id));
                }
              }
            }
          });
          
          // æ›´æ–° interviewSchedulesï¼ˆè¦†è“‹ç¾æœ‰æ•¸æ“šï¼Œç¢ºä¿ç·¨è¼¯æ™‚èƒ½è¼‰å…¥æœ€æ–°æ•¸æ“šï¼‰
          ownSchedulesByDate.forEach((scheduleData, date) => {
            interviewSchedules.set(date, scheduleData);
            console.log(`âœ… æ›´æ–°æ’ç¨‹ ${date}: æ™‚é–“=${scheduleData.timeStart}-${scheduleData.timeEnd}, å­¸ç”Ÿ=${scheduleData.students.join(',')}`);
          });
          
          // ä¸å†ä¿å­˜åˆ°æœ¬åœ°å­˜å„²ï¼Œå®Œå…¨ä¾è³´è³‡æ–™åº«
          // saveInterviewSchedulesToStorage();
          
          console.log('âœ… å·²è¼‰å…¥æ‰€æœ‰å» å•†çš„é¢è©¦æ’ç¨‹ï¼Œå…±', allVendorSchedules.size, 'å€‹æ—¥æœŸæœ‰æ’ç¨‹');
          // èª¿è©¦ï¼šæ‰“å°æ¯å€‹æ’ç¨‹çš„è©³ç´°ä¿¡æ¯ï¼ŒåŒ…æ‹¬å…¬å¸åç¨±æ¯”è¼ƒ
          allVendorSchedules.forEach((schedules, date) => {
            schedules.forEach(schedule => {
              const companyMatch = vendorCompanyName && schedule.company_name ? 
                (schedule.company_name.trim() === vendorCompanyName.trim()) : 'ç„¡æ³•æ¯”è¼ƒ';
              console.log(`ğŸ“… ${date}: å­¸ç”ŸID=${schedule.student_id}, å…¬å¸=${schedule.company_name}, is_own=${schedule.is_own}, ç•¶å‰å» å•†=${vendorCompanyName}, å…¬å¸åç¨±åŒ¹é…=${companyMatch}, æ™‚é–“=${schedule.time_start || ''}-${schedule.time_end || ''}`);
            });
          });
        } else {
          console.warn('âš ï¸ è¼‰å…¥æ’ç¨‹å¤±æ•—æˆ–æ²’æœ‰æ’ç¨‹:', data);
        }
      } catch (err) {
        console.error('âŒ è¼‰å…¥æ‰€æœ‰å» å•†é¢è©¦æ’ç¨‹å¤±æ•—:', err);
      }
    }
    
    // ä¿å­˜é¢è©¦æ’ç¨‹åˆ°æœ¬åœ°å­˜å„²
    function saveInterviewSchedulesToStorage() {
      const schedules = {};
      interviewSchedules.forEach((value, key) => {
        schedules[key] = value;
      });
      localStorage.setItem('interviewSchedules', JSON.stringify(schedules));
    }
    
    // åˆå§‹åŒ–æ™‚è¼‰å…¥ï¼ˆåªå¾è³‡æ–™åº«è¼‰å…¥ï¼Œä¸æ¸…é™¤æœ¬åœ°å­˜å„²ä½†ä¹Ÿä¸ä½¿ç”¨å®ƒï¼‰
    // æ³¨æ„ï¼šä¸å†å¾ localStorage è¼‰å…¥ï¼Œå®Œå…¨ä¾è³´è³‡æ–™åº«
    loadAllVendorSchedules(); // è¼‰å…¥æ‰€æœ‰å» å•†çš„é¢è©¦æ’ç¨‹

    // å¡«å……é¢è©¦åœ°é»ä¸‹æ‹‰é¸å–®ï¼ˆåŒ…å«å›ºå®šåœ°é»èˆ‡å…¬å¸åç¨±ï¼‰
    function populateLocationDropdown() {
      const locationSelect = document.getElementById('interviewLocation');
      if (!locationSelect) return;
      
      // æ¸…ç©ºç¾æœ‰é¸é …ï¼ˆä¿ç•™ç¬¬ä¸€å€‹ã€Œè«‹é¸æ“‡ã€é¸é …ï¼‰
      locationSelect.innerHTML = '<option value=\"\">è«‹é¸æ“‡é¢è©¦åœ°é»</option>';
      
      // å›ºå®šåŠ å…¥ã€Œåº·å¯§å¤§å­¸ç§‘è¾¦ã€
      const schoolOption = document.createElement('option');
      schoolOption.value = 'åº·å¯§å¤§å­¸ç§‘è¾¦';
      schoolOption.textContent = 'åº·å¯§å¤§å­¸ç§‘è¾¦';
      locationSelect.appendChild(schoolOption);
      
      // ä½¿ç”¨ Set é¿å…é‡è¤‡å…¬å¸åç¨±
      const added = new Set(['åº·å¯§å¤§å­¸ç§‘è¾¦']);
      interviewCompanyNames.forEach(name => {
        if (name && !added.has(name)) {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          locationSelect.appendChild(opt);
          added.add(name);
        }
      });
      
      // æ·»åŠ ã€Œå…¶ä»–ã€é¸é …
      const otherOption = document.createElement('option');
      otherOption.value = 'other';
      otherOption.textContent = 'å…¶ä»–';
      locationSelect.appendChild(otherOption);
      
      // ç›£è½åœ°é»é¸æ“‡è®ŠåŒ–ï¼Œé¡¯ç¤º/éš±è—ã€Œå…¶ä»–ã€è¼¸å…¥æ¡†
      locationSelect.addEventListener('change', function() {
        const otherInput = document.getElementById('interviewLocationOther');
        if (otherInput) {
          if (this.value === 'other') {
            otherInput.style.display = 'block';
            otherInput.required = true;
          } else {
            otherInput.style.display = 'none';
            otherInput.required = false;
            otherInput.value = '';
          }
        }
      });
    }
    
    // æª¢æŸ¥å­¸ç”Ÿæ˜¯å¦å·²ç¶“è¢«å…¶ä»–å» å•†å®‰æ’äº†é¢è©¦
    function isStudentScheduledByOtherVendor(studentId, selectedDate) {
      if (!selectedDate) {
        console.log('âš ï¸ isStudentScheduledByOtherVendor: æ²’æœ‰é¸æ“‡æ—¥æœŸ');
        return null;
      }
      
      if (!allVendorSchedules.has(selectedDate)) {
        console.log(`âš ï¸ isStudentScheduledByOtherVendor: æ—¥æœŸ ${selectedDate} æ²’æœ‰æ’ç¨‹`);
        return null;
      }
      
      const schedules = allVendorSchedules.get(selectedDate);
      console.log(`ğŸ” æª¢æŸ¥å­¸ç”Ÿ ${studentId} åœ¨æ—¥æœŸ ${selectedDate} çš„æ’ç¨‹ç‹€æ…‹ï¼Œå…±æœ‰ ${schedules.length} å€‹æ’ç¨‹`);
      
      // éæ¿¾æ‰è‡ªå·±çš„æ’ç¨‹ï¼Œåªæª¢æŸ¥å…¶ä»–å» å•†çš„æ’ç¨‹
      const otherVendorSchedules = schedules.filter(s => !s.is_own);
      console.log(`ğŸ” å…¶ä»–å» å•†çš„æ’ç¨‹æ•¸é‡: ${otherVendorSchedules.length}`);
      
      // æª¢æŸ¥è©²å­¸ç”Ÿæ˜¯å¦åœ¨å…¶ä»–å» å•†çš„æ’ç¨‹ä¸­
      for (const schedule of otherVendorSchedules) {
        console.log(`ğŸ” æª¢æŸ¥æ’ç¨‹: student_id=${schedule.student_id}, ç›®æ¨™student_id=${studentId}, åŒ¹é…=${schedule.student_id && String(schedule.student_id) === String(studentId)}`);
        if (schedule.student_id && String(schedule.student_id) === String(studentId)) {
          console.log(`âœ… æ‰¾åˆ°è¡çª: å­¸ç”Ÿ ${studentId} å·²è¢« ${schedule.company_name} å®‰æ’åœ¨ ${schedule.time_start}-${schedule.time_end}`);
          return {
            date: schedule.date,
            time_start: schedule.time_start,
            time_end: schedule.time_end,
            company_name: schedule.company_name || 'å…¶ä»–å» å•†'
          };
        }
      }
      
      console.log(`âœ… å­¸ç”Ÿ ${studentId} åœ¨æ—¥æœŸ ${selectedDate} æ²’æœ‰è¡çª`);
      return null;
    }
    
    // å¡«å……å­¸ç”Ÿä¸‹æ‹‰é¸å–®ï¼ˆå¯è¤‡é¸ï¼‰
    // isEditMode: true è¡¨ç¤ºç·¨è¼¯æ¨¡å¼ï¼Œfalse è¡¨ç¤ºæ–°å¢æ¨¡å¼
    function populateStudentsDropdown(isEditMode = false) {
      const studentsContainer = document.getElementById('interviewStudents');
      if (!studentsContainer) return;
      
      // æ¸…ç©ºç¾æœ‰é¸é …
      studentsContainer.innerHTML = '';
      
      // ç²å–ç•¶å‰é¸æ“‡çš„æ—¥æœŸ
      const selectedDateStr = selectedInterviewDate ? formatDate(selectedInterviewDate) : null;
      
      // å¾ allResumes ä¸­æå–å­¸ç”Ÿè³‡æ–™ï¼ˆä¿ç•™æ¯å€‹å­¸ç”Ÿå°æ‡‰çš„ application_id å’Œ job_idï¼‰
      // é‡è¦ï¼šallResumes æ‡‰è©²åªåŒ…å«ç•¶å‰å…¬å¸çš„å­¸ç”Ÿè¨˜éŒ„ï¼Œä½†ç‚ºäº†å®‰å…¨èµ·è¦‹ï¼Œæˆ‘å€‘å„ªå…ˆä½¿ç”¨æœ‰ application_id çš„è¨˜éŒ„
      const studentMap = new Map();
      allResumes.forEach(r => {
        const studentId = r.student_id || r.id;
        const studentName = r.name || r.student_name || 'æœªçŸ¥';
        const studentUsername = r.username || r.student_number || '';
        const applicationId = r.application_id || null; // åªä½¿ç”¨çœŸæ­£çš„ application_idï¼Œä¸ä½¿ç”¨ preference_id
        const jobId = r.job_id || r.jobId || null;
        const companyId = r.company_id || null; // ä¿å­˜ company_id ä»¥ä¾¿é©—è­‰
        const key = String(studentId);
        
        // å¦‚æœè©²å­¸ç”Ÿå°šæœªåŠ å…¥ï¼Œå‰‡åŠ å…¥
        if (!studentMap.has(key) && studentId) {
          studentMap.set(key, {
            id: studentId,
            name: studentName,
            username: studentUsername,
            applicationId: applicationId,
            jobId: jobId,
            companyId: companyId,
            displayText: `${studentName} (${studentUsername})`
          });
        } else if (studentMap.has(key)) {
          // å¦‚æœå·²å­˜åœ¨ï¼Œå„ªå…ˆä½¿ç”¨æœ‰ application_id çš„è¨˜éŒ„
          const existing = studentMap.get(key);
          // å¦‚æœç¾æœ‰è¨˜éŒ„æ²’æœ‰ application_idï¼Œä½†æ–°è¨˜éŒ„æœ‰ï¼Œå‰‡æ›´æ–°
          if (!existing.applicationId && applicationId) {
            existing.applicationId = applicationId;
            existing.jobId = jobId;
            existing.companyId = companyId;
          }
          // å¦‚æœå…©å€‹éƒ½æœ‰ application_idï¼Œå„ªå…ˆä½¿ç”¨æœ‰ company_id åŒ¹é…çš„ï¼ˆé›–ç„¶ç†è«–ä¸Šæ‡‰è©²éƒ½åŒ¹é…ï¼‰
          else if (existing.applicationId && applicationId && companyId) {
            // ä¿æŒç¾æœ‰çš„è¨˜éŒ„ï¼ˆå› ç‚º allResumes æ‡‰è©²å·²ç¶“éæ¿¾äº†å…¬å¸ï¼‰
          }
        }
      });
      
      // æŒ‰å§“åæ’åºå¾ŒåŠ å…¥é¸å–®
      const sortedStudents = Array.from(studentMap.values()).sort((a, b) => {
        return a.name.localeCompare(b.name, 'zh-Hant');
      });
      
      sortedStudents.forEach(student => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'student-checkbox-item';
        
        // æª¢æŸ¥è©²å­¸ç”Ÿæ˜¯å¦å·²ç¶“è¢«ç•¶å‰å» å•†å®‰æ’äº†é¢è©¦ï¼ˆåœ¨åŒä¸€å¤©ï¼‰
        // æ³¨æ„ï¼šåªæœ‰è¢«è‡ªå·±å®‰æ’çš„å­¸ç”Ÿæ‰è¨­ç‚ºå”¯è®€ï¼Œè¢«å…¶ä»–å» å•†å®‰æ’çš„å­¸ç”Ÿä¸è¨­ç‚ºå”¯è®€ï¼ˆä¿å­˜æ™‚æœƒæª¢æŸ¥è¡çªï¼‰
        // ä½†åœ¨ç·¨è¼¯æ¨¡å¼ä¸‹ï¼Œå³ä½¿æ˜¯è‡ªå·±å®‰æ’çš„å­¸ç”Ÿä¹Ÿä¸è¨­ç‚ºå”¯è®€ï¼ˆå› ç‚ºé€™æ˜¯ç·¨è¼¯ç¾æœ‰æ’ç¨‹ï¼‰
        let ownSchedule = null;
        if (selectedDateStr && allVendorSchedules.has(selectedDateStr)) {
          const schedules = allVendorSchedules.get(selectedDateStr);
          ownSchedule = schedules.find(s => {
            // æª¢æŸ¥æ˜¯å¦ç‚ºè‡ªå·±çš„æ’ç¨‹ä¸”å­¸ç”ŸIDåŒ¹é…
            if (String(s.student_id) !== String(student.id)) {
              return false;
            }
            // ä½¿ç”¨å¯¬é¬†çš„å…¬å¸åç¨±åŒ¹é…
            if (vendorCompanyName && s.company_name) {
              return isCompanyNameMatch(s.company_name, vendorCompanyName);
            }
            // å¦‚æœæ²’æœ‰å…¬å¸åç¨±ä¿¡æ¯ï¼Œå‰‡ä½¿ç”¨ is_own åˆ¤æ–·
            return s.is_own === true;
          });
        }
        
        // åªæœ‰è¢«è‡ªå·±å®‰æ’çš„å­¸ç”Ÿæ‰è¨­ç‚ºå”¯è®€ï¼Œä¸”åªåœ¨æ–°å¢æ¨¡å¼ä¸‹ï¼ˆç·¨è¼¯æ¨¡å¼ä¸‹ä¸è¨­ç‚ºå”¯è®€ï¼‰
        const isDisabled = !isEditMode && ownSchedule !== null && ownSchedule !== undefined;
        
        if (isDisabled && ownSchedule) {
          itemDiv.style.opacity = '0.6';
          itemDiv.style.cursor = 'not-allowed';
          
          // å·²è¢«è‡ªå·±å®‰æ’
          const timeDisplay = ownSchedule.time_end 
            ? `${ownSchedule.time_start || ''}-${ownSchedule.time_end}`
            : ownSchedule.time_start || '';
          itemDiv.title = `è©²å­¸ç”Ÿå·²è¢«æ‚¨å®‰æ’åœ¨ ${timeDisplay}`;
        }
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `student-checkbox-${student.id}`;
        checkbox.value = String(student.id);
        checkbox.className = 'student-checkbox';
        checkbox.disabled = isDisabled;
        // ä¿å­˜ application_id å’Œ job_id åˆ° data å±¬æ€§
        if (student.applicationId) {
          checkbox.dataset.applicationId = String(student.applicationId);
        }
        if (student.jobId) {
          checkbox.dataset.jobId = String(student.jobId);
        }
        
        const label = document.createElement('label');
        label.htmlFor = `student-checkbox-${student.id}`;
        let labelText = student.displayText;
        if (isDisabled && ownSchedule) {
          // å·²è¢«è‡ªå·±å®‰æ’
          const timeDisplay = ownSchedule.time_end 
            ? `${ownSchedule.time_start || ''}-${ownSchedule.time_end}`
            : ownSchedule.time_start || '';
          labelText += ` (å·²å®‰æ’ ${timeDisplay})`;
          label.style.color = '#6c757d'; // ä½¿ç”¨ç°è‰²è¡¨ç¤ºå”¯è®€ç‹€æ…‹
          label.style.fontWeight = '600';
        }
        label.textContent = labelText;
        
        itemDiv.appendChild(checkbox);
        itemDiv.appendChild(label);
        
        // é»æ“Šæ•´å€‹é …ç›®ä¹Ÿå¯ä»¥åˆ‡æ› checkboxï¼ˆå¦‚æœæœªç¦ç”¨ï¼‰
        if (!isDisabled) {
          itemDiv.addEventListener('click', function(e) {
            if (e.target !== checkbox && e.target !== label) {
              checkbox.checked = !checkbox.checked;
              updateSelectedStudentsCount();
            }
          });
        }
        
        // checkbox æ”¹è®Šæ™‚æ›´æ–°è¨ˆæ•¸
        checkbox.addEventListener('change', updateSelectedStudentsCount);
        
        studentsContainer.appendChild(itemDiv);
      });
      
      // æ›´æ–°é¸ä¸­å­¸ç”Ÿè¨ˆæ•¸
      updateSelectedStudentsCount();
    }
    
    // æ›´æ–°é¸ä¸­å­¸ç”Ÿè¨ˆæ•¸
    function updateSelectedStudentsCount() {
      const studentsContainer = document.getElementById('interviewStudents');
      const countSpan = document.getElementById('selectedStudentsCount');
      if (studentsContainer && countSpan) {
        const checkboxes = studentsContainer.querySelectorAll('.student-checkbox:checked');
        const selectedCount = checkboxes.length;
        countSpan.textContent = selectedCount;
        
        // æ›´æ–°å…¨é¸æŒ‰éˆ•æ–‡å­—
        const selectAllBtn = document.getElementById('selectAllStudentsBtn');
        if (selectAllBtn) {
          const allCheckboxes = studentsContainer.querySelectorAll('.student-checkbox');
          if (selectedCount === allCheckboxes.length && allCheckboxes.length > 0) {
            selectAllBtn.textContent = 'å–æ¶ˆå…¨é¸';
          } else {
            selectAllBtn.textContent = 'å…¨é¸';
          }
        }
      }
    }
    
    // æ‰¹é‡æ¨™è¨˜é¸ä¸­çš„å±¥æ­·ç‚ºå·²é¢è©¦
    function markSelectedAsCompleted() {
      const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
      
      if (checkedBoxes.length === 0) {
        alert('è«‹å…ˆå‹¾é¸è¦æ¨™è¨˜ç‚ºå·²é¢è©¦çš„å±¥æ­·');
        return;
      }
      
      if (!confirm(`ç¢ºå®šè¦å°‡é¸ä¸­çš„ ${checkedBoxes.length} ä»½å±¥æ­·æ¨™è¨˜ç‚ºå·²é¢è©¦å—ï¼Ÿ`)) {
        return;
      }
      
      // æ”¶é›†æ‰€æœ‰ preference_id
      const preferenceIds = [];
      checkedBoxes.forEach(checkbox => {
        const preferenceId = checkbox.getAttribute('data-preference-id');
        if (preferenceId && preferenceId !== '' && preferenceId !== 'null') {
          preferenceIds.push(preferenceId);
        }
      });
      
      if (preferenceIds.length === 0) {
        alert('é¸ä¸­çš„å±¥æ­·ä¸­æ²’æœ‰æœ‰æ•ˆçš„å¿—é¡˜åºè³‡æ–™ï¼Œç„¡æ³•æ¨™è¨˜ç‚ºå·²é¢è©¦');
        return;
      }
      
      // æ‰¹é‡æ¨™è¨˜ç‚ºå·²é¢è©¦
      let successCount = 0;
      let failCount = 0;
      
      const promises = preferenceIds.map(preferenceId => {
        return fetch("/vendor/api/mark_interview_completed", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            preference_id: preferenceId
          })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            successCount++;
          } else {
            failCount++;
          }
        })
        .catch(err => {
          console.error("æ¨™è¨˜å·²é¢è©¦å¤±æ•—:", err);
          failCount++;
        });
      });
      
      Promise.all(promises).then(() => {
        if (successCount > 0) {
          alert(`âœ… å·²æˆåŠŸæ¨™è¨˜ ${successCount} ä»½å±¥æ­·ç‚ºå·²é¢è©¦${failCount > 0 ? `ï¼Œ${failCount} ä»½å¤±æ•—` : ''}`);
          
          // é‡æ–°è¼‰å…¥è³‡æ–™
          fetch(getResumeApiUrl()).then(r=>r.json()).then(d=>{
            if(d.success) { 
              allResumes = d.resumes;
              // æ ¹æ“šå¾Œç«¯è¿”å›çš„è³‡æ–™æ›´æ–° interviewedSet
              // å„ªå…ˆä½¿ç”¨ interview_status å€¼ï¼ˆå¾ resume_applications è¡¨è®€å–ï¼‰
              interviewedSet.clear();
              allResumes.forEach(r => {
                const interviewStatus = r.interview_status || 'none';
                if (interviewStatus !== 'none' || r.has_interview || r.interview_completed) {
                  const key = String(r.preference_id || r.preferenceId || r.id);
                  interviewedSet.add(key);
                }
              });
              applyFilters(); 
            }
          });
        } else {
          alert(`âŒ æ¨™è¨˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦`);
        }
      });
    }
    
    // æŒ‰åª’åˆé †åºæ’åºä¸¦é¡¯ç¤º
    function sortByMatchingOrder() {
      console.log('ğŸ“Š é–‹å§‹åª’åˆæ’åº');
      console.log('ğŸ“‹ è·ç¼ºè³‡æ–™æ•¸é‡ï¼š', allPositions.length);
      console.log('ğŸ“‹ å±¥æ­·è³‡æ–™æ•¸é‡ï¼š', allResumes.length);
      
      // 1. å¾è·ç¼ºè³‡æ–™ï¼ˆallPositionsï¼‰å»ºç«‹è·ç¼ºæ˜ å°„è¡¨ï¼Œä½¿ç”¨å» å•†è¨­å®šçš„åé¡
      const jobsMap = new Map(); // key: job_id, value: { job_title, slots, students: [] }
      
      // å…ˆå¾è·ç¼ºè³‡æ–™å»ºç«‹è·ç¼ºçµæ§‹ï¼ˆä½¿ç”¨å» å•†è¨­å®šçš„åé¡ï¼‰
      if (allPositions.length === 0) {
        alert('âš ï¸ ç›®å‰æ²’æœ‰è·ç¼ºè³‡æ–™ï¼Œè«‹å…ˆå»ºç«‹è·ç¼º');
        return;
      }
      
      allPositions.forEach(position => {
        const jobId = position.id || position.job_id || null;
        const jobTitle = position.title || position.job_title || 'æœªæŒ‡å®šè·ç¼º';
        const jobSlots = position.slots || 0;
        
        console.log(`ğŸ“¦ è™•ç†è·ç¼ºï¼š${jobTitle}ï¼ŒIDï¼š${jobId}ï¼Œåé¡ï¼š${jobSlots}`);
        
        if (jobId) {
          const key = String(jobId);
          jobsMap.set(key, {
            job_id: jobId,
            job_title: jobTitle,
            slots: Math.max(1, jobSlots), // è‡³å°‘1å€‹åé¡
            students: []
          });
        }
      });
      
      console.log('ğŸ“Š è·ç¼ºæ˜ å°„è¡¨æ•¸é‡ï¼š', jobsMap.size);
      
      // 2. å°‡ç‹€æ…‹ç‚ºã€Œé€šéã€çš„å­¸ç”ŸæŒ‰è·ç¼ºåˆ†çµ„
      allResumes.forEach(resume => {
        // æª¢æŸ¥å±¥æ­·ç‹€æ…‹æ˜¯å¦ç‚ºã€Œé€šéã€
        const status = resume.application_statuses || resume.display_status || resume.status || 'pending';
        if (status !== 'approved') {
          const studentName = resume.name || resume.student_name || 'æœªçŸ¥';
          console.log(`  â­ï¸ å­¸ç”Ÿ ${studentName} ç‹€æ…‹ç‚ºã€Œ${status}ã€ï¼Œè·³é`);
          return; // è·³ééã€Œé€šéã€ç‹€æ…‹çš„å­¸ç”Ÿ
        }
        
        const jobId = resume.job_id || resume.jobId || null;
        const studentName = resume.name || resume.student_name || 'æœªçŸ¥';
        
        if (jobId) {
          const key = String(jobId);
          if (jobsMap.has(key)) {
            jobsMap.get(key).students.push(resume);
            console.log(`  âœ… å­¸ç”Ÿ ${studentName}ï¼ˆç‹€æ…‹ï¼šé€šéï¼‰åŠ å…¥è·ç¼º ${jobsMap.get(key).job_title}`);
          } else {
            // å¦‚æœè·ç¼ºä¸åœ¨è·ç¼ºåˆ—è¡¨ä¸­ï¼Œä½¿ç”¨å±¥æ­·ä¸­çš„è·ç¼ºè³‡è¨Š
            const jobTitle = resume.job_title || resume.jobTitle || 'æœªæŒ‡å®šè·ç¼º';
            const jobSlots = resume.job_slots || resume.slots || 1;
            jobsMap.set(key, {
              job_id: jobId,
              job_title: jobTitle,
              slots: Math.max(1, jobSlots),
              students: [resume]
            });
            console.log(`  âš ï¸ è·ç¼º ${jobTitle} ä¸åœ¨è·ç¼ºåˆ—è¡¨ä¸­ï¼Œä½¿ç”¨å±¥æ­·ä¸­çš„è³‡è¨Š`);
          }
        } else {
          // å¦‚æœæ²’æœ‰ job_idï¼Œä½¿ç”¨è·ç¼ºåç¨±ä½œç‚º key
          const jobTitle = resume.job_title || resume.jobTitle || 'æœªæŒ‡å®šè·ç¼º';
          const jobSlots = resume.job_slots || resume.slots || 1;
          const key = `no_id_${jobTitle}`;
          if (!jobsMap.has(key)) {
            jobsMap.set(key, {
              job_id: null,
              job_title: jobTitle,
              slots: Math.max(1, jobSlots),
              students: []
            });
          }
          jobsMap.get(key).students.push(resume);
          console.log(`  âš ï¸ å­¸ç”Ÿ ${studentName}ï¼ˆç‹€æ…‹ï¼šé€šéï¼‰æ²’æœ‰ job_idï¼Œä½¿ç”¨è·ç¼ºåç¨±ï¼š${jobTitle}`);
        }
      });
      
      // 3. å°æ¯å€‹è·ç¼ºçš„å­¸ç”ŸæŒ‰å§“åæ’åº
      jobsMap.forEach((jobData, key) => {
        jobData.students.sort((a, b) => {
          const nameA = (a.name || a.student_name || '').toLowerCase();
          const nameB = (b.name || b.student_name || '').toLowerCase();
          return nameA.localeCompare(nameB, 'zh-TW');
        });
        console.log(`ğŸ“¦ è·ç¼ºã€Œ${jobData.job_title}ã€ï¼š${jobData.students.length} ä½å­¸ç”Ÿï¼Œåé¡ï¼š${jobData.slots}`);
      });
      
      if (jobsMap.size === 0) {
        alert('âš ï¸ ç›®å‰æ²’æœ‰è·ç¼ºè³‡æ–™');
        return;
      }
      
      const lettersContainer = document.getElementById('matchingSortLetters');
      const content = document.getElementById('matchingSortContent');
      
      if (!lettersContainer || !content) {
        console.error('âŒ æ‰¾ä¸åˆ°å®¹å™¨å…ƒç´ ');
        return;
      }
      
      // æ¸…ç©ºå®¹å™¨
      lettersContainer.innerHTML = '';
      content.innerHTML = '';
      
      // ç‚ºæ¯å€‹è·ç¼ºå‰µå»ºå°æ‡‰åé¡æ•¸é‡çš„ä¸‹æ‹‰é¸å–®
      let globalIndex = 0;
      jobsMap.forEach((jobData, jobKey) => {
        const jobTitle = jobData.job_title;
        const slots = Math.max(1, jobData.slots || 1); // è‡³å°‘1å€‹åé¡
        const students = jobData.students;
        
        console.log(`ğŸ”§ å‰µå»ºè·ç¼ºã€Œ${jobTitle}ã€çš„ä¸‹æ‹‰é¸å–®ï¼Œåé¡ï¼š${slots}ï¼Œå­¸ç”Ÿæ•¸ï¼š${students.length}`);
        
        // ç‚ºè©²è·ç¼ºå‰µå»ºæ¨™é¡Œï¼ˆé¡¯ç¤ºå·²é¸æ“‡äººæ•¸å’Œç¸½åé¡ï¼‰
        const jobTitleDiv = document.createElement('div');
        jobTitleDiv.style.cssText = 'margin-top: 20px; margin-bottom: 12px; padding: 12px; background-color: #f1f5f9; border-radius: 8px;';
        const selectedCountId = `selected-count-${jobKey}`;
        jobTitleDiv.innerHTML = `<strong style="font-size: 1.1rem; color: #0055a8;">${escapeHtml(jobTitle)}</strong> <span style="color: #64748b; font-size: 0.9rem;">ï¼ˆå·²é¸æ“‡ï¼š<span id="${selectedCountId}">0</span> / ç¸½åé¡ï¼š${slots}ï¼‰</span>`;
        lettersContainer.appendChild(jobTitleDiv);
        
        // ç‚ºè©²è·ç¼ºå‰µå»ºå°æ‡‰åé¡æ•¸é‡çš„ä¸‹æ‹‰é¸å–®
        for (let i = 0; i < slots; i++) {
          const rowDiv = document.createElement('div');
          rowDiv.style.cssText = 'display: flex; align-items: center; gap: 12px; margin-bottom: 12px;';
          
          // åºè™Ÿæ¨™ç±¤
          const label = document.createElement('label');
          label.style.cssText = 'min-width: 60px; font-weight: 600; color: #475569;';
          label.textContent = `æ­£å–${i + 1}`;
          rowDiv.appendChild(label);
          
          // ä¸‹æ‹‰é¸å–®
          const dropdown = document.createElement('select');
          dropdown.className = 'form-select';
          dropdown.style.cssText = 'padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; flex: 1;';
          dropdown.innerHTML = '<option value="">è«‹é¸æ“‡å­¸ç”Ÿ</option>';
          dropdown.dataset.jobId = jobKey;
          dropdown.dataset.slotIndex = i;
          dropdown.dataset.globalIndex = globalIndex++;
          
          // åœ¨ä¸‹æ‹‰é¸å–®ä¸­é¡¯ç¤ºè©²è·ç¼ºçš„æ‰€æœ‰å­¸ç”Ÿ
          students.forEach((resume, index) => {
            const studentName = resume.name || resume.student_name || 'æœªçŸ¥';
            const studentNumber = resume.username || resume.student_number || '';
            const displayText = studentNumber ? `${studentName} (${studentNumber})` : studentName;
            
            const option = document.createElement('option');
            option.value = `${jobKey}_${index}`;
            option.textContent = displayText;
            option.dataset.resumeIndex = index;
            dropdown.appendChild(option);
          });
          
          // ä¸‹æ‹‰é¸å–®è®Šæ›´äº‹ä»¶
          dropdown.addEventListener('change', (e) => {
            const selectedValue = e.target.value;
            const currentJobKey = e.target.dataset.jobId;
            
            // æ›´æ–°æ‰€æœ‰è·ç¼ºçš„å·²é¸æ“‡äººæ•¸å’Œé¸é …ç‹€æ…‹
            updateAllJobDropdowns(jobKey, lettersContainer, jobsMap);
            
            if (!selectedValue || selectedValue === '') {
              // å¦‚æœæ‰€æœ‰ä¸‹æ‹‰é¸å–®éƒ½ç‚ºç©ºï¼Œæ¸…ç©ºå…§å®¹å€åŸŸ
              const allDropdowns = lettersContainer.querySelectorAll('select');
              const hasSelection = Array.from(allDropdowns).some(dd => dd.value !== '');
              if (!hasSelection) {
                content.innerHTML = '';
              }
              return;
            }
            
            const [jobKeySelected, resumeIndex] = selectedValue.split('_');
            const jobDataSelected = jobsMap.get(jobKeySelected);
            if (!jobDataSelected || !jobDataSelected.students[parseInt(resumeIndex)]) return;
            
            const resume = jobDataSelected.students[parseInt(resumeIndex)];
            
            // é¡¯ç¤ºé¸ä¸­å­¸ç”Ÿçš„è©³ç´°è³‡è¨Š
            displayStudentDetail(resume);
          });
          
          rowDiv.appendChild(dropdown);
          lettersContainer.appendChild(rowDiv);
        }
        
        // ç‚ºè©²è·ç¼ºå‰µå»ºå€™è£œå­¸ç”Ÿå€å¡Š
        const reserveContainer = document.createElement('div');
        reserveContainer.id = `reserve-container-${jobKey}`;
        reserveContainer.style.cssText = 'margin-top: 16px; padding: 16px; background-color: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;';
        
        // å€™è£œæ¨™é¡Œå’Œæ–°å¢æŒ‰éˆ•
        const reserveHeader = document.createElement('div');
        reserveHeader.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;';
        reserveHeader.innerHTML = `
          <strong style="font-size: 0.95rem; color: #64748b;">å€™è£œå­¸ç”Ÿ</strong>
          <button type="button" class="btn btn-sm btn-outline-primary" onclick="addReserveStudent('${jobKey}')">
            <span style="font-size: 0.9rem;">+ æ–°å¢å€™è£œ</span>
          </button>
        `;
        reserveContainer.appendChild(reserveHeader);
        
        // å€™è£œå­¸ç”Ÿåˆ—è¡¨å®¹å™¨
        const reserveList = document.createElement('div');
        reserveList.id = `reserve-list-${jobKey}`;
        reserveList.style.cssText = 'display: flex; flex-direction: column; gap: 8px;';
        reserveContainer.appendChild(reserveList);
        
        lettersContainer.appendChild(reserveContainer);
      });
      
      // å°‡ jobsMap å­˜å„²åˆ°å…¨åŸŸè®Šæ•¸ï¼Œä»¥ä¾¿åœ¨ addReserveStudent å‡½æ•¸ä¸­ä½¿ç”¨
      window.matchingSortJobsMap = jobsMap;
      
      // å„²å­˜æŒ‰éˆ•äº‹ä»¶
      const saveBtn = document.getElementById('saveMatchingSortBtn');
      if (saveBtn) {
        // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
        const newSaveBtn = saveBtn.cloneNode(true);
        saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
        
        newSaveBtn.addEventListener('click', () => {
          // æ”¶é›†æ‰€æœ‰é¸ä¸­çš„å­¸ç”Ÿè³‡æ–™ï¼ˆæ­£å–åé¡ï¼‰
          const selectedStudents = [];
          const allDropdowns = lettersContainer.querySelectorAll('select:not([data-reserve])');
          
          allDropdowns.forEach((dropdown) => {
            if (dropdown.value && dropdown.value !== '') {
              const [jobKey, resumeIndex] = dropdown.value.split('_');
              const jobData = jobsMap.get(jobKey);
              if (jobData && jobData.students[parseInt(resumeIndex)]) {
                const resume = jobData.students[parseInt(resumeIndex)];
                const slotIndex = parseInt(dropdown.dataset.slotIndex || '0');
                // ç¢ºä¿ä½¿ç”¨æ­£ç¢ºçš„ student_idï¼ˆä¸æ˜¯å±¥æ­·IDï¼‰
                const studentId = resume.student_id;
                if (!studentId) {
                  console.error('âŒ ç¼ºå°‘ student_idï¼Œresume:', resume);
                  alert(`éŒ¯èª¤ï¼šå­¸ç”Ÿ ${resume.name || resume.student_name} ç¼ºå°‘ student_id`);
                  return;
                }
                selectedStudents.push({
                  slot_index: slotIndex + 1,
                  job_title: jobData.job_title,
                  job_id: jobData.job_id,
                  student_id: studentId,
                  student_name: resume.name || resume.student_name,
                  student_number: resume.username || resume.student_number,
                  company_name: resume.company_name,
                  job_title_display: resume.job_title || resume.jobTitle,
                  preference_id: resume.preference_id,
                  preference_order: resume.preference_order || resume.preferenceOrder,
                  is_reserve: false
                });
              }
            }
          });
          
          // æ”¶é›†å€™è£œå­¸ç”Ÿè³‡æ–™
          const reserveDropdowns = lettersContainer.querySelectorAll('select[data-reserve="true"]');
          reserveDropdowns.forEach((dropdown) => {
            if (dropdown.value && dropdown.value !== '') {
              const [jobKey, resumeIndex] = dropdown.value.split('_');
              const jobData = jobsMap.get(jobKey);
              if (jobData && jobData.students[parseInt(resumeIndex)]) {
                const resume = jobData.students[parseInt(resumeIndex)];
                // ç¢ºä¿ä½¿ç”¨æ­£ç¢ºçš„ student_idï¼ˆä¸æ˜¯å±¥æ­·IDï¼‰
                const studentId = resume.student_id;
                if (!studentId) {
                  console.error('âŒ ç¼ºå°‘ student_idï¼Œresume:', resume);
                  alert(`éŒ¯èª¤ï¼šå­¸ç”Ÿ ${resume.name || resume.student_name} ç¼ºå°‘ student_id`);
                  return;
                }
                selectedStudents.push({
                  slot_index: null,
                  job_title: jobData.job_title,
                  job_id: jobData.job_id,
                  student_id: studentId,
                  student_name: resume.name || resume.student_name,
                  student_number: resume.username || resume.student_number,
                  company_name: resume.company_name,
                  job_title_display: resume.job_title || resume.jobTitle,
                  preference_id: resume.preference_id,
                  preference_order: resume.preference_order || resume.preferenceOrder,
                  is_reserve: true
                });
              }
            }
          });
          
          if (selectedStudents.length === 0) {
            alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å­¸ç”Ÿ');
            return;
          }
          
          // èª¿è©¦ï¼šæ‰“å°è¦ç™¼é€çš„æ•¸æ“š
          console.log('ğŸ“¤ æº–å‚™ç™¼é€åª’åˆæ’åºæ•¸æ“šï¼š', selectedStudents);
          selectedStudents.forEach((student, idx) => {
            console.log(`  [${idx+1}] å­¸ç”Ÿï¼š${student.student_name}, student_id=${student.student_id}, preference_id=${student.preference_id}, job_id=${student.job_id}`);
          });
          
          // ä¿å­˜åˆ°å¾Œç«¯è³‡æ–™åº«
          fetch('/vendor/api/save_matching_sort', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ students: selectedStudents })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              alert('âœ… ' + (data.message || 'åª’åˆæ’åºå·²æˆåŠŸä¿å­˜'));
              
              // ä½¿ç”¨ BroadcastChannel é€šçŸ¥å…¶ä»–é é¢ï¼ˆå¦‚ä¸»ä»»åª’åˆé é¢ï¼‰åˆ·æ–°è³‡æ–™
              try {
                const channel = new BroadcastChannel('matching_sort_updated');
                channel.postMessage({
                  type: 'matching_sort_saved',
                  timestamp: Date.now(),
                  message: 'å» å•†åª’åˆæ’åºå·²æ›´æ–°ï¼Œè«‹åˆ·æ–°è³‡æ–™'
                });
                channel.close();
                console.log('ğŸ“¢ å·²ç™¼é€åª’åˆæ’åºæ›´æ–°é€šçŸ¥');
              } catch (err) {
                console.warn('âš ï¸ BroadcastChannel ä¸æ”¯æ´æˆ–ç™¼é€å¤±æ•—:', err);
              }
              
              // é—œé–‰æ¨¡æ…‹æ¡†
              const modal = bootstrap.Modal.getInstance(document.getElementById('matchingSortModal'));
              if (modal) {
                modal.hide();
              }
              
              // ç•™åœ¨ç•¶å‰é é¢ï¼Œä¸è·³è½‰
            } else {
              alert('âŒ ä¿å­˜å¤±æ•—ï¼š' + (data.message || 'æœªçŸ¥éŒ¯èª¤'));
            }
          })
          .catch(err => {
            console.error('ä¿å­˜åª’åˆæ’åºå¤±æ•—:', err);
            alert('âŒ ä¿å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          });
        });
      }
      
      // é¡¯ç¤ºæ¨¡æ…‹æ¡†
      const modal = new bootstrap.Modal(document.getElementById('matchingSortModal'));
      modal.show();
    }
    
    // æ–°å¢å€™è£œå­¸ç”Ÿä¸‹æ‹‰é¸å–®
    function addReserveStudent(jobKey) {
      const reserveList = document.getElementById(`reserve-list-${jobKey}`);
      if (!reserveList) return;
      
      const jobsMap = window.matchingSortJobsMap;
      if (!jobsMap) {
        console.error('æ‰¾ä¸åˆ° jobsMap');
        return;
      }
      
      const jobData = jobsMap.get(jobKey);
      if (!jobData) return;
      
      const students = jobData.students;
      const reserveIndex = reserveList.children.length;
      
      // å‰µå»ºå€™è£œå­¸ç”Ÿè¡Œ
      const reserveRow = document.createElement('div');
      reserveRow.style.cssText = 'display: flex; align-items: center; gap: 12px;';
      reserveRow.id = `reserve-row-${jobKey}-${reserveIndex}`;
      
      // å€™è£œæ¨™ç±¤
      const label = document.createElement('label');
      label.style.cssText = 'min-width: 80px; font-weight: 600; color: #64748b; font-size: 0.9rem;';
      label.textContent = `å€™è£œ ${reserveIndex + 1}`;
      reserveRow.appendChild(label);
      
      // å€™è£œä¸‹æ‹‰é¸å–®
      const dropdown = document.createElement('select');
      dropdown.className = 'form-select';
      dropdown.style.cssText = 'padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; flex: 1;';
      dropdown.innerHTML = '<option value="">è«‹é¸æ“‡å­¸ç”Ÿ</option>';
      dropdown.dataset.jobId = jobKey;
      dropdown.dataset.reserve = 'true';
      dropdown.dataset.reserveIndex = reserveIndex;
      
      // åœ¨ä¸‹æ‹‰é¸å–®ä¸­é¡¯ç¤ºè©²è·ç¼ºçš„æ‰€æœ‰å­¸ç”Ÿ
      students.forEach((resume, index) => {
        const studentName = resume.name || resume.student_name || 'æœªçŸ¥';
        const studentNumber = resume.username || resume.student_number || '';
        const displayText = studentNumber ? `${studentName} (${studentNumber})` : studentName;
        
        const option = document.createElement('option');
        option.value = `${jobKey}_${index}`;
        option.textContent = displayText;
        option.dataset.resumeIndex = index;
        dropdown.appendChild(option);
      });
      
      // ä¸‹æ‹‰é¸å–®è®Šæ›´äº‹ä»¶
      dropdown.addEventListener('change', (e) => {
        const selectedValue = e.target.value;
        const lettersContainer = document.getElementById('matchingSortLetters');
        updateAllJobDropdowns(jobKey, lettersContainer, jobsMap);
        
        if (selectedValue && selectedValue !== '') {
          const [jobKeySelected, resumeIndex] = selectedValue.split('_');
          const jobDataSelected = jobsMap.get(jobKeySelected);
          if (jobDataSelected && jobDataSelected.students[parseInt(resumeIndex)]) {
            const resume = jobDataSelected.students[parseInt(resumeIndex)];
            displayStudentDetail(resume);
          }
        }
      });
      
      reserveRow.appendChild(dropdown);
      
      // åˆªé™¤æŒ‰éˆ•
      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.className = 'btn btn-sm btn-outline-danger';
      deleteBtn.innerHTML = 'Ã—';
      deleteBtn.style.cssText = 'min-width: 32px; height: 32px; padding: 0; font-size: 1.2rem; line-height: 1;';
      deleteBtn.onclick = () => {
        reserveRow.remove();
        const lettersContainer = document.getElementById('matchingSortLetters');
        updateAllJobDropdowns(jobKey, lettersContainer, jobsMap);
      };
      reserveRow.appendChild(deleteBtn);
      
      reserveList.appendChild(reserveRow);
      
      // æ›´æ–°æ‰€æœ‰ä¸‹æ‹‰é¸å–®ç‹€æ…‹
      const lettersContainer = document.getElementById('matchingSortLetters');
      updateAllJobDropdowns(jobKey, lettersContainer, jobsMap);
    }
    
    // æ›´æ–°æ‰€æœ‰è·ç¼ºçš„ä¸‹æ‹‰é¸å–®ç‹€æ…‹ï¼ˆç¦ç”¨å·²é¸æ“‡çš„å­¸ç”Ÿï¼Œæ›´æ–°å·²é¸æ“‡äººæ•¸ï¼‰
    function updateAllJobDropdowns(currentJobKey, container, jobsMap) {
      // æ”¶é›†æ‰€æœ‰å·²é¸æ“‡çš„å­¸ç”Ÿï¼ˆè·¨è·ç¼ºï¼‰
      const allSelectedStudents = new Set();
      const allDropdowns = container.querySelectorAll('select');
      
      allDropdowns.forEach(dropdown => {
        if (dropdown.value && dropdown.value !== '') {
          allSelectedStudents.add(dropdown.value);
        }
      });
      
      // æ›´æ–°æ¯å€‹è·ç¼ºçš„ä¸‹æ‹‰é¸å–®
      jobsMap.forEach((jobData, jobKey) => {
        // æ›´æ–°å·²é¸æ“‡äººæ•¸ï¼ˆåªè¨ˆç®—æ­£å–åé¡ï¼Œä¸åŒ…æ‹¬å€™è£œï¼‰
        const countElement = document.getElementById(`selected-count-${jobKey}`);
        if (countElement) {
          const jobDropdowns = container.querySelectorAll(`select[data-job-id="${jobKey}"]:not([data-reserve="true"])`);
          let selectedCount = 0;
          jobDropdowns.forEach(dropdown => {
            if (dropdown.value && dropdown.value !== '') {
              selectedCount++;
            }
          });
          countElement.textContent = selectedCount;
        }
        
        // æ›´æ–°è©²è·ç¼ºæ‰€æœ‰ä¸‹æ‹‰é¸å–®çš„é¸é …ç‹€æ…‹
        const jobDropdowns = container.querySelectorAll(`select[data-job-id="${jobKey}"]`);
        jobDropdowns.forEach(dropdown => {
          const currentValue = dropdown.value;
          
          // éæ­·æ‰€æœ‰é¸é …
          Array.from(dropdown.options).forEach(option => {
            if (option.value === '' || option.value === currentValue) {
              // ç©ºé¸é …æˆ–ç•¶å‰é¸ä¸­çš„é¸é …ä¿æŒå¯ç”¨
              option.disabled = false;
            } else {
              // å¦‚æœè©²å­¸ç”Ÿå·²è¢«å…¶ä»–ä¸‹æ‹‰é¸å–®é¸ä¸­ï¼Œå‰‡ç¦ç”¨
              option.disabled = allSelectedStudents.has(option.value);
            }
          });
        });
      });
    }
    
    // é¡¯ç¤ºé¸ä¸­å­¸ç”Ÿçš„è©³ç´°è³‡è¨Š
    function displayStudentDetail(resume) {
      const content = document.getElementById('matchingSortContent');
      if (!content) return;
      
      const studentName = resume.name || resume.student_name || 'æœªçŸ¥';
      const studentNumber = resume.username || resume.student_number || '';
      const companyName = resume.company_name || 'â€”';
      const jobTitle = resume.job_title || resume.jobTitle || 'â€”';
      const status = resume.application_statuses || resume.display_status || resume.status || 'pending';
      const statusLabel = mapStatus(status);
      const statusColorClass = statusColor(status);
      const className = resume.className || '';
      const department = resume.department || '';
      
      let html = `
        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0;">
          <h6 style="font-weight: 600; color: #0066cc; margin-bottom: 16px; font-size: 1.2rem;">
            å­¸ç”Ÿè©³ç´°è³‡è¨Š
          </h6>
          <div style="display: grid; gap: 12px;">
            <div>
              <strong>å­¸ç”Ÿå§“åï¼š</strong>
              <span>${escapeHtml(studentName)}</span>
            </div>
            <div>
              <strong>å­¸è™Ÿï¼š</strong>
              <span>${escapeHtml(studentNumber)}</span>
            </div>
            ${className ? `<div><strong>ç­ç´šï¼š</strong><span>${escapeHtml(className)}</span></div>` : ''}
            ${department ? `<div><strong>å­¸å¹´ï¼š</strong><span>${escapeHtml(department)}</span></div>` : ''}
            <div>
              <strong>å…¬å¸åç¨±ï¼š</strong>
              <span>${escapeHtml(companyName)}</span>
            </div>
            <div>
              <strong>è·ç¼ºï¼š</strong>
              <span>${escapeHtml(jobTitle)}</span>
            </div>
            <div>
              <strong>ç‹€æ…‹ï¼š</strong>
              <span class="status-badge bg-${statusColorClass}" style="font-size: 0.9rem; padding: 4px 8px;">
                ${statusLabel}
              </span>
            </div>
          </div>
        </div>
      `;
      
      content.innerHTML = html;
    }
    
    // ä¸‹è¼‰é¸ä¸­çš„å±¥æ­·
    function downloadSelectedResumes() {
      const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
      
      if (checkedBoxes.length === 0) {
        alert('è«‹å…ˆå‹¾é¸è¦ä¸‹è¼‰çš„å±¥æ­·');
        return;
      }
      
      // ä¸‹è¼‰æ‰€æœ‰é¸ä¸­çš„å±¥æ­·
      checkedBoxes.forEach((checkbox, index) => {
        const resumeId = checkbox.getAttribute('data-resume-id');
        if (resumeId) {
          // å»¶é²ä¸‹è¼‰ï¼Œé¿å…ç€è¦½å™¨é˜»æ­¢å¤šå€‹ä¸‹è¼‰
          setTimeout(() => {
            const downloadLink = document.createElement('a');
            downloadLink.href = `/api/download_resume/${resumeId}`;
            downloadLink.target = '_blank';
            downloadLink.download = '';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
          }, index * 200); // æ¯å€‹ä¸‹è¼‰é–“éš”200ms
        }
      });
      
      alert(`å·²é–‹å§‹ä¸‹è¼‰ ${checkedBoxes.length} ä»½å±¥æ­·`);
    }
    
    // é–‹å•Ÿé¢è©¦æ’ç¨‹æœˆæ›†
    async function openInterviewSchedule() {
      currentCalendarDate = new Date();
      // é‡æ–°è¼‰å…¥æ‰€æœ‰å» å•†çš„é¢è©¦æ’ç¨‹
      await loadAllVendorSchedules();
      renderCalendar();
      const modal = new bootstrap.Modal(document.getElementById("interviewScheduleModal"));
      modal.show();
      
      // å•Ÿå‹•å®šæœŸè‡ªå‹•åˆ·æ–°ï¼ˆæ¯30ç§’åˆ·æ–°ä¸€æ¬¡ï¼Œç¢ºä¿çœ‹åˆ°å…¶ä»–å» å•†æ–°å¢çš„æ’ç¨‹ï¼‰
      if (scheduleRefreshInterval) {
        clearInterval(scheduleRefreshInterval);
      }
      scheduleRefreshInterval = setInterval(async () => {
        console.log('ğŸ”„ å®šæœŸè‡ªå‹•åˆ·æ–°é¢è©¦æ’ç¨‹...');
        await loadAllVendorSchedules();
        renderCalendar();
      }, 30000); // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡
    }

    // æ”¹è®Šæœˆä»½
    async function changeMonth(direction) {
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
      // é‡æ–°è¼‰å…¥æ‰€æœ‰å» å•†çš„é¢è©¦æ’ç¨‹ï¼Œç¢ºä¿æ•¸æ“šæ˜¯æœ€æ–°çš„
      await loadAllVendorSchedules();
      renderCalendar();
    }
    
    // é–‹å•Ÿé¢è©¦è¡¨å–®
    // forceEditMode: true è¡¨ç¤ºå¼·åˆ¶ç·¨è¼¯æ¨¡å¼ï¼ˆé»æ“Šè—è‰²æ¨™ç±¤æ™‚ï¼‰ï¼Œfalse è¡¨ç¤ºæ–°å¢æ¨¡å¼ï¼ˆé»æ“Šæ—¥æœŸæ ¼å­æ™‚ï¼‰
    async function openInterviewForm(date, forceEditMode = false) {
      selectedInterviewDate = date;
      const dateStr = formatDate(date);
      const dateDisplay = formatDateDisplay(date);
      
      // å…ˆé‡æ–°è¼‰å…¥æ‰€æœ‰å» å•†çš„é¢è©¦æ’ç¨‹ï¼Œç¢ºä¿æ•¸æ“šæ˜¯æœ€æ–°çš„
      console.log('ğŸ”„ é‡æ–°è¼‰å…¥æ‰€æœ‰å» å•†çš„é¢è©¦æ’ç¨‹...');
      await loadAllVendorSchedules();
      
      // æª¢æŸ¥è©²æ—¥æœŸæ˜¯å¦æœ‰è‡ªå·±çš„æ’ç¨‹
      // å„ªå…ˆå¾ allVendorSchedules æª¢æŸ¥ï¼ˆæ›´æº–ç¢ºï¼‰
      let hasOwnSchedule = false;
      if (allVendorSchedules.has(dateStr)) {
        const schedules = allVendorSchedules.get(dateStr);
        hasOwnSchedule = schedules.some(s => s.is_own);
      } else {
        // å¦‚æœ allVendorSchedules ä¸­æ²’æœ‰ï¼Œæª¢æŸ¥æœ¬åœ°å­˜å„²ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
        hasOwnSchedule = interviewSchedules.has(dateStr);
      }
      
      // å¦‚æœæœ‰å…¶ä»–å» å•†çš„æ’ç¨‹ï¼Œé¡¯ç¤ºæç¤ºä¿¡æ¯ï¼ˆä½†ä¸é˜»æ­¢æ–°å¢ï¼‰
      if (allVendorSchedules.has(dateStr)) {
        const schedules = allVendorSchedules.get(dateStr);
        // éæ¿¾å…¶ä»–å» å•†çš„æ’ç¨‹ï¼šå„ªå…ˆé€šéå…¬å¸åç¨±åˆ¤æ–·
        const otherSchedules = schedules.filter(s => {
          // å„ªå…ˆé€šéå…¬å¸åç¨±åˆ¤æ–·ï¼ˆæœ€æº–ç¢ºï¼‰
          if (vendorCompanyName && s.company_name) {
            return s.company_name.trim() !== vendorCompanyName.trim();
          }
          // å¦‚æœæ²’æœ‰å…¬å¸åç¨±ä¿¡æ¯ï¼Œå‰‡ä½¿ç”¨ is_own åˆ¤æ–·
          return s.is_own === false;
        });
        
        if (otherSchedules.length > 0 && !hasOwnSchedule) {
          // ç²å–å…¶ä»–å» å•†çš„æ’ç¨‹ä¿¡æ¯
          const companyNames = [...new Set(otherSchedules.map(s => s.company_name || 'å…¶ä»–å» å•†'))];
          const timeSlots = [];
          otherSchedules.forEach(s => {
            if (s.time_start && s.time_end) {
              timeSlots.push(`${s.time_start}-${s.time_end}`);
            } else if (s.time_start) {
              timeSlots.push(s.time_start);
            }
          });
          const uniqueTimeSlots = [...new Set(timeSlots)].sort();
          
          // é¡¯ç¤ºæç¤ºï¼Œä½†ä¸é˜»æ­¢æ‰“é–‹è¡¨å–®ï¼ˆå…è¨±æ–°å¢è‡ªå·±çš„æ’ç¨‹ï¼‰
          console.log(`â„¹ï¸ è©²æ—¥æœŸå·²æœ‰å…¶ä»–å» å•†é ç´„ï¼š${companyNames.join(', ')}ï¼Œæ™‚é–“ï¼š${uniqueTimeSlots.join(', ')}ã€‚æ‚¨å¯ä»¥åœ¨æ­¤æ—¥æœŸæ–°å¢è‡ªå·±çš„æ’ç¨‹ã€‚`);
        }
      }
      
      document.getElementById('interviewDate').value = dateDisplay;
      document.getElementById('interviewTimeStart').value = '';
      document.getElementById('interviewTimeEnd').value = '';
      document.getElementById('interviewLocation').value = '';
      const locationOtherInput = document.getElementById('interviewLocationOther');
      if (locationOtherInput) {
        locationOtherInput.value = '';
        locationOtherInput.style.display = 'none';
        locationOtherInput.required = false;
      }
      document.getElementById('interviewNotes').value = '';
      
      // æª¢æŸ¥è©²æ—¥æœŸæ˜¯å¦æœ‰å…¶ä»–å» å•†å·²é ç´„çš„æ™‚é–“æ®µ
      checkBookedTimeSlots(dateStr);
      
      // ä¾ç…§ç›®å‰å±¥æ­·è³‡æ–™é‡å»ºåœ°é»ä¸‹æ‹‰é¸å–®ï¼ˆåŒ…å«å…¬å¸åç¨±ï¼‰
      populateLocationDropdown();
      
      // å¡«å……å­¸ç”Ÿé¸å–®ï¼ˆæœƒæ ¹æ“šé¸æ“‡çš„æ—¥æœŸæª¢æŸ¥å­¸ç”Ÿæ˜¯å¦å·²è¢«å…¶ä»–å» å•†å®‰æ’ï¼‰
      // å‚³éç·¨è¼¯æ¨¡å¼æ¨™è¨˜ï¼šå¦‚æœæ˜¯å¼·åˆ¶ç·¨è¼¯æ¨¡å¼ï¼Œå‚³é trueï¼›å¦å‰‡å‚³é falseï¼ˆæ–°å¢æ¨¡å¼ï¼‰
      populateStudentsDropdown(forceEditMode);
      
      // å¦‚æœå·²æœ‰æ’ç¨‹ï¼Œè¼‰å…¥ç¾æœ‰è³‡æ–™
      // å„ªå…ˆå¾ allVendorSchedules ç²å–æœ€æ–°çš„æ’ç¨‹ä¿¡æ¯ï¼ˆæ›´æº–ç¢ºï¼‰
      let schedule = null;
      
      // å¦‚æœæ˜¯å¼·åˆ¶ç·¨è¼¯æ¨¡å¼ï¼ˆé»æ“Šè—è‰²æ¨™ç±¤ï¼‰ï¼Œåªè¼‰å…¥è‡ªå·±çš„æ’ç¨‹
      if (forceEditMode) {
        console.log('ğŸ“ ç·¨è¼¯æ¨¡å¼ï¼šè¼‰å…¥è‡ªå·±çš„æ’ç¨‹è³‡æ–™');
        if (allVendorSchedules.has(dateStr)) {
          const schedules = allVendorSchedules.get(dateStr);
          // åªéæ¿¾è‡ªå·±çš„æ’ç¨‹ï¼šå„ªå…ˆé€šéå…¬å¸åç¨±åˆ¤æ–·ï¼ˆæœ€æº–ç¢ºï¼‰ï¼Œç„¶å¾Œæª¢æŸ¥ is_own
          const ownSchedules = schedules.filter(s => {
            // å„ªå…ˆé€šéå…¬å¸åç¨±åˆ¤æ–·ï¼ˆæœ€æº–ç¢ºï¼‰
            if (vendorCompanyName && s.company_name) {
              // ä½¿ç”¨å¯¬é¬†çš„å…¬å¸åç¨±åŒ¹é…ï¼ˆè™•ç†ã€Œæœ‰é™å…¬å¸ã€å’Œã€Œè‚¡ä»½æœ‰é™å…¬å¸ã€ç­‰å·®ç•°ï¼‰
              const isOwn = isCompanyNameMatch(s.company_name, vendorCompanyName);
              // å¦‚æœå…¬å¸åç¨±åŒ¹é…ï¼Œå°±æ˜¯è‡ªå·±çš„æ’ç¨‹ï¼ˆå³ä½¿ is_own=falseï¼‰
              if (isOwn) return true;
              // å¦‚æœå…¬å¸åç¨±ä¸åŒ¹é…ï¼Œå³ä½¿ is_own=true ä¹Ÿä¸æ˜¯è‡ªå·±çš„æ’ç¨‹
              if (!isOwn && s.is_own === true) {
                console.warn(`âš ï¸ [openInterviewForm ç·¨è¼¯æ¨¡å¼] è­¦å‘Šï¼šæ’ç¨‹ is_own=true ä½†å…¬å¸åç¨±ä¸åŒ¹é…ï¼Œéæ¿¾æ‰`);
                return false;
              }
            }
            // å¦‚æœæ²’æœ‰å…¬å¸åç¨±ä¿¡æ¯ï¼Œå‰‡ä½¿ç”¨ is_own åˆ¤æ–·
            if (s.is_own === true) return true;
            if (s.is_own === false) return false;
            return false;
          });
          
          if (ownSchedules.length > 0) {
            // åˆä½µæ‰€æœ‰è‡ªå·±çš„æ’ç¨‹ï¼ˆå¯èƒ½æœ‰å¤šå€‹å­¸ç”Ÿï¼‰
            // ä½¿ç”¨ç¬¬ä¸€å€‹æ’ç¨‹çš„æ™‚é–“å’Œåœ°é»ï¼Œä½†æ”¶é›†æ‰€æœ‰å­¸ç”Ÿ
            const firstSchedule = ownSchedules[0];
            schedule = {
              timeStart: firstSchedule.time_start || '',
              timeEnd: firstSchedule.time_end || '',
              location: firstSchedule.location || '',
              notes: firstSchedule.notes || '', // ç¢ºä¿ notes è¢«æ­£ç¢ºè¼‰å…¥
              students: ownSchedules.filter(s => s.student_id).map(s => String(s.student_id))
            };
            console.log(`âœ… [ç·¨è¼¯æ¨¡å¼] å¾ allVendorSchedules è¼‰å…¥è‡ªå·±çš„æ’ç¨‹è³‡æ–™: æ™‚é–“=${schedule.timeStart}-${schedule.timeEnd}, åœ°é»=${schedule.location}, å‚™è¨»=${schedule.notes ? schedule.notes.substring(0, 30) : 'ç„¡'}, å­¸ç”Ÿ=${schedule.students.join(',')}`);
          }
        }
        
        // ä¸å†å¾ interviewSchedulesï¼ˆæœ¬åœ°å­˜å„²ï¼‰ç²å–ï¼Œå®Œå…¨ä¾è³´ allVendorSchedulesï¼ˆè³‡æ–™åº«ï¼‰
        // å¦‚æœ allVendorSchedules ä¸­æ²’æœ‰ï¼Œschedule ä¿æŒç‚º nullï¼ˆæ–°å¢æ¨¡å¼ï¼‰
      } else {
        // æ–°å¢æ¨¡å¼ï¼ˆé»æ“Šæ—¥æœŸæ ¼å­æ™‚ï¼‰ï¼šä¸è¼‰å…¥ä»»ä½•ç¾æœ‰æ’ç¨‹ï¼Œä¸€å¾‹è¦–ç‚ºæ–°å¢
        console.log('â• æ–°å¢æ¨¡å¼ï¼šé»æ“Šæ—¥æœŸæ ¼å­ï¼Œä¸è¼‰å…¥ç¾æœ‰æ’ç¨‹');
        // schedule ä¿æŒç‚º nullï¼Œä¸è¼‰å…¥ä»»ä½•è³‡æ–™
      }
      
      if (schedule) {
        // è™•ç†èˆŠæ ¼å¼ï¼ˆå–®ä¸€æ™‚é–“ï¼‰å’Œæ–°æ ¼å¼ï¼ˆé–‹å§‹/çµæŸæ™‚é–“ï¼‰
        if (schedule.timeStart && schedule.timeEnd) {
          document.getElementById('interviewTimeStart').value = schedule.timeStart || '';
          document.getElementById('interviewTimeEnd').value = schedule.timeEnd || '';
        } else if (schedule.timeStart) {
          // åªæœ‰é–‹å§‹æ™‚é–“
          document.getElementById('interviewTimeStart').value = schedule.timeStart || '';
        } else if (schedule.time) {
          // å…¼å®¹èˆŠæ ¼å¼ï¼šå¦‚æœåªæœ‰å–®ä¸€æ™‚é–“ï¼Œè¨­ç‚ºé–‹å§‹æ™‚é–“
          document.getElementById('interviewTimeStart').value = schedule.time || '';
        }
        
        // è™•ç†åœ°é»ï¼šæª¢æŸ¥æ˜¯å¦ç‚ºé è¨­é¸é …æˆ–ã€Œå…¶ä»–ã€
        const locationSelect = document.getElementById('interviewLocation');
        const locationOtherInput = document.getElementById('interviewLocationOther');
        const savedLocation = schedule.location || '';
        
        if (savedLocation) {
          // æª¢æŸ¥ä¿å­˜çš„åœ°é»æ˜¯å¦åœ¨é¸å–®ä¸­
          const locationOption = Array.from(locationSelect.options).find(opt => opt.value === savedLocation);
          if (locationOption) {
            // å¦‚æœæ˜¯é è¨­é¸é …ï¼Œç›´æ¥è¨­ç½®
            locationSelect.value = savedLocation;
            if (locationOtherInput) {
              locationOtherInput.style.display = 'none';
              locationOtherInput.value = '';
            }
          } else {
            // å¦‚æœä¸åœ¨é¸å–®ä¸­ï¼Œè¨­ç½®ç‚ºã€Œå…¶ä»–ã€ä¸¦å¡«å…¥è¼¸å…¥æ¡†
            locationSelect.value = 'other';
            if (locationOtherInput) {
              locationOtherInput.style.display = 'block';
              locationOtherInput.value = savedLocation;
              locationOtherInput.required = true;
            }
          }
        }
        
        // è¨­ç½®é¢è©¦é ˆçŸ¥ï¼ˆç¢ºä¿ä¿ç•™åŸæœ‰å…§å®¹ï¼‰
        const notesValue = schedule.notes || '';
        document.getElementById('interviewNotes').value = notesValue;
        console.log(`ğŸ“ [ç·¨è¼¯æ¨¡å¼] è¨­ç½®é¢è©¦é ˆçŸ¥: ${notesValue ? notesValue.substring(0, 50) + '...' : 'ï¼ˆç©ºï¼‰'}`);
        
        // æ¢å¾©é¸ä¸­çš„å­¸ç”Ÿ
        const studentsContainer = document.getElementById('interviewStudents');
        if (studentsContainer && schedule.students && Array.isArray(schedule.students)) {
          // æ¸…é™¤æ‰€æœ‰é¸ä¸­ç‹€æ…‹
          const checkboxes = studentsContainer.querySelectorAll('.student-checkbox');
          checkboxes.forEach(checkbox => {
            checkbox.checked = false;
          });
          
          // æ¢å¾©é¸ä¸­çš„å­¸ç”Ÿ
          schedule.students.forEach(studentId => {
            const checkbox = studentsContainer.querySelector(`.student-checkbox[value="${studentId}"]`);
            if (checkbox) {
              checkbox.checked = true;
            }
          });
          updateSelectedStudentsCount();
        }
      } else {
        // å¦‚æœæ²’æœ‰æ’ç¨‹ï¼Œæ¸…é™¤æ‰€æœ‰é¸ä¸­ç‹€æ…‹
        const studentsContainer = document.getElementById('interviewStudents');
        if (studentsContainer) {
          const checkboxes = studentsContainer.querySelectorAll('.student-checkbox');
          checkboxes.forEach(checkbox => {
            checkbox.checked = false;
          });
          updateSelectedStudentsCount();
        }
      }
      
      // å…ˆé—œé–‰æœˆæ›†æ¨¡æ…‹æ¡†
      const scheduleModal = bootstrap.Modal.getInstance(document.getElementById("interviewScheduleModal"));
      if (scheduleModal) {
        scheduleModal.hide();
      }
      
      // æ›´æ–°æ¨¡æ…‹æ¡†æ¨™é¡Œ
      const modalTitle = document.querySelector('#interviewFormModal .modal-title');
      if (modalTitle) {
        modalTitle.textContent = schedule ? 'ç·¨è¼¯é¢è©¦æ’ç¨‹' : 'æ–°å¢é¢è©¦æ’ç¨‹';
      }
      
      // é¡¯ç¤º/éš±è—åˆªé™¤æŒ‰éˆ•ï¼ˆåªåœ¨ç·¨è¼¯æ¨¡å¼æ™‚é¡¯ç¤ºï¼‰
      const deleteBtn = document.getElementById('deleteInterviewBtn');
      if (deleteBtn) {
        deleteBtn.style.display = schedule ? 'inline-block' : 'none';
      }
      
      // ç­‰å¾…æœˆæ›†æ¨¡æ…‹æ¡†å®Œå…¨é—œé–‰å¾Œå†æ‰“é–‹è¡¨å–®æ¨¡æ…‹æ¡†
      setTimeout(() => {
        const formModal = new bootstrap.Modal(document.getElementById("interviewFormModal"));
        formModal.show();
        
        // ç¢ºä¿èƒŒæ™¯é®ç½©æ­£ç¢ºé¡¯ç¤º
        setTimeout(() => {
          const backdrop = document.querySelector('.modal-backdrop');
          if (backdrop) {
            backdrop.style.backgroundColor = 'rgba(0, 0, 0, 0.6)';
            backdrop.style.opacity = '1';
          }
        }, 100);
      }, 300);
    }
    
    // æ ¼å¼åŒ–æ—¥æœŸç‚º YYYY-MM-DD
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    // æ ¼å¼åŒ–æ™‚é–“ç‚ºä¸Šåˆ/ä¸‹åˆæ ¼å¼
    function formatTimeToAMPM(timeStr) {
      if (!timeStr) return '';
      const [hours, minutes] = timeStr.split(':');
      const hour = parseInt(hours);
      const min = minutes || '00';
      if (hour === 0) {
        return `ä¸Šåˆ 12:${min}`;
      } else if (hour < 12) {
        return `ä¸Šåˆ ${hour}:${min}`;
      } else if (hour === 12) {
        return `ä¸‹åˆ 12:${min}`;
      } else {
        const displayHour = hour - 12;
        return `ä¸‹åˆ ${displayHour}:${min}`;
      }
    }
    
    // æ ¼å¼åŒ–æ—¥æœŸé¡¯ç¤º
    function formatDateDisplay(date) {
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const weekDays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
      const weekDay = weekDays[date.getDay()];
      return `${year}å¹´${month}æœˆ${day}æ—¥ï¼ˆ${weekDay}ï¼‰`;
    }
    
    // æª¢æŸ¥è©²æ—¥æœŸæ˜¯å¦æœ‰å…¶ä»–å» å•†å·²é ç´„çš„æ™‚é–“æ®µ
    function checkBookedTimeSlots(dateStr) {
      const warningDiv = document.getElementById('bookedTimeSlotsWarning');
      const timeSlotsList = document.getElementById('bookedTimeSlotsList');
      const timeStartInput = document.getElementById('interviewTimeStart');
      const timeEndInput = document.getElementById('interviewTimeEnd');
      
      if (!warningDiv || !timeSlotsList || !timeStartInput || !timeEndInput) return;
      
      // æª¢æŸ¥æ˜¯å¦æœ‰å…¶ä»–å» å•†å·²é ç´„çš„æ™‚é–“æ®µ
      if (allVendorSchedules.has(dateStr)) {
        const schedules = allVendorSchedules.get(dateStr);
        // éæ¿¾æ‰è‡ªå·±çš„æ’ç¨‹ï¼šå„ªå…ˆé€šéå…¬å¸åç¨±åˆ¤æ–·
        const otherVendorSchedules = schedules.filter(s => {
          // å„ªå…ˆé€šéå…¬å¸åç¨±åˆ¤æ–·ï¼ˆæœ€æº–ç¢ºï¼‰
          if (vendorCompanyName && s.company_name) {
            // ä½¿ç”¨å¯¬é¬†çš„å…¬å¸åç¨±åŒ¹é…ï¼ˆè™•ç†ã€Œæœ‰é™å…¬å¸ã€å’Œã€Œè‚¡ä»½æœ‰é™å…¬å¸ã€ç­‰å·®ç•°ï¼‰
            return !isCompanyNameMatch(s.company_name, vendorCompanyName);
          }
          // å¦‚æœæ²’æœ‰å…¬å¸åç¨±ä¿¡æ¯ï¼Œå‰‡ä½¿ç”¨ is_own åˆ¤æ–·
          return s.is_own === false;
        });
        
        if (otherVendorSchedules.length > 0) {
          // æ”¶é›†æ‰€æœ‰å…¶ä»–å» å•†çš„æ™‚é–“æ®µï¼ˆåŒ…å«å…¬å¸åç¨±ã€å­¸ç”Ÿä¿¡æ¯å’Œå®Œæ•´æ™‚é–“ä¿¡æ¯ï¼‰
          const timeSlotsMap = new Map(); // ä½¿ç”¨ Map ä¾†åˆä½µç›¸åŒå…¬å¸å’Œæ™‚é–“æ®µçš„æ’ç¨‹
          
          otherVendorSchedules.forEach(schedule => {
            const companyName = schedule.company_name || 'å…¶ä»–å» å•†';
            
            // ç²å–å­¸ç”Ÿå§“åï¼ˆå„ªå…ˆä½¿ç”¨å¾Œç«¯è¿”å›çš„ student_nameï¼Œå¦‚æœæ²’æœ‰å‰‡å¾ allResumes æŸ¥æ‰¾ï¼‰
            let studentName = '';
            if (schedule.student_name) {
              // å¾Œç«¯å·²ç¶“è¿”å›å­¸ç”Ÿå§“åï¼Œç›´æ¥ä½¿ç”¨
              studentName = schedule.student_name;
            } else if (schedule.student_id) {
              // å¦‚æœå¾Œç«¯æ²’æœ‰è¿”å›å­¸ç”Ÿå§“åï¼Œå¾ allResumes æŸ¥æ‰¾
              const student = allResumes.find(r => String(r.student_id || r.id) === String(schedule.student_id));
              studentName = student ? (student.name || student.student_name || `å­¸ç”Ÿ${schedule.student_id}`) : `å­¸ç”Ÿ${schedule.student_id}`;
            }
            
            if (!studentName) return; // å¦‚æœæ²’æœ‰å­¸ç”Ÿå§“åï¼Œè·³é
            
            let timeKey = '';
            let timeDisplay = '';
            if (schedule.time_start && schedule.time_end) {
              const startTime = schedule.time_start.substring(0, 5);
              const endTime = schedule.time_end.substring(0, 5);
              timeKey = `${startTime}-${endTime}`;
              timeDisplay = timeKey;
            } else if (schedule.time_start) {
              const startTime = schedule.time_start.substring(0, 5);
              timeKey = startTime;
              timeDisplay = startTime;
            } else {
              return; // å¦‚æœæ²’æœ‰æ™‚é–“ï¼Œè·³é
            }
            
            // ä½¿ç”¨ã€Œå…¬å¸åç¨± + æ™‚é–“æ®µã€ä½œç‚º key
            const mapKey = `${companyName}|${timeKey}`;
            
            if (!timeSlotsMap.has(mapKey)) {
              // å¦‚æœé€™å€‹çµ„åˆä¸å­˜åœ¨ï¼Œå‰µå»ºæ–°æ¢ç›®
              timeSlotsMap.set(mapKey, {
                company: companyName,
                time: timeDisplay,
                students: [studentName],
                time_start: schedule.time_start,
                time_end: schedule.time_end
              });
            } else {
              // å¦‚æœå·²å­˜åœ¨ï¼Œå°‡å­¸ç”Ÿå§“ååŠ å…¥åˆ—è¡¨ï¼ˆé¿å…é‡è¤‡ï¼‰
              const existing = timeSlotsMap.get(mapKey);
              if (!existing.students.includes(studentName)) {
                existing.students.push(studentName);
              }
            }
          });
          
          // è½‰æ›ç‚ºæ•¸çµ„ä¸¦æ’åºï¼ˆæŒ‰æ™‚é–“ï¼‰
          const timeSlotsWithCompany = Array.from(timeSlotsMap.values()).sort((a, b) => {
            return (a.time_start || '').localeCompare(b.time_start || '');
          });
          
          if (timeSlotsWithCompany.length > 0) {
            // é¡¯ç¤ºè­¦å‘Šï¼ˆåŒ…å«å…¬å¸åç¨±å’Œå­¸ç”Ÿå§“åï¼ŒåŒä¸€å…¬å¸åŒä¸€æ™‚é–“æ®µçš„å­¸ç”Ÿåˆä½µé¡¯ç¤ºï¼‰
            timeSlotsList.innerHTML = timeSlotsWithCompany.map(slot => {
              const studentsText = slot.students.length > 0 ? ` - ${slot.students.join('ã€')}` : '';
              return `<div>â€¢ ${slot.time} (${slot.company}${studentsText})</div>`;
            }).join('');
            warningDiv.style.display = 'block';
            
            // æ·»åŠ æ™‚é–“é©—è­‰äº‹ä»¶
            const validateTime = () => {
              const selectedStart = timeStartInput.value;
              const selectedEnd = timeEndInput.value;
              
              if (!selectedStart || !selectedEnd) return;
              
              // æª¢æŸ¥æ˜¯å¦èˆ‡å·²é ç´„çš„æ™‚é–“æ®µé‡ç–Š
              const isConflict = timeSlotsWithCompany.some(slot => {
                if (slot.time.includes('-')) {
                  const [slotStart, slotEnd] = slot.time.split('-');
                  // æ™‚é–“é‡ç–Šçš„æ¢ä»¶ï¼šæ–°é–‹å§‹æ™‚é–“ < èˆŠçµæŸæ™‚é–“ ä¸” æ–°çµæŸæ™‚é–“ > èˆŠé–‹å§‹æ™‚é–“
                  return selectedStart < slotEnd && selectedEnd > slotStart;
                } else {
                  // åªæœ‰é–‹å§‹æ™‚é–“çš„æƒ…æ³ï¼Œæª¢æŸ¥æ˜¯å¦åœ¨è©²æ™‚é–“é»
                  return selectedStart <= slot.time && selectedEnd > slot.time;
                }
              });
              
              if (isConflict) {
                timeStartInput.setCustomValidity('è©²æ™‚é–“æ®µå·²è¢«å…¶ä»–å» å•†é ç´„ï¼Œè«‹é¸æ“‡å…¶ä»–æ™‚é–“');
                timeEndInput.setCustomValidity('è©²æ™‚é–“æ®µå·²è¢«å…¶ä»–å» å•†é ç´„ï¼Œè«‹é¸æ“‡å…¶ä»–æ™‚é–“');
                timeStartInput.style.borderColor = '#dc3545';
                timeEndInput.style.borderColor = '#dc3545';
              } else {
                timeStartInput.setCustomValidity('');
                timeEndInput.setCustomValidity('');
                timeStartInput.style.borderColor = '';
                timeEndInput.style.borderColor = '';
              }
            };
            
            // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            timeStartInput.removeEventListener('change', validateTime);
            timeEndInput.removeEventListener('change', validateTime);
            
            // æ·»åŠ æ–°çš„äº‹ä»¶ç›£è½å™¨
            timeStartInput.addEventListener('change', validateTime);
            timeEndInput.addEventListener('change', validateTime);
          } else {
            warningDiv.style.display = 'none';
          }
        } else {
          warningDiv.style.display = 'none';
        }
      } else {
        warningDiv.style.display = 'none';
      }
    }
    
    // ä¿å­˜é¢è©¦æ’ç¨‹
    async function saveInterviewSchedule() {
      if (!selectedInterviewDate) {
        alert('è«‹é¸æ“‡æ—¥æœŸ');
        return;
      }
      
      const dateStr = formatDate(selectedInterviewDate);
      
      // æª¢æŸ¥è©²æ—¥æœŸæ˜¯å¦æœ‰è‡ªå·±çš„æ’ç¨‹
      // å„ªå…ˆå¾ allVendorSchedules æª¢æŸ¥ï¼ˆæ›´æº–ç¢ºï¼‰
      let hasOwnSchedule = false;
      if (allVendorSchedules.has(dateStr)) {
        const schedules = allVendorSchedules.get(dateStr);
        hasOwnSchedule = schedules.some(s => s.is_own);
      } else {
        // å¦‚æœ allVendorSchedules ä¸­æ²’æœ‰ï¼Œæª¢æŸ¥æœ¬åœ°å­˜å„²ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
        hasOwnSchedule = interviewSchedules.has(dateStr);
      }
      
      // å…è¨±åœ¨åŒä¸€å¤©æ–°å¢è‡ªå·±çš„æ’ç¨‹ï¼Œå³ä½¿æœ‰å…¶ä»–å» å•†çš„æ’ç¨‹
      // å¾Œç«¯æœƒç¢ºä¿ä¸æœƒè¦†è“‹å…¶ä»–å» å•†çš„æ’ç¨‹
      
      const timeStart = document.getElementById('interviewTimeStart').value.trim();
      const timeEnd = document.getElementById('interviewTimeEnd').value.trim();
      
      if (!timeStart) {
        alert('è«‹è¼¸å…¥é–‹å§‹æ™‚é–“');
        document.getElementById('interviewTimeStart').focus();
        return;
      }
      
      if (!timeEnd) {
        alert('è«‹è¼¸å…¥çµæŸæ™‚é–“');
        document.getElementById('interviewTimeEnd').focus();
        return;
      }
      
      // é©—è­‰çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“
      if (timeEnd <= timeStart) {
        alert('çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“');
        document.getElementById('interviewTimeEnd').focus();
        return;
      }
      
      // æª¢æŸ¥æ—¥æœŸå’Œæ™‚é–“æ˜¯å¦å·²éæœŸ
      const now = new Date();
      const selectedDate = new Date(selectedInterviewDate);
      selectedDate.setHours(0, 0, 0, 0); // è¨­ç½®ç‚ºç•¶å¤©çš„ 00:00:00
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      
      // æª¢æŸ¥æ—¥æœŸæ˜¯å¦å·²éæœŸ
      if (selectedDate < today) {
        alert('ç„¡æ³•å„²å­˜ï¼šé¸æ“‡çš„æ—¥æœŸå·²éæœŸï¼Œè«‹é¸æ“‡ä»Šå¤©æˆ–æœªä¾†çš„æ—¥æœŸ');
        return;
      }
      
      // å¦‚æœé¸æ“‡çš„æ˜¯ä»Šå¤©ï¼Œæª¢æŸ¥æ™‚é–“æ˜¯å¦å·²éæœŸ
      if (selectedDate.getTime() === today.getTime()) {
        // å°‡æ™‚é–“è½‰æ›ç‚ºåˆ†é˜æ•¸é€²è¡Œæº–ç¢ºæ¯”è¼ƒ
        const timeToMinutes = (timeStr) => {
          const [hours, minutes] = timeStr.split(':').map(Number);
          return hours * 60 + (minutes || 0);
        };
        
        const currentMinutes = now.getHours() * 60 + now.getMinutes();
        const startMinutes = timeToMinutes(timeStart);
        const endMinutes = timeToMinutes(timeEnd);
        
        // æª¢æŸ¥é–‹å§‹æ™‚é–“æ˜¯å¦å·²éæœŸï¼ˆå¿…é ˆæ˜¯æœªä¾†çš„æ™‚é–“ï¼‰
        if (startMinutes <= currentMinutes) {
          const currentTimeDisplay = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
          alert(`ç„¡æ³•å„²å­˜ï¼šé¸æ“‡çš„é–‹å§‹æ™‚é–“ï¼ˆ${timeStart}ï¼‰å·²éæœŸæˆ–å·²é–‹å§‹ï¼ˆç•¶å‰æ™‚é–“ï¼š${currentTimeDisplay}ï¼‰ï¼Œè«‹é¸æ“‡æœªä¾†çš„æ™‚é–“`);
          document.getElementById('interviewTimeStart').focus();
          return;
        }
        
        // æª¢æŸ¥çµæŸæ™‚é–“æ˜¯å¦å·²éæœŸï¼ˆå¿…é ˆæ˜¯æœªä¾†çš„æ™‚é–“ï¼‰
        if (endMinutes <= currentMinutes) {
          const currentTimeDisplay = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
          alert(`ç„¡æ³•å„²å­˜ï¼šé¸æ“‡çš„çµæŸæ™‚é–“ï¼ˆ${timeEnd}ï¼‰å·²éæœŸï¼ˆç•¶å‰æ™‚é–“ï¼š${currentTimeDisplay}ï¼‰ï¼Œè«‹é¸æ“‡æœªä¾†çš„æ™‚é–“`);
          document.getElementById('interviewTimeEnd').focus();
          return;
        }
      }
      
      const locationSelect = document.getElementById('interviewLocation');
      const locationOtherInput = document.getElementById('interviewLocationOther');
      let location = '';
      
      if (locationSelect.value === 'other') {
        // å¦‚æœé¸æ“‡ã€Œå…¶ä»–ã€ï¼Œä½¿ç”¨è¼¸å…¥æ¡†çš„å€¼
        location = locationOtherInput ? locationOtherInput.value.trim() : '';
        if (!location) {
          alert('è«‹è¼¸å…¥å…¶ä»–é¢è©¦åœ°é»');
          if (locationOtherInput) {
            locationOtherInput.focus();
          }
          return;
        }
      } else {
        // ä½¿ç”¨é¸å–®ä¸­çš„å€¼
        location = locationSelect.value.trim();
        if (!location) {
          alert('è«‹é¸æ“‡é¢è©¦åœ°é»');
          locationSelect.focus();
          return;
        }
      }
      
      const notes = document.getElementById('interviewNotes').value.trim();
      
      // ç²å–é¸ä¸­çš„å­¸ç”Ÿ ID åŠå…¶å°æ‡‰çš„ application_id å’Œ job_id
      const studentsContainer = document.getElementById('interviewStudents');
      const selectedStudents = [];
      const studentApplications = []; // ä¿å­˜æ¯å€‹å­¸ç”Ÿå°æ‡‰çš„ application_id å’Œ job_id
      const conflictedStudents = []; // è¨˜éŒ„å·²è¢«å…¶ä»–å» å•†å®‰æ’é¢è©¦çš„å­¸ç”Ÿï¼ˆåŒä¸€æ™‚é–“æ®µï¼‰
      
      if (studentsContainer) {
        const checkboxes = studentsContainer.querySelectorAll('.student-checkbox:checked');
        checkboxes.forEach(checkbox => {
          const studentId = checkbox.value;
          
          // æª¢æŸ¥è©²å­¸ç”Ÿæ˜¯å¦å·²ç¶“è¢«å…¶ä»–å» å•†åœ¨åŒä¸€æ™‚é–“æ®µå®‰æ’äº†é¢è©¦
          if (allVendorSchedules.has(dateStr)) {
            const schedules = allVendorSchedules.get(dateStr);
            // éæ¿¾å…¶ä»–å» å•†çš„æ’ç¨‹ï¼šå„ªå…ˆé€šéå…¬å¸åç¨±åˆ¤æ–·
            const otherVendorSchedules = schedules.filter(s => {
              // å„ªå…ˆé€šéå…¬å¸åç¨±åˆ¤æ–·ï¼ˆæœ€æº–ç¢ºï¼‰
              if (vendorCompanyName && s.company_name) {
                return s.company_name.trim() !== vendorCompanyName.trim();
              }
              // å¦‚æœæ²’æœ‰å…¬å¸åç¨±ä¿¡æ¯ï¼Œå‰‡ä½¿ç”¨ is_own åˆ¤æ–·
              return s.is_own === false;
            });
            
            console.log(`ğŸ” [saveInterviewSchedule] æª¢æŸ¥å­¸ç”Ÿ ${studentId} åœ¨æ™‚é–“æ®µ ${timeStart}-${timeEnd} çš„è¡çªï¼Œå…¶ä»–å» å•†æ’ç¨‹æ•¸é‡: ${otherVendorSchedules.length}`);
            
            // æª¢æŸ¥è©²å­¸ç”Ÿæ˜¯å¦åœ¨è©²æ™‚é–“æ®µå·²è¢«å…¶ä»–å» å•†å®‰æ’
            const conflictingSchedule = otherVendorSchedules.find(schedule => {
              // æª¢æŸ¥å­¸ç”ŸIDæ˜¯å¦åŒ¹é…
              const scheduleStudentId = String(schedule.student_id || '');
              const currentStudentId = String(studentId);
              const studentMatch = scheduleStudentId === currentStudentId;
              
              console.log(`ğŸ” [saveInterviewSchedule] æª¢æŸ¥æ’ç¨‹: schedule.student_id=${schedule.student_id}, ç›®æ¨™studentId=${studentId}, åŒ¹é…=${studentMatch}`);
              
              if (!studentMatch) {
                return false;
              }
              
              // æª¢æŸ¥æ™‚é–“æ®µæ˜¯å¦é‡ç–Š
              const otherStart = schedule.time_start || '';
              const otherEnd = schedule.time_end || '';
              
              console.log(`ğŸ” [saveInterviewSchedule] æª¢æŸ¥æ™‚é–“æ®µ: æ–°æ™‚é–“=${timeStart}-${timeEnd}, èˆŠæ™‚é–“=${otherStart}-${otherEnd}`);
              
              if (otherStart && otherEnd) {
                // æ™‚é–“é‡ç–Šçš„æ¢ä»¶ï¼šæ–°é–‹å§‹æ™‚é–“ < èˆŠçµæŸæ™‚é–“ ä¸” æ–°çµæŸæ™‚é–“ > èˆŠé–‹å§‹æ™‚é–“
                const isTimeOverlap = timeStart < otherEnd && timeEnd > otherStart;
                console.log(`ğŸ” [saveInterviewSchedule] æ™‚é–“æ®µé‡ç–Šæª¢æŸ¥: ${timeStart} < ${otherEnd} && ${timeEnd} > ${otherStart} => ${isTimeOverlap}`);
                return isTimeOverlap;
              } else if (otherStart) {
                // åªæœ‰é–‹å§‹æ™‚é–“çš„æƒ…æ³ï¼Œæª¢æŸ¥æ˜¯å¦åœ¨è©²æ™‚é–“é»
                const isTimeOverlap = timeStart <= otherStart && timeEnd > otherStart;
                console.log(`ğŸ” [saveInterviewSchedule] æ™‚é–“é»é‡ç–Šæª¢æŸ¥: ${timeStart} <= ${otherStart} && ${timeEnd} > ${otherStart} => ${isTimeOverlap}`);
                return isTimeOverlap;
              }
              
              return false;
            });
            
            if (conflictingSchedule) {
              const student = allResumes.find(r => String(r.student_id || r.id) === String(studentId));
              const studentName = student ? (student.name || student.student_name || 'æœªçŸ¥') : 'æœªçŸ¥';
              const timeDisplay = conflictingSchedule.time_end ? 
                `${conflictingSchedule.time_start}-${conflictingSchedule.time_end}` : 
                conflictingSchedule.time_start;
              
              console.log(`âš ï¸ [saveInterviewSchedule] ç™¼ç¾å­¸ç”Ÿè¡çª: ${studentName} å·²è¢« ${conflictingSchedule.company_name} å®‰æ’åœ¨ ${timeDisplay}`);
              
              conflictedStudents.push({
                studentId: studentId,
                studentName: studentName,
                company: conflictingSchedule.company_name || 'å…¶ä»–å» å•†',
                time: timeDisplay
              });
              return; // è·³éå·²è¢«å…¶ä»–å» å•†åœ¨åŒä¸€æ™‚é–“æ®µå®‰æ’çš„å­¸ç”Ÿ
            } else {
              console.log(`âœ… [saveInterviewSchedule] å­¸ç”Ÿ ${studentId} åœ¨æ™‚é–“æ®µ ${timeStart}-${timeEnd} æ²’æœ‰è¡çª`);
            }
          }
          
          selectedStudents.push(studentId);
          
          // å„ªå…ˆå¾ checkbox çš„ data å±¬æ€§ç²å– application_id å’Œ job_id
          let applicationId = checkbox.dataset.applicationId || null;
          let jobId = checkbox.dataset.jobId || null;
          
          // å¦‚æœ checkbox ä¸Šæ²’æœ‰é€™äº›ä¿¡æ¯ï¼Œå¾ allResumes ä¸­æŸ¥æ‰¾è©²å­¸ç”Ÿçš„è¨˜éŒ„
          // æ³¨æ„ï¼šallResumes æ‡‰è©²åªåŒ…å«ç•¶å‰å…¬å¸çš„å­¸ç”Ÿè¨˜éŒ„
          if (!applicationId || !jobId) {
            // å¾ allResumes ä¸­æŸ¥æ‰¾è©²å­¸ç”Ÿçš„è¨˜éŒ„ï¼ˆå„ªå…ˆä½¿ç”¨æœ‰ application_id çš„è¨˜éŒ„ï¼‰
            const resumes = allResumes.filter(r => {
              const resumeStudentId = String(r.student_id || r.id || '');
              return resumeStudentId === String(studentId);
            });
            
            // å„ªå…ˆä½¿ç”¨æœ‰ application_id çš„è¨˜éŒ„ï¼ˆç¢ºä¿å±¬æ–¼ç•¶å‰å…¬å¸ï¼‰
            // å¦‚æœæœ‰å¤šæ¢è¨˜éŒ„ï¼Œå„ªå…ˆä½¿ç”¨æœ‰ application_id çš„
            let resume = resumes.find(r => r.application_id);
            if (!resume) {
              resume = resumes[0];
            }
            
            if (resume) {
              applicationId = applicationId || resume.application_id || null;
              jobId = jobId || resume.job_id || resume.jobId || null;
              
              // é©—è­‰è¨˜éŒ„æ˜¯å¦å±¬æ–¼ç•¶å‰å…¬å¸ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
              const resumeCompanyId = resume.company_id;
              if (resumeCompanyId) {
                const urlParams = new URLSearchParams(window.location.search);
                const targetCompanyId = urlParams.get('company_id');
                if (targetCompanyId && String(resumeCompanyId) !== String(targetCompanyId)) {
                  console.warn(`âš ï¸ å­¸ç”Ÿ ${studentId} çš„è¨˜éŒ„å±¬æ–¼ä¸åŒå…¬å¸: resume.company_id=${resumeCompanyId}, targetCompanyId=${targetCompanyId}`);
                  // å˜—è©¦æŸ¥æ‰¾å±¬æ–¼ç•¶å‰å…¬å¸çš„è¨˜éŒ„
                  const correctResume = resumes.find(r => r.company_id && String(r.company_id) === String(targetCompanyId) && r.application_id);
                  if (correctResume) {
                    applicationId = correctResume.application_id;
                    jobId = correctResume.job_id || correctResume.jobId;
                    console.log(`âœ… æ‰¾åˆ°æ­£ç¢ºçš„å…¬å¸è¨˜éŒ„: application_id=${applicationId}, job_id=${jobId}`);
                  }
                }
              }
              
              // å¦‚æœé‚„æ˜¯æ²’æœ‰ï¼Œè¨˜éŒ„è­¦å‘Š
              if (!applicationId || !jobId) {
                console.warn(`âš ï¸ å­¸ç”Ÿ ${studentId} æ‰¾ä¸åˆ° application_id æˆ– job_id`, resume);
              }
            } else {
              console.warn(`âš ï¸ åœ¨ allResumes ä¸­æ‰¾ä¸åˆ°å­¸ç”Ÿ ${studentId} çš„è¨˜éŒ„`);
            }
          }
          
          studentApplications.push({
            student_id: studentId,
            application_id: applicationId,
            job_id: jobId
          });
        });
      }
      
      // å¦‚æœæœ‰è¡çªçš„å­¸ç”Ÿï¼ˆåŒä¸€æ™‚é–“æ®µï¼‰ï¼Œé¡¯ç¤ºè­¦å‘Šä¸¦é˜»æ­¢ä¿å­˜
      if (conflictedStudents.length > 0) {
        const conflictedNames = conflictedStudents.map(c => {
          return `${c.studentName} (å·²è¢« ${c.company} å®‰æ’åœ¨ ${c.time})`;
        }).join('\n');
        
        alert(`âŒ ä»¥ä¸‹å­¸ç”Ÿåœ¨è©²æ™‚é–“æ®µå·²è¢«å…¶ä»–å» å•†å®‰æ’é¢è©¦ï¼Œç„¡æ³•é‡è¤‡å®‰æ’ï¼š\n\n${conflictedNames}\n\nè«‹å–æ¶ˆé¸æ“‡é€™äº›å­¸ç”Ÿæˆ–é¸æ“‡å…¶ä»–æ™‚é–“æ®µå¾Œå†å„²å­˜ã€‚`);
        return;
      }
      
      // å¦‚æœæ²’æœ‰é¸ä¸­ä»»ä½•å­¸ç”Ÿï¼Œæç¤ºç”¨æˆ¶
      if (selectedStudents.length === 0) {
        alert('è«‹è‡³å°‘é¸æ“‡ä¸€ä½å­¸ç”Ÿ');
        return;
      }
      
      // æ³¨æ„ï¼šåªæª¢æŸ¥å­¸ç”Ÿè¡çªï¼ˆåŒä¸€å­¸ç”Ÿåœ¨åŒä¸€æ™‚é–“æ®µï¼‰ï¼Œä¸æª¢æŸ¥ç´”æ™‚é–“æ®µè¡çª
      // å¦‚æœæ™‚é–“æ®µç›¸åŒä½†å­¸ç”Ÿä¸åŒï¼Œå…è¨±æ–°å¢ï¼ˆä¸åŒå­¸ç”Ÿå¯ä»¥åœ¨åŒä¸€æ™‚é–“æ®µé¢è©¦ï¼‰
      
      // ä¸å†ä¿å­˜åˆ°æœ¬åœ°å­˜å„²ï¼Œå®Œå…¨ä¾è³´è³‡æ–™åº«
      // interviewSchedules åƒ…ç”¨æ–¼ç·¨è¼¯æ¨¡å¼è¼‰å…¥ï¼Œä¸ä½œç‚ºé¡¯ç¤ºä¾æ“š
      
      // å¦‚æœæœ‰é¸ä¸­å­¸ç”Ÿï¼Œèª¿ç”¨å¾Œç«¯ API è¨˜éŒ„åˆ° vendor_preference_history è³‡æ–™è¡¨
      if (selectedStudents.length > 0) {
        // æ·»åŠ èª¿è©¦æ—¥èªŒ
        console.log('ğŸ“‹ æº–å‚™ç™¼é€é¢è©¦æ’ç¨‹æ•¸æ“šï¼š');
        console.log('  - é¸ä¸­çš„å­¸ç”ŸIDï¼š', selectedStudents);
        console.log('  - å­¸ç”Ÿç”³è«‹ä¿¡æ¯ï¼š', studentApplications);
        
        const interviewData = {
          student_ids: selectedStudents,
          student_applications: studentApplications, // å‚³éæ¯å€‹å­¸ç”Ÿå°æ‡‰çš„ application_id å’Œ job_id
          interview_date: dateStr,
          interview_time_start: timeStart,
          interview_time_end: timeEnd,
          interview_location: location,
          interview_notes: notes
        };
        
        console.log('ğŸ“¤ ç™¼é€å®Œæ•´æ•¸æ“šï¼š', JSON.stringify(interviewData, null, 2));
        
        fetch("/vendor/api/schedule_interviews", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(interviewData)
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            // ç«‹å³æ›´æ–°å‰ç«¯ç‹€æ…‹é¡¯ç¤º
            selectedStudents.forEach(studentId => {
              allResumes.forEach(resume => {
                const resumeStudentId = String(resume.student_id || resume.id || '');
                if (resumeStudentId === String(studentId)) {
                  // æ›´æ–° interview_status ç‚º 'scheduled'
                  resume.interview_status = 'scheduled';
                  resume.has_interview = true;
                  const key = String(resume.preference_id || resume.preferenceId || resume.id);
                  interviewedSet.add(key);
                }
              });
            });
            
            // ç«‹å³é‡æ–°æ¸²æŸ“è¡¨æ ¼ä»¥é¡¯ç¤ºã€Œé¢è©¦ä¸­ã€ç‹€æ…‹
            applyFilters();
            
            // é‡æ–°è¼‰å…¥è³‡æ–™ä»¥ç¢ºä¿ç‹€æ…‹åŒæ­¥
            fetch(getResumeApiUrl()).then(r=>r.json()).then(async d=>{
              if(d.success) { 
                allResumes = d.resumes;
                interviewedSet.clear();
                // å„ªå…ˆä½¿ç”¨ interview_status å€¼ï¼ˆå¾ resume_applications è¡¨è®€å–ï¼‰
                allResumes.forEach(r => {
                  const interviewStatus = r.interview_status || 'none';
                  if (interviewStatus !== 'none' || r.has_interview || r.interview_completed) {
                    const key = String(r.preference_id || r.preferenceId || r.id);
                    interviewedSet.add(key);
                  }
                });
                applyFilters();
                
                // é‡æ–°è¼‰å…¥æ‰€æœ‰å» å•†çš„é¢è©¦æ’ç¨‹
                await loadAllVendorSchedules();
                // é‡æ–°æ¸²æŸ“æ—¥æ›†ä»¥é¡¯ç¤ºè‡ªå·±çš„æ’ç¨‹
                renderCalendar();
                // é‡æ–°è¼‰å…¥å­¸ç”Ÿåˆ—è¡¨ï¼ˆæ–°å¢æ¨¡å¼ä¸‹ï¼Œå·²å®‰æ’çš„å­¸ç”Ÿæœƒè®Šæˆå”¯è®€ï¼‰
                // æ³¨æ„ï¼šä¿å­˜æˆåŠŸå¾Œï¼Œè¡¨å–®å¯èƒ½é‚„åœ¨ç·¨è¼¯æ¨¡å¼ï¼Œæ‰€ä»¥å‚³é falseï¼ˆæ–°å¢æ¨¡å¼ï¼‰
                populateStudentsDropdown(false);
              }
            });
          } else {
            console.error("è¨˜éŒ„é¢è©¦æ’ç¨‹åˆ°è³‡æ–™åº«å¤±æ•—:", data.message);
            // å³ä½¿å¾Œç«¯è¨˜éŒ„å¤±æ•—ï¼Œä¹Ÿæ›´æ–°å‰ç«¯ç‹€æ…‹
            selectedStudents.forEach(studentId => {
              allResumes.forEach(resume => {
                const resumeStudentId = String(resume.student_id || resume.id || '');
                if (resumeStudentId === String(studentId)) {
                  resume.has_interview = true;
                  const key = String(resume.preference_id || resume.preferenceId || resume.id);
                  interviewedSet.add(key);
                }
              });
            });
            applyFilters();
          }
        })
        .catch(err => {
          console.error("èª¿ç”¨é¢è©¦æ’ç¨‹ API å¤±æ•—:", err);
          // å³ä½¿ API èª¿ç”¨å¤±æ•—ï¼Œä¹Ÿæ›´æ–°å‰ç«¯ç‹€æ…‹
          selectedStudents.forEach(studentId => {
            allResumes.forEach(resume => {
              const resumeStudentId = String(resume.student_id || resume.id || '');
              if (resumeStudentId === String(studentId)) {
                resume.has_interview = true;
                const key = String(resume.preference_id || resume.preferenceId || resume.id);
                interviewedSet.add(key);
              }
            });
          });
          applyFilters();
        });
      } else {
        // å¦‚æœæ²’æœ‰é¸ä¸­å­¸ç”Ÿï¼Œä»ç„¶éœ€è¦é‡æ–°æ¸²æŸ“ä»¥ç¢ºä¿ç‹€æ…‹æ­£ç¢º
        applyFilters();
      }
      
      // é‡æ–°è¼‰å…¥æ‰€æœ‰å» å•†çš„é¢è©¦æ’ç¨‹ï¼ˆåŒ…æ‹¬è‡ªå·±çš„ï¼‰ï¼Œç¢ºä¿å…¶ä»–å» å•†ä¹Ÿèƒ½çœ‹åˆ°æ–°æ’ç¨‹
      await loadAllVendorSchedules();
      
      // é—œé–‰è¡¨å–®æ¨¡æ…‹æ¡†
      const formModal = bootstrap.Modal.getInstance(document.getElementById("interviewFormModal"));
      formModal.hide();
      
      // å¦‚æœé¢è©¦æ’ç¨‹æ¨¡æ…‹æ¡†æ˜¯æ‰“é–‹çš„ï¼Œé‡æ–°æ¸²æŸ“æœˆæ›†ä»¥é¡¯ç¤ºæ›´æ–°å¾Œçš„æ’ç¨‹
      const scheduleModal = bootstrap.Modal.getInstance(document.getElementById("interviewScheduleModal"));
      if (scheduleModal && scheduleModal._isShown) {
        renderCalendar();
      }
      
      // ç¢ºä¿ç‹€æ…‹æ›´æ–°å¾Œå†é¡¯ç¤ºæç¤º
      setTimeout(() => {
        alert('âœ… é¢è©¦æ’ç¨‹å·²å„²å­˜');
      }, 100);
    }

    // åˆªé™¤é¢è©¦æ’ç¨‹
    async function deleteInterviewSchedule(dateKey) {
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${dateKey} çš„é¢è©¦æ’ç¨‹å—ï¼Ÿæ­¤æ“ä½œå°‡å–æ¶ˆè©²æ—¥æœŸæ‰€æœ‰å­¸ç”Ÿçš„é¢è©¦å®‰æ’ã€‚`)) {
        return;
      }
      
      // ç²å–è©²æ—¥æœŸçš„æ’ç¨‹ä¿¡æ¯
      const schedule = interviewSchedules.get(dateKey);
      if (!schedule) {
        alert('æ‰¾ä¸åˆ°è©²æ—¥æœŸçš„é¢è©¦æ’ç¨‹');
        return;
      }
      
      // ç²å–è©²æ’ç¨‹çš„å­¸ç”Ÿåˆ—è¡¨
      const studentIds = schedule.students || [];
      
      try {
        // èª¿ç”¨å¾Œç«¯ API åˆªé™¤é¢è©¦æ’ç¨‹
        const response = await fetch("/vendor/api/delete_interview_schedule", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            interview_date: dateKey,
            student_ids: studentIds
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // å¾æœ¬åœ°å­˜å„²ä¸­åˆªé™¤
          interviewSchedules.delete(dateKey);
          // ä¸å†ä¿å­˜åˆ°æœ¬åœ°å­˜å„²ï¼Œå®Œå…¨ä¾è³´è³‡æ–™åº«
          // saveInterviewSchedulesToStorage();
          
          // æ›´æ–°å‰ç«¯ç‹€æ…‹
          studentIds.forEach(studentId => {
            allResumes.forEach(resume => {
              const resumeStudentId = String(resume.student_id || resume.id || '');
              if (resumeStudentId === String(studentId)) {
                // å¦‚æœè©²æ—¥æœŸçš„é¢è©¦è¢«åˆªé™¤ï¼Œä¸”æ²’æœ‰å…¶ä»–æ—¥æœŸçš„é¢è©¦ï¼Œå‰‡æ¸…é™¤ç‹€æ…‹
                resume.interview_status = 'none';
                resume.has_interview = false;
                const key = String(resume.preference_id || resume.preferenceId || resume.id);
                interviewedSet.delete(key);
              }
            });
          });
          
          // é‡æ–°è¼‰å…¥è³‡æ–™ä»¥ç¢ºä¿ç‹€æ…‹åŒæ­¥
          fetch(getResumeApiUrl()).then(r=>r.json()).then(async d=>{
            if(d.success) { 
              allResumes = d.resumes;
              interviewedSet.clear();
              allResumes.forEach(r => {
                const interviewStatus = r.interview_status || 'none';
                if (interviewStatus !== 'none' || r.has_interview || r.interview_completed) {
                  const key = String(r.preference_id || r.preferenceId || r.id);
                  interviewedSet.add(key);
                }
              });
              applyFilters();
              
              // é‡æ–°è¼‰å…¥æ‰€æœ‰å» å•†çš„é¢è©¦æ’ç¨‹
              await loadAllVendorSchedules();
              // é‡æ–°æ¸²æŸ“æ—¥æ›†
              renderCalendar();
            }
          });
          
          // é—œé–‰è¡¨å–®æ¨¡æ…‹æ¡†ï¼ˆå¦‚æœæ‰“é–‹çš„è©±ï¼‰
          const formModal = bootstrap.Modal.getInstance(document.getElementById("interviewFormModal"));
          if (formModal) {
            formModal.hide();
          }
          
          // ç¢ºä¿ç‹€æ…‹æ›´æ–°å¾Œå†é¡¯ç¤ºæç¤º
          setTimeout(() => {
            alert('âœ… é¢è©¦æ’ç¨‹å·²åˆªé™¤');
          }, 100);
        } else {
          alert(`âŒ åˆªé™¤å¤±æ•—ï¼š${data.message || 'æœªçŸ¥éŒ¯èª¤'}`);
        }
      } catch (err) {
        console.error("åˆªé™¤é¢è©¦æ’ç¨‹å¤±æ•—:", err);
        alert('âŒ åˆªé™¤é¢è©¦æ’ç¨‹æ™‚ç™¼ç”ŸéŒ¯èª¤');
      }
    }

    // æ¸²æŸ“æœˆæ›†
    function renderCalendar() {
      const calendar = document.getElementById("calendar");
      const monthYear = document.getElementById("currentMonthYear");
      
      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();
      
      // è¨­ç½®æœˆä»½å¹´ä»½æ¨™é¡Œ
      const monthNames = ["ä¸€æœˆ", "äºŒæœˆ", "ä¸‰æœˆ", "å››æœˆ", "äº”æœˆ", "å…­æœˆ", 
                          "ä¸ƒæœˆ", "å…«æœˆ", "ä¹æœˆ", "åæœˆ", "åä¸€æœˆ", "åäºŒæœˆ"];
      monthYear.textContent = `${year}å¹´ ${monthNames[month]}`;
      
      // ç²å–ç•¶æœˆç¬¬ä¸€å¤©å’Œæœ€å¾Œä¸€å¤©
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay(); // 0 = æ˜ŸæœŸæ—¥, 1 = æ˜ŸæœŸä¸€, ...
      
      // æ¸…ç©ºæœˆæ›†
      calendar.innerHTML = "";
      
      // æ·»åŠ æ˜ŸæœŸæ¨™é¡Œ
      const weekDays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
      weekDays.forEach(day => {
        const dayHeader = document.createElement("div");
        dayHeader.style.cssText = "padding: 12px; text-align: center; font-weight: 600; background-color: #f1f5f9; border-radius: 8px;";
        dayHeader.textContent = day;
        calendar.appendChild(dayHeader);
      });
      
      // æ·»åŠ ç©ºç™½æ ¼å­ï¼ˆæœˆåˆï¼‰
      for (let i = 0; i < startingDayOfWeek; i++) {
        const emptyCell = document.createElement("div");
        emptyCell.style.cssText = "padding: 12px; min-height: 80px; border: 1px solid #e2e8f0; border-radius: 8px; background-color: #f9fafb;";
        calendar.appendChild(emptyCell);
      }
      
      // æ·»åŠ æ—¥æœŸæ ¼å­
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      for (let day = 1; day <= daysInMonth; day++) {
        const dateCell = document.createElement("div");
        const cellDate = new Date(year, month, day);
        cellDate.setHours(0, 0, 0, 0);
        
        const isToday = cellDate.getTime() === today.getTime();
        const isPast = cellDate < today;
        
        dateCell.style.cssText = `
          padding: 12px;
          min-height: 80px;
          border: 1px solid #e2e8f0;
          border-radius: 8px;
          background-color: ${isToday ? '#e3f2fd' : isPast ? '#f9fafb' : '#ffffff'};
          cursor: ${isPast ? 'not-allowed' : 'pointer'};
          transition: background-color 0.2s;
        `;
        
        // æ—¥æœŸæ•¸å­—
        const dayNumber = document.createElement("div");
        dayNumber.style.cssText = `
          font-weight: ${isToday ? '700' : '600'};
          font-size: 1rem;
          color: ${isToday ? '#0055a8' : isPast ? '#94a3b8' : '#1e293b'};
          margin-bottom: 4px;
        `;
        dayNumber.textContent = day;
        dateCell.appendChild(dayNumber);
        
        // æª¢æŸ¥æ˜¯å¦æœ‰é¢è©¦å®‰æ’ï¼ˆå¾æœ¬åœ°å­˜å„²æˆ–å¾Œç«¯ç²å–ï¼‰
        const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        // å¾ allVendorSchedules ä¸­æª¢æŸ¥æ˜¯å¦æœ‰è‡ªå·±çš„æ’ç¨‹ï¼ˆæ›´æº–ç¢ºï¼‰
        let hasOwnInterview = false;
        let hasOtherVendorInterviews = false;
        if (allVendorSchedules.has(dateKey)) {
          const schedules = allVendorSchedules.get(dateKey);
          
          // èª¿è©¦ï¼šæ‰“å°è©²æ—¥æœŸçš„æ‰€æœ‰æ’ç¨‹ä¿¡æ¯
          console.log(`ğŸ” [renderCalendar] æ—¥æœŸ ${dateKey} çš„æ’ç¨‹:`, schedules.map(s => ({
            company: s.company_name,
            student_id: s.student_id,
            is_own: s.is_own,
            time: `${s.time_start || ''}-${s.time_end || ''}`
          })));
          console.log(`ğŸ” [renderCalendar] ç•¶å‰å» å•†å…¬å¸åç¨±: ${vendorCompanyName}`);
          
          // åˆ¤æ–·æ˜¯å¦ç‚ºè‡ªå·±çš„æ’ç¨‹ï¼šå„ªå…ˆé€šéå…¬å¸åç¨±åˆ¤æ–·ï¼ˆæœ€æº–ç¢ºï¼‰ï¼Œç„¶å¾Œæª¢æŸ¥ is_own
          hasOwnInterview = schedules.some(s => {
            // å„ªå…ˆé€šéå…¬å¸åç¨±åˆ¤æ–·ï¼ˆæœ€æº–ç¢ºï¼‰
            if (vendorCompanyName && s.company_name) {
              // ä½¿ç”¨å¯¬é¬†çš„å…¬å¸åç¨±åŒ¹é…ï¼ˆè™•ç†ã€Œæœ‰é™å…¬å¸ã€å’Œã€Œè‚¡ä»½æœ‰é™å…¬å¸ã€ç­‰å·®ç•°ï¼‰
              const isOwn = isCompanyNameMatch(s.company_name, vendorCompanyName);
              console.log(`ğŸ” [renderCalendar] é€šéå…¬å¸åç¨±åˆ¤æ–·: ${s.company_name} â‰ˆ ${vendorCompanyName} => ${isOwn}`);
              // å¦‚æœå…¬å¸åç¨±åŒ¹é…ï¼Œå°±æ˜¯è‡ªå·±çš„æ’ç¨‹
              if (isOwn) return true;
              // å¦‚æœå…¬å¸åç¨±ä¸åŒ¹é…ï¼Œå³ä½¿ is_own=true ä¹Ÿä¸æ˜¯è‡ªå·±çš„æ’ç¨‹
              if (!isOwn && s.is_own === true) {
                console.warn(`âš ï¸ [renderCalendar] è­¦å‘Šï¼šæ’ç¨‹ is_own=true ä½†å…¬å¸åç¨±ä¸åŒ¹é…ï¼Œè¦–ç‚ºå…¶ä»–å» å•†çš„æ’ç¨‹`);
                return false;
              }
            }
            // å¦‚æœæ²’æœ‰å…¬å¸åç¨±ä¿¡æ¯ï¼Œå‰‡ä½¿ç”¨ is_own åˆ¤æ–·
            if (s.is_own === true) return true;
            if (s.is_own === false) return false;
            // å¦‚æœ is_own ç‚º undefined æˆ– nullï¼Œä¸”æ²’æœ‰å…¬å¸åç¨±ä¿¡æ¯ï¼Œé»˜èªä¸æ˜¯è‡ªå·±çš„ï¼ˆå®‰å…¨èµ·è¦‹ï¼‰
            return false;
          });
          
          // åˆ¤æ–·æ˜¯å¦æœ‰å…¶ä»–å» å•†çš„æ’ç¨‹ï¼šå„ªå…ˆé€šéå…¬å¸åç¨±åˆ¤æ–·ï¼ˆæœ€æº–ç¢ºï¼‰ï¼Œç„¶å¾Œæª¢æŸ¥ is_own
          hasOtherVendorInterviews = schedules.some(s => {
            // å„ªå…ˆé€šéå…¬å¸åç¨±åˆ¤æ–·ï¼ˆæœ€æº–ç¢ºï¼‰
            if (vendorCompanyName && s.company_name) {
              // ä½¿ç”¨å¯¬é¬†çš„å…¬å¸åç¨±åŒ¹é…ï¼ˆè™•ç†ã€Œæœ‰é™å…¬å¸ã€å’Œã€Œè‚¡ä»½æœ‰é™å…¬å¸ã€ç­‰å·®ç•°ï¼‰
              const isOther = !isCompanyNameMatch(s.company_name, vendorCompanyName);
              console.log(`ğŸ” [renderCalendar] é€šéå…¬å¸åç¨±åˆ¤æ–·å…¶ä»–å» å•†: ${s.company_name} â‰ˆ ${vendorCompanyName} => ${!isOther} (isOther=${isOther})`);
              // å¦‚æœå…¬å¸åç¨±ä¸åŒ¹é…ï¼Œå°±æ˜¯å…¶ä»–å» å•†çš„æ’ç¨‹ï¼ˆå³ä½¿ is_own=trueï¼‰
              if (isOther) {
                if (s.is_own === true) {
                  console.warn(`âš ï¸ [renderCalendar] è­¦å‘Šï¼šæ’ç¨‹ is_own=true ä½†å…¬å¸åç¨±ä¸åŒ¹é…ï¼Œè¦–ç‚ºå…¶ä»–å» å•†çš„æ’ç¨‹`);
                }
                return true;
              }
              // å¦‚æœå…¬å¸åç¨±åŒ¹é…ï¼Œå³ä½¿ is_own=false ä¹Ÿæ˜¯è‡ªå·±çš„æ’ç¨‹
              return false;
            }
            // å¦‚æœæ²’æœ‰å…¬å¸åç¨±ä¿¡æ¯ï¼Œå‰‡ä½¿ç”¨ is_own åˆ¤æ–·
            if (s.is_own === false) return true;
            if (s.is_own === true) return false;
            // å¦‚æœ is_own ç‚º undefined æˆ– nullï¼Œä¸”æ²’æœ‰å…¬å¸åç¨±ä¿¡æ¯ï¼Œè¦–ç‚ºå…¶ä»–å» å•†ï¼ˆå®‰å…¨èµ·è¦‹ï¼‰
            return s.is_own !== true;
          });
          
          console.log(`ğŸ” [renderCalendar] æ—¥æœŸ ${dateKey}: hasOwnInterview=${hasOwnInterview}, hasOtherVendorInterviews=${hasOtherVendorInterviews}`);
        } else {
          // å¦‚æœ allVendorSchedules ä¸­æ²’æœ‰ï¼Œæª¢æŸ¥æœ¬åœ°å­˜å„²ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
          hasOwnInterview = interviewSchedules.has(dateKey);
        }
        
        // æ›´åš´æ ¼åœ°æª¢æŸ¥ï¼šè©²æ—¥æœŸæ˜¯å¦åªæœ‰å…¶ä»–å» å•†çš„æ’ç¨‹ï¼ˆæ²’æœ‰è‡ªå·±çš„æ’ç¨‹ï¼‰
        let onlyOtherVendorSchedules = false;
        if (hasOtherVendorInterviews && !hasOwnInterview) {
          const schedules = allVendorSchedules.get(dateKey);
          if (schedules && schedules.length > 0) {
            // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰æ’ç¨‹éƒ½æ˜¯å…¶ä»–å» å•†çš„ï¼ˆis_own = falseï¼‰
            onlyOtherVendorSchedules = schedules.every(s => !s.is_own);
          }
        }
        
        // é¡¯ç¤ºè‡ªå·±çš„é¢è©¦æ’ç¨‹ï¼ˆå¯ä»¥æœ‰å¤šå€‹æ’ç¨‹ï¼‰
        if (hasOwnInterview) {
          // å‰µå»ºé¢è©¦æ’ç¨‹å®¹å™¨ï¼ˆå‚ç›´æ’åˆ—å¤šå€‹æ’ç¨‹ï¼‰
          const interviewContainer = document.createElement("div");
          interviewContainer.style.cssText = `
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 4px;
          `;
          
          // ç²å–æ‰€æœ‰è‡ªå·±çš„æ’ç¨‹
          let ownSchedules = [];
          if (allVendorSchedules.has(dateKey)) {
            const schedules = allVendorSchedules.get(dateKey);
            // éæ¿¾è‡ªå·±çš„æ’ç¨‹ï¼šå„ªå…ˆé€šéå…¬å¸åç¨±åˆ¤æ–·ï¼ˆæœ€æº–ç¢ºï¼‰ï¼Œç„¶å¾Œæª¢æŸ¥ is_own
            ownSchedules = schedules.filter(s => {
              // å„ªå…ˆé€šéå…¬å¸åç¨±åˆ¤æ–·ï¼ˆæœ€æº–ç¢ºï¼‰
              if (vendorCompanyName && s.company_name) {
                // ä½¿ç”¨å¯¬é¬†çš„å…¬å¸åç¨±åŒ¹é…ï¼ˆè™•ç†ã€Œæœ‰é™å…¬å¸ã€å’Œã€Œè‚¡ä»½æœ‰é™å…¬å¸ã€ç­‰å·®ç•°ï¼‰
                const isOwn = isCompanyNameMatch(s.company_name, vendorCompanyName);
                // å¦‚æœå…¬å¸åç¨±åŒ¹é…ï¼Œå°±æ˜¯è‡ªå·±çš„æ’ç¨‹ï¼ˆå³ä½¿ is_own=falseï¼‰
                if (isOwn) return true;
                // å¦‚æœå…¬å¸åç¨±ä¸åŒ¹é…ï¼Œå³ä½¿ is_own=true ä¹Ÿä¸æ˜¯è‡ªå·±çš„æ’ç¨‹
                if (!isOwn && s.is_own === true) {
                  console.warn(`âš ï¸ [renderCalendar] è­¦å‘Šï¼šæ’ç¨‹ is_own=true ä½†å…¬å¸åç¨±ä¸åŒ¹é…ï¼Œéæ¿¾æ‰`);
                  return false;
                }
              }
              // å¦‚æœæ²’æœ‰å…¬å¸åç¨±ä¿¡æ¯ï¼Œå‰‡ä½¿ç”¨ is_own åˆ¤æ–·
              if (s.is_own === true) return true;
              if (s.is_own === false) return false;
              return false;
            });
          }
          
          // ä¸å†å¾ interviewSchedulesï¼ˆæœ¬åœ°å­˜å„²ï¼‰ç²å–ï¼Œå®Œå…¨ä¾è³´ allVendorSchedulesï¼ˆè³‡æ–™åº«ï¼‰
          // å¦‚æœ allVendorSchedules ä¸­æ²’æœ‰ï¼Œå°±ä¸é¡¯ç¤ºä»»ä½•æ’ç¨‹
          
          // æŒ‰æ™‚é–“åˆ†çµ„æ’ç¨‹ï¼ˆç›¸åŒæ™‚é–“æ®µçš„æ’ç¨‹åˆä½µé¡¯ç¤ºï¼‰
          const schedulesByTime = new Map();
          ownSchedules.forEach(schedule => {
            const timeKey = `${schedule.time_start || ''}-${schedule.time_end || ''}`;
            if (!schedulesByTime.has(timeKey)) {
              schedulesByTime.set(timeKey, {
                time_start: schedule.time_start || '',
                time_end: schedule.time_end || '',
                student_ids: []
              });
            }
            if (schedule.student_id) {
              const scheduleData = schedulesByTime.get(timeKey);
              if (!scheduleData.student_ids.includes(String(schedule.student_id))) {
                scheduleData.student_ids.push(String(schedule.student_id));
              }
            }
          });
          
          // ç‚ºæ¯å€‹æ™‚é–“æ®µå‰µå»ºä¸€å€‹è—è‰²æ¨™ç±¤
          schedulesByTime.forEach((scheduleData, timeKey) => {
            const timeStart = scheduleData.time_start;
            const timeEnd = scheduleData.time_end;
            
            // æ ¼å¼åŒ–æ™‚é–“é¡¯ç¤ºï¼ˆä½¿ç”¨ä¸Šåˆ/ä¸‹åˆæ ¼å¼ï¼‰
            let timeDisplay = '';
            if (timeStart) {
              const startTime = formatTimeToAMPM(timeStart.substring(0, 5)); // å– HH:MM ä¸¦è½‰æ›
              if (timeEnd && timeEnd.trim() !== '') {
                // æœ‰çµæŸæ™‚é–“ï¼Œé¡¯ç¤ºç¯„åœ
                const endTime = formatTimeToAMPM(timeEnd.substring(0, 5)); // å– HH:MM ä¸¦è½‰æ›
                timeDisplay = ` ${startTime}-${endTime}`;
              } else {
                // åªæœ‰é–‹å§‹æ™‚é–“ï¼Œåªé¡¯ç¤ºé–‹å§‹æ™‚é–“
                timeDisplay = ` ${startTime}`;
              }
            }
            
            // ç²å–æ‰€æœ‰å­¸ç”Ÿçš„å®Œæ•´å§“å
            const studentNames = [];
            if (scheduleData.student_ids.length > 0) {
              scheduleData.student_ids.forEach(studentId => {
                const student = allResumes.find(r => String(r.student_id || r.id) === String(studentId));
                if (student) {
                  const name = student.name || student.student_name || '';
                  if (name && !studentNames.includes(name)) {
                    studentNames.push(name);
                  }
                }
              });
            }
            
            // æ§‹å»ºå­¸ç”Ÿå§“åé¡¯ç¤ºæ–‡å­—ï¼ˆç”¨é “è™Ÿé€£æ¥æ‰€æœ‰å­¸ç”Ÿå§“åï¼‰
            const studentNameText = studentNames.length > 0 ? studentNames.join('ã€') : '';
            
            // å‰µå»ºé¢è©¦æ’ç¨‹æ¨™ç±¤
            const interviewBadge = document.createElement("div");
            interviewBadge.style.cssText = `
              font-size: 0.75rem;
              color: #fff;
              background-color: #0dcaf0;
              padding: 2px 6px;
              border-radius: 4px;
              display: inline-block;
              white-space: nowrap;
              cursor: pointer;
              transition: background-color 0.2s;
            `;
            interviewBadge.textContent = studentNameText ? `${studentNameText}${timeDisplay}` : `é¢è©¦${timeDisplay}`;
            interviewBadge.title = studentNameText ? `${studentNameText}${timeDisplay}` : `é¢è©¦${timeDisplay}`;
            
            // æ·»åŠ é»æ“Šäº‹ä»¶ï¼Œé»æ“Šè—è‰²æ¨™ç±¤æ™‚è¼‰å…¥è©²å» å•†çš„æ’ç¨‹è³‡æ–™ï¼ˆç·¨è¼¯æ¨¡å¼ï¼‰
            interviewBadge.addEventListener('click', (e) => {
              e.stopPropagation(); // é˜»æ­¢è§¸ç™¼æ—¥æœŸæ ¼å­çš„é»æ“Šäº‹ä»¶
              // æ˜ç¢ºæ¨™è¨˜ç‚ºç·¨è¼¯æ¨¡å¼ï¼Œè¼‰å…¥è‡ªå·±çš„æ’ç¨‹
              openInterviewForm(cellDate, true); // true è¡¨ç¤ºå¼·åˆ¶ç·¨è¼¯æ¨¡å¼
            });
            
            // æ·»åŠ æ‡¸åœæ•ˆæœ
            interviewBadge.addEventListener('mouseenter', () => {
              interviewBadge.style.backgroundColor = '#0aa2c0';
            });
            interviewBadge.addEventListener('mouseleave', () => {
              interviewBadge.style.backgroundColor = '#0dcaf0';
            });
            
            interviewContainer.appendChild(interviewBadge);
          });
          
          dateCell.appendChild(interviewContainer);
        }
        
        // é¡¯ç¤ºå…¶ä»–å» å•†å·²é ç´„çš„æ™‚é–“æ®µ
        if (hasOtherVendorInterviews) {
          const otherSchedules = allVendorSchedules.get(dateKey);
          // éæ¿¾æ‰è‡ªå·±çš„æ’ç¨‹ï¼šå„ªå…ˆé€šéå…¬å¸åç¨±åˆ¤æ–·ï¼ˆæœ€æº–ç¢ºï¼‰ï¼Œç„¶å¾Œæª¢æŸ¥ is_own
          const otherVendorSchedules = otherSchedules.filter(s => {
            // å„ªå…ˆé€šéå…¬å¸åç¨±åˆ¤æ–·ï¼ˆæœ€æº–ç¢ºï¼‰
            if (vendorCompanyName && s.company_name) {
              // ä½¿ç”¨å¯¬é¬†çš„å…¬å¸åç¨±åŒ¹é…ï¼ˆè™•ç†ã€Œæœ‰é™å…¬å¸ã€å’Œã€Œè‚¡ä»½æœ‰é™å…¬å¸ã€ç­‰å·®ç•°ï¼‰
              const isOther = !isCompanyNameMatch(s.company_name, vendorCompanyName);
              console.log(`ğŸ” [renderCalendar] éæ¿¾å…¶ä»–å» å•†æ’ç¨‹: ${s.company_name} â‰ˆ ${vendorCompanyName} => ${!isOther} (isOther=${isOther})`);
              // å¦‚æœå…¬å¸åç¨±ä¸åŒ¹é…ï¼Œå°±æ˜¯å…¶ä»–å» å•†çš„æ’ç¨‹ï¼ˆå³ä½¿ is_own=trueï¼‰
              if (isOther) {
                if (s.is_own === true) {
                  console.warn(`âš ï¸ [renderCalendar] è­¦å‘Šï¼šæ’ç¨‹ is_own=true ä½†å…¬å¸åç¨±ä¸åŒ¹é…ï¼Œè¦–ç‚ºå…¶ä»–å» å•†çš„æ’ç¨‹`);
                }
                return true;
              }
              // å¦‚æœå…¬å¸åç¨±åŒ¹é…ï¼Œå³ä½¿ is_own=false ä¹Ÿæ˜¯è‡ªå·±çš„æ’ç¨‹ï¼Œéæ¿¾æ‰
              return false;
            }
            // å¦‚æœæ²’æœ‰å…¬å¸åç¨±ä¿¡æ¯ï¼Œå‰‡ä½¿ç”¨ is_own åˆ¤æ–·
            if (s.is_own === false) return true;
            if (s.is_own === true) return false;
            // å¦‚æœ is_own ç‚º undefined æˆ– nullï¼Œè¦–ç‚ºå…¶ä»–å» å•†ï¼ˆå®‰å…¨èµ·è¦‹ï¼‰
            return s.is_own !== true;
          });
          
          console.log(`ğŸ” [renderCalendar] æ—¥æœŸ ${dateKey} çš„å…¶ä»–å» å•†æ’ç¨‹:`, otherVendorSchedules.map(s => ({
            company: s.company_name,
            student_id: s.student_id,
            time: `${s.time_start || ''}-${s.time_end || ''}`
          })));
          
          if (otherVendorSchedules.length > 0) {
            // æŒ‰æ™‚é–“æ®µåˆ†çµ„ï¼Œæ”¶é›†æ¯å€‹æ™‚é–“æ®µçš„å­¸ç”Ÿå§“å
            const schedulesByTime = new Map();
            otherVendorSchedules.forEach(schedule => {
              let timeKey = '';
              let timeDisplay = '';
              
              if (schedule.time_start && schedule.time_end) {
                const startTime = schedule.time_start.substring(0, 5);
                const endTime = schedule.time_end.substring(0, 5);
                timeKey = `${startTime}-${endTime}`;
                timeDisplay = timeKey;
              } else if (schedule.time_start) {
                const startTime = schedule.time_start.substring(0, 5);
                timeKey = startTime;
                timeDisplay = startTime;
              } else {
                return; // è·³éæ²’æœ‰æ™‚é–“çš„æ’ç¨‹
              }
              
              // ç²å–å­¸ç”Ÿå§“å
              let studentName = '';
              if (schedule.student_name) {
                // å¾Œç«¯å·²ç¶“è¿”å›å­¸ç”Ÿå§“åï¼Œç›´æ¥ä½¿ç”¨
                studentName = schedule.student_name;
              } else if (schedule.student_id) {
                // å¦‚æœå¾Œç«¯æ²’æœ‰è¿”å›å­¸ç”Ÿå§“åï¼Œå¾ allResumes æŸ¥æ‰¾
                const student = allResumes.find(r => String(r.student_id || r.id) === String(schedule.student_id));
                studentName = student ? (student.name || student.student_name || `å­¸ç”Ÿ${schedule.student_id}`) : `å­¸ç”Ÿ${schedule.student_id}`;
              }
              
              if (!schedulesByTime.has(timeKey)) {
                schedulesByTime.set(timeKey, {
                  time: timeDisplay,
                  students: []
                });
              }
              
              // æ·»åŠ å­¸ç”Ÿå§“åï¼ˆé¿å…é‡è¤‡ï¼‰
              const scheduleData = schedulesByTime.get(timeKey);
              if (studentName && !scheduleData.students.includes(studentName)) {
                scheduleData.students.push(studentName);
              }
            });
            
            if (schedulesByTime.size > 0) {
              // ç‚ºæ¯å€‹æ™‚é–“æ®µå‰µå»ºä¸€å€‹ç´…è‰²æ¨™ç±¤
              const sortedTimeSlots = Array.from(schedulesByTime.entries()).sort((a, b) => {
                return a[1].time.localeCompare(b[1].time);
              });
              
              sortedTimeSlots.forEach(([timeKey, scheduleData]) => {
                const otherVendorBadge = document.createElement("div");
                otherVendorBadge.style.cssText = `
                  font-size: 0.7rem;
                  color: #fff;
                  background-color: #dc3545;
                  padding: 2px 6px;
                  border-radius: 4px;
                  margin-top: 4px;
                  display: inline-block;
                  white-space: nowrap;
                  pointer-events: none;
                `;
                
                // æ§‹å»ºé¡¯ç¤ºæ–‡å­—ï¼šå­¸ç”Ÿå§“å + å·²æ’é¢è©¦ + æ™‚é–“
                const studentsText = scheduleData.students.length > 0 
                  ? `${scheduleData.students.join('ã€')} å·²æ’é¢è©¦ ${scheduleData.time}`
                  : `å·²æ’é¢è©¦ ${scheduleData.time}`;
                
                otherVendorBadge.textContent = studentsText;
                otherVendorBadge.title = `å…¶ä»–å» å•†å·²é ç´„ï¼š${studentsText}ï¼ˆå”¯è®€ï¼‰`;
                dateCell.appendChild(otherVendorBadge);
              });
            }
          }
        }
        
        // æ·»åŠ é»é¸äº‹ä»¶ï¼ˆééå»çš„æ—¥æœŸï¼‰
        // åªæœ‰ç•¶è©²æ—¥æœŸæœ‰è‡ªå·±çš„æ’ç¨‹æ™‚ï¼Œæ‰èƒ½é»æ“Šç·¨è¼¯ï¼›å¦‚æœåªæœ‰å…¶ä»–å» å•†çš„æ’ç¨‹ï¼Œå‰‡ä¸èƒ½ç·¨è¼¯
        if (!isPast) {
          // æ›´åš´æ ¼åœ°æª¢æŸ¥ï¼šè©²æ—¥æœŸæ˜¯å¦åªæœ‰å…¶ä»–å» å•†çš„æ’ç¨‹ï¼ˆæ²’æœ‰è‡ªå·±çš„æ’ç¨‹ï¼‰
          let onlyOtherVendorSchedules = false;
          if (hasOtherVendorInterviews && !hasOwnInterview) {
            const schedules = allVendorSchedules.get(dateKey);
            if (schedules && schedules.length > 0) {
              // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰æ’ç¨‹éƒ½æ˜¯å…¶ä»–å» å•†çš„ï¼ˆis_own = falseï¼‰
              onlyOtherVendorSchedules = schedules.every(s => !s.is_own);
              console.log(`ğŸ” [renderCalendar] æ—¥æœŸ ${dateKey}: hasOwnInterview=${hasOwnInterview}, hasOtherVendorInterviews=${hasOtherVendorInterviews}, onlyOtherVendorSchedules=${onlyOtherVendorSchedules}, schedules=`, schedules);
            }
          }
          
          // é»æ“Šæ—¥æœŸæ ¼å­ï¼ˆè—è‰²æ¨™ç±¤ä»¥å¤–çš„åœ°æ–¹ï¼‰ä¸€å¾‹è¦–ç‚ºæ–°å¢é¢è©¦æ’ç¨‹
          // åªæœ‰é»æ“Šè—è‰²æ¨™ç±¤æ‰æœƒé€²å…¥ç·¨è¼¯æ¨¡å¼
          dateCell.addEventListener('click', (e) => {
            // å¦‚æœé»æ“Šçš„æ˜¯è—è‰²æ¨™ç±¤ï¼Œäº‹ä»¶æœƒè¢«é˜»æ­¢å†’æ³¡ï¼Œä¸æœƒè§¸ç™¼é€™è£¡
            // åªæœ‰é»æ“Šæ—¥æœŸæ ¼å­çš„å…¶ä»–å€åŸŸæ‰æœƒè§¸ç™¼
            e.stopPropagation();
            // æ–°å¢æ¨¡å¼ï¼šä¸è¼‰å…¥ç¾æœ‰æ’ç¨‹
            openInterviewForm(cellDate, false);
          });
          dateCell.addEventListener('mouseenter', () => {
            dateCell.style.backgroundColor = '#f0f9ff';
          });
          dateCell.addEventListener('mouseleave', () => {
            dateCell.style.backgroundColor = isToday ? '#e3f2fd' : '#ffffff';
          });
        } else {
          dateCell.style.opacity = '0.6';
        }
        
        calendar.appendChild(dateCell);
      }
    }

  </script>
</body>
</html>
