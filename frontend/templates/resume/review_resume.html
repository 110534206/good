<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>智慧實習平台 | 學生履歷審查</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    header {
      background: linear-gradient(135deg, #0055a8 0%, #006acb 50%, #004f94 100%);
      border-bottom: none;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 8px 20px rgba(0, 68, 148, 0.35);
    }

    .topbar {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      position: relative;
    }

    .topbar h1 {
      font-size: 1.5rem;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      color: #fff;
      flex: 1;
    }

    .topbar h1 .header-title {
      flex: 1;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .topbar h1 i {
      color: #ffe27a;
    }

    body {
      font-family: "Noto Sans TC", sans-serif;
      background: #ffffff;
      margin: 0;
      padding: 0;
    }

    main {
      max-width: 1200px;
      margin: 24px auto 60px;
      padding: 0 24px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .panel {
      background: #ffffff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
      border: 1px solid #e2e8f0;
      margin-bottom: 32px;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    .panel-header h2 {
      font-size: 1.2rem;
      margin: 0;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    .table-wrapper table tbody tr:hover {
      background: rgba(15, 23, 42, 0.02);
    }

    /* 表格樣式 */
    .table thead th {
      text-align: center;
      background-color: #fafafb;
    }

    .table tbody td {
      text-align: center;
      vertical-align: middle;
    }

    .table-striped>tbody>tr:nth-of-type(odd) {
      background-color: rgba(0, 0, 0, 0.02);
    }

    /* 狀態標籤 */
    .status-badge {
      font-size: 0.9em;
      padding: 0.3em 0.6em;
      border-radius: 0.5rem;
      display: inline-block;
      font-weight: 600;
    }

    .status-badge.bg-success {
      color: #fff;
    }

    .status-badge.bg-danger {
      color: #fff;
    }

    .status-badge.bg-info {
      color: #fff;
    }

    .status-badge.bg-secondary {
      color: #fff;
    }

    .status-badge.bg-warning {
      /* 確保黃色 badge 的文字可讀 */
      color: #212529;
    }

    #commentInput {
      width: 100%;
      height: 180px;
      resize: vertical;
      padding: 0.5rem;
      font-size: 1rem;
      line-height: 1.4;
    }

    .card h4.text-center {
      color: #0066cc;
      font-weight: bold;
    }

    /* 選單按鈕樣式 */
    #menu-btn {
      width: 30px;
      height: 22px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      background: none;
      border: none;
      padding: 0;
    }

    #menu-btn span {
      display: block;
      width: 100%;
      height: 3px;
      background-color: white;
      border-radius: 2px;
      transition: all 0.3s ease;
    }

    /* 側邊選單樣式 */
    #side-menu {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 320px;
      max-width: 80vw;
      background-color: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(6px);
      box-shadow: 3px 0 12px rgba(0, 0, 0, 0.6);
      padding: 2rem 1.5rem;
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
      z-index: 1300;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      color: #fff;
      user-select: none;
    }

    #side-menu.open {
      transform: translateX(0);
    }

    #close-btn {
      position: absolute;
      top: 2rem;
      right: 1.6rem;
      font-size: 2.2rem;
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      line-height: 1;
      width: 2.4rem;
      height: 2.4rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #side-menu h2 {
      margin: 0.5rem 0 1.5rem;
      font-weight: 700;
      font-size: 1.6rem;
    }

    #side-menu a {
      display: block;
      width: 100%;
      padding: 0.6rem 0;
      font-size: 1.1rem;
      color: #e2e8f0;
      text-decoration: none;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }

    #side-menu a:hover {
      background-color: rgba(255, 255, 255, 0.18);
      color: #fff;
    }
  </style>
</head>

<body>
  <header>
    <div class="topbar">
      <h1>
        <button id="menu-btn" title="選單" role="button" tabindex="0" aria-label="開啟側邊選單">
          <span></span>
          <span></span>
          <span></span>
        </button>
        <div class="header-title">學生履歷審查</div>
        <div style="width: 30px;"></div> <!-- 佔位元素，保持標題置中 -->
      </h1>
    </div>
  </header>
  <main>
    <section class="panel" aria-label="履歷列表">
      <div class="panel-header">
        <h2>履歷列表</h2>
      </div>
      <div style="display: flex; flex-wrap: wrap; gap: 16px; align-items: center; margin-bottom: 16px;">
        <select id="departmentFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; background: #fff; font-size: 0.95rem; min-width: 150px;">
          <option value="">所有學年</option>
        </select>
        <select id="classFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; background: #fff; font-size: 0.95rem; min-width: 150px;">
          <option value="">所有班級</option>
        </select>
        <select id="companyFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; background: #fff; font-size: 0.95rem; min-width: 150px;">
          <option value="">所有公司</option>
        </select>
        <select id="statusFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; background: #fff; font-size: 0.95rem; min-width: 150px;">
          <option value="">所有狀態</option>
          <option value="pending">待審核</option>
          <option value="approved">通過</option>
          <option value="rejected">退件</option>
        </select>
        <input type="text" id="searchBox" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; background: #fff; font-size: 0.95rem; min-width: 200px; flex: 1;" placeholder="搜尋帳號/檔案" />
      </div>

      <div class="table-wrapper">
        <table style="width: 100%; border-collapse: collapse; min-width: 1000px;">
          <thead style="background: #f1f5f9;">
            <tr>
              <th style="padding: 14px 16px; text-align: left; border-bottom: 1px solid #e2e8f0; font-weight: 600;">學生帳號</th>
              <th style="padding: 14px 16px; text-align: left; border-bottom: 1px solid #e2e8f0; font-weight: 600;">姓名</th>
              <th style="padding: 14px 16px; text-align: left; border-bottom: 1px solid #e2e8f0; font-weight: 600;">上傳時間</th>
              <th style="padding: 14px 16px; text-align: left; border-bottom: 1px solid #e2e8f0; font-weight: 600;">檔案名稱</th>
              <th style="padding: 14px 16px; text-align: left; border-bottom: 1px solid #e2e8f0; font-weight: 600;">選擇公司</th>
              <th style="padding: 14px 16px; text-align: left; border-bottom: 1px solid #e2e8f0; font-weight: 600;">職缺</th>
              <th style="padding: 14px 16px; text-align: left; border-bottom: 1px solid #e2e8f0; font-weight: 600;">狀態</th>
              <th style="padding: 14px 16px; text-align: left; border-bottom: 1px solid #e2e8f0; font-weight: 600;">老師留言</th>
              <th style="padding: 14px 16px; text-align: left; border-bottom: 1px solid #e2e8f0; font-weight: 600;">操作</th>
            </tr>
          </thead>
          <tbody id="resumeTableBody">
              <tr>
                <td colspan="9" style="padding: 14px 16px; text-align: center; color: #64748b; border-bottom: 1px solid #e2e8f0;">載入中...</td>
              </tr>
          </tbody>
        </table>
      </div>

        <nav>
          <ul class="pagination justify-content-center mt-3" id="pagination"></ul>
        </nav>
    </section>
  </main>

    <div class="modal fade" id="commentModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="commentModalLabel">編輯留言</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <textarea id="commentInput"></textarea>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button class="btn btn-primary" id="saveCommentBtn">送出</button>
          </div>
        </div>
      </div>
    </div>

    <nav id="side-menu" aria-hidden="true" role="navigation" aria-label="功能選單">
      <button id="close-btn" aria-label="關閉功能選單">×</button>
      <h2>功能選單</h2>
      <a href="/vendor_home">首頁</a>
      <a href="/profile">個人資料</a>
      <a href="/vendor/resume-review">學生履歷審核</a>
      <a href="/manage_positions">職位需求管理</a>
      <a href="/confirm_matching">媒合結果</a>
      <a href="/publish_announcements">發布公告</a>
      <a href="/reviews_resumes_notifications">查看履歷與通知</a>
      <a href="/logout">登出</a>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>

      let allResumes = [];
      let currentResumeId = null;
      let currentPreferenceId = null; // 儲存當前的 preference_id（用於廠商審核）
      let currentPage = 1;
      const rowsPerPage = 10;
      let userRole = null; // 儲存用戶角色

      // ------------------------------------
      // 狀態轉換函式 (已修正：統一使用 pending 作為待審核狀態)
      // ------------------------------------

      /**
       * 根據履歷狀態返回對應的 Bootstrap 顏色類別。
       * status: 'pending', 'approved', 'rejected'
       */
      function statusColor(status) {
        return {
          'pending': 'info',       // 待審核 (藍色)
          'approved': 'success',     // 通過 (綠色)
          'rejected': 'danger',      // 退件 (紅色)
          // 兼容舊狀態
          'submitted': 'info',
          'uploaded': 'info'
        }[status] || 'secondary'; // 未知使用灰色
      }

      /**
       * 將履歷狀態碼轉換為中文顯示名稱。
       * status: 'pending', 'approved', 'rejected'
       */
      function mapStatus(status) {
        return {
          'pending': '待審核',      // 廠商視角：待審核
          'approved': '通過',
          'rejected': '退件',
          // 兼容舊狀態
          'submitted': '待審核',
          'uploaded': '待審核'
        }[status] || '未知';
      }

      // ------------------------------------
      // DOMContentLoaded 載入與事件綁定
      // ------------------------------------

      let currentUserId = null; // 儲存當前用戶 ID

      document.addEventListener("DOMContentLoaded", () => {
        // 先獲取用戶角色，根據角色調用不同的 API
        fetch('/api/profile')
          .then(res => res.json())
          .then(profileData => {
            userRole = profileData.success && profileData.user ? profileData.user.role : null;
            currentUserId = profileData.success && profileData.user ? profileData.user.id : null;
            
            let apiUrl;
            let companyApiUrl = '/api/get_reviewed_companies';
            
            // 根據角色選擇不同的 API
            if (userRole === 'vendor') {
              // 廠商：調用廠商專用的履歷 API
              apiUrl = '/vendor/api/resumes';
            } else {
              // 老師/其他角色：使用原有的 API
              const urlParams = new URLSearchParams(window.location.search);
              const mode = urlParams.get('mode');
              apiUrl = mode ? `/api/get_class_resumes?mode=${encodeURIComponent(mode)}` : `/api/get_class_resumes`;
            }
            
            // 載入履歷資料
            Promise.all([
              fetch(apiUrl).then(res => res.json()),
              userRole === 'vendor' ? Promise.resolve({success: true, companies: []}) : fetch(companyApiUrl).then(res => res.json())
            ])
              .then(([resumeData, companyData]) => {
                if (resumeData.success) {
                  allResumes = resumeData.resumes || [];
                  
                  // 如果是廠商，處理狀態：確保未審核的履歷顯示為「待審核」
                  if (userRole === 'vendor') {
                    allResumes = allResumes.map(resume => {
                      // 對於廠商來說，如果 preference_id 存在（表示有志願序），需要檢查狀態
                      if (resume.preference_id) {
                        // 如果狀態是 'approved'，檢查是否有審核標記
                        // 如果沒有 reviewed_at 且沒有 comment（廠商審核備註），視為未審核
                        if (resume.status === 'approved') {
                          const hasVendorReview = resume.reviewed_at || resume.comment;
                          if (!hasVendorReview) {
                            console.log(`⚠️ 履歷 ${resume.id} (學生: ${resume.name}) 狀態為 'approved' 但沒有廠商審核標記，強制改為 'pending'`);
                            resume.status = 'pending';
                          }
                        }
                        // 如果狀態不是 'approved' 或 'rejected'，確保是 'pending'
                        if (resume.status !== 'approved' && resume.status !== 'rejected') {
                          resume.status = 'pending';
                        }
                      } else {
                        // 如果沒有 preference_id，狀態應該是 'pending'（待審核）
                        resume.status = 'pending';
                      }
                      // 確保狀態有效，無效狀態改為 'pending'
                      if (!resume.status || !['pending', 'approved', 'rejected'].includes(resume.status)) {
                        resume.status = 'pending';
                      }
                      return resume;
                    });
                  }
                  
                  // 如果是廠商，從 API 返回的 companies 中獲取公司列表
                  if (userRole === 'vendor' && resumeData.companies) {
                    companyData = {success: true, companies: resumeData.companies};
                  }
                  
                  // 如果是指導老師，過濾出他們管理的公司
                  if ((userRole === 'teacher' || userRole === 'class_teacher') && companyData && companyData.success && companyData.companies && currentUserId) {
                    companyData.companies = companyData.companies.filter(company => {
                      // 檢查 advisor_user_id 是否匹配當前指導老師
                      return company.advisor_user_id === currentUserId;
                    });
                  }
                  
                  populateFilters(allResumes, companyData);
                  // 從 URL 參數讀取狀態並設置篩選器
                  const urlParams = new URLSearchParams(window.location.search);
                  const statusParam = urlParams.get('status');
                  if (statusParam) {
                    const statusFilter = document.getElementById('statusFilter');
                    if (statusFilter) {
                      // 將 submitted/uploaded 映射到 pending，或保持原值
                      const mappedStatus = (statusParam === 'submitted' || statusParam === 'uploaded') ? 'pending' : statusParam;
                      statusFilter.value = mappedStatus;
                    }
                  }
                  applyFilters();
                } else {
                  alert("載入資料失敗：" + (resumeData.message || "未知錯誤"));
                }
              })
              .catch(error => {
                console.error("API調用錯誤:", error);
                alert("載入資料失敗，請檢查網路連線");
              });
          })
          .catch(error => {
            console.error("獲取用戶資料失敗:", error);
            // 如果獲取用戶資料失敗，使用預設 API
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const apiUrl = mode ? `/api/get_class_resumes?mode=${encodeURIComponent(mode)}` : `/api/get_class_resumes`;
            
            Promise.all([
              fetch(apiUrl).then(res => res.json()),
              fetch('/api/get_reviewed_companies').then(res => res.json())
            ])
              .then(([resumeData, companyData]) => {
                if (resumeData.success) {
                  allResumes = resumeData.resumes;
                  populateFilters(allResumes, companyData);
                  // 從 URL 參數讀取狀態並設置篩選器
                  const urlParams = new URLSearchParams(window.location.search);
                  const statusParam = urlParams.get('status');
                  if (statusParam) {
                    const statusFilter = document.getElementById('statusFilter');
                    if (statusFilter) {
                      const mappedStatus = (statusParam === 'submitted' || statusParam === 'uploaded') ? 'pending' : statusParam;
                      statusFilter.value = mappedStatus;
                    }
                  }
                  applyFilters();
                } else {
                  alert("載入資料失敗：" + (resumeData.message || "未知錯誤"));
                }
              })
              .catch(err => {
                console.error("API調用錯誤:", err);
                alert("載入資料失敗，請檢查網路連線");
              });
          });

        // 綁定篩選事件
        document.getElementById("departmentFilter").addEventListener("change", applyFilters);
        document.getElementById("classFilter").addEventListener("change", applyFilters);
        document.getElementById("companyFilter").addEventListener("change", applyFilters);
        document.getElementById("statusFilter").addEventListener("change", applyFilters);
        document.getElementById("searchBox").addEventListener("input", applyFilters);
        document.getElementById("saveCommentBtn").addEventListener("click", saveComment); // 綁定 "儲存留言"
      });

      // 判斷是否為班導，顯示切換到班導主頁 (此段保留用戶原邏輯)
      fetch('/api/profile').then(r => r.json()).then(d => {
        if (d.success && d.user && d.user.is_homeroom) {
          const link = document.getElementById('toHomeroomLink');
          if (link) link.style.display = 'block';
        }
      }).catch(() => { });

      // ------------------------------------
      // 篩選與渲染函式
      // ------------------------------------

      function populateFilters(data, companyData) {
        const classSet = new Set();

        data.forEach(r => {
          if (r.className) classSet.add(r.className);
        });
        
        classSet.add("忠班");
        classSet.add("孝班");

        const deptSelect = document.getElementById("departmentFilter");
        const classSelect = document.getElementById("classFilter");
        const companySelect = document.getElementById("companyFilter");

        // 固定顯示 1132 和 1142 作為學年選項
        deptSelect.innerHTML = `<option value="">所有學年</option>`;
        const semesters = ['1132', '1142'];
        semesters.forEach(semester => {
          const option = document.createElement("option");
          option.value = semester;
          option.textContent = semester;
          deptSelect.appendChild(option);
        });

        classSelect.innerHTML = `<option value="">所有班級</option>`;
        companySelect.innerHTML = `<option value="">所有公司</option>`;

        Array.from(classSet).sort().forEach(c => {
          const option = document.createElement("option");
          option.value = c;
          option.textContent = c;
          classSelect.appendChild(option);
        });

        // 如果是指導老師，顯示所有他們管理的公司（從 API 獲取）
        if (userRole === 'teacher' || userRole === 'class_teacher') {
          if (companyData && companyData.success && companyData.companies) {
            // 顯示所有指導老師管理的公司（即使沒有學生選擇）
            companyData.companies.forEach(company => {
              const option = document.createElement("option");
              option.value = company.company_name;
              option.textContent = company.company_name;
              companySelect.appendChild(option);
            });
          } else {
            // 如果 API 沒有返回公司列表，從履歷資料中提取公司名稱（備用方案）
            const companySet = new Set();
            data.forEach(r => {
              if (r.company_name && r.company_name.trim()) {
                companySet.add(r.company_name.trim());
              }
            });
            Array.from(companySet).sort().forEach(companyName => {
              const option = document.createElement("option");
              option.value = companyName;
              option.textContent = companyName;
              companySelect.appendChild(option);
            });
          }
        } else {
          // 其他角色（如廠商、主任等）使用 API 返回的公司列表
          if (companyData && companyData.success && companyData.companies) {
            const openCompanies = companyData.companies.filter(company => {
              // 如果是廠商格式（有 name 屬性），直接顯示
              if (company.name) {
                return true;
              }
              // 如果是老師格式（有 company_name 和 is_open_current_semester），需要檢查是否開放
              return company.is_open_current_semester === true || company.is_open_current_semester === 1;
            });
            
            openCompanies.forEach(company => {
              const option = document.createElement("option");
              // 處理兩種格式的公司名稱
              const companyName = company.name || company.company_name;
              option.value = companyName; // 這裡使用公司名稱作為 value，前端過濾需要依賴此
              option.textContent = companyName;
              companySelect.appendChild(option);
            });
          }
        }
      }

      function applyFilters() {
        currentPage = 1;
        const dept = document.getElementById("departmentFilter").value.trim();
        const cls = document.getElementById("classFilter").value.trim();
        const companyName = document.getElementById("companyFilter").value.trim(); // 使用公司名稱
        const status = document.getElementById("statusFilter").value.trim();
        const keyword = document.getElementById("searchBox").value.trim().toLowerCase();

        const filtered = allResumes.filter(r => {
          const matchesDept = !dept || r.department === dept;
          const matchesClass = !cls || r.className === cls;
          // 使用 companyName 進行過濾
          const matchesCompany = !companyName || r.company_name === companyName; 
          
          // 狀態匹配：現在只匹配後端返回的 'pending', 'approved', 'rejected'
          let matchesStatus = true;
          if (status) {
            matchesStatus = r.status === status;
          }
          
          const matchesKeyword =
            (r.username && r.username.toLowerCase().includes(keyword)) ||
            (r.original_filename && r.original_filename.toLowerCase().includes(keyword));

          return matchesDept && matchesClass && matchesCompany && matchesStatus && matchesKeyword;
        });

        renderTable(filtered);
      }

      function renderTable(resumes) {
        const tbody = document.getElementById("resumeTableBody");
        tbody.innerHTML = "";

        if (resumes.length === 0) {
          tbody.innerHTML = `<tr><td colspan="9" style="padding: 14px 16px; text-align: center; color: #64748b;">目前沒有資料</td></tr>`;
          document.getElementById("pagination").innerHTML = "";
          return;
        }

        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageData = resumes.slice(start, end);

        pageData.forEach(r => {
          const preferenceId = r.preference_id || null;
          const companyName = r.company_name || '';
          const jobTitle = r.job_title || '';
          const row = `
        <tr style="border-bottom: 1px solid #e2e8f0;">
          <td style="padding: 14px 16px; vertical-align: middle;">${r.username}</td>
          <td style="padding: 14px 16px; vertical-align: middle;">${escapeHtml(r.name || '')}</td>
          <td style="padding: 14px 16px; vertical-align: middle;">${r.upload_time}</td>
          <td style="padding: 14px 16px; vertical-align: middle;">${escapeHtml(r.original_filename)}</td>
          <td style="padding: 14px 16px; vertical-align: middle;">${escapeHtml(companyName) || '<span style="color: #64748b;">—</span>'}</td>
          <td style="padding: 14px 16px; vertical-align: middle;">${escapeHtml(jobTitle) || '<span style="color: #64748b;">—</span>'}</td>
          <td style="padding: 14px 16px; vertical-align: middle;"><span class="status-badge bg-${statusColor(r.status)}">${mapStatus(r.status)}</span></td>
          <td style="padding: 14px 16px; vertical-align: middle;">
            <button class="btn btn-sm btn-outline-secondary ${r.comment ? 'text-success' : ''}"
              onclick="openCommentModal(${r.id}, '${escapeHtml(r.comment || '')}')"
              style="padding: 6px 12px; border-radius: 6px; border: 1px solid #e2e8f0; background: #fff; cursor: pointer; font-size: 0.875rem;">
              ${r.comment ? '已填寫' : '未填寫'}
            </button>
          </td>
          <td style="padding: 14px 16px; vertical-align: middle;">
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
         <a href="/api/download_resume/${r.id}" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #0066cc; background: #fff; color: #0066cc; text-decoration: none; font-size: 0.875rem; display: inline-block;" target="_blank">下載</a>
         <button type="button" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #dc2626; background: #fff; color: #dc2626; cursor: pointer; font-size: 0.875rem;" onclick="rejectResume(${r.id}, ${preferenceId ? preferenceId : 'null'})">退件</button>
         <button type="button" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #16a34a; background: #fff; color: #16a34a; cursor: pointer; font-size: 0.875rem;" onclick="approveResume(${r.id}, ${preferenceId ? preferenceId : 'null'})">完成</button>
            </div>
          </td>
        </tr>`;
          tbody.innerHTML += row;
        });

        renderPagination(resumes.length);
      }

      function renderPagination(totalItems) {
        const totalPages = Math.ceil(totalItems / rowsPerPage);
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        if (totalPages <= 1) return;

        for (let i = 1; i <= totalPages; i++) {
          const li = document.createElement("li");
          li.className = `page-item ${i === currentPage ? "active" : ""}`;
          li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
          li.addEventListener("click", (e) => {
            e.preventDefault();
            currentPage = i;
            applyFilters();
          });
          pagination.appendChild(li);
        }
      }

      function escapeHtml(text) {
        if (text === null || text === undefined) return '';
        return String(text)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // ------------------------------------
      // 審核操作函式
      // ------------------------------------

      // 這是給老師單純編輯 'comment' 用的，不改變狀態
      function openCommentModal(id, comment) {
        currentResumeId = id;
        document.getElementById("commentInput").value = comment;
        // 確保將 Modal 的標題和按鈕設為 '編輯留言'
        document.getElementById("commentModalLabel").textContent = "編輯留言";
        document.getElementById("saveCommentBtn").textContent = "儲存留言";
        new bootstrap.Modal(document.getElementById("commentModal")).show();
      }

      // 這是給老師單純編輯 'comment' 用的，不改變狀態
      // 如果是廠商退件後填寫原因，則更新志願申請的 comment
      function saveComment() {
        const newVal = document.getElementById("commentInput").value.trim();
        
        // 如果是廠商且有 preference_id，使用志願申請的 comment API
        if (userRole === 'vendor' && currentPreferenceId) {
          fetch(`/vendor/api/applications/${currentPreferenceId}/comment`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ comment: newVal })
          })
            .then(res => res.json())
            .then(data => {
              // 後端返回格式：{"item": detail} 或 {"error": "..."}
              if (data.item) {
                bootstrap.Modal.getInstance(document.getElementById("commentModal")).hide();
                alert("退件原因已更新");
                currentPreferenceId = null; // 清除
                // 重新應用篩選並渲染表格（不重新載入頁面）
                applyFilters();
              } else if (data.error) {
                alert("更新失敗：" + data.error);
              } else {
                alert("更新失敗：未知錯誤");
              }
            })
            .catch(error => {
              console.error("Comment error:", error);
              alert("更新失敗，網路錯誤或 API 錯誤。");
            });
        } else {
          // 老師或其他角色，使用履歷的 comment API
          fetch("/api/update_resume_field", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ resume_id: currentResumeId, field: "comment", value: newVal })
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById("commentModal")).hide();
                alert("留言更新成功");
                location.reload(); // 重新載入以更新表格顯示
              } else {
                alert("留言更新失敗");
              }
            });
        }
      }

      // 處理退件：先嘗試退件API，若成功則強制彈出留言Modal讓老師填寫原因
      function rejectResume(resumeId, preferenceId) {
        if (!confirm("確定要將此履歷標記為退件？退件後，請務必填寫退件原因。")) return;

        // 如果是廠商
        if (userRole === 'vendor') {
          // 如果有 preference_id，使用志願申請的退件 API
          if (preferenceId) {
          fetch(`/vendor/api/applications/${preferenceId}/reject`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ comment: "" }) // 初始呼叫不傳 comment，稍後在 Modal 中填寫
          })
            .then(res => res.json())
            .then(data => {
              // 後端返回格式：{"item": detail} 或 {"error": "..."}
              if (data.item) {
                // 更新本地資料中的狀態
                const resume = allResumes.find(r => r.id === resumeId);
                if (resume) {
                  resume.status = 'rejected';
                }
                
                alert("已成功標記為退件狀態。請填寫退件原因。");

                currentResumeId = resumeId;
                currentPreferenceId = preferenceId; // 儲存 preference_id 用於後續更新 comment
                document.getElementById("commentInput").value = "";

                // 修正 Modal 標題，強調這是退件原因填寫
                document.getElementById("commentModalLabel").textContent = "❌ 填寫退件原因";
                document.getElementById("saveCommentBtn").textContent = "送出";

                // 顯示留言Modal
                new bootstrap.Modal(document.getElementById("commentModal")).show();
              } else if (data.error) {
                alert("退件失敗：" + data.error);
              } else {
                alert("退件失敗：未知錯誤");
              }
            })
            .catch(error => {
              console.error("Reject error:", error);
              alert("退件失敗，網路錯誤或 API 錯誤。");
            });
          } else {
            // 沒有 preference_id，提示用戶
            alert("此學生尚未填寫志願序，無法進行退件。請等待學生填寫志願序後再進行操作。");
          }
        } else {
          // 老師或其他角色，使用履歷審核 API
          fetch(`/api/review_resume/${resumeId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status: "rejected" }) // 初始呼叫不傳 comment
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                alert("已成功標記為退件狀態。請填寫退件原因。");

                currentResumeId = resumeId;
                document.getElementById("commentInput").value = "";

                // 修正 Modal 標題，強調這是退件原因填寫
                document.getElementById("commentModalLabel").textContent = "❌ 填寫退件原因";
                document.getElementById("saveCommentBtn").textContent = "送出";

                // 顯示留言Modal
                new bootstrap.Modal(document.getElementById("commentModal")).show();
              } else {
                alert("退件失敗：" + data.message);
              }
            })
            .catch(error => {
              console.error("Reject error:", error);
              alert("退件失敗，網路錯誤或 API 錯誤。");
            });
        }
      }


      function approveResume(resumeId, preferenceId) {
        if (!confirm("確定要將此履歷標記為審核通過嗎？")) return;
        
        // 如果是廠商
        if (userRole === 'vendor') {
          // 如果有 preference_id，使用志願申請的通過 API
          if (preferenceId) {
            fetch(`/vendor/api/applications/${preferenceId}/approve`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({})
            })
              .then(res => res.json())
              .then(data => {
                // 後端返回格式：{"item": detail} 或 {"error": "..."}
                if (data.item) {
                  // 立即更新本地數據中的狀態，確保界面即時反映變化
                  const resume = allResumes.find(r => r.preference_id === preferenceId);
                  if (resume) {
                    resume.status = 'approved';
                  }
                  
                  // 獲取當前篩選條件
                  const currentStatusFilter = document.getElementById("statusFilter").value.trim();
                  const companyFilter = document.getElementById("companyFilter").value.trim();
                  const keywordFilter = document.getElementById("searchBox").value.trim();
                  
                  // 如果當前篩選的是「待審核」，自動切換到「通過」狀態，讓用戶看到更新後的結果
                  if (currentStatusFilter === 'pending') {
                    document.getElementById("statusFilter").value = 'approved';
                  }
                  
                  // 立即重新渲染表格，讓用戶立即看到狀態變化（從「待審核」變為「通過」）
                  applyFilters();
                  
                  // 在背景重新從 API 獲取最新的履歷列表，確保數據同步
                  const statusFilter = document.getElementById("statusFilter").value.trim();
                  
                  let apiUrl = '/vendor/api/resumes';
                  const params = [];
                  if (statusFilter) {
                    params.push(`status=${encodeURIComponent(statusFilter)}`);
                  }
                  if (companyFilter) {
                    // 從 allResumes 中查找對應的公司 ID
                    const matchingResume = allResumes.find(r => r.company_name === companyFilter);
                    if (matchingResume && matchingResume.company_id) {
                      params.push(`company_id=${matchingResume.company_id}`);
                    }
                  }
                  if (keywordFilter) {
                    params.push(`keyword=${encodeURIComponent(keywordFilter)}`);
                  }
                  if (params.length > 0) {
                    apiUrl += '?' + params.join('&');
                  }
                  
                  // 在背景重新獲取數據，確保與後端同步
                  fetch(apiUrl)
                    .then(res => res.json())
                    .then(resumeData => {
                      if (resumeData.success) {
                        allResumes = resumeData.resumes || [];
                        // 重新應用篩選並渲染表格
                        applyFilters();
                      }
                      // 不顯示額外的提示，因為界面已經更新了
                    })
                    .catch(error => {
                      console.error("Reload error:", error);
                      // 如果重新獲取失敗，使用已更新的本地數據（已經在 applyFilters 中處理）
                    });
                  
                  // 顯示成功提示
                  alert("✅ 履歷已標記為審核通過");
                } else if (data.error) {
                  alert("標記失敗：" + data.error);
                } else {
                  alert("標記失敗：未知錯誤");
                }
              })
              .catch(error => {
                console.error("Approve error:", error);
                alert("通過失敗，網路錯誤或 API 錯誤。");
              });
          } else {
            // 沒有 preference_id，提示用戶
            alert("此學生尚未填寫志願序，無法進行審核。請等待學生填寫志願序後再進行審核。");
          }
        } else {
          // 老師或其他角色，使用履歷審核 API
          fetch(`/api/review_resume/${resumeId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status: "approved" })
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                // 更新本地資料中的狀態
                const resume = allResumes.find(r => r.id === resumeId);
                if (resume) {
                  resume.status = 'approved';
                }
                // 重新應用篩選並渲染表格（不重新載入頁面）
                applyFilters();
                alert("✅ 履歷已標記為審核通過");
              } else {
                alert("標記失敗：" + data.message);
              }
            })
            .catch(error => {
              console.error("Approve error:", error);
              alert("通過失敗，網路錯誤或 API 錯誤。");
            });
        }
      }


      // 側邊選單控制
      document.getElementById('menu-btn').addEventListener('click', () => {
        document.getElementById('side-menu').classList.add('open');
      });
      document.getElementById('close-btn').addEventListener('click', () => {
        document.getElementById('side-menu').classList.remove('open');
      });
    </script>
</body>

</html>