<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ™ºæ…§å¯¦ç¿’å¹³å° | å­¸ç”Ÿå±¥æ­·å¯©æŸ¥</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    header {
      background: linear-gradient(135deg, #0055a8 0%, #006acb 50%, #004f94 100%);
      border-bottom: none; position: sticky; top: 0; z-index: 10;
      box-shadow: 0 8px 20px rgba(0, 68, 148, 0.35);
    }
    .topbar {
      max-width: 1800px; margin: 0 auto; padding: 18px 24px;
      display: flex; align-items: center; justify-content: space-between; color: #fff;
    }
    .topbar-left {
      display: flex; align-items: center; gap: 16px;
    }
    .topbar-left #menu-btn {
      width: 30px; height: 22px; cursor: pointer; display: flex; flex-direction: column;
      justify-content: space-between; background: none; border: none; padding: 0;
    }
    .topbar-left #menu-btn span {
      display: block; width: 100%; height: 3px; background-color: white;
      border-radius: 2px; transition: all 0.3s ease;
    }
    .topbar h1 { font-size: 1.5rem; margin: 0; text-align: center; color: #fff; flex: 1; }
    body { font-family: "Noto Sans TC", sans-serif; background: #ffffff; margin: 0; padding: 0; }
    main { max-width: 1800px; margin: 24px auto 60px; padding: 0 24px; display: flex; flex-direction: column; gap: 24px; }
    .panel {
      background: #ffffff; border-radius: 16px; padding: 24px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08); border: 1px solid #e2e8f0; margin-bottom: 32px;
    }
    .panel-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 16px; }
    .panel-header h2 { font-size: 1.2rem; margin: 0; }
    .table-wrapper { overflow-x: visible; width: 100%; }
    .table-wrapper table tbody tr:hover { background: rgba(15, 23, 42, 0.02); }
    .table thead th { text-align: left; background-color: #fafafb; }
    .table tbody td { text-align: left; vertical-align: middle; }
    .table tbody tr td:nth-child(1), .table tbody tr td:nth-child(2), 
    .table tbody tr td:nth-child(3), .table tbody tr td:nth-child(4) { vertical-align: top; }
    
    /* --- ç‹€æ…‹æ¨™ç±¤æ¨£å¼è¨­å®š --- */
    .status-badge { font-size: 0.9em; padding: 0.3em 0.6em; border-radius: 0.5rem; display: inline-block; font-weight: 600; }
    
    /* é€šéï¼šç¶ åº•ç™½å­— */
    .status-badge.bg-success { color: #fff; background-color: #198754; }
    
    /* é€€ä»¶ï¼šç´…åº•ç™½å­— */
    .status-badge.bg-danger { color: #fff; background-color: #dc3545; }
    
    /* å¾…å¯©æ ¸ï¼šè—åº•ç™½å­— */
    .status-badge.bg-info { color: #fff; background-color: #0dcaf0; }
    
    .status-badge.bg-secondary { color: #fff; background-color: #6c757d; }
    
    .alert-deadline {
      margin-bottom: 16px;
      border-radius: 8px;
      padding: 12px 16px;
    }
    
    #commentInput { width: 100%; height: 180px; resize: vertical; padding: 0.5rem; font-size: 1rem; line-height: 1.4; }
    
    /* å´é‚Šé¸å–®æ¨£å¼ */
    #side-menu {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 320px;
      max-width: 80vw;
      background-color: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(6px);
      box-shadow: 3px 0 12px rgb(0 0 0 / 0.7);
      padding: 2rem 1.5rem;
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
      z-index: 1200;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      color: white;
      user-select: none;
    }

    #side-menu.open {
      transform: translateX(0);
    }

    #close-btn {
      position: absolute;
      top: 2rem;
      right: 1.6rem;
      font-size: 2.2rem;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      line-height: 1;
      width: 2.5rem;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #side-menu h2 {
      width: 100%;
      margin-bottom: 1.5rem;
      font-weight: 700;
      font-size: 1.5rem;
      text-align: left;
    }

    #side-menu a {
      display: block;
      width: 100%;
      padding: 0.5rem 0;
      font-size: 1.1rem;
      color: #ddd;
      text-decoration: none;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }

    #side-menu a:hover {
      background-color: rgba(255, 255, 255, 0.15);
      color: white;
    }
  </style>
</head>

<body>
  <header>
    <div class="topbar">
      <div class="topbar-left">
        <button id="menu-btn" title="é¸å–®" role="button" tabindex="0" aria-label="é–‹å•Ÿå´é‚Šé¸å–®">
          <span></span><span></span><span></span>
        </button>
      </div>
      <h1>å­¸ç”Ÿå±¥æ­·å¯©æŸ¥</h1>
      <div style="width: 30px;"></div>
    </div>
  </header>
  <main>
    <section class="panel" aria-label="å±¥æ­·åˆ—è¡¨">
      <!-- æˆªæ­¢æ™‚é–“æç¤º -->
      <div id="deadlineAlert" class="alert alert-deadline" style="display: none; margin-bottom: 16px;"></div>
      
      <div class="panel-header">
        <h2 id="resumeListTitle">å±¥æ­·åˆ—è¡¨</h2>
      </div>
      <div style="display: flex; flex-wrap: wrap; gap: 16px; align-items: center; margin-bottom: 16px;">
        <select id="departmentFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">æ‰€æœ‰å­¸å¹´</option>
        </select>
        <select id="classFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">æ‰€æœ‰ç­ç´š</option>
        </select>
        <select id="companyNameFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">æ‰€æœ‰å…¬å¸</option>
        </select>
        <select id="companyFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">æ‰€æœ‰è·ç¼º</option>
        </select>
        <select id="statusFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">æ‰€æœ‰ç‹€æ…‹</option>
          <option value="pending">å¾…å¯©æ ¸</option>
          <option value="approved">é€šé</option>
          <option value="rejected">é€€ä»¶</option>
        </select>
        <input type="text" id="searchBox" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 200px; flex: 1;" placeholder="æœå°‹å¸³è™Ÿ/æª”æ¡ˆ" />
      </div>

      <div class="table-wrapper">
        <table style="width: 100%; border-collapse: collapse;">
          <thead style="background: #f1f5f9;">
            <tr>
              <th style="padding: 14px 16px; font-weight: 600;">å­¸ç”Ÿå¸³è™Ÿ</th>
              <th style="padding: 14px 16px; font-weight: 600;">å§“å</th>
              <th style="padding: 14px 16px; font-weight: 600;">ä¸Šå‚³æ™‚é–“</th>
              <th style="padding: 14px 16px; font-weight: 600;">æª”æ¡ˆåç¨±</th>
              <th style="padding: 14px 16px; font-weight: 600;">é¸æ“‡å…¬å¸</th>
              <th style="padding: 14px 16px; font-weight: 600;">è·ç¼º</th>
              <th id="statusHeader" style="padding: 14px 16px; font-weight: 600; display: none;">ç‹€æ…‹</th>
              <th style="padding: 14px 16px; font-weight: 600;" id="commentHeader">ç•™è¨€</th>
              <th style="padding: 14px 16px; font-weight: 600;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="resumeTableBody">
            <tr><td colspan="8" style="padding: 14px 16px; text-align: center; color: #64748b;">è¼‰å…¥ä¸­...</td></tr>
          </tbody>
        </table>
      </div>
      <nav><ul class="pagination justify-content-center mt-3" id="pagination"></ul></nav>
    </section>
  </main>

  <div class="modal fade" id="commentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="commentModalLabel">ç·¨è¼¯ç•™è¨€</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body"><textarea id="commentInput"></textarea></div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button class="btn btn-primary" id="saveCommentBtn">é€å‡º</button>
        </div>
      </div>
    </div>
  </div>

  <!-- å´é‚Šé¸å–® -->
  <nav id="side-menu" aria-hidden="true" role="navigation" aria-label="åŠŸèƒ½é¸å–®">
    <button id="close-btn" aria-label="é—œé–‰åŠŸèƒ½é¸å–®">Ã—</button>
    <h2>åŠŸèƒ½é¸å–®</h2>
    <a href="/director_home">é¦–é </a>
    <a href="/profile">å€‹äººè³‡æ–™</a>
    <a href="/notifications">å…¬å‘Š</a>
    <a href="/upload_company">å»ºç«‹å¯¦ç¿’æ©Ÿæœƒ</a>
    <a href="/review_resume">å­¸ç”Ÿå±¥æ­·å¯©æ ¸</a>
    <a href="/manage_vendor">å¯¦ç¿’å» å•†ç®¡ç†</a>
    <a href="/interview_schedule">è¡Œäº‹æ›†</a>
    <a href="/admission_results">æŸ¥çœ‹éŒ„å–çµæœ</a>
    <a href="/review_experience">å¯©æ ¸å¯¦ç¿’å¿ƒå¾—</a>
    <a href="/login">ç™»å‡º</a>
  </nav>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let allResumes = [];
    let currentResumeId = null;
    let currentPreferenceId = null; 
    let currentPage = 1;
    const rowsPerPage = 10;
    let userRole = null;
    let isHomeroom = false;
    let currentUserId = null;
    let isDeadlinePassed = false; // æˆªæ­¢æ™‚é–“æ˜¯å¦å·²é

    // å®šç¾©ç‹€æ…‹é¡è‰²ï¼Œapproved å°æ‡‰ success (ç¶ è‰²)
    function statusColor(status) {
      return { 'pending': 'info', 'approved': 'success', 'rejected': 'danger', 'submitted': 'info', 'uploaded': 'info' }[status] || 'secondary';
    }

    // å®šç¾©ç‹€æ…‹æ–‡å­—ï¼Œapproved å°æ‡‰ "é€šé"
    function mapStatus(status) {
      return { 'pending': 'å¾…å¯©æ ¸', 'approved': 'é€šé', 'rejected': 'é€€ä»¶', 'submitted': 'å¾…å¯©æ ¸', 'uploaded': 'å¾…å¯©æ ¸' }[status] || 'å¾…å¯©æ ¸';
    }

    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    document.addEventListener("DOMContentLoaded", () => {
      const urlParams = new URLSearchParams(window.location.search);
      const targetCompanyId = urlParams.get('company_id');
      const targetStatus = urlParams.get('status');
      const isDirectorMode = urlParams.get('mode') === 'director';

      // å¦‚æœæ˜¯ä¸»ä»»æ¨¡å¼ï¼Œéš±è—ç‹€æ…‹ç¯©é¸å™¨å’Œç‹€æ…‹æ¬„ä½
      if (isDirectorMode) {
        const statusFilter = document.getElementById('statusFilter');
        if (statusFilter) {
          statusFilter.style.display = 'none';
        }
        const statusHeader = document.getElementById('statusHeader');
        if (statusHeader) {
          statusHeader.style.display = 'none';
        }
      }

      fetch('/api/profile')
        .then(res => res.json())
        .then(profileData => {
          userRole = profileData.success && profileData.user ? profileData.user.role : 'teacher';
          currentUserId = profileData.success && profileData.user ? profileData.user.id : null;
          isHomeroom = profileData.success && profileData.user ? profileData.user.is_homeroom : false;

          let apiUrl;
          if (userRole === 'vendor') {
            apiUrl = '/vendor/api/resumes';
            const commentHeader = document.getElementById('commentHeader');
            if (commentHeader) commentHeader.textContent = 'å» å•†ç•™è¨€';
          } else {
            // ä½¿ç”¨ /api/teacher_review_resumes APIï¼ˆèˆ‡ class_review_resume.html ä¸€è‡´ï¼‰
            apiUrl = '/api/teacher_review_resumes';
          }

          Promise.all([
            fetch(apiUrl).then(res => res.ok ? res.json() : {success:false}),
            userRole === 'vendor' ? Promise.resolve({success:true, companies:[]}) : fetch('/api/get_reviewed_companies').then(res => res.ok ? res.json() : {success:true, companies:[]}),
            userRole === 'vendor' ? fetch('/vendor/api/positions').then(res => res.ok ? res.json() : {success:true, items:[]}) : (targetCompanyId ? fetch(`/api/public/company/${targetCompanyId}`).then(async res => {
               if(!res.ok) return {success:true, items:[]};
               const r = await res.json();
               return {success:true, items: (r.jobs||[]).map(j=>({id:j.id, title:j.title}))};
            }) : fetch('/api/public/positions').then(res => res.ok ? res.json() : {success:true, items:[]}))
          ]).then(([resumeResponse, companyData, positionData]) => {
            if (resumeResponse.success) {
              // è™•ç†å±¥æ­·æ•¸æ“šå’Œæˆªæ­¢æ™‚é–“ä¿¡æ¯ï¼ˆèˆ‡ class_review_resume.html ä¸€è‡´ï¼‰
              const resumes = userRole === 'vendor' ? (resumeResponse.resumes || []) : (resumeResponse.data || []);
              allResumes = resumes;
              
              // é¡¯ç¤ºæˆªæ­¢æ™‚é–“æç¤ºï¼ˆåƒ…é vendor è§’è‰²ï¼‰
              if (userRole !== 'vendor' && resumeResponse.deadline) {
                isDeadlinePassed = resumeResponse.is_deadline_passed || false;
                const deadlineAlert = document.getElementById('deadlineAlert');
                if (deadlineAlert) {
                  const isExpired = resumeResponse.is_deadline_passed;
                  if (isExpired) {
                    deadlineAlert.className = 'alert alert-warning alert-deadline';
                    deadlineAlert.innerHTML = `
                      <strong>âš ï¸ å±¥æ­·æäº¤æˆªæ­¢æ™‚é–“å·²é</strong><br>
                      å±¥æ­·æäº¤æˆªæ­¢æ™‚é–“ï¼š${resumeResponse.deadline}<br>
                      <span style="color: #dc3545;">å·²è¶…éæˆªæ­¢æ™‚é–“ï¼Œæœªé€€ä»¶çš„å±¥æ­·å·²è‡ªå‹•é€šéä¸¦å‚³çµ¦æŒ‡å°è€å¸«å¯©æ ¸ã€‚</span>
                    `;
                    deadlineAlert.style.display = 'block';
                  } else {
                    deadlineAlert.className = 'alert alert-info alert-deadline';
                    deadlineAlert.innerHTML = `
                      <strong>ğŸ“… å±¥æ­·æäº¤æˆªæ­¢æ™‚é–“æé†’</strong><br>
                      å±¥æ­·æäº¤æˆªæ­¢æ™‚é–“ï¼š${resumeResponse.deadline}<br>
                      è«‹åœ¨æˆªæ­¢æ™‚é–“å‰å®Œæˆå±¥æ­·é€€ä»¶ï¼Œå¦å‰‡å°‡è‡ªå‹•é€šéä¸¦å‚³çµ¦æŒ‡å°è€å¸«å¯©æ ¸ã€‚
                    `;
                    deadlineAlert.style.display = 'block';
                  }
                }
              }
              
              populateFilters(allResumes, companyData, positionData);

              if (targetStatus) {
                 const statusSelect = document.getElementById('statusFilter');
                 const mapped = (targetStatus === 'submitted' || targetStatus === 'uploaded') ? 'pending' : targetStatus;
                 if(statusSelect) statusSelect.value = mapped;
              }

              applyFilters();
            } else {
              allResumes = [];
              renderTable([]);
            }
          });
        });

      document.getElementById("departmentFilter").addEventListener("change", applyFilters);
      document.getElementById("classFilter").addEventListener("change", applyFilters);
      document.getElementById("companyNameFilter").addEventListener("change", applyFilters);
      document.getElementById("companyFilter").addEventListener("change", applyFilters);
      document.getElementById("statusFilter").addEventListener("change", applyFilters);
      document.getElementById("searchBox").addEventListener("input", applyFilters);
      document.getElementById("saveCommentBtn").addEventListener("click", saveComment);

      // å´é‚Šé¸å–®æ§åˆ¶
      const menuBtn = document.getElementById('menu-btn');
      const sideMenu = document.getElementById('side-menu');
      const closeBtn = document.getElementById('close-btn');

      if (menuBtn) {
        menuBtn.addEventListener('click', () => {
          if (sideMenu) {
            sideMenu.classList.add('open');
            sideMenu.setAttribute('aria-hidden', 'false');
          }
        });
      }

      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          if (sideMenu) {
            sideMenu.classList.remove('open');
            sideMenu.setAttribute('aria-hidden', 'true');
          }
        });
      }

      // é»æ“Šé¸å–®å¤–éƒ¨é—œé–‰é¸å–®
      document.addEventListener('click', (e) => {
        if (sideMenu && menuBtn) {
          if (!sideMenu.contains(e.target) && !menuBtn.contains(e.target) && sideMenu.classList.contains('open')) {
            sideMenu.classList.remove('open');
            sideMenu.setAttribute('aria-hidden', 'true');
          }
        }
      });
    });

    function populateFilters(data, companyData, positionData) {
      const urlParams = new URLSearchParams(window.location.search);
      const isDirectorMode = urlParams.get('mode') === 'director';
      
      const deptSelect = document.getElementById("departmentFilter");
      deptSelect.innerHTML = `<option value="">æ‰€æœ‰å­¸å¹´</option><option value="1132">1132</option><option value="1142">1142</option>`;
      
      const classSelect = document.getElementById("classFilter");
      if (isDirectorMode) {
          // ä¸»ä»»æ¨¡å¼ï¼šèˆ‡ class_review_resume.html ä¸€æ¨£çš„é‚è¼¯
          classSelect.innerHTML = `
            <option value="">æ‰€æœ‰ç­ç´š</option>
            <option value="å¿ ç­">å¿ ç­</option>
            <option value="å­ç­">å­ç­</option>
          `;
          
          // å‹•æ…‹æ·»åŠ å…¶ä»–ç­ç´šï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
          const classSet = new Set();
          data.forEach(r => { 
            if(r.className && r.className !== "å¿ ç­" && r.className !== "å­ç­") {
              classSet.add(r.className);
            }
          });
          
          // å°‡å…¶ä»–ç­ç´šæŒ‰å­—æ¯é †åºæ’åºå¾ŒåŠ å…¥é¸å–®
          Array.from(classSet).sort().forEach(c => {
            classSelect.innerHTML += `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`;
          });
      } else {
          // ä¸€èˆ¬æ¨¡å¼ï¼šç¶­æŒåŸæœ‰é‚è¼¯
          classSelect.innerHTML = `<option value="">æ‰€æœ‰ç­ç´š</option>`;
          const classSet = new Set();
          data.forEach(r => { if(r.className) classSet.add(r.className); });
          classSet.add("å¿ ç­"); classSet.add("å­ç­");
          Array.from(classSet).sort().forEach(c => {
             if(c !== 'äº”å­') classSelect.innerHTML += `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`;
          });
      }

      // å¡«å……å…¬å¸åç¨±ä¸‹æ‹‰é¸å–®
      const companyNameSelect = document.getElementById("companyNameFilter");
      companyNameSelect.innerHTML = `<option value="">æ‰€æœ‰å…¬å¸</option>`;
      const companySet = new Set();
      
      // ä½¿ç”¨å·²å¯©æ ¸å…¬å¸åˆ—è¡¨ï¼ˆèˆ‡ class_review_resume.html ä¸€è‡´ï¼‰
      if (companyData && companyData.companies && companyData.companies.length > 0) {
          companyData.companies.forEach(company => {
              const companyName = company.company_name || company.name || '';
              let shouldInclude = false;
              
              if (isDirectorMode || userRole === 'class_teacher') {
                  // ä¸»ä»»/ç­å°æ¨¡å¼ï¼šé¡¯ç¤ºæ‰€æœ‰å·²æ ¸å‡†ä¸”æœ¬å­¸æœŸé–‹æ”¾çš„å…¬å¸
                  shouldInclude = companyName && companyName.trim() && 
                                  company.status === 'approved' && 
                                  company.is_open_current_semester;
              } else {
                  // ä¸€èˆ¬æ¨¡å¼ï¼ˆæŒ‡å°è€å¸«ï¼‰ï¼šåªé¡¯ç¤ºè©²æŒ‡å°è€å¸«ç®¡ç†çš„å…¬å¸
                  shouldInclude = companyName && companyName.trim() && 
                                  company.advisor_user_id && 
                                  String(company.advisor_user_id) === String(currentUserId) &&
                                  company.status === 'approved' && 
                                  company.is_open_current_semester;
              }
              
              if (shouldInclude) {
                  companySet.add(companyName.trim());
              }
          });
      }
      
      // å°‡æ‰€æœ‰å…¬å¸åç¨±æ’åºå¾ŒåŠ å…¥é¸å–®
      Array.from(companySet).sort().forEach(companyName => {
          companyNameSelect.innerHTML += `<option value="${escapeHtml(companyName)}">${escapeHtml(companyName)}</option>`;
      });

      const companySelect = document.getElementById("companyFilter");
      companySelect.innerHTML = `<option value="">æ‰€æœ‰è·ç¼º</option>`;
      const jobSet = new Set();
      
      if (isDirectorMode || userRole === 'class_teacher') {
          // ä¸»ä»»/ç­å°æ¨¡å¼ï¼šå¾å·²å¯©æ ¸å…¬å¸åˆ—è¡¨ä¸­æå–æ‰€æœ‰è·ç¼ºï¼ˆèˆ‡ class_review_resume.html ä¸€æ¨£ï¼‰
          if (companyData && companyData.companies && companyData.companies.length > 0) {
              companyData.companies.forEach(c => {
                  // ç¯©é¸æ¢ä»¶ï¼šå·²æ ¸å‡† (approved) ä¸”æœ¬å­¸æœŸé–‹æ”¾ (is_open_current_semester)
                  if (c.status === 'approved' && c.is_open_current_semester && Array.isArray(c.jobs)) {
                      // éæ­·è©²å…¬å¸çš„æ‰€æœ‰è·ç¼º
                      c.jobs.forEach(jobTitle => {
                          if (jobTitle && String(jobTitle).trim()) {
                              jobSet.add(String(jobTitle).trim());
                          }
                      });
                  }
              });
          }
          
          // ä¹Ÿå¾å±¥æ­·è³‡æ–™ä¸­æå–è·ç¼ºï¼ˆä½œç‚ºè£œå……ï¼‰
          data.forEach(r => {
              const jobTitle = r.job_title || r.jobTitle || '';
              if (jobTitle && jobTitle.trim()) {
                  const titles = jobTitle.split(' | ');
                  titles.forEach(t => {
                      const parts = t.split(' - ');
                      if(parts.length > 1) {
                          jobSet.add(parts[1].trim());
                      } else if(t.trim()) {
                          jobSet.add(t.trim());
                      }
                  });
              }
          });
      } else {
          // ä¸€èˆ¬æ¨¡å¼ï¼šå„ªå…ˆå¾å±¥æ­·è³‡æ–™ä¸­æå–æ‰€æœ‰è·ç¼º
          data.forEach(r => {
              const jobTitle = r.job_title || r.jobTitle || '';
              if (jobTitle && jobTitle.trim()) {
                  // è™•ç†å¤šå€‹è·ç¼ºï¼ˆç”¨ | åˆ†éš”ï¼‰
                  const titles = jobTitle.split(' | ');
                  titles.forEach(t => {
                      // è™•ç† "å…¬å¸åç¨± - è·ç¼ºåç¨±" æ ¼å¼
                      const parts = t.split(' - ');
                      if(parts.length > 1) {
                          jobSet.add(parts[1].trim());
                      } else if(t.trim()) {
                          jobSet.add(t.trim());
                      }
                  });
              }
          });
          
          // å¦‚æœ API æœ‰æä¾›è·ç¼ºè³‡æ–™ï¼Œä¹ŸåŠ å…¥ï¼ˆä½œç‚ºè£œå……ï¼‰
          if (positionData && positionData.items && positionData.items.length > 0) {
              positionData.items.forEach(job => {
                  const jobTitle = job.title || job.job_title || '';
                  if (jobTitle) {
                      jobSet.add(jobTitle.trim());
                  }
              });
          }
      }
      
      // å°‡æ‰€æœ‰è·ç¼ºæ’åºå¾ŒåŠ å…¥é¸å–®
      Array.from(jobSet).sort().forEach(j => {
          companySelect.innerHTML += `<option value="${escapeHtml(j)}">${escapeHtml(j)}</option>`;
      });
    }

    function applyFilters() {
      currentPage = 1;
      const dept = document.getElementById("departmentFilter").value.trim();
      const cls = document.getElementById("classFilter").value.trim();
      const companyName = document.getElementById("companyNameFilter").value.trim();
      const jobFilter = document.getElementById("companyFilter").value.trim();
      const status = document.getElementById("statusFilter").value.trim();
      const keyword = document.getElementById("searchBox").value.trim().toLowerCase();
      
      const urlParams = new URLSearchParams(window.location.search);
      const isCompanyView = !!urlParams.get('company_id');

      const filtered = allResumes.filter(r => {
        const matchesDept = !dept || r.department === dept;
        const matchesClass = !cls || r.className === cls;
        const matchesKeyword = (r.username && r.username.toLowerCase().includes(keyword)) ||
                               (r.original_filename && r.original_filename.toLowerCase().includes(keyword));
        
        let matchesCompanyName = true;
        if (companyName) {
            const companyNameStr = (r.company_name || '').trim();
            matchesCompanyName = companyNameStr === companyName;
        }
        
        let matchesJob = true;
        if (jobFilter) {
            const jobs = (r.job_title || r.jobTitle || '').toLowerCase();
            matchesJob = jobs.includes(jobFilter.toLowerCase()) || (r.job_id && String(r.job_id) === jobFilter);
        }

        let matchesStatus = true;
        if (status) {
           // review_resume.html ä½¿ç”¨ teacher_review_status æ¬„ä½
           const statusStr = isCompanyView ? (r.display_status || '') : (r.teacher_review_status || 'pending');
           matchesStatus = statusStr === status;  // ä½¿ç”¨åš´æ ¼ç›¸ç­‰ï¼Œç¢ºä¿ç²¾ç¢ºåŒ¹é…
        }

        return matchesDept && matchesClass && matchesCompanyName && matchesJob && matchesStatus && matchesKeyword;
      });

      renderTable(filtered);
    }

    function renderTable(resumes) {
      const tbody = document.getElementById("resumeTableBody");
      tbody.innerHTML = "";
      
      const urlParams = new URLSearchParams(window.location.search);
      const isDirectorMode = urlParams.get('mode') === 'director';
      const isViewOnly = !!urlParams.get('company_id'); 
      const filterStatus = document.getElementById("statusFilter").value.trim(); 
      const filterJob = document.getElementById("companyFilter").value.trim();
      
      // å¦‚æœæ˜¯ä¸»ä»»æ¨¡å¼ï¼Œéš±è—ç‹€æ…‹æ¬„ä½
      const statusHeader = document.getElementById("statusHeader");
      if (statusHeader) {
        statusHeader.style.display = isDirectorMode ? 'none' : '';
      }
      
      if (resumes.length === 0) {
        const colspan = isDirectorMode ? 8 : 9;
        tbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align: center; color: #64748b; padding: 16px;">ç›®å‰æ²’æœ‰è³‡æ–™</td></tr>`;
        document.getElementById("pagination").innerHTML = "";
        return;
      } 

      let allRowsData = [];

      resumes.forEach(r => {
        // ç›´æ¥ä½¿ç”¨æœ€æ–°çš„å¿—é¡˜åºè³‡æ–™ï¼ˆå¾Œç«¯å·²è™•ç†ï¼‰
        // review_resume.html ä½¿ç”¨ resumes.teacher_review_status
        const comp = r.company_name || 'â€”';
        const job = r.job_title || r.jobTitle || 'â€”';
        const pid = r.preference_id || null;
        const st = r.teacher_review_status || 'pending';  // ç›´æ¥ä½¿ç”¨ teacher_review_statusï¼Œä¸ fallback åˆ° display_status
        const cm = r.comment || '';

        // ç‹€æ…‹ç¯©é¸
        if (filterStatus && st !== filterStatus) return;
        
        // è·ç¼ºç¯©é¸
        if (filterJob && !job.includes(filterJob) && filterJob !== (r.job_id ? String(r.job_id) : '')) return;

        allRowsData.push({
            ...r,
            display_company: comp,
            display_job: job,
            preference_id: pid,
            display_status: st,
            comment: cm,
            isMultiRow: true
        });
      });

      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pageData = allRowsData.slice(start, end);

      pageData.forEach(row => {
        const pid = row.preference_id || null;
        
        // æ¸²æŸ“æ¯ä¸€è¡Œï¼ŒstatusColor(row.display_status) æœƒæ±ºå®šèƒŒæ™¯è‰²ï¼ŒmapStatus æ±ºå®šæ–‡å­—
        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid #e2e8f0';
        const statusCell = isDirectorMode ? '' : `
           <td style="padding: 14px 16px;">
             <span class="status-badge bg-${statusColor(row.display_status)}">${mapStatus(row.display_status)}</span>
           </td>`;
        tr.innerHTML = `
           <td style="padding: 14px 16px;">${row.username}</td>
           <td style="padding: 14px 16px;">${escapeHtml(row.name)}</td>
           <td style="padding: 14px 16px;">${row.upload_time}</td>
           <td style="padding: 14px 16px; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(row.original_filename)}</td>
           <td style="padding: 14px 16px;">${escapeHtml(row.display_company)}</td>
           <td style="padding: 14px 16px;">${escapeHtml(row.display_job)}</td>
           ${statusCell}
           <td style="padding: 14px 16px;">
             ${ renderCommentBtn(row, isViewOnly, pid) }
           </td>
           <td style="padding: 14px 16px;">
             ${ renderActionBtns(row, isViewOnly, pid, isDirectorMode) }
           </td>
        `;
        tbody.appendChild(tr);
      });

      renderPagination(allRowsData.length);
    }

    function renderCommentBtn(row, isViewOnly, pid) {
        const hasComment = row.comment && row.comment.trim() !== '';
        const btnClass = hasComment ? 'text-success' : '';
        const btnText = hasComment ? 'å·²å¡«å¯«' : 'æœªå¡«å¯«';
        
        if (isViewOnly) {
            if (hasComment) {
                return `<button class="btn btn-sm btn-outline-secondary text-success" onclick="openCommentModal(${row.id}, '${escapeHtml(row.comment)}', ${pid}, true)">å·²å¡«å¯«</button>`;
            } else {
                return `<span style="color:#aaa; font-size:0.9em;">æœªå¡«å¯«</span>`;
            }
        }
        return `<button class="btn btn-sm btn-outline-secondary ${btnClass}" onclick="openCommentModal(${row.id}, '${escapeHtml(row.comment)}', ${pid}, false)">${btnText}</button>`;
    }

    function renderActionBtns(row, isViewOnly, pid, isDirectorMode = false) {
        const dlBtn = `<a href="/api/download_resume/${row.id}" class="btn btn-sm btn-outline-primary" target="_blank" style="margin-right:4px;">ä¸‹è¼‰</a>`;
        if (isViewOnly) return dlBtn; 

        const approveClick = `approveResume(${row.id}, ${pid ? `'${pid}'` : 'null'})`;
        const rejectClick = `rejectResume(${row.id}, ${pid ? `'${pid}'` : 'null'})`;

        // ä¸»ä»»æ¨¡å¼åªé¡¯ç¤ºé€€ä»¶æŒ‰éˆ•ï¼Œä¸é¡¯ç¤ºé€šéæŒ‰éˆ•
        // æ ¹æ“šæˆªæ­¢æ™‚é–“ç‹€æ…‹æ±ºå®šæ˜¯å¦é¡¯ç¤ºé€€ä»¶æŒ‰éˆ•
        // æ³¨æ„ï¼šæˆªæ­¢æ™‚é–“å¾Œï¼Œç­å°å’Œä¸»ä»»ä»èƒ½çœ‹åˆ°å±¥æ­·ï¼Œä½†é€€ä»¶æŒ‰éˆ•æœƒè¢«ç¦ç”¨
        const isRejected = row.display_status === 'rejected';
        const canReject = !isDeadlinePassed || userRole === 'vendor';
        
        // é€€ä»¶æŒ‰éˆ•é¡¯ç¤ºé‚è¼¯ï¼š
        // 1. å·²é€€ä»¶çš„å±¥æ­·ï¼šä¸é¡¯ç¤ºé€€ä»¶æŒ‰éˆ•ï¼ˆå·²é€€ä»¶ï¼‰
        // 2. æˆªæ­¢æ™‚é–“å‰ï¼šé¡¯ç¤ºå¯ç”¨çš„é€€ä»¶æŒ‰éˆ•
        // 3. æˆªæ­¢æ™‚é–“å¾Œï¼ˆç­å°/ä¸»ä»»ï¼‰ï¼šé¡¯ç¤ºç¦ç”¨çš„é€€ä»¶æŒ‰éˆ•ï¼Œè¡¨ç¤ºç„¡æ³•å†é€€ä»¶
        const rejectBtn = isRejected 
          ? '' // å·²é€€ä»¶çš„å±¥æ­·ä¸é¡¯ç¤ºé€€ä»¶æŒ‰éˆ•
          : canReject 
          ? `<button class="btn btn-sm btn-outline-danger" style="margin-right:4px;" onclick="${rejectClick}">é€€ä»¶</button>`
          : (isDeadlinePassed && (userRole === 'class_teacher' || userRole === 'director'))
          ? `<button class="btn btn-sm btn-outline-secondary" style="margin-right:4px;" disabled title="å·²éæˆªæ­¢æ™‚é–“ï¼Œç„¡æ³•é€€ä»¶">é€€ä»¶</button>`
          : '';
        
        let btns = `<div style="display:flex; align-items:center;">${dlBtn}`;
        btns += rejectBtn;
        if (!isDirectorMode) {
            btns += `<button class="btn btn-sm btn-outline-success" onclick="${approveClick}">å®Œæˆ</button>`;
        }
        btns += `</div>`;
        return btns;
    }

    function renderPagination(totalItems) {
      const totalPages = Math.ceil(totalItems / rowsPerPage);
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";
      if (totalPages <= 1) return;
      for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement("li");
        li.className = `page-item ${i === currentPage ? "active" : ""}`;
        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        li.onclick = (e) => { e.preventDefault(); currentPage = i; applyFilters(); }; 
        pagination.appendChild(li);
      }
    }

    // æ›´æ–°ç‹€æ…‹å‡½å¼
    function approveResume(resumeId, preferenceId) {
      if (!confirm("ç¢ºå®šè¦å°‡æ­¤è·ç¼ºç”³è«‹æ¨™è¨˜ç‚ºé€šéå—ï¼Ÿ")) return;
      
      const body = { status: 'approved' };
      if (preferenceId) body.preference_id = preferenceId;

      fetch(`/api/review_resume/${resumeId}`, { 
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(body)
      }).then(res => res.json()).then(data => {
          if (data.success) {
              alert("âœ… ç‹€æ…‹æ›´æ–°æˆåŠŸ");
              // é‡æ–°è¼‰å…¥è³‡æ–™
              if (userRole === 'vendor') {
                fetch('/vendor/api/resumes').then(r=>r.json()).then(d=>{
                  if(d.success) { allResumes=d.resumes || []; applyFilters(); }
                });
              } else {
                fetch('/api/teacher_review_resumes').then(r=>r.json()).then(d=>{
                  if(d.success) { allResumes=d.data || []; applyFilters(); }
                });
              }
          } else {
              alert("å¤±æ•—ï¼š" + data.message);
          }
      });
    }

    function rejectResume(resumeId, preferenceId) {
       // æª¢æŸ¥æˆªæ­¢æ™‚é–“ï¼ˆåƒ…é vendor è§’è‰²ï¼‰
       if (userRole !== 'vendor' && isDeadlinePassed) {
         alert('âš ï¸ å·²è¶…éå±¥æ­·æäº¤æˆªæ­¢æ™‚é–“ï¼Œç„¡æ³•å†é€€ä»¶å±¥æ­·ã€‚æœªé€€ä»¶çš„å±¥æ­·å·²è‡ªå‹•é€šéä¸¦å‚³çµ¦æŒ‡å°è€å¸«å¯©æ ¸ã€‚');
         return;
       }
       
       if (!confirm("ç¢ºå®šè¦é€€ä»¶æ­¤ç”³è«‹ï¼Ÿ")) return;
       currentResumeId = resumeId;
       currentPreferenceId = preferenceId;
       
       document.getElementById("commentInput").value = "";
       document.getElementById("commentModalLabel").textContent = "âŒ å¡«å¯«é€€ä»¶åŸå› ";
       document.getElementById("saveCommentBtn").textContent = "ç¢ºèªé€€ä»¶";
       const modal = new bootstrap.Modal(document.getElementById("commentModal"));
       modal.show();
       
       const saveBtn = document.getElementById("saveCommentBtn");
       saveBtn.onclick = () => {
           const reason = document.getElementById("commentInput").value.trim();
           if(!reason) { alert("è«‹å¡«å¯«é€€ä»¶åŸå› "); return; }
           
           const body = { status: 'rejected', comment: reason };
           if (currentPreferenceId) body.preference_id = currentPreferenceId;

           fetch(`/api/review_resume/${currentResumeId}`, {
               method: 'POST',
               headers: {'Content-Type': 'application/json'},
               body: JSON.stringify(body)
           }).then(res => res.json()).then(data => {
               if(data.success) {
                   alert("âœ… å·²é€€ä»¶");
                   modal.hide();
                   // é‡æ–°è¼‰å…¥æ•¸æ“š
                   const urlParams = new URLSearchParams(window.location.search);
                   const targetCompanyId = urlParams.get('company_id');
                   if (userRole === 'vendor') {
                     fetch('/vendor/api/resumes').then(r=>r.json()).then(d=>{
                       if(d.success) { allResumes=d.resumes || []; applyFilters(); }
                     });
                   } else {
                     fetch('/api/teacher_review_resumes').then(r=>r.json()).then(d=>{
                       if(d.success) { allResumes=d.data || []; applyFilters(); }
                     });
                   }
               } else {
                   alert("å¤±æ•—ï¼š" + data.message);
               }
           });
       };
    }

    function openCommentModal(id, comment, pid, readonly) {
        document.getElementById("commentInput").value = comment;
        document.getElementById("commentInput").readOnly = readonly;
        document.getElementById("commentModalLabel").textContent = readonly ? "æŸ¥çœ‹ç•™è¨€" : "ç·¨è¼¯ç•™è¨€";
        const saveBtn = document.getElementById("saveCommentBtn");
        saveBtn.style.display = readonly ? 'none' : 'block';
        saveBtn.textContent = "å„²å­˜";
        
        if (!readonly) {
            currentResumeId = id;
            currentPreferenceId = pid;
            saveBtn.onclick = saveComment; 
        }
        new bootstrap.Modal(document.getElementById("commentModal")).show();
    }

    function saveComment() {
        const val = document.getElementById("commentInput").value.trim();
        const body = { field: 'comment', value: val, resume_id: currentResumeId };
        if(currentPreferenceId) body.preference_id = currentPreferenceId;

        fetch("/api/update_resume_field", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        }).then(res => res.json()).then(data => {
             if(data.success) {
                 alert("ç•™è¨€å·²æ›´æ–°");
                 bootstrap.Modal.getInstance(document.getElementById("commentModal")).hide();
                 // é‡æ–°è¼‰å…¥è³‡æ–™
                 if (userRole === 'vendor') {
                   fetch('/vendor/api/resumes').then(r=>r.json()).then(d=>{
                     if(d.success) { allResumes=d.resumes || []; applyFilters(); }
                   });
                 } else {
                   fetch('/api/teacher_review_resumes').then(r=>r.json()).then(d=>{
                     if(d.success) { allResumes=d.data || []; applyFilters(); }
                   });
                 }
             } else {
                 alert("å¤±æ•—");
             }
        });
    }

  </script>
</body>
</html>