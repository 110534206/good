<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>智慧實習平台 | 學生履歷審查</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    header {
      background: linear-gradient(135deg, #0055a8 0%, #006acb 50%, #004f94 100%);
      border-bottom: none;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 8px 20px rgba(0, 68, 148, 0.35);
    }

    .topbar {
      max-width: 1800px;
      margin: 0 auto;
      padding: 18px 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      position: relative;
    }

    .topbar h1 {
      font-size: 1.5rem;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      color: #fff;
      flex: 1;
    }

    .topbar h1 .header-title {
      flex: 1;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .topbar h1 i {
      color: #ffe27a;
    }

    body {
      font-family: "Noto Sans TC", sans-serif;
      background: #ffffff;
      margin: 0;
      padding: 0;
    }

    main {
      max-width: 1800px;
      margin: 24px auto 60px;
      padding: 0 24px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .panel {
      background: #ffffff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
      border: 1px solid #e2e8f0;
      margin-bottom: 32px;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    .panel-header h2 {
      font-size: 1.2rem;
      margin: 0;
    }

    .table-wrapper {
      overflow-x: visible;
      width: 100%;
    }

    .table-wrapper table tbody tr:hover {
      background: rgba(15, 23, 42, 0.02);
    }

    /* 表格樣式 */
    .table thead th {
      text-align: center;
      background-color: #fafafb;
    }

    .table tbody td {
      text-align: center;
      vertical-align: middle;
    }

    .table-striped>tbody>tr:nth-of-type(odd) {
      background-color: rgba(0, 0, 0, 0.02);
    }

    /* 狀態標籤 */
    .status-badge {
      font-size: 0.9em;
      padding: 0.3em 0.6em;
      border-radius: 0.5rem;
      display: inline-block;
      font-weight: 600;
    }

    .status-badge.bg-success {
      color: #fff;
    }

    .status-badge.bg-danger {
      color: #fff;
    }

    .status-badge.bg-info {
      color: #fff;
    }

    .status-badge.bg-secondary {
      color: #fff;
    }

    .status-badge.bg-warning {
      /* 確保黃色 badge 的文字可讀 */
      color: #212529;
    }

    #commentInput {
      width: 100%;
      height: 180px;
      resize: vertical;
      padding: 0.5rem;
      font-size: 1rem;
      line-height: 1.4;
    }

    .card h4.text-center {
      color: #0066cc;
      font-weight: bold;
    }

    /* 選單按鈕樣式 */
    #menu-btn {
      width: 30px;
      height: 22px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      background: none;
      border: none;
      padding: 0;
    }

    #menu-btn span {
      display: block;
      width: 100%;
      height: 3px;
      background-color: white;
      border-radius: 2px;
      transition: all 0.3s ease;
    }

    /* 側邊選單樣式 */
    #side-menu {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 320px;
      max-width: 80vw;
      background-color: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(6px);
      box-shadow: 3px 0 12px rgba(0, 0, 0, 0.6);
      padding: 2rem 1.5rem;
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
      z-index: 1300;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      color: #fff;
      user-select: none;
    }

    #side-menu.open {
      transform: translateX(0);
    }

    #close-btn {
      position: absolute;
      top: 2rem;
      right: 1.6rem;
      font-size: 2.2rem;
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      line-height: 1;
      width: 2.4rem;
      height: 2.4rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #side-menu h2 {
      margin: 0.5rem 0 1.5rem;
      font-weight: 700;
      font-size: 1.6rem;
    }

    #side-menu a {
      display: block;
      width: 100%;
      padding: 0.6rem 0;
      font-size: 1.1rem;
      color: #e2e8f0;
      text-decoration: none;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }

    #side-menu a:hover {
      background-color: rgba(255, 255, 255, 0.18);
      color: #fff;
    }
  </style>
</head>

<body>
  <header>
    <div class="topbar">
      <h1>
        <button id="menu-btn" title="選單" role="button" tabindex="0" aria-label="開啟側邊選單">
          <span></span>
          <span></span>
          <span></span>
        </button>
        <div class="header-title">學生履歷審查</div>
        <div style="width: 30px;"></div> <!-- 佔位元素，保持標題置中 -->
      </h1>
    </div>
  </header>
  <main>
    <section class="panel" aria-label="履歷列表">
      <div class="panel-header">
        <h2>履歷列表</h2>
      </div>
      <div style="display: flex; flex-wrap: wrap; gap: 16px; align-items: center; margin-bottom: 16px;">
        <select id="departmentFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; background: #fff; font-size: 0.95rem; min-width: 150px;">
          <option value="">所有學年</option>
        </select>
        <select id="classFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; background: #fff; font-size: 0.95rem; min-width: 150px;">
          <option value="">所有班級</option>
        </select>
        <select id="companyFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; background: #fff; font-size: 0.95rem; min-width: 150px;">
          <option value="">所有職缺</option>
        </select>
        <select id="statusFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; background: #fff; font-size: 0.95rem; min-width: 150px;">
          <option value="">所有狀態</option>
          <option value="pending">待審核</option>
          <option value="approved">通過</option>
          <option value="rejected">退件</option>
        </select>
        <input type="text" id="searchBox" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; background: #fff; font-size: 0.95rem; min-width: 200px; flex: 1;" placeholder="搜尋帳號/檔案" />
      </div>

      <div class="table-wrapper">
        <table style="width: 100%; border-collapse: collapse;">
          <thead style="background: #f1f5f9;">
            <tr>
              <th style="padding: 14px 16px; text-align: left; border-bottom: 1px solid #e2e8f0; font-weight: 600;">學生帳號</th>
              <th style="padding: 14px 16px; text-align: left; border-bottom: 1px solid #e2e8f0; font-weight: 600;">姓名</th>
              <th style="padding: 14px 16px; text-align: left; border-bottom: 1px solid #e2e8f0; font-weight: 600;">上傳時間</th>
              <th style="padding: 14px 16px; text-align: left; border-bottom: 1px solid #e2e8f0; font-weight: 600;">檔案名稱</th>
              <th style="padding: 14px 16px; text-align: left; border-bottom: 1px solid #e2e8f0; font-weight: 600;">選擇公司</th>
              <th style="padding: 14px 16px; text-align: left; border-bottom: 1px solid #e2e8f0; font-weight: 600;">職缺</th>
              <th style="padding: 14px 16px; text-align: left; border-bottom: 1px solid #e2e8f0; font-weight: 600;">狀態</th>
              <th style="padding: 14px 16px; text-align: left; border-bottom: 1px solid #e2e8f0; font-weight: 600;" id="commentHeader">留言</th>
              <th style="padding: 14px 16px; text-align: left; border-bottom: 1px solid #e2e8f0; font-weight: 600;">操作</th>
            </tr>
          </thead>
          <tbody id="resumeTableBody">
              <tr>
                <td colspan="9" style="padding: 14px 16px; text-align: center; color: #64748b; border-bottom: 1px solid #e2e8f0;">載入中...</td>
              </tr>
          </tbody>
        </table>
      </div>

        <nav>
          <ul class="pagination justify-content-center mt-3" id="pagination"></ul>
        </nav>
    </section>
  </main>

    <div class="modal fade" id="commentModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="commentModalLabel">編輯留言</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <textarea id="commentInput"></textarea>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button class="btn btn-primary" id="saveCommentBtn">送出</button>
          </div>
        </div>
      </div>
    </div>

    <nav id="side-menu" aria-hidden="true" role="navigation" aria-label="功能選單">
      <button id="close-btn" aria-label="關閉功能選單">×</button>
      <h2>功能選單</h2>
      <div id="menu-content">
        <!-- 選單內容將根據用戶角色動態生成 -->
      </div>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>

      let allResumes = [];
      let currentResumeId = null;
      let currentPreferenceId = null; // 儲存當前的 preference_id（用於廠商審核）
      let currentPage = 1;
      const rowsPerPage = 10;
      let userRole = null; // 儲存用戶角色
      let isHomeroom = false; // 儲存是否為班導師

      // ------------------------------------
      // 狀態轉換函式 (已修正：統一使用 pending 作為待審核狀態)
      // ------------------------------------

      /**
       * 根據履歷狀態返回對應的 Bootstrap 顏色類別。
       * status: 'pending', 'approved', 'rejected'
       */
      function statusColor(status) {
        return {
          'pending': 'info',       // 待審核 (藍色)
          'approved': 'success',     // 通過 (綠色)
          'rejected': 'danger',      // 退件 (紅色)
          // 兼容舊狀態
          'submitted': 'info',
          'uploaded': 'info'
        }[status] || 'secondary'; // 未知使用灰色
      }

      /**
       * 將履歷狀態碼轉換為中文顯示名稱。
       * status: 'pending', 'approved', 'rejected'
       */
      function mapStatus(status) {
        return {
          'pending': '待審核',      // 廠商視角：待審核
          'approved': '通過',
          'rejected': '退件',
          // 兼容舊狀態
          'submitted': '待審核',
          'uploaded': '待審核'
        }[status] || '未知';
      }

      // ------------------------------------
      // DOMContentLoaded 載入與事件綁定
      // ------------------------------------

      let currentUserId = null; // 儲存當前用戶 ID

      document.addEventListener("DOMContentLoaded", () => {
        // 先顯示預設選單（老師選單），等獲取到用戶角色後再更新
        userRole = 'teacher'; // 預設為老師
        isHomeroom = false; // 預設不是班導師
        renderMenu();
        
        // 先獲取用戶角色，根據角色調用不同的 API
        fetch('/api/profile')
          .then(res => res.json())
          .then(profileData => {
            userRole = profileData.success && profileData.user ? profileData.user.role : null;
            currentUserId = profileData.success && profileData.user ? profileData.user.id : null;
            isHomeroom = profileData.success && profileData.user ? (profileData.user.is_homeroom === true) : false;
            
            // 根據角色生成選單
            renderMenu();
            
            let apiUrl;
            let companyApiUrl = '/api/get_reviewed_companies';
            
            // 根據角色選擇不同的 API
            if (userRole === 'vendor') {
              // 廠商：調用廠商專用的履歷 API
              apiUrl = '/vendor/api/resumes';
            } else {
              // 老師/其他角色：使用原有的 API
              const urlParams = new URLSearchParams(window.location.search);
              const mode = urlParams.get('mode');
              const companyId = urlParams.get('company_id');
              // 構建 API URL，包含 mode 和 company_id 參數
              const params = [];
              if (mode) params.push(`mode=${encodeURIComponent(mode)}`);
              if (companyId) params.push(`company_id=${encodeURIComponent(companyId)}`);
              apiUrl = params.length > 0 
                ? `/api/get_class_resumes?${params.join('&')}` 
                : `/api/get_class_resumes`;
            }
            
            // 檢查是否有 company_id 參數，如果有則獲取該公司的職缺
            const urlParamsForJobs = new URLSearchParams(window.location.search);
            const companyIdParam = urlParamsForJobs.get('company_id');
            
            // 載入履歷資料
            Promise.all([
              fetch(apiUrl).then(async res => {
                if (!res.ok) {
                  const errorText = await res.text();
                  let errorMessage = "伺服器錯誤";
                  try {
                    const errorJson = JSON.parse(errorText);
                    errorMessage = errorJson.message || errorMessage;
                  } catch (e) {
                    errorMessage = `HTTP ${res.status}: ${errorText.substring(0, 100)}`;
                  }
                  return {success: false, message: errorMessage};
                }
                return res.json();
              }),
              userRole === 'vendor' ? Promise.resolve({success: true, companies: []}) : fetch(companyApiUrl).then(async res => {
                if (!res.ok) {
                  return {success: true, companies: []};
                }
                return res.json();
              }),
              // 如果有 company_id 參數，獲取該公司的職缺；否則使用原有邏輯
              userRole === 'vendor' ? fetch('/vendor/api/positions').then(async res => {
                if (!res.ok) {
                  return {success: true, items: []};
                }
                return res.json();
              }) : (companyIdParam ? fetch(`/api/public/company/${companyIdParam}`).then(async res => {
                if (!res.ok) {
                  return {success: true, items: []};
                }
                const result = await res.json();
                // 將職缺資料轉換為與 vendor API 相同的格式
                if (result.success && result.jobs) {
                  return {
                    success: true,
                    items: result.jobs.map(job => ({
                      id: job.id,
                      title: job.title
                    }))
                  };
                }
                return {success: true, items: []};
              }) : Promise.resolve({success: true, items: []}))
            ])
              .then(([resumeData, companyData, positionData]) => {
                if (resumeData.success) {
                  allResumes = resumeData.resumes || [];
                  
                  // 如果是廠商，處理狀態：確保未審核的履歷顯示為「待審核」
                  if (userRole === 'vendor') {
                    // 更新表格標題為「廠商留言」
                    const commentHeader = document.getElementById('commentHeader');
                    if (commentHeader) {
                      commentHeader.textContent = '廠商留言';
                    }
                    
                    allResumes = allResumes.map(resume => {
                      // 對於廠商來說，如果 preference_id 存在（表示有志願序），需要檢查狀態
                      if (resume.preference_id) {
                        // 如果狀態是 'approved'，檢查是否有審核標記
                        // 如果沒有 reviewed_at 且沒有 comment（廠商審核備註），視為未審核
                        if (resume.status === 'approved') {
                          const hasVendorReview = resume.reviewed_at || resume.comment;
                          if (!hasVendorReview) {
                            console.log(`⚠️ 履歷 ${resume.id} (學生: ${resume.name}) 狀態為 'approved' 但沒有廠商審核標記，強制改為 'pending'`);
                            resume.status = 'pending';
                          }
                        }
                        // 如果狀態不是 'approved' 或 'rejected'，確保是 'pending'
                        if (resume.status !== 'approved' && resume.status !== 'rejected') {
                          resume.status = 'pending';
                        }
                      } else {
                        // 如果沒有 preference_id，狀態應該是 'pending'（待審核）
                        resume.status = 'pending';
                      }
                      // 確保狀態有效，無效狀態改為 'pending'
                      if (!resume.status || !['pending', 'approved', 'rejected'].includes(resume.status)) {
                        resume.status = 'pending';
                      }
                      // 廠商角色時，comment 已經是廠商留言（從後端 API 返回）
                      return resume;
                    });
                  }
                  
                  // 如果是廠商，從 API 返回的 companies 中獲取公司列表
                  if (userRole === 'vendor' && resumeData.companies) {
                    companyData = {success: true, companies: resumeData.companies};
                  }
                  
                  // 如果是指導老師，過濾出他們管理的公司
                  if ((userRole === 'teacher' || userRole === 'class_teacher') && companyData && companyData.success && companyData.companies && currentUserId) {
                    companyData.companies = companyData.companies.filter(company => {
                      // 檢查 advisor_user_id 是否匹配當前指導老師
                      return company.advisor_user_id === currentUserId;
                    });
                  }
                  
                  populateFilters(allResumes, companyData, positionData);
                  // 從 URL 參數讀取狀態並設置篩選器
                  const urlParams = new URLSearchParams(window.location.search);
                  const statusParam = urlParams.get('status');
                  const companyIdParam = urlParams.get('company_id');
                  
                  // 如果有 company_id 參數，需要根據廠商的審核狀態來更新履歷狀態
                  if (companyIdParam) {
                    // 更新表格標題為「廠商留言」
                    const commentHeader = document.getElementById('commentHeader');
                    if (commentHeader) {
                      commentHeader.textContent = '廠商留言';
                    }
                    
                    // 獲取廠商已審核的學生列表
                    fetch(`/api/public/company/${companyIdParam}/vendor-reviewed-students`)
                      .then(res => res.json())
                      .then(vendorResult => {
                        // 建立廠商審核狀態和留言映射
                        const vendorReviewStatusMap = new Map();
                        const vendorCommentMap = new Map();
                        if (vendorResult.success && vendorResult.students) {
                          vendorResult.students.forEach(s => {
                            vendorReviewStatusMap.set(s.student_id, s.vendor_review_status);
                            if (s.vendor_comment) {
                              vendorCommentMap.set(s.student_id, s.vendor_comment);
                            }
                          });
                        }
                        
                        // 更新履歷的顯示狀態為廠商審核狀態
                        // 只保留指導老師已通過的履歷（只有這些會送到廠商）
                        allResumes = allResumes.filter(r => {
                          // 只顯示指導老師已通過的履歷
                          if (r.status !== 'approved') {
                            return false; // 過濾掉指導老師還沒通過的履歷
                          }
                          
                          const studentId = r.user_id || r.student_id;
                          const vendorStatus = vendorReviewStatusMap.get(studentId);
                          const vendorComment = vendorCommentMap.get(studentId);
                          
                          // 設置廠商留言
                          if (vendorComment) {
                            r.vendor_comment = vendorComment;
                            r.comment = vendorComment; // 用於顯示
                          } else {
                            r.vendor_comment = null;
                            r.comment = null; // 清除老師留言，因為這裡顯示的是廠商留言
                          }
                          
                          if (vendorStatus) {
                            // 如果廠商已審核，使用廠商的審核狀態
                            r.vendor_review_status = vendorStatus;
                            r.display_status = vendorStatus; // 用於顯示的狀態
                          } else {
                            // 如果廠商尚未審核，但指導老師已通過，則為「待審核」
                            r.vendor_review_status = 'pending';
                            r.display_status = 'pending';
                          }
                          
                          return true; // 保留此履歷
                        });
                        
                        // 設置狀態篩選器
                        if (statusParam) {
                          const statusFilter = document.getElementById('statusFilter');
                          if (statusFilter) {
                            // 將 submitted/uploaded 映射到 pending（待廠商審核）
                            const mappedStatus = (statusParam === 'submitted' || statusParam === 'uploaded') ? 'pending' : statusParam;
                            statusFilter.value = mappedStatus;
                          }
                        }
                        applyFilters();
                      })
                      .catch(err => {
                        console.error('獲取廠商審核結果失敗:', err);
                        // 如果獲取失敗，使用原有邏輯
                        if (statusParam) {
                          const statusFilter = document.getElementById('statusFilter');
                          if (statusFilter) {
                            const mappedStatus = (statusParam === 'submitted' || statusParam === 'uploaded') ? 'pending' : statusParam;
                            statusFilter.value = mappedStatus;
                          }
                        }
                        applyFilters();
                      });
                  } else if (userRole === 'vendor') {
                    // 如果是廠商角色，也顯示「廠商留言」
                    const commentHeader = document.getElementById('commentHeader');
                    if (commentHeader) {
                      commentHeader.textContent = '廠商留言';
                    }
                    // 沒有 company_id 參數，使用原有邏輯
                    if (statusParam) {
                      const statusFilter = document.getElementById('statusFilter');
                      if (statusFilter) {
                        const mappedStatus = (statusParam === 'submitted' || statusParam === 'uploaded') ? 'pending' : statusParam;
                        statusFilter.value = mappedStatus;
                      }
                    }
                    applyFilters();
                  }
                } else {
                  alert("載入資料失敗：" + (resumeData.message || "未知錯誤"));
                }
              })
              .catch(error => {
                console.error("API調用錯誤:", error);
                alert("載入資料失敗，請檢查網路連線");
              });
          })
          .catch(error => {
            console.error("獲取用戶資料失敗:", error);
            // 如果獲取用戶資料失敗，預設為老師角色並生成選單
            userRole = 'teacher';
            isHomeroom = false;
            renderMenu();
            // 如果獲取用戶資料失敗，使用預設 API
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const apiUrl = mode ? `/api/get_class_resumes?mode=${encodeURIComponent(mode)}` : `/api/get_class_resumes`;
            
            Promise.all([
              fetch(apiUrl).then(res => res.json()),
              fetch('/api/get_reviewed_companies').then(res => res.json()),
              Promise.resolve({success: true, items: []}) // 備用方案：空的職缺資料
            ])
              .then(([resumeData, companyData, positionData]) => {
                if (resumeData.success) {
                  allResumes = resumeData.resumes;
                  populateFilters(allResumes, companyData, positionData);
                  // 從 URL 參數讀取狀態並設置篩選器
                  const urlParams = new URLSearchParams(window.location.search);
                  const statusParam = urlParams.get('status');
                  if (statusParam) {
                    const statusFilter = document.getElementById('statusFilter');
                    if (statusFilter) {
                      const mappedStatus = (statusParam === 'submitted' || statusParam === 'uploaded') ? 'pending' : statusParam;
                      statusFilter.value = mappedStatus;
                    }
                  }
                  applyFilters();
                } else {
                  alert("載入資料失敗：" + (resumeData.message || "未知錯誤"));
                }
              })
              .catch(err => {
                console.error("API調用錯誤:", err);
                alert("載入資料失敗，請檢查網路連線");
              });
          });

        // 綁定篩選事件
        document.getElementById("departmentFilter").addEventListener("change", applyFilters);
        document.getElementById("classFilter").addEventListener("change", applyFilters);
        document.getElementById("companyFilter").addEventListener("change", applyFilters);
        document.getElementById("statusFilter").addEventListener("change", applyFilters);
        document.getElementById("searchBox").addEventListener("input", applyFilters);
        document.getElementById("saveCommentBtn").addEventListener("click", saveComment); // 綁定 "儲存留言"
      });

      // 判斷是否為班導，顯示切換到班導主頁 (此段保留用戶原邏輯)
      fetch('/api/profile').then(r => r.json()).then(d => {
        if (d.success && d.user && d.user.is_homeroom) {
          const link = document.getElementById('toHomeroomLink');
          if (link) link.style.display = 'block';
        }
      }).catch(() => { });

      // ------------------------------------
      // 篩選與渲染函式
      // ------------------------------------

      function populateFilters(data, companyData, positionData) {
        const classSet = new Set();

        data.forEach(r => {
          if (r.className) classSet.add(r.className);
        });
        
        classSet.add("忠班");
        classSet.add("孝班");

        const deptSelect = document.getElementById("departmentFilter");
        const classSelect = document.getElementById("classFilter");
        const companySelect = document.getElementById("companyFilter");

        // 固定顯示 1132 和 1142 作為學年選項
        deptSelect.innerHTML = `<option value="">所有學年</option>`;
        const semesters = ['1132', '1142'];
        semesters.forEach(semester => {
          const option = document.createElement("option");
          option.value = semester;
          option.textContent = semester;
          deptSelect.appendChild(option);
        });

        classSelect.innerHTML = `<option value="">所有班級</option>`;
        companySelect.innerHTML = `<option value="">所有職缺</option>`;

        Array.from(classSet).sort().forEach(c => {
          const option = document.createElement("option");
          option.value = c;
          option.textContent = c;
          classSelect.appendChild(option);
        });

        // 填充職缺篩選器
        let hasJobs = false;
        
        // 從職缺 API 獲取職缺列表（如果是廠商）
        if (positionData && positionData.success && positionData.items && Array.isArray(positionData.items) && positionData.items.length > 0) {
          console.log("從職缺 API 填充，數量:", positionData.items.length);
          positionData.items.forEach(job => {
            if (job.title && job.title.trim()) {
              const option = document.createElement("option");
              option.value = job.id;
              option.textContent = job.title;
              companySelect.appendChild(option);
              hasJobs = true;
            }
          });
        }
        
        // 備用方案：從履歷資料中提取職缺資訊
        if (!hasJobs && data.length > 0) {
          console.log("從履歷資料中提取職缺名稱");
          const jobSet = new Set();
          data.forEach(r => {
            const jobTitle = r.job_title || r.jobTitle;
            if (jobTitle && jobTitle.trim()) {
              jobSet.add(jobTitle.trim());
            }
          });
          
          if (jobSet.size > 0) {
            console.log("從履歷中找到的職缺:", Array.from(jobSet));
            Array.from(jobSet).sort().forEach(jobTitle => {
              const option = document.createElement("option");
              option.value = jobTitle;
              option.textContent = jobTitle;
              companySelect.appendChild(option);
              hasJobs = true;
            });
          }
        }
        
        // 如果還是沒有職缺，顯示提示
        if (!hasJobs) {
          console.warn("⚠️ 沒有找到職缺資料");
          console.warn("可能的原因：");
          console.warn("1. 尚未建立任何職缺");
          console.warn("2. 沒有學生填寫志願序");
          console.warn("3. 履歷資料中沒有職缺資訊");
          
          // 在控制台顯示更多調試信息
          if (data.length > 0) {
            console.log("履歷範例:", data[0]);
          } else {
            console.warn("⚠️ 也沒有找到任何履歷資料");
          }
        }
      }

      function applyFilters() {
        currentPage = 1;
        const dept = document.getElementById("departmentFilter").value.trim();
        const cls = document.getElementById("classFilter").value.trim();
        const jobFilter = document.getElementById("companyFilter").value.trim(); // 使用職缺篩選
        const status = document.getElementById("statusFilter").value.trim();
        const keyword = document.getElementById("searchBox").value.trim().toLowerCase();

        const filtered = allResumes.filter(r => {
          const matchesDept = !dept || r.department === dept;
          const matchesClass = !cls || r.className === cls;
          
          // 職缺篩選：根據職缺 ID 或職缺名稱匹配
          let matchJob = true;
          if (jobFilter) {
            const jobTitle = r.job_title || r.jobTitle || '';
            const jobId = r.job_id || r.jobId;
            // 如果篩選值是數字，則匹配 job_id；否則匹配 job_title
            const filterIsNumeric = /^\d+$/.test(jobFilter);
            if (filterIsNumeric) {
              matchJob = jobId && String(jobId) === jobFilter;
            } else {
              matchJob = jobTitle && jobTitle.trim() === jobFilter.trim();
            }
          }
          
          // 狀態匹配：如果有 company_id，使用廠商審核狀態；否則使用履歷狀態
          let matchesStatus = true;
          if (status) {
            // 如果有 company_id 參數，使用廠商的審核狀態（display_status）
            const urlParams = new URLSearchParams(window.location.search);
            const companyIdParam = urlParams.get('company_id');
            if (companyIdParam && r.display_status !== undefined) {
              matchesStatus = r.display_status === status;
            } else {
              // 沒有 company_id 或沒有 display_status，使用原有邏輯
              matchesStatus = r.status === status;
            }
          }
          
          const matchesKeyword =
            (r.username && r.username.toLowerCase().includes(keyword)) ||
            (r.original_filename && r.original_filename.toLowerCase().includes(keyword));

          return matchesDept && matchesClass && matchJob && matchesStatus && matchesKeyword;
        });

        renderTable(filtered);
      }

      function renderTable(resumes) {
        const tbody = document.getElementById("resumeTableBody");
        tbody.innerHTML = "";

        if (resumes.length === 0) {
          tbody.innerHTML = `<tr><td colspan="9" style="padding: 14px 16px; text-align: center; color: #64748b;">目前沒有資料</td></tr>`;
          document.getElementById("pagination").innerHTML = "";
          return;
        }

        // 檢查是否有 company_id 參數，如果有則隱藏操作按鈕（僅供查看）
        const urlParams = new URLSearchParams(window.location.search);
        const companyIdParam = urlParams.get('company_id');
        const isViewOnly = !!companyIdParam; // 如果有 company_id，則為僅查看模式

        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageData = resumes.slice(start, end);

        pageData.forEach(r => {
          const preferenceId = r.preference_id || null;
          const companyName = r.company_name || '';
          const jobTitle = r.job_title || r.jobTitle || '';
          
          // 處理公司名稱：如果包含多個公司（用 | 分隔），則顯示為列表
          let companyDisplay = '';
          if (companyName) {
            const companies = companyName.split(' | ').filter(c => c.trim());
            if (companies.length > 1) {
              // 多個公司，顯示為列表
              companyDisplay = `<div style="text-align: left;">
                ${companies.map((comp, idx) => 
                  `<div style="margin-bottom: 6px; font-size: 0.9rem; line-height: 1.4;">
                    <strong style="color: #0066cc;">${idx + 1}.</strong> ${escapeHtml(comp)}
                  </div>`
                ).join('')}
              </div>`;
            } else if (companies.length === 1) {
              // 單一公司
              companyDisplay = escapeHtml(companies[0]);
            } else {
              companyDisplay = '<span style="color: #64748b;">—</span>';
            }
          } else {
            companyDisplay = '<span style="color: #64748b;">—</span>';
          }
          
          // 處理職缺：格式為 公司名稱 - 職缺名稱 | 公司名稱 - 職缺名稱
          let jobDisplay = '';
          if (jobTitle) {
            const jobs = jobTitle.split(' | ').filter(j => j.trim());
            if (jobs.length > 1) {
              // 多個職缺，顯示為列表
              jobDisplay = `<div style="text-align: left;">
                ${jobs.map((job, idx) => {
                  // 解析格式：公司名稱 - 職缺名稱
                  const parts = job.split(' - ');
                  const jobName = parts.length > 1 ? parts[1] : job;
                  return `<div style="margin-bottom: 6px; font-size: 0.9rem; line-height: 1.4;">
                    <strong style="color: #16a34a;">${idx + 1}.</strong> ${escapeHtml(jobName)}
                  </div>`;
                }).join('')}
              </div>`;
            } else if (jobs.length === 1) {
              // 單一職缺，提取職缺名稱
              const parts = jobs[0].split(' - ');
              const jobName = parts.length > 1 ? parts[1] : jobs[0];
              jobDisplay = escapeHtml(jobName);
            } else {
              jobDisplay = '<span style="color: #64748b;">—</span>';
            }
          } else {
            jobDisplay = '<span style="color: #64748b;">—</span>';
          }
          
          const row = `
        <tr style="border-bottom: 1px solid #e2e8f0;">
          <td style="padding: 14px 16px; vertical-align: middle; white-space: nowrap;">${r.username}</td>
          <td style="padding: 14px 16px; vertical-align: middle; white-space: nowrap;">${escapeHtml(r.name || '')}</td>
          <td style="padding: 14px 16px; vertical-align: middle; white-space: nowrap;">${r.upload_time}</td>
          <td style="padding: 14px 16px; vertical-align: middle; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 300px;">${escapeHtml(r.original_filename)}</td>
          <td style="padding: 14px 16px; vertical-align: top; max-width: 300px;">${companyDisplay}</td>
          <td style="padding: 14px 16px; vertical-align: top; max-width: 300px;">${jobDisplay}</td>
          <td style="padding: 14px 16px; vertical-align: middle; white-space: nowrap;">
            <span class="status-badge bg-${statusColor(r.display_status || r.status)}">${mapStatus(r.display_status || r.status)}</span>
          </td>
          <td style="padding: 14px 16px; vertical-align: middle; white-space: nowrap;">
            ${isViewOnly ? 
              // 僅查看模式：只顯示留言狀態，不可編輯
              `<span style="padding: 6px 12px; border-radius: 6px; border: 1px solid #e2e8f0; background: #f5f5f5; color: ${r.comment ? '#16a34a' : '#64748b'}; font-size: 0.875rem;">
                ${r.comment ? '已填寫' : '未填寫'}
              </span>` :
              // 正常模式：可以編輯留言
              `<button class="btn btn-sm btn-outline-secondary ${r.comment ? 'text-success' : ''}"
                onclick="openCommentModal(${r.id}, '${escapeHtml(r.comment || '')}')"
                style="padding: 6px 12px; border-radius: 6px; border: 1px solid #e2e8f0; background: #fff; cursor: pointer; font-size: 0.875rem;">
                ${r.comment ? '已填寫' : '未填寫'}
              </button>`
            }
          </td>
          <td style="padding: 14px 16px; vertical-align: middle; white-space: nowrap;">
            ${isViewOnly ? 
              // 僅查看模式：只顯示下載按鈕
              `<a href="/api/download_resume/${r.id}" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #0066cc; background: #fff; color: #0066cc; text-decoration: none; font-size: 0.875rem; display: inline-block;" target="_blank">下載</a>` :
              // 正常模式：顯示所有操作按鈕
              `<div style="display: flex; gap: 8px; flex-wrap: nowrap;">
                <a href="/api/download_resume/${r.id}" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #0066cc; background: #fff; color: #0066cc; text-decoration: none; font-size: 0.875rem; display: inline-block;" target="_blank">下載</a>
                <button type="button" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #dc2626; background: #fff; color: #dc2626; cursor: pointer; font-size: 0.875rem;" onclick="rejectResume(${r.id}, ${preferenceId ? preferenceId : 'null'})">退件</button>
                <button type="button" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #16a34a; background: #fff; color: #16a34a; cursor: pointer; font-size: 0.875rem;" onclick="approveResume(${r.id}, ${preferenceId ? preferenceId : 'null'})">完成</button>
              </div>`
            }
          </td>
        </tr>`;
          tbody.innerHTML += row;
        });

        renderPagination(resumes.length);
      }

      function renderPagination(totalItems) {
        const totalPages = Math.ceil(totalItems / rowsPerPage);
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        if (totalPages <= 1) return;

        for (let i = 1; i <= totalPages; i++) {
          const li = document.createElement("li");
          li.className = `page-item ${i === currentPage ? "active" : ""}`;
          li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
          li.addEventListener("click", (e) => {
            e.preventDefault();
            currentPage = i;
            applyFilters();
          });
          pagination.appendChild(li);
        }
      }

      function escapeHtml(text) {
        if (text === null || text === undefined) return '';
        return String(text)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // ------------------------------------
      // 審核操作函式
      // ------------------------------------

      // 這是給老師單純編輯 'comment' 用的，不改變狀態
      function openCommentModal(id, comment) {
        currentResumeId = id;
        document.getElementById("commentInput").value = comment;
        // 確保將 Modal 的標題和按鈕設為 '編輯留言'
        document.getElementById("commentModalLabel").textContent = "編輯留言";
        document.getElementById("saveCommentBtn").textContent = "儲存留言";
        new bootstrap.Modal(document.getElementById("commentModal")).show();
      }

      // 這是給老師單純編輯 'comment' 用的，不改變狀態
      // 如果是廠商退件後填寫原因，則更新志願申請的 comment
      function saveComment() {
        const newVal = document.getElementById("commentInput").value.trim();
        
        // 如果是廠商且有 preference_id，使用志願申請的 comment API
        if (userRole === 'vendor' && currentPreferenceId) {
          fetch(`/vendor/api/applications/${currentPreferenceId}/comment`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ comment: newVal })
          })
            .then(res => res.json())
            .then(data => {
              // 後端返回格式：{"item": detail} 或 {"error": "..."}
              if (data.item) {
                bootstrap.Modal.getInstance(document.getElementById("commentModal")).hide();
                alert("退件原因已更新");
                currentPreferenceId = null; // 清除
                // 重新應用篩選並渲染表格（不重新載入頁面）
                applyFilters();
              } else if (data.error) {
                alert("更新失敗：" + data.error);
              } else {
                alert("更新失敗：未知錯誤");
              }
            })
            .catch(error => {
              console.error("Comment error:", error);
              alert("更新失敗，網路錯誤或 API 錯誤。");
            });
        } else {
          // 老師或其他角色，使用履歷的 comment API
          fetch("/api/update_resume_field", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ resume_id: currentResumeId, field: "comment", value: newVal })
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById("commentModal")).hide();
                alert("留言更新成功");
                location.reload(); // 重新載入以更新表格顯示
              } else {
                alert("留言更新失敗");
              }
            });
        }
      }

      // 處理退件：先嘗試退件API，若成功則強制彈出留言Modal讓老師填寫原因
      function rejectResume(resumeId, preferenceId) {
        if (!confirm("確定要將此履歷標記為退件？退件後，請務必填寫退件原因。")) return;

        // 如果是廠商
        if (userRole === 'vendor') {
          // 如果有 preference_id，使用志願申請的退件 API
          if (preferenceId) {
          fetch(`/vendor/api/applications/${preferenceId}/reject`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ comment: "" }) // 初始呼叫不傳 comment，稍後在 Modal 中填寫
          })
            .then(res => res.json())
            .then(data => {
              // 後端返回格式：{"item": detail} 或 {"error": "..."}
              if (data.item) {
                // 更新本地資料中的狀態
                const resume = allResumes.find(r => r.id === resumeId);
                if (resume) {
                  resume.status = 'rejected';
                }
                
                alert("已成功標記為退件狀態。請填寫退件原因。");

                currentResumeId = resumeId;
                currentPreferenceId = preferenceId; // 儲存 preference_id 用於後續更新 comment
                document.getElementById("commentInput").value = "";

                // 修正 Modal 標題，強調這是退件原因填寫
                document.getElementById("commentModalLabel").textContent = "❌ 填寫退件原因";
                document.getElementById("saveCommentBtn").textContent = "送出";

                // 顯示留言Modal
                new bootstrap.Modal(document.getElementById("commentModal")).show();
              } else if (data.error) {
                alert("退件失敗：" + data.error);
              } else {
                alert("退件失敗：未知錯誤");
              }
            })
            .catch(error => {
              console.error("Reject error:", error);
              alert("退件失敗，網路錯誤或 API 錯誤。");
            });
          } else {
            // 沒有 preference_id，提示用戶
            alert("此學生尚未填寫志願序，無法進行退件。請等待學生填寫志願序後再進行操作。");
          }
        } else {
          // 老師或其他角色，使用履歷審核 API
          fetch(`/api/review_resume/${resumeId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status: "rejected" }) // 初始呼叫不傳 comment
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                alert("已成功標記為退件狀態。請填寫退件原因。");

                currentResumeId = resumeId;
                document.getElementById("commentInput").value = "";

                // 修正 Modal 標題，強調這是退件原因填寫
                document.getElementById("commentModalLabel").textContent = "❌ 填寫退件原因";
                document.getElementById("saveCommentBtn").textContent = "送出";

                // 顯示留言Modal
                new bootstrap.Modal(document.getElementById("commentModal")).show();
              } else {
                alert("退件失敗：" + data.message);
              }
            })
            .catch(error => {
              console.error("Reject error:", error);
              alert("退件失敗，網路錯誤或 API 錯誤。");
            });
        }
      }


      function approveResume(resumeId, preferenceId) {
        if (!confirm("確定要將此履歷標記為審核通過嗎？")) return;
        
        // 如果是廠商
        if (userRole === 'vendor') {
          // 如果有 preference_id，使用志願申請的通過 API
          if (preferenceId) {
            fetch(`/vendor/api/applications/${preferenceId}/approve`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({})
            })
              .then(res => res.json())
              .then(data => {
                // 後端返回格式：{"item": detail} 或 {"error": "..."}
                if (data.item) {
                  // 立即更新本地數據中的狀態，確保界面即時反映變化
                  const resume = allResumes.find(r => r.preference_id === preferenceId);
                  if (resume) {
                    resume.status = 'approved';
                  }
                  
                  // 獲取當前篩選條件
                  const currentStatusFilter = document.getElementById("statusFilter").value.trim();
                  const jobFilter = document.getElementById("companyFilter").value.trim();
                  const keywordFilter = document.getElementById("searchBox").value.trim();
                  
                  // 如果當前篩選的是「待審核」，自動切換到「通過」狀態，讓用戶看到更新後的結果
                  if (currentStatusFilter === 'pending') {
                    document.getElementById("statusFilter").value = 'approved';
                  }
                  
                  // 立即重新渲染表格，讓用戶立即看到狀態變化（從「待審核」變為「通過」）
                  applyFilters();
                  
                  // 在背景重新從 API 獲取最新的履歷列表，確保數據同步
                  const statusFilter = document.getElementById("statusFilter").value.trim();
                  
                  let apiUrl = '/vendor/api/resumes';
                  const params = [];
                  if (statusFilter) {
                    params.push(`status=${encodeURIComponent(statusFilter)}`);
                  }
                  if (jobFilter) {
                    // 從 allResumes 中查找對應的職缺 ID
                    const filterIsNumeric = /^\d+$/.test(jobFilter);
                    const matchingResume = allResumes.find(r => {
                      if (filterIsNumeric) {
                        return r.job_id && String(r.job_id) === jobFilter;
                      } else {
                        return r.job_title && r.job_title.trim() === jobFilter.trim();
                      }
                    });
                    // 注意：這裡保留 company_id 參數以向後兼容，但主要篩選已改為職缺
                    if (matchingResume && matchingResume.company_id) {
                      params.push(`company_id=${matchingResume.company_id}`);
                    }
                  }
                  if (keywordFilter) {
                    params.push(`keyword=${encodeURIComponent(keywordFilter)}`);
                  }
                  if (params.length > 0) {
                    apiUrl += '?' + params.join('&');
                  }
                  
                  // 在背景重新獲取數據，確保與後端同步
                  fetch(apiUrl)
                    .then(res => res.json())
                    .then(resumeData => {
                      if (resumeData.success) {
                        allResumes = resumeData.resumes || [];
                        // 重新應用篩選並渲染表格
                        applyFilters();
                      }
                      // 不顯示額外的提示，因為界面已經更新了
                    })
                    .catch(error => {
                      console.error("Reload error:", error);
                      // 如果重新獲取失敗，使用已更新的本地數據（已經在 applyFilters 中處理）
                    });
                  
                  // 顯示成功提示
                  alert("✅ 履歷已標記為審核通過");
                } else if (data.error) {
                  alert("標記失敗：" + data.error);
                } else {
                  alert("標記失敗：未知錯誤");
                }
              })
              .catch(error => {
                console.error("Approve error:", error);
                alert("通過失敗，網路錯誤或 API 錯誤。");
              });
          } else {
            // 沒有 preference_id，提示用戶
            alert("此學生尚未填寫志願序，無法進行審核。請等待學生填寫志願序後再進行審核。");
          }
        } else {
          // 老師或其他角色，使用履歷審核 API
          fetch(`/api/review_resume/${resumeId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status: "approved" })
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                // 更新本地資料中的狀態
                const resume = allResumes.find(r => r.id === resumeId);
                if (resume) {
                  resume.status = 'approved';
                }
                // 重新應用篩選並渲染表格（不重新載入頁面）
                applyFilters();
                alert("✅ 履歷已標記為審核通過");
              } else {
                alert("標記失敗：" + data.message);
              }
            })
            .catch(error => {
              console.error("Approve error:", error);
              alert("通過失敗，網路錯誤或 API 錯誤。");
            });
        }
      }


      // 根據用戶角色生成選單
      function renderMenu() {
        const menuContent = document.getElementById('menu-content');
        if (!menuContent) return;

        let menuItems = [];
        
        if (userRole === 'vendor') {
          // 廠商選單
          menuItems = [
            { href: '/vendor_home', text: '首頁' },
            { href: '/profile', text: '個人資料' },
            { href: '/vendor/resume-review', text: '學生履歷審核' },
            { href: '/manage_positions', text: '職位需求管理' },
            { href: '/confirm_matching', text: '媒合結果' },
            { href: '/publish_announcements', text: '發布公告' },
            { href: '/reviews_resumes_notifications', text: '查看履歷與通知' },
            { href: '/login', text: '登出' }
          ];
        } else if (isHomeroom && (userRole === 'teacher' || userRole === 'director')) {
          // 班導師選單
          menuItems = [
            { href: '/class_teacher_home', text: '首頁' },
            { href: '/review_resume', text: '查看學生履歷' },
            { href: '/profile', text: '個人資料' },
            { href: '/review_preferences', text: '審核志願序' },
            { href: '/admission/results', text: '查詢學生錄取結果' },
            { href: '/notifications', text: '通知' },
            { href: '/login', text: '登出' }
          ];
        } else if (userRole === 'teacher') {
          // 指導老師選單
          menuItems = [
            { href: '/review_resume', text: '學生履歷審核' },
            { href: '/teacher_home', text: '首頁' },
            { href: '/profile', text: '個人資料' },
            { href: '/upload_company', text: '建立實習機會' },
            { href: '/admission_results', text: '查看錄取結果' },
            { href: '/manage_vendor', text: '實習廠商管理' },
            { href: '/notifications', text: '查看公告' },
            { href: '/login', text: '登出' }
          ];
        } else if (userRole === 'director') {
          // 主任選單（與指導老師相同）
          menuItems = [
            { href: '/review_resume', text: '學生履歷審核' },
            { href: '/teacher_home', text: '首頁' },
            { href: '/profile', text: '個人資料' },
            { href: '/upload_company', text: '建立實習機會' },
            { href: '/admission_results', text: '查看錄取結果' },
            { href: '/manage_vendor', text: '實習廠商管理' },
            { href: '/notifications', text: '查看公告' },
            { href: '/login', text: '登出' }
          ];
        } else {
          // 預設選單（其他角色）
          menuItems = [
            { href: '/teacher_home', text: '首頁' },
            { href: '/profile', text: '個人資料' },
            { href: '/review_resume', text: '學生履歷審核' },
            { href: '/login', text: '登出' }
          ];
        }

        menuContent.innerHTML = menuItems.map(item => 
          `<a href="${item.href}">${item.text}</a>`
        ).join('');
      }

      // 側邊選單控制
      document.getElementById('menu-btn').addEventListener('click', () => {
        document.getElementById('side-menu').classList.add('open');
        document.getElementById('side-menu').setAttribute('aria-hidden', 'false');
      });
      
      document.getElementById('close-btn').addEventListener('click', () => {
        document.getElementById('side-menu').classList.remove('open');
        document.getElementById('side-menu').setAttribute('aria-hidden', 'true');
      });

      // 點擊選單外部關閉選單
      document.addEventListener('click', (e) => {
        const sideMenu = document.getElementById('side-menu');
        const menuBtn = document.getElementById('menu-btn');
        if (sideMenu && menuBtn) {
          if (!sideMenu.contains(e.target) && !menuBtn.contains(e.target) && sideMenu.classList.contains('open')) {
            sideMenu.classList.remove('open');
            sideMenu.setAttribute('aria-hidden', 'true');
          }
        }
      });
    </script>
</body>

</html>