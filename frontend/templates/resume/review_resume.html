<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>智慧實習平台 | 學生履歷審查</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    header {
      background: #0454a3;
      color: white;
      padding: 1rem 2rem;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      position: relative;
    }

    header .header-title {
      flex: 1;
      text-align: center;
    }

    body {
      font-family: "Noto Sans TC", sans-serif;
      background: #f7f9fc;
      margin: 0;
      padding: 0;
    }

    /* 表格樣式 */
    .table thead th {
      text-align: center;
      background-color: #fafafb;
    }

    .table tbody td {
      text-align: center;
      vertical-align: middle;
    }

    .table-striped>tbody>tr:nth-of-type(odd) {
      background-color: rgba(0, 0, 0, 0.02);
    }

    /* 狀態標籤 */
    .status-badge {
      font-size: 0.9em;
      padding: 0.3em 0.6em;
      border-radius: 0.5rem;
      display: inline-block;
      font-weight: 600;
    }

    .status-badge.bg-success {
      color: #fff;
    }

    .status-badge.bg-danger {
      color: #fff;
    }

    .status-badge.bg-info {
      color: #fff;
    }

    .status-badge.bg-secondary {
      color: #fff;
    }

    .status-badge.bg-warning {
      /* 確保黃色 badge 的文字可讀 */
      color: #212529;
    }

    #commentInput {
      width: 100%;
      height: 180px;
      resize: vertical;
      padding: 0.5rem;
      font-size: 1rem;
      line-height: 1.4;
    }

    .card h4.text-center {
      color: #0066cc;
      font-weight: bold;
    }

    /* 選單按鈕樣式 */
    #menu-btn {
      width: 30px;
      height: 22px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      background: none;
      border: none;
      padding: 0;
      margin-left: 100px;
    }

    #menu-btn span {
      display: block;
      width: 100%;
      height: 3px;
      background-color: white;
      border-radius: 2px;
      transition: all 0.3s ease;
    }

    /* 側邊選單樣式 */
    #side-menu {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 320px;
      max-width: 80vw;
      background-color: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(6px);
      box-shadow: 3px 0 12px rgb(0 0 0 / 0.7);
      padding: 2rem 1.5rem;
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
      z-index: 1100;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      color: white;
      user-select: none;
    }

    #side-menu.open {
      transform: translateX(0);
    }

    #close-btn {
      position: absolute;
      top: 2rem;
      right: 1.6rem;
      font-size: 2.2rem;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      line-height: 1;
      width: 2.5rem;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #side-menu h2 {
      width: 100%;
      margin-bottom: 1.5rem;
      font-weight: 700;
      font-size: 1.5rem;
      text-align: left;
    }

    #side-menu a {
      display: block;
      width: 100%;
      padding: 0.6rem 0;
      font-size: 1.1rem;
      color: #ddd;
      text-decoration: none;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }

    #side-menu a:hover {
      background-color: rgba(255, 255, 255, 0.18);
      color: white;
    }
  </style>
</head>

<body>
  <header>
    <div id="menu-btn" title="選單" role="button" tabindex="0">
      <span></span><span></span><span></span>
    </div>
    <div class="header-title">學生履歷審查</div>
  </header>
  <div class="container">

    <div class="container my-5 pt-1">
      <div class="card shadow-sm p-4">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
          <div class="d-flex gap-2 flex-wrap">
            <select id="departmentFilter" class="form-select form-select-sm w-auto">
              <option value="">所有學年</option>
            </select>
            <select id="classFilter" class="form-select form-select-sm w-auto">
              <option value="">所有班級</option>
            </select>
            <select id="companyFilter" class="form-select form-select-sm w-auto">
              <option value="">所有公司</option>
            </select>
            <select id="statusFilter" class="form-select form-select-sm w-auto">
              <option value="">所有狀態</option>
              <option value="submitted">待審查</option>
              <option value="pending">待審核</option>
              <option value="uploaded">未通過</option>
              <option value="approved">通過</option>
              <option value="rejected">退件</option>
            </select>
          </div>
          <input type="text" id="searchBox" class="form-control form-control-sm w-auto" placeholder="搜尋帳號/檔案" />
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th>學生帳號</th>
                <th>姓名</th>
                <th>上傳時間</th>
                <th>檔案名稱</th>
                <th>狀態</th>
                <th>老師留言</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="resumeTableBody">
              <tr>
                <td colspan="7" class="text-muted text-center">載入中...</td>
              </tr>
            </tbody>
          </table>
        </div>

        <nav>
          <ul class="pagination justify-content-center mt-3" id="pagination"></ul>
        </nav>
      </div>
    </div>

    <div class="modal fade" id="commentModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="commentModalLabel">編輯留言</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <textarea id="commentInput"></textarea>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button class="btn btn-primary" id="saveCommentBtn">送出</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 側邊選單 -->
    <nav id="side-menu" aria-hidden="true" role="navigation" aria-label="功能選單">
      <button id="close-btn" aria-label="關閉功能選單">×</button>
      <h2>功能選單</h2>
      <a href="/vendor_home">首頁</a>
      <a href="/profile">個人資料</a>
      <a href="/upload_company">建立實習機會</a>
      <a href="/admission_results">查看錄取結果</a>
      <a href="/manage_vendor">實習廠商管理</a>
      <a href="/notifications">查看公告</a>
      <a href="/review_resume">學生履歷審核</a>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>

      let allResumes = [];
      let currentResumeId = null;
      let currentPage = 1;
      const rowsPerPage = 10;

      // ------------------------------------
      // 狀態轉換函式 (已修正：使用 submitted 和 under_review)
      // ------------------------------------

      /**
       * 根據履歷狀態返回對應的 Bootstrap 顏色類別。
       */
      function statusColor(status) {
        // status: 'submitted', 'under_review', 'approved', 'rejected', 'pending'
        return {
          'submitted': 'info',       // 已提交 (藍色)
          'pending': 'info',         // 待審查 (藍色) - 廠商視角
          'approved': 'success',     // 通過 (綠色)
          'rejected': 'danger',      // 退件 (紅色)
          'uploaded': 'info'         // 保留舊狀態 'uploaded'
        }[status] || 'secondary'; // 未知使用灰色
      }

      /**
       * 將履歷狀態碼轉換為中文顯示名稱。
       */
      function mapStatus(status) {
        // status: 'submitted', 'under_review', 'approved', 'rejected', 'pending'
        return {
          'submitted': '待審查',
          'pending': '待審查',  // 廠商視角：待審查（未知狀態）
          'approved': '通過',
          'rejected': '退件',
          'uploaded': '待審查'
        }[status] || '未知';
      }

      // ------------------------------------
      // DOMContentLoaded 載入與事件綁定
      // ------------------------------------

      document.addEventListener("DOMContentLoaded", () => {
        // 先獲取用戶角色，根據角色調用不同的 API
        fetch('/api/profile')
          .then(res => res.json())
          .then(profileData => {
            const userRole = profileData.success && profileData.user ? profileData.user.role : null;
            
            let apiUrl;
            let companyApiUrl = '/api/get_reviewed_companies';
            
            // 根據角色選擇不同的 API
            if (userRole === 'vendor') {
              // 廠商：調用廠商專用的履歷 API
              apiUrl = '/vendor/api/resumes';
            } else {
              // 老師/其他角色：使用原有的 API
              const urlParams = new URLSearchParams(window.location.search);
              const mode = urlParams.get('mode');
              apiUrl = mode ? `/api/get_class_resumes?mode=${encodeURIComponent(mode)}` : `/api/get_class_resumes`;
            }
            
            // 載入履歷資料
            Promise.all([
              fetch(apiUrl).then(res => res.json()),
              userRole === 'vendor' ? Promise.resolve({success: true, companies: []}) : fetch(companyApiUrl).then(res => res.json())
            ])
              .then(([resumeData, companyData]) => {
                if (resumeData.success) {
                  allResumes = resumeData.resumes || [];
                  
                  // 如果是廠商，從 API 返回的 companies 中獲取公司列表
                  if (userRole === 'vendor' && resumeData.companies) {
                    companyData = {success: true, companies: resumeData.companies};
                  }
                  
                  populateFilters(allResumes, companyData);
                  // 從 URL 參數讀取狀態並設置篩選器
                  const urlParams = new URLSearchParams(window.location.search);
                  const statusParam = urlParams.get('status');
                  if (statusParam) {
                    const statusFilter = document.getElementById('statusFilter');
                    if (statusFilter) {
                      // 將 pending 映射到 submitted 或保持原值
                      const mappedStatus = statusParam === 'pending' ? 'submitted' : statusParam;
                      statusFilter.value = mappedStatus;
                    }
                  }
                  applyFilters();
                } else {
                  alert("載入資料失敗：" + (resumeData.message || "未知錯誤"));
                }
              })
              .catch(error => {
                console.error("API調用錯誤:", error);
                alert("載入資料失敗，請檢查網路連線");
              });
          })
          .catch(error => {
            console.error("獲取用戶資料失敗:", error);
            // 如果獲取用戶資料失敗，使用預設 API
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const apiUrl = mode ? `/api/get_class_resumes?mode=${encodeURIComponent(mode)}` : `/api/get_class_resumes`;
            
            Promise.all([
              fetch(apiUrl).then(res => res.json()),
              fetch('/api/get_reviewed_companies').then(res => res.json())
            ])
              .then(([resumeData, companyData]) => {
                if (resumeData.success) {
                  allResumes = resumeData.resumes;
                  populateFilters(allResumes, companyData);
                  // 從 URL 參數讀取狀態並設置篩選器
                  const urlParams = new URLSearchParams(window.location.search);
                  const statusParam = urlParams.get('status');
                  if (statusParam) {
                    const statusFilter = document.getElementById('statusFilter');
                    if (statusFilter) {
                      // 將 pending 映射到 submitted 或保持原值
                      const mappedStatus = statusParam === 'pending' ? 'submitted' : statusParam;
                      statusFilter.value = mappedStatus;
                    }
                  }
                  applyFilters();
                } else {
                  alert("載入資料失敗：" + (resumeData.message || "未知錯誤"));
                }
              })
              .catch(err => {
                console.error("API調用錯誤:", err);
                alert("載入資料失敗，請檢查網路連線");
              });
          });

        // 綁定篩選事件
        document.getElementById("departmentFilter").addEventListener("change", applyFilters);
        document.getElementById("classFilter").addEventListener("change", applyFilters);
        document.getElementById("companyFilter").addEventListener("change", applyFilters);
        document.getElementById("statusFilter").addEventListener("change", applyFilters);
        document.getElementById("searchBox").addEventListener("input", applyFilters);
        document.getElementById("saveCommentBtn").addEventListener("click", saveComment); // 綁定 "儲存留言"
      });

      // 判斷是否為班導，顯示切換到班導主頁 (此段保留用戶原邏輯)
      fetch('/api/profile').then(r => r.json()).then(d => {
        if (d.success && d.user && d.user.is_homeroom) {
          const link = document.getElementById('toHomeroomLink');
          if (link) link.style.display = 'block';
        }
      }).catch(() => { });

      // ------------------------------------
      // 篩選與渲染函式
      // ------------------------------------

      function populateFilters(data, companyData) {
        const classSet = new Set();

        data.forEach(r => {
          if (r.className) classSet.add(r.className);
        });
        
        classSet.add("忠班");
        classSet.add("孝班");

        const deptSelect = document.getElementById("departmentFilter");
        const classSelect = document.getElementById("classFilter");
        const companySelect = document.getElementById("companyFilter");

        // 固定顯示 1132 和 1142 作為學年選項
        deptSelect.innerHTML = `<option value="">所有學年</option>`;
        const semesters = ['1132', '1142'];
        semesters.forEach(semester => {
          const option = document.createElement("option");
          option.value = semester;
          option.textContent = semester;
          deptSelect.appendChild(option);
        });

        classSelect.innerHTML = `<option value="">所有班級</option>`;
        companySelect.innerHTML = `<option value="">所有公司</option>`;

        Array.from(classSet).sort().forEach(c => {
          const option = document.createElement("option");
          option.value = c;
          option.textContent = c;
          classSelect.appendChild(option);
        });

        // 從 API 獲取的開放公司列表中，只顯示當前學期開放的公司
        if (companyData && companyData.success && companyData.companies) {
          // 處理兩種格式：老師的格式（有 is_open_current_semester）和廠商的格式（只有 id 和 name）
          const openCompanies = companyData.companies.filter(company => {
            // 如果是廠商格式（有 name 屬性），直接顯示
            if (company.name) {
              return true;
            }
            // 如果是老師格式（有 company_name 和 is_open_current_semester），需要檢查是否開放
            return company.is_open_current_semester === true || company.is_open_current_semester === 1;
          });
          
          openCompanies.forEach(company => {
            const option = document.createElement("option");
            // 處理兩種格式的公司名稱
            const companyName = company.name || company.company_name;
            option.value = companyName;
            option.textContent = companyName;
            companySelect.appendChild(option);
          });
        }
      }

      function applyFilters() {
        currentPage = 1;
        const dept = document.getElementById("departmentFilter").value.trim();
        const cls = document.getElementById("classFilter").value.trim();
        const company = document.getElementById("companyFilter").value.trim();
        const status = document.getElementById("statusFilter").value.trim();
        const keyword = document.getElementById("searchBox").value.trim().toLowerCase();

        const filtered = allResumes.filter(r => {
          const matchesDept = !dept || r.department === dept;
          const matchesClass = !cls || r.className === cls;
          const matchesCompany = !company || r.company_name === company;
          // 狀態匹配：支持 pending 映射到 submitted 或 uploaded
          let matchesStatus = true;
          if (status) {
            if (status === 'submitted') {
              // submitted 狀態匹配 submitted、pending 或 uploaded
              matchesStatus = r.status === 'submitted' || r.status === 'pending' || r.status === 'uploaded';
            } else {
              matchesStatus = r.status === status;
            }
          }
          const matchesKeyword =
            (r.username && r.username.toLowerCase().includes(keyword)) ||
            (r.original_filename && r.original_filename.toLowerCase().includes(keyword));

          return matchesDept && matchesClass && matchesCompany && matchesStatus && matchesKeyword;
        });

        renderTable(filtered);
      }

      function renderTable(resumes) {
        const tbody = document.getElementById("resumeTableBody");
        tbody.innerHTML = "";

        if (resumes.length === 0) {
          tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">目前沒有資料</td></tr>`;
          document.getElementById("pagination").innerHTML = "";
          return;
        }

        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageData = resumes.slice(start, end);

        pageData.forEach(r => {
          const row = `
        <tr>
          <td>${r.username}</td>
          <td>${escapeHtml(r.name || '')}</td>
          <td>${r.upload_time}</td>
          <td>${escapeHtml(r.original_filename)}</td>
          <td><span class="status-badge bg-${statusColor(r.status)}">${mapStatus(r.status)}</span></td>
          <td>
            <button class="btn btn-sm btn-outline-secondary ${r.comment ? 'text-success' : ''}"
              onclick="openCommentModal(${r.id}, '${escapeHtml(r.comment || '')}')">
              ${r.comment ? '已填寫' : '未填寫'}
            </button>
          </td>
          <td>
            <div class="btn-group btn-group-sm">
         <a href="/api/download_resume/${r.id}" class="btn btn-outline-primary btn-sm me-1" target="_blank">下載</a>
         <button type="button" class="btn btn-outline-danger" onclick="rejectResume(${r.id})">退件</button>
         <button type="button" class="btn btn-outline-success" onclick="approveResume(${r.id})">完成</button>

          </td>
        </tr>`;
          tbody.innerHTML += row;
        });

        renderPagination(resumes.length);
      }

      function renderPagination(totalItems) {
        const totalPages = Math.ceil(totalItems / rowsPerPage);
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        if (totalPages <= 1) return;

        for (let i = 1; i <= totalPages; i++) {
          const li = document.createElement("li");
          li.className = `page-item ${i === currentPage ? "active" : ""}`;
          li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
          li.addEventListener("click", (e) => {
            e.preventDefault();
            currentPage = i;
            applyFilters();
          });
          pagination.appendChild(li);
        }
      }

      function escapeHtml(text) {
        if (text === null || text === undefined) return '';
        return String(text)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // ------------------------------------
      // 審核操作函式
      // ------------------------------------

      // 這是給老師單純編輯 'comment' 用的，不改變狀態
      function openCommentModal(id, comment) {
        currentResumeId = id;
        document.getElementById("commentInput").value = comment;
        // 確保將 Modal 的標題和按鈕設為 '編輯留言'
        document.getElementById("commentModalLabel").textContent = "編輯留言";
        document.getElementById("saveCommentBtn").textContent = "儲存留言";
        new bootstrap.Modal(document.getElementById("commentModal")).show();
      }

      // 這是給老師單純編輯 'comment' 用的，不改變狀態
      function saveComment() {
        const newVal = document.getElementById("commentInput").value.trim();
        fetch("/api/update_resume_field", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ resume_id: currentResumeId, field: "comment", value: newVal })
        })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              bootstrap.Modal.getInstance(document.getElementById("commentModal")).hide();
              alert("留言更新成功");
              location.reload(); // 重新載入以更新表格顯示
            } else {
              alert("留言更新失敗");
            }
          });
      }

      // 處理退件：先嘗試退件API，若成功則強制彈出留言Modal讓老師填寫原因
      function rejectResume(resumeId) {
        if (!confirm("確定要將此履歷標記為退件？退件後，請務必填寫退件原因。")) return;

        // 注意：根據後端邏輯，/api/review_resume/<id> 預期 body 包含 status 和 comment
        // 我們先呼叫 API，但不傳 comment
        fetch(`/api/review_resume/${resumeId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status: "rejected" }) // 初始呼叫不傳 comment
        })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              alert("已成功標記為退件狀態。請填寫退件原因。");

              currentResumeId = resumeId;
              document.getElementById("commentInput").value = "";

              // 修正 Modal 標題，強調這是退件原因填寫
              document.getElementById("commentModalLabel").textContent = "❌ 填寫退件原因";
              document.getElementById("saveCommentBtn").textContent = "送出";

              // 顯示留言Modal
              new bootstrap.Modal(document.getElementById("commentModal")).show();
            } else {
              alert("退件失敗：" + data.message);
            }
          })
          .catch(error => {
            console.error("Reject error:", error);
            alert("退件失敗，網路錯誤或 API 錯誤。");
          });
      }


      function approveResume(resumeId) {
        if (!confirm("確定要將此履歷標記為審核通過嗎？")) return;
        fetch(`/api/review_resume/${resumeId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status: "approved" })
        })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              alert("✅ 履歷已標記為審核通過");
              location.reload();
            } else {
              alert("標記失敗：" + data.message);
            }
          })
          .catch(error => {
            console.error("Approve error:", error);
            alert("通過失敗，網路錯誤或 API 錯誤。");
          });
      }


      // 側邊選單控制
      document.getElementById('menu-btn').addEventListener('click', () => {
        document.getElementById('side-menu').classList.add('open');
      });
      document.getElementById('close-btn').addEventListener('click', () => {
        document.getElementById('side-menu').classList.remove('open');
      });
    </script>
</body>

</html>