<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ™ºæ…§å¯¦ç¿’å¹³å° | å…¬å¸å±¥æ­·å¯©æŸ¥</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    header {
      background: linear-gradient(135deg, #0055a8 0%, #006acb 50%, #004f94 100%);
      border-bottom: none; position: sticky; top: 0; z-index: 10;
      box-shadow: 0 8px 20px rgba(0, 68, 148, 0.35);
    }
    .topbar {
      max-width: 1800px; margin: 0 auto; padding: 18px 24px;
      display: flex; align-items: center; justify-content: space-between; color: #fff;
    }
    .topbar-left { display: flex; align-items: center; }
    .topbar-left #menu-btn {
      width: 30px; height: 22px; cursor: pointer; display: flex; flex-direction: column;
      justify-content: space-between; background: none; border: none; padding: 0;
    }
    .topbar-left #menu-btn span {
      display: block; width: 100%; height: 3px; background-color: white; border-radius: 2px; transition: all 0.3s ease;
    }
    .topbar h1 { font-size: 1.5rem; margin: 0; text-align: center; color: #fff; flex: 1; }
    body { font-family: "Noto Sans TC", sans-serif; background: #ffffff; margin: 0; padding: 0; }
    main { max-width: 1800px; margin: 24px auto 60px; padding: 0 24px; display: flex; flex-direction: column; gap: 24px; }
    .panel {
      background: #ffffff; border-radius: 16px; padding: 24px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08); border: 1px solid #e2e8f0; margin-bottom: 32px;
    }
    .panel-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 16px; }
    .panel-header h2 { font-size: 1.2rem; margin: 0; }
    .table-wrapper { overflow-x: visible; width: 100%; }
    .table-wrapper table tbody tr:hover { background: rgba(15, 23, 42, 0.02); }
    .table thead th { text-align: left; background-color: #fafafb; }
    .table tbody td { text-align: left; vertical-align: middle; }
    .table tbody tr td:nth-child(1), .table tbody tr td:nth-child(2), 
    .table tbody tr td:nth-child(3), .table tbody tr td:nth-child(4) { vertical-align: top; }
    
    /* --- ç‹€æ…‹æ¨™ç±¤æ¨£å¼è¨­å®š --- */
    .status-badge { font-size: 0.9em; padding: 0.3em 0.6em; border-radius: 0.5rem; display: inline-block; font-weight: 600; }
    
    /* é€šéï¼šç¶ åº•ç™½å­— */
    .status-badge.bg-success { color: #fff; background-color: #198754; }
    
    /* é€€ä»¶ï¼šç´…åº•ç™½å­— */
    .status-badge.bg-danger { color: #fff; background-color: #dc3545; }
    
    /* å¾…å¯©æ ¸ï¼šè—åº•ç™½å­— */
    .status-badge.bg-info { color: #fff; background-color: #0dcaf0; }
    
    .status-badge.bg-secondary { color: #fff; background-color: #6c757d; }
    
    /* é¢è©¦ä¸­ï¼šä¸­æ©™è‰²åº•ç™½å­— */
    .status-badge.bg-interviewing { color: #fff; background-color: #ff8c42; }
    
    /* å·²é¢è©¦ï¼šä¸­è—è‰²åº•ç™½å­— */
    .status-badge.bg-completed { color: #fff; background-color: #4a9eff; }
    
    #commentInput { width: 100%; height: 180px; resize: vertical; padding: 0.5rem; font-size: 1rem; line-height: 1.4; }
    
    /* å­¸ç”Ÿé¸å–®æ¨£å¼ */
    #interviewStudents {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
    }
    .student-checkbox-item {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .student-checkbox-item:hover {
      background-color: #f0f9ff;
    }
    .student-checkbox-item input[type="checkbox"] {
      margin-right: 10px;
      cursor: pointer;
      width: 18px;
      height: 18px;
    }
    .student-checkbox-item label {
      margin: 0;
      cursor: pointer;
      flex: 1;
      user-select: none;
    }
    
    /* æ¨¡æ…‹æ¡†èƒŒæ™¯é®ç½©æ¨£å¼ - ç°é»‘è‰² */
    .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.6) !important;
      opacity: 1 !important;
    }
    
    .modal-backdrop.show {
      opacity: 1 !important;
      background-color: rgba(0, 0, 0, 0.6) !important;
    }
    
    /* ç¢ºä¿æ¨¡æ…‹æ¡†é¡¯ç¤ºæ™‚èƒŒæ™¯è®Šæš— */
    body.modal-open {
      overflow: hidden;
    }
    
    /* ç•¶é¢è©¦è¡¨å–®æ¨¡æ…‹æ¡†æ‰“é–‹æ™‚ï¼Œç¢ºä¿èƒŒæ™¯é®ç½©æ­£ç¢ºé¡¯ç¤º */
    #interviewFormModal.show ~ .modal-backdrop,
    #interviewFormModal.show + .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.6) !important;
      opacity: 1 !important;
    }
    
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: #ffffff;
      background-color: rgba(255, 255, 255, 0.2);
      padding: 8px 16px;
      border-radius: 8px;
      text-decoration: none;
      transition: background-color 0.2s ease;
      border: 1px solid rgba(255, 255, 255, 0.3);
      font-size: 0.9rem;
    }
    .back-link:hover {
      background-color: rgba(255, 255, 255, 0.3);
      color: #ffffff;
    }
    
    #side-menu {
      position: fixed; top: 0; left: 0; height: 100vh; width: 320px; max-width: 80vw;
      background-color: rgba(10, 10, 10, 0.95); backdrop-filter: blur(6px);
      box-shadow: 3px 0 12px rgba(0, 0, 0, 0.6); padding: 2rem 1.5rem;
      transform: translateX(-100%); transition: transform 0.3s ease-in-out; z-index: 1300;
      display: flex; flex-direction: column; align-items: flex-start; color: #fff; user-select: none;
    }
    #side-menu.open { transform: translateX(0); }
    #side-menu h2 {
      margin: 0.5rem 0 1.5rem;
      font-weight: 700;
      font-size: 1.6rem;
    }

    #close-btn {
      position: absolute;
      top: 2rem;
      right: 1.6rem;
      font-size: 2.2rem;
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      line-height: 1;
      width: 2.4rem;
      height: 2.4rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #side-menu a {
      display: block; width: 100%; padding: 0.6rem 0; font-size: 1.1rem; color: #e2e8f0;
      text-decoration: none; border-radius: 4px; transition: background-color 0.2s ease;
    }
    #side-menu a:hover { background-color: rgba(255, 255, 255, 0.18); color: #fff; }
  </style>
</head>

<body>
  <header>
    <div class="topbar">
      <div class="topbar-left">
        <button id="menu-btn" title="é¸å–®" role="button" tabindex="0" aria-label="é–‹å•Ÿå´é‚Šé¸å–®">
          <span></span><span></span><span></span>
        </button>
      </div>
      <h1 id="pageTitle">å…¬å¸å±¥æ­·å¯©æŸ¥</h1>
      <div style="width: 30px;"></div>
    </div>
  </header>
  <main>
    <section class="panel" aria-label="å±¥æ­·åˆ—è¡¨">
      <div class="panel-header">
      </div>
      <div style="display: flex; flex-wrap: wrap; gap: 16px; align-items: center; margin-bottom: 16px;">
        <select id="departmentFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">æ‰€æœ‰å­¸å¹´</option>
        </select>
        <select id="classFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">æ‰€æœ‰ç­ç´š</option>
        </select>
        <select id="companyNameFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">æ‰€æœ‰å…¬å¸</option>
        </select>
        <select id="companyFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">æ‰€æœ‰è·ç¼º</option>
        </select>
        <select id="statusFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">æ‰€æœ‰ç‹€æ…‹</option>
          <option value="pending">å¾…å¯©æ ¸</option>
          <option value="approved">é€šé</option>
          <option value="rejected">é€€ä»¶</option>
        </select>
        <select id="interviewStatusFilter" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">æ‰€æœ‰é¢è©¦ç‹€æ…‹</option>
          <option value="not_interviewed">æœªé¢è©¦</option>
          <option value="interviewing">é¢è©¦ä¸­</option>
          <option value="completed">å·²é¢è©¦</option>
        </select>
        <input type="text" id="searchBox" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 200px; flex: 1;" placeholder="æœå°‹å¸³è™Ÿ/æª”æ¡ˆ" />
      </div>
      
      <div style="margin-bottom: 16px;">
        <select id="interviewScheduleMenu" class="form-select" style="padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; min-width: 150px;">
          <option value="">æ‰€æœ‰åŠŸèƒ½</option>
          <option value="schedule">é¢è©¦æ’ç¨‹</option>
          <option value="completed">å·²é¢è©¦</option>
          <option value="download">ä¸‹è¼‰</option>
          <option value="matching_sort">åª’åˆæ’åº</option>
        </select>
      </div>

      <div class="table-wrapper">
        <table style="width: 100%; border-collapse: collapse;">
          <thead style="background: #f1f5f9;">
            <tr>
              <th style="padding: 14px 16px; font-weight: 600; width: 50px;">
                <input type="checkbox" id="selectAllCheckbox" title="å…¨é¸/å–æ¶ˆå…¨é¸" style="cursor: pointer; width: 18px; height: 18px;">
              </th>
              <th style="padding: 14px 16px; font-weight: 600;">å­¸ç”Ÿå¸³è™Ÿ</th>
              <th style="padding: 14px 16px; font-weight: 600;">å§“å</th>
              <th style="padding: 14px 16px; font-weight: 600;">ä¸Šå‚³æ™‚é–“</th>
              <th style="padding: 14px 16px; font-weight: 600;">æª”æ¡ˆåç¨±</th>
              <th style="padding: 14px 16px; font-weight: 600;">è·ç¼º</th>
              <th style="padding: 14px 16px; font-weight: 600;">ç‹€æ…‹</th>
              <th style="padding: 14px 16px; font-weight: 600;">å» å•†ç•™è¨€</th>
              <th style="padding: 14px 16px; font-weight: 600;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="resumeTableBody">
            <tr><td colspan="9" style="padding: 14px 16px; text-align: center; color: #64748b;">è¼‰å…¥ä¸­...</td></tr>
          </tbody>
        </table>
      </div>
      <nav><ul class="pagination justify-content-center mt-3" id="pagination"></ul></nav>
    </section>
  </main>

  <div class="modal fade" id="commentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="commentModalLabel">ç·¨è¼¯ç•™è¨€</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body"><textarea id="commentInput"></textarea></div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button class="btn btn-primary" id="saveCommentBtn">é€å‡º</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="interviewScheduleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">é¢è©¦æ’ç¨‹</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="calendarContainer" style="padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <button id="prevMonthBtn" class="btn btn-outline-secondary" style="padding: 8px 16px;">â€¹ ä¸Šå€‹æœˆ</button>
              <h4 id="currentMonthYear" style="margin: 0; font-weight: 600;"></h4>
              <button id="nextMonthBtn" class="btn btn-outline-secondary" style="padding: 8px 16px;">ä¸‹å€‹æœˆ â€º</button>
            </div>
            <div id="calendar" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="matchingSortModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">åª’åˆæ’åº</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div style="padding: 20px;">
            <!-- æ¯å€‹å­—æ¯å’Œå°æ‡‰çš„ä¸‹æ‹‰é¸å–® -->
            <div id="matchingSortLetters" style="display: flex; flex-direction: column; gap: 16px;">
              <!-- å­—æ¯æŒ‰éˆ•å’Œä¸‹æ‹‰é¸å–®å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </div>
            <!-- å­¸ç”Ÿè©³ç´°è³‡è¨Šé¡¯ç¤ºå€åŸŸ -->
            <div id="matchingSortContent" style="margin-top: 20px; max-height: 400px; overflow-y: auto;">
              <!-- æ’åºçµæœå°‡åœ¨æ­¤è™•é¡¯ç¤º -->
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" id="saveMatchingSortBtn">å„²å­˜</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="interviewFormModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">æ–°å¢é¢è©¦æ’ç¨‹</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="interviewForm">
            <div class="mb-3">
              <label for="interviewDate" class="form-label" style="font-weight: 600;">é¢è©¦æ—¥æœŸ</label>
              <input type="text" class="form-control" id="interviewDate" readonly style="background-color: #f9fafb;">
            </div>
            <div class="mb-3">
              <label class="form-label" style="font-weight: 600;">é¢è©¦æ™‚é–“</label>
              <div id="bookedTimeSlotsWarning" style="display: none; margin-bottom: 12px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; color: #856404;">
                <strong>âš ï¸ è©²æ—¥æœŸä»¥ä¸‹æ™‚é–“æ®µå·²è¢«å…¶ä»–å» å•†é ç´„ï¼Œè«‹é¸æ“‡å…¶ä»–æ™‚é–“ï¼š</strong>
                <div id="bookedTimeSlotsList" style="margin-top: 6px; font-size: 0.9rem;"></div>
              </div>
              <div style="display: flex; gap: 12px; align-items: center;">
                <div style="flex: 1;">
                  <label for="interviewTimeStart" class="form-label" style="font-weight: 500; font-size: 0.9rem; margin-bottom: 4px;">é–‹å§‹æ™‚é–“</label>
                  <input type="time" class="form-control" id="interviewTimeStart" required>
                </div>
                <div style="flex: 1;">
                  <label for="interviewTimeEnd" class="form-label" style="font-weight: 500; font-size: 0.9rem; margin-bottom: 4px;">çµæŸæ™‚é–“</label>
                  <input type="time" class="form-control" id="interviewTimeEnd" required>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                <label for="interviewStudents" class="form-label" style="font-weight: 600; margin: 0;">é¢è©¦å­¸ç”Ÿ</label>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="selectAllStudentsBtn" style="font-size: 0.85rem; padding: 4px 12px;">å…¨é¸</button>
              </div>
              <div id="interviewStudents" style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; max-height: 200px; overflow-y: auto; background-color: #fff;">
                <!-- å­¸ç”Ÿé¸é …å°‡ç”± JavaScript å‹•æ…‹å¡«å…… -->
              </div>
              <small class="form-text text-muted" style="font-size: 0.85rem; margin-top: 4px; display: block;">
                å·²é¸æ“‡ <span id="selectedStudentsCount">0</span> ä½å­¸ç”Ÿ
              </small>
            </div>
            <div class="mb-3">
              <label for="interviewLocation" class="form-label" style="font-weight: 600;">é¢è©¦åœ°é»</label>
              <select class="form-control" id="interviewLocation" required>
                <option value="">è«‹é¸æ“‡é¢è©¦åœ°é»</option>
                <option value="åº·å¯§å¤§å­¸ç§‘è¾¦">åº·å¯§å¤§å­¸ç§‘è¾¦</option>
                <option value="other">å…¶ä»–</option>
              </select>
              <input type="text" class="form-control mt-2" id="interviewLocationOther" placeholder="è«‹è¼¸å…¥å…¶ä»–é¢è©¦åœ°é»" style="display: none;">
            </div>
            <div class="mb-3">
              <label for="interviewNotes" class="form-label" style="font-weight: 600;">é¢è©¦é ˆçŸ¥</label>
              <textarea class="form-control" id="interviewNotes" rows="5" placeholder="è«‹è¼¸å…¥é¢è©¦é ˆçŸ¥ï¼Œä¾‹å¦‚ï¼šæ”œå¸¶æ–‡ä»¶ã€æ³¨æ„äº‹é …ç­‰..." style="resize: vertical;"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" id="saveInterviewBtn">å„²å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <nav id="side-menu" aria-hidden="true" role="navigation" aria-label="åŠŸèƒ½é¸å–®">
    <button id="close-btn" aria-label="é—œé–‰åŠŸèƒ½é¸å–®">Ã—</button>
    <h2>åŠŸèƒ½é¸å–®</h2>
    <a href="/teacher_home">é¦–é </a>
    <a href="/profile">å€‹äººè³‡æ–™</a>
    <a href="/upload_company">å»ºç«‹å¯¦ç¿’æ©Ÿæœƒ</a>
    <a href="/admission_results">æŸ¥çœ‹éŒ„å–çµæœ</a>
    <a href="/manage_vendor">å¯¦ç¿’å» å•†ç®¡ç†</a>
    <a href="/notifications">æŸ¥çœ‹å…¬å‘Š</a>
    <a href="/review_resume">å­¸ç”Ÿå±¥æ­·å¯©æ ¸</a>
    <a href="/logout">ç™»å‡º</a>
  </nav>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // å¾ URL ç²å– company_id
    const pathParts = window.location.pathname.split('/');
    const COMPANY_ID = parseInt(pathParts[pathParts.length - 2]);
    
    let allResumes = [];
    let allPositions = []; // å„²å­˜æ‰€æœ‰è·ç¼ºè³‡æ–™ï¼ˆåŒ…å«åé¡ï¼‰
    let currentResumeId = null;
    let currentPreferenceId = null; 
    let currentPage = 1;
    const rowsPerPage = 10;
    // ç´€éŒ„å·²ç¶“æŒ‰ä¸‹ã€Œé¢è©¦ã€çš„ç”³è«‹ï¼ˆä»¥ preferenceId æˆ– resumeId ä½œç‚º keyï¼‰
    const interviewedSet = new Set();
    // é¢è©¦åœ°é»ä¸‹æ‹‰é¸å–®ç”¨çš„å…¬å¸åç¨±åˆ—è¡¨ï¼ˆå¾å±¥æ­·è³‡æ–™æ”¶é›†ï¼‰
    let interviewCompanyNames = [];
    let companyInfo = null;
    let userRole = null;

    // æœˆæ›†ç›¸é—œè®Šæ•¸
    let currentCalendarDate = new Date();
    let selectedInterviewDate = null;
    // å­˜å„²é¢è©¦æ’ç¨‹ï¼ˆæ ¼å¼ï¼š'YYYY-MM-DD' => {timeStart: 'HH:MM', timeEnd: 'HH:MM', location: '...', notes: '...', students: []}ï¼‰
    const interviewSchedules = new Map();
    // å­˜å„²æ‰€æœ‰å» å•†çš„é¢è©¦æ’ç¨‹ï¼ˆç”¨æ–¼é¡¯ç¤ºå…¶ä»–å» å•†å·²é ç´„çš„æ™‚é–“ï¼‰
    const allVendorSchedules = new Map();

    // å®šç¾©ç‹€æ…‹é¡è‰²
    function statusColor(status) {
      return { 'pending': 'info', 'approved': 'success', 'rejected': 'danger', 'submitted': 'info', 'uploaded': 'info' }[status] || 'secondary';
    }

    // å®šç¾©ç‹€æ…‹æ–‡å­—
    function mapStatus(status) {
      return { 'pending': 'å¾…å¯©æ ¸', 'approved': 'é€šé', 'rejected': 'é€€ä»¶', 'submitted': 'å¾…å¯©æ ¸', 'uploaded': 'å¾…å¯©æ ¸' }[status] || 'å¾…å¯©æ ¸';
    }

    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    // ç²å–åŒ…å« company_id çš„ API URL
    function getResumeApiUrl() {
      // å¾ URL è·¯å¾‘ä¸­ç²å– company_idï¼ˆæ ¼å¼ï¼š/teacher/company/72/resumesï¼‰
      const pathParts = window.location.pathname.split('/');
      const companyId = parseInt(pathParts[pathParts.length - 2]);
      let apiUrl = '/vendor/api/resumes';
      if (companyId && !isNaN(companyId)) {
        apiUrl += `?company_id=${companyId}`;
      }
      return apiUrl;
    }

    document.addEventListener("DOMContentLoaded", () => {
      const urlParams = new URLSearchParams(window.location.search);
      // å¾ URL è·¯å¾‘ä¸­ç²å– company_idï¼ˆæ ¼å¼ï¼š/teacher/company/72/resumesï¼‰
      const pathParts = window.location.pathname.split('/');
      const targetCompanyId = parseInt(pathParts[pathParts.length - 2]);
      const targetStatus = urlParams.get('status');

      initMenu();

      // å…ˆç²å–ç”¨æˆ¶è§’è‰²ï¼Œç„¶å¾Œè¼‰å…¥è³‡æ–™
      fetch('/api/profile')
        .then(res => res.json())
        .then(profileData => {
          userRole = profileData.success && profileData.user ? profileData.user.role : 'teacher';
          
          // å» å•†å°ˆç”¨ APIï¼ˆè€å¸«ä¹Ÿå¯ä»¥è¨ªå•ï¼‰
          const apiUrl = getResumeApiUrl();

          // æ ¹æ“šè§’è‰²æ±ºå®šå¦‚ä½•ç²å–è·ç¼ºåˆ—è¡¨
          let positionsPromise;
          if (userRole === 'vendor') {
            // å» å•†èª¿ç”¨ vendor API
            positionsPromise = fetch('/vendor/api/positions').then(res => res.ok ? res.json() : {success:true, items:[]});
          } else if (userRole === 'teacher' || userRole === 'ta') {
            // è€å¸«èª¿ç”¨ public API
            if (targetCompanyId && !isNaN(targetCompanyId)) {
              // å¦‚æœæœ‰ company_idï¼Œç²å–è©²å…¬å¸çš„è·ç¼º
              positionsPromise = fetch(`/api/public/company/${targetCompanyId}`).then(async res => {
                if (!res.ok) return {success:true, items:[]};
                const r = await res.json();
                // åŒæ™‚è¨­ç½®å…¬å¸è³‡è¨Š
                if (r.success && r.company) {
                  companyInfo = r.company;
                  const pageTitle = document.getElementById('pageTitle');
                  if (pageTitle) {
                    pageTitle.textContent = `${r.company.name || 'å…¬å¸'} - å±¥æ­·å¯©æŸ¥`;
                  }
                }
                return {success:true, items: (r.jobs||[]).map(j=>({id:j.id, title:j.title, slots:j.slots}))};
              });
            } else {
              // å¦å‰‡ç²å–æ‰€æœ‰è·ç¼º
              positionsPromise = fetch('/api/public/positions').then(res => res.ok ? res.json() : {success:true, items:[]});
            }
          } else {
            positionsPromise = Promise.resolve({success:true, items:[]});
          }
          
          return Promise.all([
            fetch(apiUrl).then(res => res.ok ? res.json() : {success:false}),
            Promise.resolve({success:true, companies:[]}),
            positionsPromise
          ]);
        })
        .then(([resumeData, companyData, positionData]) => {
          if (resumeData.success) {
            allResumes = resumeData.resumes || [];
            
            // å„²å­˜è·ç¼ºè³‡æ–™ï¼ˆåŒ…å«åé¡ï¼‰
            if (positionData && positionData.items && Array.isArray(positionData.items)) {
              allPositions = positionData.items;
              console.log('ğŸ“‹ è¼‰å…¥è·ç¼ºè³‡æ–™ï¼š', allPositions.length, 'å€‹è·ç¼º');
              allPositions.forEach(pos => {
                console.log('  - è·ç¼ºï¼š', pos.title || pos.job_title, 'IDï¼š', pos.id, 'åé¡ï¼š', pos.slots);
              });
            } else if (positionData && positionData.success && positionData.positions && Array.isArray(positionData.positions)) {
              allPositions = positionData.positions;
            } else {
              allPositions = [];
              console.warn('âš ï¸ ç„¡æ³•è¼‰å…¥è·ç¼ºè³‡æ–™ï¼ŒpositionDataï¼š', positionData);
            }
            
            // æ ¹æ“šå¾Œç«¯è¿”å›çš„è³‡æ–™åˆå§‹åŒ– interviewedSet
            interviewedSet.clear();
            allResumes.forEach(r => {
              if (r.has_interview || r.interview_completed) {
                const key = String(r.preference_id || r.preferenceId || r.id);
                interviewedSet.add(key);
              }
            });

            // å¾å±¥æ­·è³‡æ–™è’é›†å…¬å¸åç¨±ï¼ˆç”¨æ–¼é¢è©¦åœ°é»ä¸‹æ‹‰é¸å–®ï¼‰
            const companyNameSet = new Set();
            allResumes.forEach(r => {
              if (r.company_name && r.company_name.trim()) {
                companyNameSet.add(r.company_name.trim());
              }
            });
            interviewCompanyNames = Array.from(companyNameSet);
            
            populateFilters(allResumes, companyData, positionData);

            if (targetStatus) {
               const statusSelect = document.getElementById('statusFilter');
               const mapped = (targetStatus === 'submitted' || targetStatus === 'uploaded') ? 'pending' : targetStatus;
               if(statusSelect) statusSelect.value = mapped;
            }

            applyFilters();
          } else {
            allResumes = [];
            renderTable([]);
          }
        });

      document.getElementById("departmentFilter").addEventListener("change", applyFilters);
      document.getElementById("classFilter").addEventListener("change", applyFilters);
      document.getElementById("companyNameFilter").addEventListener("change", applyFilters);
      document.getElementById("companyFilter").addEventListener("change", applyFilters);
      document.getElementById("statusFilter").addEventListener("change", applyFilters);
      document.getElementById("interviewStatusFilter").addEventListener("change", applyFilters);
      document.getElementById("searchBox").addEventListener("input", applyFilters);
    });

    function initMenu() {
      const sideMenu = document.getElementById('side-menu');
      const menuBtn = document.getElementById('menu-btn');
      const closeBtn = document.getElementById('close-btn');
      
      if (menuBtn) {
        menuBtn.addEventListener('click', () => {
          sideMenu.classList.add('open');
          sideMenu.setAttribute('aria-hidden', 'false');
        });
      }
      
      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          sideMenu.classList.remove('open');
          sideMenu.setAttribute('aria-hidden', 'true');
        });
      }
      
      document.addEventListener('click', (event) => {
        if (sideMenu && !sideMenu.contains(event.target) && menuBtn && !menuBtn.contains(event.target)) {
          sideMenu.classList.remove('open');
          sideMenu.setAttribute('aria-hidden', 'true');
        }
      });
    }

    function populateFilters(data, positionData) {
      const deptSelect = document.getElementById("departmentFilter");
      deptSelect.innerHTML = `<option value="">æ‰€æœ‰å­¸å¹´</option><option value="1132">1132</option><option value="1142">1142</option>`;
      
      const classSelect = document.getElementById("classFilter");
      classSelect.innerHTML = `<option value="">æ‰€æœ‰ç­ç´š</option>`;
      const classSet = new Set();
      data.forEach(r => { if(r.className) classSet.add(r.className); });
      classSet.add("å¿ ç­"); classSet.add("å­ç­");
      Array.from(classSet).sort().forEach(c => {
         if(c !== 'äº”å­') classSelect.innerHTML += `<option value="${c}">${c}</option>`;
      });

      // å¡«å……å…¬å¸åç¨±é¸å–®ï¼ˆåªé¡¯ç¤ºç•¶å‰å…¬å¸çš„åç¨±ï¼‰
      const companyNameSelect = document.getElementById("companyNameFilter");
      companyNameSelect.innerHTML = `<option value="">æ‰€æœ‰å…¬å¸</option>`;
      
      // å„ªå…ˆä½¿ç”¨ companyInfoï¼ˆå¾ API ç²å–çš„å…¬å¸è³‡è¨Šï¼‰
      // API è¿”å›çš„æ¬„ä½æ˜¯ nameï¼Œä¸æ˜¯ company_name
      if (companyInfo && companyInfo.name) {
        const companyName = companyInfo.name.trim();
        if (companyName) {
          companyNameSelect.innerHTML += `<option value="${escapeHtml(companyName)}">${escapeHtml(companyName)}</option>`;
        }
      } else {
        // å¦‚æœ companyInfo é‚„æ²’è¼‰å…¥ï¼Œå¾å±¥æ­·æ•¸æ“šä¸­æå–ç•¶å‰å…¬å¸çš„åç¨±
        const companySet = new Set();
        data.forEach(r => { 
          if(r.company_name && r.company_name.trim()) {
            companySet.add(r.company_name.trim());
          }
        });
        // åªé¡¯ç¤ºç¬¬ä¸€å€‹æ‰¾åˆ°çš„å…¬å¸åç¨±ï¼ˆå› ç‚ºé€™å€‹é é¢åªé‡å°ä¸€å€‹å…¬å¸ï¼‰
        if (companySet.size > 0) {
          const firstCompany = Array.from(companySet).sort()[0];
          companyNameSelect.innerHTML += `<option value="${escapeHtml(firstCompany)}">${escapeHtml(firstCompany)}</option>`;
        }
      }

      const companySelect = document.getElementById("companyFilter");
      companySelect.innerHTML = `<option value="">æ‰€æœ‰è·ç¼º</option>`;
      const jobSet = new Set();
      
      // å¾ API è¿”å›çš„è·ç¼ºè³‡æ–™ä¸­æå–è·ç¼ºï¼ˆç›´æ¥å¾ internship_jobs è³‡æ–™è¡¨æŠ“å–ï¼‰
      if (positionData && positionData.items && positionData.items.length > 0) {
        positionData.items.forEach(job => {
          const jobTitle = job.title || job.job_title || '';
          if (jobTitle && jobTitle.trim()) {
            jobSet.add(jobTitle.trim());
          }
        });
      }
      
      // ä¹Ÿå¾å±¥æ­·æ•¸æ“šä¸­æå–è·ç¼ºï¼ˆä½œç‚ºå‚™ç”¨ï¼Œç¢ºä¿æ‰€æœ‰å‡ºç¾çš„è·ç¼ºéƒ½è¢«åŒ…å«ï¼‰
      data.forEach(r => {
        const jobTitle = r.job_title || r.jobTitle || '';
        if (jobTitle && jobTitle.trim()) {
          jobSet.add(jobTitle.trim());
        }
      });
      
      console.log('è·ç¼ºé¸å–®è³‡æ–™:', Array.from(jobSet));
      
      // å°‡æ‰€æœ‰è·ç¼ºæ’åºå¾ŒåŠ å…¥é¸å–®
      Array.from(jobSet).sort().forEach(j => {
        companySelect.innerHTML += `<option value="${escapeHtml(j)}">${escapeHtml(j)}</option>`;
      });
    }

    function applyFilters() {
      currentPage = 1;
      const dept = document.getElementById("departmentFilter").value.trim();
      const cls = document.getElementById("classFilter").value.trim();
      const companyNameFilter = document.getElementById("companyNameFilter").value.trim();
      const jobFilter = document.getElementById("companyFilter").value.trim();
      const status = document.getElementById("statusFilter").value.trim();
      const interviewStatus = document.getElementById("interviewStatusFilter").value.trim();
      const keyword = document.getElementById("searchBox").value.trim().toLowerCase();

      const filtered = allResumes.filter(r => {
        const matchesDept = !dept || r.department === dept;
        const matchesClass = !cls || r.className === cls;
        const matchesKeyword = (r.username && r.username.toLowerCase().includes(keyword)) ||
                               (r.original_filename && r.original_filename.toLowerCase().includes(keyword));
        
        let matchesCompanyName = true;
        if (companyNameFilter) {
          const companyName = (r.company_name || '').trim();
          matchesCompanyName = companyName === companyNameFilter;
        }
        
        let matchesJob = true;
        if (jobFilter) {
          const jobs = (r.job_title || r.jobTitle || '').toLowerCase();
          matchesJob = jobs.includes(jobFilter.toLowerCase()) || (r.job_id && String(r.job_id) === jobFilter);
        }

        let matchesStatus = true;
        if (status) {
          const statusStr = r.application_statuses || r.display_status || r.status || '';
          matchesStatus = statusStr === status;
        }

        // é¢è©¦ç‹€æ…‹ç¯©é¸
        let matchesInterviewStatus = true;
        if (interviewStatus) {
          const key = (r.preference_id || r.preferenceId || r.id);
          const hasInterviewed = interviewedSet.has(String(key)) || r.has_interview || false;
          const isInterviewCompleted = r.interview_completed || false;
          
          if (interviewStatus === 'not_interviewed') {
            // æœªé¢è©¦ï¼šæ²’æœ‰é¢è©¦è¨˜éŒ„
            matchesInterviewStatus = !hasInterviewed && !isInterviewCompleted;
          } else if (interviewStatus === 'interviewing') {
            // é¢è©¦ä¸­ï¼šæœ‰é¢è©¦è¨˜éŒ„ä½†æœªå®Œæˆ
            matchesInterviewStatus = hasInterviewed && !isInterviewCompleted;
          } else if (interviewStatus === 'completed') {
            // å·²é¢è©¦ï¼šå·²å®Œæˆé¢è©¦
            matchesInterviewStatus = isInterviewCompleted;
          }
        }

        return matchesDept && matchesClass && matchesCompanyName && matchesJob && matchesStatus && matchesInterviewStatus && matchesKeyword;
      });

      renderTable(filtered);
    }

    function renderTable(resumes) {
      const tbody = document.getElementById("resumeTableBody");
      tbody.innerHTML = "";
      if (resumes.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; color: #64748b; padding: 16px;">ç›®å‰æ²’æœ‰è³‡æ–™</td></tr>`;
        document.getElementById("pagination").innerHTML = "";
        return;
      }

      const filterStatus = document.getElementById("statusFilter").value.trim(); 
      const filterJob = document.getElementById("companyFilter").value.trim(); 

      let allRowsData = [];

      resumes.forEach(r => {
        // ç›´æ¥ä½¿ç”¨æœ€æ–°çš„å¿—é¡˜åºè³‡æ–™ï¼ˆå¾Œç«¯å·²è™•ç†ï¼‰
        const comp = r.company_name || 'â€”';
        const job = r.job_title || r.jobTitle || 'â€”';
        const pid = r.preference_id || null;
        const st = r.application_statuses || r.display_status || r.status || 'pending';
        const cm = r.comment || '';

        // ç‹€æ…‹ç¯©é¸
        if (filterStatus && st !== filterStatus) return;
        
        // è·ç¼ºç¯©é¸
        if (filterJob && !job.includes(filterJob) && filterJob !== (r.job_id ? String(r.job_id) : '')) return;

        allRowsData.push({
            ...r,
            display_company: comp,
            display_job: job,
            preference_id: pid,
            display_status: st,
            comment: cm,
            isMultiRow: true
        });
      });

      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pageData = allRowsData.slice(start, end);

      pageData.forEach(row => {
        const pid = row.preference_id || null;
        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid #e2e8f0';
        const key = (row.preference_id || row.preferenceId || row.id);
        const hasInterviewed = interviewedSet.has(String(key)) || row.has_interview || false;
        const isInterviewCompleted = row.interview_completed || false;
        const rowId = `checkbox-${row.id}-${pid || 'no-pid'}`;
        
        tr.innerHTML = `
           <td style="padding: 14px 16px; text-align: center;">
             <input type="checkbox" class="row-checkbox" id="${rowId}" data-resume-id="${row.id}" data-preference-id="${pid || ''}" style="cursor: pointer; width: 18px; height: 18px;">
           </td>
           <td style="padding: 14px 16px;">${row.username || row.student_number || 'â€”'}</td>
           <td style="padding: 14px 16px;">${escapeHtml(row.name || row.student_name || 'â€”')}</td>
           <td style="padding: 14px 16px;">${row.upload_time || 'â€”'}</td>
           <td style="padding: 14px 16px; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(row.original_filename || 'â€”')}</td>
          <td style="padding: 14px 16px;">${escapeHtml(row.display_job)}</td>
          <td style="padding: 14px 16px;">
            <div style="display:flex; gap:6px; flex-wrap:wrap; align-items:center;">
              <span class="status-badge bg-${statusColor(row.display_status)}">${mapStatus(row.display_status)}</span>
              ${
                isInterviewCompleted
                  ? `<span class="status-badge bg-completed">å·²é¢è©¦</span>`
                  : (hasInterviewed || row.has_interview)
                    ? `<span class="status-badge bg-interviewing">é¢è©¦ä¸­</span>`
                    : `<span class="status-badge bg-secondary" style="background-color: #94a3b8;">æœªé¢è©¦</span>`
              }
            </div>
          </td>
           <td style="padding: 14px 16px;">
             ${ renderCommentBtn(row, pid) }
           </td>
           <td style="padding: 14px 16px;">
             ${ renderActionBtns(row, pid) }
           </td>
        `;
        tbody.appendChild(tr);
      });

      renderPagination(allRowsData.length);
    }

    function renderCommentBtn(row, pid) {
        const hasComment = row.comment && row.comment.trim() !== '';
        const btnClass = hasComment ? 'text-success' : '';
        const btnText = hasComment ? 'å·²å¡«å¯«' : 'æœªå¡«å¯«';
        
        // å¦‚æœæ˜¯è€å¸«ï¼Œåªé¡¯ç¤ºæŸ¥çœ‹æ¨¡å¼ï¼ˆåªè®€ï¼‰
        const isReadOnly = userRole && userRole !== 'vendor';
        if (isReadOnly) {
            if (hasComment) {
                return `<button class="btn btn-sm btn-outline-secondary text-success" onclick="openCommentModal(${row.id}, '${escapeHtml(row.comment || '')}', ${pid ? pid : 'null'}, true)">å·²å¡«å¯«</button>`;
            } else {
                return `<span style="color:#aaa; font-size:0.9em;">æœªå¡«å¯«</span>`;
            }
        }
        
        return `<button class="btn btn-sm btn-outline-secondary ${btnClass}" onclick="openCommentModal(${row.id}, '${escapeHtml(row.comment || '')}', ${pid ? pid : 'null'}, false)">${btnText}</button>`;
    }

    function renderActionBtns(row, pid) {
        const dlBtn = `<a href="/api/download_resume/${row.id}" class="btn btn-sm btn-outline-primary" target="_blank" style="margin-right:4px;">ä¸‹è¼‰</a>`;
        
        // å¦‚æœæ˜¯è€å¸«ï¼Œåªé¡¯ç¤ºä¸‹è¼‰æŒ‰éˆ•ï¼ˆåªè®€æ¨¡å¼ï¼‰
        if (userRole && userRole !== 'vendor') {
            return dlBtn;
        }
        
        const key = (pid || row.preference_id || row.preferenceId || row.id);
        const hasInterviewed = interviewedSet.has(String(key)) || row.has_interview || false;
        const isInterviewCompleted = row.interview_completed || false;

        // å» å•†å¯ä»¥é€²è¡Œå¯©æ ¸æ“ä½œ
        const approveClick = `approveResume(${row.id}, ${pid ? `'${pid}'` : 'null'})`;
        const rejectClick = `rejectResume(${row.id}, ${pid ? `'${pid}'` : 'null'})`;
        const interviewClick = `sendInterview(${row.student_id || 'null'}, ${row.company_id || 'null'}, ${row.id}, ${pid ? `'${pid}'` : 'null'})`;
        const markCompletedClick = `markInterviewCompleted(${row.id}, ${pid ? `'${pid}'` : 'null'})`;

        // ç„¡è«–ç‹€æ…‹ç‚ºä½•ï¼Œä¿ç•™æŒ‰éˆ•
        let btns = `<div style="display:flex; align-items:center; flex-wrap:wrap; gap:4px;">${dlBtn}`;
        btns += `<button class="btn btn-sm btn-outline-danger" style="margin-right:4px;" onclick="${rejectClick}">é€€ä»¶</button>`;
        btns += `<button class="btn btn-sm btn-outline-success" onclick="${approveClick}">é€šé</button>`;
        btns += `</div>`;
        return btns;
    }

    // æ›´æ–°ç‹€æ…‹å‡½å¼
    function approveResume(resumeId, preferenceId) {
      if (!confirm("ç¢ºå®šè¦å°‡æ­¤è·ç¼ºç”³è«‹æ¨™è¨˜ç‚ºé€šéå—ï¼Ÿ")) return;
      
      const body = { status: 'approved' };
      if (preferenceId && preferenceId !== 'null') body.preference_id = preferenceId;

      fetch(`/api/review_resume/${resumeId}`, { 
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(body)
      }).then(res => res.json()).then(data => {
          if (data.success) {
              alert("âœ… ç‹€æ…‹æ›´æ–°æˆåŠŸ");
              // é‡æ–°è¼‰å…¥è³‡æ–™
              fetch(getResumeApiUrl()).then(r=>r.json()).then(d=>{
                  if(d.success) { 
                    allResumes=d.resumes;
                    // æ ¹æ“šå¾Œç«¯è¿”å›çš„è³‡æ–™æ›´æ–° interviewedSet
                    interviewedSet.clear();
                    allResumes.forEach(r => {
                      if (r.has_interview || r.interview_completed) {
                        const key = String(r.preference_id || r.preferenceId || r.id);
                        interviewedSet.add(key);
                      }
                    });
                    applyFilters(); 
                  }
              });
          } else {
              alert("å¤±æ•—ï¼š" + data.message);
          }
      });
    }

    function rejectResume(resumeId, preferenceId) {
       if (!confirm("ç¢ºå®šè¦é€€ä»¶æ­¤ç”³è«‹ï¼Ÿ")) return;
       currentResumeId = resumeId;
       currentPreferenceId = preferenceId && preferenceId !== 'null' ? preferenceId : null;
       
       document.getElementById("commentInput").value = "";
       document.getElementById("commentModalLabel").textContent = "âŒ å¡«å¯«é€€ä»¶åŸå› ";
       document.getElementById("saveCommentBtn").textContent = "ç¢ºèªé€€ä»¶";
       const modal = new bootstrap.Modal(document.getElementById("commentModal"));
       modal.show();
       
       const saveBtn = document.getElementById("saveCommentBtn");
       saveBtn.onclick = () => {
           const reason = document.getElementById("commentInput").value.trim();
           if(!reason) { alert("è«‹å¡«å¯«é€€ä»¶åŸå› "); return; }
           
           const body = { status: 'rejected', comment: reason };
           if (currentPreferenceId) body.preference_id = currentPreferenceId;

           fetch(`/api/review_resume/${currentResumeId}`, {
               method: 'POST',
               headers: {'Content-Type': 'application/json'},
               body: JSON.stringify(body)
           }).then(res => res.json()).then(data => {
               if(data.success) {
                   alert("âœ… å·²é€€ä»¶");
                   modal.hide();
                   fetch(getResumeApiUrl()).then(r=>r.json()).then(d=>{
                       if(d.success) { 
                         allResumes=d.resumes;
                         // æ ¹æ“šå¾Œç«¯è¿”å›çš„è³‡æ–™æ›´æ–° interviewedSet
                         interviewedSet.clear();
                         allResumes.forEach(r => {
                           if (r.has_interview) {
                             const key = String(r.preference_id || r.preferenceId || r.id);
                             interviewedSet.add(key);
                           }
                         });
                         applyFilters(); 
                       }
                   });
               } else {
                   alert("å¤±æ•—ï¼š" + data.message);
               }
           });
       };
    }

    function openCommentModal(id, comment, pid, readonly) {
        document.getElementById("commentInput").value = comment || '';
        document.getElementById("commentInput").readOnly = readonly;
        document.getElementById("commentModalLabel").textContent = readonly ? "æŸ¥çœ‹ç•™è¨€" : "ç·¨è¼¯ç•™è¨€";
        const saveBtn = document.getElementById("saveCommentBtn");
        saveBtn.style.display = readonly ? 'none' : 'block';
        saveBtn.textContent = "å„²å­˜";
        
        if (!readonly) {
            currentResumeId = id;
            currentPreferenceId = pid && pid !== 'null' ? pid : null;
            saveBtn.onclick = saveComment; 
        }
        new bootstrap.Modal(document.getElementById("commentModal")).show();
    }

    function saveComment() {
        const val = document.getElementById("commentInput").value.trim();
        const body = { field: 'comment', value: val, resume_id: currentResumeId };
        if(currentPreferenceId) body.preference_id = currentPreferenceId;

        fetch("/api/update_resume_field", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        }).then(res => res.json()).then(data => {
             if(data.success) {
                 alert("ç•™è¨€å·²æ›´æ–°");
                 bootstrap.Modal.getInstance(document.getElementById("commentModal")).hide();
                 fetch(getResumeApiUrl()).then(r=>r.json()).then(d=>{
                     if(d.success) { 
                       allResumes=d.resumes;
                       // æ ¹æ“šå¾Œç«¯è¿”å›çš„è³‡æ–™æ›´æ–° interviewedSet
                       interviewedSet.clear();
                       allResumes.forEach(r => {
                         if (r.has_interview) {
                           const key = String(r.preference_id || r.preferenceId || r.id);
                           interviewedSet.add(key);
                         }
                       });
                       applyFilters(); 
                     }
                 });
             } else {
                 alert("å¤±æ•—");
             }
        });
    }

    // å» å•†é€å‡ºé¢è©¦é€šçŸ¥
    function sendInterview(studentId, companyId, resumeId, preferenceId) {
      if (!studentId) {
        alert("æ‰¾ä¸åˆ°å­¸ç”Ÿè³‡æ–™ï¼Œç„¡æ³•ç™¼é€é¢è©¦é€šçŸ¥");
        return;
      }
      const contentRaw = prompt("è«‹è¼¸å…¥è¦çµ¦å­¸ç”Ÿçš„é¢è©¦é€šçŸ¥å…§å®¹ï¼ˆå¯ç•™ç©ºï¼ŒæŒ‰ã€Œå–æ¶ˆã€å‰‡ä¸é€å‡ºï¼‰ï¼š");
      if (contentRaw === null) {
        // ä½¿ç”¨è€…æŒ‰ä¸‹å–æ¶ˆï¼Œä¸é€å‡ºé€šçŸ¥
        return;
      }
      const content = contentRaw.trim();
      const payload = {
        student_id: studentId,
        company_id: companyId || null,
        notification_type: "interview",
        content: content,
        preference_id: preferenceId || null
      };

      fetch("/vendor/api/send_notification", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("âœ… é¢è©¦é€šçŸ¥å·²ç™¼é€çµ¦å­¸ç”Ÿå’ŒæŒ‡å°è€å¸«");
          // é‡æ–°è¼‰å…¥è³‡æ–™
          fetch(getResumeApiUrl()).then(r=>r.json()).then(d=>{
            if(d.success) { 
              allResumes=d.resumes;
              // æ ¹æ“šå¾Œç«¯è¿”å›çš„è³‡æ–™æ›´æ–° interviewedSet
              interviewedSet.clear();
              allResumes.forEach(r => {
                if (r.has_interview || r.interview_completed) {
                  const key = String(r.preference_id || r.preferenceId || r.id);
                  interviewedSet.add(key);
                }
              });
              applyFilters(); 
            }
          });
        } else {
          alert("ç™¼é€å¤±æ•—ï¼š" + (data.message || "æœªçŸ¥éŒ¯èª¤"));
        }
      })
      .catch(err => {
        console.error("sendInterview error:", err);
        alert("ç™¼é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
      });
    }

    // æ¨™è¨˜é¢è©¦å·²å®Œæˆ
    function markInterviewCompleted(resumeId, preferenceId) {
      if (!preferenceId || preferenceId === 'null') {
        alert("æ‰¾ä¸åˆ°å¿—é¡˜åºè³‡æ–™ï¼Œç„¡æ³•æ¨™è¨˜é¢è©¦å®Œæˆ");
        return;
      }
      
      if (!confirm("ç¢ºå®šè¦æ¨™è¨˜ç‚ºå·²é¢è©¦å—ï¼Ÿ")) {
        return;
      }

      fetch("/vendor/api/mark_interview_completed", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          preference_id: preferenceId
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("âœ… å·²æ¨™è¨˜ç‚ºé¢è©¦å®Œæˆ");
          // é‡æ–°è¼‰å…¥è³‡æ–™
          fetch(getResumeApiUrl()).then(r=>r.json()).then(d=>{
            if(d.success) { 
              allResumes=d.resumes;
              // æ ¹æ“šå¾Œç«¯è¿”å›çš„è³‡æ–™æ›´æ–° interviewedSet
              interviewedSet.clear();
              allResumes.forEach(r => {
                if (r.has_interview || r.interview_completed) {
                  const key = String(r.preference_id || r.preferenceId || r.id);
                  interviewedSet.add(key);
                }
              });
              applyFilters(); 
            }
          });
        } else {
          alert("æ“ä½œå¤±æ•—ï¼š" + (data.message || "æœªçŸ¥éŒ¯èª¤"));
        }
      })
      .catch(err => {
        console.error("markInterviewCompleted error:", err);
        alert("æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
      });
    }

    function renderPagination(totalItems) {
      const totalPages = Math.ceil(totalItems / rowsPerPage);
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";
      if (totalPages <= 1) return;
      for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement("li");
        li.className = `page-item ${i === currentPage ? "active" : ""}`;
        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        li.onclick = (e) => { e.preventDefault(); currentPage = i; applyFilters(); }; 
        pagination.appendChild(li);
      }
    }

    // æ‰¹é‡æ¨™è¨˜ç‚ºå·²é¢è©¦
    async function markSelectedAsCompleted() {
      const checkboxes = document.querySelectorAll('.row-checkbox:checked');
      if (checkboxes.length === 0) {
        alert('è«‹å…ˆé¸æ“‡è¦æ¨™è¨˜çš„å±¥æ­·');
        return;
      }

      const preferenceIds = [];
      checkboxes.forEach(cb => {
        const pid = cb.getAttribute('data-preference-id');
        if (pid && pid !== '') {
          preferenceIds.push(pid);
        }
      });

      if (preferenceIds.length === 0) {
        alert('é¸ä¸­çš„å±¥æ­·ä¸­æ²’æœ‰å¯ç”¨çš„å¿—é¡˜åºè³‡æ–™');
        return;
      }

      if (!confirm(`ç¢ºå®šè¦å°‡é¸ä¸­çš„ ${preferenceIds.length} ç­†å±¥æ­·æ¨™è¨˜ç‚ºå·²é¢è©¦å—ï¼Ÿ`)) {
        return;
      }

      try {
        const res = await fetch('/vendor/api/mark_interview_completed', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ preference_ids: preferenceIds })
        });
        const data = await res.json();
        if (data.success) {
          alert(`âœ… å·²æˆåŠŸæ¨™è¨˜ ${preferenceIds.length} ç­†å±¥æ­·ç‚ºå·²é¢è©¦`);
          // é‡æ–°è¼‰å…¥è³‡æ–™
          fetch(getResumeApiUrl()).then(r => r.json()).then(d => {
            if (d.success) {
              allResumes = d.resumes;
              interviewedSet.clear();
              allResumes.forEach(r => {
                if (r.has_interview || r.interview_completed) {
                  const key = String(r.preference_id || r.preferenceId || r.id);
                  interviewedSet.add(key);
                }
              });
              applyFilters();
            }
          });
        } else {
          alert('æ“ä½œå¤±æ•—ï¼š' + (data.message || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (err) {
        console.error('markSelectedAsCompleted error:', err);
        alert('æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    // æ‰¹é‡ä¸‹è¼‰å±¥æ­·
    function downloadSelectedResumes() {
      const checkboxes = document.querySelectorAll('.row-checkbox:checked');
      if (checkboxes.length === 0) {
        alert('è«‹å…ˆé¸æ“‡è¦ä¸‹è¼‰çš„å±¥æ­·');
        return;
      }

      const resumeIds = [];
      checkboxes.forEach(cb => {
        const resumeId = cb.getAttribute('data-resume-id');
        if (resumeId) {
          resumeIds.push(resumeId);
        }
      });

      if (resumeIds.length === 0) {
        alert('é¸ä¸­çš„å±¥æ­·ä¸­æ²’æœ‰å¯ç”¨çš„å±¥æ­· ID');
        return;
      }

      // é€ä¸€ä¸‹è¼‰ï¼ˆæˆ–ä½¿ç”¨å¾Œç«¯æ‰¹é‡ä¸‹è¼‰ APIï¼‰
      resumeIds.forEach((id, index) => {
        setTimeout(() => {
          window.open(`/api/download_resume/${id}`, '_blank');
        }, index * 200); // å»¶é² 200ms é¿å…ç€è¦½å™¨é˜»æ“‹
      });
    }

    // å…¨é¸/å–æ¶ˆå…¨é¸ checkbox äº‹ä»¶ç›£è½å™¨
    document.addEventListener('DOMContentLoaded', function() {
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
          const checkboxes = document.querySelectorAll('.row-checkbox');
          checkboxes.forEach(cb => {
            cb.checked = this.checked;
          });
        });
      }

      // é¢è©¦æ’ç¨‹é¸å–®äº‹ä»¶ç›£è½å™¨
      const interviewScheduleMenu = document.getElementById('interviewScheduleMenu');
      if (interviewScheduleMenu) {
        interviewScheduleMenu.addEventListener('change', function() {
          const action = this.value;
          if (action === 'schedule') {
            // æ‰“é–‹é¢è©¦æ’ç¨‹æ¨¡æ…‹æ¡†
            openInterviewSchedule();
          } else if (action === 'completed') {
            // æ‰¹é‡æ¨™è¨˜ç‚ºå·²é¢è©¦
            markSelectedAsCompleted();
          } else if (action === 'download') {
            // æ‰¹é‡ä¸‹è¼‰
            downloadSelectedResumes();
          } else if (action === 'matching_sort') {
            // åª’åˆæ’åºï¼ˆè€å¸«è§’è‰²ä¸éœ€è¦ï¼‰
            if (userRole && userRole !== 'vendor') {
              alert('è€å¸«è§’è‰²ç„¡æ³•ä½¿ç”¨åª’åˆæ’åºåŠŸèƒ½');
              this.value = '';
              return;
            }
            openMatchingSortModal();
          }
          // é‡ç½®é¸å–®
          this.value = '';
        });
      }
    });

    // æ‰“é–‹é¢è©¦æ’ç¨‹æ¨¡æ…‹æ¡†ï¼ˆç°¡åŒ–ç‰ˆæœ¬ï¼Œè€å¸«è§’è‰²åªè®€ï¼‰
    function openInterviewSchedule() {
      if (userRole && userRole !== 'vendor') {
        alert('è€å¸«è§’è‰²ç„¡æ³•ç·¨è¼¯é¢è©¦æ’ç¨‹');
        return;
      }
      // é€™è£¡å¯ä»¥æ‰“é–‹é¢è©¦æ’ç¨‹æ¨¡æ…‹æ¡†
      // ç”±æ–¼æª”æ¡ˆå¤ªå¤§ï¼Œæˆ‘å…ˆä¸å¯¦ç¾å®Œæ•´åŠŸèƒ½ï¼Œä½†ä¿ç•™æ¥å£
      alert('é¢è©¦æ’ç¨‹åŠŸèƒ½éœ€è¦å®Œæ•´çš„å¯¦ç¾');
    }

    // æ‰“é–‹åª’åˆæ’åºæ¨¡æ…‹æ¡†
    function openMatchingSortModal() {
      if (userRole && userRole !== 'vendor') {
        alert('è€å¸«è§’è‰²ç„¡æ³•ä½¿ç”¨åª’åˆæ’åºåŠŸèƒ½');
        return;
      }
      // é€™è£¡å¯ä»¥æ‰“é–‹åª’åˆæ’åºæ¨¡æ…‹æ¡†
      alert('åª’åˆæ’åºåŠŸèƒ½éœ€è¦å®Œæ•´çš„å¯¦ç¾');
    }
  </script>
</body>
</html>

