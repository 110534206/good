<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ™ºæ…§å¯¦ç¿’å¹³å° | å±¥æ­·ç®¡ç†å¹³å°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    header {
      background: #0454a3;
      color: white;
      padding: 1rem 2rem;
      text-align: center;
      font-size: 1.5rem;
    }

    body {
      font-family: "Noto Sans TC", sans-serif;
      background: #f7f9fc;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1200px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .card {
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }

    td.comment-cell .view-text,
    td.note-cell .view-text {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 40px;
      height: 40px;
      text-align: center;
      word-break: break-word;
      white-space: pre-wrap;
    }

    td.comment-cell .text-muted,
    td.note-cell .text-muted {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      min-height: 40px;
      text-align: center;
      word-break: break-word;
      white-space: pre-wrap;
    }

    td.comment-cell textarea,
    td.note-cell textarea {
      width: 100%;
      resize: vertical;
      font-size: 1.2em;
      text-align: center;
      box-sizing: border-box;
      font-family: inherit;
      padding: 0.4rem;
    }

    td.comment-cell button,
    td.note-cell button {
      margin-top: 0.2rem;
      font-size: 0.85em;
      padding: 0.2rem 0.5rem;
    }

    .view-text span {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 40px;
      color: #198754;
    }

    .view-text span.text-muted {
      color: #6c757d;
    }

    .editor-box {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10;
      background-color: #fff;
      border: 1px solid #ddd;
      padding: 0.5rem;
      width: 100%;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>

<body>
  <header>æ™ºæ…§å¯¦ç¿’å¹³å° | å±¥æ­·ç®¡ç†</header>

  <div class="container">
    <ul class="nav nav-tabs mb-4" id="resumeTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="submit-tab" data-bs-toggle="tab" data-bs-target="#submit-pane" type="button"
          role="tab">ğŸ“ å¯¦ç¿’å±¥æ­·å¡«å¯«</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="records-tab" data-bs-toggle="tab" data-bs-target="#records-pane"
          type="button" role="tab">ğŸ“‚ ä¸Šå‚³ç´€éŒ„èˆ‡ç®¡ç†</button>
      </li>
    </ul>

    <div class="tab-content">
      <!-- å±¥æ­·å¡«å¯«é ç±¤ -->
      <div class="tab-pane fade" id="submit-pane" role="tabpanel" aria-labelledby="submit-tab">
        <form id="applicationForm">
          <div class="card p-4">
            <h5 class="card-title text-primary">ğŸ‘¤ å€‹äººåŸºæœ¬è³‡æ–™</h5>
            <div class="row g-3">
              <div class="col-md-4"><label class="form-label">å§“å</label>
                <input type="text" class="form-control" name="name" required>
              </div>
              <div class="col-md-4"><label class="form-label">å‡ºç”Ÿæ—¥æœŸ</label>
                <input type="date" class="form-control" name="birth_date" required>
              </div>
              <div class="col-md-4"><label class="form-label">æ€§åˆ¥</label>
                <select class="form-select" name="gender" required>
                  <option value="">è«‹é¸æ“‡</option>
                  <option value="ç”·">ç”·</option>
                  <option value="å¥³">å¥³</option>
                </select>
              </div>
              <div class="col-md-6"><label class="form-label">è¯çµ¡é›»è©±</label>
                <input type="tel" class="form-control" name="phone" required>
              </div>
              <div class="col-md-6"><label class="form-label">é›»å­ä¿¡ç®±</label>
                <input type="email" class="form-control" name="email" required>
              </div>
              <div class="col-12"><label class="form-label">åœ°å€</label>
                <input type="text" class="form-control" name="address" required>
              </div>
            </div>
          </div>

          <div class="card p-4">
            <h5 class="card-title text-info">ğŸ“ è‡ªå‚³</h5>
            <textarea class="form-control" name="autobiography" rows="6"
              placeholder="è«‹å¡«å¯«å®¶åº­ç”Ÿæ´»ã€æ±‚å­¸ç¶“éã€å€‹äººå°ˆé•·ã€æœªä¾†ç”Ÿæ¶¯è¦åŠƒç­‰..."></textarea>
          </div>

          <div class="text-center mt-4">
            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">æäº¤ä¸¦ç”Ÿæˆå±¥æ­·</button>
          </div>
        </form>
      </div>

      <!-- å±¥æ­·ç´€éŒ„é ç±¤ -->
      <div class="tab-pane fade show active" id="records-pane" role="tabpanel" aria-labelledby="records-tab">
        <div class="card p-4">
          <h5 class="card-title text-primary">âœ… å·²æäº¤å±¥æ­·ç´€éŒ„</h5>
          <p class="text-muted">ä»¥ä¸‹ç‚ºæ­·å²å±¥æ­·ç´€éŒ„ï¼Œå­¸ç”Ÿå¯ä¸‹è¼‰æŸ¥çœ‹ã€ç·¨è¼¯å‚™è¨»ã€‚</p>

          <!-- ç¯©é¸æŒ‰éˆ• -->
          <div class="btn-group mb-3 w-100" role="group">
            <button class="btn btn-outline-secondary active" onclick="filterStatus('all', this)">å…¨éƒ¨</button>
            <button class="btn btn-outline-info" id="uploadedCountBtn"
              onclick="filterStatus('uploaded', this)">å·²ä¸Šå‚³</button>
            <button class="btn btn-outline-success" id="approvedCountBtn"
              onclick="filterStatus('approved', this)">å¯©æŸ¥å®Œæˆ</button>
            <button class="btn btn-outline-danger" id="rejectedCountBtn"
              onclick="filterStatus('rejected', this)">å·²é€€ä»¶</button>
          </div>

          <div class="table-responsive">
            <table class="table table-hover mt-3" id="resumeTable">
              <thead>
                <tr>
                  <th>ä¸Šå‚³æ™‚é–“</th>
                  <th>æª”æ¡ˆåç¨±</th>
                  <th>ç‹€æ…‹</th>
                  <th>ç•™è¨€ (æ•™å¸«)</th>
                  <th>å‚™è¨» (å­¸ç”Ÿ)</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="resumeTableBody">
                <tr>
                  <td colspan="6" class="text-center text-muted">è¼‰å…¥ä¸­...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      let resumesData = [];
      let role = 'visitor';
      let currentFilter = 'all'; // âœ… æ–°å¢ï¼šè¨˜éŒ„ç›®å‰ç¯©é¸ç‹€æ…‹
      const tbody = document.getElementById('resumeTableBody');

      // å–å¾—ä½¿ç”¨è€…è§’è‰²
      fetch('/api/get-session')
        .then(res => res.json())
        .then(data => {
          role = data.success ? data.role : 'visitor';
          if (role !== 'student') {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">è«‹ä½¿ç”¨å­¸ç”Ÿå¸³è™Ÿç™»å…¥ä»¥æŸ¥çœ‹å±¥æ­·ç´€éŒ„ã€‚</td></tr>`;
            return;
          }
          loadResumes();
        });

      // é€å‡ºå±¥æ­·è¡¨å–®
      document.getElementById('applicationForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch('/api/generate_resume', { method: 'POST', body: formData })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              alert('å±¥æ­·å·²ç”Ÿæˆä¸¦æäº¤æˆåŠŸï¼');
              const tabTrigger = new bootstrap.Tab(document.getElementById('records-tab'));
              tabTrigger.show(); // åˆ‡æ›åˆ°ç´€éŒ„é ç±¤
              loadResumes();
            } else {
              alert(`æäº¤å¤±æ•—ï¼š${data.message || 'æœªçŸ¥éŒ¯èª¤'}`);
            }
          })
          .catch(() => alert('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚'));
      });

      // è¼‰å…¥å±¥æ­·ç´€éŒ„
      function loadResumes() {
        fetch('/api/get_my_resumes')
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              resumesData = data.resumes;
              renderTable(currentFilter); // âœ… æ”¹æˆä½¿ç”¨ç›®å‰ç¯©é¸æ¢ä»¶
            } else {
              tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">è¼‰å…¥å¤±æ•—ã€‚</td></tr>`;
            }
          })
          .catch(() => tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">ç¶²è·¯éŒ¯èª¤ã€‚</td></tr>`);
      }

      // æ¸²æŸ“è¡¨æ ¼
      function renderTable(filter = 'all') { // âœ… åŠ ä¸Šé è¨­å€¼
        tbody.innerHTML = '';

        // è¨ˆç®—å„å€‹ç‹€æ…‹çš„æ•¸é‡
        const statusCounts = {
          uploaded: resumesData.filter(r => r.status === 'uploaded').length,
          reviewing: resumesData.filter(r => r.status === 'reviewing').length,
          approved: resumesData.filter(r => r.status === 'approved').length,
          rejected: resumesData.filter(r => r.status === 'rejected').length
        };

        // æ›´æ–°æŒ‰éˆ•æ–‡å­—
        document.getElementById('uploadedCountBtn').textContent = `å·²ä¸Šå‚³ (${statusCounts.uploaded})`;
        document.getElementById('approvedCountBtn').textContent = `å¯©æŸ¥å®Œæˆ (${statusCounts.approved})`;
        document.getElementById('rejectedCountBtn').textContent = `å·²é€€ä»¶ (${statusCounts.rejected})`;

        const filtered = filter === 'all' ? resumesData : resumesData.filter(r => r.status === filter);
        if (filtered.length === 0) {
          tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">ç„¡è³‡æ–™</td></tr>`;
          return;
        }

        filtered.forEach(r => {
          const commentView = `
            <div class="view-text" onclick="showCommentEditor(this, ${r.id})" style="cursor:pointer;">
              <span class="${r.comment?.trim() ? '' : 'text-muted'}">${r.comment?.trim() ? 'è«‹æŸ¥çœ‹' : 'ç„¡å…§å®¹'}</span>
            </div>
            <div class="editor-box" style="display:none;">
              <textarea readonly style="background-color:#f9f9f9;" placeholder="ç„¡å…§å®¹">${escapeHtml(r.comment)}</textarea><br/>
              <button class="btn btn-sm btn-secondary" onclick="cancelEdit(this)">è¿”å›</button>
            </div>`;

          const noteView = `
            <div class="view-text" onclick="showNoteEditor(this, ${r.id})" style="cursor:pointer;">
              <span class="${r.note?.trim() ? '' : 'text-muted'}">${r.note?.trim() ? 'å·²å¡«å¯«' : 'æœªå¡«å¯«'}</span>
            </div>
            <div class="editor-box" style="display:none;">
              <textarea onkeydown="handleNoteKeydown(event, this, ${r.id})" placeholder="è«‹è¼¸å…¥å‚™è¨»...">${escapeHtml(r.note)}</textarea><br/>
              <button class="btn btn-sm btn-primary" onclick="submitNote(this, ${r.id})">é€å‡º</button>
              <button class="btn btn-sm btn-secondary" onclick="cancelEdit(this)">å–æ¶ˆ</button>
            </div>`;

          const rowHTML = `
            <tr>
              <td>${new Date(r.upload_time).toLocaleString()}</td>
              <td>${r.original_filename}</td>
              <td><span class="badge bg-${statusColor(r.status)}">${mapStatus(r.status)}</span></td>
              <td class="comment-cell">${commentView}</td>
              <td class="note-cell">${noteView}</td>
              <td>
                <a href="/api/download_resume/${r.id}" class="btn btn-outline-primary btn-sm me-1">ä¸‹è¼‰</a>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteResume(${r.id})">åˆªé™¤</button>
              </td>
            </tr>`;
          tbody.insertAdjacentHTML('beforeend', rowHTML);
        });
      }

      // âœ… ç¯©é¸æŒ‰éˆ•æ§åˆ¶
      window.filterStatus = function (filter, btn) {
        currentFilter = filter;
        document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderTable(filter);
      };

      function mapStatus(status) {
        return {
          uploaded: 'å·²ä¸Šå‚³',
          reviewing: 'å¯©æŸ¥ä¸­',
          approved: 'å®Œæˆ',
          rejected: 'é€€ä»¶'
        }[status] || 'æœªçŸ¥';
      }

      function statusColor(status) {
        return {
          uploaded: 'info',
          reviewing: 'warning',
          approved: 'success',
          rejected: 'danger'
        }[status] || 'secondary';
      }

      window.showCommentEditor = function (container) {
        const td = container.closest('td');
        td.querySelector('.view-text').style.display = 'none';
        td.querySelector('.editor-box').style.display = 'block';
      };

      window.showNoteEditor = function (container) {
        const td = container.closest('td');
        td.querySelector('.view-text').style.display = 'none';
        td.querySelector('.editor-box').style.display = 'block';
        td.querySelector('textarea').focus();
      };

      window.cancelEdit = function (btn) {
        const td = btn.closest('td');
        td.querySelector('.editor-box').style.display = 'none';
        td.querySelector('.view-text').style.display = 'flex';
      };

      window.submitNote = function (btn, id) {
        const td = btn.closest('td');
        const newVal = td.querySelector('textarea').value.trim();
        updateField(id, 'note', newVal, td);
      };

      window.deleteResume = function (id) {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ä»½å±¥æ­·ï¼Ÿ")) return;
        fetch(`/api/delete_resume?resume_id=${id}`, { method: 'DELETE' })
          .then(res => res.json())
          .then(data => {
            if (data.success) loadResumes();
            else alert("åˆªé™¤å¤±æ•—");
          });
      };

      function escapeHtml(text) {
        if (!text) return '';
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;")
          .replace(/>/g, "&gt;").replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function updateField(id, field, value, td) {
        fetch('/api/update_resume_field', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ resume_id: id, field, value })
        })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              td.querySelector('.view-text span').textContent = value ? 'å·²å¡«å¯«' : 'æœªå¡«å¯«';
              td.querySelector('.view-text span').className = value ? '' : 'text-muted';
              td.querySelector('.editor-box').style.display = 'none';
              td.querySelector('.view-text').style.display = 'flex';
            } else {
              alert("æ›´æ–°å¤±æ•—");
            }
          });
      }
    });
  </script>
</body>

</html>
