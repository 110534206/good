<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>智慧實習平台 | 履歷管理平台</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    header {
      background: #0454a3;
      color: white;
      padding: 1rem 2rem;
      text-align: center;
      font-size: 1.5rem;
    }

    body {
      font-family: "Noto Sans TC", sans-serif;
      background: #f7f9fc;
    }

    .container {
      max-width: 1000px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .card {
      border-radius: 10px;
    }

    table {
      font-size: 0.95rem;
    }

    /*用於語文能力的水平排列 */
    .language-group {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .language-group label {
      margin-right: 15px;
      width: 50px;
      /* 調整標籤寬度 */
    }
  </style>
</head>

<body>
  <header>智慧實習平台 | 履歷管理平台</header>

  <div class="container">
    <div class="card p-4">
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="form-tab" data-bs-toggle="tab" data-bs-target="#form-pane" type="button"
            role="tab" aria-controls="form-pane" aria-selected="true">
            表單填寫
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="records-tab" data-bs-toggle="tab" data-bs-target="#records-pane" type="button"
            role="tab" aria-controls="records-pane" aria-selected="false">
            紀錄下載
          </button>
        </li>
      </ul>

      <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="form-pane" role="tabpanel" aria-labelledby="form-tab" tabindex="0">
          <h5 class="mt-4 mb-3">個人基本資料</h5>
          <form id="resumeForm" enctype="multipart/form-data">
            <div class="row g-3">
              <div class="col-md-4">
                <label for="name" class="form-label">姓名</label>
                <input type="text" class="form-control" id="name" name="name" required />
              </div>
              <div class="col-md-4">
                <label for="birth_date" class="form-label">生日</label>
                <input type="date" class="form-control" id="birth_date" name="birth_date" required />
              </div>
              <div class="col-md-4">
                <label for="gender" class="form-label">性別</label>
                <select class="form-select" id="gender" name="gender" required>
                  <option value="">選擇...</option>
                  <option value="男">男</option>
                  <option value="女">女</option>
                  <option value="其他">其他</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="phone" class="form-label">聯絡電話</label>
                <input type="tel" class="form-control" id="phone" name="phone" required />
              </div>
              <div class="col-md-6">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" name="email" required />
              </div>
              <div class="col-12">
                <label for="address" class="form-label">通訊地址</label>
                <input type="text" class="form-control" id="address" name="address" required />
              </div>
              <div class="col-md-6">
                <label for="conduct_score" class="form-label">操行成績 (請輸入分數 0-100)</label>
                <input type="number" class="form-control" id="conduct_score" name="conduct_score" min="0" max="100"
                  required />
              </div>
              <div class="col-md-6">
                <label for="photo" class="form-label">個人大頭照 (JPG/PNG)</label>
                <input class="form-control" type="file" id="photo" name="photo" accept="image/*" />
              </div>
            </div>

            <h5 class="mt-4 mb-3">自傳</h5>
            <div class="row">
              <div class="col-12">
                <textarea class="form-control" id="autobiography" name="autobiography" rows="5" required></textarea>
              </div>
            </div>

            <h5 class="mt-4 mb-3">學業成績</h5>
            <div class="table-responsive">
              <table class="table table-bordered" id="coursesTable">
                <thead>
                  <tr>
                    <th>課程名稱</th>
                    <th>學分</th>
                    <th>成績 (分數或等級)</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="4" class="text-end">
                      <button type="button" class="btn btn-sm btn-outline-primary" id="addCourseBtn">
                        新增課程
                      </button>
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>

            <h5 class="mt-4 mb-3">語文能力</h5>
            <div class="row">
              <div class="col-md-3 language-group">
                <label>英語</label>
                <select class="form-select form-select-sm" name="lang_en_level">
                  <option value="">未選</option>
                  <option value="精通">精通</option>
                  <option value="中等">中等</option>
                  <option value="略懂">略懂</option>
                </select>
              </div>
              <div class="col-md-3 language-group">
                <label>台語</label>
                <select class="form-select form-select-sm" name="lang_tw_level">
                  <option value="">未選</option>
                  <option value="精通">精通</option>
                  <option value="中等">中等</option>
                  <option value="略懂">略懂</option>
                </select>
              </div>
              <div class="col-md-3 language-group">
                <label>日語</label>
                <select class="form-select form-select-sm" name="lang_jp_level">
                  <option value="">未選</option>
                  <option value="精通">精通</option>
                  <option value="中等">中等</option>
                  <option value="略懂">略懂</option>
                </select>
              </div>
              <div class="col-md-3 language-group">
                <label>客語</label>
                <select class="form-select form-select-sm" name="lang_hk_level">
                  <option value="">未選</option>
                  <option value="精通">精通</option>
                  <option value="中等">中等</option>
                  <option value="略懂">略懂</option>
                </select>
              </div>
            </div>


            <h5 class="mt-4 mb-3">檔案上傳</h5>
            <div class="row g-3">
              <div class="col-md-6">
                <label for="transcript_file" class="form-label">成績單圖片 (JPG/PNG)</label>
                <input class="form-control" type="file" id="transcript_file" name="transcript_file" accept="image/*" />
                <small class="form-text text-muted">用於 Word 文件內成績單區塊。</small>
              </div>

              <div class="col-md-6">
                <label for="cert_photos" class="form-label">
                  證照圖片 (請上傳實體圖片檔，最多8張)
                </label>
                <input class="form-control" type="file" id="cert_photos" name="cert_photos[]" multiple
                  accept="image/*" />
                <small class="form-text text-muted">點選後可多選，圖片會依序顯示在履歷中。</small>
              </div>

              <div class="col-12">
                <div id="certNameContainer" class="p-3 border rounded"
                  style="display: none; background-color: #f0f7ff;">
                  <strong>請為您上傳的證照填寫名稱（必填）：</strong>
                </div>
              </div>
            </div>


            <div class="text-center mt-5">
              <button type="submit" class="btn btn-primary btn-lg">
                提交表單並生成履歷 (Word)
              </button>
            </div>
          </form>
        </div>

        <div class="tab-pane fade" id="records-pane" role="tabpanel" aria-labelledby="records-tab" tabindex="0">
          <h5 class="mt-4 mb-3">已生成履歷紀錄</h5>
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>上傳時間</th>
                  <th>檔案名稱</th>
                  <th>狀態</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="recordsBody">
                <tr>
                  <td colspan="4" class="text-muted text-center">載入中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const resumeForm = document.getElementById('resumeForm');
      const coursesTableBody = document.querySelector('#coursesTable tbody');
      const addCourseBtn = document.getElementById('addCourseBtn');
      const certFileInput = document.getElementById('cert_photos');
      const certNameContainer = document.getElementById('certNameContainer');

      let courseCounter = 0;

      // --- 課程表格操作 ---
      function addCourseRow(course = { name: '', credits: '', grade: '' }) {
        const row = coursesTableBody.insertRow();
        row.id = `course-row-${courseCounter}`;
        row.innerHTML = `
                <td><input type="text" class="form-control form-control-sm" name="course_name" value="${course.name}" required></td>
                <td><input type="number" class="form-control form-control-sm" name="course_credits" value="${course.credits}" step="0.5" required></td>
                <td><input type="text" class="form-control form-control-sm" name="course_grade" value="${course.grade}" required></td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger remove-course-btn" data-id="${courseCounter}">
                        移除
                    </button>
                </td>
            `;
        courseCounter++;
      }

      // 預設添加 3 行課程
      for (let i = 0; i < 3; i++) {
        addCourseRow();
      }

      addCourseBtn.addEventListener('click', () => addCourseRow());

      coursesTableBody.addEventListener('click', function (e) {
        if (e.target.classList.contains('remove-course-btn')) {
          e.target.closest('tr').remove();
        }
      });

      // --- 證照名稱動態生成 ---
      certFileInput.addEventListener('change', function (event) {
        const files = event.target.files;
        const maxCerts = 8;

        certNameContainer.innerHTML = ''; // 清空舊的名稱輸入框

        if (files.length > 0) {
          certNameContainer.style.display = 'block';

          // 限制最多只處理 8 個檔案
          const filesToProcess = Array.from(files).slice(0, maxCerts);

          filesToProcess.forEach((file, index) => {
            const certIndex = index + 1;
            // 嘗試安全地獲取副檔名
            const fileExtension = file.name.split('.').pop() || '';

            // 每個證照一個 Group
            const inputGroup = document.createElement('div');
            inputGroup.className = 'input-group mb-2';

            // 顯示圖片序號和檔案名稱
            const span = document.createElement('span');
            span.className = 'input-group-text';
            // 僅顯示前 30 個字元的檔案名稱
            const displayName = file.name.length > 30 ? file.name.substring(0, 30) + '...' + fileExtension : file.name;
            span.textContent = `第 ${certIndex} 張 (${displayName}):`;

            // 實際輸入框
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control';
            input.placeholder = '請輸入證照或文件名稱 (例：勞動部乙級技術士)';

            // *** 關鍵：使用與 Python 後端預期一致的陣列名稱 ***
            input.name = 'cert_names[]';
            input.required = true; // 強制填寫名稱

            inputGroup.appendChild(span);
            inputGroup.appendChild(input);
            certNameContainer.appendChild(inputGroup);
          });

          if (files.length > maxCerts) {
            // 超過 8 張圖的提示
            certNameContainer.insertAdjacentHTML('beforeend', `<p class="text-danger mt-2">❗ 您上傳了 ${files.length} 張圖，但系統只處理前 ${maxCerts} 張。</p>`);
          }
        } else {
          certNameContainer.style.display = 'none';
        }
      });


      // --- 表單提交處理 ---
      resumeForm.addEventListener('submit', async function (e) {
        e.preventDefault();

        // 1. 收集課程資料
        const courses = [];
        const rows = coursesTableBody.querySelectorAll('tr');
        rows.forEach(row => {
          const nameInput = row.querySelector('input[name="course_name"]');
          const creditsInput = row.querySelector('input[name="course_credits"]');
          const gradeInput = row.querySelector('input[name="course_grade"]');

          if (nameInput && nameInput.value.trim()) {
            courses.push({
              name: nameInput.value.trim(),
              credits: creditsInput ? creditsInput.value.trim() : '',
              grade: gradeInput ? gradeInput.value.trim() : ''
            });
          }
        });

        // 2. 建立 FormData
        const formData = new FormData(e.target);
        formData.append("courses", JSON.stringify(courses)); // 將課程資料作為 JSON 字串傳輸

        // 3. 提交
        const submitBtn = e.submitter;
        submitBtn.disabled = true;
        submitBtn.textContent = '提交中... 請稍候';

        try {
          const res = await fetch("/api/submit_and_generate", {
            method: "POST",
            body: formData
          });
          const result = await res.json();

          if (result.success) {
            alert("✅ 履歷已生成，請切換至紀錄頁籤下載");
            // 切換到紀錄頁籤
            const tabTrigger = new bootstrap.Tab(document.querySelector('[data-bs-target="#records-pane"]'));
            tabTrigger.show();
            await loadResumeRecords();
          } else {
            alert("❌ 提交失敗：" + (result.message || "未知錯誤"));
          }
        } catch (error) {
          alert("❌ 提交時發生網路錯誤：" + error.message);
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = '提交表單並生成履歷 (Word)';
        }
      });

      // --- 紀錄載入 ---
      async function loadResumeRecords() {
        const tbody = document.getElementById("recordsBody");
        tbody.innerHTML = `<tr><td colspan="4" class="text-muted text-center">載入中...</td></tr>`;

        try {
          const res = await fetch("/api/get_my_resumes");
          const result = await res.json();

          tbody.innerHTML = "";

          if (!result.success || !result.resumes || result.resumes.length === 0) {
            tbody.innerHTML = `<tr><td colspan="4" class="text-muted text-center">尚無履歷紀錄</td></tr>`;
            return;
          }

          result.resumes.forEach(r => {
            // 狀態顏色
            let statusBadge = '';
            switch (r.status) {
              case 'approved':
                statusBadge = `<span class="badge bg-success">通過</span>`;
                break;
              case 'rejected':
                statusBadge = `<span class="badge bg-danger">駁回</span>`;
                break;
              case 'pending':
                statusBadge = `<span class="badge bg-warning text-dark">審核中</span>`;
                break;
              case 'generated':
              default:
                statusBadge = `<span class="badge bg-info text-dark">已生成</span>`;
                break;
            }

            tbody.insertAdjacentHTML("beforeend", `
                            <tr>
                                <td>${r.upload_time || "-"}</td>
                                <td>${r.original_filename || "未命名"}</td>
                                <td>${statusBadge}</td>
                                <td>
                                    <a href="/api/download_resume/${r.id}" class="btn btn-sm btn-outline-secondary me-2">
                                        <i class="bi bi-download"></i> 下載文件
                                    </a>
                                </td>
                            </tr>
                        `);
          });
        } catch (error) {
          tbody.innerHTML = `<tr><td colspan="4" class="text-danger text-center">載入紀錄失敗</td></tr>`;
        }
      }

      // 預載入紀錄
      loadResumeRecords();
    });
  </script>
</body>

</html>