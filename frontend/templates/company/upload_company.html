<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä¸Šå‚³å¯¦ç¿’å…¬å¸</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #ffffff;
      font-family: "Noto Sans TC", sans-serif;
      margin: 30px;
      padding-top: 30px;
    }

    /* é ‚ç«¯åˆ— */
    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background-color: #fff;
      z-index: 1100;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .top-bar>.container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 100%;
    }
    
    /* è³‡æ–™é è¦½è¡¨æ ¼æ¨£å¼ */
    .preview-section {
        margin-top: 20px;
    }
    .preview-table {
        font-size: 0.85rem;
    }
  </style>
</head>

<body>
  <div class="top-bar">
    <div class="container">
        <span class="navbar-brand h1 mb-0">å¯¦ç¿’ç®¡ç†ç³»çµ±</span>
        </div>
  </div>
  
  <div class="container" style="padding-top: 40px;">
    <h1>æ‰¹é‡ä¸Šå‚³å¯¦ç¿’å…¬å¸èˆ‡è·ç¼ºè³‡æ–™</h1>
    
    <div class="card p-4 mt-4">
      <h5 class="card-title">æ­¥é©Ÿä¸€ï¼šä¸‹è¼‰èˆ‡å¡«å¯«ç¯„æœ¬</h5>
      <button class="btn btn-info mb-4" onclick="downloadTemplate()">ä¸‹è¼‰å…¬å¸è³‡æ–™èˆ‡è·ç¼ºç¯„æœ¬</button>

      <h5 class="card-title">æ­¥é©ŸäºŒï¼šä¸Šå‚³èˆ‡ç€è¦½è³‡æ–™</h5>
      
      <form id="uploadForm" enctype="multipart/form-data">
        <div class="mb-3">
            <label for="excelFile" class="form-label">é¸æ“‡å¡«å¯«å¥½çš„ Excel æª”æ¡ˆ (.xlsx)ï¼š</label>
            <input type="file" class="form-control" id="excelFile" name="excel_file" accept=".xlsx" required>
        </div>
        
        <div class="d-flex gap-3">
            <button type="button" class="btn btn-primary" id="previewButton">
                <span id="loadingSpinner" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
                è¼‰å…¥ä¸¦é è¦½æª”æ¡ˆå…§å®¹
            </button>
            <button type="submit" class="btn btn-success" id="submitButton" disabled>
                ç¢ºèªè³‡æ–™ç„¡èª¤ï¼Œä¸Šå‚³è‡³ç³»çµ±
            </button>
        </div>
        <div id="statusMessage" class="mt-3"></div>
      </form>
    </div>

    <div id="previewSection" class="preview-section d-none">
        <h2>è³‡æ–™é è¦½</h2>
        
        <h4 class="mt-4">å…¬å¸è³‡æ–™ (<span id="companyCount">0</span> ç­†)</h4>
        <div class="table-responsive">
            <table class="table table-bordered table-striped preview-table">
                <thead id="companyHeader"></thead>
                <tbody id="companyBody"></tbody>
            </table>
        </div>

        <h4 class="mt-4">å¯¦ç¿’è·ç¼º (<span id="jobsCount">0</span> ç­†)</h4>
        <div class="table-responsive">
            <table class="table table-bordered table-striped preview-table">
                <thead id="jobsHeader"></thead>
                <tbody id="jobsBody"></tbody>
            </table>
        </div>
    </div>
    
    </div>
  
  
  <script>
    // =========================================================
    // 1. å®šç¾©å›ºå®šçš„æ¨™é¡Œé †åº (èˆ‡æ‚¨çš„ Excel æ¬„ä½é †åºä¸€è‡´)
    // =========================================================
    const COMPANY_HEADERS_ORDER = [
        "å…¬å¸åç¨±", 
        "å…¬å¸ç°¡ä»‹", 
        "å…¬å¸åœ°å€", 
        "è¯çµ¡äººå§“å", 
        "è¯çµ¡äººè·ç¨±", 
        "è¯çµ¡ä¿¡ç®±", 
        "è¯çµ¡é›»è©±"
    ];

    const JOBS_HEADERS_ORDER = [
        "å…¬å¸åç¨±", // å¾Œç«¯é—œè¯é‚è¼¯éœ€è¦æ­¤æ¬„ä½
        "å¯¦ç¿’è·ä½", 
        "å¯¦ç¿’å…§å®¹", 
        "è–ªè³‡", 
        "å¯¦ç¿’æœŸé–“", 
        "å¯¦ç¿’æ™‚æ®µ", 
        "å´—ä½äººæ•¸", 
        "å‚™è¨»"
    ];


    // =========================================================
    // 2. è¼”åŠ©å‡½å¼ï¼šå‹•æ…‹ç”Ÿæˆè¡¨æ ¼
    // =========================================================
    function renderTable(data, headerId, bodyId, countId, headersOrder) {
        const headerElement = document.getElementById(headerId);
        const bodyElement = document.getElementById(bodyId);
        const countElement = document.getElementById(countId);
        
        headerElement.innerHTML = '';
        bodyElement.innerHTML = '';
        countElement.textContent = data.length;

        if (data.length === 0) {
            bodyElement.innerHTML = `<tr><td colspan="${headersOrder.length}">æ²’æœ‰è³‡æ–™</td></tr>`;
            return;
        }

        // 1. ç”Ÿæˆè¡¨é ­
        const headerRow = document.createElement('tr');
        headersOrder.forEach(key => {
            const th = document.createElement('th');
            th.textContent = key;
            headerRow.appendChild(th);
        });
        headerElement.appendChild(headerRow);

        // 2. ç”Ÿæˆè¡¨æ ¼å…§å®¹
        data.forEach(rowObj => {
            const row = document.createElement('tr');
            
            // ä½¿ç”¨å›ºå®šçš„ headersOrder ä¾†è¿­ä»£ä¸¦å–å€¼
            headersOrder.forEach(key => {
                const td = document.createElement('td');
                const cellValue = rowObj[key] !== undefined ? String(rowObj[key]) : '';
                
                // é™åˆ¶é¡¯ç¤ºé•·åº¦ï¼Œé¿å…å–®å…ƒæ ¼å…§å®¹éé•·
                td.textContent = cellValue.length > 100 ? 
                                 cellValue.substring(0, 100) + '...' : 
                                 cellValue;
                row.appendChild(td);
            });
            bodyElement.appendChild(row);
        });
    }

    // =========================================================
    // 3. ä¸‹è¼‰ç¯„æœ¬ (ç™¼é€è·¯ç”±è«‹æ±‚)
    // =========================================================
    function downloadTemplate() {
        window.location.href = '/download_company_template';
    }


    // =========================================================
    // 4. ç€è¦½åŠŸèƒ½å‡½å¼ (ç™¼é€æª”æ¡ˆåˆ°å¾Œç«¯è§£æä¸¦å„²å­˜åˆ° Session)
    // =========================================================
    async function previewExcelData() {
        const fileInput = document.getElementById('excelFile');
        const file = fileInput.files[0];
        const previewSection = document.getElementById('previewSection');
        const submitButton = document.getElementById('submitButton');
        const statusMessage = document.getElementById('statusMessage');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const previewButton = document.getElementById('previewButton');


        if (!file) {
            statusMessage.className = 'mt-3 text-danger';
            statusMessage.textContent = 'è«‹å…ˆé¸æ“‡ Excel æª”æ¡ˆã€‚';
            return;
        }

        loadingSpinner.classList.remove('d-none');
        statusMessage.textContent = 'æ­£åœ¨è¼‰å…¥ä¸¦è§£ææª”æ¡ˆ...';
        submitButton.disabled = true; 
        previewButton.disabled = true; // é–å®šé è¦½æŒ‰éˆ•é˜²æ­¢é‡è¤‡é»æ“Š
        sessionStorage.removeItem('companyPreviewData'); // é–‹å§‹æ–°çš„é è¦½ï¼Œå…ˆæ¸…é™¤èˆŠè³‡æ–™
        
        const formData = new FormData();
        formData.append('excel_file', file);
        formData.append('action', 'preview');

        try {
            const response = await fetch('/upload_company', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                // âœ… æª”æ¡ˆè§£ææˆåŠŸ
                
                // ğŸ¯ ä¿®æ­£é» 1: å°‡æˆåŠŸè§£æçš„è³‡æ–™å„²å­˜åˆ° sessionStorage
                sessionStorage.setItem('companyPreviewData', JSON.stringify(result));
                
                previewSection.classList.remove('d-none');
                
                // å‹•æ…‹ç”Ÿæˆè¡¨æ ¼
                renderTable(result.company_data, 'companyHeader', 'companyBody', 'companyCount', COMPANY_HEADERS_ORDER);
                renderTable(result.jobs_data, 'jobsHeader', 'jobsBody', 'jobsCount', JOBS_HEADERS_ORDER);

                statusMessage.className = 'mt-3 text-success';
                statusMessage.textContent = `æª”æ¡ˆè§£ææˆåŠŸï¼å…¬å¸ç­†æ•¸: ${result.company_data.length} ç­†ï¼Œè·ç¼ºç­†æ•¸: ${result.jobs_data.length} ç­†ã€‚è«‹ç¢ºèªå¾Œå†ä¸Šå‚³ã€‚`;
                submitButton.disabled = false;
                previewButton.disabled = true; // é è¦½æˆåŠŸå¾Œé–å®šï¼Œé¿å…æ··æ·†
                

            } else {
                // âŒ æª”æ¡ˆè§£æå¤±æ•—
                previewSection.classList.add('d-none');
                statusMessage.className = 'mt-3 text-danger';
                statusMessage.textContent = 'æª”æ¡ˆè§£æå¤±æ•—: ' + result.message;
                submitButton.disabled = true;
                previewButton.disabled = false; // å¤±æ•—å‰‡è§£é–ï¼Œå…è¨±ç”¨æˆ¶é‡æ–°é¸æ“‡æª”æ¡ˆ
            }
        } catch (error) {
            previewSection.classList.add('d-none');
            statusMessage.className = 'mt-3 text-danger';
            statusMessage.textContent = 'é€£ç·šæˆ–ç€è¦½ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ä¼ºæœå™¨é€£ç·šã€‚';
            console.error('ç€è¦½å¤±æ•—:', error);
            submitButton.disabled = true;
            previewButton.disabled = false;
        } finally {
            loadingSpinner.classList.add('d-none');
        }
    }


    // =========================================================
    // 5. è¼‰å…¥ Session è³‡æ–™çš„å‡½å¼
    // =========================================================
    function loadPreviewFromSession() {
        const storedData = sessionStorage.getItem('companyPreviewData');
        const submitButton = document.getElementById('submitButton');
        const statusMessage = document.getElementById('statusMessage');
        const previewButton = document.getElementById('previewButton');

        if (storedData) {
            try {
                const result = JSON.parse(storedData);
                
                // é‡æ–°æ¸²æŸ“è¡¨æ ¼
                renderTable(result.company_data, 'companyHeader', 'companyBody', 'companyCount', COMPANY_HEADERS_ORDER);
                renderTable(result.jobs_data, 'jobsHeader', 'jobsBody', 'jobsCount', JOBS_HEADERS_ORDER);

                // æ¢å¾©é é¢ç‹€æ…‹
                document.getElementById('previewSection').classList.remove('d-none');
                statusMessage.className = 'mt-3 text-success';
                statusMessage.textContent = `å·²å¾ä¸Šæ¬¡æœƒè©±æ¢å¾©é è¦½è³‡æ–™ã€‚å…¬å¸ç­†æ•¸: ${result.company_data.length} ç­†ï¼Œè·ç¼ºç­†æ•¸: ${result.jobs_data.length} ç­†ã€‚è«‹ç¢ºèªå¾Œå†ä¸Šå‚³ã€‚`;
                submitButton.disabled = false;
                
                // æª”æ¡ˆè¼¸å…¥æ¡†æ¸…ç©ºï¼Œä¸”é è¦½æŒ‰éˆ•é–å®š
                document.getElementById('excelFile').value = ''; 
                previewButton.disabled = true; 

            } catch (e) {
                console.error("è§£æ sessionStorage è³‡æ–™å¤±æ•—:", e);
                sessionStorage.removeItem('companyPreviewData');
            }
        } else {
            // å¦‚æœæ²’æœ‰ storedDataï¼Œå‰‡ç¢ºä¿é è¦½æŒ‰éˆ•æ˜¯å•Ÿç”¨çš„
            previewButton.disabled = false;
        }
    }


    // =========================================================
    // 6. é é¢å°±ç·’äº‹ä»¶åŠäº‹ä»¶ç›£è½
    // =========================================================
    document.addEventListener('DOMContentLoaded', () => {
        
        // ğŸš¨ é é¢è¼‰å…¥æ™‚åŸ·è¡Œæ¢å¾©æ“ä½œ
        loadPreviewFromSession(); 

        const previewButton = document.getElementById('previewButton');
        if (previewButton) {
            previewButton.addEventListener('click', previewExcelData);
        }
        
        // ç›£è½æª”æ¡ˆè¼¸å…¥æ¡†çš„è®ŠåŒ–ï¼Œ**ä¸¦åœ¨æœ‰æ–°æª”æ¡ˆæ™‚æ¸…é™¤ session å„²å­˜**
        document.getElementById('excelFile').addEventListener('change', () => {
            document.getElementById('previewSection').classList.add('d-none');
            document.getElementById('statusMessage').textContent = '';
            document.getElementById('submitButton').disabled = true;
            
            // ğŸš¨ æ¸…é™¤ sessionStorageï¼Œä¸¦é‡æ–°å•Ÿç”¨é è¦½æŒ‰éˆ•
            sessionStorage.removeItem('companyPreviewData');
            document.getElementById('previewButton').disabled = false; 
        });

        // ç›£è½ã€Œç¢ºèªä¸¦ä¸Šå‚³è‡³ç³»çµ±ã€æŒ‰éˆ•çš„è¡¨å–®æäº¤äº‹ä»¶
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault(); 
            
            const fileInput = document.getElementById('excelFile');
            const submitButton = document.getElementById('submitButton');
            const statusMessage = document.getElementById('statusMessage');
            
            // å¦‚æœæ˜¯å¾ session æ¢å¾©çš„ï¼ŒfileInput.files[0] æœƒæ˜¯ undefinedï¼Œæ­¤æ™‚éœ€è¦æª¢æŸ¥ session
            const file = fileInput.files[0];
            const hasSessionData = sessionStorage.getItem('companyPreviewData') !== null;
            
            if (submitButton.disabled || (!file && !hasSessionData)) {
                 statusMessage.className = 'mt-3 text-warning';
                 statusMessage.textContent = 'è«‹å…ˆé»æ“Šã€Œè¼‰å…¥ä¸¦é è¦½æª”æ¡ˆå…§å®¹ã€ç¢ºèªè³‡æ–™ç„¡èª¤ã€‚';
                 return;
            }

            // æœ€çµ‚ä¸Šå‚³é‚è¼¯
            statusMessage.className = 'mt-3 text-info';
            statusMessage.textContent = 'æ­£åœ¨é€²è¡Œæœ€çµ‚ä¸Šå‚³ (è³‡æ–™åº«å¯«å…¥)...';
            submitButton.disabled = true; 

            // å¦‚æœæ˜¯å¾ session æ¢å¾©çš„ï¼Œå‰‡å¿…é ˆé‡æ–°åŸ·è¡Œé è¦½é‚è¼¯ä¾†å–å¾—æª”æ¡ˆç‰©ä»¶æˆ–ç¢ºä¿å¾Œç«¯é‚è¼¯èƒ½å¤ è™•ç†
            // æœ€ä½³åšæ³•æ˜¯ç¢ºä¿ä¸Šå‚³æ™‚åªèƒ½ä½¿ç”¨æª”æ¡ˆæˆ–é˜»æ­¢ session æ¢å¾©æ™‚çš„æäº¤ï¼Œä½†æ­¤è™•éµå¾ªç”¨æˆ¶æµç¨‹ï¼š
            // ç”±æ–¼å¾Œç«¯éœ€è¦æ–‡ä»¶ï¼Œå¦‚æœæ²’æœ‰æ–°æ–‡ä»¶ï¼Œå‰‡å¿…é ˆæç¤ºç”¨æˆ¶é‡æ–°è¼‰å…¥æ–‡ä»¶ã€‚
            if (!file) {
                 statusMessage.className = 'mt-3 text-danger';
                 statusMessage.textContent = 'âŒ æœ€çµ‚ä¸Šå‚³å¤±æ•—ï¼šè«‹é‡æ–°é¸æ“‡ Excel æª”æ¡ˆï¼Œä¸¦é»æ“Šé è¦½æŒ‰éˆ•ã€‚';
                 submitButton.disabled = false;
                 return;
            }

            const formData = new FormData();
            formData.append('excel_file', file);
            formData.append('action', 'final_submit'); 

            try {
                const response = await fetch('/upload_company', { 
                    method: 'POST', 
                    body: formData 
                });
                
                const result = await response.json();

                if (result.success) {
                    statusMessage.className = 'mt-3 text-success';
                    statusMessage.textContent = 'âœ… è³‡æ–™å·²æˆåŠŸä¸Šå‚³è‡³ç³»çµ±ä¸¦å„²å­˜ï¼';
                    
                    // ğŸš¨ ä¿®æ­£é» 4: æœ€çµ‚æäº¤æˆåŠŸå¾Œæ¸…é™¤ sessionStorage
                    sessionStorage.removeItem('companyPreviewData');
                    
                    document.getElementById('previewButton').disabled = true;
                } else {
                    statusMessage.className = 'mt-3 text-danger';
                    statusMessage.textContent = 'âŒ è³‡æ–™ä¸Šå‚³å¤±æ•—: ' + result.message;
                    submitButton.disabled = false; 
                }

            } catch (error) {
                statusMessage.className = 'mt-3 text-danger';
                statusMessage.textContent = 'âŒ æœ€çµ‚ä¸Šå‚³é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚';
                submitButton.disabled = false;
            }

        });

    });

  </script>
  </body>

</html>