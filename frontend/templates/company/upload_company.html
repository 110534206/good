<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ™ºæ…§å¯¦ç¿’å¹³å° | å¡«å¯«å¯¦ç¿’å…¬å¸è³‡æ–™</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #ffffff;
      font-family: "Noto Sans TC", sans-serif;
      margin-top: 80px;
    }

    /* é ‚ç«¯åˆ— */
    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background-color: #fff;
      z-index: 1100;
      display: flex;
      align-items: center;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }

    .top-bar>.container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 0.5rem;
      height: 100%;
      gap: 30px;
    }

    .top-bar-left #menu-btn {
      width: 30px;
      height: 22px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      margin-top: -42px;
    }

    .top-bar-left #menu-btn span {
      height: 4px;
      background-color: #333;
      border-radius: 2px;
    }

    .top-bar-right {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: -65px;
      font-weight: bold;
    }

    .top-bar-right .btn-link {
      color: #0066cc;
      background-color: transparent;
      border: 1.5px solid #0066cc;
      padding: 0.3rem 0.7rem;
      border-radius: 6px;
      text-decoration: none;
      transition: background-color 0.3s ease, color 0.3s ease;
      font-size: 0.9rem;
    }

    .top-bar-right .btn-link:hover {
      background-color: #0066cc;
      color: white;
    }

    .container {
      max-width: 1000px;
      margin: auto;
      margin-top: 40px;
    }

    .card {
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.05);
      border-radius: 10px;
    }

    h4.text-center {
      color: #0066cc;
      font-weight: bold;
    }

    .btn-template {
      background-color: #198754;
      color: #fff;
      border: none;
      padding: 0.4rem 0.9rem;
      border-radius: 6px;
      font-weight: 600;
      transition: background-color 0.3s;
    }

    .btn-template:hover {
      background-color: #157347;
    }

    /* å´é‚Šé¸å–® */
    #side-menu {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 320px;
      max-width: 80vw;
      background-color: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(6px);
      box-shadow: 3px 0 12px rgb(0 0 0 / 0.7);
      padding: 2rem 1.5rem;
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
      z-index: 1100;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      color: white;
      user-select: none;
    }

    #side-menu.open {
      transform: translateX(0);
    }

    #close-btn {
      position: absolute;
      top: 2rem;
      right: 1.6rem;
      font-size: 2.2rem;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
    }

    #side-menu a {
      color: #ddd;
      text-decoration: none;
      display: block;
      padding: 0.5rem 0;
    }

    #side-menu a:hover {
      color: white;
    }

    /* æ­·å²ç´€éŒ„è¡¨æ ¼ */
    table thead th,
    table td {
      text-align: center;
      vertical-align: middle;
    }

    .status-badge {
      font-weight: bold;
      border-radius: 5px;
      padding: 0.2rem 0.6rem;
    }
  </style>
</head>

<body>
  <!-- é ‚éƒ¨æ¬„ -->
  <div class="top-bar">
    <div class="container">
      <div class="top-bar-left">
        <div id="menu-btn" title="é¸å–®" role="button">
          <span></span><span></span><span></span>
        </div>
      </div>
      <div class="top-bar-right">
        <a href="/company_home" class="btn-link">è¿”å›ä¸»é </a>
        <a href="/login" class="btn-link">ç™»å‡º</a>
      </div>
    </div>
  </div>

  <div class="container my-5">
  <!-- ä¸Šå‚³å€ -->
  <form id="uploadForm" enctype="multipart/form-data">
    <!-- ğŸ”¹ Word æª”æ¡ˆä¸Šå‚³ -->
    <div class="card p-4 mb-4">
      <h4 class="text-center mb-4 text-primary fw-bold">ä¸Šå‚³å¯¦ç¿’å…¬å¸è³‡æ–™è¡¨</h4>
      <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <label class="form-label fw-bold mb-0">ä¸Šå‚³å…¬å¸è³‡æ–™è¡¨ (.docx)<span class="text-danger">*</span></label>
          <a href="/download_company_template" class="btn btn-template btn-sm" target="_blank">ä¸‹è¼‰ç¯„æœ¬</a>
        </div>
        <input type="file" name="company_doc" class="form-control" accept=".docx,.doc" required>
      </div>
    </div>

    <!-- ğŸ”¹ å…¬å¸åç¨± -->
    <div class="mb-4">
      <label for="company_name" class="form-label fw-bold">å…¬å¸åç¨±<span class="text-danger">*</span></label>
      <input type="text" id="company_name" name="company_name" class="form-control" required placeholder="è«‹è¼¸å…¥å…¬å¸åç¨±">
    </div>

    <!-- ğŸ”¹ è·ç¼ºå€ -->
    <div id="jobsContainer" class="mb-4"></div>
    <button type="button" class="btn btn-outline-success w-100 mb-3" id="addJobBtn">+ æ–°å¢è·ç¼º</button>

    <!-- ğŸ”¹ é€å‡ºæŒ‰éˆ• -->
    <button type="submit" class="btn btn-primary w-100" id="submitBtn">
      <span id="btnText">é€å‡ºä¸¦ä¸Šå‚³</span>
      <div id="spinner" class="spinner-border spinner-border-sm ms-2 d-none"></div>
    </button>

    <!-- ğŸ”¹ ä¸Šå‚³è¨Šæ¯å€ -->
    <div id="msgBox" class="mt-4"></div>
  </form>

  <!-- ğŸ”¹ æ­·å²ç´€éŒ„å€ -->
  <div class="card p-4 mt-5">
    <h5 class="mb-3 fw-bold text-primary">ä¸Šå‚³ç´€éŒ„</h5>
    <table class="table table-bordered table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>ä¸Šå‚³æ™‚é–“</th>
          <th>å…¬å¸åç¨±</th>
          <th>æª”æ¡ˆåç¨±</th>
          <th>å¯©æ ¸ç‹€æ…‹</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="historyTableBody">
        <tr><td colspan="5" class="text-muted text-center">è¼‰å…¥ä¸­...</td></tr>
      </tbody>
    </table>
  </div>
</div>

  <!-- å´é‚Šé¸å–® -->
  <nav id="side-menu">
    <button id="close-btn">Ã—</button>
    <h2>åŠŸèƒ½é¸å–®</h2>
    <a href="/company_home">é¦–é </a>
    <a href="/upload_company">ä¸Šå‚³å…¬å¸è³‡æ–™</a>
    <a href="/company_review">å¯©æŸ¥ç‹€æ…‹</a>
    <a href="/notifications">é€šçŸ¥</a>
  </nav>

  <script>
    // === å´é‚Šé¸å–®æ§åˆ¶ ===
    document.getElementById('menu-btn').addEventListener('click', () => {
      document.getElementById('side-menu').classList.add('open');
    });
    document.getElementById('close-btn').addEventListener('click', () => {
      document.getElementById('side-menu').classList.remove('open');
    });

    // === è·ç¼ºæ–°å¢å€ ===
    let jobIndex = 0;
    const jobsContainer = document.getElementById('jobsContainer');

    function createJobTemplate(i) {
      return `
      <div class="card p-3 mb-3 border-info border-2 job-item">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <strong class="text-primary">è·ç¼º #${i + 1}</strong>
          <button type="button" class="btn btn-sm btn-outline-danger remove-job-btn" ${i === 0 ? "disabled" : ""}>ç§»é™¤</button>
        </div>
        <div class="mb-3">
          <label class="form-label">è·ç¼ºåç¨±</label>
          <input type="text" name="job[${i}][title]" class="form-control" required>
        </div>
        <div class="mb-3">
          <label class="form-label">é è¨ˆåé¡</label>
          <input type="number" name="job[${i}][slots]" class="form-control" value="1" min="1" required>
        </div>
      </div>`;
    }

    function addJob() {
      jobsContainer.insertAdjacentHTML("beforeend", createJobTemplate(jobIndex));
      jobIndex++;
    }

    document.addEventListener("DOMContentLoaded", () => {
      addJob();
      document.getElementById("addJobBtn").addEventListener("click", addJob);
      loadUploadedCompanies();
    });

    // âœ… æ–°å¢ï¼šäº‹ä»¶ä»£ç†ä¾†è™•ç†å‹•æ…‹æ–°å¢çš„è·ç¼ºç§»é™¤æŒ‰éˆ•
    jobsContainer.addEventListener('click', function (e) {
      if (e.target.classList.contains('remove-job-btn') && !e.target.disabled) {
        e.target.closest('.job-item').remove();
      }
    });

    // === ä¸Šå‚³è™•ç† ===
    document.getElementById("uploadForm").addEventListener("submit", async e => {
      e.preventDefault();
      const btn = document.getElementById("submitBtn");
      const text = document.getElementById("btnText");
      const spinner = document.getElementById("spinner");
      const msg = document.getElementById("msgBox");

      btn.disabled = true;
      text.textContent = "ä¸Šå‚³ä¸­...";
      spinner.classList.remove("d-none");
      msg.innerHTML = "";

      try {
        const res = await fetch("/api/upload_company", {
          method: "POST",
          body: new FormData(e.target)
        });
        const data = await res.json();

        if (data.success) {
          msg.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
          e.target.reset();
          jobsContainer.innerHTML = "";
          jobIndex = 0;
          addJob();
          loadUploadedCompanies(); // âœ… ä¸Šå‚³æˆåŠŸå¾Œé‡æ–°è¼‰å…¥ç´€éŒ„
        } else {
          msg.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
        }
      } catch (err) {
        console.error("ä¸Šå‚³éŒ¯èª¤:", err);
        msg.innerHTML = `<div class="alert alert-danger">ä¼ºæœå™¨éŒ¯èª¤æˆ–ç„¡å›æ‡‰ã€‚</div>`;
      } finally {
        btn.disabled = false;
        text.textContent = "é€å‡ºä¸¦ä¸Šå‚³";
        spinner.classList.add("d-none");
      }
    });

    // === ä¸Šå‚³ç´€éŒ„è¼‰å…¥ ===
    async function loadUploadedCompanies() {
      const tbody = document.getElementById('historyTableBody');
      tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">è¼‰å…¥ä¸­...</td></tr>`;

      try {
        const res = await fetch("/api/get_my_companies");
        const data = await res.json();

        if (res.status === 403) {
          tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹ç´€éŒ„</td></tr>`;
          return;
        }

        if (!data.success || !data.companies || data.companies.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">å°šç„¡ä¸Šå‚³ç´€éŒ„</td></tr>`;
          return;
        }

        tbody.innerHTML = data.companies.map((r, idx) => {
          const displayTime = r.upload_time || formatDateTime(r.submitted_at);
          const filename = r.filename || 'N/A';
          const jobDisplay = r.job_count !== undefined ? `${r.job_count} å€‹è·ç¼º` : 'N/A';

          return `
          <tr>
            <td>${displayTime}</td>
            <td>${r.company_name || '-'}</td>
            <td>${filename}</td>
            <td>
              <span class="status-badge ${r.status === 'approved' ? 'bg-success text-white'
              : r.status === 'rejected' ? 'bg-danger text-white'
                : 'bg-warning text-dark'
            }">
                ${statusText(r.status)}
              </span>
            </td>
            <td>
              <a href="/api/download_company_file/${r.id}" class="btn btn-sm btn-outline-primary">ä¸‹è¼‰</a>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteCompany(${r.id})">åˆªé™¤</button>
            </td>
          </tr>
        `;
        }).join("");

      } catch (error) {
        console.error("è¼‰å…¥æ­·å²ç´€éŒ„ç™¼ç”ŸéŒ¯èª¤:", error);
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</td></tr>`;
      }
    }

    // === ç‹€æ…‹æ–‡å­—è½‰æ› ===
    function statusText(s) {
      if (s === "approved") return "å·²é€šé";
      if (s === "rejected") return "å·²é€€å›";
      if (s === "pending") return "å¾…å¯©æ ¸";
      return s || "-";
    }

    async function deleteCompany(id) {
      if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤ä¸Šå‚³ç´€éŒ„å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚")) return;

      try {
        const res = await fetch(`/api/delete_company/${id}`, { method: "DELETE" });
        const data = await res.json();

        if (data.success) {
          alert("åˆªé™¤æˆåŠŸï¼");
          loadUploadedCompanies(); // âœ… é‡æ–°è¼‰å…¥è¡¨æ ¼
        } else {
          alert("åˆªé™¤å¤±æ•—ï¼š" + (data.message || "æœªçŸ¥éŒ¯èª¤"));
        }
      } catch (err) {
        console.error("åˆªé™¤å…¬å¸è³‡æ–™éŒ¯èª¤:", err);
        alert("ä¼ºæœå™¨éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
      }
    }

    function formatDateTime(dt) {
      if (!dt) return '-';
      const d = new Date(dt);
      if (isNaN(d)) return dt;
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      const hh = String(d.getHours()).padStart(2, '0');
      const mi = String(d.getMinutes()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }

  </script>
</body>

</html>