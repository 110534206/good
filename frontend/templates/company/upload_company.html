<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>上傳實習公司</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #ffffff;
      font-family: "Noto Sans TC", sans-serif;
      margin: 30px;
      padding-top: 30px;
    }

    /* 頂端列 */
    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background-color: #fff;
      z-index: 1100;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .top-bar>.container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 100%;
    }
    
    /* 資料預覽表格樣式 */
    .preview-section {
        margin-top: 20px;
    }
    .preview-table {
        font-size: 0.85rem;
    }
  </style>
</head>

<body>
  <div class="top-bar">
    <div class="container">
        <span class="navbar-brand h1 mb-0">實習管理系統</span>
        </div>
  </div>
  
  <div class="container" style="padding-top: 40px;">
    <h1>批量上傳實習公司與職缺資料</h1>
    
    <div class="card p-4 mt-4">
      <h5 class="card-title">步驟一：下載與填寫範本</h5>
      <button class="btn btn-info mb-4" onclick="downloadTemplate()">下載公司資料與職缺範本</button>

      <h5 class="card-title">步驟二：上傳與瀏覽資料</h5>
      
      <form id="uploadForm" enctype="multipart/form-data">
        <div class="mb-3">
            <label for="excelFile" class="form-label">選擇填寫好的 Excel 檔案 (.xlsx)：</label>
            <input type="file" class="form-control" id="excelFile" name="excel_file" accept=".xlsx" required>
        </div>
        
        <div class="d-flex gap-3">
            <button type="button" class="btn btn-primary" id="previewButton">
                <span id="loadingSpinner" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
                載入並預覽檔案內容
            </button>
            <button type="submit" class="btn btn-success" id="submitButton" disabled>
                確認資料無誤，上傳至系統
            </button>
        </div>
        <div id="statusMessage" class="mt-3"></div>
      </form>
    </div>

    <div id="previewSection" class="preview-section d-none">
        <h2>資料預覽</h2>
        
        <h4 class="mt-4">公司資料 (<span id="companyCount">0</span> 筆)</h4>
        <div class="table-responsive">
            <table class="table table-bordered table-striped preview-table">
                <thead id="companyHeader"></thead>
                <tbody id="companyBody"></tbody>
            </table>
        </div>

        <h4 class="mt-4">實習職缺 (<span id="jobsCount">0</span> 筆)</h4>
        <div class="table-responsive">
            <table class="table table-bordered table-striped preview-table">
                <thead id="jobsHeader"></thead>
                <tbody id="jobsBody"></tbody>
            </table>
        </div>
    </div>
    
    </div>
  
  
  <script>
    // =========================================================
    // 輔助函式：動態生成表格
    // =========================================================
    function renderTable(data, headerId, bodyId, countId) {
        const headerElement = document.getElementById(headerId);
        const bodyElement = document.getElementById(bodyId);
        const countElement = document.getElementById(countId);
        
        headerElement.innerHTML = '';
        bodyElement.innerHTML = '';
        countElement.textContent = data.length;

        if (data.length === 0) {
            bodyElement.innerHTML = '<tr><td colspan="100">沒有資料</td></tr>';
            return;
        }

        // 1. 生成表頭
        const headers = Object.keys(data[0]);
        const headerRow = document.createElement('tr');
        headers.forEach(key => {
            const th = document.createElement('th');
            th.textContent = key;
            headerRow.appendChild(th);
        });
        headerElement.appendChild(headerRow);

        // 2. 生成表格內容
        data.forEach(rowObj => {
            const row = document.createElement('tr');
            headers.forEach(key => {
                const td = document.createElement('td');
                // 限制顯示長度，避免表格過大
                td.textContent = String(rowObj[key]).length > 100 ? 
                                 String(rowObj[key]).substring(0, 100) + '...' : 
                                 rowObj[key];
                row.appendChild(td);
            });
            bodyElement.appendChild(row);
        });
    }

    // =========================================================
    // 下載範本 (發送路由請求)
    // =========================================================
    function downloadTemplate() {
        // 導向後端下載路由
        window.location.href = '/download_company_template';
    }


    // =========================================================
    // 瀏覽功能函式 (發送檔案到後端解析)
    // =========================================================
    async function previewExcelData() {
        const fileInput = document.getElementById('excelFile');
        const file = fileInput.files[0];
        const previewSection = document.getElementById('previewSection');
        const submitButton = document.getElementById('submitButton');
        const statusMessage = document.getElementById('statusMessage');
        const loadingSpinner = document.getElementById('loadingSpinner');

        if (!file) {
            statusMessage.className = 'mt-3 text-danger';
            statusMessage.textContent = '請先選擇 Excel 檔案。';
            return;
        }

        if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
            statusMessage.className = 'mt-3 text-danger';
            statusMessage.textContent = '請上傳 .xlsx 或 .xls 格式的檔案。';
            return;
        }

        loadingSpinner.classList.remove('d-none');
        statusMessage.textContent = '正在載入並解析檔案...';
        submitButton.disabled = true; // 預先禁用上傳按鈕
        
        const formData = new FormData();
        formData.append('excel_file', file);
        formData.append('action', 'preview'); // 告訴後端這是瀏覽請求

        try {
            const response = await fetch('/upload_company', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                // ✅ 檔案解析成功
                previewSection.classList.remove('d-none');
                
                // 動態生成表格
                renderTable(result.company_data, 'companyHeader', 'companyBody', 'companyCount');
                renderTable(result.jobs_data, 'jobsHeader', 'jobsBody', 'jobsCount');

                statusMessage.className = 'mt-3 text-success';
                statusMessage.textContent = `檔案解析成功！公司筆數: ${result.company_data.length} 筆，職缺筆數: ${result.jobs_data.length} 筆。請確認後再上傳。`;
                submitButton.disabled = false; // 啟用上傳按鈕

            } else {
                // ❌ 檔案解析失敗
                previewSection.classList.add('d-none');
                statusMessage.className = 'mt-3 text-danger';
                statusMessage.textContent = '檔案解析失敗: ' + result.message;
                submitButton.disabled = true;
            }
        } catch (error) {
            previewSection.classList.add('d-none');
            statusMessage.className = 'mt-3 text-danger';
            statusMessage.textContent = '連線或瀏覽發生錯誤，請檢查伺服器連線。';
            console.error('瀏覽失敗:', error);
            submitButton.disabled = true;
        } finally {
            loadingSpinner.classList.add('d-none');
        }
    }
    
    
    // =========================================================
    // 頁面就緒事件及事件監聽
    // =========================================================
    document.addEventListener('DOMContentLoaded', () => {
        // loadUserAvatar(); // 載入用戶頭像 (保留您原有的邏輯)

        const previewButton = document.getElementById('previewButton');
        if (previewButton) {
            previewButton.addEventListener('click', previewExcelData);
        }
        
        // 監聽檔案輸入框的變化，清除預覽狀態
        document.getElementById('excelFile').addEventListener('change', () => {
            document.getElementById('previewSection').classList.add('d-none');
            document.getElementById('statusMessage').textContent = '';
            document.getElementById('submitButton').disabled = true;
        });

        // 監聽「確認並上傳至系統」按鈕的表單提交事件
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault(); // 阻止表單預設提交行為
            
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            const submitButton = document.getElementById('submitButton');
            const statusMessage = document.getElementById('statusMessage');
            
            if (submitButton.disabled || !file) {
                 statusMessage.className = 'mt-3 text-warning';
                 statusMessage.textContent = '請先點擊「載入並預覽檔案內容」確認資料無誤。';
                 return;
            }

            // 最終上傳邏輯 (將 action 設定為 final_submit)
            statusMessage.className = 'mt-3 text-info';
            statusMessage.textContent = '正在進行最終上傳 (資料庫寫入)...';
            submitButton.disabled = true; // 鎖定按鈕

            const formData = new FormData();
            formData.append('excel_file', file);
            formData.append('action', 'final_submit'); // 告訴後端這是最終提交

            try {
                const response = await fetch('/upload_company', { 
                    method: 'POST', 
                    body: formData 
                });
                
                const result = await response.json();

                if (result.success) {
                    statusMessage.className = 'mt-3 text-success';
                    statusMessage.textContent = '✅ 資料已成功上傳至系統並儲存！';
                    // 可以清空檔案輸入框並禁用預覽按鈕
                    fileInput.value = ''; 
                    document.getElementById('previewButton').disabled = true;
                } else {
                    statusMessage.className = 'mt-3 text-danger';
                    statusMessage.textContent = '❌ 資料上傳失敗: ' + result.message;
                    submitButton.disabled = false; // 允許重試
                }

            } catch (error) {
                statusMessage.className = 'mt-3 text-danger';
                statusMessage.textContent = '❌ 最終上傳連線失敗，請檢查網路。';
                submitButton.disabled = false;
            }

        });

    });

  </script>
  </body>

</html>