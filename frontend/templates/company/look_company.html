<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>æ™ºæ…§å¯¦ç¿’å¹³å° | æŸ¥çœ‹å¯¦ç¿’å…¬å¸</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            font-family: "Noto Sans TC", sans-serif;
            background: #f7f9fc;
            margin: 0;
            padding: 0;
        }

        header {
            background: #0454a3;
            color: white;
            padding: 1rem 2rem;
            text-align: center;
            font-size: 1.5rem;
        }

        /* ä¸‰æ¢ç·šé¸å–®æŒ‰éˆ•æ¨£å¼ */
        .top-bar-left {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1100;
        }

        .top-bar-left #menu-btn {
            width: 30px;
            height: 22px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            background: none;
            border: none;
            padding: 0;
        }

        .top-bar-left #menu-btn span {
            display: block;
            width: 100%;
            height: 3px;
            background-color: white;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        /* å´é‚Šé¸å–®æ¨£å¼ */
        #side-menu {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 320px;
            max-width: 80vw;
            background-color: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(6px);
            box-shadow: 3px 0 12px rgb(0 0 0 / 0.7);
            padding: 2rem 1.5rem;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 1200;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            color: white;
            user-select: none;
        }

        #side-menu.open {
            transform: translateX(0);
        }

        #close-btn {
            position: absolute;
            top: 2rem;
            right: 1.6rem;
            font-size: 2.2rem;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            line-height: 1;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #side-menu h2 {
            width: 100%;
            margin-bottom: 1.5rem;
            font-weight: 700;
            font-size: 1.5rem;
            text-align: left;
            color: white;
            border-bottom: none;
        }

        #side-menu a {
            display: block;
            width: 100%;
            padding: 0.5rem 0;
            font-size: 1.1rem;
            color: #ddd;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        #side-menu a:hover {
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #004d99;
            margin-bottom: 30px;
            font-weight: 700;
            font-size: 2rem;
            border-bottom: 3px solid #1a73e8;
            display: inline-block;
            padding-bottom: 8px;
        }

        .table {
            margin-top: 20px;
        }

        .table thead {
            background-color: #0454a3;
            color: white;
        }

        .table thead th {
            border: none;
            padding: 1rem;
            font-weight: 600;
        }

        .table tbody tr {
            transition: background-color 0.2s ease;
        }

        .table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .table tbody td {
            padding: 1rem;
            vertical-align: middle;
        }

        .btn {
            border-radius: 0.6rem;
            font-weight: 600;
            padding: 8px 16px;
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn-outline-primary {
            color: #1a73e8;
            border-color: #1a73e8;
            background-color: transparent;
        }

        .btn-outline-primary:hover:not([disabled]) {
            color: white;
            background-color: #1a73e8;
            transform: translateY(-1px);
        }

        .btn-outline-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: #1a73e8;
            border-color: #1a73e8;
        }

        .btn-primary:hover {
            background-color: #1557b0;
            border-color: #1557b0;
        }

        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
            border-color: #5a6268;
        }
    </style>
</head>

<body>
    <header>æŸ¥çœ‹å¯¦ç¿’å…¬å¸</header>
    <div class="top-bar-left">
        <div id="menu-btn" title="é¸å–®" role="button" tabindex="0">
            <span></span><span></span><span></span>
        </div>
    </div>
    <div class="container">
        <h2 class="fw-bold mb-4">æŸ¥çœ‹å¯¦ç¿’å…¬å¸</h2>

        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>å…¬å¸åç¨±</th>
                    <th>åœ°é»</th>
                    <th class="text-center">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="companyTable">
                <!-- å…¬å¸è³‡æ–™ -->
            </tbody>
        </table>
    </div>

    <!-- æŠ•éå±¥æ­· Modal -->
    <div class="modal fade" id="applyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">æŠ•éå±¥æ­·</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <p id="applyCompanyName" class="fw-bold mb-3"></p>

                    <!-- è·ç¼ºé¸æ“‡ -->
                    <label class="form-label">é¸æ“‡è·ç¼º</label>
                    <select id="jobSelect" class="form-select mb-3">
                        <option value="">è«‹é¸æ“‡è·ç¼º</option>
                    </select>

                    <!-- å±¥æ­·è³‡æ–™å¤¾é¸æ“‡ -->
                    <label class="form-label">é¸æ“‡å±¥æ­·è³‡æ–™å¤¾</label>
                    <select id="folderSelect" class="form-select mb-3" onchange="loadResumeVersions()">
                        <option value="">è«‹é¸æ“‡è³‡æ–™å¤¾</option>
                    </select>
                    
                    <!-- å±¥æ­·ç‰ˆæœ¬é¸æ“‡ -->
                    <label class="form-label">é¸æ“‡å±¥æ­·ç‰ˆæœ¬</label>
                    <select id="resumeSelect" class="form-select">
                        <option value="">è«‹å…ˆé¸æ“‡è³‡æ–™å¤¾</option>
                    </select>
                    <small class="form-text text-muted">å¦‚æœè³‡æ–™å¤¾å…§æœ‰å¤šå€‹å±¥æ­·ç‰ˆæœ¬ï¼Œè«‹é¸æ“‡è¦æŠ•éçš„ç‰ˆæœ¬</small>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="submitApply()">ç¢ºèªæŠ•é</button>
                </div>

            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // å¼ºåˆ¶æ¸…é™¤ç¼“å­˜ - æ·»åŠ ç‰ˆæœ¬å·
        const CACHE_VERSION = '20260107-v2';
        let selectedCompanyId = null;
        let folders = [];
        let resumeVersions = [];

        /* ===============================
           è¼‰å…¥å…¬å¸è³‡æ–™
        ================================ */
        async function loadCompanies() {
            const res = await fetch('/api/student/companies');
            const result = await res.json();

            if (!result.success) {
                alert(result.message || 'è¼‰å…¥å…¬å¸è³‡æ–™å¤±æ•—');
                return;
            }

            const data = result.companies || [];

            const tbody = document.getElementById('companyTable');
            tbody.innerHTML = '';

            data.forEach(c => {
                // è½¬ä¹‰å…¬å¸åç§°ä¸­çš„ç‰¹æ®Šå­—ç¬¦ï¼Œé¿å…åœ¨ HTML ä¸­å‡ºé”™
                const escapedName = (c.company_name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                tbody.innerHTML += `
                    <tr>
                        <td>${c.company_name}</td>
                        <td>${c.location || '-'}</td>
                        <td>
                            <div class="d-flex flex-column gap-2">
                                <button
                                    class="btn btn-outline-primary btn-sm"
                                    onclick="openApply(${c.id}, '${escapedName}')"
                                >
                                    <i class="bi bi-send me-1"></i>æŠ•é
                                </button>
                                <button
                                    type="button"
                                    class="btn btn-outline-primary btn-sm download-company-btn"
                                    onclick="downloadCompanyFile(${c.id}, '${escapedName}')"
                                    title="ä¸‹è¼‰å…¬å¸è³‡æ–™"
                                >
                                    <i class="bi bi-file-earmark-arrow-down-fill me-1"></i>ä¸‹è¼‰å…¬å¸è³‡æ–™ (DOCX)
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        /* ===============================
           è¼‰å…¥å±¥æ­·è³‡æ–™å¤¾
        ================================ */
        async function loadFolders() {
            const res = await fetch('/api/resume_folders');
            const result = await res.json();
            folders = result.folders || [];
        }

        /* ===============================
           è¼‰å…¥å…¬å¸è·ç¼º
        ================================ */
        async function loadJobsByCompany(companyId) {
            console.log('ğŸ” [DEBUG] åŠ è½½å…¬å¸èŒç¼º:', companyId);
            const jobSelect = document.getElementById('jobSelect');
            jobSelect.innerHTML = '<option value="">è¼‰å…¥ä¸­...</option>';
            
            try {
                // ä½¿ç”¨æ­£ç¡®çš„ API è·¯å¾„ï¼ˆä¸ fill_preferences.html ç›¸åŒï¼‰
                // æ³¨æ„ï¼šä¸è¦ä½¿ç”¨ /preferences/api/get_jobs_by_companyï¼Œåº”è¯¥ä½¿ç”¨ /api/get_jobs_by_company
                const apiUrl = `/api/get_jobs_by_company?company_id=${companyId}&_v=${CACHE_VERSION}`;
                console.log('ğŸ“¤ [DEBUG] è¯·æ±‚ URL:', apiUrl);
                console.log('ğŸ“¤ [DEBUG] ç¡®ä¿ä½¿ç”¨æ­£ç¡®è·¯å¾„: /api/get_jobs_by_company (ä¸æ˜¯ /preferences/api/get_jobs_by_company)');
                const res = await fetch(apiUrl);
                console.log('ğŸ“¥ æ”¶åˆ°èŒç¼ºå“åº”:', res.status, res.statusText);
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                
                const result = await res.json();
                console.log('ğŸ“¦ èŒç¼ºæ•°æ®:', result);

                jobSelect.innerHTML = '<option value="">è«‹é¸æ“‡è·ç¼º</option>';

                if (result.success && result.jobs && result.jobs.length > 0) {
                    result.jobs.forEach(job => {
                        jobSelect.innerHTML += `
                            <option value="${job.id}">${job.title}</option>
                        `;
                    });
                    console.log(`âœ… æˆåŠŸåŠ è½½ ${result.jobs.length} ä¸ªèŒç¼º`);
                } else {
                    jobSelect.innerHTML = '<option value="">æ­¤å…¬å¸å°šç„¡è·ç¼º</option>';
                    console.warn('âš ï¸ è¯¥å…¬å¸æ²¡æœ‰èŒç¼ºæˆ–åŠ è½½å¤±è´¥:', result);
                }
            } catch (error) {
                console.error('âŒ åŠ è½½èŒç¼ºå¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                jobSelect.innerHTML = '<option value="">è¼‰å…¥è·ç¼ºå¤±æ•—</option>';
                alert(`è¼‰å…¥è·ç¼ºå¤±æ•—ï¼š${error.message}\n\nè«‹ç¢ºèªï¼š\n1. å·²åˆ·æ–°é é¢æ¸…é™¤ç·©å­˜ï¼ˆCtrl+F5ï¼‰\n2. å¾Œç«¯æœå‹™æ­£å¸¸é‹è¡Œ`);
            }
        }

        /* ===============================
           é–‹å•ŸæŠ•éè¦–çª—
        ================================ */
        function openApply(companyId, companyName) {
            selectedCompanyId = companyId;

            document.getElementById('applyCompanyName').innerText =
                `å…¬å¸ï¼š${companyName}`;

            // è¼‰å…¥è·ç¼º
            loadJobsByCompany(companyId);

            // è¼‰å…¥å±¥æ­·è³‡æ–™å¤¾
            const folderSelect = document.getElementById('folderSelect');
            folderSelect.innerHTML = '<option value="">è«‹é¸æ“‡è³‡æ–™å¤¾</option>' + folders.map(f =>
                `<option value="${f.id}">${f.folder_name}</option>`
            ).join('');
            folderSelect.disabled = false;
            
            // é‡ç½®å±¥æ­·ç‰ˆæœ¬é¸æ“‡
            const resumeSelect = document.getElementById('resumeSelect');
            resumeSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡è³‡æ–™å¤¾</option>';
            resumeSelect.disabled = true; // å…ˆç¦ç”¨ï¼Œç›´åˆ°é¸æ“‡äº†è³‡æ–™å¤¾

            new bootstrap.Modal(
                document.getElementById('applyModal')
            ).show();
        }

        /* ===============================
           è¼‰å…¥å±¥æ­·ç‰ˆæœ¬ï¼ˆé¡¯ç¤ºæ‰€æœ‰æ­·å²è¨˜éŒ„ï¼Œèˆ‡ upload_resume.html ä¸€è‡´ï¼‰
        ================================ */
        async function loadResumeVersions() {
            const folderId = document.getElementById('folderSelect').value;
            const resumeSelect = document.getElementById('resumeSelect');
            
            if (!folderId) {
                resumeSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡è³‡æ–™å¤¾</option>';
                resumeSelect.disabled = true;
                return;
            }
            
            // é¡¯ç¤ºè¼‰å…¥ä¸­ç‹€æ…‹
            resumeSelect.innerHTML = '<option value="">è¼‰å…¥ä¸­...</option>';
            resumeSelect.disabled = true;
            
            try {
                console.log('ğŸ“¤ [DEBUG] è¼‰å…¥å±¥æ­·ç‰ˆæœ¬ï¼Œè³‡æ–™å¤¾ID:', folderId);
                
                // å„ªå…ˆå˜—è©¦ä½¿ç”¨ /api/resume_folders/{folderId}/resumes ç²å–è©²è³‡æ–™å¤¾ä¸‹çš„å±¥æ­·
                let versions = [];
                try {
                    const apiUrl = `/api/resume_folders/${folderId}/resumes`;
                    console.log('ğŸ“¤ [DEBUG] å˜—è©¦ API URL:', apiUrl);
                    
                    const res = await fetch(apiUrl);
                    console.log('ğŸ“¥ [DEBUG] æ”¶åˆ°éŸ¿æ‡‰:', res.status, res.statusText);
                    
                    if (res.ok) {
                        const result = await res.json();
                        console.log('ğŸ“¦ [DEBUG] API è¿”å›æ•¸æ“š:', result);
                        
                        if (result.success && result.resumes) {
                            versions = result.resumes;
                            console.log('ğŸ“‹ [DEBUG] å¾è³‡æ–™å¤¾APIç²å–åˆ°å±¥æ­·ç‰ˆæœ¬æ•¸:', versions.length);
                        }
                    }
                } catch (folderApiErr) {
                    console.warn('âš ï¸ è³‡æ–™å¤¾APIå¤±æ•—ï¼Œå°‡ä½¿ç”¨æ‰€æœ‰å±¥æ­·:', folderApiErr);
                }
                
                // å¦‚æœè³‡æ–™å¤¾APIè¿”å›ç©ºæˆ–å¤±æ•—ï¼Œä½¿ç”¨ /api/get_my_resumes ç²å–æ‰€æœ‰å±¥æ­·
                // é€™æ¨£å¯ä»¥ç¢ºä¿é¡¯ç¤ºæ‰€æœ‰æ­·å²è¨˜éŒ„ï¼ˆèˆ‡ upload_resume.html ä¸€è‡´ï¼‰
                if (versions.length === 0) {
                    console.log('ğŸ“¤ [DEBUG] è³‡æ–™å¤¾ä¸‹ç„¡å±¥æ­·ï¼Œè¼‰å…¥æ‰€æœ‰å±¥æ­·ç‰ˆæœ¬...');
                    const allRes = await fetch('/api/get_my_resumes');
                    const allResult = await allRes.json();
                    
                    if (allResult.success && allResult.resumes) {
                        versions = allResult.resumes;
                        console.log('ğŸ“‹ [DEBUG] å¾æ‰€æœ‰å±¥æ­·APIç²å–åˆ°å±¥æ­·ç‰ˆæœ¬æ•¸:', versions.length);
                        console.log('ğŸ“‹ [DEBUG] å±¥æ­·ç‰ˆæœ¬æ•¸æ“š:', versions);
                    } else {
                        console.warn('âš ï¸ ç„¡æ³•ç²å–å±¥æ­·åˆ—è¡¨:', allResult.message);
                    }
                }
                
                resumeVersions = versions;
                
                if (versions.length === 0) {
                    resumeSelect.innerHTML = '<option value="">å°šç„¡å±¥æ­·ç‰ˆæœ¬</option>';
                    console.log('â„¹ï¸ æ²’æœ‰æ‰¾åˆ°ä»»ä½•å±¥æ­·ç‰ˆæœ¬');
                } else {
                    // ç”Ÿæˆé¸é …åˆ—è¡¨ï¼ˆèˆ‡ upload_resume.html çš„æ ¼å¼ä¸€è‡´ï¼‰
                    const options = versions.map(r => {
                        // è™•ç†å­—æ®µå
                        const id = r.id || r.resume_id || r.version_id;
                        const filename = r.original_filename || r.filename || r.name || 'æœªå‘½å';
                        const status = r.status || '';
                        // è™•ç†æ—¥æœŸå­—æ®µï¼ˆå¯èƒ½æ˜¯ created_at æˆ– upload_timeï¼‰
                        const uploadTime = r.created_at || r.upload_time || r.uploaded_at || '';
                        
                        // æ ¼å¼åŒ–ç‹€æ…‹é¡¯ç¤ºï¼ˆèˆ‡ upload_resume.html ä¸€è‡´ï¼‰
                        let statusText = '';
                        if (status === 'approved' || status === 'å¯©æ ¸é€šé') {
                            statusText = ' âœ“';
                        } else if (status === 'rejected' || status === 'é€€ä»¶') {
                            statusText = ' âœ—';
                        } else if (status === 'uploaded' || status === 'å·²ä¸Šå‚³') {
                            statusText = ' â³';
                        }
                        
                        // æ ¼å¼åŒ–æ—¥æœŸï¼ˆåªå–æ—¥æœŸéƒ¨åˆ†ï¼Œèˆ‡ upload_resume.html ä¸€è‡´ï¼‰
                        let dateText = '';
                        if (uploadTime) {
                            try {
                                // è™•ç†æ—¥æœŸæ ¼å¼ï¼šå¯èƒ½æ˜¯ "2024-01-01 12:00:00" æˆ– "2024-01-01T12:00:00"
                                const date = uploadTime.split(' ')[0] || uploadTime.split('T')[0];
                                dateText = date ? ` (${date})` : '';
                            } catch (e) {
                                console.warn('æ—¥æœŸæ ¼å¼åŒ–å¤±æ•—:', uploadTime, e);
                            }
                        }
                        
                        const displayText = `${filename}${statusText}${dateText}`;
                        return `<option value="${id}">${displayText}</option>`;
                    }).join('');
                    
                    resumeSelect.innerHTML = '<option value="">è«‹é¸æ“‡å±¥æ­·ç‰ˆæœ¬</option>' + options;
                    console.log(`âœ… æˆåŠŸè¼‰å…¥ ${versions.length} å€‹å±¥æ­·ç‰ˆæœ¬`);
                }
            } catch (err) {
                console.error('âŒ è¼‰å…¥å±¥æ­·ç‰ˆæœ¬å¤±æ•—:', err);
                console.error('éŒ¯èª¤è©³æƒ…:', err.message);
                resumeSelect.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°é¸æ“‡è³‡æ–™å¤¾</option>';
                alert(`è¼‰å…¥å±¥æ­·ç‰ˆæœ¬å¤±æ•—ï¼š${err.message}\n\nè«‹ç¢ºèªï¼š\n1. è³‡æ–™å¤¾IDæ˜¯å¦æ­£ç¢º\n2. å¾Œç«¯æœå‹™æ­£å¸¸é‹è¡Œ`);
            } finally {
                resumeSelect.disabled = false;
            }
        }

        /* ===============================
           ä¸‹è¼‰å…¬å¸è³‡æ–™ï¼ˆæ”¹é€²ç‰ˆï¼Œå¸¶éŒ¯èª¤è™•ç†ï¼‰
        ================================ */
        async function downloadCompanyFile(companyId, companyName) {
            if (!companyId) {
                alert('âŒ éŒ¯èª¤ï¼šç¼ºå°‘å…¬å¸ ID');
                return;
            }
            
            try {
                console.log('ğŸ“¤ [DEBUG] ä¸‹è½½å…¬å¸æ–‡ä»¶ï¼ŒID:', companyId, 'å…¬å¸åç¨±:', companyName);
                const response = await fetch(`/api/download_company_file/${companyId}`);
                console.log('ğŸ“¥ æ”¶åˆ°å“åº”:', response.status, response.statusText, response.headers.get('content-type'));
                
                if (!response.ok) {
                    // å¦‚æœæ˜¯ HTML éŒ¯èª¤é é¢ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                    const text = await response.text();
                    if (text.includes('<html>')) {
                        // æå–éŒ¯èª¤è¨Šæ¯
                        const errorMatch = text.match(/<h2>éŒ¯èª¤ï¼š(.+?)<\/h2>/);
                        const errorMsg = errorMatch ? errorMatch[1] : 'ä¸‹è¼‰å¤±æ•—';
                        alert(`âŒ ${errorMsg}\n\nå…¬å¸ï¼š${companyName || 'æœªçŸ¥'}\nIDï¼š${companyId}`);
                        return;
                    }
                    // å¦‚æœæ˜¯ JSON éŒ¯èª¤
                    try {
                        const data = await response.json();
                        alert(`âŒ ${data.message || 'ä¸‹è¼‰å¤±æ•—'}\n\nå…¬å¸ï¼š${companyName || 'æœªçŸ¥'}\nIDï¼š${companyId}`);
                    } catch (e) {
                        alert(`âŒ ä¸‹è¼‰å¤±æ•—ï¼ˆHTTP ${response.status}ï¼‰\n\nå…¬å¸ï¼š${companyName || 'æœªçŸ¥'}\nIDï¼š${companyId}`);
                    }
                    return;
                }
                
                // æª¢æŸ¥ Content-Type æ˜¯å¦ç‚ºæ–‡ä»¶
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    // å¦‚æœæ˜¯ JSONï¼Œè¡¨ç¤ºæ˜¯éŒ¯èª¤è¨Šæ¯
                    const data = await response.json();
                    alert(`âŒ ${data.message || 'ä¸‹è¼‰å¤±æ•—'}\n\nå…¬å¸ï¼š${companyName || 'æœªçŸ¥'}\nIDï¼š${companyId}`);
                    return;
                }
                
                // å¾ Content-Disposition æ¨™é ­ç²å–æ–‡ä»¶åï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨å…¬å¸åç¨±
                let filename = `${companyName || 'company'}_${companyId}.docx`;
                const contentDisposition = response.headers.get('content-disposition');
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                    if (filenameMatch && filenameMatch[1]) {
                        filename = filenameMatch[1].replace(/['"]/g, '');
                    }
                }
                
                // ä¸‹è¼‰æ–‡ä»¶
                console.log('ğŸ“¦ å¼€å§‹ä¸‹è½½æ–‡ä»¶ï¼Œæ–‡ä»¶å:', filename);
                const blob = await response.blob();
                console.log('ğŸ“¦ Blob å¤§å°:', blob.size, 'bytes');
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                console.log('âœ… ä¸‹è½½é“¾æ¥å·²ç‚¹å‡»');
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                console.error('âŒ ä¸‹è¼‰éŒ¯èª¤:', error);
                alert(`âŒ ä¸‹è¼‰æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}\n\nå…¬å¸ï¼š${companyName || 'æœªçŸ¥'}\nIDï¼š${companyId}`);
            }
        }

        // ç¡®ä¿å‡½æ•°åœ¨å…¨å±€ä½œç”¨åŸŸä¸­
        window.downloadCompanyFile = downloadCompanyFile;

        /* ===============================
           é€å‡ºæŠ•é
        ================================ */
        async function submitApply() {
            const folderId = document.getElementById('folderSelect').value;
            const resumeId = document.getElementById('resumeSelect').value;
            const jobId = document.getElementById('jobSelect').value;

            if (!jobId) {
                alert('è«‹é¸æ“‡è·ç¼º');
                return;
            }
            
            if (!folderId) {
                alert('è«‹é¸æ“‡å±¥æ­·è³‡æ–™å¤¾');
                return;
            }
            
            if (!resumeId) {
                alert('è«‹é¸æ“‡å±¥æ­·ç‰ˆæœ¬');
                return;
            }

            const res = await fetch('/api/student/apply_company', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    company_id: selectedCompanyId,
                    job_id: jobId,
                    folder_id: folderId,
                    resume_id: resumeId
                })
            });

            const result = await res.json();

            if (result.success) {
                alert('æŠ•éæˆåŠŸ');
                bootstrap.Modal
                    .getInstance(document.getElementById('applyModal'))
                    .hide();
            } else {
                alert(result.message || 'æŠ•éå¤±æ•—');
            }
        }

        // é¸å–®é–‹é—œé‚è¼¯
        document.addEventListener("DOMContentLoaded", () => {
            const menuBtn = document.getElementById("menu-btn");
            const sideMenu = document.getElementById("side-menu");
            const closeBtn = document.getElementById("close-btn");

            if (menuBtn && sideMenu && closeBtn) {
                menuBtn.addEventListener("click", () => {
                    sideMenu.classList.add("open");
                    sideMenu.setAttribute("aria-hidden", "false");
                });

                closeBtn.addEventListener("click", () => {
                    sideMenu.classList.remove("open");
                    sideMenu.setAttribute("aria-hidden", "true");
                });

                // å¦‚æœé»æ“Š menu ä»¥å¤–çš„åœ°æ–¹å°±é—œé–‰é¸å–®
                document.addEventListener("click", (e) => {
                    if (
                        !sideMenu.contains(e.target) &&
                        !menuBtn.contains(e.target)
                    ) {
                        sideMenu.classList.remove("open");
                        sideMenu.setAttribute("aria-hidden", "true");
                    }
                });
            }

            // è¼‰å…¥å…¬å¸è³‡æ–™å’Œå±¥æ­·è³‡æ–™å¤¾
            loadCompanies();
            loadFolders();
        });
    </script>

    <!-- å´é‚Šé¸å–® -->
    <nav id="side-menu" aria-hidden="true" role="navigation" aria-label="åŠŸèƒ½é¸å–®">
        <button id="close-btn" aria-label="é—œé–‰åŠŸèƒ½é¸å–®">Ã—</button>
        <h2>åŠŸèƒ½é¸å–®</h2>
        <a href="/student_home">é¦–é </a>
        <a href="/profile">å€‹äººè³‡æ–™</a>
        <a href="/upload_resume">ä¸Šå‚³å±¥æ­·</a>
        <a href="/fill_preferences">å¡«å¯«å¿—é¡˜åº</a>
        <a href="/notifications">é€šçŸ¥</a>
        <a href="/intern_achievement">å­¸ç”Ÿåª’åˆçµæœ</a>
        <a href="/intern_experience">å¯¦ç¿’å¿ƒå¾—</a>
    </nav>
</body>

</html>
