<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>查看實習公司</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-5">
  <h2 class="fw-bold mb-4">查看實習公司</h2>

  <table class="table table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th>公司名稱</th>
        <th>產業別</th>
        <th>地點</th>
        <th class="text-center">操作</th>
      </tr>
    </thead>
    <tbody id="companyTable">
      <!-- 公司資料 -->
    </tbody>
  </table>
</div>

<!-- 投遞履歷 Modal -->
<div class="modal fade" id="applyModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">投遞履歷</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p id="applyCompanyName" class="fw-bold mb-3"></p>

        <!-- 職缺選擇 -->
        <label class="form-label">選擇職缺</label>
        <select id="jobSelect" class="form-select mb-3">
          <option value="">請選擇職缺</option>
        </select>

        <!-- 履歷資料夾選擇 -->
        <label class="form-label">選擇履歷資料夾</label>
        <select id="folderSelect" class="form-select mb-3" onchange="loadResumeVersions()">
          <option value="">請選擇資料夾</option>
        </select>
        
        <!-- 履歷版本選擇 -->
        <label class="form-label">選擇履歷版本</label>
        <select id="resumeSelect" class="form-select">
          <option value="">請先選擇資料夾</option>
        </select>
        <small class="form-text text-muted">如果資料夾內有多個履歷版本，請選擇要投遞的版本</small>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button class="btn btn-primary" onclick="submitApply()">確認投遞</button>
      </div>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
let selectedCompanyId = null;
let folders = [];
let resumeVersions = [];

/* ===============================
   載入公司資料
================================ */
async function loadCompanies() {
  const res = await fetch('/api/student/companies');
  const result = await res.json();

  if (!result.success) {
    alert(result.message || '載入公司資料失敗');
    return;
  }

  const data = result.companies || [];

  const tbody = document.getElementById('companyTable');
  tbody.innerHTML = '';

  data.forEach(c => {
    tbody.innerHTML += `
      <tr>
        <td>${c.company_name}</td>
        <td>${c.industry || '-'}</td>
        <td>${c.location || '-'}</td>
        <td class="text-center">
          <button
            class="btn btn-outline-primary btn-sm me-2"
            onclick="openApply(${c.id}, '${c.company_name}')"
          >
            投遞
          </button>
          <button
            class="btn btn-outline-secondary btn-sm"
            onclick="downloadCompanyFile(${c.id})"
            title="下載公司資料"
          >
            <i class="bi bi-file-earmark-arrow-down-fill me-1"></i>下載資料
          </button>
        </td>
      </tr>
    `;
  });
}

/* ===============================
   載入履歷資料夾
================================ */
async function loadFolders() {
  const res = await fetch('/api/resume_folders');
  const result = await res.json();
  folders = result.folders || [];
}

/* ===============================
   載入公司職缺
================================ */
async function loadJobsByCompany(companyId) {
  const res = await fetch(
    `/preferences/api/get_jobs_by_company?company_id=${companyId}`
  );
  const result = await res.json();

  const jobSelect = document.getElementById('jobSelect');
  jobSelect.innerHTML = '<option value="">請選擇職缺</option>';

  if (result.success) {
    result.jobs.forEach(job => {
      jobSelect.innerHTML += `
        <option value="${job.id}">${job.title}</option>
      `;
    });
  }
}

/* ===============================
   開啟投遞視窗
================================ */
function openApply(companyId, companyName) {
  selectedCompanyId = companyId;

  document.getElementById('applyCompanyName').innerText =
    `公司：${companyName}`;

  // 載入職缺
  loadJobsByCompany(companyId);

  // 載入履歷資料夾
  const folderSelect = document.getElementById('folderSelect');
  folderSelect.innerHTML = '<option value="">請選擇資料夾</option>' + folders.map(f =>
    `<option value="${f.id}">${f.folder_name}</option>`
  ).join('');
  
  // 重置履歷版本選擇
  const resumeSelect = document.getElementById('resumeSelect');
  resumeSelect.innerHTML = '<option value="">請先選擇資料夾</option>';

  new bootstrap.Modal(
    document.getElementById('applyModal')
  ).show();
}

/* ===============================
   載入履歷版本
================================ */
async function loadResumeVersions() {
  const folderId = document.getElementById('folderSelect').value;
  const resumeSelect = document.getElementById('resumeSelect');
  
  if (!folderId) {
    resumeSelect.innerHTML = '<option value="">請先選擇資料夾</option>';
    return;
  }
  
  try {
    const res = await fetch(`/api/resume_folders/${folderId}/resumes`);
    const result = await res.json();
    
    if (result.success) {
      resumeVersions = result.resumes || [];
      
      if (resumeVersions.length === 0) {
        resumeSelect.innerHTML = '<option value="">此資料夾尚無履歷版本</option>';
      } else {
        resumeSelect.innerHTML = '<option value="">請選擇履歷版本</option>' + 
          resumeVersions.map(r => {
            const statusText = r.status === 'approved' ? '✓' : r.status === 'rejected' ? '✗' : '';
            const date = r.created_at ? r.created_at.split(' ')[0] : '';
            return `<option value="${r.id}">${r.original_filename || '未命名'} ${statusText} ${date ? '(' + date + ')' : ''}</option>`;
          }).join('');
      }
    } else {
      resumeSelect.innerHTML = '<option value="">載入失敗</option>';
    }
  } catch (err) {
    console.error('載入履歷版本失敗:', err);
    resumeSelect.innerHTML = '<option value="">載入失敗</option>';
  }
}

/* ===============================
   下載公司資料
================================ */
function downloadCompanyFile(companyId) {
  window.location.href = `/api/download_company_file/${companyId}`;
}

/* ===============================
   送出投遞
================================ */
async function submitApply() {
  const folderId = document.getElementById('folderSelect').value;
  const resumeId = document.getElementById('resumeSelect').value;
  const jobId = document.getElementById('jobSelect').value;

  if (!jobId) {
    alert('請選擇職缺');
    return;
  }
  
  if (!folderId) {
    alert('請選擇履歷資料夾');
    return;
  }
  
  if (!resumeId) {
    alert('請選擇履歷版本');
    return;
  }

  const res = await fetch('/api/student/apply_company', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      company_id: selectedCompanyId,
      job_id: jobId,
      folder_id: folderId,
      resume_id: resumeId
    })
  });

  const result = await res.json();

  if (result.success) {
    alert('投遞成功');
    bootstrap.Modal
      .getInstance(document.getElementById('applyModal'))
      .hide();
  } else {
    alert(result.message || '投遞失敗');
  }
}

loadCompanies();
loadFolders();
</script>

</body>
</html>
