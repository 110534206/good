<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>æ™ºæ…§å¯¦ç¿’å¹³å° | æŠ•éå±¥æ­·</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            font-family: "Noto Sans TC", sans-serif;
            background: #f7f9fc;
            margin: 0;
            padding: 0;
        }

        header {
            background: #0454a3;
            color: white;
            padding: 1rem 2rem;
            text-align: center;
            font-size: 1.5rem;
        }

        /* ä¸‰æ¢ç·šé¸å–®æŒ‰éˆ•æ¨£å¼ */
        .top-bar-left {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1100;
        }

        .top-bar-left #menu-btn {
            width: 30px;
            height: 22px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            background: none;
            border: none;
            padding: 0;
        }

        .top-bar-left #menu-btn span {
            display: block;
            width: 100%;
            height: 3px;
            background-color: white;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        /* å´é‚Šé¸å–®æ¨£å¼ */
        #side-menu {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 320px;
            max-width: 80vw;
            background-color: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(6px);
            box-shadow: 3px 0 12px rgb(0 0 0 / 0.7);
            padding: 2rem 1.5rem;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 1200;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            color: white;
            user-select: none;
        }

        #side-menu.open {
            transform: translateX(0);
        }

        #side-menu .menu-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 1.5rem;
        }

        #side-menu h2 {
            margin: 0;
            font-weight: 700;
            font-size: 1.5rem;
            text-align: left;
            flex: 1;
            color: white;
        }

        #close-btn {
            font-size: 1.5rem;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            line-height: 1;
            width: auto;
            height: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin: 0;
        }

        #side-menu a {
            display: block;
            width: 100%;
            padding: 0.5rem 0;
            font-size: 1.1rem;
            color: #ddd;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        #side-menu a:hover {
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #004d99;
            margin-bottom: 30px;
            font-weight: 700;
            font-size: 2rem;
            border-bottom: 3px solid #1a73e8;
            display: inline-block;
            padding-bottom: 8px;
        }

        .table {
            margin-top: 20px;
            font-size: 1.1rem;
        }

        .table thead {
            background-color: #0454a3;
            color: white;
        }

        .table thead th {
            border: none;
            padding: 1.2rem 1rem;
            font-weight: 600;
            font-size: 1.15rem;
        }

        .table tbody tr {
            transition: background-color 0.2s ease;
        }

        .table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .table tbody td {
            padding: 1.2rem 1rem;
            vertical-align: middle;
            font-size: 1.1rem;
        }

        /* è¡¨æ ¼å…§çš„æŒ‰éˆ•æ¨£å¼ */
        .table .btn-sm {
            font-size: 1rem;
            padding: 0.5rem 1rem;
        }

        .btn {
            border-radius: 0.6rem;
            font-weight: 600;
            padding: 10px 18px;
            font-size: 1rem;
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn-outline-primary {
            color: #1a73e8;
            border-color: #1a73e8;
            background-color: transparent;
        }

        .btn-outline-primary:hover:not([disabled]) {
            color: white;
            background-color: #1a73e8;
            transform: translateY(-1px);
        }

        .btn-outline-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: #1a73e8;
            border-color: #1a73e8;
        }

        .btn-primary:hover {
            background-color: #1557b0;
            border-color: #1557b0;
        }

        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
            border-color: #5a6268;
        }

        .alert-deadline {
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        /* ç¯©é¸æŒ‰éˆ•çµ„æ¨£å¼ */
        .filter-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.75rem 1.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 0.6rem;
            border: 2px solid #1a73e8;
            background-color: white;
            color: #1a73e8;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background-color: #f0f7ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(26, 115, 232, 0.2);
        }

        .filter-btn.active {
            background-color: #1a73e8;
            color: white;
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
        }

        .filter-btn:active {
            transform: translateY(0);
        }

        /* è¡¨æ ¼å®¹å™¨æ¨£å¼ */
        .table-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .btn-add {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }

        .btn-add:hover {
            background-color: #218838;
            border-color: #1e7e34;
            color: white;
        }

        /* ç‹€æ…‹é ç±¤ï¼ˆå¯©æ ¸ä¸­ / é€€ä»¶ / é€šéï¼‰ */
        .resume-status-tabs .filter-btn {
            min-width: 160px;
            justify-content: center;
            border-radius: 14px;
            font-size: 1.05rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* è¡¨æ ¼æ•´é«” */
        .resume-status-table {
            border-radius: 14px;
            overflow: hidden;
        }

        /* è¡¨é ­ */
        .resume-status-table thead {
            background: linear-gradient(135deg, #0454a3, #1a73e8);
            color: #fff;
        }

        /* è¡¨æ ¼åˆ— */
        .resume-status-table tbody tr {
            transition: all 0.2s ease;
        }

        .resume-status-table tbody tr:hover {
            background-color: #f4f9ff;
            transform: scale(1.002);
        }

        /* å±¥æ­·æª”å */
        .resume-filename {
            font-weight: 600;
            color: #004d99;
        }

        /* å¯©æ ¸æ„è¦‹ */
        .resume-comment {
            max-width: 260px;
            font-size: 0.95rem;
            line-height: 1.4;
            color: #555;
        }

        /* ç‹€æ…‹ badge æ”¾å¤§ */
        .resume-status-badge {
            font-size: 0.95rem;
            padding: 0.45em 0.8em;
            border-radius: 999px;
        }

    </style>
</head>

<body>
    <header>æŠ•éå±¥æ­·</header>
    <div class="top-bar-left">
        <div id="menu-btn" title="é¸å–®" role="button" tabindex="0">
            <span></span><span></span><span></span>
        </div>
    </div>
    <div class="container">

        <!-- æˆªæ­¢æ™‚é–“æç¤º -->
        <div id="deadlineAlert" class="alert alert-deadline d-none" role="alert"></div>

        <!-- ç¯©é¸æŒ‰éˆ•çµ„ -->
        <div class="filter-buttons">
            <button class="filter-btn active" data-filter="all" onclick="filterCompanies('all')">
                <i class="bi bi-list-ul me-2"></i>å…¨éƒ¨å…¬å¸
            </button>
            <button class="filter-btn" data-filter="selected" onclick="filterCompanies('selected')">
                <i class="bi bi-check-circle me-2"></i>å¿—é¡˜åºå…¬å¸
            </button>
            <button class="filter-btn" data-filter="unselected" onclick="filterCompanies('unselected')">
                <i class="bi bi-building me-2"></i>å…¶ä»–å…¬å¸
            </button>
        </div>

        <!-- å…¬å¸è¡¨æ ¼ -->
        <div class="table-container">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>å…¬å¸åç¨±</th>
                        <th class="text-center">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="companyTable">
                    <tr>
                        <td colspan="2" class="text-center text-muted">
                            <i class="bi bi-hourglass-split"></i> è¼‰å…¥ä¸­...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- å±¥æ­·å¯©æ ¸ç‹€æ…‹å€åŸŸ -->
        <div class="mt-5">
            <h4 class="mb-4"><i class="bi bi-file-earmark-check me-2"></i>å±¥æ­·å¯©æ ¸ç‹€æ…‹</h4>

            <!-- å¯©æ ¸ç‹€æ…‹é ç±¤ -->
            <div class="filter-buttons resume-status-tabs mb-3">
                <button class="filter-btn active" data-status="reviewing" onclick="filterResumeStatus('reviewing')">
                    <i class="bi bi-hourglass-split me-2"></i>å¯©æ ¸ä¸­
                    <span class="badge bg-warning ms-2" id="count-reviewing">0</span>
                </button>
                <button class="filter-btn" data-status="rejected" onclick="filterResumeStatus('rejected')">
                    <i class="bi bi-x-circle me-2"></i>é€€ä»¶
                    <span class="badge bg-danger ms-2" id="count-rejected">0</span>
                </button>
                <button class="filter-btn" data-status="approved" onclick="filterResumeStatus('approved')">
                    <i class="bi bi-check-circle me-2"></i>é€šé
                    <span class="badge bg-success ms-2" id="count-approved">0</span>
                </button>
            </div>

            <!-- å±¥æ­·å¯©æ ¸ç‹€æ…‹è¡¨æ ¼ -->
            <div class="table-container">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>å±¥æ­·æª”å</th>
                            <th>æŠ•éå…¬å¸</th>
                            <th>è·ç¼º</th>
                            <th>æŠ•éæ™‚é–“</th>
                            <th>å¯©æ ¸ç‹€æ…‹</th>
                            <th>å¯©æ ¸æ„è¦‹</th>
                            <th class="text-center">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="resumeStatusTable">
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                <i class="bi bi-hourglass-split"></i> è¼‰å…¥ä¸­...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- æŠ•éå±¥æ­· Modal -->
    <div class="modal fade" id="applyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">æŠ•éå±¥æ­·</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <p id="applyCompanyName" class="fw-bold mb-3"></p>

                    <!-- è·ç¼ºé¸æ“‡ -->
                    <label class="form-label">é¸æ“‡è·ç¼º</label>
                    <select id="jobSelect" class="form-select mb-3">
                        <option value="">è«‹é¸æ“‡è·ç¼º</option>
                    </select>

                    <!-- å±¥æ­·é¸æ“‡ -->
                    <label class="form-label">é¸æ“‡å±¥æ­·</label>
                    <select id="resumeSelect" class="form-select">
                        <option value="">è¼‰å…¥ä¸­...</option>
                    </select>
                    <small class="form-text text-muted">è«‹é¸æ“‡å·²æäº¤ç‚ºæ­£å¼ç‰ˆæœ¬çš„å±¥æ­·é€²è¡ŒæŠ•é</small>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="submitApply()">ç¢ºèªæŠ•é</button>
                </div>

            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // å¼ºåˆ¶æ¸…é™¤ç¼“å­˜ - æ·»åŠ ç‰ˆæœ¬å·
        const CACHE_VERSION = '20260107-v2';
        let selectedCompanyId = null;
        let resumeVersions = [];
        let deadlineExpired = false; // æˆªæ­¢æ™‚é–“éæœŸæ¨™è¨˜
        let allCompanies = []; // æ‰€æœ‰å…¬å¸åˆ—è¡¨
        let selectedCompanyIds = new Set(); // å·²é¸æ“‡çš„å…¬å¸ ID é›†åˆ
        let allResumeStatuses = []; // æ‰€æœ‰å±¥æ­·å¯©æ ¸ç‹€æ…‹
        let currentResumeStatus = 'reviewing'; // ç•¶å‰é¸ä¸­çš„å¯©æ ¸ç‹€æ…‹é ç±¤
        let currentFilter = 'all'; // ç•¶å‰å…¬å¸ç¯©é¸æ¢ä»¶

        /* ===============================
           æª¢æŸ¥æŠ•éå±¥æ­·æˆªæ­¢æ™‚é–“
        ================================ */
        async function checkDeadlineAndDisableApply() {
            try {
                const res = await fetch("/announcement/api/check_deadline?type=resume");
                const result = await res.json();

                if (result.success && result.has_deadline) {
                    const deadlineAlert = document.getElementById('deadlineAlert');

                    if (result.is_expired) {
                        // æˆªæ­¢æ™‚é–“å·²éï¼Œç¦ç”¨æŠ•éåŠŸèƒ½
                        deadlineExpired = true;

                        // é¡¯ç¤ºè­¦å‘Šè¨Šæ¯
                        deadlineAlert.className = 'alert alert-danger alert-deadline';
                        deadlineAlert.innerHTML = `
                            <strong>âš ï¸ å·²è¶…éæŠ•éå±¥æ­·æˆªæ­¢æ™‚é–“</strong><br>
                            æŠ•éå±¥æ­·çš„æˆªæ­¢æ™‚é–“ç‚ºï¼š${result.deadline}<br>
                            ç›®å‰ç„¡æ³•å†æŠ•éå±¥æ­·åˆ°å…¬å¸ã€‚
                        `;
                        deadlineAlert.classList.remove('d-none');

                        // ç¦ç”¨æ‰€æœ‰æŠ•éæŒ‰éˆ•
                        document.querySelectorAll('.btn-outline-primary').forEach(btn => {
                            if (btn.textContent.includes('æŠ•é')) {
                                btn.disabled = true;
                                btn.classList.add('disabled');
                            }
                        });
                    } else {
                        // å°šæœªéæœŸï¼Œé¡¯ç¤ºæé†’
                        deadlineAlert.className = 'alert alert-info alert-deadline';
                        deadlineAlert.innerHTML = `
                            <strong>ğŸ“… æŠ•éå±¥æ­·æˆªæ­¢æ™‚é–“æé†’</strong><br>
                            æŠ•éå±¥æ­·çš„æˆªæ­¢æ™‚é–“ç‚ºï¼š${result.deadline}<br>
                            è«‹åœ¨æˆªæ­¢æ™‚é–“å‰å®ŒæˆæŠ•éã€‚
                        `;
                        deadlineAlert.classList.remove('d-none');
                    }
                } else {
                    // æ²’æœ‰è¨­å®šæˆªæ­¢æ™‚é–“ï¼Œéš±è—æç¤º
                    const deadlineAlert = document.getElementById('deadlineAlert');
                    deadlineAlert.classList.add('d-none');
                }
            } catch (error) {
                console.error("æª¢æŸ¥æˆªæ­¢æ™‚é–“å¤±æ•—:", error);
            }
        }

        /* ===============================
           ç²å–å¿—é¡˜åºä¸­å·²é¸æ“‡çš„å…¬å¸ ID
        ================================ */
        async function getSelectedCompanyIds() {
            try {
                const res = await fetch('/api/get_my_preferences');
                const result = await res.json();

                if (result.success && result.preferences) {
                    // å¾å¿—é¡˜åºä¸­æå–æ‰€æœ‰å”¯ä¸€çš„å…¬å¸ ID
                    const companyIds = new Set();
                    result.preferences.forEach(pref => {
                        if (pref.company_id) {
                            companyIds.add(pref.company_id);
                        }
                    });
                    return companyIds;
                }
                return new Set();
            } catch (error) {
                console.error('ç²å–å¿—é¡˜åºå¤±æ•—:', error);
                return new Set();
            }
        }

        /* ===============================
           è¼‰å…¥å…¬å¸è³‡æ–™ä¸¦åˆ†é¡
        ================================ */
        async function loadCompanies() {
            // å…ˆç²å–å·²é¸æ“‡çš„å…¬å¸ ID
            selectedCompanyIds = await getSelectedCompanyIds();

            // ç²å–æ‰€æœ‰å…¬å¸
            const res = await fetch('/api/student/companies');
            const result = await res.json();

            if (!result.success) {
                alert(result.message || 'è¼‰å…¥å…¬å¸è³‡æ–™å¤±æ•—');
                return;
            }

            allCompanies = result.companies || [];

            // åˆ†é¡å…¬å¸
            selectedCompanies = [];
            unselectedCompanies = [];

            allCompanies.forEach(c => {
                if (selectedCompanyIds.has(c.id)) {
                    selectedCompanies.push(c);
                } else {
                    unselectedCompanies.push(c);
                }
            });

            // æ ¹æ“šç•¶å‰ç¯©é¸æ¢ä»¶é¡¯ç¤ºå°æ‡‰çš„å…¬å¸
            filterCompanies(currentFilter);
        }

        /* ===============================
           ç¯©é¸å…¬å¸
        ================================ */
        function filterCompanies(filter) {
            currentFilter = filter;

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.getAttribute('data-filter') === filter) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // æ ¹æ“šç¯©é¸æ¢ä»¶é¸æ“‡è¦é¡¯ç¤ºçš„å…¬å¸åˆ—è¡¨
            let companiesToShow = [];
            let emptyMessage = '';

            switch (filter) {
                case 'selected':
                    companiesToShow = selectedCompanies;
                    emptyMessage = '<i class="bi bi-inbox"></i> å°šç„¡å¿—é¡˜åºå…¬å¸';
                    break;
                case 'unselected':
                    companiesToShow = unselectedCompanies;
                    emptyMessage = '<i class="bi bi-inbox"></i> å°šç„¡å…¶ä»–å…¬å¸';
                    break;
                case 'all':
                default:
                    companiesToShow = allCompanies;
                    emptyMessage = '<i class="bi bi-inbox"></i> å°šç„¡å…¬å¸è³‡æ–™';
                    break;
            }

            // æ¸²æŸ“è¡¨æ ¼
            renderCompanyTable(companiesToShow, emptyMessage);
        }

        /* ===============================
           æ¸²æŸ“å…¬å¸è¡¨æ ¼
        ================================ */
        function renderCompanyTable(companies, emptyMessage = '<i class="bi bi-inbox"></i> å°šç„¡å…¬å¸è³‡æ–™') {
            const tbody = document.getElementById('companyTable');
            tbody.innerHTML = '';

            if (companies.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="2" class="text-center text-muted">
                            ${emptyMessage}
                        </td>
                    </tr>
                `;
                return;
            }

            companies.forEach(c => {
                const escapedName = (c.company_name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');

                // æ‰€æœ‰å…¬å¸éƒ½é¡¯ç¤ºæŠ•éå’Œä¸‹è¼‰æŒ‰éˆ•
                const actionButtons = `
                    <div class="d-flex flex-column gap-2">
                        <button
                            class="btn btn-outline-primary btn-sm"
                            onclick="openApply(${c.id}, '${escapedName}')"
                        >
                            <i class="bi bi-send me-1"></i>æŠ•é
                        </button>
                        <button
                            type="button"
                            class="btn btn-outline-primary btn-sm download-company-btn"
                            onclick="downloadCompanyFile(${c.id}, '${escapedName}')"
                            title="ä¸‹è¼‰å…¬å¸è³‡æ–™"
                        >
                            <i class="bi bi-file-earmark-arrow-down-fill me-1"></i>ä¸‹è¼‰å…¬å¸è³‡æ–™ (DOCX)
                        </button>
                    </div>
                `;

                tbody.innerHTML += `
                    <tr id="company-row-${c.id}">
                        <td>${c.company_name}</td>
                        <td>
                            ${actionButtons}
                        </td>
                    </tr>
                `;
            });
        }

        // å·²ç§»é™¤è³‡æ–™å¤¾ç›¸é—œåŠŸèƒ½ï¼Œæ”¹ç”¨åˆ†é¡ç³»çµ±

        /* ===============================
           è¼‰å…¥å±¥æ­·å¯©æ ¸ç‹€æ…‹
        ================================ */
        async function loadResumeStatuses() {
            try {
                // ç²å–æ‰€æœ‰å±¥æ­·
                const res = await fetch('/api/my_resumes');
                const result = await res.json();

                if (!result.success || !result.resumes) {
                    throw new Error(result.message || 'ç„¡æ³•ç²å–å±¥æ­·åˆ—è¡¨');
                }

                // ç²å–æŠ•éä¿¡æ¯ï¼ˆå¾ student_preferencesï¼‰
                const prefRes = await fetch('/api/get_my_preferences');
                const prefResult = await prefRes.json();

                const preferences = prefResult.success ? (prefResult.preferences || []) : [];

                // åˆä½µå±¥æ­·å’ŒæŠ•éä¿¡æ¯
                // åªé¡¯ç¤ºæ­£å¼ç‰ˆæœ¬ï¼ˆcategory='ready'ï¼‰çš„å±¥æ­·ï¼Œæ ¹æ“š status ä¾†åˆ†é¡
                allResumeStatuses = result.resumes
                    .filter(r => {
                        const category = r.category || 'draft';
                        return category === 'ready';
                    })
                    .map(resume => {
                        // æ‰¾åˆ°å°æ‡‰çš„æŠ•éè¨˜éŒ„ï¼ˆé€šé resume_id åŒ¹é…ï¼‰
                        const preference = preferences.find(p => p.resume_id === resume.id);
                        return {
                            ...resume,
                            company_name: preference ? preference.company_name : 'å°šæœªé¸æ“‡',
                            job_title: preference ? (preference.job_title || 'å°šæœªé¸æ“‡') : 'å°šæœªé¸æ“‡',
                            preference_id: preference ? preference.id : null,
                            applied_at: preference ? (preference.submitted_at || resume.created_at) : resume.created_at
                        };
                    });

                updateResumeStatusCounts();
                filterResumeStatus(currentResumeStatus);
            } catch (err) {
                console.error('è¼‰å…¥å±¥æ­·å¯©æ ¸ç‹€æ…‹å¤±æ•—:', err);
                document.getElementById('resumeStatusTable').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-danger">
                            <i class="bi bi-exclamation-triangle"></i> è¼‰å…¥å¤±æ•—ï¼š${err.message}
                        </td>
                    </tr>
                `;
            }
        }

        /* ===============================
           æ›´æ–°å±¥æ­·å¯©æ ¸ç‹€æ…‹è¨ˆæ•¸
        ================================ */
        function updateResumeStatusCounts() {
            const counts = {
                reviewing: 0,
                rejected: 0,
                approved: 0
            };

            allResumeStatuses.forEach(resume => {
                const status = resume.status || 'uploaded';
                // æ ¹æ“š status æ¬„ä½ä¾†åˆ†é¡
                if (status === 'uploaded') {
                    counts.reviewing++; // å¯©æ ¸ä¸­
                } else if (status === 'rejected') {
                    counts.rejected++; // é€€ä»¶
                } else if (status === 'approved') {
                    counts.approved++; // é€šé
                }
            });

            Object.keys(counts).forEach(status => {
                const badge = document.getElementById(`count-${status}`);
                if (badge) {
                    badge.textContent = counts[status];
                }
            });
        }

        /* ===============================
           ç¯©é¸å±¥æ­·å¯©æ ¸ç‹€æ…‹
        ================================ */
        function filterResumeStatus(status) {
            currentResumeStatus = status;

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('[data-status]').forEach(btn => {
                if (btn.getAttribute('data-status') === status) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // ç¯©é¸å±¥æ­·ï¼ˆæ ¹æ“š status æ¬„ä½ï¼‰
            const filteredResumes = allResumeStatuses.filter(r => {
                const resumeStatus = r.status || 'uploaded';
                // å°‡ status æ˜ å°„åˆ°é ç±¤
                if (status === 'reviewing') {
                    return resumeStatus === 'uploaded'; // å¯©æ ¸ä¸­
                } else if (status === 'rejected') {
                    return resumeStatus === 'rejected'; // é€€ä»¶
                } else if (status === 'approved') {
                    return resumeStatus === 'approved'; // é€šé
                }
                return false;
            });

            renderResumeStatusTable(filteredResumes);
        }

        /* ===============================
           æ¸²æŸ“å±¥æ­·å¯©æ ¸ç‹€æ…‹è¡¨æ ¼
        ================================ */
        function renderResumeStatusTable(resumes) {
            const tbody = document.getElementById('resumeStatusTable');

            if (resumes.length === 0) {
                const statusLabels = {
                    'reviewing': 'å¯©æ ¸ä¸­',
                    'rejected': 'é€€ä»¶',
                    'approved': 'é€šé'
                };
                const statusText = statusLabels[currentResumeStatus] || 'å¯©æ ¸ä¸­';
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="bi bi-inbox"></i> ç›®å‰æ²’æœ‰${statusText}çš„å±¥æ­·
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = resumes.map(resume => {
                const resumeStatus = resume.status || 'uploaded';
                const statusLabels = {
                    'uploaded': '<span class="badge bg-warning resume-status-badge">å¯©æ ¸ä¸­</span>',
                    'rejected': '<span class="badge bg-danger resume-status-badge">é€€ä»¶</span>',
                    'approved': '<span class="badge bg-success resume-status-badge">é€šé</span>'
                };
                // æ ¼å¼åŒ–æ—¥æœŸ
                let appliedDate = 'æœªçŸ¥';
                if (resume.applied_at) {
                    try {
                        const date = new Date(resume.applied_at);
                        appliedDate = date.toLocaleDateString('zh-TW', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    } catch (e) {
                        appliedDate = resume.applied_at;
                    }
                }

                return `
                    <tr>
                        <td>${resume.original_filename || 'æœªå‘½åå±¥æ­·'}</td>
                        <td>${resume.company_name || 'å°šæœªé¸æ“‡'}</td>
                        <td>${resume.job_title || 'å°šæœªé¸æ“‡'}</td>
                        <td>${appliedDate}</td>
                        <td>${statusLabels[resumeStatus] || '<span class="badge bg-secondary">æœªçŸ¥</span>'}</td>
                        <td>${resume.comment || '<span class="text-muted">ç„¡</span>'}</td>
                        <td class="text-center">
                            <a href="/api/download_resume/${resume.id}" class="btn btn-sm btn-outline-primary" target="_blank">
                                <i class="bi bi-download"></i> ä¸‹è¼‰
                            </a>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /* ===============================
           è¼‰å…¥å…¬å¸è·ç¼º
        ================================ */
        async function loadJobsByCompany(companyId) {
            console.log('ğŸ” [DEBUG] åŠ è½½å…¬å¸èŒç¼º:', companyId);
            const jobSelect = document.getElementById('jobSelect');
            jobSelect.innerHTML = '<option value="">è¼‰å…¥ä¸­...</option>';

            try {
                const apiUrl = `/api/get_jobs_by_company?company_id=${companyId}&_v=${CACHE_VERSION}`;
                console.log('ğŸ“¤ [DEBUG] è¯·æ±‚ URL:', apiUrl);
                console.log('ğŸ“¤ [DEBUG] ç¡®ä¿ä½¿ç”¨æ­£ç¡®è·¯å¾„: /api/get_jobs_by_company (ä¸æ˜¯ /preferences/api/get_jobs_by_company)');
                const res = await fetch(apiUrl);
                console.log('ğŸ“¥ æ”¶åˆ°èŒç¼ºå“åº”:', res.status, res.statusText);

                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }

                const result = await res.json();
                console.log('ğŸ“¦ èŒç¼ºæ•°æ®:', result);

                jobSelect.innerHTML = '<option value="">è«‹é¸æ“‡è·ç¼º</option>';

                if (result.success && result.jobs && result.jobs.length > 0) {
                    result.jobs.forEach(job => {
                        jobSelect.innerHTML += `
                            <option value="${job.id}">${job.title}</option>
                        `;
                    });
                    console.log(`âœ… æˆåŠŸåŠ è½½ ${result.jobs.length} ä¸ªèŒç¼º`);
                } else {
                    jobSelect.innerHTML = '<option value="">æ­¤å…¬å¸å°šç„¡è·ç¼º</option>';
                    console.warn('âš ï¸ è¯¥å…¬å¸æ²¡æœ‰èŒç¼ºæˆ–åŠ è½½å¤±è´¥:', result);
                }
            } catch (error) {
                console.error('âŒ åŠ è½½èŒç¼ºå¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                jobSelect.innerHTML = '<option value="">è¼‰å…¥è·ç¼ºå¤±æ•—</option>';
                alert(`è¼‰å…¥è·ç¼ºå¤±æ•—ï¼š${error.message}\n\nè«‹ç¢ºèªï¼š\n1. å·²åˆ·æ–°é é¢æ¸…é™¤ç·©å­˜ï¼ˆCtrl+F5ï¼‰\n2. å¾Œç«¯æœå‹™æ­£å¸¸é‹è¡Œ`);
            }
        }

        /* ===============================
           é–‹å•ŸæŠ•éè¦–çª—
        ================================ */
        async function openApply(companyId, companyName) {
            // æª¢æŸ¥æˆªæ­¢æ™‚é–“
            if (deadlineExpired) {
                alert('âš ï¸ å·²è¶…éæŠ•éå±¥æ­·æˆªæ­¢æ™‚é–“ï¼Œç„¡æ³•å†æŠ•éå±¥æ­·ã€‚');
                return;
            }

            // å†æ¬¡æª¢æŸ¥æˆªæ­¢æ™‚é–“ï¼ˆé˜²æ­¢ç‹€æ…‹è®ŠåŒ–ï¼‰
            try {
                const deadlineCheck = await fetch("/announcement/api/check_deadline?type=resume");
                const deadlineResult = await deadlineCheck.json();
                if (deadlineResult.success && deadlineResult.has_deadline && deadlineResult.is_expired) {
                    alert(`âš ï¸ å·²è¶…éæŠ•éå±¥æ­·æˆªæ­¢æ™‚é–“ï¼š${deadlineResult.deadline}ï¼Œç„¡æ³•å†æŠ•éå±¥æ­·ã€‚`);
                    deadlineExpired = true;
                    return;
                }
            } catch (error) {
                console.error("æª¢æŸ¥æˆªæ­¢æ™‚é–“å¤±æ•—:", error);
            }

            selectedCompanyId = companyId;

            document.getElementById('applyCompanyName').innerText =
                `å…¬å¸ï¼š${companyName}`;

            // è¼‰å…¥è·ç¼º
            loadJobsByCompany(companyId);

            // è¼‰å…¥æ­£å¼ç‰ˆæœ¬çš„å±¥æ­·ï¼ˆå¯ä»¥æŠ•éçš„å±¥æ­·ï¼‰
            loadAvailableResumes();

            new bootstrap.Modal(
                document.getElementById('applyModal')
            ).show();
        }

        /* ===============================
           è¼‰å…¥å¯æŠ•éçš„å±¥æ­·ï¼ˆæ­£å¼ç‰ˆæœ¬ï¼‰
        ================================ */
        async function loadAvailableResumes() {
            const resumeSelect = document.getElementById('resumeSelect');

            // é¡¯ç¤ºè¼‰å…¥ä¸­ç‹€æ…‹
            resumeSelect.innerHTML = '<option value="">è¼‰å…¥ä¸­...</option>';
            resumeSelect.disabled = true;

            try {
                // ç²å–æ‰€æœ‰å±¥æ­·ï¼Œç¯©é¸å‡ºæ­£å¼ç‰ˆæœ¬ï¼ˆcategory='draft' ä¸” status='uploaded' ä¸” note='submitted'ï¼‰
                // æˆ–è€…å·²ç¶“åœ¨å¯©æ ¸ä¸­çš„å±¥æ­·ï¼ˆcategory='reviewing'ï¼Œå¯ä»¥é‡è¤‡æŠ•éï¼‰
                const res = await fetch('/api/my_resumes');
                const result = await res.json();

                if (!result.success || !result.resumes) {
                    throw new Error(result.message || 'ç„¡æ³•ç²å–å±¥æ­·åˆ—è¡¨');
                }

                // ç¯©é¸å‡ºå¯ä»¥æŠ•éçš„å±¥æ­·ï¼šåªé¡¯ç¤ºæ­£å¼ç‰ˆæœ¬ï¼ˆcategory='ready'ï¼‰
                const availableResumes = result.resumes.filter(r => {
                    const category = r.category || 'draft';
                    return category === 'ready';
                });

                if (availableResumes.length === 0) {
                    resumeSelect.innerHTML = '<option value="">å°šç„¡å¯æŠ•éçš„å±¥æ­·ï¼Œè«‹å…ˆæäº¤å±¥æ­·ç‚ºæ­£å¼ç‰ˆæœ¬</option>';
                    console.log('â„¹ï¸ æ²’æœ‰æ‰¾åˆ°å¯æŠ•éçš„å±¥æ­·');
                } else {
                    // ç”Ÿæˆé¸é …åˆ—è¡¨
                    const options = availableResumes.map(r => {
                        const id = r.id;
                        const filename = r.original_filename || 'æœªå‘½åå±¥æ­·';
                        const category = r.category || 'draft';
                        const status = r.status || 'uploaded';

                        // æ ¼å¼åŒ–æ—¥æœŸ
                        let timeStr = '';
                        if (r.created_at) {
                            try {
                                const date = new Date(r.created_at);
                                timeStr = date.toLocaleDateString('zh-TW', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                            } catch (e) {
                                timeStr = r.created_at;
                            }
                        }

                        // ç‹€æ…‹æ¨™ç±¤
                        let statusLabel = '';
                        if (category === 'reviewing') statusLabel = ' [å¯©æ ¸ä¸­]';
                        else if (status === 'uploaded' && r.note === 'submitted') statusLabel = ' [æ­£å¼ç‰ˆæœ¬]';

                        return `<option value="${id}">${filename}${statusLabel}${timeStr ? ' - ' + timeStr : ''}</option>`;
                    });

                    resumeSelect.innerHTML = '<option value="">è«‹é¸æ“‡å±¥æ­·</option>' + options;
                    console.log(`âœ… æˆåŠŸè¼‰å…¥ ${availableResumes.length} å€‹å¯æŠ•éçš„å±¥æ­·`);
                }
            } catch (err) {
                console.error('âŒ è¼‰å…¥å±¥æ­·å¤±æ•—:', err);
                resumeSelect.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>';
                alert(`è¼‰å…¥å±¥æ­·å¤±æ•—ï¼š${err.message}`);
            } finally {
                resumeSelect.disabled = false;
            }
        }

        /* ===============================
           ä¸‹è¼‰å…¬å¸è³‡æ–™ï¼ˆæ”¹é€²ç‰ˆï¼Œå¸¶éŒ¯èª¤è™•ç†ï¼‰
        ================================ */
        async function downloadCompanyFile(companyId, companyName) {
            if (!companyId) {
                alert('âŒ éŒ¯èª¤ï¼šç¼ºå°‘å…¬å¸ ID');
                return;
            }

            try {
                console.log('ğŸ“¤ [DEBUG] ä¸‹è½½å…¬å¸æ–‡ä»¶ï¼ŒID:', companyId, 'å…¬å¸åç¨±:', companyName);
                const response = await fetch(`/api/download_company_file/${companyId}`);
                console.log('ğŸ“¥ æ”¶åˆ°å“åº”:', response.status, response.statusText, response.headers.get('content-type'));

                if (!response.ok) {
                    // å¦‚æœæ˜¯ HTML éŒ¯èª¤é é¢ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                    const text = await response.text();
                    if (text.includes('<html>')) {
                        // æå–éŒ¯èª¤è¨Šæ¯
                        const errorMatch = text.match(/<h2>éŒ¯èª¤ï¼š(.+?)<\/h2>/);
                        const errorMsg = errorMatch ? errorMatch[1] : 'ä¸‹è¼‰å¤±æ•—';
                        alert(`âŒ ${errorMsg}\n\nå…¬å¸ï¼š${companyName || 'æœªçŸ¥'}\nIDï¼š${companyId}`);
                        return;
                    }
                    // å¦‚æœæ˜¯ JSON éŒ¯èª¤
                    try {
                        const data = await response.json();
                        alert(`âŒ ${data.message || 'ä¸‹è¼‰å¤±æ•—'}\n\nå…¬å¸ï¼š${companyName || 'æœªçŸ¥'}\nIDï¼š${companyId}`);
                    } catch (e) {
                        alert(`âŒ ä¸‹è¼‰å¤±æ•—ï¼ˆHTTP ${response.status}ï¼‰\n\nå…¬å¸ï¼š${companyName || 'æœªçŸ¥'}\nIDï¼š${companyId}`);
                    }
                    return;
                }

                // æª¢æŸ¥ Content-Type æ˜¯å¦ç‚ºæ–‡ä»¶
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    // å¦‚æœæ˜¯ JSONï¼Œè¡¨ç¤ºæ˜¯éŒ¯èª¤è¨Šæ¯
                    const data = await response.json();
                    alert(`âŒ ${data.message || 'ä¸‹è¼‰å¤±æ•—'}\n\nå…¬å¸ï¼š${companyName || 'æœªçŸ¥'}\nIDï¼š${companyId}`);
                    return;
                }

                // å¾ Content-Disposition æ¨™é ­ç²å–æ–‡ä»¶åï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨å…¬å¸åç¨±
                let filename = `${companyName || 'company'}_${companyId}.docx`;
                const contentDisposition = response.headers.get('content-disposition');
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                    if (filenameMatch && filenameMatch[1]) {
                        filename = filenameMatch[1].replace(/['"]/g, '');
                    }
                }

                // ä¸‹è¼‰æ–‡ä»¶
                console.log('ğŸ“¦ å¼€å§‹ä¸‹è½½æ–‡ä»¶ï¼Œæ–‡ä»¶å:', filename);
                const blob = await response.blob();
                console.log('ğŸ“¦ Blob å¤§å°:', blob.size, 'bytes');
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                console.log('âœ… ä¸‹è½½é“¾æ¥å·²ç‚¹å‡»');
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                console.error('âŒ ä¸‹è¼‰éŒ¯èª¤:', error);
                alert(`âŒ ä¸‹è¼‰æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}\n\nå…¬å¸ï¼š${companyName || 'æœªçŸ¥'}\nIDï¼š${companyId}`);
            }
        }

        // ç¡®ä¿å‡½æ•°åœ¨å…¨å±€ä½œç”¨åŸŸä¸­
        window.downloadCompanyFile = downloadCompanyFile;
        window.filterCompanies = filterCompanies;

        /* ===============================
           é€å‡ºæŠ•é
        ================================ */
        async function submitApply() {
            // å†æ¬¡æª¢æŸ¥æˆªæ­¢æ™‚é–“ï¼ˆé˜²æ­¢ç”¨æˆ¶ç¹éå‰ç«¯æª¢æŸ¥ï¼‰
            if (deadlineExpired) {
                alert('âš ï¸ å·²è¶…éæŠ•éå±¥æ­·æˆªæ­¢æ™‚é–“ï¼Œç„¡æ³•å†æŠ•éå±¥æ­·ã€‚');
                return;
            }

            try {
                const deadlineCheck = await fetch("/announcement/api/check_deadline?type=resume");
                const deadlineResult = await deadlineCheck.json();
                if (deadlineResult.success && deadlineResult.has_deadline && deadlineResult.is_expired) {
                    alert(`âš ï¸ å·²è¶…éæŠ•éå±¥æ­·æˆªæ­¢æ™‚é–“ï¼š${deadlineResult.deadline}ï¼Œç„¡æ³•å†æŠ•éå±¥æ­·ã€‚`);
                    return;
                }
            } catch (error) {
                console.error("æª¢æŸ¥æˆªæ­¢æ™‚é–“å¤±æ•—:", error);
            }

            const resumeId = document.getElementById('resumeSelect').value;
            const jobId = document.getElementById('jobSelect').value;

            if (!jobId) {
                alert('è«‹é¸æ“‡è·ç¼º');
                return;
            }

            if (!resumeId) {
                alert('è«‹é¸æ“‡å±¥æ­·');
                return;
            }

            const res = await fetch('/api/student/apply_company', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    company_id: selectedCompanyId,
                    job_id: jobId,
                    resume_id: resumeId
                })
            });

            const result = await res.json();

            if (result.success) {
                alert('æŠ•éæˆåŠŸ');
                bootstrap.Modal
                    .getInstance(document.getElementById('applyModal'))
                    .hide();
            } else {
                alert(result.message || 'æŠ•éå¤±æ•—');
            }
        }

        // é¸å–®é–‹é—œé‚è¼¯
        document.addEventListener("DOMContentLoaded", async () => {
            const menuBtn = document.getElementById("menu-btn");
            const sideMenu = document.getElementById("side-menu");
            const closeBtn = document.getElementById("close-btn");

            if (menuBtn && sideMenu && closeBtn) {
                menuBtn.addEventListener("click", () => {
                    sideMenu.classList.add("open");
                    sideMenu.setAttribute("aria-hidden", "false");
                });

                closeBtn.addEventListener("click", () => {
                    sideMenu.classList.remove("open");
                    sideMenu.setAttribute("aria-hidden", "true");
                });

                // å¦‚æœé»æ“Š menu ä»¥å¤–çš„åœ°æ–¹å°±é—œé–‰é¸å–®
                document.addEventListener("click", (e) => {
                    if (
                        !sideMenu.contains(e.target) &&
                        !menuBtn.contains(e.target)
                    ) {
                        sideMenu.classList.remove("open");
                        sideMenu.setAttribute("aria-hidden", "true");
                    }
                });
            }

            // é¦–å…ˆæª¢æŸ¥æˆªæ­¢æ™‚é–“
            await checkDeadlineAndDisableApply();

            // è¼‰å…¥å…¬å¸è³‡æ–™å’Œå±¥æ­·è³‡æ–™å¤¾
            loadCompanies();
            // å·²ç§»é™¤è³‡æ–™å¤¾è¼‰å…¥ï¼Œæ”¹ç”¨åˆ†é¡ç³»çµ±

            // è¼‰å…¥å±¥æ­·å¯©æ ¸ç‹€æ…‹
            loadResumeStatuses();
        });
    </script>

    <!-- å´é‚Šé¸å–® -->
    <nav id="side-menu" aria-hidden="true" role="navigation" aria-label="åŠŸèƒ½é¸å–®">
        <div class="menu-header">
            <h2>åŠŸèƒ½é¸å–®</h2>
            <button id="close-btn" aria-label="é—œé–‰åŠŸèƒ½é¸å–®">Ã—</button>
        </div>
        <a href="/student_home">é¦–é </a>
        <a href="/profile">å€‹äººè³‡æ–™</a>
        <a href="/resume_folders">å±¥æ­·ç®¡ç†</a>
        <a href="/fill_preferences">å¡«å¯«å¿—é¡˜åº</a>
        <a href="/look_company">æŠ•éå±¥æ­·</a>
        <a href="/notifications">é€šçŸ¥</a>
        <a href="/interview_schedule">è¡Œäº‹æ›†</a>
        <a href="/intern_achievement">å­¸ç”Ÿåª’åˆçµæœ</a>
        <a href="/intern_experience">å¯¦ç¿’å¿ƒå¾—</a>
        <a href="/logout">ç™»å‡º</a>
    </nav>
</body>

</html>