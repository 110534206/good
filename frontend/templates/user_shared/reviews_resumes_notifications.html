<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>智慧實習平台 | 廠商查看履歷與通知</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    /* 這裡保留您原本所有的 CSS 樣式 */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --color-primary: #0066cc;
      --color-primary-dark: #024689;
      --color-border: #e2e8f0;
      --color-bg: #f5f7fb;
      --color-card: #ffffff;
      --color-text: #1f2933;
      --color-muted: #64748b;
      --color-success: #16a34a;
      --color-danger: #dc2626;
      --color-warning: #f97316;
      --shadow-sm: 0 1px 2px rgba(15, 23, 42, 0.08);
      --shadow-md: 0 8px 24px rgba(15, 23, 42, 0.08);
      --radius-md: 12px;
      --radius-lg: 16px;
    }
    body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background: var(--color-bg); color: var(--color-text); min-height: 100vh; }
    header { background: linear-gradient(135deg, #0055a8 0%, #006acb 50%, #004f94 100%); position: sticky; top: 0; z-index: 10; box-shadow: 0 8px 20px rgba(0, 68, 148, 0.35); }
    .topbar { max-width: 1200px; margin: 0 auto; padding: 18px 24px; display: flex; align-items: center; justify-content: center; color: #fff; }
    .topbar h1 { font-size: 1.5rem; margin: 0; display: flex; align-items: center; justify-content: space-between; width: 100%; }
    #menu-btn { width: 30px; height: 22px; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; background: none; border: none; }
    #menu-btn span { display: block; width: 100%; height: 3px; background-color: white; border-radius: 2px; }
    main.management-container { max-width: 1200px; margin: 24px auto 60px; padding: 0 24px; }
    .panel { background: var(--color-card); border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-md); border: 1px solid var(--color-border); }
    .status-badge { font-size: 0.85rem; padding: 0.4em 0.8em; border-radius: 6px; }
    #side-menu { position: fixed; top: 0; left: 0; height: 100vh; width: 280px; background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(6px); transform: translateX(-100%); transition: transform 0.3s ease; z-index: 1300; padding: 2rem; color: #fff; }
    #side-menu.open { transform: translateX(0); }
    #side-menu a { display: block; color: #e2e8f0; text-decoration: none; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
    #close-btn { position: absolute; top: 10px; right: 20px; font-size: 2rem; background: none; border: none; color: white; }
    /* ... 這裡省略其他重複樣式，請保留您原本的樣式表 ... */
  </style>
</head>
<body>

  <header>
    <div class="topbar">
      <h1>
        <button id="menu-btn" aria-label="開啟選單"><span></span><span></span><span></span></button>
        <div class="header-title text-center flex-grow-1">查看履歷與通知</div>
        <div style="width: 30px;"></div>
      </h1>
    </div>
  </header>

  <main class="management-container">
    <section class="panel">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>學生履歷列表</h2>
        <button class="btn btn-outline-primary" onclick="viewEmailLogs()">查看已發送 Email</button>
      </div>

      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <select id="companyFilter" class="form-select"><option value="">所有職缺</option></select>
        </div>
        <div class="col-md-3">
          <select id="statusFilter" class="form-select">
            <option value="">所有狀態</option>
            <option value="pending">待審核</option>
            <option value="approved">通過</option>
            <option value="rejected">退件</option>
          </select>
        </div>
        <div class="col-md-6">
          <input type="text" id="searchBox" class="form-control" placeholder="搜尋姓名或學號..." />
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>學號</th>
              <th>姓名</th>
              <th>投遞職缺</th>
              <th>上傳日期</th>
              <th>履歷檔案</th>
              <th>目前狀態</th>
              <th>動作</th>
            </tr>
          </thead>
          <tbody id="resumeTableBody"></tbody>
        </table>
      </div>
      <nav><ul class="pagination justify-content-center mt-4" id="pagination"></ul></nav>
    </section>
  </main>

  <div class="modal fade" id="notificationModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">發送面試/錄取通知</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">學生姓名</label>
            <input type="text" class="form-control" id="studentNameInput" readonly />
          </div>
          <div class="mb-3">
            <label class="form-label">學生 Email</label>
            <input type="email" class="form-control" id="studentEmailInput" readonly />
          </div>
          <div class="mb-3">
            <label class="form-label">通知類型</label>
            <select class="form-select" id="notificationType">
              <option value="interview">面試通知</option>
              <option value="admission">錄取通知</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">面試地點</label>
            <input type="text" class="form-control" id="interviewLocationInput" placeholder="請輸入面試地點">
          </div>
          <div class="mb-3">
            <label class="form-label">面試時間</label>
            <input type="text" class="form-control" id="interviewTimeInput" placeholder="例如：2026-02-01 10:00">
          </div>
          <div class="mb-3">
            <label class="form-label">需攜帶文件</label>
            <textarea class="form-control" id="interviewDocumentsInput" rows="2"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">備註事項</label>
            <textarea class="form-control" id="interviewNotesInput" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="sendNotificationBtn">確認發送</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="emailLogsModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h5>Email 發送記錄</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <table class="table table-sm">
            <thead><tr><th>時間</th><th>收件人</th><th>主旨</th><th>狀態</th></tr></thead>
            <tbody id="emailLogsTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <nav id="side-menu">
    <button id="close-btn">&times;</button>
    <div class="mt-4">
      <a href="/vendor_home">首頁</a>
      <a href="/vendor_review_resume">學生履歷審核</a>
      <a href="/manage_positions">職位需求管理</a>
      <a href="/logout">登出</a>
    </div>
  </nav>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ---------------- 全域變數 ----------------
    let allResumes = [];
    let currentPage = 1;
    const rowsPerPage = 10;
    let currentStudentId = null;

    // ---------------- 初始化 ----------------
    document.addEventListener("DOMContentLoaded", () => {
      fetchResumes();
      initEvents();
    });

    function initEvents() {
      document.getElementById("companyFilter").onchange = applyFilters;
      document.getElementById("statusFilter").onchange = applyFilters;
      document.getElementById("searchBox").oninput = applyFilters;
      document.getElementById("sendNotificationBtn").onclick = sendNotification;
      
      const menu = document.getElementById('side-menu');
      document.getElementById('menu-btn').onclick = () => menu.classList.add('open');
      document.getElementById('close-btn').onclick = () => menu.classList.remove('open');
    }

    // ---------------- 資料獲取 ----------------
    function fetchResumes() {
      Promise.all([
        fetch('/vendor/api/resumes').then(r => r.json()),
        fetch('/vendor/api/positions').then(r => r.json())
      ]).then(([resData, posData]) => {
        if (resData.success) {
          allResumes = resData.resumes || [];
          populateJobFilter(posData.items || []);
          applyFilters();
        }
      });
    }

    function populateJobFilter(items) {
      const select = document.getElementById("companyFilter");
      items.forEach(item => {
        const opt = new Option(item.title, item.id);
        select.add(opt);
      });
    }

    // ---------------- 渲染邏輯 ----------------
    function applyFilters() {
      const jobVal = document.getElementById("companyFilter").value;
      const statusVal = document.getElementById("statusFilter").value;
      const searchVal = document.getElementById("searchBox").value.toLowerCase();

      const filtered = allResumes.filter(r => {
        const matchJob = !jobVal || String(r.job_id) === jobVal || r.job_title === jobVal;
        const matchStatus = !statusVal || r.status === statusVal;
        const name = (r.name || '').toLowerCase();
        const sid = (r.username || '').toLowerCase();
        const matchSearch = !searchVal || name.includes(searchVal) || sid.includes(searchVal);
        return matchJob && matchStatus && matchSearch;
      });
      renderTable(filtered);
    }

    function renderTable(data) {
      const tbody = document.getElementById("resumeTableBody");
      const start = (currentPage - 1) * rowsPerPage;
      const paginated = data.slice(start, start + rowsPerPage);

      if (paginated.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">暫無匹配資料</td></tr>';
        return;
      }

      tbody.innerHTML = paginated.map(r => `
        <tr>
          <td>${r.username || '-'}</td>
          <td>${r.name || '-'}</td>
          <td>${r.job_title || '-'}</td>
          <td>${r.upload_time || '-'}</td>
          <td>
            ${r.filepath ? `<a href="/api/download_resume/${r.id}" target="_blank" class="btn btn-sm btn-outline-primary">下載</a>` : '無檔案'}
          </td>
          <td>
            <span class="badge bg-${r.status==='approved'?'success':r.status==='rejected'?'danger':'info'}">
              ${r.status==='approved'?'通過':r.status==='rejected'?'退件':'待審'}
            </span>
          </td>
          <td>
            <button class="btn btn-success btn-sm" onclick="openNotificationModal(${r.student_id}, '${r.name}')">發送通知</button>
          </td>
        </tr>
      `).join('');
      renderPagination(data.length);
    }

    function renderPagination(total) {
      const totalPages = Math.ceil(total / rowsPerPage);
      const container = document.getElementById("pagination");
      container.innerHTML = '';
      for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="javascript:void(0)" onclick="goToPage(${i})">${i}</a>`;
        container.appendChild(li);
      }
    }

    function goToPage(p) { currentPage = p; applyFilters(); }

    // ---------------- 通知發送邏輯 (核心修復) ----------------
    function openNotificationModal(studentId, studentName) {
      currentStudentId = studentId;
      
      // 獲取該學生的詳細資料（主要是 Email）
      fetch(`/vendor/api/applications?student_id=${studentId}`)
        .then(res => res.json())
        .then(data => {
          const info = (data.items && data.items[0]) || {};
          document.getElementById("studentNameInput").value = studentName;
          document.getElementById("studentEmailInput").value = info.student_email || '無電子郵件紀錄';
          
          // 清空所有輸入欄位，避免上一次的資料殘留
          document.getElementById("interviewLocationInput").value = '';
          document.getElementById("interviewTimeInput").value = '';
          document.getElementById("interviewDocumentsInput").value = '';
          document.getElementById("interviewNotesInput").value = '';

          new bootstrap.Modal(document.getElementById("notificationModal")).show();
        });
    }

    function sendNotification() {
      const loc = document.getElementById("interviewLocationInput").value.trim();
      const time = document.getElementById("interviewTimeInput").value.trim();
      const docs = document.getElementById("interviewDocumentsInput").value.trim();
      const notes = document.getElementById("interviewNotesInput").value.trim();

      if (!loc || !time) {
        alert("面試地點與時間為必填項！");
        return;
      }

      // 組合所有欄位內容
      const finalContent = `【面試通知內容】\n地點：${loc}\n時間：${time}\n需帶文件：${docs}\n其他備註：${notes}`;

      const btn = document.getElementById("sendNotificationBtn");
      btn.disabled = true;
      btn.textContent = "發送中...";

      fetch('/vendor/api/send_notification', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          student_id: currentStudentId,
          notification_type: document.getElementById("notificationType").value,
          content: finalContent
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("通知發送成功！");
          bootstrap.Modal.getInstance(document.getElementById("notificationModal")).hide();
        } else {
          alert("發送失敗：" + data.message);
        }
      })
      .catch(err => alert("網路錯誤，請稍後再試"))
      .finally(() => {
        btn.disabled = false;
        btn.textContent = "確認發送";
      });
    }

    function viewEmailLogs() {
      const tbody = document.getElementById("emailLogsTableBody");
      tbody.innerHTML = '<tr><td colspan="4" class="text-center">讀取中...</td></tr>';
      new bootstrap.Modal(document.getElementById("emailLogsModal")).show();

      fetch('/vendor/api/email_logs?limit=50')
        .then(res => res.json())
        .then(data => {
          if (data.success && data.logs) {
            tbody.innerHTML = data.logs.map(l => `
              <tr>
                <td>${l.sent_at || '-'}</td>
                <td>${l.recipient_email || '-'}</td>
                <td>${l.subject || '-'}</td>
                <td><span class="badge bg-success">已發送</span></td>
              </tr>
            `).join('');
          }
        });
    }
  </script>
</body>
</html>