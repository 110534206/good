<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>智慧實習平台 | 公司詳情</title>
  <style>
    :root {
      --color-primary: #0066cc;
      --color-primary-dark: #024689;
      --color-border: #e2e8f0;
      --color-bg: #f5f7fb;
      --color-card: #ffffff;
      --color-text: #1f2933;
      --color-muted: #64748b;
      --color-success: #16a34a;
      --color-danger: #dc2626;
      --shadow-sm: 0 1px 2px rgba(15, 23, 42, 0.08);
      --shadow-md: 0 8px 24px rgba(15, 23, 42, 0.08);
      --radius-md: 12px;
      --radius-lg: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Noto Sans TC', sans-serif;
      background: var(--color-bg);
      color: var(--color-text);
      margin: 0;
      min-height: 100vh;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    .container {
      width: 100%;
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    main.company-detail-container {
      padding: 32px 0 64px;
      display: grid;
      gap: 24px;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: #ffffff;
      background-color: var(--color-primary);
      padding: 10px 20px;
      border-radius: 8px;
      text-decoration: none;
      transition: background-color 0.2s ease, transform 0.2s ease;
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
      width: fit-content;
    }

    .back-link:hover {
      background-color: var(--color-primary-dark);
      transform: translateY(-1px);
      color: #ffffff;
    }

    .back-link:active {
      transform: translateY(0);
    }

    .company-hero {
      background: var(--color-card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-border);
      padding: 32px;
      box-shadow: var(--shadow-md);
      display: grid;
      gap: 16px;
    }

    .company-hero h1 {
      margin: 0;
      font-size: 2rem;
    }

    .hero-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      color: var(--color-muted);
      font-size: 0.95rem;
    }

    .hero-description {
      font-size: 1rem;
      line-height: 1.7;
    }

    .company-description-panel {
      background: var(--color-card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-border);
      padding: 24px;
      box-shadow: var(--shadow-md);
      margin-top: 24px;
    }

    .company-description-panel h2 {
      margin: 0 0 12px;
      font-size: 1.25rem;
      color: var(--color-text);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .company-description-content {
      font-size: 1rem;
      line-height: 1.7;
      color: var(--color-text);
      white-space: pre-wrap;
      margin: 0;
      padding: 0;
      text-align: justify;
      text-align-last: left;
      word-spacing: normal;
      letter-spacing: normal;
      text-indent: 0;
    }

    .company-description-panel .info-grid {
      margin-top: 16px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0;
      column-gap: 12px;
      row-gap: 12px;
    }

    .info-card {
      background: #f8fbff;
      border-radius: var(--radius-md);
      border: 1px solid #dee7f3;
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
    }

    .info-card:hover {
      background: #e8f2ff;
      border-color: var(--color-primary);
      transform: translateY(-1px);
    }

    .info-card > a > span {
      display: block;
    }
    
    .info-card span span {
      display: inline;
    }

    .info-label {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--color-muted);
      margin-bottom: 4px;
      display: block;
    }

    .info-value {
      font-weight: 600;
      color: var(--color-text);
      display: block;
      word-break: break-word;
    }

    .panel {
      background: var(--color-card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-border);
      padding: 28px;
      box-shadow: var(--shadow-md);
    }

    .panel-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
    }

    .panel-header h2 {
      margin: 0;
    }

    .jobs-list {
      display: grid;
      gap: 20px;
    }

    .job-card {
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 20px;
      background: #f8fafc;
    }

    .job-card h3 {
      margin: 0 0 10px;
    }

    .job-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      font-size: 0.9rem;
      color: var(--color-muted);
      margin-bottom: 12px;
    }

    .job-section {
      margin-top: 12px;
      font-size: 0.92rem;
      line-height: 1.6;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .status-pill.active {
      background: rgba(22, 163, 74, 0.15);
      color: var(--color-success);
    }

    .status-pill.inactive {
      background: rgba(100, 116, 139, 0.15);
      color: var(--color-muted);
    }

    .empty-state {
      padding: 48px;
      text-align: center;
      color: var(--color-muted);
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      min-width: 240px;
      max-width: 360px;
      padding: 14px 16px;
      background: var(--color-text);
      color: #fff;
      border-radius: 12px;
      box-shadow: 0 12px 32px rgba(15, 23, 42, 0.2);
      display: none;
      z-index: 1500;
      font-weight: 600;
    }

    .toast.show {
      display: block;
    }

    .toast.success {
      background: var(--color-success);
    }

    .toast.error {
      background: var(--color-danger);
    }

    .btn-edit {
      background: var(--color-primary);
      color: #fff;
      padding: 8px 16px;
      font-size: 0.875rem;
      font-weight: 600;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.15s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-edit:hover {
      background: var(--color-primary-dark);
      transform: translateY(-1px);
    }

    .btn-edit:active {
      transform: translateY(0);
    }

    .edit-form-group {
      margin-bottom: 16px;
    }

    .edit-form-group label {
      display: block;
      font-weight: 600;
      color: var(--color-muted);
      margin-bottom: 6px;
      font-size: 0.9rem;
    }

    .edit-form-group textarea,
    .edit-form-group input[type="text"],
    .edit-form-group input[type="email"],
    .edit-form-group input[type="tel"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--color-border);
      font-size: 0.95rem;
      background: #fff;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      font-family: inherit;
    }

    .edit-form-group textarea:focus,
    .edit-form-group input:focus {
      border-color: var(--color-primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.15);
    }

    .edit-form-group textarea {
      min-height: 120px;
      resize: vertical;
    }

    .edit-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 16px;
    }

    .btn-save {
      background: var(--color-success);
      color: #fff;
      padding: 10px 20px;
      font-size: 0.95rem;
      font-weight: 600;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .btn-save:hover:not(:disabled) {
      background: #15803d;
    }

    .btn-save:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-cancel {
      background: rgba(15, 23, 42, 0.05);
      color: var(--color-text);
      padding: 10px 20px;
      font-size: 0.95rem;
      font-weight: 600;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .btn-cancel:hover {
      background: rgba(15, 23, 42, 0.08);
    }

    @media (max-width: 768px) {
      .company-hero {
        padding: 24px;
      }

      .panel {
        padding: 22px;
      }
    }
  </style>
</head>

<body>

  <main class="company-detail-container container" data-company-id="{{ company_id }}" id="main-container">
    <section class="company-hero" id="companyHero">
      <div>
        <span class="hero-meta">公司資訊載入中...</span>
      </div>
    </section>

  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    (() => {
      'use strict';

      // 從 data 屬性獲取 company_id，避免在 script 中使用模板語法
      const mainContainer = document.getElementById('main-container');
      const COMPANY_ID = mainContainer ? parseInt(mainContainer.dataset.companyId, 10) : null;
      
      if (!COMPANY_ID) {
        console.error('無法獲取公司 ID');
        return;
      }

      const state = {
        company: null,
        jobs: [],
        resumeStats: {
          approved: 0,
          rejected: 0,
          pending: 0
        },
        isEditing: false,
        originalData: null
      };

      const els = {
        companyHero: document.getElementById('companyHero'),
        toast: document.getElementById('toast')
      };

      function showToast(message, type = 'info') {
        if (!els.toast) return;
        els.toast.textContent = message;
        els.toast.className = `toast show ${type}`;
        clearTimeout(els.toast._timer);
        els.toast._timer = setTimeout(() => {
          els.toast.classList.remove('show');
        }, 3600);
      }

      function escapeHtml(str) {
        if (typeof str !== 'string') return '';
        return str.replace(/[&<>"']/g, (char) => {
          const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
          return map[char] || char;
        });
      }

      function formatText(value, defaultText = '—') {
        if (value === null || value === undefined || value === '') return defaultText;
        return escapeHtml(String(value));
      }

      function renderJobsEditSection() {
        const jobs = state.jobs || [];
        if (jobs.length === 0) {
          return `
            <div style="margin-top: 32px; padding-top: 32px; border-top: 1px solid var(--color-border);">
              <h3 style="margin: 0 0 16px; font-size: 1.1rem;">提供中的職缺</h3>
              <p style="color: var(--color-muted);">目前沒有職缺</p>
            </div>
          `;
        }
        
        return `
          <div style="margin-top: 32px; padding-top: 32px; border-top: 1px solid var(--color-border);">
            <h3 style="margin: 0 0 16px; font-size: 1.1rem;">提供中的職缺</h3>
            <div style="display: grid; gap: 20px;">
              ${jobs.map((job, index) => `
                <div class="job-edit-card" style="border: 1px solid var(--color-border); border-radius: 8px; padding: 16px; background: #f8fafc;">
                  <div class="edit-form-group">
                    <label for="editJobTitle_${index}">職缺名稱</label>
                    <input type="text" id="editJobTitle_${index}" name="job_title_${job.id}" value="${escapeHtml(job.title || '')}" />
                  </div>
                  <div class="info-grid" style="margin-top: 12px;">
                    <div class="edit-form-group">
                      <label for="editJobSlots_${index}">名額</label>
                      <input type="number" id="editJobSlots_${index}" name="job_slots_${job.id}" value="${job.slots || 0}" min="1" />
                    </div>
                    <div class="edit-form-group">
                      <label for="editJobPeriod_${index}">期間</label>
                      <input type="text" id="editJobPeriod_${index}" name="job_period_${job.id}" value="${escapeHtml(job.period || '')}" />
                    </div>
                    <div class="edit-form-group">
                      <label for="editJobWorkTime_${index}">上班時間</label>
                      <input type="text" id="editJobWorkTime_${index}" name="job_work_time_${job.id}" value="${escapeHtml(job.work_time || '')}" />
                    </div>
                    <div class="edit-form-group">
                      <label for="editJobSalary_${index}">薪資</label>
                      <input type="text" id="editJobSalary_${index}" name="job_salary_${job.id}" value="${escapeHtml(job.salary || '')}" />
                    </div>
                  </div>
                  <div class="edit-form-group" style="margin-top: 12px;">
                    <label for="editJobDescription_${index}">職務說明</label>
                    <textarea id="editJobDescription_${index}" name="job_description_${job.id}" rows="3">${escapeHtml(job.description || '')}</textarea>
                  </div>
                  <div class="edit-form-group" style="margin-top: 12px;">
                    <label for="editJobRemark_${index}">備註</label>
                    <textarea id="editJobRemark_${index}" name="job_remark_${job.id}" rows="2">${escapeHtml(job.remark || '')}</textarea>
                  </div>
                  <input type="hidden" name="job_id_${index}" value="${job.id}" />
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      function renderCompany() {
        const company = state.company;
        if (!company) {
          els.companyHero.innerHTML = `
            <div class="empty-state" style="padding:24px;">
              <p>找不到公司資料。</p>
            </div>
          `;
          return;
        }

        const description = company.description || '尚未提供公司簡介。';
        const contactBlocks = [
          { label: '聯絡人', value: [company.contact_person, company.contact_title].filter(Boolean).join(' / ') || '—' },
          { label: '電子郵件', value: company.contact_email || '—' },
          { label: '聯絡電話', value: company.contact_phone || '—' },
          { label: '公司地址', value: company.location || '—' }
        ];

        els.companyHero.innerHTML = `
          <div>
            <h1>${escapeHtml(company.name)}</h1>
          </div>
          <div class="info-grid" style="margin-top: 16px;">
            <div class="info-card" style="cursor: pointer;">
              <a href="/vendor_review_resume?company_id=${COMPANY_ID}" style="display: block; text-decoration: none; color: inherit;">
                <span class="info-label">廠商審核狀態</span>
                <span class="info-value" style="color: var(--color-muted);">總筆數<span id="totalCount" style="margin-left: 4px;">${state.resumeStats.pending + state.resumeStats.approved + state.resumeStats.rejected}</span></span>
              </a>
            </div>
            <div class="info-card" style="cursor: pointer;">
              <a href="/vendor_review_resume?status=pending&company_id=${COMPANY_ID}" style="display: block; text-decoration: none; color: inherit;">
                <span class="info-label">廠商審核狀態</span>
                <span class="info-value" style="color: var(--color-primary);">待審核<span id="pendingCount" style="margin-left: 4px;">${state.resumeStats.pending}</span></span>
              </a>
            </div>
            <div class="info-card" style="cursor: pointer;">
              <a href="/vendor_review_resume?status=approved&company_id=${COMPANY_ID}" style="display: block; text-decoration: none; color: inherit;">
                <span class="info-label">廠商審核狀態</span>
                <span class="info-value" style="color: var(--color-success);">通過<span id="approvedCount" style="margin-left: 4px;">${state.resumeStats.approved}</span></span>
              </a>
            </div>
            <div class="info-card" style="cursor: pointer;">
              <a href="/vendor_review_resume?status=rejected&company_id=${COMPANY_ID}" style="display: block; text-decoration: none; color: inherit;">
                <span class="info-label">廠商審核狀態</span>
                <span class="info-value" style="color: var(--color-danger);">退件<span id="rejectedCount" style="margin-left: 4px;">${state.resumeStats.rejected}</span></span>
              </a>
            </div>
          </div>
        `;

        // 移除舊的公司介紹面板（如果存在）
        const existingDescriptionPanel = document.querySelector('.company-description-panel');
        if (existingDescriptionPanel) {
          existingDescriptionPanel.remove();
        }

        // 渲染公司介紹到獨立的框框中，包含聯絡資訊
        const descriptionPanel = document.createElement('section');
        descriptionPanel.className = 'company-description-panel';
        descriptionPanel.setAttribute('aria-label', '公司簡介');
        
        if (state.isEditing) {
          // 編輯模式
          descriptionPanel.innerHTML = `
            <h2>
              <span>公司簡介</span>
            </h2>
            <form id="companyEditForm">
              <div class="edit-form-group">
                <label for="editDescription">公司簡介</label>
                <textarea id="editDescription" name="description">${escapeHtml(description)}</textarea>
              </div>
              <div class="info-grid">
                <div class="edit-form-group">
                  <label for="editContactPerson">聯絡人</label>
                  <input type="text" id="editContactPerson" name="contact_person" value="${escapeHtml(company.contact_person || '')}" />
                </div>
                <div class="edit-form-group">
                  <label for="editContactTitle">職稱</label>
                  <input type="text" id="editContactTitle" name="contact_title" value="${escapeHtml(company.contact_title || '')}" />
                </div>
                <div class="edit-form-group">
                  <label for="editContactEmail">電子郵件</label>
                  <input type="email" id="editContactEmail" name="contact_email" value="${escapeHtml(company.contact_email || '')}" />
                </div>
                <div class="edit-form-group">
                  <label for="editContactPhone">聯絡電話</label>
                  <input type="tel" id="editContactPhone" name="contact_phone" value="${escapeHtml(company.contact_phone || '')}" />
                </div>
                <div class="edit-form-group" style="grid-column: 1 / -1;">
                  <label for="editLocation">公司地址</label>
                  <input type="text" id="editLocation" name="location" value="${escapeHtml(company.location || '')}" />
                </div>
              </div>
              ${renderJobsEditSection()}
              <div class="edit-actions" style="margin-top: 32px;">
                <button type="button" class="btn-cancel" id="cancelEditBtn">取消</button>
                <button type="submit" class="btn-save" id="saveEditBtn">儲存</button>
              </div>
            </form>
          `;
        } else {
          // 檢視模式
          const jobs = state.jobs || [];
          const jobsHtml = jobs.length > 0 ? `
            <div style="margin-top: 32px; padding-top: 32px; border-top: 1px solid var(--color-border);">
              <div class="panel-header" style="margin-bottom: 20px;">
                <h2>提供中的職缺</h2>
                <span style="color:var(--color-muted);">${jobs.length} 個職缺</span>
              </div>
              <div class="jobs-list">
                ${jobs.map(job => `
                  <article class="job-card">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;">
                      <div>
                        <h3>${escapeHtml(job.title)}</h3>
                        <div class="status-pill ${job.is_active ? 'active' : 'inactive'}">
                          ${job.is_active ? '啟用中' : '未啟用'}
                        </div>
                      </div>
                    </div>
                    <div class="job-meta">
                      <span>名額：${job.slots ?? 0} 人</span>
                      <span>期間：${formatText(job.period)}</span>
                      <span>上班時間：${formatText(job.work_time)}</span>
                      <span>薪資：${formatText(job.salary)}</span>
                    </div>
                    ${job.description ? `<div class="job-section"><strong>職務說明：</strong>${escapeHtml(job.description)}</div>` : ''}
                    ${job.remark ? `<div class="job-section"><strong>備註：</strong>${escapeHtml(job.remark)}</div>` : ''}
                  </article>
                `).join('')}
              </div>
            </div>
          ` : `
            <div style="margin-top: 32px; padding-top: 32px; border-top: 1px solid var(--color-border);">
              <div class="panel-header" style="margin-bottom: 20px;">
                <h2>提供中的職缺</h2>
                <span style="color:var(--color-muted);">0 個職缺</span>
              </div>
              <div class="empty-state">
                <p>目前沒有可供顯示的職缺。</p>
              </div>
            </div>
          `;
          
          descriptionPanel.innerHTML = `
            <h2>
              <span>公司簡介</span>
              <button class="btn-edit" id="editCompanyBtn">修改</button>
            </h2>
            <div class="company-description-content">${escapeHtml(description)}</div>
            <div class="info-grid">
              ${contactBlocks.map(block => `
                <div class="info-card">
                  <span class="info-label">${escapeHtml(block.label)}</span>
                  <span class="info-value">${escapeHtml(block.value)}</span>
                </div>
              `).join('')}
            </div>
            ${jobsHtml}
          `;
        }
        // 將公司介紹面板插入到 company-hero 之後
        if (els.companyHero && els.companyHero.parentNode) {
          els.companyHero.parentNode.insertBefore(descriptionPanel, els.companyHero.nextSibling);
        }
        
        // 載入並顯示廠商已審核的學生履歷
        loadVendorReviewedStudents();
        
        // 綁定編輯模式的事件
        if (state.isEditing) {
          bindEditEvents();
        } else {
          bindViewEvents();
        }
      }


      function setLoading() {
        if (els.companyHero) {
          els.companyHero.innerHTML = `
            <div class="hero-meta">公司資料載入中...</div>
          `;
        }
      }

      async function loadResumeStats() {
        try {
          // 重置統計
          state.resumeStats = {
            approved: 0,
            rejected: 0,
            pending: 0
          };
          
          // 從廠商審核結果 API 獲取數據，統計廠商的審核狀態
          const response = await fetch(`/api/public/company/${COMPANY_ID}/vendor-reviewed-students`, {
            headers: { 'Accept': 'application/json' },
            credentials: 'include'
          });
          const result = await response.json();
          
          // 獲取廠商已審核的學生 ID 集合
          const vendorReviewedStudentIds = new Set();
          if (response.ok && result.success && result.students) {
            // 根據廠商的審核狀態統計
            result.students.forEach(s => {
              vendorReviewedStudentIds.add(s.student_id);
              const status = s.vendor_review_status;
              if (status === 'approved') {
                state.resumeStats.approved++;
              } else if (status === 'rejected') {
                state.resumeStats.rejected++;
              }
            });
          }
          
          // 獲取所有選擇該公司的學生履歷，但只計算指導老師已審核通過的
          const allResumesResponse = await fetch(`/api/get_class_resumes?company_id=${COMPANY_ID}`, {
            headers: { 'Accept': 'application/json' },
            credentials: 'include'
          });
          const allResumesResult = await allResumesResponse.json();
          
          if (allResumesResponse.ok && allResumesResult.success && allResumesResult.resumes) {
            // 只計算：指導老師已審核通過（status = 'approved'）且廠商尚未審核的數量
            const pendingResumes = allResumesResult.resumes.filter(r => {
              // 必須是指導老師已審核通過的履歷
              const isTeacherApproved = r.status === 'approved';
              // 且廠商尚未審核（不在 vendor-reviewed-students 中）
              const isNotVendorReviewed = !vendorReviewedStudentIds.has(r.user_id || r.student_id);
              return isTeacherApproved && isNotVendorReviewed;
            });
            state.resumeStats.pending = pendingResumes.length;
          }
        } catch (error) {
          console.error('載入履歷統計失敗:', error);
        }
      }

      function updateResumeCounts() {
        // 更新顯示的數量
        const totalEl = document.getElementById('totalCount');
        const approvedEl = document.getElementById('approvedCount');
        const rejectedEl = document.getElementById('rejectedCount');
        const pendingEl = document.getElementById('pendingCount');
        
        // 計算總筆數
        const total = state.resumeStats.pending + state.resumeStats.approved + state.resumeStats.rejected;
        if (totalEl) totalEl.textContent = total;
        if (approvedEl) approvedEl.textContent = state.resumeStats.approved;
        if (rejectedEl) rejectedEl.textContent = state.resumeStats.rejected;
        if (pendingEl) pendingEl.textContent = state.resumeStats.pending;
      }

      async function loadVendorReviewedStudents() {
        try {
          const response = await fetch(`/api/public/company/${COMPANY_ID}/vendor-reviewed-students`, {
            headers: { 'Accept': 'application/json' },
            credentials: 'include'
          });
          const result = await response.json();
          
          if (!response.ok || !result.success) {
            throw new Error(result.message || '載入失敗');
          }
          
          const students = result.students || [];
          
          // 移除舊的廠商審核區塊（如果存在）
          const existingPanel = document.getElementById('vendor-reviewed-panel');
          if (existingPanel) {
            existingPanel.remove();
          }
          
          // 創建新的廠商審核區塊
          const vendorPanel = document.createElement('section');
          vendorPanel.id = 'vendor-reviewed-panel';
          vendorPanel.className = 'company-description-panel';
          vendorPanel.setAttribute('aria-label', '廠商審核結果');
          
          if (students.length > 0) {
            vendorPanel.innerHTML = `
              <h2>廠商審核結果</h2>
              <div style="margin-top: 20px;">
                <table style="width: 100%; border-collapse: collapse;">
                  <thead>
                    <tr style="background: #f1f5f9; border-bottom: 2px solid #e2e8f0;">
                      <th style="padding: 12px; text-align: left; font-weight: 600;">學生姓名</th>
                      <th style="padding: 12px; text-align: left; font-weight: 600;">學號</th>
                      <th style="padding: 12px; text-align: left; font-weight: 600;">班級</th>
                      <th style="padding: 12px; text-align: left; font-weight: 600;">職缺</th>
                      <th style="padding: 12px; text-align: left; font-weight: 600;">審核狀態</th>
                      <th style="padding: 12px; text-align: left; font-weight: 600;">廠商備註</th>
                      <th style="padding: 12px; text-align: left; font-weight: 600;">審核時間</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${students.map(s => `
                      <tr style="border-bottom: 1px solid #e2e8f0;">
                        <td style="padding: 12px;">${escapeHtml(s.student_name || '—')}</td>
                        <td style="padding: 12px;">${escapeHtml(s.student_number || '—')}</td>
                        <td style="padding: 12px;">${escapeHtml(s.class_name || '—')}</td>
                        <td style="padding: 12px;">${escapeHtml(s.job_title || '—')}</td>
                        <td style="padding: 12px;">
                          <span style="padding: 4px 8px; border-radius: 4px; font-size: 0.875rem; font-weight: 600; 
                            ${s.vendor_review_status === 'approved' ? 'background: #dcfce7; color: #16a34a;' : 
                              s.vendor_review_status === 'rejected' ? 'background: #fee2e2; color: #dc2626;' : 
                              'background: #fef3c7; color: #f97316;'}">
                            ${s.vendor_review_status === 'approved' ? '通過' : 
                              s.vendor_review_status === 'rejected' ? '退件' : '待審核'}
                          </span>
                        </td>
                        <td style="padding: 12px; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                          ${escapeHtml(s.vendor_comment || '—')}
                        </td>
                        <td style="padding: 12px;">${escapeHtml(s.vendor_reviewed_at || '—')}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            `;
          } else {
            vendorPanel.innerHTML = `
              <h2>廠商審核結果</h2>
              <div class="empty-state" style="padding: 24px; text-align: center; color: var(--color-muted);">
                <p>目前沒有廠商已審核的學生履歷。</p>
              </div>
            `;
          }
          
          // 將廠商審核區塊插入到公司介紹面板之後
          const descriptionPanel = document.querySelector('.company-description-panel');
          if (descriptionPanel && descriptionPanel.parentNode) {
            descriptionPanel.parentNode.insertBefore(vendorPanel, descriptionPanel.nextSibling);
          } else if (els.companyHero && els.companyHero.parentNode) {
            els.companyHero.parentNode.insertBefore(vendorPanel, els.companyHero.nextSibling);
          }
        } catch (error) {
          console.error('載入廠商審核結果失敗:', error);
          // 不顯示錯誤提示，因為這不是主要功能
        }
      }

      async function loadDetail() {
        setLoading();
        try {
          const response = await fetch(`/api/public/company/${COMPANY_ID}`, {
            headers: { 'Accept': 'application/json' },
            credentials: 'include'
          });
          const result = await response.json();
          if (!response.ok || !result.success) {
            throw new Error(result.message || '載入失敗');
          }
          state.company = result.company;
          state.jobs = result.jobs || [];
          // 先載入履歷統計，再渲染公司信息
          await loadResumeStats();
          renderCompany();
          // 渲染後更新數量（確保元素已存在）
          updateResumeCounts();
        } catch (error) {
          showToast(error.message || '載入資料失敗', 'error');
          if (els.companyHero) {
            els.companyHero.innerHTML = `
              <div class="empty-state" style="padding:24px;">
                <p>無法載入公司資訊，請稍後再試。</p>
              </div>
            `;
          }
        }
      }

      function bindViewEvents() {
        const editBtn = document.getElementById('editCompanyBtn');
        if (editBtn) {
          editBtn.addEventListener('click', () => {
            state.originalData = {
              description: state.company.description || '',
              contact_person: state.company.contact_person || '',
              contact_title: state.company.contact_title || '',
              contact_email: state.company.contact_email || '',
              contact_phone: state.company.contact_phone || '',
              location: state.company.location || ''
            };
            state.isEditing = true;
            renderCompany();
          });
        }
      }

      function bindEditEvents() {
        const form = document.getElementById('companyEditForm');
        const cancelBtn = document.getElementById('cancelEditBtn');
        const saveBtn = document.getElementById('saveEditBtn');
        
        if (cancelBtn) {
          cancelBtn.addEventListener('click', () => {
            state.isEditing = false;
            renderCompany();
          });
        }
        
        if (form) {
          form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (saveBtn) {
              saveBtn.disabled = true;
              saveBtn.textContent = '儲存中...';
            }
            
            try {
              const formData = new FormData(form);
              const updateData = {
                description: document.getElementById('editDescription').value.trim(),
                contact_person: document.getElementById('editContactPerson').value.trim(),
                contact_title: document.getElementById('editContactTitle').value.trim(),
                contact_email: document.getElementById('editContactEmail').value.trim(),
                contact_phone: document.getElementById('editContactPhone').value.trim(),
                location: document.getElementById('editLocation').value.trim()
              };
              
              // 調用 API 更新公司資訊
              const response = await fetch(`/api/public/company/${COMPANY_ID}`, {
                method: 'PUT',
                headers: {
                  'Content-Type': 'application/json',
                  'Accept': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(updateData)
              });
              
              const result = await response.json();
              
              if (!response.ok || !result.success) {
                throw new Error(result.message || '更新失敗');
              }
              
              // 更新本地狀態
              state.company.description = updateData.description;
              state.company.contact_person = updateData.contact_person;
              state.company.contact_title = updateData.contact_title;
              state.company.contact_email = updateData.contact_email;
              state.company.contact_phone = updateData.contact_phone;
              state.company.location = updateData.location;
              
              // 更新職缺資訊
              const jobs = state.jobs || [];
              for (let index = 0; index < jobs.length; index++) {
                const job = jobs[index];
                const jobId = job.id;
                const jobTitleEl = document.getElementById(`editJobTitle_${index}`);
                const jobSlotsEl = document.getElementById(`editJobSlots_${index}`);
                const jobPeriodEl = document.getElementById(`editJobPeriod_${index}`);
                const jobWorkTimeEl = document.getElementById(`editJobWorkTime_${index}`);
                const jobSalaryEl = document.getElementById(`editJobSalary_${index}`);
                const jobDescriptionEl = document.getElementById(`editJobDescription_${index}`);
                const jobRemarkEl = document.getElementById(`editJobRemark_${index}`);
                
                if (!jobId || !jobTitleEl) continue;
                
                const jobUpdateData = {
                  title: jobTitleEl.value.trim(),
                  slots: parseInt(jobSlotsEl?.value || '0', 10),
                  period: jobPeriodEl?.value.trim() || null,
                  work_time: jobWorkTimeEl?.value.trim() || null,
                  salary: jobSalaryEl?.value.trim() || null,
                  description: jobDescriptionEl?.value.trim() || null,
                  remark: jobRemarkEl?.value.trim() || null
                };
                
                // 更新本地職缺狀態
                const jobIndex = state.jobs.findIndex(j => j.id === jobId);
                if (jobIndex !== -1) {
                  state.jobs[jobIndex] = {
                    ...state.jobs[jobIndex],
                    ...jobUpdateData
                  };
                }
                
                // 嘗試更新職缺（如果 API 可用）
                try {
                  const jobResponse = await fetch(`/api/public/company/${COMPANY_ID}/jobs/${jobId}`, {
                    method: 'PUT',
                    headers: {
                      'Content-Type': 'application/json',
                      'Accept': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(jobUpdateData)
                  });
                  
                  if (jobResponse.ok) {
                    const jobResult = await jobResponse.json();
                    if (jobResult.success && jobResult.item) {
                      // 使用伺服器返回的資料更新本地狀態
                      state.jobs[jobIndex] = jobResult.item;
                    }
                  }
                } catch (err) {
                  // 忽略職缺更新錯誤，不影響公司資訊更新
                  console.warn('職缺更新失敗:', err);
                }
              }
              
              state.isEditing = false;
              showToast('公司資訊更新成功', 'success');
              
              // 重新載入資料以確保同步
              await loadDetail();
            } catch (error) {
              showToast(error.message || '更新失敗，請稍後再試', 'error');
              if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.textContent = '儲存';
              }
            }
          });
        }
      }

      function init() {
        loadDetail();
      }

      document.addEventListener('DOMContentLoaded', init);
    })();
  </script>
</body>

</html>

