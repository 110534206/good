<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ™ºæ…§å¯¦ç¿’å¹³å° | ä¸»ä»»åª’åˆ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />
  <style>
    :root {
      --color-primary: #0454a3;
      --color-primary-dark: #0454a3;
      --color-border: #e2e8f0;
      --color-bg: #f7f9fc;
      --color-card: #ffffff;
      --color-text: #1f2933;
      --color-muted: #64748b;
      --color-success: #16a34a;
      --color-danger: #dc2626;
      --color-warning: #fbbf24;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Noto Sans TC', sans-serif;
      background: var(--color-bg);
      color: var(--color-text);
      margin: 0;
      min-height: 100vh;
    }

    header {
      background: linear-gradient(135deg, #0055a8 0%, #006acb 50%, #004f94 100%);
      border-bottom: none;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 8px 20px rgba(0, 68, 148, 0.35);
    }

    .topbar {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      position: relative;
    }

    .topbar h1 {
      font-size: 1.5rem;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      color: #fff;
      flex: 1;
    }

    .topbar h1 .header-title {
      flex: 1;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    #menu-btn {
      width: 30px;
      height: 22px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      background: none;
      border: none;
      padding: 0;
    }

    #menu-btn span {
      display: block;
      width: 100%;
      height: 3px;
      background-color: white;
      border-radius: 2px;
      transition: all 0.3s ease;
    }

    main.management-container {
      max-width: 1200px;
      margin: 24px auto 60px;
      padding: 0 24px;
    }

    .panel {
      background: var(--color-card);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      margin-bottom: 24px;
      overflow: hidden;
    }

    .panel-header {
      background: linear-gradient(135deg, #0055a8 0%, #006acb 100%);
      color: #fff;
      padding: 20px 24px;
      font-size: 1.25rem;
      font-weight: 600;
    }

    .panel-body {
      padding: 24px;
    }

    .company-navigation {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      padding: 16px 20px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid var(--color-border);
    }

    .nav-buttons {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .nav-btn {
      padding: 8px 16px;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      background: #fff;
      color: var(--color-text);
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .nav-btn:hover:not(:disabled) {
      background: var(--color-primary);
      color: #fff;
      border-color: var(--color-primary);
    }

    .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .company-counter {
      font-size: 0.95rem;
      color: var(--color-muted);
      font-weight: 500;
    }

    .duplicate-alert {
      background: #fef3c7;
      border-left: 4px solid var(--color-warning);
      padding: 16px;
      margin-bottom: 24px;
      border-radius: 8px;
    }

    .duplicate-alert h4 {
      color: #92400e;
      margin-bottom: 8px;
      font-size: 1.1rem;
    }

    .duplicate-alert ul {
      margin: 0;
      padding-left: 20px;
      color: #78350f;
    }

    .company-card {
      border: 2px solid var(--color-border);
      border-radius: 12px;
      overflow: visible;  /* æ”¹ç‚º visibleï¼Œè®“å…§å®¹å¯ä»¥è¶…å‡ºå¡ç‰‡ */
      background: var(--color-card);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: box-shadow 0.2s ease;
      min-width: 400px;
      max-width: 500px;
      flex-shrink: 0;
      position: relative;  /* ç¢ºä¿å¡ç‰‡å¯ä»¥æ­£ç¢ºæ¥æ”¶æ‹–æ”¾äº‹ä»¶ */
      z-index: 1;  /* ç¢ºä¿å¡ç‰‡åœ¨æ­£ç¢ºçš„å±¤ç´š */
    }

    .company-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }

    .company-card.full {
      opacity: 0.6;
      background: #f3f4f6;
      border-color: #d1d5db;
    }

    .company-card.full .company-header {
      background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%);
    }

    .company-card.full .company-header:hover {
      background: linear-gradient(135deg, #4b5563 0%, #6b7280 100%);
    }

    .company-card.full .company-content {
      background: #f9fafb;
    }

    .company-header {
      background: linear-gradient(135deg, #0055a8 0%, #006acb 100%);
      color: #fff;
      padding: 18px 24px;
      border-bottom: none;
      font-weight: 600;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      user-select: none;
      transition: background 0.2s ease;
      position: relative;  /* ç¢ºä¿æ¨™é¡Œå¯ä»¥æ­£ç¢ºæ¥æ”¶æ‹–æ”¾äº‹ä»¶ */
      z-index: 2;  /* ç¢ºä¿æ¨™é¡Œåœ¨å¡ç‰‡å…§å®¹ä¹‹ä¸Š */
    }

    .company-header:hover {
      background: linear-gradient(135deg, #004a94 0%, #005bb8 100%);
    }

    .company-header .toggle-icon {
      font-size: 1rem;
      transition: transform 0.3s ease;
      margin-left: 12px;
    }

    .company-card.collapsed .company-header .toggle-icon {
      transform: rotate(-90deg);
    }

    .company-content {
      max-height: 5000px;
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.3s ease;
      opacity: 1;
    }

    .company-card.collapsed .company-content {
      max-height: 0;
      opacity: 0;
      padding: 0;
      pointer-events: none;  /* æ”¶åˆæ™‚ä¸æ¥æ”¶é»æ“Šäº‹ä»¶ï¼Œä½†å…è¨±æ‹–æ”¾äº‹ä»¶ç©¿é€ */
    }

    .job-section {
      padding: 20px;
      border-bottom: 1px solid var(--color-border);
      overflow: visible;  /* è®“å…§å®¹å¯ä»¥è¶…å‡ºå€å¡Š */
    }

    .job-section:last-child {
      border-bottom: none;
    }

    .job-title {
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: 16px;
      font-size: 1.05rem;
    }

    .btn-sm {
      padding: 4px 8px;
      font-size: 0.8rem;
      min-width: auto;
    }

    .regular-list, .reserve-list {
      margin-bottom: 16px;
      overflow: visible;  /* è®“ç©ºä½æ¡†æ ¼å¯ä»¥è¶…å‡ºåˆ—è¡¨ç¯„åœ */
    }

    .list-label {
      font-weight: 600;
      color: var(--color-muted);
      margin-bottom: 12px;
      font-size: 0.9rem;
      text-transform: uppercase;
    }

    .student-item {
      background: #fff;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s ease;
    }

    .student-item:hover {
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .student-item.duplicate {
      border-left: 4px solid var(--color-warning);
      background: #fffbeb;
    }

    .student-info {
      flex: 1;
    }

    .student-name {
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: 4px;
    }

    .student-details {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 0.9rem;
      color: var(--color-muted);
    }

    .student-details-row {
      display: flex;
      gap: 16px;
    }

    .student-details span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 8px;
    }

    .badge-regular {
      background: var(--color-success);
      color: #fff;
    }

    .badge-reserve {
      background: var(--color-warning);
      color: #fff;
    }

    .badge-duplicate {
      background: var(--color-danger);
      color: #fff;
    }

    .preference-order {
      color: var(--color-primary);
      font-weight: 600;
    }

    .student-actions {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .btn-danger {
      background: var(--color-danger);
      color: #fff;
    }

    .btn-danger:hover {
      background: #b91c1c;
    }

    .btn-primary {
      background: var(--color-primary);
      color: #fff;
    }

    .btn-primary:hover {
      background: var(--color-primary-dark);
    }

    .btn-success {
      background: var(--color-success);
      color: #fff;
    }

    .btn-success:hover {
      background: #15803d;
    }

    .empty-slot {
      border: 2px dashed var(--color-border);
      background: #f8fafc;
      padding: 16px;
      text-align: center;
      color: var(--color-muted);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .empty-slot:hover {
      border-color: var(--color-primary);
      background: #eff6ff;
      color: var(--color-primary);
    }

    .empty-slot i {
      font-size: 1.5rem;
      margin-bottom: 8px;
      display: block;
    }

    #side-menu {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 320px;
      max-width: 80vw;
      background-color: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(6px);
      box-shadow: 3px 0 12px rgba(0, 0, 0, 0.6);
      padding: 2rem 1.5rem;
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
      z-index: 1300;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      color: #fff;
      user-select: none;
    }

    #side-menu.open {
      transform: translateX(0);
    }

    #close-btn {
      position: absolute;
      top: 2rem;
      right: 1.6rem;
      font-size: 2.2rem;
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      line-height: 1;
      width: 2.4rem;
      height: 2.4rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #side-menu h2 {
      margin: 0.5rem 0 1.5rem;
      font-weight: 700;
      font-size: 1.6rem;
    }

    #side-menu a {
      display: block;
      width: 100%;
      padding: 0.6rem 0;
      font-size: 1.1rem;
      color: #e2e8f0;
      text-decoration: none;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }

    #side-menu a:hover {
      background-color: rgba(255, 255, 255, 0.18);
      color: #fff;
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      min-width: 240px;
      max-width: 360px;
      padding: 14px 16px;
      background: var(--color-text);
      color: #fff;
      border-radius: 12px;
      box-shadow: 0 12px 32px rgba(15, 23, 42, 0.2);
      display: none;
      z-index: 1500;
      font-weight: 600;
    }

    .toast.show {
      display: block;
      animation: fade-in 0.2s ease;
    }

    .toast.success {
      background: var(--color-success);
    }

    .toast.error {
      background: var(--color-danger);
    }

    @keyframes fade-in {
      from {
        transform: translateY(8px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 48px;
      color: var(--color-muted);
    }

    .loading .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid rgba(4, 84, 163, 0.2);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* åª’åˆçµæœéæ¿¾å™¨å’Œå¡ç‰‡æ¨£å¼ï¼ˆèˆ‡ final_results.html ç›¸åŒï¼‰ */
    .filters-container {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
      padding: 20px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.06);
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      min-width: 200px;
    }

    .filter-group label {
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--color-text);
    }

    .filter-group select,
    .filter-group input {
      width: 100%;
      padding: 10px 16px;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      font-size: 0.95rem;
      color: var(--color-text);
      background: #ffffff;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 12px;
      padding-right: 36px;
    }

    .filter-group input {
      background-image: none;
      padding-right: 16px;
    }

    .filter-group select:focus,
    .filter-group input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(4, 84, 163, 0.1);
    }

  
    .companies-container {
     display: flex;
     flex-direction: row;
     flex-wrap: wrap;  /* å…è¨±æ›è¡Œï¼Œç•¶æ©«å‘ç©ºé–“ä¸è¶³æ™‚è‡ªå‹•æ›åˆ°ä¸‹ä¸€è¡Œ */
     gap: 24px;
     padding: 10px 5px 20px 5px; 
     align-items: flex-start;
     justify-content: flex-start;  /* å¾å·¦é–‹å§‹æ’åˆ— */
     }

    .companies-container::after {
      content: '';
      flex: 1 1 calc(33.333% - 24px);  /* å¹«åŠ©æœ€å¾Œä¸€è¡Œå°é½Š */
      max-width: calc(33.333% - 24px);
    }


    .company-card {
    border: 2px solid var(--color-border);
    border-radius: 12px;
    background: var(--color-card);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    margin-bottom: 24px;  /* ç¢ºä¿æ¯å€‹å¡ç‰‡ä¹‹é–“æœ‰é–“è· */
    
    /* ä¸€æ’é¡¯ç¤º3å€‹ï¼Œæ¯å€‹ä½”ç´„33.33%å¯¬åº¦ï¼Œæ¸›å»gap */
    flex: 1 1 calc(33.333% - 16px);
    min-width: 300px;  /* æœ€å°å¯¬åº¦ï¼Œç¢ºä¿åœ¨å°è¢å¹•ä¸Šä¹Ÿèƒ½æ­£å¸¸é¡¯ç¤º */
    max-width: calc(33.333% - 16px);  /* æœ€å¤§å¯¬åº¦ï¼Œç¢ºä¿ä¸€æ’3å€‹ */
    display: flex;
    flex-direction: column;
    overflow: visible;  /* æ”¹ç‚º visibleï¼Œè®“ä¸‹æ–¹çš„æ¡†æ ¼å¯ä»¥è¶…å‡ºå¡ç‰‡ç¯„åœ */
    position: relative;  /* ç¢ºä¿å¡ç‰‡ç¨ç«‹å®šä½ */
    }

    .companies-container::-webkit-scrollbar {
      height: 8px;
    }

    .companies-container::-webkit-scrollbar-track {
      background: #f0f0f0;
      border-radius: 4px;
    }

    .companies-container::-webkit-scrollbar-thumb {
      background: var(--color-primary);
      border-radius: 4px;
    }

    .companies-container::-webkit-scrollbar-thumb:hover {
      background: var(--color-primary-dark);
    }

    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--color-muted);
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 16px;
      color: rgba(4, 84, 163, 0.3);
    }

    /* æœªè¢«éŒ„å–å­¸ç”Ÿåˆ—è¡¨æ¨£å¼ */
    #unmatchedStudentsContainer {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }

    .unmatched-student-item {
      background: #fff;
      border: 1px solid var(--color-border);
      border-left: 4px solid #f59e0b;
      border-radius: 8px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: all 0.2s ease;
      cursor: grab;
      user-select: none;
      position: relative;
    }

    .unmatched-student-item::before {
      content: 'â‹®â‹®';
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--color-muted);
      font-size: 1.2rem;
      line-height: 0.5;
      opacity: 0.5;
      transition: opacity 0.2s ease;
    }

    .unmatched-student-item:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
      border-left-color: #d97706;
    }

    .unmatched-student-item:hover::before {
      opacity: 1;
    }

    .unmatched-student-item:active {
      cursor: grabbing;
    }

    .unmatched-student-item.dragging {
      opacity: 0.6;
      cursor: grabbing;
      transform: rotate(2deg);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      z-index: 1000;
    }

    .unmatched-student-item.dragging::before {
      opacity: 0;
    }

    .company-card.drag-over,
    .job-section.drag-over,
    .regular-list.drag-over,
    .reserve-list.drag-over,
    .empty-slot.drag-over {
      background: #eff6ff;
      border-color: var(--color-primary);
      border-style: dashed;
      border-width: 2px;
      box-shadow: 0 0 0 3px rgba(4, 84, 163, 0.1);
    }

    .empty-slot.drag-over {
      background: #dbeafe;
      border-color: var(--color-primary);
      color: var(--color-primary);
      transform: scale(1.02);
    }

    .unmatched-student-name {
      font-weight: 600;
      color: var(--color-text);
      font-size: 1.05rem;
    }

    .unmatched-student-details {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 0.9rem;
      color: var(--color-muted);
    }

    .unmatched-student-details span {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .unmatched-empty {
      text-align: center;
      padding: 48px 24px;
      color: var(--color-muted);
    }

    .unmatched-empty i {
      font-size: 3rem;
      margin-bottom: 16px;
      color: rgba(4, 84, 163, 0.3);
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <h1>
        <button id="menu-btn" title="é¸å–®" role="button" tabindex="0" aria-label="é–‹å•Ÿå´é‚Šé¸å–®">
          <span></span>
          <span></span>
          <span></span>
        </button>
        <div class="header-title">ä¸»ä»»åª’åˆ</div>
        <div style="width: 30px;"></div>
      </h1>
    </div>
  </header>

  <main class="management-container">
    <!-- é‡è¤‡ä¸­é¸è­¦å‘Š -->
    <div id="duplicateAlert" class="duplicate-alert" style="display: none;">
      <h4><i class="fas fa-exclamation-triangle"></i> ç™¼ç¾é‡è¤‡ä¸­é¸å­¸ç”Ÿ</h4>
      <ul id="duplicateList"></ul>
    </div>

    <!-- å» å•†å°èˆªï¼ˆä¸€å€‹ä¸€å€‹é¡¯ç¤ºï¼‰ -->
    <div id="companyNavigation" class="company-navigation" style="display: none;">
      <div class="nav-buttons">
        <button id="prevBtn" class="nav-btn" onclick="showPreviousCompany()" disabled>
          <i class="fas fa-chevron-left"></i> ä¸Šä¸€å€‹
        </button>
        <button id="nextBtn" class="nav-btn" onclick="showNextCompany()">
          ä¸‹ä¸€å€‹ <i class="fas fa-chevron-right"></i>
        </button>
      </div>
      <div id="companyCounter" class="company-counter">1 / 1</div>
    </div>

    <!-- åª’åˆçµæœéæ¿¾å™¨ï¼ˆæ¡†æ¶ä¸€ç›´å­˜åœ¨ï¼‰ -->
    <div class="filters-container" id="filtersContainer">
      <div class="filter-group">
        <label for="companyFilter">é¸æ“‡å…¬å¸</label>
        <select id="companyFilter">
          <option value="">é¸æ“‡å…¬å¸</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="jobFilter">é¸æ“‡è·ç¼º</label>
        <select id="jobFilter">
          <option value="">é¸æ“‡è·ç¼º</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="studentNameFilter">æœå°‹å­¸ç”Ÿå§“åæˆ–å­¸è™Ÿ</label>
        <input type="text" id="studentNameFilter" placeholder="è¼¸å…¥å­¸ç”Ÿå§“åæˆ–å­¸è™Ÿ">
      </div>
    </div>

    <!-- åª’åˆçµæœè¼‰å…¥ç‹€æ…‹ï¼ˆæ¡†æ¶ä¸€ç›´å­˜åœ¨ï¼‰ -->
    <div id="loadingState" class="loading" style="display: none;">
      <span class="spinner"></span>
      <span>è¼‰å…¥ä¸­...</span>
    </div>

    <!-- åª’åˆçµæœå…¬å¸å¡ç‰‡å®¹å™¨ï¼ˆæ¡†æ¶ä¸€ç›´å­˜åœ¨ï¼‰ -->
    <div id="companiesContainer" class="companies-container" style="display: flex;">
      <!-- å» å•†å¡ç‰‡å°‡å‹•æ…‹ç”Ÿæˆ -->
    </div>

    <!-- åª’åˆçµæœç©ºç‹€æ…‹ï¼ˆæ¡†æ¶ä¸€ç›´å­˜åœ¨ï¼‰ -->
    <div id="emptyState" class="empty-state" style="display: none;">
      <i class="fa-solid fa-inbox"></i>
      <div>ç›®å‰æ²’æœ‰å» å•†åª’åˆçµæœ</div>
    </div>

    <!-- æœªè¢«éŒ„å–å­¸ç”Ÿåˆ—è¡¨ -->
    <div class="panel" id="unmatchedStudentsPanel" style="display: none;">
      <div class="panel-header">
        <i class="fas fa-users"></i> æœªè¢«éŒ„å–å­¸ç”Ÿåå–®
      </div>
      <div class="panel-body">
        <div id="unmatchedStudentsContainer">
          <!-- æœªè¢«éŒ„å–çš„å­¸ç”Ÿå°‡å‹•æ…‹ç”Ÿæˆ -->
        </div>
      </div>
    </div>
  </main>

  <nav id="side-menu" aria-hidden="true" role="navigation" aria-label="åŠŸèƒ½é¸å–®">
    <button id="close-btn" aria-label="é—œé–‰åŠŸèƒ½é¸å–®">Ã—</button>
    <h2>åŠŸèƒ½é¸å–®</h2>
    <a href="/director_home">é¦–é </a>
    <a href="/profile">å€‹äººè³‡æ–™</a>
    <a href="/approve_company">å¯©æ ¸å¯¦ç¿’å–®ä½</a>
    <a href="/review_resume?mode=director">å¯©æ ¸å¯¦ç¿’å±¥æ­·</a>
    <a href="/manage_director">ä¸»ä»»åª’åˆ</a>
    <a href="/interview_schedule">è¡Œäº‹æ›†</a>
    <a href="/notifications">ç®¡ç†å…¬å‘Š</a>
    <a href="/admin_statistics">çµ±è¨ˆè³‡æ–™</a>
  </nav>

  <div id="toast" class="toast"></div>

  <script>
    let allCompaniesData = [];
    let duplicateStudents = [];
    let currentCompanyIndex = 0;  // ç•¶å‰é¡¯ç¤ºçš„å» å•†ç´¢å¼•
    let jobSlotsMap = {};  // å„²å­˜æ¯å€‹è·ç¼ºçš„åé¡è¨­å®š {companyId_jobId: slots}ï¼Œå¾è·ç¼ºè³‡æ–™è‡ªå‹•å¸¶å…¥
    let unmatchedStudents = [];  // æœªè¢«éŒ„å–çš„å­¸ç”Ÿåˆ—è¡¨

    // å´é‚Šé¸å–®æ§åˆ¶
    const menuBtn = document.getElementById('menu-btn');
    const sideMenu = document.getElementById('side-menu');
    const closeBtn = document.getElementById('close-btn');

    menuBtn.addEventListener('click', () => {
      sideMenu.classList.add('open');
    });

    closeBtn.addEventListener('click', () => {
      sideMenu.classList.remove('open');
    });

    // è¼‰å…¥åª’åˆçµæœ
    async function loadMatchingResults() {
      const loadingState = document.getElementById('loadingState');
      const companiesContainer = document.getElementById('companiesContainer');
      const emptyState = document.getElementById('emptyState');
      const filtersContainer = document.getElementById('filtersContainer');
      
      // ç¢ºä¿æ¡†æ¶ä¸€ç›´å­˜åœ¨
      filtersContainer.style.display = 'flex';  // éæ¿¾å™¨æ¡†æ¶ä¸€ç›´é¡¯ç¤º
      
      // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹ï¼Œä½†ä¿æŒå…¶ä»–æ¡†æ¶å­˜åœ¨
      loadingState.style.display = 'flex';
      companiesContainer.style.display = 'flex';  // æ¡†æ¶ä¸€ç›´å­˜åœ¨ï¼Œå³ä½¿æ²’æœ‰å…§å®¹
      emptyState.style.display = 'none';
      
      try {
        const res = await fetch('/admission/api/director_matching_results', {
          credentials: 'include'
        });
        const data = await res.json();

        if (data.success) {
          allCompaniesData = data.companies || [];
          duplicateStudents = data.duplicate_students || [];
          currentCompanyIndex = 0;  // é‡ç½®åˆ°ç¬¬ä¸€å€‹å» å•†
          
          // å¾åª’åˆçµæœä¸­çš„è·ç¼ºè³‡æ–™è‡ªå‹•å¸¶å…¥åé¡è¨­å®š
          jobSlotsMap = {};
          allCompaniesData.forEach(company => {
            company.jobs.forEach(job => {
              const key = `${company.company_id}_${job.job_id}`;
              // ä½¿ç”¨è·ç¼ºçš„åé¡ï¼ˆå¾è³‡æ–™åº«ç›´æ¥å–å¾—ï¼‰
              jobSlotsMap[key] = job.job_slots || 1;
            });
          });
          
          // å¡«å……éæ¿¾å™¨é¸é …
          populateFilters();
          
          // æ¸²æŸ“çµæœ
          renderCompanies();
          renderDuplicateAlert();
          
          // è¼‰å…¥æœªè¢«éŒ„å–çš„å­¸ç”Ÿ
          await loadUnmatchedStudents();
          
          // éš±è—è¼‰å…¥ç‹€æ…‹ï¼Œä½†ä¿æŒæ¡†æ¶å­˜åœ¨
          loadingState.style.display = 'none';
          
          // æ ¹æ“šæ˜¯å¦æœ‰è³‡æ–™é¡¯ç¤ºå°æ‡‰çš„å…§å®¹ï¼Œä½†æ¡†æ¶ä¸€ç›´å­˜åœ¨
          if (allCompaniesData.length === 0) {
            companiesContainer.style.display = 'flex';  // æ¡†æ¶å­˜åœ¨
            companiesContainer.innerHTML = '';  // æ¸…ç©ºå…§å®¹
            emptyState.style.display = 'block';
          } else {
            companiesContainer.style.display = 'flex';  // æ¡†æ¶å­˜åœ¨
            emptyState.style.display = 'none';
          }
        } else {
          loadingState.style.display = 'none';
          companiesContainer.style.display = 'flex';  // æ¡†æ¶ä¸€ç›´å­˜åœ¨
          companiesContainer.innerHTML = '';  // æ¸…ç©ºå…§å®¹
          emptyState.style.display = 'block';
          emptyState.innerHTML = `
            <i class="fa-solid fa-triangle-exclamation"></i>
            <div>è¼‰å…¥å¤±æ•—ï¼š${data.message || 'æœªçŸ¥éŒ¯èª¤'}</div>
          `;
        }
      } catch (error) {
        console.error('è¼‰å…¥å¤±æ•—:', error);
        loadingState.style.display = 'none';
        companiesContainer.style.display = 'flex';  // æ¡†æ¶ä¸€ç›´å­˜åœ¨
        companiesContainer.innerHTML = '';  // æ¸…ç©ºå…§å®¹
        emptyState.style.display = 'block';
        emptyState.innerHTML = `
          <i class="fa-solid fa-triangle-exclamation"></i>
          <div>è¼‰å…¥å¤±æ•—ï¼š${error.message}</div>
        `;
      }
    }

    // å¡«å……éæ¿¾å™¨é¸é …
    function populateFilters() {
      const companyFilter = document.getElementById('companyFilter');
      const jobFilter = document.getElementById('jobFilter');
      
      // æ¸…ç©ºä¸¦å¡«å……å…¬å¸é¸é …
      companyFilter.innerHTML = '<option value="">é¸æ“‡å…¬å¸</option>';
      allCompaniesData.forEach(company => {
        const option = document.createElement('option');
        option.value = company.company_id;
        option.textContent = company.company_name;
        companyFilter.appendChild(option);
      });
      
      // æ›´æ–°è·ç¼ºé¸é …
      updateJobFilterOptions();
    }

    // æ›´æ–°è·ç¼ºéæ¿¾å™¨é¸é …ï¼ˆæ ¹æ“šé¸æ“‡çš„å…¬å¸ï¼‰
    function updateJobFilterOptions() {
      const companyFilter = document.getElementById('companyFilter');
      const jobFilter = document.getElementById('jobFilter');
      const selectedCompanyId = companyFilter ? companyFilter.value : '';
      
      // æ”¶é›†è·ç¼º
      const jobTitles = new Set();
      
      if (selectedCompanyId) {
        // å¦‚æœé¸æ“‡äº†å…¬å¸ï¼Œåªé¡¯ç¤ºè©²å…¬å¸çš„è·ç¼º
        const selectedCompany = allCompaniesData.find(c => c.company_id.toString() === selectedCompanyId);
        if (selectedCompany) {
          selectedCompany.jobs.forEach(job => {
            if (job.job_title) {
              jobTitles.add(job.job_title);
            }
          });
        }
      } else {
        // å¦‚æœæ²’æœ‰é¸æ“‡å…¬å¸ï¼Œé¡¯ç¤ºæ‰€æœ‰è·ç¼º
        allCompaniesData.forEach(company => {
          company.jobs.forEach(job => {
            if (job.job_title) {
              jobTitles.add(job.job_title);
            }
          });
        });
      }
      
      // ä¿å­˜ç•¶å‰é¸æ“‡çš„è·ç¼º
      const currentJobValue = jobFilter ? jobFilter.value : '';
      
      // æ¸…ç©ºä¸¦å¡«å……è·ç¼ºé¸é …
      jobFilter.innerHTML = '<option value="">é¸æ“‡è·ç¼º</option>';
      Array.from(jobTitles).sort().forEach(jobTitle => {
        const option = document.createElement('option');
        option.value = jobTitle;
        option.textContent = jobTitle;
        jobFilter.appendChild(option);
      });
      
      // å¦‚æœä¹‹å‰çš„é¸æ“‡ä»ç„¶å­˜åœ¨ï¼Œå‰‡æ¢å¾©é¸æ“‡
      if (currentJobValue && Array.from(jobTitles).includes(currentJobValue)) {
        jobFilter.value = currentJobValue;
      } else {
        jobFilter.value = '';
      }
    }

    // è¼‰å…¥æœªè¢«éŒ„å–çš„å­¸ç”Ÿ
    async function loadUnmatchedStudents() {
      try {
        // ç²å–æ‰€æœ‰æœªéŒ„å–çš„å­¸ç”Ÿï¼ˆå¾Œç«¯ API å·²ç¶“éæ¿¾æ‰å·²åœ¨åª’åˆçµæœä¸­çš„å­¸ç”Ÿï¼‰
        const res = await fetch('/admission/api/get_all_students', {
          credentials: 'include'
        });
        const data = await res.json();

        if (data.success && data.students) {
          // å¾Œç«¯å·²ç¶“éæ¿¾ï¼Œç›´æ¥ä½¿ç”¨çµæœ
          unmatchedStudents = data.students;
          console.log(`ğŸ“Š æœªéŒ„å–å­¸ç”Ÿæ•¸é‡: ${unmatchedStudents.length}`);

          // æ¸²æŸ“æœªè¢«éŒ„å–çš„å­¸ç”Ÿ
          renderUnmatchedStudents();
        } else {
          unmatchedStudents = [];
          renderUnmatchedStudents();
        }
      } catch (error) {
        console.error('è¼‰å…¥æœªè¢«éŒ„å–å­¸ç”Ÿå¤±æ•—:', error);
        unmatchedStudents = [];
        renderUnmatchedStudents();
      }
    }

    // æ¸²æŸ“æœªè¢«éŒ„å–çš„å­¸ç”Ÿ
    function renderUnmatchedStudents() {
      const panel = document.getElementById('unmatchedStudentsPanel');
      const container = document.getElementById('unmatchedStudentsContainer');

      if (!panel || !container) return;

      // æ‡‰ç”¨æœå°‹éæ¿¾ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
      const studentNameFilter = document.getElementById('studentNameFilter');
      const searchKeyword = studentNameFilter ? studentNameFilter.value.trim().toLowerCase() : '';
      
      let filteredUnmatched = unmatchedStudents;
      if (searchKeyword) {
        filteredUnmatched = unmatchedStudents.filter(student => {
          const name = (student.student_name || student.name || '').toLowerCase();
          const number = (student.student_number || student.username || '').toLowerCase();
          return name.includes(searchKeyword) || number.includes(searchKeyword);
        });
      }

      // å¦‚æœæœ‰æœªè¢«éŒ„å–çš„å­¸ç”Ÿï¼Œé¡¯ç¤ºé¢æ¿
      if (filteredUnmatched.length > 0) {
        panel.style.display = 'block';
        container.innerHTML = filteredUnmatched.map(student => {
          const studentName = escapeHtml(student.student_name || student.name || 'æœªçŸ¥');
          const studentNumber = escapeHtml(student.student_number || student.username || 'â€”');
          const className = escapeHtml(student.class_name || 'â€”');

          const studentId = student.student_id || student.id;
          return `
            <div class="unmatched-student-item" 
                 draggable="true" 
                 data-student-id="${studentId}"
                 data-student-name="${escapeHtml(studentName)}"
                 data-student-number="${escapeHtml(studentNumber)}"
                 ondragstart="handleDragStart(event)"
                 ondragend="handleDragEnd(event)"
                 onclick="showStudentPreferences(${studentId}, '${escapeHtml(studentName)}')"
                 title="é»æ“ŠæŸ¥çœ‹å¿—é¡˜åºï¼Œæ‹–æ”¾æ­¤å­¸ç”Ÿåˆ°å…¬å¸è·ç¼ºä¸­">
              <div class="unmatched-student-name">
                ${studentName}
              </div>
              <div class="unmatched-student-details">
                <span><i class="fas fa-id-card"></i> å­¸è™Ÿï¼š${studentNumber}</span>
                <span><i class="fas fa-users"></i> ç­ç´šï¼š${className}</span>
              </div>
            </div>
          `;
        }).join('');
      } else {
        // å¦‚æœæœå°‹å¾Œæ²’æœ‰çµæœï¼Œé¡¯ç¤ºæœå°‹ç„¡çµæœï¼›å¦å‰‡é¡¯ç¤ºæ‰€æœ‰å­¸ç”Ÿéƒ½å·²è¢«éŒ„å–
        const studentNameFilter = document.getElementById('studentNameFilter');
        const searchKeyword = studentNameFilter ? studentNameFilter.value.trim() : '';
        
        panel.style.display = 'block';
        container.innerHTML = `
          <div class="unmatched-empty" style="grid-column: 1 / -1;">
            <i class="fa-solid ${searchKeyword ? 'fa-search' : 'fa-check-circle'}"></i>
            <div>${searchKeyword ? 'æœå°‹ç„¡çµæœ' : 'æ‰€æœ‰å­¸ç”Ÿéƒ½å·²è¢«éŒ„å–'}</div>
          </div>
        `;
      }
    }

    // æ¸²æŸ“é‡è¤‡ä¸­é¸è­¦å‘Š
    function renderDuplicateAlert() {
      const alert = document.getElementById('duplicateAlert');
      const list = document.getElementById('duplicateList');
      
      if (duplicateStudents.length === 0) {
        alert.style.display = 'none';
        return;
      }

      alert.style.display = 'block';
      list.innerHTML = '';

      // ç²å–é‡è¤‡å­¸ç”Ÿçš„è©³ç´°è³‡è¨Š
      const duplicateInfo = [];
      allCompaniesData.forEach(company => {
        company.jobs.forEach(job => {
          [...job.regulars, ...job.reserves].forEach(student => {
            if (duplicateStudents.includes(student.student_id)) {
              const existing = duplicateInfo.find(d => d.student_id === student.student_id);
              if (existing) {
                existing.companies.push(company.company_name);
              } else {
                duplicateInfo.push({
                  student_id: student.student_id,
                  student_name: student.student_name,
                  student_number: student.student_number,
                  companies: [company.company_name]
                });
              }
            }
          });
        });
      });

      duplicateInfo.forEach(info => {
        const li = document.createElement('li');
        li.innerHTML = `<strong>${info.student_name}</strong> (${info.student_number}) è¢«ä»¥ä¸‹å…¬å¸é¸ä¸­ï¼š${info.companies.join('ã€')}`;
        list.appendChild(li);
      });
    }

    // é¡¯ç¤ºä¸Šä¸€å€‹å» å•†
    function showPreviousCompany() {
      if (currentCompanyIndex > 0) {
        currentCompanyIndex--;
        renderCompanies();
        updateNavigation();
      }
    }

    // é¡¯ç¤ºä¸‹ä¸€å€‹å» å•†
    function showNextCompany() {
      if (currentCompanyIndex < allCompaniesData.length - 1) {
        currentCompanyIndex++;
        renderCompanies();
        updateNavigation();
      }
    }

    // æ›´æ–°å°èˆªæŒ‰éˆ•ç‹€æ…‹ï¼ˆæ°´å¹³æ’åˆ—æ™‚éš±è—å°èˆªï¼‰
    function updateNavigation() {
      const nav = document.getElementById('companyNavigation');
      
      // æ°´å¹³æ’åˆ—æ™‚éš±è—å°èˆªæŒ‰éˆ•
      if (nav) {
        nav.style.display = 'none';
      }
    }

    // éæ¿¾å…¬å¸æ•¸æ“š
    function filterCompanies() {
      const companyFilter = document.getElementById('companyFilter');
      const jobFilter = document.getElementById('jobFilter');
      const studentNameFilter = document.getElementById('studentNameFilter');
      
      const selectedCompanyId = companyFilter ? companyFilter.value : '';
      const selectedJobTitle = jobFilter ? jobFilter.value : '';
      const searchKeyword = studentNameFilter ? studentNameFilter.value.trim().toLowerCase() : '';
      
      // å¦‚æœæ²’æœ‰ä»»ä½•éæ¿¾æ¢ä»¶ï¼Œè¿”å›æ‰€æœ‰æ•¸æ“š
      if (!selectedCompanyId && !selectedJobTitle && !searchKeyword) {
        return allCompaniesData;
      }
      
      // éæ¿¾æ•¸æ“š
      return allCompaniesData.map(company => {
        // å…¬å¸éæ¿¾ï¼šå¦‚æœé¸æ“‡äº†å…¬å¸ï¼Œä¸”ä¸åŒ¹é…å‰‡è·³éæ•´å€‹å…¬å¸
        if (selectedCompanyId && company.company_id.toString() !== selectedCompanyId) {
          return null;
        }
        
        // éæ¿¾è·ç¼ºå’Œå­¸ç”Ÿ
        const filteredJobs = company.jobs.map(job => {
          // è·ç¼ºéæ¿¾ï¼šå¦‚æœé¸æ“‡äº†è·ç¼ºï¼Œä¸”ä¸åŒ¹é…å‰‡è·³éæ•´å€‹è·ç¼º
          if (selectedJobTitle && job.job_title !== selectedJobTitle) {
            return null;
          }
          
          // å­¸ç”Ÿæœå°‹éæ¿¾
          const filterStudents = (students) => {
            if (!searchKeyword) return students;
            return students.filter(student => {
              const name = (student.student_name || '').toLowerCase();
              const number = (student.student_number || '').toLowerCase();
              return name.includes(searchKeyword) || number.includes(searchKeyword);
            });
          };
          
          const filteredRegulars = filterStudents(job.regulars || []);
          const filteredReserves = filterStudents(job.reserves || []);
          
          // å¦‚æœæœå°‹é—œéµå­—å­˜åœ¨ï¼Œä½†è©²è·ç¼ºæ²’æœ‰ä»»ä½•åŒ¹é…çš„å­¸ç”Ÿï¼Œå‰‡è·³éè©²è·ç¼º
          if (searchKeyword && filteredRegulars.length === 0 && filteredReserves.length === 0) {
            return null;
          }
          
          return {
            ...job,
            regulars: filteredRegulars,
            reserves: filteredReserves
          };
        }).filter(job => job !== null);
        
        // å¦‚æœå…¬å¸æ²’æœ‰ä»»ä½•è·ç¼ºï¼Œå‰‡è·³éè©²å…¬å¸
        if (filteredJobs.length === 0) {
          return null;
        }
        
        return {
          ...company,
          jobs: filteredJobs
        };
      }).filter(company => company !== null);
    }

    // æ¸²æŸ“å…¬å¸åˆ—è¡¨ï¼ˆæ°´å¹³æ’åˆ—é¡¯ç¤ºæ‰€æœ‰å» å•†ï¼‰
    function renderCompanies(filteredData = null) {
      const container = document.getElementById('companiesContainer');
      const loadingState = document.getElementById('loadingState');
      const emptyState = document.getElementById('emptyState');
      
      // ç¢ºä¿æ¡†æ¶ä¸€ç›´å­˜åœ¨
      loadingState.style.display = 'none';
      container.style.display = 'flex';  // æ¡†æ¶ä¸€ç›´å­˜åœ¨
      
      // ä½¿ç”¨éæ¿¾å¾Œçš„æ•¸æ“šæˆ–åŸå§‹æ•¸æ“š
      const companiesToRender = filteredData !== null ? filteredData : allCompaniesData;
      
      if (companiesToRender.length === 0) {
        container.innerHTML = '';  // æ¸…ç©ºå…§å®¹ï¼Œä½†æ¡†æ¶å­˜åœ¨
        emptyState.style.display = 'block';
        updateNavigation();
        return;
      }

      // é¡¯ç¤ºå…§å®¹ï¼Œéš±è—ç©ºç‹€æ…‹
      emptyState.style.display = 'none';
      
      // æ¸²æŸ“æ‰€æœ‰å» å•†ï¼Œæ°´å¹³æ’åˆ—ï¼ˆå³ä½¿æ²’æœ‰è³‡æ–™ä¹Ÿé¡¯ç¤ºæ¡†æ¶ï¼‰
      container.innerHTML = companiesToRender.map(company => {
        // ç¢ºä¿ jobs é™£åˆ—å­˜åœ¨
        const jobs = company.jobs || [];
        const jobsHtml = jobs.map(job => {
          const regularsHtml = renderStudentList(job.regulars, 'regular', job);
          const reservesHtml = renderStudentList(job.reserves, 'reserve', job);
          
          // ç²å–è©²è·ç¼ºçš„åé¡è¨­å®šï¼ˆå¯æ‰‹å‹•èª¿æ•´ï¼‰
          const key = `${company.company_id}_${job.job_id}`;
          const maxSlots = jobSlotsMap[key] || job.job_slots || 1;
          const filledSlots = job.regulars.length;
          const emptySlots = [];
          
          // æ ¹æ“šè·ç¼ºåé¡è¨ˆç®—ç©ºä½
          for (let i = filledSlots + 1; i <= maxSlots; i++) {
            emptySlots.push(i);
          }

          const emptySlotsHtml = emptySlots.map(slotIndex => `
            <div class="empty-slot" 
                 data-company-id="${company.company_id}"
                 data-job-id="${job.job_id}"
                 data-type="regular"
                 data-slot-index="${slotIndex}"
                 onclick="selectStudentForSlot(${company.company_id}, ${job.job_id}, ${slotIndex})"
                 ondrop="handleDrop(event)"
                 ondragover="handleDragOver(event)"
                 ondragleave="handleDragLeave(event)">
              <i class="fas fa-plus-circle"></i>
              <div>æ­£å– ${slotIndex}ï¼ˆé»æ“Šæˆ–æ‹–æ”¾å­¸ç”Ÿè‡³æ­¤ï¼‰</div>
            </div>
          `).join('');

          return `
            <div class="job-section" 
                 data-company-id="${company.company_id}"
                 data-job-id="${job.job_id}"
                 ondrop="handleDrop(event)"
                 ondragover="handleDragOver(event)"
                 ondragleave="handleDragLeave(event)">
              <div class="job-title">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                  <span>${job.job_title || 'æœªæŒ‡å®šè·ç¼º'}</span>
                  <span style="font-size: 0.85rem; color: var(--color-muted);">
                    ï¼ˆå·²é¸ï¼š${filledSlots} / åé¡ï¼š${maxSlots}ï¼‰
                  </span>
                </div>
              </div>
              <div class="regular-list"
                   data-company-id="${company.company_id}"
                   data-job-id="${job.job_id}"
                   data-type="regular"
                   ondrop="handleDrop(event)"
                   ondragover="handleDragOver(event)"
                   ondragleave="handleDragLeave(event)">
                <div class="list-label">æ­£å–åå–®</div>
                ${regularsHtml}
                ${emptySlotsHtml}
              </div>
              ${job.reserves.length > 0 ? `
                <div class="reserve-list"
                     data-company-id="${company.company_id}"
                     data-job-id="${job.job_id}"
                     data-type="reserve"
                     ondrop="handleDrop(event)"
                     ondragover="handleDragOver(event)"
                     ondragleave="handleDragLeave(event)">
                  <div class="list-label">å‚™å–åå–®</div>
                  ${reservesHtml}
                </div>
              ` : `
                <div class="reserve-list"
                     data-company-id="${company.company_id}"
                     data-job-id="${job.job_id}"
                     data-type="reserve"
                     ondrop="handleDrop(event)"
                     ondragover="handleDragOver(event)"
                     ondragleave="handleDragLeave(event)"
                     style="min-height: 60px; border: 2px dashed transparent; border-radius: 8px; padding: 8px; transition: all 0.2s ease;">
                  <div class="list-label">å‚™å–åå–®</div>
                  <div style="padding: 12px; text-align: center; color: var(--color-muted); font-size: 0.9rem;">å°šç„¡å­¸ç”Ÿï¼ˆå¯æ‹–æ”¾å­¸ç”Ÿè‡³æ­¤ï¼‰</div>
                </div>
              `}
            </div>
          `;
        }).join('');

        // å³ä½¿æ²’æœ‰è·ç¼ºï¼Œä¹Ÿé¡¯ç¤ºå» å•†æ¡†æ¶
        const jobsContent = jobsHtml || '<div class="job-section"><div style="padding: 20px; text-align: center; color: var(--color-muted);">ç›®å‰æ²’æœ‰è·ç¼º</div></div>';
        
        // æª¢æŸ¥å…¬å¸æ˜¯å¦æœ‰æ­£å–åå–®ï¼ˆä»»ä½•è·ç¼ºæœ‰æ­£å–å­¸ç”Ÿï¼‰
        const hasRegulars = jobs.some(job => job.regulars && job.regulars.length > 0);
        
        // æª¢æŸ¥å…¬å¸æ˜¯å¦æ‰€æœ‰è·ç¼ºéƒ½å·²æ»¿ï¼ˆæ­£å–æ»¿ä¸”å‚™å–æœ‰å­¸ç”Ÿï¼‰
        const isCompanyFull = jobs.length > 0 && jobs.every(job => {
          const key = `${company.company_id}_${job.job_id}`;
          const maxSlots = jobSlotsMap[key] || job.job_slots || 1;
          const filledSlots = (job.regulars || []).length;
          const hasReserves = (job.reserves || []).length > 0;
          // æ­£å–åé¡å·²æ»¿ ä¸” å‚™å–åå–®æœ‰å­¸ç”Ÿ
          return filledSlots >= maxSlots && hasReserves;
        });
        
        // å¦‚æœæœ‰æ­£å–åå–®ï¼Œå‰‡è‡ªå‹•å±•é–‹ï¼ˆä¸æ·»åŠ  collapsed classï¼‰
        const companyCardId = `company-card-${company.company_id}`;
        const collapsedClass = hasRegulars ? '' : 'collapsed';
        const fullClass = isCompanyFull ? 'full' : '';
        
        return `
          <div class="company-card ${collapsedClass} ${fullClass}" 
               id="${companyCardId}"
               data-company-id="${company.company_id}"
               ondrop="handleDrop(event)"
               ondragover="handleDragOver(event)"
               ondragleave="handleDragLeave(event)">
            <div class="company-header" 
                 data-company-id="${company.company_id}"
                 onclick="toggleCompanyCard('${companyCardId}')"
                 ondrop="handleDrop(event)"
                 ondragover="handleDragOver(event)"
                 ondragleave="handleDragLeave(event)">
              <span>${company.company_name}</span>
              <i class="fas fa-chevron-down toggle-icon"></i>
            </div>
            <div class="company-content">
              ${jobsContent}
            </div>
          </div>
        `;
      }).join('');
      
      updateNavigation();
    }

    // æ¸²æŸ“å­¸ç”Ÿåˆ—è¡¨
    function renderStudentList(students, type, job) {
      if (students.length === 0) {
        return '<div class="text-muted" style="padding: 12px;">å°šç„¡å­¸ç”Ÿ</div>';
      }

      return students.map(student => {
        const isDuplicate = duplicateStudents.includes(student.student_id);
        const badgeClass = type === 'regular' ? 'badge-regular' : 'badge-reserve';
        const badgeText = type === 'regular' 
          ? `æ­£å–${student.slot_index || ''}` 
          : 'å€™è£œ';
        
        return `
          <div class="student-item ${isDuplicate ? 'duplicate' : ''}">
            <div class="student-info">
              <div class="student-name">
                ${escapeHtml(student.student_name)}
                <span class="badge ${badgeClass}">${badgeText}</span>
                ${isDuplicate ? '<span class="badge badge-duplicate">é‡è¤‡ä¸­é¸</span>' : ''}
              </div>
              <div class="student-details">
                <div class="student-details-row">
                  <span><i class="fas fa-id-card"></i> ${escapeHtml(student.student_number || 'â€”')}</span>
                </div>
                <div class="student-details-row">
                  <span><i class="fas fa-users"></i> ${escapeHtml(student.class_name || 'â€”')}</span>
                </div>
                <div class="student-details-row">
                  <span class="preference-order">
                    <i class="fas fa-list-ol"></i> å¿—é¡˜åºï¼š${(student.preference_order && student.preference_order >= 1 && student.preference_order <= 5) ? student.preference_order : 'â€”'}
                  </span>
                </div>
              </div>
            </div>
            <div class="student-actions">
              ${type === 'regular' ? `
                <button class="btn btn-sm" onclick="movePosition(${student.id}, ${job.job_id}, 'up')" 
                        style="background: #f3f4f6; color: #374151; padding: 4px 8px; margin-right: 4px;"
                        title="å‘ä¸Šç§»å‹•">
                  <i class="fas fa-arrow-up"></i>
                </button>
                <button class="btn btn-sm" onclick="movePosition(${student.id}, ${job.job_id}, 'down')" 
                        style="background: #f3f4f6; color: #374151; padding: 4px 8px; margin-right: 8px;"
                        title="å‘ä¸‹ç§»å‹•">
                  <i class="fas fa-arrow-down"></i>
                </button>
              ` : ''}
              <button class="btn btn-danger" onclick="removeStudent(${student.id}, '${escapeHtml(student.student_name)}')">
                <i class="fas fa-times"></i> ç§»é™¤
              </button>
              ${type === 'reserve' ? `
                <button class="btn btn-success" onclick="promoteToRegular(${student.id}, ${job.job_id})">
                  <i class="fas fa-arrow-up"></i> æå‡ç‚ºæ­£å–
                </button>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    // ç§»é™¤å­¸ç”Ÿ
    async function removeStudent(historyId, studentName) {
      if (!confirm(`ç¢ºå®šè¦ç§»é™¤ã€Œ${studentName}ã€å—ï¼Ÿ`)) {
        return;
      }

      try {
        const res = await fetch('/admission/api/director_remove_student', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ history_id: historyId })
        });

        const data = await res.json();
        if (data.success) {
          showToast('å·²ç§»é™¤å­¸ç”Ÿï¼Œå­¸ç”Ÿå·²å›åˆ°æœªéŒ„å–åå–®', 'success');
          // åŒæ™‚é‡æ–°è¼‰å…¥åª’åˆçµæœå’ŒæœªéŒ„å–å­¸ç”Ÿåˆ—è¡¨
          loadMatchingResults();
          loadUnmatchedStudents();
        } else {
          showToast(data.message || 'ç§»é™¤å¤±æ•—', 'error');
        }
      } catch (error) {
        console.error('ç§»é™¤å¤±æ•—:', error);
        showToast('ç§»é™¤å¤±æ•—', 'error');
      }
    }

    // é¡¯ç¤ºå­¸ç”Ÿå¿—é¡˜åº
    async function showStudentPreferences(studentId, studentName) {
      try {
        const res = await fetch(`/admission/api/get_student_preferences?student_id=${studentId}`, {
          credentials: 'include'
        });
        const data = await res.json();
        
        if (data.success) {
          const preferences = data.preferences || [];
          
          if (preferences.length === 0) {
            showToast(`${studentName} å°šæœªå¡«å¯«å¿—é¡˜åº`, 'info');
            return;
          }
          
          // æ§‹å»ºå¿—é¡˜åºåˆ—è¡¨ HTML
          let preferencesHtml = '<div style="max-height: 400px; overflow-y: auto;">';
          preferencesHtml += '<table style="width: 100%; border-collapse: collapse;">';
          preferencesHtml += '<thead><tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">';
          preferencesHtml += '<th style="padding: 10px; text-align: center; border-right: 1px solid #e2e8f0;">å¿—é¡˜åº</th>';
          preferencesHtml += '<th style="padding: 10px; text-align: left; border-right: 1px solid #e2e8f0;">å…¬å¸åç¨±</th>';
          preferencesHtml += '<th style="padding: 10px; text-align: left;">è·ç¼ºåç¨±</th>';
          preferencesHtml += '</tr></thead><tbody>';
          
          // åªé¡¯ç¤º preference_order åœ¨ 1-5 ç¯„åœå…§çš„å¿—é¡˜åº
          const validPreferences = preferences.filter(p => 
            p.preference_order >= 1 && p.preference_order <= 5
          ).sort((a, b) => a.preference_order - b.preference_order);
          
          validPreferences.forEach((pref) => {
            const order = pref.preference_order;
            const companyName = pref.company_name || 'æœªçŸ¥å…¬å¸';
            const jobTitle = pref.job_title || 'æœªæŒ‡å®šè·ç¼º';
            
            preferencesHtml += '<tr style="border-bottom: 1px solid #e2e8f0;">';
            preferencesHtml += `<td style="padding: 10px; text-align: center; font-weight: 600; color: var(--color-primary); border-right: 1px solid #e2e8f0;">${order}</td>`;
            preferencesHtml += `<td style="padding: 10px; border-right: 1px solid #e2e8f0;">${escapeHtml(companyName)}</td>`;
            preferencesHtml += `<td style="padding: 10px;">${escapeHtml(jobTitle)}</td>`;
            preferencesHtml += '</tr>';
          });
          
          preferencesHtml += '</tbody></table></div>';
          
          // é¡¯ç¤ºå½ˆçª—
          const modal = document.createElement('div');
          modal.className = 'modal';
          modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;';
          modal.innerHTML = `
            <div style="background: white; border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 12px;">
                <h3 style="margin: 0; color: var(--color-text);">
                  <i class="fas fa-list-ol" style="margin-right: 8px; color: var(--color-primary);"></i>
                  ${escapeHtml(studentName)} çš„å¿—é¡˜åº
                </h3>
                <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">&times;</button>
              </div>
              ${preferencesHtml}
            </div>
          `;
          
          document.body.appendChild(modal);
          
          // é»æ“ŠèƒŒæ™¯é—œé–‰
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              modal.remove();
            }
          });
        } else {
          showToast(data.message || 'ç„¡æ³•è¼‰å…¥å¿—é¡˜åºè³‡æ–™', 'error');
        }
      } catch (error) {
        console.error('è¼‰å…¥å¿—é¡˜åºå¤±æ•—:', error);
        showToast('è¼‰å…¥å¿—é¡˜åºå¤±æ•—', 'error');
      }
    }

    // èª¿æ•´æ­£å–åå–®ä¸­å­¸ç”Ÿçš„ä½ç½®
    async function movePosition(historyId, jobId, direction) {
      // æ‰¾åˆ°è©²è·ç¼ºçš„æ‰€æœ‰æ­£å–å­¸ç”Ÿ
      let regulars = [];
      let currentStudent = null;
      
      allCompaniesData.forEach(company => {
        company.jobs.forEach(job => {
          if (job.job_id === jobId) {
            regulars = job.regulars || [];
            currentStudent = regulars.find(s => s.id === historyId);
          }
        });
      });
      
      if (!currentStudent) {
        showToast('æ‰¾ä¸åˆ°è©²å­¸ç”Ÿ', 'error');
        return;
      }
      
      // æŒ‰ slot_index æ’åº
      regulars.sort((a, b) => (a.slot_index || 999) - (b.slot_index || 999));
      
      // æ‰¾åˆ°ç•¶å‰å­¸ç”Ÿçš„ç´¢å¼•
      const currentIndex = regulars.findIndex(s => s.id === historyId);
      if (currentIndex === -1) {
        showToast('æ‰¾ä¸åˆ°è©²å­¸ç”Ÿ', 'error');
        return;
      }
      
      // è¨ˆç®—ç›®æ¨™ä½ç½®
      let targetIndex;
      if (direction === 'up') {
        targetIndex = currentIndex - 1;
        if (targetIndex < 0) {
          showToast('å·²ç¶“æ˜¯ç¬¬ä¸€å€‹', 'info');
          return;
        }
      } else {
        targetIndex = currentIndex + 1;
        if (targetIndex >= regulars.length) {
          showToast('å·²ç¶“æ˜¯æœ€å¾Œä¸€å€‹', 'info');
          return;
        }
      }
      
      const targetStudent = regulars[targetIndex];
      
      try {
        const res = await fetch('/admission/api/director_swap_positions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            match_id1: historyId,
            match_id2: targetStudent.id
          })
        });
        
        const data = await res.json();
        if (data.success) {
          showToast('å·²èª¿æ•´ä½ç½®', 'success');
          loadMatchingResults();
        } else {
          showToast(data.message || 'èª¿æ•´å¤±æ•—', 'error');
        }
      } catch (error) {
        console.error('èª¿æ•´ä½ç½®å¤±æ•—:', error);
        showToast('èª¿æ•´ä½ç½®å¤±æ•—', 'error');
      }
    }

    // å¾å‚™å–åå–®æå‡ç‚ºæ­£å–
    async function promoteToRegular(historyId, jobId) {
      // æ‰¾åˆ°è©²è·ç¼ºçš„æ­£å–æ•¸é‡ï¼Œä¸‹ä¸€å€‹ä½ç½®å°±æ˜¯æ–°çš„æ­£å–ä½ç½®
      let nextSlotIndex = 1;
      allCompaniesData.forEach(company => {
        company.jobs.forEach(job => {
          if (job.job_id === jobId) {
            nextSlotIndex = job.regulars.length + 1;
          }
        });
      });

      try {
        const res = await fetch('/admission/api/director_promote_reserve', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            history_id: historyId,
            slot_index: nextSlotIndex
          })
        });

        const data = await res.json();
        if (data.success) {
          showToast('å·²æå‡ç‚ºæ­£å–', 'success');
          loadMatchingResults();
        } else {
          showToast(data.message || 'æå‡å¤±æ•—', 'error');
        }
      } catch (error) {
        console.error('æå‡å¤±æ•—:', error);
        showToast('æå‡å¤±æ•—', 'error');
      }
    }

    // é¸æ“‡å­¸ç”Ÿå¡«å…¥ç©ºä½ï¼ˆå¯ä»¥å¾æœªéŒ„å–å­¸ç”Ÿæˆ–å‚™å–åå–®ä¸­é¸æ“‡ï¼‰
    async function selectStudentForSlot(companyId, jobId, slotIndex) {
      // æ‰¾åˆ°è©²è·ç¼ºçš„å‚™å–åå–®
      let reserves = [];
      allCompaniesData.forEach(company => {
        if (company.company_id === companyId) {
          company.jobs.forEach(job => {
            if (job.job_id === jobId) {
              reserves = job.reserves || [];
            }
          });
        }
      });

      // æ§‹å»ºé¸æ“‡åˆ—è¡¨ï¼šå…ˆé¡¯ç¤ºæœªéŒ„å–å­¸ç”Ÿï¼Œå†é¡¯ç¤ºå‚™å–åå–®
      let studentOptions = [];
      
      // æ·»åŠ æœªéŒ„å–å­¸ç”Ÿ
      if (unmatchedStudents && unmatchedStudents.length > 0) {
        unmatchedStudents.forEach((student, index) => {
          studentOptions.push({
            type: 'unmatched',
            index: index,
            student: student,
            displayText: `${student.student_name || student.name} (${student.student_number || student.username}) - æœªéŒ„å–`
          });
        });
      }
      
      // æ·»åŠ å‚™å–åå–®å­¸ç”Ÿ
      reserves.forEach((student, index) => {
        studentOptions.push({
          type: 'reserve',
          index: index,
          student: student,
          displayText: `${student.student_name} (${student.student_number}) - å‚™å–`
        });
      });

      if (studentOptions.length === 0) {
        showToast('æ²’æœ‰å¯é¸æ“‡çš„å­¸ç”Ÿ', 'info');
        return;
      }

      // æ§‹å»ºé¸æ“‡åˆ—è¡¨ HTML
      let optionsHtml = '<div style="max-height: 400px; overflow-y: auto; padding: 1em;">';
      studentOptions.forEach((option, idx) => {
        const studentId = option.student.student_id || option.student.id;
        const studentName = escapeHtml(option.student.student_name || option.student.name);
        const studentNumber = escapeHtml(option.student.student_number || option.student.username);
        const displayText = escapeHtml(option.displayText);
        
        optionsHtml += `
          <div style="padding: 10px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; background: #f8f9fa; transition: background 0.2s;"
               onclick="this.style.background='#e3f2fd'; setTimeout(() => { this.closest('.modal').remove(); handleStudentSelection(${companyId}, ${jobId}, ${slotIndex}, '${option.type}', ${option.index}); }, 200);"
               onmouseover="this.style.background='#e3f2fd'"
               onmouseout="this.style.background='#f8f9fa'">
            <strong>${displayText}</strong>
          </div>
        `;
      });
      optionsHtml += '</div>';

      // é¡¯ç¤ºé¸æ“‡å½ˆçª—
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;';
      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 12px;">
            <h3 style="margin: 0; color: var(--color-text);">
              <i class="fas fa-user-plus" style="margin-right: 8px; color: var(--color-primary);"></i>
              é¸æ“‡å­¸ç”Ÿå¡«å…¥æ­£å– ${slotIndex}
            </h3>
            <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">&times;</button>
          </div>
          ${optionsHtml}
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // é»æ“ŠèƒŒæ™¯é—œé–‰
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }

    // è™•ç†å­¸ç”Ÿé¸æ“‡
    async function handleStudentSelection(companyId, jobId, slotIndex, studentType, studentIndex) {
      let selectedStudent = null;
      
      if (studentType === 'unmatched') {
        // å¾æœªéŒ„å–å­¸ç”Ÿä¸­é¸æ“‡
        if (unmatchedStudents && unmatchedStudents[studentIndex]) {
          selectedStudent = unmatchedStudents[studentIndex];
        } else {
          showToast('æ‰¾ä¸åˆ°è©²å­¸ç”Ÿ', 'error');
          return;
        }
        
        // ä½¿ç”¨æ‹–æ”¾é‚è¼¯æ·»åŠ å­¸ç”Ÿ
        const studentInfo = {
          student_id: selectedStudent.student_id || selectedStudent.id,
          student_name: selectedStudent.student_name || selectedStudent.name,
          student_number: selectedStudent.student_number || selectedStudent.username
        };
        
        try {
          const res = await fetch('/admission/api/director_add_student', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              student_id: parseInt(studentInfo.student_id),
              company_id: parseInt(companyId),
              job_id: parseInt(jobId),
              type: 'regular',
              slot_index: slotIndex
            })
          });

          const data = await res.json();
          if (data.success) {
            showToast(`å·²å°‡ã€Œ${studentInfo.student_name}ã€æ·»åŠ åˆ°æ­£å– ${slotIndex}`, 'success');
            loadMatchingResults();
            loadUnmatchedStudents();
          } else {
            showToast(data.message || 'æ·»åŠ å¤±æ•—', 'error');
          }
        } catch (error) {
          console.error('æ·»åŠ å¤±æ•—:', error);
          showToast('æ·»åŠ å¤±æ•—', 'error');
        }
      } else if (studentType === 'reserve') {
        // å¾å‚™å–åå–®ä¸­é¸æ“‡ï¼ˆä½¿ç”¨åŸæœ‰çš„ promoteFromReserve é‚è¼¯ï¼‰
        let reserves = [];
        allCompaniesData.forEach(company => {
          if (company.company_id === companyId) {
            company.jobs.forEach(job => {
              if (job.job_id === jobId) {
                reserves = job.reserves || [];
              }
            });
          }
        });
        
        if (reserves[studentIndex]) {
          selectedStudent = reserves[studentIndex];
          
          try {
            const res = await fetch('/admission/api/director_promote_reserve', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({
                history_id: selectedStudent.id,
                slot_index: slotIndex
              })
            });

            const data = await res.json();
            if (data.success) {
              showToast('å·²å¾å‚™å–åå–®è£œä¸Š', 'success');
              loadMatchingResults();
            } else {
              showToast(data.message || 'æå‡å¤±æ•—', 'error');
            }
          } catch (error) {
            console.error('æå‡å¤±æ•—:', error);
            showToast('æå‡å¤±æ•—', 'error');
          }
        } else {
          showToast('æ‰¾ä¸åˆ°è©²å­¸ç”Ÿ', 'error');
        }
      }
    }

    // å¾å‚™å–åå–®è£œä¸Šç©ºä½
    async function promoteFromReserve(companyId, jobId, slotIndex) {
      // æ‰¾åˆ°è©²è·ç¼ºçš„å‚™å–åå–®
      let reserves = [];
      allCompaniesData.forEach(company => {
        if (company.company_id === companyId) {
          company.jobs.forEach(job => {
            if (job.job_id === jobId) {
              reserves = job.reserves;
            }
          });
        }
      });

      if (reserves.length === 0) {
        showToast('è©²è·ç¼ºç„¡å‚™å–åå–®', 'error');
        return;
      }

      // é¡¯ç¤ºå‚™å–åå–®ä¾›é¸æ“‡
      const studentList = reserves.map((s, i) => 
        `${i + 1}. ${s.student_name} (${s.student_number})`
      ).join('\n');

      const choice = prompt(`è«‹é¸æ“‡è¦è£œä¸Šçš„å­¸ç”Ÿï¼ˆè¼¸å…¥ç·¨è™Ÿï¼‰ï¼š\n\n${studentList}`);
      const index = parseInt(choice) - 1;

      if (isNaN(index) || index < 0 || index >= reserves.length) {
        return;
      }

      const selectedStudent = reserves[index];

      try {
        const res = await fetch('/admission/api/director_promote_reserve', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            history_id: selectedStudent.id,
            slot_index: slotIndex
          })
        });

        const data = await res.json();
        if (data.success) {
          showToast('å·²å¾å‚™å–åå–®è£œä¸Š', 'success');
          loadMatchingResults();
        } else {
          showToast(data.message || 'è£œä¸Šå¤±æ•—', 'error');
        }
      } catch (error) {
        console.error('è£œä¸Šå¤±æ•—:', error);
        showToast('è£œä¸Šå¤±æ•—', 'error');
      }
    }

    // é¡¯ç¤ºæç¤ºè¨Šæ¯
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // åˆ‡æ›å…¬å¸å¡ç‰‡å±•é–‹/æ”¶åˆ
    function toggleCompanyCard(cardId) {
      const card = document.getElementById(cardId);
      if (card) {
        card.classList.toggle('collapsed');
      }
    }

    // HTML è½‰ç¾©
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // ç²å–å¿—é¡˜åºé¡¯ç¤ºæ–‡å­—ï¼ˆæ ¹æ“š fill_preferences.html çš„é‚è¼¯ï¼‰
    function getPreferenceOrderText(student) {
      const preferences = student.preferences || [];
      
      // å¦‚æœæ²’æœ‰å¡«å¯«å¿—é¡˜åºï¼Œé¡¯ç¤ºã€Œå°šæœªå¡«å¯«ã€
      if (preferences.length === 0) {
        return 'å°šæœªå¡«å¯«';
      }
      
      // åªé¡¯ç¤º preference_order åœ¨ 1-5 ç¯„åœå…§çš„å¿—é¡˜åº
      const validPreferences = preferences.filter(p => 
        p.preference_order >= 1 && p.preference_order <= 5
      );
      
      if (validPreferences.length === 0) {
        return 'å°šæœªå¡«å¯«';
      }
      
      // é¡¯ç¤ºæ‰€æœ‰å¿—é¡˜åºï¼ˆ1-5ï¼‰ï¼Œç”¨é “è™Ÿåˆ†éš”
      const orders = validPreferences
        .sort((a, b) => a.preference_order - b.preference_order)
        .map(p => p.preference_order)
        .join('ã€');
      
      return orders;
    }

    // æ‹–æ”¾åŠŸèƒ½
    let draggedStudent = null;

    function handleDragStart(event) {
      const item = event.target.closest('.unmatched-student-item');
      if (!item) return;
      
      draggedStudent = {
        student_id: item.dataset.studentId,
        student_name: item.dataset.studentName,
        student_number: item.dataset.studentNumber
      };
      
      item.classList.add('dragging');
      event.dataTransfer.effectAllowed = 'move';
      event.dataTransfer.setData('text/plain', draggedStudent.student_id);
    }

    function handleDragEnd(event) {
      const item = event.target.closest('.unmatched-student-item');
      if (item) {
        item.classList.remove('dragging');
      }
      // ç§»é™¤æ‰€æœ‰ drag-over æ¨£å¼
      document.querySelectorAll('.drag-over').forEach(el => {
        el.classList.remove('drag-over');
      });
      draggedStudent = null;
    }

    function handleDragOver(event) {
      event.preventDefault();
      // ä¸è¦é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œè®“äº‹ä»¶èƒ½æ­£ç¢ºå‚³æ’­åˆ°æ‰€æœ‰å¯æ‹–æ”¾çš„å…ƒç´ 
      event.dataTransfer.dropEffect = 'move';
      
      const target = event.currentTarget;
      if (!target.classList.contains('drag-over')) {
        target.classList.add('drag-over');
      }
      
      // å¦‚æœæ‹–æ”¾åˆ°å…¬å¸æ¨™é¡Œæˆ–å…¬å¸å¡ç‰‡ï¼Œç¢ºä¿çˆ¶å…ƒç´ ä¹Ÿèƒ½æ¥æ”¶æ‹–æ”¾
      if (target.classList.contains('company-header') || target.classList.contains('company-card')) {
        const card = target.classList.contains('company-card') ? target : target.closest('.company-card');
        if (card) {
          // è‡ªå‹•å±•é–‹æ”¶åˆçš„å…¬å¸å¡ç‰‡
          if (card.classList.contains('collapsed')) {
            card.classList.remove('collapsed');
          }
          
          if (!card.classList.contains('drag-over')) {
            card.classList.add('drag-over');
          }
          
          // æª¢æŸ¥å¡ç‰‡æ˜¯å¦åœ¨è¦–çª—ä¸Šæ–¹ï¼Œå¦‚æœæ˜¯å‰‡å‘ä¸Šæ»¾å‹•
          const cardRect = card.getBoundingClientRect();
          const scrollThreshold = 150; // ç•¶å¡ç‰‡è·é›¢é ‚éƒ¨ 150px æ™‚é–‹å§‹æ»¾å‹•
          
          if (cardRect.top < scrollThreshold && window.scrollY > 0) {
            // è¨ˆç®—éœ€è¦æ»¾å‹•çš„è·é›¢
            const scrollAmount = Math.min(scrollThreshold - cardRect.top, 20);
            window.scrollBy({
              top: -scrollAmount,
              behavior: 'auto'
            });
          }
        }
      }
    }

    function handleDragLeave(event) {
      const target = event.currentTarget;
      const relatedTarget = event.relatedTarget;
      // æª¢æŸ¥æ˜¯å¦çœŸçš„é›¢é–‹äº†ç›®æ¨™å€åŸŸï¼ˆè€Œä¸æ˜¯é€²å…¥å­å…ƒç´ ï¼‰
      if (!relatedTarget || !target.contains(relatedTarget)) {
        target.classList.remove('drag-over');
        
        // å¦‚æœæ˜¯å…¬å¸æ¨™é¡Œæˆ–å…¬å¸å¡ç‰‡ï¼Œä¹Ÿç§»é™¤çˆ¶å…ƒç´ çš„ drag-over æ¨£å¼
        if (target.classList.contains('company-header') || target.classList.contains('company-card')) {
          const card = target.classList.contains('company-card') ? target : target.closest('.company-card');
          if (card && (!relatedTarget || !card.contains(relatedTarget))) {
            card.classList.remove('drag-over');
          }
        }
      }
    }

    async function handleDrop(event) {
      event.preventDefault();
      event.stopPropagation();
      
      const target = event.currentTarget;
      
      // å¦‚æœæ‹–æ”¾åˆ°å…¬å¸æ¨™é¡Œæˆ–å…¬å¸å¡ç‰‡ï¼Œé˜»æ­¢é»æ“Šäº‹ä»¶è§¸ç™¼ä¸¦è‡ªå‹•å±•é–‹å¡ç‰‡
      const isCompanyHeader = target.classList.contains('company-header');
      const isCompanyCard = target.classList.contains('company-card');
      
      if (isCompanyHeader || isCompanyCard) {
        // å»¶é²åŸ·è¡Œï¼Œç¢ºä¿é»æ“Šäº‹ä»¶ä¸æœƒè§¸ç™¼
        setTimeout(() => {
          const card = isCompanyCard ? target : target.closest('.company-card');
          if (card) {
            // å¦‚æœå¡ç‰‡æ˜¯æ”¶åˆçš„ï¼Œè‡ªå‹•å±•é–‹
            if (card.classList.contains('collapsed')) {
              card.classList.remove('collapsed');
            }
          }
        }, 100);
      }
      
      // ç§»é™¤æ‰€æœ‰ drag-over æ¨£å¼
      document.querySelectorAll('.drag-over').forEach(el => {
        el.classList.remove('drag-over');
      });
      
      // æª¢æŸ¥ draggedStudent æ˜¯å¦å­˜åœ¨
      if (!draggedStudent) {
        console.error('æ‹–æ”¾å¤±æ•—ï¼šdraggedStudent ç‚º null');
        showToast('æ‹–æ”¾å¤±æ•—ï¼šç„¡æ³•ç²å–å­¸ç”Ÿè³‡è¨Š', 'error');
        return;
      }

      // ä¿å­˜å­¸ç”Ÿè³‡è¨Šï¼Œé¿å…åœ¨ç•°æ­¥æ“ä½œä¸­ä¸Ÿå¤±
      const studentInfo = {
        student_id: draggedStudent.student_id,
        student_name: draggedStudent.student_name,
        student_number: draggedStudent.student_number
      };
      
      // æ›´å¯é åœ°ç²å– companyId å’Œ jobId
      let companyId = target.dataset.companyId;
      let jobId = target.dataset.jobId;
      
      // å¦‚æœç•¶å‰å…ƒç´ æ²’æœ‰ï¼Œå‘ä¸ŠæŸ¥æ‰¾çˆ¶å…ƒç´ 
      if (!companyId) {
        const parentWithCompanyId = target.closest('[data-company-id]');
        if (parentWithCompanyId) companyId = parentWithCompanyId.dataset.companyId;
      }
      
      if (!jobId) {
        const parentWithJobId = target.closest('[data-job-id]');
        if (parentWithJobId) jobId = parentWithJobId.dataset.jobId;
      }
      
      // å¦‚æœæ‹–æ”¾åˆ°å…¬å¸å¡ç‰‡æœ¬èº«æˆ–å…¬å¸æ¨™é¡Œï¼ˆæ²’æœ‰ jobIdï¼‰ï¼Œå˜—è©¦æ‰¾åˆ°è©²å…¬å¸çš„ç¬¬ä¸€å€‹è·ç¼º
      if (companyId && !jobId) {
        const company = allCompaniesData.find(c => c.company_id.toString() === companyId.toString());
        if (company && company.jobs && company.jobs.length > 0) {
          // ä½¿ç”¨ç¬¬ä¸€å€‹è·ç¼º
          jobId = company.jobs[0].job_id;
          console.log('æ‹–æ”¾åˆ°å…¬å¸å¡ç‰‡ï¼Œä½¿ç”¨ç¬¬ä¸€å€‹è·ç¼º:', { 
            companyId, 
            jobId, 
            jobTitle: company.jobs[0].job_title,
            targetClass: target.className,
            isCompanyCard: isCompanyCard,
            isCompanyHeader: isCompanyHeader
          });
        } else {
          console.error('å…¬å¸æ²’æœ‰è·ç¼º:', { companyId, company });
          showToast('è©²å…¬å¸æ²’æœ‰è·ç¼ºï¼Œç„¡æ³•æ·»åŠ å­¸ç”Ÿ', 'error');
          return;
        }
      }
      
      let type = target.dataset.type || 'regular'; // regular æˆ– reserve
      let slotIndex = target.dataset.slotIndex ? parseInt(target.dataset.slotIndex) : null;

      // å¦‚æœæ‹–æ”¾åˆ°ç©ºä½æ¡†æ ¼ï¼Œè¨­å®šç‚ºæ­£å–é¡å‹
      if (target.classList.contains('empty-slot')) {
        type = 'regular';
        // ä¸ç›´æ¥ä½¿ç”¨ç©ºä½æ¡†æ ¼çš„ slotIndexï¼Œè€Œæ˜¯è¨ˆç®—ç¬¬ä¸€å€‹å¯ç”¨ä½ç½®
        slotIndex = null;
      }

      console.log('æ‹–æ”¾ç›®æ¨™ä¿¡æ¯:', {
        target: target,
        targetClass: target.className,
        companyId: companyId,
        jobId: jobId,
        type: type,
        slotIndex: slotIndex
      });

      if (!companyId || !jobId || companyId === 'undefined' || jobId === 'undefined') {
        console.error('ç¼ºå°‘å¿…è¦çš„åƒæ•¸:', { companyId, jobId });
        showToast('è«‹æ‹–æ”¾åˆ°å…·é«”çš„è·ç¼ºå€åŸŸ', 'error');
        return;
      }

      // å¦‚æœæ˜¯æ­£å–ä½†æ²’æœ‰æŒ‡å®š slot_indexï¼Œè¨ˆç®—ç¬¬ä¸€å€‹å¯ç”¨çš„æ­£å–ä½ç½®
      if (type === 'regular' && !slotIndex) {
        // æ‰¾åˆ°è©²è·ç¼ºï¼Œè¨ˆç®—ç¬¬ä¸€å€‹å¯ç”¨çš„æ­£å–ä½ç½®
        allCompaniesData.forEach(company => {
          if (company.company_id.toString() === companyId.toString()) {
            company.jobs.forEach(job => {
              if (job.job_id.toString() === jobId.toString()) {
                const regulars = job.regulars || [];
                const maxSlots = jobSlotsMap[`${company.company_id}_${job.job_id}`] || job.job_slots || 1;
                
                // æ‰¾å‡ºæ‰€æœ‰å·²ä½¿ç”¨çš„ slot_index
                const usedSlots = new Set();
                regulars.forEach(student => {
                  if (student.slot_index) {
                    usedSlots.add(student.slot_index);
                  }
                });
                
                // å¾1é–‹å§‹æ‰¾åˆ°ç¬¬ä¸€å€‹å¯ç”¨çš„ä½ç½®
                slotIndex = 1;
                while (usedSlots.has(slotIndex) && slotIndex <= maxSlots) {
                  slotIndex++;
                }
                
                // å¦‚æœæ‰€æœ‰ä½ç½®éƒ½è¢«ä½¿ç”¨ï¼Œä½¿ç”¨ä¸‹ä¸€å€‹ä½ç½®
                if (slotIndex > maxSlots) {
                  slotIndex = regulars.length + 1;
                }
              }
            });
          }
        });
      }

      // é©—è­‰æ‰€æœ‰å¿…è¦çš„åƒæ•¸
      if (!studentInfo || !studentInfo.student_id) {
        console.error('å­¸ç”Ÿè³‡è¨Šä¸å®Œæ•´:', studentInfo);
        showToast('å­¸ç”Ÿè³‡è¨Šä¸å®Œæ•´ï¼Œè«‹é‡è©¦', 'error');
        return;
      }

      const studentIdInt = parseInt(studentInfo.student_id);
      const companyIdInt = parseInt(companyId);
      const jobIdInt = parseInt(jobId);
      
      console.log('åƒæ•¸é©—è­‰:', {
        student_id: studentInfo.student_id,
        studentIdInt: studentIdInt,
        companyId: companyId,
        companyIdInt: companyIdInt,
        jobId: jobId,
        jobIdInt: jobIdInt,
        type: type,
        slotIndex: slotIndex
      });
      
      if (isNaN(studentIdInt) || isNaN(companyIdInt) || isNaN(jobIdInt)) {
        console.error('åƒæ•¸é©—è­‰å¤±æ•—:', {
          student_id: studentInfo.student_id,
          studentIdInt: studentIdInt,
          company_id: companyId,
          companyIdInt: companyIdInt,
          job_id: jobId,
          jobIdInt: jobIdInt
        });
        showToast('åƒæ•¸éŒ¯èª¤ï¼Œè«‹é‡è©¦', 'error');
        return;
      }

      try {
        const requestBody = {
          student_id: studentIdInt,
          company_id: companyIdInt,
          job_id: jobIdInt,
          type: type, // 'regular' æˆ– 'reserve'
          slot_index: slotIndex
        };
        
        console.log('ç™¼é€è«‹æ±‚:', requestBody);
        
        const res = await fetch('/admission/api/director_add_student', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(requestBody)
        });

        // æª¢æŸ¥å›æ‡‰ç‹€æ…‹
        if (!res.ok) {
          console.error('HTTP éŒ¯èª¤:', res.status, res.statusText);
          const errorText = await res.text();
          console.error('éŒ¯èª¤å›æ‡‰å…§å®¹:', errorText);
          try {
            const errorData = JSON.parse(errorText);
            showToast(errorData.message || `æ·»åŠ å¤±æ•— (${res.status})`, 'error');
          } catch (e) {
            showToast(`æ·»åŠ å¤±æ•— (${res.status}): ${errorText}`, 'error');
          }
          return;
        }

        const data = await res.json();
        console.log('æ”¶åˆ°å›æ‡‰:', data);
        
        if (data.success) {
          showToast(`å·²å°‡ã€Œ${studentInfo.student_name}ã€æ·»åŠ åˆ°${type === 'regular' ? 'æ­£å–' : 'å‚™å–'}åå–®`, 'success');
          loadMatchingResults(); // é‡æ–°è¼‰å…¥åª’åˆçµæœ
        } else {
          showToast(data.message || 'æ·»åŠ å¤±æ•—', 'error');
        }
      } catch (error) {
        console.error('æ·»åŠ å¤±æ•—:', error);
        showToast('æ·»åŠ å¤±æ•—: ' + (error.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
      } finally {
        // é‡ç½® draggedStudent
        draggedStudent = null;
      }
    }

    // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
    document.addEventListener('DOMContentLoaded', () => {
      loadMatchingResults();
      
      // ç¶å®šéæ¿¾å™¨äº‹ä»¶ï¼ˆæ¡†æ¶ä¸€ç›´å­˜åœ¨ï¼Œæ‰€ä»¥äº‹ä»¶ç¶å®šä¹Ÿè¦ä¸€ç›´å­˜åœ¨ï¼‰
      const companyFilter = document.getElementById('companyFilter');
      const jobFilter = document.getElementById('jobFilter');
      const studentNameFilter = document.getElementById('studentNameFilter');
      
      // çµ±ä¸€çš„éæ¿¾å’Œé‡æ–°æ¸²æŸ“å‡½æ•¸
      function applyFilters() {
        const filteredData = filterCompanies();
        renderCompanies(filteredData);
        renderUnmatchedStudents();  // åŒæ™‚æ›´æ–°æœªè¢«éŒ„å–å­¸ç”Ÿåˆ—è¡¨ï¼ˆæ‡‰ç”¨æœå°‹éæ¿¾ï¼‰
      }
      
      if (companyFilter) {
        companyFilter.addEventListener('change', () => {
          // ç•¶å…¬å¸æ”¹è®Šæ™‚ï¼Œæ›´æ–°è·ç¼ºéæ¿¾å™¨é¸é …
          updateJobFilterOptions();
          applyFilters();
        });
      }
      
      if (jobFilter) {
        jobFilter.addEventListener('change', () => {
          applyFilters();
        });
      }
      
      if (studentNameFilter) {
        // ä½¿ç”¨ debounce ä¾†é¿å…è¼¸å…¥æ™‚é »ç¹è§¸ç™¼
        let searchTimeout;
        studentNameFilter.addEventListener('input', () => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            applyFilters();
          }, 300);  // 300ms å»¶é²ï¼Œæå‡æ•ˆèƒ½
        });
      }
    });
  </script>
</body>
</html>

