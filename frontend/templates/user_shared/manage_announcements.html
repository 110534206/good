<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æ™ºæ…§å¯¦ç¿’å¹³å° | å…¬å‘Šç®¡ç†</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { padding: 0; font-family: "Noto Sans TC", sans-serif; background: #ffffff; overflow-x: hidden; }
    header { background: #0454a3; color: white; padding: 1rem 2rem; text-align: center; font-size: 1.5rem; }

    .top-bar-left { position: fixed; top: 1rem; left: 1rem; z-index: 1100; }
    .top-bar-left #menu-btn { width: 30px; height: 22px; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; background: none; border: none; padding: 0; }
    .top-bar-left #menu-btn span { display: block; width: 100%; height: 3px; background-color: white; border-radius: 2px; }

    .sidebar { position: fixed; top: 0; left: -250px; width: 250px; height: 100%; background: #2c3e50; color: white; transition: 0.3s; z-index: 1000; padding-top: 4rem; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
    .sidebar.active { left: 0; }
    .sidebar a { color: #ecf0f1; text-decoration: none; display: block; padding: 1rem 2rem; transition: 0.3s; }
    .sidebar a:hover { background: #34495e; padding-left: 2.5rem; }

    main { padding: 2rem; max-width: 1200px; margin: 0 auto; }
    .actions { display: flex; justify-content: flex-end; gap: 1rem; margin-bottom: 1rem; }
    .table-responsive { background: #fff; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #eee; vertical-align: middle; }
    th { background: #f8f9fa; font-weight: 600; color: #333; }
    
    .status-badge { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: bold; }
    .status-ongoing { background: #d1e7dd; color: #0f5132; }
    .status-draft { background: #e2e3e5; color: #41464b; }
    .pub-status-published { background: #cfe2ff; color: #084298; }
    .pub-status-not { background: #f8d7da; color: #842029; }
    
    .btn-action { border: 1px solid #ced4da; background: #fff; color: #333; padding: 0.4rem 0.8rem; border-radius: 4px; font-size: 0.9rem; transition: 0.2s; }
    .btn-action:hover { background: #f8f9fa; border-color: #adb5bd; }
    .btn-delete { color: #dc3545; }
    .btn-delete:hover { background: #fff5f5; border-color: #dc3545; }
  </style>
</head>

<body>
  <div class="top-bar-left">
    <button id="menu-btn" onclick="toggleSidebar()">
      <span></span><span></span><span></span>
    </button>
  </div>

  <nav class="sidebar" id="sidebar">
    <a href="/index">é¦–é </a>
    <a href="/announcement/manage">å…¬å‘Šç®¡ç†</a>
    <a href="/logout">ç™»å‡º</a>
  </nav>

  <header>æ™ºæ…§å¯¦ç¿’å¹³å° - å…¬å‘Šç®¡ç†</header>

  <main>
    <div class="actions">
      <button class="btn btn-primary" id="btn-new">+ æ–°å¢å…¬å‘Š</button>
      <button class="btn btn-success" id="btn-new-assignment">ğŸ“ æ–°å¢ä½œæ¥­æˆªæ­¢æ™‚é–“</button>
    </div>

    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>æ¨™é¡Œ</th>
            <th>é–‹å§‹æ™‚é–“</th>
            <th>çµæŸæ™‚é–“</th>
            <th>ç‹€æ…‹</th>
            <th>ç™¼å¸ƒç‹€æ…‹</th>
            <th>ç™¼å¸ƒæ™‚é–“</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="ann-table-body">
          </tbody>
      </table>
    </div>
  </main>

  <div class="modal fade" id="annModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">å…¬å‘Šç·¨è¼¯</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <form id="ann-form">
            <div class="mb-3"><label class="form-label">æ¨™é¡Œ</label><input type="text" class="form-control" id="ann-title" required></div>
            <div class="mb-3"><label class="form-label">å…§å®¹</label><textarea class="form-control" id="ann-content" rows="4"></textarea></div>
            <div class="mb-3"><label class="form-label">é–‹å§‹æ™‚é–“</label><input type="datetime-local" class="form-control" id="ann-start"></div>
            <div class="mb-3"><label class="form-label">çµæŸæ™‚é–“</label><input type="datetime-local" class="form-control" id="ann-end"></div>
            <div class="form-check"><input type="checkbox" class="form-check-input" id="ann-publish"><label class="form-check-label">ç«‹å³ç™¼å¸ƒ</label></div>
          </form>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button><button type="button" class="btn btn-primary" id="btn-save">å„²å­˜</button></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }

    // --- æ ¸å¿ƒä¿®æ­£ï¼šå¼·åˆ¶è½‰æ›ç‚º YYYY-MM-DD HH:mm:ssï¼Œå¾¹åº•ç§»é™¤è‹±æ–‡ ---
    function formatDateTimeCustom(dateString) {
      if (!dateString || dateString === 'â€”' || dateString === 'null') return 'â€”';

      // 1. å…ˆè™•ç†å¸¸è¦‹çš„ Z å’Œ T æ ¼å¼
      let s = dateString.replace('T', ' ').replace('Z', '').replace(/\//g, '-');
      
      // 2. å˜—è©¦å»ºç«‹ Date ç‰©ä»¶
      let d = new Date(s);

      // 3. å¦‚æœ Date è§£æå¤±æ•— (é€šå¸¸æ˜¯å¸¶æœ‰ Wed, Dec é€™ç¨®æ ¼å¼)
      // æˆ–è€…ç‚ºäº†ä¿éšªèµ·è¦‹ï¼Œæˆ‘å€‘ç›´æ¥ä½¿ç”¨æ­£å‰‡è¡¨é”å¼æŠ“å–æ•¸å­—
      if (isNaN(d.getTime()) || dateString.includes('Dec') || dateString.includes('Jan')) {
        const nums = dateString.match(/\d+/g);
        if (nums && nums.length >= 5) {
          const Y = nums[0].length === 4 ? nums[0] : nums[nums.length-1]; // ç°¡å–®åˆ¤æ–·å¹´ä»½ä½ç½®
          const M = nums[1].padStart(2, '0');
          const D = nums[2].padStart(2, '0');
          const h = nums[3].padStart(2, '0');
          const m = nums[4].padStart(2, '0');
          const sec = nums[5] ? nums[5].padStart(2, '0') : '00';
          // é€™è£¡å‡è¨­é †åºæ˜¯ å¹´-æœˆ-æ—¥
          return `${nums[0]}-${nums[1].padStart(2,'0')}-${nums[2].padStart(2,'0')} ${nums[3].padStart(2,'0')}:${nums[4].padStart(2,'0')}:${sec}`;
        }
      }

      // 4. è§£ææˆåŠŸï¼Œæ‰‹å‹•æ ¼å¼åŒ–é¿å…ç€è¦½å™¨ Locale å¹²æ“¾
      const Y = d.getFullYear();
      const M = String(d.getMonth() + 1).padStart(2, '0');
      const D = String(d.getDate()).padStart(2, '0');
      const h = String(d.getHours()).padStart(2, '0');
      const m = String(d.getMinutes()).padStart(2, '0');
      const sec = String(d.getSeconds()).padStart(2, '0');

      return `${Y}-${M}-${D} ${h}:${m}:${sec}`;
    }

    let annList = [];
    let editId = null;
    const annModal = new bootstrap.Modal(document.getElementById('annModal'));

    async function loadAnnouncements() {
      const res = await fetch('/announcement/api/list');
      annList = await res.json();
      const tbody = document.getElementById("ann-table-body");
      tbody.innerHTML = "";

      annList.forEach(ann => {
        const now = new Date();
        const start = ann.start_time ? new Date(ann.start_time) : null;
        const end = ann.end_time ? new Date(ann.end_time) : null;
        let status = '<span class="status-badge status-draft">æœªç™¼å¸ƒ</span>';
        
        if (ann.is_published == 1) {
          if (start && end && now >= start && now <= end) {
            status = '<span class="status-badge status-ongoing">é€²è¡Œä¸­</span>';
          } else {
            status = '<span class="status-badge status-draft">å·²çµæŸ/æœªé–‹å§‹</span>';
          }
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${ann.title}</td>
          <td>${formatDateTimeCustom(ann.start_time)}</td>
          <td>${formatDateTimeCustom(ann.end_time)}</td>
          <td>${status}</td>
          <td>${ann.is_published == 1 ? '<span class="status-badge pub-status-published">å·²ç™¼å¸ƒ</span>' : '<span class="status-badge pub-status-not">æœªç™¼å¸ƒ</span>'}</td>
          <td>${formatDateTimeCustom(ann.created_at)}</td>
          <td>
            <button class="btn-action" onclick="editAnnouncement(${ann.id})">âœï¸</button>
            <button class="btn-action btn-delete" onclick="deleteAnnouncement(${ann.id})">ğŸ—‘ï¸</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // å„²å­˜ã€ç·¨è¼¯ã€åˆªé™¤é‚è¼¯ (èˆ‡åŸæœ¬ä¸€è‡´)
    document.getElementById("btn-save").onclick = async () => {
      const data = {
        title: document.getElementById("ann-title").value,
        content: document.getElementById("ann-content").value,
        start_time: document.getElementById("ann-start").value,
        end_time: document.getElementById("ann-end").value,
        is_published: document.getElementById("ann-publish").checked ? 1 : 0
      };
      const url = editId ? `/announcement/api/update/${editId}` : '/announcement/api/create';
      const method = editId ? 'PUT' : 'POST';
      await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
      annModal.hide();
      loadAnnouncements();
    };

    window.editAnnouncement = function (id) {
      const ann = annList.find(a => a.id === id);
      if (!ann) return;
      editId = id;
      document.getElementById("ann-title").value = ann.title;
      document.getElementById("ann-content").value = ann.content;
      // datetime-local ä¿®æ­£
      if (ann.start_time) document.getElementById("ann-start").value = ann.start_time.replace(' ', 'T').slice(0, 16);
      if (ann.end_time) document.getElementById("ann-end").value = ann.end_time.replace(' ', 'T').slice(0, 16);
      document.getElementById("ann-publish").checked = (ann.is_published == 1);
      annModal.show();
    };

    window.deleteAnnouncement = async (id) => {
      if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) {
        await fetch(`/announcement/api/delete/${id}`, { method: "DELETE" });
        loadAnnouncements();
      }
    };

    document.getElementById("btn-new").onclick = () => { editId = null; document.getElementById("ann-form").reset(); annModal.show(); };
    
    window.onload = loadAnnouncements;
  </script>
</body>
</html>