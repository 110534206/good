<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æ™ºæ…§å¯¦ç¿’å¹³å° | å…¬å‘Šç®¡ç†</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* å…¨åŸŸèˆ‡å´é‚Šæ¬„è¨­å®š */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { padding: 0; font-family: "Noto Sans TC", sans-serif; background: #f5f7fa; overflow-x: hidden; }
    header { background: #0454a3; color: white; padding: 1rem 2rem; text-align: center; font-size: 1.5rem; }

    .top-bar-left { position: fixed; top: 1rem; left: 1rem; z-index: 1100; }
    .top-bar-left #menu-btn { width: 30px; height: 22px; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; background: none; border: none; padding: 0; }
    .top-bar-left #menu-btn span { display: block; width: 100%; height: 3px; background-color: white; border-radius: 2px; transition: all 0.3s ease; }
    #side-menu { position: fixed; top: 0; left: 0; height: 100vh; width: 320px; background-color: rgba(10, 10, 10, 0.95); backdrop-filter: blur(6px); box-shadow: 3px 0 12px rgba(0,0,0,0.7); padding: 2rem 1.5rem; transform: translateX(-100%); transition: transform 0.3s ease-in-out; z-index: 1200; display: flex; flex-direction: column; align-items: flex-start; color: white; }
    #side-menu.open { transform: translateX(0); }
    #close-btn { position: absolute; top: 1.5rem; right: 1.5rem; font-size: 2.2rem; background: none; border: none; color: white; cursor: pointer; }
    #side-menu a { color: white; text-decoration: none; font-size: 1.1rem; margin-bottom: 1.2rem; }
    
    .container { padding: 2.5rem; margin-top: 3rem; margin-bottom: 3rem; max-width: 95%; background-color: #ffffff; border: 1px solid #dee2e6; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.05); }

    /* ä¸‹æ–¹æˆªæ­¢æ™‚é–“é¡¯ç¤ºå€æ¨£å¼ */
    .deadline-display-box {
      margin-top: 20px;
      border: 2px solid #2e7d32;
      border-radius: 4px;
      background-color: #f8f9fa;
      display: none; /* å„²å­˜å¾Œé¡¯ç¤º */
    }
    .deadline-display-table { width: 100%; }
    .deadline-display-table td { padding: 15px !important; font-weight: bold; color: #1b5e20; border: none !important; vertical-align: middle; }

    .btn { display: inline-flex; align-items: center; justify-content: center; font-weight: 500; }
  </style>
</head>

<body>
  <header>å…¬å‘Šç®¡ç†</header>

  <div class="top-bar-left">
    <div id="menu-btn"><span></span><span></span><span></span></div>
  </div>

  <nav id="side-menu">
    <h2>åŠŸèƒ½é¸å–®</h2>
    <button id="close-btn">Ã—</button>
    <a href="/assistant_home">é¦–é </a>
    <a href="/profile">å€‹äººè³‡æ–™</a>
    <a href="/announcement/manage_announcements">å…¬å‘Šç®¡ç†</a>
    <a href="/ta/statistics/manage_companies">å¯¦ç¿’å» å•†ç®¡ç†</a>
    <a href="/final_results">å¿—é¡˜åºçµæœ</a>
    <a href="/notifications">é€šçŸ¥</a>
    <a href="/admin/absence_default_range">ç¼ºå‹¤é è¨­å­¸æœŸç¯„åœè¨­å®š</a>
    <a href="/ta/upload_standard_courses">å°ˆæ¥­æ ¸å¿ƒç§‘ç›®ç®¡ç†</a>
    <a href="/login">ç™»å‡º</a>
  </nav>

  <div class="container">
    <div class="mb-4 d-flex justify-content-between align-items-center">
      <h4 class="mb-0" style="font-weight: bold;">å…¬å‘Šåˆ—è¡¨</h4>
      <div>
        <button id="btn-new" class="btn btn-primary me-2">â• æ–°å¢å…¬å‘Š</button>
        <button id="btn-open-deadline" class="btn btn-success">ğŸ“ æ–°å¢ä½œæ¥­æˆªæ­¢æ™‚é–“</button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle" id="ann-table">
        <thead class="table-light">
          <tr>
            <th style="width: 25%;">æ¨™é¡Œ</th>
            <th class="text-center">é–‹å§‹æ™‚é–“</th>
            <th class="text-center">çµæŸæ™‚é–“</th>
            <th class="text-center">ç‹€æ…‹</th>
            <th class="text-center">ç™¼å¸ƒç‹€æ…‹</th>
            <th class="text-center">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="ann-tbody"></tbody>
      </table>
    </div>

    <div id="deadline-display-area" class="deadline-display-box">
      <table class="deadline-display-table">
        <tr>
          <td style="width: 45%;">ğŸš© å¿—é¡˜åºæˆªæ­¢ï¼š<span id="pref-time-text">æœªè¨­å®š</span></td>
          <td style="width: 45%;">ğŸ“„ å±¥æ­·ä¸Šå‚³æˆªæ­¢ï¼š<span id="resume-time-text">æœªè¨­å®š</span></td>
          <td style="text-align: right;"><button class="btn btn-sm btn-link text-success p-0" onclick="document.getElementById('deadline-display-area').style.display='none'">æ¸…é™¤</button></td>
        </tr>
      </table>
    </div>
  </div>

  <div class="modal fade" id="deadlineModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" style="font-weight: bold;">è¨­å®šä½œæ¥­æˆªæ­¢æ™‚é–“</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">å¡«å¯«å¿—é¡˜åºæˆªæ­¢ï¼š</label>
            <input type="datetime-local" id="pref-input" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">ä¸Šå‚³å±¥æ­·æˆªæ­¢ï¼š</label>
            <input type="datetime-local" id="resume-input" class="form-control">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button id="btn-save-deadline" type="button" class="btn btn-primary">å„²å­˜ä¸¦é€šçŸ¥å­¸ç”Ÿ</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="annModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle" style="font-weight: bold;">æ–°å¢å…¬å‘Š</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3"><label class="form-label">æ¨™é¡Œ</label><input id="ann-title" class="form-control"></div>
          <div class="mb-3"><label class="form-label">å…§å®¹</label><textarea id="ann-content" class="form-control" rows="4"></textarea></div>
          <div class="mb-3"><label class="form-label">é–‹å§‹æ™‚é–“</label><input id="ann-start" type="datetime-local" class="form-control"></div>
          <div class="mb-3"><label class="form-label">çµæŸæ™‚é–“</label><input id="ann-end" type="datetime-local" class="form-control"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button id="btn-save-ann" type="button" class="btn btn-primary">å„²å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const annTbody = document.getElementById("ann-tbody");
      const annModal = new bootstrap.Modal(document.getElementById("annModal"));
      const deadlineModal = new bootstrap.Modal(document.getElementById("deadlineModal"));
      let editId = null, annList = [];

      // é¸å–®é‚è¼¯
      document.getElementById("menu-btn").onclick = () => document.getElementById("side-menu").classList.add("open");
      document.getElementById("close-btn").onclick = () => document.getElementById("side-menu").classList.remove("open");

      // æ ¸å¿ƒï¼šå¼·åˆ¶å¹´æœˆæ—¥æ™‚åˆ†ç´”æ•¸å­—æ ¼å¼åŒ–
      // è™•ç† datetime-local è¼¸å…¥æ ¼å¼ï¼Œé¿å…æ™‚å€è½‰æ›å•é¡Œ
      function formatDT(str) {
        if (!str || str === 'â€”') return 'â€”';
        
        // å¦‚æœæ˜¯ datetime-local æ ¼å¼ (YYYY-MM-DDTHH:mm)ï¼Œç›´æ¥è§£æä¸è½‰æ›æ™‚å€
        if (str.includes('T')) {
          const [datePart, timePart] = str.split('T');
          const [year, month, day] = datePart.split('-');
          const [hour, minute] = timePart.split(':');
          return `${year}/${month}/${day} ${hour.padStart(2, '0')}:${minute.padStart(2, '0')}`;
        }
        
        // å¦‚æœæ˜¯ Date å°è±¡æˆ–å…¶ä»–æ ¼å¼ï¼Œä½¿ç”¨åŸé‚è¼¯
        const d = new Date(str);
        if (isNaN(d.getTime())) return str;
        return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
      }

      // ä½œæ¥­æˆªæ­¢æ™‚é–“åŠŸèƒ½
      document.getElementById("btn-open-deadline").onclick = () => deadlineModal.show();
      document.getElementById("btn-save-deadline").onclick = async () => {
        const pV = document.getElementById("pref-input").value;
        const rV = document.getElementById("resume-input").value;
        if (!pV || !rV) {
          alert("è«‹å®Œæ•´å¡«å¯«æ—¥æœŸèˆ‡æ™‚é–“");
          return;
        }

        try {
          // ç™¼é€ API è«‹æ±‚å„²å­˜åˆ°è³‡æ–™è¡¨
          const res = await fetch("/announcement/api/save_deadlines", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              pref_deadline: pV,
              resume_deadline: rV
            })
          });

          const result = await res.json();
          
          if (result.success) {
            document.getElementById("pref-time-text").innerText = formatDT(pV);
            document.getElementById("resume-time-text").innerText = formatDT(rV);
            document.getElementById("deadline-display-area").style.display = "block";
            deadlineModal.hide();
            
            // é‡æ–°è¼‰å…¥å…¬å‘Šåˆ—è¡¨
            loadData();
            
            alert("æˆªæ­¢æ™‚é–“å·²å„²å­˜åˆ°è³‡æ–™è¡¨ï¼Œä¸¦å·²åŒæ­¥ç™¼å¸ƒé€šçŸ¥çµ¦å­¸ç”Ÿï¼");
          } else {
            alert("å„²å­˜å¤±æ•—ï¼š" + (result.message || "æœªçŸ¥éŒ¯èª¤"));
          }
        } catch (error) {
          console.error("å„²å­˜æˆªæ­¢æ™‚é–“å¤±æ•—:", error);
          alert("å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        }
      };

      // æ¸²æŸ“è¡¨æ ¼ (åŒ…å«åˆ¤æ–·é‚è¼¯)
      function renderTable() {
        const now = new Date();
        annTbody.innerHTML = annList.map(a => {
          const s = formatDT(a.start_time), e = formatDT(a.end_time);
          let st = "æœªç™¼å¸ƒ", color = "secondary";
          const sd = new Date(a.start_time), ed = new Date(a.end_time);
          if (now < sd) st = "æœªé–‹å§‹";
          else if (now > ed) { st = "å·²çµæŸ"; color = "danger"; }
          else { st = "é€²è¡Œä¸­"; color = "success"; }
          
          return `<tr>
            <td class="fw-bold">${a.title}</td>
            <td class="text-center">${s}</td>
            <td class="text-center">${e}</td>
            <td class="text-center"><span class="badge bg-${color}">${st}</span></td>
            <td class="text-center">å·²ç™¼å¸ƒ</td>
            <td class="text-center">
              <button class="btn btn-sm btn-outline-primary me-1" onclick="editAnn(${a.id})">ç·¨è¼¯</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteAnn(${a.id})">åˆªé™¤</button>
            </td>
          </tr>`;
        }).join('');
      }

      // å…¬å‘Š CRUD é‚è¼¯ (ä¿ç•™åŸ API)
      document.getElementById("btn-new").onclick = () => {
        editId = null;
        document.getElementById("modalTitle").innerText = "æ–°å¢å…¬å‘Š";
        document.querySelectorAll('#annModal input:not([type=checkbox]), textarea').forEach(i => i.value = "");
        annModal.show();
      };

      document.getElementById("btn-save-ann").onclick = async () => {
        const payload = {
          title: document.getElementById("ann-title").value,
          content: document.getElementById("ann-content").value,
          start_time: document.getElementById("ann-start").value.replace('T', ' '),
          end_time: document.getElementById("ann-end").value.replace('T', ' ')
        };
        const url = editId ? `/announcement/api/update/${editId}` : `/announcement/api/create`;
        const res = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
        if ((await res.json()).success) { annModal.hide(); loadData(); }
      };

      window.editAnn = (id) => {
        const a = annList.find(i => i.id === id);
        if (!a) return;
        editId = id;
        document.getElementById("modalTitle").innerText = "ç·¨è¼¯å…¬å‘Š";
        document.getElementById("ann-title").value = a.title;
        document.getElementById("ann-content").value = a.content || "";
        annModal.show();
      };

      window.deleteAnn = async (id) => {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ")) return;
        const res = await fetch(`/announcement/api/delete/${id}`, { method: "DELETE" });
        if ((await res.json()).success) loadData();
      };

      async function loadData() {
        try {
          const res = await fetch(`/announcement/api/list?t=${Date.now()}`);
          annList = (await res.json()).data || [];
          renderTable();
        } catch (e) { console.error(e); }
      }
      loadData();
    });
  </script>
</body>
</html>