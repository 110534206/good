<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æ™ºæ…§å¯¦ç¿’å¹³å° | å…¬å‘Šç®¡ç†</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* å…¨åŸŸèˆ‡å´é‚Šæ¬„è¨­å®š */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { padding: 0; font-family: "Noto Sans TC", sans-serif; background: #f5f7fa; overflow-x: hidden; }
    header { background: #0454a3; color: white; padding: 1rem 2rem; text-align: center; font-size: 1.5rem; }

    .top-bar-left { position: fixed; top: 1rem; left: 1rem; z-index: 1100; }
    .top-bar-left #menu-btn { width: 30px; height: 22px; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; background: none; border: none; padding: 0; }
    .top-bar-left #menu-btn span { display: block; width: 100%; height: 3px; background-color: white; border-radius: 2px; transition: all 0.3s ease; }
    #side-menu { position: fixed; top: 0; left: 0; height: 100vh; width: 320px; max-width: 80vw; background-color: rgba(10, 10, 10, 0.95); backdrop-filter: blur(6px); box-shadow: 3px 0 12px rgba(0, 0, 0, 0.7); padding: 2rem 1.5rem; transform: translateX(-100%); transition: transform 0.3s ease-in-out; z-index: 1200; display: flex; flex-direction: column; align-items: flex-start; color: white; user-select: none; }
    #side-menu.open { transform: translateX(0); }
    #side-menu .menu-header { display: flex; align-items: center; justify-content: space-between; width: 100%; margin-bottom: 1.5rem; }
    #side-menu h2 { margin: 0; font-weight: 700; font-size: 1.5rem; text-align: left; flex: 1; color: white; }
    #close-btn { font-size: 2.2rem; background: none; border: none; color: white; cursor: pointer; line-height: 1; width: 2.5rem; height: 2.5rem; display: flex; align-items: center; justify-content: center; padding: 0; margin: 0; }
    #side-menu a { 
      display: block; 
      width: 100%; 
      padding: 0.5rem 0; 
      font-size: 1.1rem; 
      color: #ddd; 
      text-decoration: none; 
      border-radius: 4px; 
      transition: background-color 0.2s ease;
    }
    #side-menu a:hover {
      background-color: rgba(255, 255, 255, 0.15);
      color: white;
    }
    
    .container { padding: 2.5rem; margin-top: 3rem; margin-bottom: 3rem; max-width: 95%; background-color: #ffffff; border: 1px solid #dee2e6; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.05); }

    .btn { display: inline-flex; align-items: center; justify-content: center; font-weight: 500; }
  </style>
</head>

<body>
  <header>å…¬å‘Šç®¡ç†</header>

  <div class="top-bar-left">
    <div id="menu-btn"><span></span><span></span><span></span></div>
  </div>

 <!-- å´é‚Šé¸å–® -->
  <nav id="side-menu">
    <div class="menu-header">
      <h2>åŠŸèƒ½é¸å–®</h2>
      <button id="close-btn">Ã—</button>
    </div>
    <a href="/ta_home">é¦–é </a>
    <a href="/profile">å€‹äººè³‡æ–™</a>
    <a href="/announcement/manage_announcements">å…¬å‘Šç®¡ç†</a>
    <a href="/ta/statistics/manage_companies">å¯¦ç¿’å» å•†ç®¡ç†</a>
    <a href="/final_results">å¿—é¡˜åºçµæœ</a>
    <a href="/notifications">é€šçŸ¥</a>
    <a href="/admin/absence_default_range">ç¼ºå‹¤é è¨­å­¸æœŸç¯„åœè¨­å®š</a>
    <a href="/ta/upload_standard_courses">å°ˆæ¥­æ ¸å¿ƒç§‘ç›®ç®¡ç†</a>
    <a href="/login">ç™»å‡º</a>
  </nav>

  <div class="container">
    <div class="mb-4 d-flex justify-content-between align-items-center">
      <h4 class="mb-0" style="font-weight: bold;">å…¬å‘Šåˆ—è¡¨</h4>
      <div>
        <button id="btn-new" class="btn btn-primary me-2">â• æ–°å¢å…¬å‘Š</button>
        <button id="btn-open-pref-deadline" class="btn btn-success me-2">ğŸ“ å¡«å¯«å¿—é¡˜åºæˆªæ­¢æ™‚é–“</button>
        <button id="btn-open-resume-deadline" class="btn btn-success">ğŸ“ ä¸Šå‚³å±¥æ­·æˆªæ­¢æ™‚é–“</button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle" id="ann-table">
        <thead class="table-light">
          <tr>
            <th style="width: 25%;">æ¨™é¡Œ</th>
            <th class="text-center">é–‹å§‹æ™‚é–“</th>
            <th class="text-center">çµæŸæ™‚é–“</th>
            <th class="text-center">ç‹€æ…‹</th>
            <th class="text-center">ç™¼å¸ƒç‹€æ…‹</th>
            <th class="text-center">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="ann-tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="modal fade" id="prefDeadlineModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" style="font-weight: bold;">æ–°å¢ä½œæ¥­æˆªæ­¢æ™‚é–“</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3"><label class="form-label">æ¨™é¡Œ</label><input id="pref-title" class="form-control"></div>
          <div class="mb-3"><label class="form-label">å…§å®¹</label><textarea id="pref-content" class="form-control" rows="4"></textarea></div>
          <div class="mb-3"><label class="form-label">é–‹å§‹æ™‚é–“</label><input id="pref-start" type="datetime-local" class="form-control"></div>
          <div class="mb-3"><label class="form-label">çµæŸæ™‚é–“</label><input id="pref-end" type="datetime-local" class="form-control"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button id="btn-save-pref-deadline" type="button" class="btn btn-primary">å„²å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="resumeDeadlineModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" style="font-weight: bold;">æ–°å¢ä½œæ¥­æˆªæ­¢æ™‚é–“</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3"><label class="form-label">æ¨™é¡Œ</label><input id="resume-title" class="form-control"></div>
          <div class="mb-3"><label class="form-label">å…§å®¹</label><textarea id="resume-content" class="form-control" rows="4"></textarea></div>
          <div class="mb-3"><label class="form-label">é–‹å§‹æ™‚é–“</label><input id="resume-start" type="datetime-local" class="form-control"></div>
          <div class="mb-3"><label class="form-label">çµæŸæ™‚é–“</label><input id="resume-end" type="datetime-local" class="form-control"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button id="btn-save-resume-deadline" type="button" class="btn btn-primary">å„²å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="annModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle" style="font-weight: bold;">æ–°å¢å…¬å‘Š</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3"><label class="form-label">æ¨™é¡Œ</label><input id="ann-title" class="form-control"></div>
          <div class="mb-3"><label class="form-label">å…§å®¹</label><textarea id="ann-content" class="form-control" rows="4"></textarea></div>
          <div class="mb-3"><label class="form-label">é–‹å§‹æ™‚é–“</label><input id="ann-start" type="datetime-local" class="form-control"></div>
          <div class="mb-3"><label class="form-label">çµæŸæ™‚é–“</label><input id="ann-end" type="datetime-local" class="form-control"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button id="btn-save-ann" type="button" class="btn btn-primary">å„²å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const annTbody = document.getElementById("ann-tbody");
      const annModal = new bootstrap.Modal(document.getElementById("annModal"));
      const prefDeadlineModal = new bootstrap.Modal(document.getElementById("prefDeadlineModal"));
      const resumeDeadlineModal = new bootstrap.Modal(document.getElementById("resumeDeadlineModal"));
      let editId = null, annList = [];

      // é¸å–®é‚è¼¯
      document.getElementById("menu-btn").onclick = () => document.getElementById("side-menu").classList.add("open");
      document.getElementById("close-btn").onclick = () => document.getElementById("side-menu").classList.remove("open");
      
      // æ¨™è¨˜ç•¶å‰é é¢çš„é¸å–®é …ç›®
      const currentPath = window.location.pathname;
      document.querySelectorAll('#side-menu a').forEach(link => {
        if (link.getAttribute('href') === currentPath) {
          link.classList.add('active');
        }
      });

      // æ ¸å¿ƒï¼šå¼·åˆ¶å¹´æœˆæ—¥æ™‚åˆ†ç´”æ•¸å­—æ ¼å¼åŒ–
      // è™•ç† datetime-local è¼¸å…¥æ ¼å¼ï¼Œé¿å…æ™‚å€è½‰æ›å•é¡Œ
      function formatDT(str) {
        if (!str || str === 'â€”') return 'â€”';
        
        // å¦‚æœæ˜¯ datetime-local æ ¼å¼ (YYYY-MM-DDTHH:mm)ï¼Œç›´æ¥è§£æä¸è½‰æ›æ™‚å€
        if (str.includes('T')) {
          const [datePart, timePart] = str.split('T');
          const [year, month, day] = datePart.split('-');
          const [hour, minute] = timePart.split(':');
          return `${year}/${month}/${day} ${hour.padStart(2, '0')}:${minute.padStart(2, '0')}`;
        }
        
        // å¦‚æœæ˜¯ Date å°è±¡æˆ–å…¶ä»–æ ¼å¼ï¼Œä½¿ç”¨åŸé‚è¼¯
        const d = new Date(str);
        if (isNaN(d.getTime())) return str;
        return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
      }

      // ä½œæ¥­æˆªæ­¢æ™‚é–“åŠŸèƒ½
      document.getElementById("btn-open-pref-deadline").onclick = () => {
        document.getElementById("pref-title").value = "[ä½œæ¥­]å¡«å¯«å¿—é¡˜åºæˆªæ­¢æ™‚é–“";
        document.getElementById("pref-content").value = "è«‹æ³¨æ„!å¡«å¯«å¿—é¡˜åºçš„æˆªæ­¢æ™‚é–“ç‚º:è«‹é¸æ“‡çµæŸæ™‚é–“,è«‹å‹™å¿…åœ¨æˆªæ­¢æ™‚é–“å‰å®Œæˆå¿—é¡˜åºå¡«å¯«ã€‚";
        document.getElementById("pref-start").value = "";
        document.getElementById("pref-end").value = "";
        prefDeadlineModal.show();
      };
      
      document.getElementById("btn-open-resume-deadline").onclick = () => {
        document.getElementById("resume-title").value = "[ä½œæ¥­]ä¸Šå‚³å±¥æ­·æˆªæ­¢æ™‚é–“";
        document.getElementById("resume-content").value = "è«‹æ³¨æ„!ä¸Šå‚³å±¥æ­·çš„æˆªæ­¢æ™‚é–“ç‚º:è«‹é¸æ“‡çµæŸæ™‚é–“,è«‹å‹™å¿…åœ¨æˆªæ­¢æ™‚é–“å‰å®Œæˆå±¥æ­·ä¸Šå‚³ã€‚";
        document.getElementById("resume-start").value = "";
        document.getElementById("resume-end").value = "";
        resumeDeadlineModal.show();
      };

      // ç•¶çµæŸæ™‚é–“æ”¹è®Šæ™‚ï¼Œè‡ªå‹•æ›´æ–°å…§å®¹ä¸­çš„æˆªæ­¢æ™‚é–“
      document.getElementById("pref-end").addEventListener("change", function() {
        const endTime = this.value;
        if (endTime) {
          // å°‡ datetime-local æ ¼å¼ (YYYY-MM-DDTHH:mm) è½‰æ›ç‚º YYYY-MM-DD HH:mm
          const formattedTime = endTime.replace('T', ' ');
          const content = document.getElementById("pref-content");
          content.value = `è«‹æ³¨æ„!å¡«å¯«å¿—é¡˜åºçš„æˆªæ­¢æ™‚é–“ç‚º:${formattedTime},è«‹å‹™å¿…åœ¨æˆªæ­¢æ™‚é–“å‰å®Œæˆå¿—é¡˜åºå¡«å¯«ã€‚`;
        }
      });

      document.getElementById("resume-end").addEventListener("change", function() {
        const endTime = this.value;
        if (endTime) {
          // å°‡ datetime-local æ ¼å¼ (YYYY-MM-DDTHH:mm) è½‰æ›ç‚º YYYY-MM-DD HH:mm
          const formattedTime = endTime.replace('T', ' ');
          const content = document.getElementById("resume-content");
          content.value = `è«‹æ³¨æ„!ä¸Šå‚³å±¥æ­·çš„æˆªæ­¢æ™‚é–“ç‚º:${formattedTime},è«‹å‹™å¿…åœ¨æˆªæ­¢æ™‚é–“å‰å®Œæˆå±¥æ­·ä¸Šå‚³ã€‚`;
        }
      });

      document.getElementById("btn-save-pref-deadline").onclick = async () => {
        const title = document.getElementById("pref-title").value;
        const content = document.getElementById("pref-content").value;
        const startTime = document.getElementById("pref-start").value;
        const endTime = document.getElementById("pref-end").value;
        
        if (!title || !startTime || !endTime) {
          alert("è«‹å®Œæ•´å¡«å¯«æ¨™é¡Œã€é–‹å§‹æ™‚é–“èˆ‡çµæŸæ™‚é–“");
          return;
        }

        try {
          // ç™¼é€ API è«‹æ±‚å„²å­˜åˆ°è³‡æ–™è¡¨
          const res = await fetch("/announcement/api/save_deadlines", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              pref_deadline: endTime,
              title: title,
              content: content,
              start_time: startTime.replace('T', ' '),
              end_time: endTime.replace('T', ' ')
            })
          });

          const result = await res.json();
          
          if (result.success) {
            prefDeadlineModal.hide();
            
            // é‡æ–°è¼‰å…¥å…¬å‘Šåˆ—è¡¨
            loadData();
          } else {
            alert("å„²å­˜å¤±æ•—ï¼š" + (result.message || "æœªçŸ¥éŒ¯èª¤"));
          }
        } catch (error) {
          console.error("å„²å­˜æˆªæ­¢æ™‚é–“å¤±æ•—:", error);
          alert("å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        }
      };

      document.getElementById("btn-save-resume-deadline").onclick = async () => {
        const title = document.getElementById("resume-title").value;
        const content = document.getElementById("resume-content").value;
        const startTime = document.getElementById("resume-start").value;
        const endTime = document.getElementById("resume-end").value;
        
        if (!title || !startTime || !endTime) {
          alert("è«‹å®Œæ•´å¡«å¯«æ¨™é¡Œã€é–‹å§‹æ™‚é–“èˆ‡çµæŸæ™‚é–“");
          return;
        }

        try {
          // ç™¼é€ API è«‹æ±‚å„²å­˜åˆ°è³‡æ–™è¡¨
          const res = await fetch("/announcement/api/save_deadlines", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              resume_deadline: endTime,
              title: title,
              content: content,
              start_time: startTime.replace('T', ' '),
              end_time: endTime.replace('T', ' ')
            })
          });

          const result = await res.json();
          
          if (result.success) {
            resumeDeadlineModal.hide();
            
            // é‡æ–°è¼‰å…¥å…¬å‘Šåˆ—è¡¨
            loadData();
          } else {
            alert("å„²å­˜å¤±æ•—ï¼š" + (result.message || "æœªçŸ¥éŒ¯èª¤"));
          }
        } catch (error) {
          console.error("å„²å­˜æˆªæ­¢æ™‚é–“å¤±æ•—:", error);
          alert("å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        }
      };

      // æ¸²æŸ“è¡¨æ ¼ (åŒ…å«åˆ¤æ–·é‚è¼¯)
      function renderTable() {
        const now = new Date();
        annTbody.innerHTML = annList.map(a => {
          const s = formatDT(a.start_time), e = formatDT(a.end_time);
          let st = "æœªç™¼å¸ƒ", color = "secondary";
          const sd = new Date(a.start_time), ed = new Date(a.end_time);
          if (now < sd) st = "æœªé–‹å§‹";
          else if (now > ed) { st = "å·²çµæŸ"; color = "danger"; }
          else { st = "é€²è¡Œä¸­"; color = "success"; }
          
          // ç™¼å¸ƒç‹€æ…‹ï¼šæ ¹æ“šç‹€æ…‹æ±ºå®š
          let publishStatus = "å·²ç™¼å¸ƒ";
          if (st === "æœªé–‹å§‹") publishStatus = "æœªç™¼å¸ƒ";
          else if (st === "å·²çµæŸ") publishStatus = "å·²çµæŸ";
          
          return `<tr>
            <td class="fw-bold">${a.title}</td>
            <td class="text-center">${s}</td>
            <td class="text-center">${e}</td>
            <td class="text-center"><span class="badge bg-${color}">${st}</span></td>
            <td class="text-center">${publishStatus}</td>
            <td class="text-center">
              <button class="btn btn-sm btn-outline-primary me-1" onclick="editAnn(${a.id})">ç·¨è¼¯</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteAnn(${a.id})">åˆªé™¤</button>
            </td>
          </tr>`;
        }).join('');
      }

      // å…¬å‘Š CRUD é‚è¼¯ (ä¿ç•™åŸ API)
      document.getElementById("btn-new").onclick = () => {
        editId = null;
        document.getElementById("modalTitle").innerText = "æ–°å¢å…¬å‘Š";
        document.querySelectorAll('#annModal input:not([type=checkbox]), textarea').forEach(i => i.value = "");
        annModal.show();
      };

      document.getElementById("btn-save-ann").onclick = async () => {
        const payload = {
          title: document.getElementById("ann-title").value,
          content: document.getElementById("ann-content").value,
          start_time: document.getElementById("ann-start").value.replace('T', ' '),
          end_time: document.getElementById("ann-end").value.replace('T', ' ')
        };
        const url = editId ? `/announcement/api/update/${editId}` : `/announcement/api/create`;
        const res = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
        if ((await res.json()).success) { annModal.hide(); loadData(); }
      };

      window.editAnn = (id) => {
        const a = annList.find(i => i.id === id);
        if (!a) return;
        editId = id;
        document.getElementById("modalTitle").innerText = "ç·¨è¼¯å…¬å‘Š";
        document.getElementById("ann-title").value = a.title;
        document.getElementById("ann-content").value = a.content || "";
        annModal.show();
      };

      window.deleteAnn = async (id) => {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ")) return;
        const res = await fetch(`/announcement/api/delete/${id}`, { method: "DELETE" });
        if ((await res.json()).success) loadData();
      };

      async function loadData() {
        try {
          const res = await fetch(`/announcement/api/list?t=${Date.now()}`);
          annList = (await res.json()).data || [];
          renderTable();
        } catch (e) { console.error(e); }
      }
      loadData();
    });
  </script>
</body>
</html>