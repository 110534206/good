<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æ™ºæ…§å¯¦ç¿’å¹³å° | å…¬å‘Šç®¡ç†</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* å…¨åŸŸè¨­å®š */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    /* ä¿®æ”¹èƒŒæ™¯é¡è‰²ï¼Œè®“ç™½è‰²çš„ã€Œæ¡†ã€æ›´æ˜é¡¯ */
    body { 
      padding: 0; 
      font-family: "Noto Sans TC", sans-serif; 
      background: #f5f7fa; 
      overflow-x: hidden; 
    }
    
    header { background: #0454a3; color: white; padding: 1rem 2rem; text-align: center; font-size: 1.5rem; }

    /* å´é‚Šæ¬„æ¨£å¼ */
    .top-bar-left { position: fixed; top: 1rem; left: 1rem; z-index: 1100; }
    .top-bar-left #menu-btn { width: 30px; height: 22px; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; background: none; border: none; padding: 0; }
    .top-bar-left #menu-btn span { display: block; width: 100%; height: 3px; background-color: white; border-radius: 2px; transition: all 0.3s ease; }
    #side-menu { position: fixed; top: 0; left: 0; height: 100vh; width: 320px; max-width: 80vw; background-color: rgba(10, 10, 10, 0.95); backdrop-filter: blur(6px); box-shadow: 3px 0 12px rgb(0 0 0 / 0.7); padding: 2rem 1.5rem; transform: translateX(-100%); transition: transform 0.3s ease-in-out; z-index: 1200; display: flex; flex-direction: column; align-items: flex-start; color: white; user-select: none; }
    #side-menu.open { transform: translateX(0); }
    #close-btn { position: absolute; top: 2rem; right: 1.6rem; font-size: 2.2rem; background: none; border: none; color: white; cursor: pointer; width: 2.5rem; height: 2.5rem; display: flex; align-items: center; justify-content: center; }
    #side-menu a { color: white; text-decoration: none; font-size: 1.2rem; margin-bottom: 1rem; }
    
    /* æ ¸å¿ƒä¿®æ”¹ï¼šç‚ºå®¹å™¨åŠ ä¸Šå¤–æ¡†ç·šã€åœ“è§’èˆ‡é™°å½± */
    .container { 
      padding: 2.5rem; 
      margin-top: 3rem; 
      margin-bottom: 3rem;
      max-width: 95%; 
      background-color: #ffffff;      /* ç™½è‰²èƒŒæ™¯ */
      border: 1px solid #dee2e6;     /* ç°è‰²ç´°é‚Šæ¡† */
      border-radius: 12px;           /* åœ“è§’ */
      box-shadow: 0 8px 30px rgba(0,0,0,0.05); /* æŸ”å’Œé™°å½± */
    }

    /* è¡¨æ ¼å„ªåŒ– */
    .table-responsive {
      margin-top: 1rem;
    }
    th { font-weight: 600; color: #495057; background-color: #f8f9fa !important; border-top: none; }
    td { vertical-align: middle; } 
    .btn-text { font-size: 0.85rem; padding: 2px 8px; }
  </style>
</head>

<body>
  <header>å…¬å‘Šç®¡ç†</header>
  <div class="top-bar-left">
    <div id="menu-btn" title="é¸å–®"><span></span><span></span><span></span></div>
  </div>

  <nav id="side-menu">
    <h2>åŠŸèƒ½é¸å–®</h2>
    <button id="close-btn">Ã—</button>
    <a href="/assistant_home">é¦–é </a>
    <a href="/announcement/manage_announcements">å…¬å‘Šç®¡ç†</a>
    <a href="/notifications">é€šçŸ¥</a>
    <a href="/login">ç™»å‡º</a>
  </nav>

  <div class="container">
    <div class="mb-4 d-flex justify-content-between align-items-center">
      <h4 class="mb-0" style="color: #333; font-weight: bold;">å…¬å‘Šåˆ—è¡¨</h4>
      <div>
        <button id="btn-new" class="btn btn-primary me-2">â• æ–°å¢å…¬å‘Š</button>
        <button id="btn-new-assignment" class="btn btn-success">ğŸ“ æ–°å¢ä½œæ¥­æˆªæ­¢æ™‚é–“</button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle" id="ann-table">
        <thead class="table-light">
          <tr>
            <th style="width: 25%;">æ¨™é¡Œ</th>
            <th class="text-center">é–‹å§‹æ™‚é–“</th>
            <th class="text-center">çµæŸæ™‚é–“</th>
            <th class="text-center">ç‹€æ…‹</th>
            <th class="text-center">ç™¼å¸ƒç‹€æ…‹</th>
            <th class="text-center">ç™¼å¸ƒæ™‚é–“</th>
            <th class="text-center">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
            </tbody>
      </table>
    </div>
  </div>

  <div class="modal fade" id="annModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">å…¬å‘Šè¨­å®š</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">æ¨™é¡Œ</label>
            <input id="ann-title" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">å…§å®¹</label>
            <textarea id="ann-content" class="form-control" rows="4"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">é–‹å§‹æ™‚é–“</label>
            <input id="ann-start" type="datetime-local" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">çµæŸæ™‚é–“</label>
            <input id="ann-end" type="datetime-local" class="form-control">
          </div>
          <div class="form-check">
            <input id="ann-publish" class="form-check-input" type="checkbox">
            <label class="form-check-label">ç«‹å³ç™¼å¸ƒ</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button id="btn-save" type="button" class="btn btn-primary">å„²å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const tableBody = document.querySelector("#ann-table tbody");
      const annModal = new bootstrap.Modal(document.getElementById("annModal"));
      let editId = null;
      let annList = [];

      document.getElementById("menu-btn").onclick = () => document.getElementById("side-menu").classList.add("open");
      document.getElementById("close-btn").onclick = () => document.getElementById("side-menu").classList.remove("open");

      function formatDateTimeCustom(dateString) {
        if (!dateString || dateString === 'â€”') return 'â€”';
        const nums = dateString.match(/\d+/g);
        if (!nums || nums.length < 3) return dateString;
        const yearIndex = nums.findIndex(n => n.length === 4);
        if (yearIndex === -1) return dateString;
        const Y = nums[yearIndex];
        let M, D, h, m;
        if (yearIndex === 0) {
          M = nums[1]; D = nums[2];
          h = nums[3] || '00'; m = nums[4] || '00';
        } else {
          D = nums[0];
          const monthMap = {'Jan':'01','Feb':'02','Mar':'03','Apr':'04','May':'05','Jun':'06','Jul':'07','Aug':'08','Sep':'09','Oct':'10','Nov':'11','Dec':'12'};
          let foundM = "";
          for(let key in monthMap) if(dateString.includes(key)) foundM = monthMap[key];
          M = foundM || (nums.length > 3 ? nums[1] : '01');
          h = nums[yearIndex + 1] || '00'; m = nums[yearIndex + 2] || '00';
        }
        return `${Y}/${M.toString().padStart(2, '0')}/${D.toString().padStart(2, '0')} ${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
      }

      async function loadAnnouncements() {
        try {
          const res = await fetch(`/announcement/api/list?t=${Date.now()}`);
          const data = await res.json();
          annList = data.data;
          renderTable();
        } catch (e) { console.error("è¼‰å…¥å¤±æ•—", e); }
      }

      function renderTable() {
        const now = new Date();
        tableBody.innerHTML = annList.map(a => {
          const fmtStart = formatDateTimeCustom(a.start_time);
          const fmtEnd = formatDateTimeCustom(a.end_time);
          let status = "æœªç™¼å¸ƒ", color = "secondary";
          if (a.is_published) {
            const start = new Date(fmtStart.replace(/\//g, '-'));
            const end = new Date(fmtEnd.replace(/\//g, '-'));
            if (now < start) status = "æœªé–‹å§‹";
            else if (now > end) { status = "å·²çµæŸ"; color = "danger"; }
            else { status = "é€²è¡Œä¸­"; color = "success"; }
          }
          return `
            <tr>
              <td class="fw-bold">${a.title}</td>
              <td class="text-center">${fmtStart}</td>
              <td class="text-center">${fmtEnd}</td>
              <td class="text-center"><span class="badge bg-${color}">${status}</span></td>
              <td class="text-center">${a.is_published ? 'å·²ç™¼å¸ƒ' : 'æœªç™¼å¸ƒ'}</td>
              <td class="text-center text-muted" style="font-size: 0.9rem;">${formatDateTimeCustom(a.published_at || a.created_at)}</td>
              <td class="text-center">
                <button class="btn btn-sm btn-outline-primary me-1" onclick="editAnnouncement(${a.id})">ç·¨è¼¯</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteAnnouncement(${a.id})">åˆªé™¤</button>
              </td>
            </tr>`;
        }).join('');
      }

      window.editAnnouncement = function(id) {
        const ann = annList.find(item => item.id === id);
        if (!ann) return;
        editId = id;
        document.getElementById("modalTitle").innerText = "ç·¨è¼¯å…¬å‘Š";
        document.getElementById("ann-title").value = ann.title;
        document.getElementById("ann-content").value = ann.content || "";
        const toInputFormat = (str) => {
          if (!str) return "";
          const fmt = formatDateTimeCustom(str);
          return fmt.replace(/\//g, '-').replace(' ', 'T');
        };
        document.getElementById("ann-start").value = toInputFormat(ann.start_time);
        document.getElementById("ann-end").value = toInputFormat(ann.end_time);
        document.getElementById("ann-publish").checked = !!ann.is_published;
        annModal.show();
      };

      window.deleteAnnouncement = async (id) => {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤å…¬å‘Šå—ï¼Ÿ")) return;
        try {
          const res = await fetch(`/announcement/api/delete/${id}`, { method: "DELETE" });
          const result = await res.json();
          if (result.success) {
            alert("åˆªé™¤æˆåŠŸ");
            loadAnnouncements();
          } else {
            alert("åˆªé™¤å¤±æ•—ï¼š" + (result.message || "åŸå› ä¸æ˜"));
          }
        } catch (error) {
          alert("ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
        }
      };

      document.getElementById("btn-save").onclick = async () => {
        const payload = {
          title: document.getElementById("ann-title").value,
          content: document.getElementById("ann-content").value,
          start_time: document.getElementById("ann-start").value.replace('T', ' '),
          end_time: document.getElementById("ann-end").value.replace('T', ' '),
          is_published: document.getElementById("ann-publish").checked ? 1 : 0
        };
        const url = editId ? `/announcement/api/update/${editId}` : `/announcement/api/create`;
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if ((await res.json()).success) { 
          annModal.hide(); 
          loadAnnouncements(); 
        }
      };

      document.getElementById("btn-new").onclick = () => {
        editId = null;
        document.getElementById("modalTitle").innerText = "æ–°å¢å…¬å‘Š";
        document.querySelectorAll('#annModal input:not([type=checkbox]), #annModal textarea').forEach(i => i.value = "");
        document.getElementById("ann-publish").checked = false;
        annModal.show();
      };

      loadAnnouncements();
    });
  </script>
</body>
</html>