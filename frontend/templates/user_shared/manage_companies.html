<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <title>智慧實習平台 | 科助後台</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Noto Sans TC", sans-serif;
      background: #f9fafb;
      margin: 0;
      overflow-x: hidden;
    }

    h2 {
      font-weight: 600;
      color: #333;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 1100;
      background: #0454a3;
      color: white;
      padding: 1rem 2rem;
      text-align: center;
      font-size: 1.5rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
    }

    /* 三條線選單按鈕樣式 */
    .top-bar-left {
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 1300;
    }

    .top-bar-left #menu-btn {
      width: 30px;
      height: 22px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      background: none;
      border: none;
      padding: 0;
    }

    .top-bar-left #menu-btn span {
      display: block;
      width: 100%;
      height: 3px;
      background-color: white;
      border-radius: 2px;
      transition: all 0.3s ease;
    }

    #side-menu {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 320px;
      max-width: 80vw;
      background-color: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(6px);
      box-shadow: 3px 0 12px rgb(0 0 0 / 0.7);
      padding: 2rem 1.5rem;
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
      z-index: 1400;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      color: white;
      user-select: none;
    }

    #side-menu.open {
      transform: translateX(0);
    }

    #side-menu .menu-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      margin-bottom: 1.5rem;
    }

    #side-menu h2 {
      margin: 0;
      font-weight: 700;
      font-size: 1.5rem;
      text-align: left;
      flex: 1;
      color: white;
    }

    #close-btn {
      font-size: 2.2rem;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      line-height: 1;
      width: 2.5rem;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      margin: 0;
    }

    #side-menu a {
      display: block;
      width: 100%;
      padding: 0.5rem 0;
      font-size: 1.1rem;
      color: #ddd;
      text-decoration: none;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }

    #side-menu a:hover {
      background-color: rgba(255, 255, 255, 0.15);
      color: white;
    }

    .main-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 60px;
      margin-top: 2rem;
    }

    /* 表格樣式 - 與圖片格式相同 */
    .table {
      border-collapse: separate;
      border-spacing: 0;
    }

    .table thead th {
      text-align: center;
      background-color: #fafafb;
      font-weight: 600;
      border: 1px solid #dee2e6;
      padding: 0.75rem;
      vertical-align: middle;
    }

    .table tbody td {
      text-align: center;
      vertical-align: middle;
      border: 1px solid #dee2e6;
      padding: 0.75rem;
      background-color: #ffffff;
    }

    .table tbody tr {
      background-color: #ffffff;
    }

    .table tbody tr:hover {
      background-color: rgba(184, 177, 177, 0.03);
    }

    .table tbody tr:hover td {
      background-color: rgba(0, 0, 0, 0.03);
    }

    /* 狀態標籤樣式 */
    .status-badge {
      font-size: 0.9em;
      padding: 0.3em 0.8em;
      border-radius: 0.25rem;
      display: inline-block;
      font-weight: 600;
      border: none;
    }

    /* 已核准狀態使用與 btn-success 完全相同的顏色和樣式 */
    .status-badge.btn-success {
      background-color: #198754;
      border-color: #198754;
      color: #ffffff;
    }
    
    .status-badge.btn-success:hover {
      background-color: #157347;
      border-color: #146c43;
      color: #ffffff;
    }
    
    .status-badge.btn-success:disabled {
      background-color: #198754;
      border-color: #198754;
      color: #ffffff;
      opacity: 1;
    }

    /* 按鈕樣式 */
    .btn-sm {
      padding: 0.25rem 0.75rem;
      font-size: 0.875rem;
    }

  </style>
</head>

<body class="p-0">
  <header>實習廠商管理</header>
  <div class="top-bar-left">
    <div id="menu-btn" title="選單" role="button" tabindex="0">
      <span></span><span></span><span></span>
    </div>
  </div>

  <!-- 側邊選單 -->
  <nav id="side-menu">
    <div class="menu-header">
      <h2>功能選單</h2>
      <button id="close-btn">×</button>
    </div>
    <a href="/ta_home">首頁</a>
    <a href="/profile">個人資料</a>
    <a href="/announcement/manage_announcements">公告管理</a>
    <a href="/ta/statistics/manage_companies">實習廠商管理</a>
    <a href="/final_results">媒合結果確認</a>
    <a href="/notifications">通知</a>
    <a href="/admin/absence_default_range">缺勤預設學期範圍設定</a>
    <a href="/ta/upload_standard_courses">專業核心科目管理</a>
    <a href="/login">登出</a>
  </nav>

  <div class="container-fluid p-0">
    <div class="main-content">
      <div class="p-4">
        <div class="mb-4">
          <div class="d-flex gap-2 justify-content-center">
            <a href="/approve_company" class="btn btn-danger">審核公司</a>
            <a href="/ta/statistics/manage_students" class="btn btn-warning">學生管理</a>
            <a href="/ta/statistics/interview_schedule" class="btn btn-info">面試排程</a>
          </div>
        </div>

        <!-- 已審核公司列表 -->
        <div class="mb-4">
          <div class="card shadow-sm">
            <div class="card-body p-4">
              <h5 class="mb-3 text-center" style="color: #000000; font-weight: bold;">公司管理（<span id="currentSemesterDisplay">載入中...</span>）</h5>
              <div class="table-responsive">
                <table class="table table-bordered align-middle" style="margin-bottom: 0;">
                  <thead>
                    <tr>
                      <th style="text-align: center; background-color: #fafafb; border: 1px solid #dee2e6;">公司名稱</th>
                      <th style="text-align: center; background-color: #fafafb; border: 1px solid #dee2e6;">職缺</th>
                      <th style="text-align: center; background-color: #fafafb; border: 1px solid #dee2e6;">上傳教師</th>
                      <th style="text-align: center; background-color: #fafafb; border: 1px solid #dee2e6;">審核時間</th>
                      <th style="text-align: center; background-color: #fafafb; border: 1px solid #dee2e6;">本學期開放</th>
                      <th style="text-align: center; background-color: #fafafb; border: 1px solid #dee2e6;">狀態</th>
                      <th style="text-align: center; background-color: #fafafb; border: 1px solid #dee2e6;">指導老師</th>
                    </tr>
                  </thead>
                  <tbody id="reviewedCompaniesTableBody">
                    <tr>
                      <td colspan="7" class="text-center text-muted">載入中...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    // 選單開關邏輯
    const menuBtn = document.getElementById("menu-btn");
    const sideMenu = document.getElementById("side-menu");
    const closeBtn = document.getElementById("close-btn");

    menuBtn.addEventListener("click", () => {
      sideMenu.classList.add("open");
      sideMenu.setAttribute("aria-hidden", "false");
    });

    closeBtn.addEventListener("click", () => {
      sideMenu.classList.remove("open");
      sideMenu.setAttribute("aria-hidden", "true");
    });

    // 如果點擊 menu 以外的地方就關閉選單
    document.addEventListener("click", (e) => {
      if (
        !sideMenu.contains(e.target) &&
        !menuBtn.contains(e.target)
      ) {
        sideMenu.classList.remove("open");
        sideMenu.setAttribute("aria-hidden", "true");
      }
    });

    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      return String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    let currentSemesterCode = null;
    let allTeachers = []; // 儲存所有指導老師列表

    // 載入所有指導老師列表
    async function loadAllTeachers() {
      try {
        const res = await fetch('/api/get_all_teachers');
        const data = await res.json();
        if (data.success) {
          allTeachers = data.teachers || [];
        }
      } catch (error) {
        console.error('載入指導老師列表錯誤:', error);
      }
    }

    // 載入已審核公司列表
    async function loadReviewedCompanies() {
      const tbody = document.getElementById('reviewedCompaniesTableBody');
      const semesterDisplay = document.getElementById('currentSemesterDisplay');
      
      tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">載入中...</td></tr>';

      try {
        const res = await fetch('/api/get_reviewed_companies');
        const data = await res.json();

        if (!data.success) {
          tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">載入失敗: ${data.message}</td></tr>`;
          return;
        }

        currentSemesterCode = data.current_semester || '未設定';
        semesterDisplay.textContent = currentSemesterCode || '未設定';

        if (!data.companies || data.companies.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">目前沒有已審核的公司</td></tr>';
          return;
        }

        tbody.innerHTML = data.companies.map(company => {
          // 開放狀態顯示為按鈕樣式（開放中使用與匯出 Excel 相同的 btn-success 類別）
          const openStatusBadge = company.is_open_current_semester
            ? '<button class="btn btn-sm btn-success status-badge" style="cursor: default;" disabled>開放中</button>'
            : '<button class="btn btn-sm btn-secondary status-badge" style="cursor: default;" disabled>未開放</button>';

          const checkboxDisabled = company.status !== 'approved' ? 'disabled' : '';
          const checkboxChecked = company.is_open_current_semester ? 'checked' : '';

          const jobTitles = Array.isArray(company.jobs) ? company.jobs.filter(title => title && String(title).trim()) : [];
          const jobDisplay = jobTitles.length
            ? jobTitles.map(title => escapeHtml(title)).join('<br>')
            : '<span class="text-muted">-</span>';

          // 建立指導老師下拉選單
          // 優先根據 advisor_teacher_name 匹配，如果沒有則根據 advisor_user_id 匹配
          let selectedTeacherId = '';
          if (company.advisor_teacher_name) {
            // 根據 teacher_name 匹配
            const matchedTeacher = allTeachers.find(t => t.name === company.advisor_teacher_name);
            if (matchedTeacher) {
              selectedTeacherId = matchedTeacher.id;
            }
          }
          // 如果根據名稱沒找到，則根據 advisor_user_id 匹配
          if (!selectedTeacherId && company.advisor_user_id) {
            selectedTeacherId = company.advisor_user_id;
          }
          
          let advisorSelect = '<select class="form-select form-select-sm advisor-select" data-company-id="' + company.id + '" data-original-value="' + (selectedTeacherId || '') + '" style="width: 120px; font-size: 0.875rem;">';
          advisorSelect += '<option value="">-- 請選擇 --</option>';
          allTeachers.forEach(teacher => {
            const selected = selectedTeacherId == teacher.id ? 'selected' : '';
            advisorSelect += `<option value="${teacher.id}" ${selected}>${teacher.name}</option>`;
          });
          advisorSelect += '</select>';
          
          // 建立修改按鈕
          const updateBtn = `<button class="btn btn-sm btn-primary advisor-update-btn" data-company-id="${company.id}" style="margin-left: 5px; height: 31px; padding: 0.25rem 0.5rem; font-size: 0.875rem;">修改</button>`;

          return `
            <tr>
              <td>${company.company_name || '-'}</td>
              <td>${jobDisplay}</td>
              <td>${company.upload_teacher_name || '-'}</td>
              <td>${company.reviewed_at || '-'}</td>
              <td>
                <div class="form-check form-switch d-inline-block">
                  <input class="form-check-input company-open-checkbox" 
                         type="checkbox" 
                         data-company-id="${company.id}"
                         ${checkboxChecked}
                         ${checkboxDisabled}
                         style="cursor: pointer;">
                </div>
              </td>
              <td>${openStatusBadge}</td>
              <td>
                <div class="d-flex align-items-center justify-content-center">
                  ${advisorSelect}
                  ${updateBtn}
                </div>
              </td>
            </tr>
          `;
        }).join('');

        // 綁定修改按鈕事件
        document.querySelectorAll('.advisor-update-btn').forEach(btn => {
          btn.addEventListener('click', async function() {
            const companyId = parseInt(this.dataset.companyId);
            const select = document.querySelector(`.advisor-select[data-company-id="${companyId}"]`);
            
            if (!select) {
              alert('找不到對應的下拉選單');
              return;
            }

            const advisorUserId = select.value ? parseInt(select.value) : null;
            const originalValue = select.dataset.originalValue;

            // 檢查是否有變更
            if (select.value === originalValue) {
              alert('沒有變更，無需更新');
              return;
            }

            // 顯示載入狀態
            this.disabled = true;
            select.disabled = true;
            const originalBtnText = this.textContent;
            this.textContent = '更新中...';

            try {
              const res = await fetch('/api/update_company_advisor', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ company_id: companyId, advisor_user_id: advisorUserId })
              });

              const data = await res.json();

              if (!data.success) {
                alert(data.message || '更新失敗');
                select.value = originalValue; // 還原選擇
              } else {
                // 更新成功，更新原始值
                select.dataset.originalValue = select.value;
                alert('指導老師已更新');
              }
            } catch (error) {
              console.error('更新指導老師錯誤:', error);
              alert('更新時發生錯誤，請稍後再試');
              select.value = originalValue; // 還原選擇
            } finally {
              this.disabled = false;
              select.disabled = false;
              this.textContent = originalBtnText;
            }
          });
        });

        // 綁定勾選框事件
        document.querySelectorAll('.company-open-checkbox').forEach(checkbox => {
          checkbox.addEventListener('change', async function() {
            const companyId = parseInt(this.dataset.companyId);
            const isOpen = this.checked;

            // 顯示載入狀態
            this.disabled = true;
            const originalChecked = this.checked;

            try {
              const res = await fetch('/api/set_company_open_status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ company_id: companyId, is_open: isOpen })
              });

              const data = await res.json();

              if (!data.success) {
                alert(data.message || '設定失敗');
                this.checked = !originalChecked; // 還原勾選狀態
              } else {
                // 更新狀態標籤（開放中使用與匯出 Excel 相同的 btn-success 類別）
                const row = this.closest('tr');
                // 狀態列是倒數第二列（倒數第一列是指導老師）
                const statusCell = row.querySelector('td:nth-last-child(2)');
                statusCell.innerHTML = isOpen
                  ? '<button class="btn btn-sm btn-success status-badge" style="cursor: default;" disabled>開放中</button>'
                  : '<button class="btn btn-sm btn-secondary status-badge" style="cursor: default;" disabled>未開放</button>';
              }
            } catch (error) {
              console.error('設定公司開放狀態錯誤:', error);
              alert('設定時發生錯誤，請稍後再試');
              this.checked = !originalChecked; // 還原勾選狀態
            } finally {
              this.disabled = false;
            }
          });
        });

      } catch (error) {
        console.error('載入已審核公司列表錯誤:', error);
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">載入時發生錯誤</td></tr>';
      }
    }

    // 初始載入
    loadAllTeachers().then(() => {
      loadReviewedCompanies(); // 載入已審核公司列表
    });
  </script>
</body>

</html>