<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <title>æ™ºæ…§å¯¦ç¿’å¹³å° | ç§‘åŠ©å¾Œå°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
      background: #f9fafb;
    }

    .chart-container {
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 24px;
    }
    
    .chart-container h5 {
      font-size: 1rem;
      margin-bottom: 12px;
    }
    
    .chart-container canvas {
      max-height: 250px;
    }

    h2 {
      font-weight: 600;
      color: #333;
    }

    .sidebar {
      min-height: 100vh;
      background: #f1f3f5;
      padding: 24px;
    }

    .sidebar h4 {
      margin-bottom: 20px;
    }

    .sidebar a {
      display: block;
      padding: 6px 0;
      color: #495057;
      text-decoration: none;
    }

    .sidebar a:hover {
      color: #0d6efd;
    }

    .main-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 60px;
    }

    .page-banner {
      background: #0066cc;
      color: #fff;
      padding: 1rem 2rem;
      margin-bottom: 0;
      width: 100%;
    }

    .page-banner h2 {
      color: #fff;
      font-weight: 600;
      margin: 0;
      text-align: center;
      font-size: 1.5rem;
    }

  </style>
</head>

<body class="p-0">
  <div class="container-fluid p-0">
    <div class="page-banner">
      <div class="main-content">
        <h2>å¯¦ç¿’å…¬å¸è³‡æ–™ç¸½è¦½</h2>
      </div>
    </div>
    <div class="main-content">
      <div class="p-4">
        <div class="mb-4">
          <div class="d-flex gap-2 justify-content-center">
            <button class="btn btn-primary" id="refreshBtn">åˆ·æ–°çµ±è¨ˆ</button>
            <button class="btn btn-success" id="exportBtn">åŒ¯å‡º Excel</button>
            <a href="/approve_company" class="btn btn-danger">å¯©æ ¸å…¬å¸</a>
            <a href="/ta/statistics/manage_students" class="btn btn-warning">å­¸ç”Ÿç®¡ç†</a>
          </div>
        </div>
        <div class="row g-4">
          <div class="col-lg-4">
            <div class="chart-container">
              <h5 class="text-center">ğŸ¢ å„å…¬å¸è¢«é¸å¿—é¡˜æ¬¡æ•¸</h5>
              <canvas id="companyChart"></canvas>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="chart-container">
              <h5 class="text-center">ğŸ“„ å±¥æ­·ç¹³äº¤ç‡</h5>
              <canvas id="resumeChart"></canvas>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="chart-container">
              <h5 class="text-center">ğŸ¯ å¿—é¡˜åºå¡«å¯«ç‡</h5>
              <canvas id="preferenceChart"></canvas>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    let companyChart, resumeChart, preferenceChart;

    // è¼‰å…¥çµ±è¨ˆè³‡æ–™ (åŸæœ‰çš„ä¸‰å€‹åœ–è¡¨)
    async function loadData(classId = "all") {
      let url = "/ta/statistics/api/manage_companies_stats"; 
      if (classId !== "all") url += `?class_id=${classId}`;

      const res = await fetch(url);
      const data = await res.json();

      if (!data.success) {
        alert("è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—ï¼š" + data.message);
        return;
      }

      // å…¬å¸å¿—é¡˜å‰äº”å
      const companies = data.top_companies.map(c => c.company_name);
      const counts = data.top_companies.map(c => c.preference_count);

      if (companyChart) companyChart.destroy();
      companyChart = new Chart(document.getElementById("companyChart"), {
        type: "bar",
        data: {
          labels: companies,
          datasets: [{ label: "å¿—é¡˜æ¬¡æ•¸", data: counts, backgroundColor: "#4e79a7" }]
        },
        options: { scales: { y: { beginAtZero: true } } }
      });

      const resumeData = [data.resume_stats.uploaded, data.resume_stats.not_uploaded];
      const resumeTotal = resumeData.reduce((a, b) => a + b, 0);

      if (resumeChart) resumeChart.destroy();
      resumeChart = new Chart(document.getElementById("resumeChart"), {
        type: "doughnut",
        data: {
          labels: ["å·²ä¸Šå‚³", "æœªä¸Šå‚³"],
          datasets: [{ data: resumeData, backgroundColor: ["#59a14f", "#e15759"] }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const value = context.raw;
                  const percent = ((value / resumeTotal) * 100).toFixed(1) + '%';
                  return `${context.label}: ${value} (${percent})`;
                }
              }
            }
          }
        }
      });

      const prefData = [data.preference_stats.filled, data.preference_stats.not_filled];
      const prefTotal = prefData.reduce((a, b) => a + b, 0);

      if (preferenceChart) preferenceChart.destroy();
      preferenceChart = new Chart(document.getElementById("preferenceChart"), {
        type: "doughnut",
        data: {
          labels: ["å·²å¡«å¯«", "æœªå¡«å¯«"],
          datasets: [{ data: prefData, backgroundColor: ["#edc948", "#bab0ab"] }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const value = context.raw;
                  const percent = ((value / prefTotal) * 100).toFixed(1) + '%';
                  return `${context.label}: ${value} (${percent})`;
                }
              }
            }
          }
        }
      });
    }

    // åˆ·æ–°çµ±è¨ˆ (é¡¯ç¤ºæ‰€æœ‰ç­ç´šçš„çµ±è¨ˆ)
    document.getElementById("refreshBtn").addEventListener("click", () => {
      loadData("all"); // è¼‰å…¥æ‰€æœ‰ç­ç´šçš„çµ±è¨ˆ
    });

    // åŒ¯å‡º Excel (æ‰€æœ‰ç­ç´š)
    document.getElementById("exportBtn").addEventListener("click", () => {
      window.location.href = `/ta/statistics/api/export_companies_stats`; // åŒ¯å‡ºæ‰€æœ‰ç­ç´šçš„çµ±è¨ˆ
    });


    // åˆå§‹è¼‰å…¥
    loadData("all"); // è¼‰å…¥æ‰€æœ‰ç­ç´šçš„çµ±è¨ˆ
  </script>
</body>

</html>