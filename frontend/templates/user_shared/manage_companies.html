<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <title>æ™ºæ…§å¯¦ç¿’å¹³å° | ç§‘åŠ©å¾Œå°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
      background: #f9fafb;
    }

    .chart-container {
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 24px;
    }
    
    .chart-container h5 {
      font-size: 1rem;
      margin-bottom: 12px;
    }
    
    .chart-container canvas {
      max-height: 250px;
    }

    h2 {
      font-weight: 600;
      color: #333;
    }

    .sidebar {
      min-height: 100vh;
      background: #f1f3f5;
      padding: 24px;
    }

    .sidebar h4 {
      margin-bottom: 20px;
    }

    .sidebar a {
      display: block;
      padding: 6px 0;
      color: #495057;
      text-decoration: none;
    }

    .sidebar a:hover {
      color: #0d6efd;
    }

    .main-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 60px;
    }

    .page-banner {
      background: #0066cc;
      color: #fff;
      padding: 1rem 2rem;
      margin-bottom: 0;
      width: 100%;
    }

    .page-banner h2 {
      color: #fff;
      font-weight: 600;
      margin: 0;
      text-align: center;
      font-size: 1.5rem;
    }

    /* è¡¨æ ¼æ¨£å¼ - èˆ‡åœ–ç‰‡æ ¼å¼ç›¸åŒ */
    .table {
      border-collapse: separate;
      border-spacing: 0;
    }

    .table thead th {
      text-align: center;
      background-color: #fafafb;
      font-weight: 600;
      border: 1px solid #dee2e6;
      padding: 0.75rem;
      vertical-align: middle;
    }

    .table tbody td {
      text-align: center;
      vertical-align: middle;
      border: 1px solid #dee2e6;
      padding: 0.75rem;
      background-color: #ffffff;
    }

    .table tbody tr {
      background-color: #ffffff;
    }

    .table tbody tr:hover {
      background-color: rgba(0, 0, 0, 0.03);
    }

    .table tbody tr:hover td {
      background-color: rgba(0, 0, 0, 0.03);
    }

    /* ç‹€æ…‹æ¨™ç±¤æ¨£å¼ */
    .status-badge {
      font-size: 0.9em;
      padding: 0.3em 0.8em;
      border-radius: 0.25rem;
      display: inline-block;
      font-weight: 600;
      border: none;
    }

    /* å·²æ ¸å‡†ç‹€æ…‹ä½¿ç”¨èˆ‡ btn-success å®Œå…¨ç›¸åŒçš„é¡è‰²å’Œæ¨£å¼ */
    .status-badge.btn-success {
      background-color: #198754;
      border-color: #198754;
      color: #ffffff;
    }
    
    .status-badge.btn-success:hover {
      background-color: #157347;
      border-color: #146c43;
      color: #ffffff;
    }
    
    .status-badge.btn-success:disabled {
      background-color: #198754;
      border-color: #198754;
      color: #ffffff;
      opacity: 1;
    }

    /* æŒ‰éˆ•æ¨£å¼ */
    .btn-sm {
      padding: 0.25rem 0.75rem;
      font-size: 0.875rem;
    }

  </style>
</head>

<body class="p-0">
  <div class="container-fluid p-0">
    <div class="page-banner">
      <div class="main-content">
        <h2>å¯¦ç¿’å» å•†ç®¡ç†</h2>
      </div>
    </div>
    <div class="main-content">
      <div class="p-4">
        <div class="mb-4">
          <div class="d-flex gap-2 justify-content-center">
            <button class="btn btn-primary" id="refreshBtn">åˆ·æ–°çµ±è¨ˆ</button>
            <button class="btn btn-success" id="exportBtn">åŒ¯å‡º Excel</button>
            <a href="/approve_company" class="btn btn-danger">å¯©æ ¸å…¬å¸</a>
            <a href="/ta/statistics/manage_students" class="btn btn-warning">å­¸ç”Ÿç®¡ç†</a>
          </div>
        </div>

        <!-- å·²å¯©æ ¸å…¬å¸åˆ—è¡¨ -->
        <div class="mb-4">
          <div class="card shadow-sm">
            <div class="card-body p-4">
              <h5 class="mb-3 text-center" style="color: #000000; font-weight: bold;">å…¬å¸ç®¡ç†ï¼ˆ<span id="currentSemesterDisplay">è¼‰å…¥ä¸­...</span>ï¼‰</h5>
              <div class="table-responsive">
                <table class="table table-bordered align-middle" style="margin-bottom: 0;">
                  <thead>
                    <tr>
                      <th style="text-align: center; background-color: #fafafb; border: 1px solid #dee2e6;">å…¬å¸åç¨±</th>
                      <th style="text-align: center; background-color: #fafafb; border: 1px solid #dee2e6;">ä¸Šå‚³æ•™å¸«</th>
                      <th style="text-align: center; background-color: #fafafb; border: 1px solid #dee2e6;">å¯©æ ¸ç‹€æ…‹</th>
                      <th style="text-align: center; background-color: #fafafb; border: 1px solid #dee2e6;">å¯©æ ¸æ™‚é–“</th>
                      <th style="text-align: center; background-color: #fafafb; border: 1px solid #dee2e6;">æœ¬å­¸æœŸé–‹æ”¾</th>
                      <th style="text-align: center; background-color: #fafafb; border: 1px solid #dee2e6;">ç‹€æ…‹</th>
                    </tr>
                  </thead>
                  <tbody id="reviewedCompaniesTableBody">
                    <tr>
                      <td colspan="6" class="text-center text-muted">è¼‰å…¥ä¸­...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-4">
          <div class="col-lg-4">
            <div class="chart-container">
              <h5 class="text-center">ğŸ¢ å„å…¬å¸è¢«é¸å¿—é¡˜æ¬¡æ•¸</h5>
              <canvas id="companyChart"></canvas>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="chart-container">
              <h5 class="text-center">ğŸ“„ å±¥æ­·ç¹³äº¤ç‡</h5>
              <canvas id="resumeChart"></canvas>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="chart-container">
              <h5 class="text-center">ğŸ¯ å¿—é¡˜åºå¡«å¯«ç‡</h5>
              <canvas id="preferenceChart"></canvas>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    let companyChart, resumeChart, preferenceChart;
    let currentSemesterCode = null;

    // è¼‰å…¥å·²å¯©æ ¸å…¬å¸åˆ—è¡¨
    async function loadReviewedCompanies() {
      const tbody = document.getElementById('reviewedCompaniesTableBody');
      const semesterDisplay = document.getElementById('currentSemesterDisplay');
      
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">è¼‰å…¥ä¸­...</td></tr>';

      try {
        const res = await fetch('/api/get_reviewed_companies');
        const data = await res.json();

        if (!data.success) {
          tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">è¼‰å…¥å¤±æ•—: ${data.message}</td></tr>`;
          return;
        }

        currentSemesterCode = data.current_semester || 'æœªè¨­å®š';
        semesterDisplay.textContent = currentSemesterCode || 'æœªè¨­å®š';

        if (!data.companies || data.companies.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">ç›®å‰æ²’æœ‰å·²å¯©æ ¸çš„å…¬å¸</td></tr>';
          return;
        }

        tbody.innerHTML = data.companies.map(company => {
          // å¯©æ ¸ç‹€æ…‹é¡¯ç¤ºç‚ºæŒ‰éˆ•æ¨£å¼ï¼ˆå·²æ ¸å‡†ä½¿ç”¨èˆ‡åŒ¯å‡º Excel ç›¸åŒçš„ btn-success é¡åˆ¥ï¼‰
          const statusBadge = company.status === 'approved' 
            ? '<button class="btn btn-sm btn-success status-badge" style="cursor: default;" disabled>å·²æ ¸å‡†</button>'
            : '<button class="btn btn-sm btn-danger status-badge" style="cursor: default;" disabled>å·²é€€å›</button>';
          
          // é–‹æ”¾ç‹€æ…‹é¡¯ç¤ºç‚ºæŒ‰éˆ•æ¨£å¼ï¼ˆé–‹æ”¾ä¸­ä½¿ç”¨èˆ‡åŒ¯å‡º Excel ç›¸åŒçš„ btn-success é¡åˆ¥ï¼‰
          const openStatusBadge = company.is_open_current_semester
            ? '<button class="btn btn-sm btn-success status-badge" style="cursor: default;" disabled>é–‹æ”¾ä¸­</button>'
            : '<button class="btn btn-sm btn-secondary status-badge" style="cursor: default;" disabled>æœªé–‹æ”¾</button>';

          const checkboxDisabled = company.status !== 'approved' ? 'disabled' : '';
          const checkboxChecked = company.is_open_current_semester ? 'checked' : '';

          return `
            <tr>
              <td>${company.company_name || '-'}</td>
              <td>${company.upload_teacher_name || '-'}</td>
              <td>${statusBadge}</td>
              <td>${company.reviewed_at || '-'}</td>
              <td>
                <div class="form-check form-switch d-inline-block">
                  <input class="form-check-input company-open-checkbox" 
                         type="checkbox" 
                         data-company-id="${company.id}"
                         ${checkboxChecked}
                         ${checkboxDisabled}
                         style="cursor: pointer;">
                </div>
              </td>
              <td>${openStatusBadge}</td>
            </tr>
          `;
        }).join('');

        // ç¶å®šå‹¾é¸æ¡†äº‹ä»¶
        document.querySelectorAll('.company-open-checkbox').forEach(checkbox => {
          checkbox.addEventListener('change', async function() {
            const companyId = parseInt(this.dataset.companyId);
            const isOpen = this.checked;

            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            this.disabled = true;
            const originalChecked = this.checked;

            try {
              const res = await fetch('/api/set_company_open_status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ company_id: companyId, is_open: isOpen })
              });

              const data = await res.json();

              if (!data.success) {
                alert(data.message || 'è¨­å®šå¤±æ•—');
                this.checked = !originalChecked; // é‚„åŸå‹¾é¸ç‹€æ…‹
              } else {
                // æ›´æ–°ç‹€æ…‹æ¨™ç±¤ï¼ˆé–‹æ”¾ä¸­ä½¿ç”¨èˆ‡åŒ¯å‡º Excel ç›¸åŒçš„ btn-success é¡åˆ¥ï¼‰
                const row = this.closest('tr');
                const statusCell = row.querySelector('td:last-child');
                statusCell.innerHTML = isOpen
                  ? '<button class="btn btn-sm btn-success status-badge" style="cursor: default;" disabled>é–‹æ”¾ä¸­</button>'
                  : '<button class="btn btn-sm btn-secondary status-badge" style="cursor: default;" disabled>æœªé–‹æ”¾</button>';
              }
            } catch (error) {
              console.error('è¨­å®šå…¬å¸é–‹æ”¾ç‹€æ…‹éŒ¯èª¤:', error);
              alert('è¨­å®šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
              this.checked = !originalChecked; // é‚„åŸå‹¾é¸ç‹€æ…‹
            } finally {
              this.disabled = false;
            }
          });
        });

      } catch (error) {
        console.error('è¼‰å…¥å·²å¯©æ ¸å…¬å¸åˆ—è¡¨éŒ¯èª¤:', error);
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">è¼‰å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤</td></tr>';
      }
    }

    // è¼‰å…¥çµ±è¨ˆè³‡æ–™ (åŸæœ‰çš„ä¸‰å€‹åœ–è¡¨)
    async function loadData(classId = "all") {
      let url = "/ta/statistics/api/manage_companies_stats"; 
      if (classId !== "all") url += `?class_id=${classId}`;

      const res = await fetch(url);
      const data = await res.json();

      if (!data.success) {
        alert("è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—ï¼š" + data.message);
        return;
      }

      // å…¬å¸å¿—é¡˜å‰äº”å
      const companies = data.top_companies.map(c => c.company_name);
      const counts = data.top_companies.map(c => c.preference_count);

      if (companyChart) companyChart.destroy();
      companyChart = new Chart(document.getElementById("companyChart"), {
        type: "bar",
        data: {
          labels: companies,
          datasets: [{ label: "å¿—é¡˜æ¬¡æ•¸", data: counts, backgroundColor: "#4e79a7" }]
        },
        options: { scales: { y: { beginAtZero: true } } }
      });

      const resumeData = [data.resume_stats.uploaded, data.resume_stats.not_uploaded];
      const resumeTotal = resumeData.reduce((a, b) => a + b, 0);

      if (resumeChart) resumeChart.destroy();
      resumeChart = new Chart(document.getElementById("resumeChart"), {
        type: "doughnut",
        data: {
          labels: ["å·²ä¸Šå‚³", "æœªä¸Šå‚³"],
          datasets: [{ data: resumeData, backgroundColor: ["#59a14f", "#e15759"] }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const value = context.raw;
                  const percent = ((value / resumeTotal) * 100).toFixed(1) + '%';
                  return `${context.label}: ${value} (${percent})`;
                }
              }
            }
          }
        }
      });

      const prefData = [data.preference_stats.filled, data.preference_stats.not_filled];
      const prefTotal = prefData.reduce((a, b) => a + b, 0);

      if (preferenceChart) preferenceChart.destroy();
      preferenceChart = new Chart(document.getElementById("preferenceChart"), {
        type: "doughnut",
        data: {
          labels: ["å·²å¡«å¯«", "æœªå¡«å¯«"],
          datasets: [{ data: prefData, backgroundColor: ["#edc948", "#bab0ab"] }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const value = context.raw;
                  const percent = ((value / prefTotal) * 100).toFixed(1) + '%';
                  return `${context.label}: ${value} (${percent})`;
                }
              }
            }
          }
        }
      });
    }

    // åˆ·æ–°çµ±è¨ˆ (é¡¯ç¤ºæ‰€æœ‰ç­ç´šçš„çµ±è¨ˆ)
    document.getElementById("refreshBtn").addEventListener("click", () => {
      loadData("all"); // è¼‰å…¥æ‰€æœ‰ç­ç´šçš„çµ±è¨ˆ
    });

    // åŒ¯å‡º Excel (æ‰€æœ‰ç­ç´š)
    document.getElementById("exportBtn").addEventListener("click", () => {
      window.location.href = `/ta/statistics/api/export_companies_stats`; // åŒ¯å‡ºæ‰€æœ‰ç­ç´šçš„çµ±è¨ˆ
    });


    // åˆå§‹è¼‰å…¥
    loadData("all"); // è¼‰å…¥æ‰€æœ‰ç­ç´šçš„çµ±è¨ˆ
    loadReviewedCompanies(); // è¼‰å…¥å·²å¯©æ ¸å…¬å¸åˆ—è¡¨
  </script>
</body>

</html>