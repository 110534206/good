<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <title>智慧實習平台 | 科助後台</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
      background: #f9fafb;
    }

    h2 {
      font-weight: 600;
      color: #333;
    }

    .sidebar {
      min-height: 100vh;
      background: #f1f3f5;
      padding: 24px;
    }

    .sidebar h4 {
      margin-bottom: 20px;
    }

    .sidebar a {
      display: block;
      padding: 6px 0;
      color: #495057;
      text-decoration: none;
    }

    .sidebar a:hover {
      color: #0d6efd;
    }

    .main-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 60px;
    }

    .page-banner {
      background: #0066cc;
      color: #fff;
      padding: 1rem 2rem;
      margin-bottom: 0;
      width: 100%;
    }

    .page-banner h2 {
      color: #fff;
      font-weight: 600;
      margin: 0;
      font-size: 1.5rem;
    }

    .page-banner .main-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .page-banner .main-content > div {
      flex: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .page-banner .main-content h2 {
      flex: 1;
      text-align: center;
    }

    /* 表格樣式 - 與圖片格式相同 */
    .table {
      border-collapse: separate;
      border-spacing: 0;
    }

    .table thead th {
      text-align: center;
      background-color: #fafafb;
      font-weight: 600;
      border: 1px solid #dee2e6;
      padding: 0.75rem;
      vertical-align: middle;
    }

    .table tbody td {
      text-align: center;
      vertical-align: middle;
      border: 1px solid #dee2e6;
      padding: 0.75rem;
      background-color: #ffffff;
    }

    .table tbody tr {
      background-color: #ffffff;
    }

    .table tbody tr:hover {
      background-color: rgba(0, 0, 0, 0.03);
    }

    .table tbody tr:hover td {
      background-color: rgba(0, 0, 0, 0.03);
    }

    /* 狀態標籤樣式 */
    .status-badge {
      font-size: 0.9em;
      padding: 0.3em 0.8em;
      border-radius: 0.25rem;
      display: inline-block;
      font-weight: 600;
      border: none;
    }

    /* 已核准狀態使用與 btn-success 完全相同的顏色和樣式 */
    .status-badge.btn-success {
      background-color: #198754;
      border-color: #198754;
      color: #ffffff;
    }
    
    .status-badge.btn-success:hover {
      background-color: #157347;
      border-color: #146c43;
      color: #ffffff;
    }
    
    .status-badge.btn-success:disabled {
      background-color: #198754;
      border-color: #198754;
      color: #ffffff;
      opacity: 1;
    }

    /* 按鈕樣式 */
    .btn-sm {
      padding: 0.25rem 0.75rem;
      font-size: 0.875rem;
    }

  </style>
</head>

<body class="p-0">
  <div class="container-fluid p-0">
    <div class="page-banner">
      <div class="main-content">
        <div class="d-flex justify-content-between align-items-center">
          <h2 class="mb-0">實習廠商管理</h2>
          <a href="/ta_home" class="btn btn-outline-light" style="font-size: 1rem; padding: 0.5rem 1rem;">返回首頁</a>
        </div>
      </div>
    </div>
    <div class="main-content">
      <div class="p-4">
        <div class="mb-4">
          <div class="d-flex gap-2 justify-content-center">
            <a href="/approve_company" class="btn btn-danger">審核公司</a>
            <a href="/ta/statistics/manage_students" class="btn btn-warning">學生管理</a>
          </div>
        </div>

        <!-- 已審核公司列表 -->
        <div class="mb-4">
          <div class="card shadow-sm">
            <div class="card-body p-4">
              <h5 class="mb-3 text-center" style="color: #000000; font-weight: bold;">公司管理（<span id="currentSemesterDisplay">載入中...</span>）</h5>
              <div class="table-responsive">
                <table class="table table-bordered align-middle" style="margin-bottom: 0;">
                  <thead>
                    <tr>
                      <th style="text-align: center; background-color: #fafafb; border: 1px solid #dee2e6;">公司名稱</th>
                      <th style="text-align: center; background-color: #fafafb; border: 1px solid #dee2e6;">上傳教師</th>
                      <th style="text-align: center; background-color: #fafafb; border: 1px solid #dee2e6;">審核狀態</th>
                      <th style="text-align: center; background-color: #fafafb; border: 1px solid #dee2e6;">審核時間</th>
                      <th style="text-align: center; background-color: #fafafb; border: 1px solid #dee2e6;">本學期開放</th>
                      <th style="text-align: center; background-color: #fafafb; border: 1px solid #dee2e6;">狀態</th>
                      <th style="text-align: center; background-color: #fafafb; border: 1px solid #dee2e6;">指導老師</th>
                    </tr>
                  </thead>
                  <tbody id="reviewedCompaniesTableBody">
                    <tr>
                      <td colspan="7" class="text-center text-muted">載入中...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    let currentSemesterCode = null;
    let allTeachers = []; // 儲存所有指導老師列表

    // 載入所有指導老師列表
    async function loadAllTeachers() {
      try {
        const res = await fetch('/api/get_all_teachers');
        const data = await res.json();
        if (data.success) {
          allTeachers = data.teachers || [];
        }
      } catch (error) {
        console.error('載入指導老師列表錯誤:', error);
      }
    }

    // 載入已審核公司列表
    async function loadReviewedCompanies() {
      const tbody = document.getElementById('reviewedCompaniesTableBody');
      const semesterDisplay = document.getElementById('currentSemesterDisplay');
      
      tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">載入中...</td></tr>';

      try {
        const res = await fetch('/api/get_reviewed_companies');
        const data = await res.json();

        if (!data.success) {
          tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">載入失敗: ${data.message}</td></tr>`;
          return;
        }

        currentSemesterCode = data.current_semester || '未設定';
        semesterDisplay.textContent = currentSemesterCode || '未設定';

        if (!data.companies || data.companies.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">目前沒有已審核的公司</td></tr>';
          return;
        }

        tbody.innerHTML = data.companies.map(company => {
          // 審核狀態顯示為按鈕樣式（已核准使用與匯出 Excel 相同的 btn-success 類別）
          // 明確檢查 status 值，確保 'rejected' 狀態正確顯示
          let statusBadge;
          if (company.status === 'approved') {
            statusBadge = '<button class="btn btn-sm btn-success status-badge" style="cursor: default;" disabled>已核准</button>';
          } else if (company.status === 'rejected') {
            statusBadge = '<button class="btn btn-sm btn-danger status-badge" style="cursor: default;" disabled>已退回</button>';
          } else {
            // 處理其他未知狀態
            statusBadge = `<button class="btn btn-sm btn-secondary status-badge" style="cursor: default;" disabled>${company.status || '未知'}</button>`;
          }
          
          // 開放狀態顯示為按鈕樣式（開放中使用與匯出 Excel 相同的 btn-success 類別）
          const openStatusBadge = company.is_open_current_semester
            ? '<button class="btn btn-sm btn-success status-badge" style="cursor: default;" disabled>開放中</button>'
            : '<button class="btn btn-sm btn-secondary status-badge" style="cursor: default;" disabled>未開放</button>';

          const checkboxDisabled = company.status !== 'approved' ? 'disabled' : '';
          const checkboxChecked = company.is_open_current_semester ? 'checked' : '';

          // 建立指導老師下拉選單
          // 優先根據 advisor_teacher_name 匹配，如果沒有則根據 advisor_user_id 匹配
          let selectedTeacherId = '';
          if (company.advisor_teacher_name) {
            // 根據 teacher_name 匹配
            const matchedTeacher = allTeachers.find(t => t.name === company.advisor_teacher_name);
            if (matchedTeacher) {
              selectedTeacherId = matchedTeacher.id;
            }
          }
          // 如果根據名稱沒找到，則根據 advisor_user_id 匹配
          if (!selectedTeacherId && company.advisor_user_id) {
            selectedTeacherId = company.advisor_user_id;
          }
          
          let advisorSelect = '<select class="form-select form-select-sm advisor-select" data-company-id="' + company.id + '" data-original-value="' + (selectedTeacherId || '') + '" style="width: 120px; font-size: 0.875rem;">';
          advisorSelect += '<option value="">-- 請選擇 --</option>';
          allTeachers.forEach(teacher => {
            const selected = selectedTeacherId == teacher.id ? 'selected' : '';
            advisorSelect += `<option value="${teacher.id}" ${selected}>${teacher.name}</option>`;
          });
          advisorSelect += '</select>';
          
          // 建立修改按鈕
          const updateBtn = `<button class="btn btn-sm btn-primary advisor-update-btn" data-company-id="${company.id}" style="margin-left: 5px; height: 31px; padding: 0.25rem 0.5rem; font-size: 0.875rem;">修改</button>`;

          return `
            <tr>
              <td>${company.company_name || '-'}</td>
              <td>${company.upload_teacher_name || '-'}</td>
              <td>${statusBadge}</td>
              <td>${company.reviewed_at || '-'}</td>
              <td>
                <div class="form-check form-switch d-inline-block">
                  <input class="form-check-input company-open-checkbox" 
                         type="checkbox" 
                         data-company-id="${company.id}"
                         ${checkboxChecked}
                         ${checkboxDisabled}
                         style="cursor: pointer;">
                </div>
              </td>
              <td>${openStatusBadge}</td>
              <td>
                <div class="d-flex align-items-center justify-content-center">
                  ${advisorSelect}
                  ${updateBtn}
                </div>
              </td>
            </tr>
          `;
        }).join('');

        // 綁定修改按鈕事件
        document.querySelectorAll('.advisor-update-btn').forEach(btn => {
          btn.addEventListener('click', async function() {
            const companyId = parseInt(this.dataset.companyId);
            const select = document.querySelector(`.advisor-select[data-company-id="${companyId}"]`);
            
            if (!select) {
              alert('找不到對應的下拉選單');
              return;
            }

            const advisorUserId = select.value ? parseInt(select.value) : null;
            const originalValue = select.dataset.originalValue;

            // 檢查是否有變更
            if (select.value === originalValue) {
              alert('沒有變更，無需更新');
              return;
            }

            // 顯示載入狀態
            this.disabled = true;
            select.disabled = true;
            const originalBtnText = this.textContent;
            this.textContent = '更新中...';

            try {
              const res = await fetch('/api/update_company_advisor', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ company_id: companyId, advisor_user_id: advisorUserId })
              });

              const data = await res.json();

              if (!data.success) {
                alert(data.message || '更新失敗');
                select.value = originalValue; // 還原選擇
              } else {
                // 更新成功，更新原始值
                select.dataset.originalValue = select.value;
                alert('指導老師已更新');
              }
            } catch (error) {
              console.error('更新指導老師錯誤:', error);
              alert('更新時發生錯誤，請稍後再試');
              select.value = originalValue; // 還原選擇
            } finally {
              this.disabled = false;
              select.disabled = false;
              this.textContent = originalBtnText;
            }
          });
        });

        // 綁定勾選框事件
        document.querySelectorAll('.company-open-checkbox').forEach(checkbox => {
          checkbox.addEventListener('change', async function() {
            const companyId = parseInt(this.dataset.companyId);
            const isOpen = this.checked;

            // 顯示載入狀態
            this.disabled = true;
            const originalChecked = this.checked;

            try {
              const res = await fetch('/api/set_company_open_status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ company_id: companyId, is_open: isOpen })
              });

              const data = await res.json();

              if (!data.success) {
                alert(data.message || '設定失敗');
                this.checked = !originalChecked; // 還原勾選狀態
              } else {
                // 更新狀態標籤（開放中使用與匯出 Excel 相同的 btn-success 類別）
                const row = this.closest('tr');
                // 狀態列是倒數第二列（倒數第一列是指導老師）
                const statusCell = row.querySelector('td:nth-last-child(2)');
                statusCell.innerHTML = isOpen
                  ? '<button class="btn btn-sm btn-success status-badge" style="cursor: default;" disabled>開放中</button>'
                  : '<button class="btn btn-sm btn-secondary status-badge" style="cursor: default;" disabled>未開放</button>';
              }
            } catch (error) {
              console.error('設定公司開放狀態錯誤:', error);
              alert('設定時發生錯誤，請稍後再試');
              this.checked = !originalChecked; // 還原勾選狀態
            } finally {
              this.disabled = false;
            }
          });
        });

      } catch (error) {
        console.error('載入已審核公司列表錯誤:', error);
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">載入時發生錯誤</td></tr>';
      }
    }

    // 初始載入
    loadAllTeachers().then(() => {
      loadReviewedCompanies(); // 載入已審核公司列表
    });
  </script>
</body>

</html>