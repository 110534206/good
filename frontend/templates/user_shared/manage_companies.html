<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <title>æ™ºæ…§å¯¦ç¿’å¹³å° | ç§‘åŠ©å¾Œå°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
      background: #f9fafb;
    }

    .chart-container {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 24px;
    }

    h2 {
      font-weight: 600;
      color: #333;
    }

    .sidebar {
      min-height: 100vh;
      background: #f1f3f5;
      padding: 24px;
    }

    .sidebar h4 {
      margin-bottom: 20px;
    }

    .sidebar a {
      display: block;
      padding: 6px 0;
      color: #495057;
      text-decoration: none;
    }

    .sidebar a:hover {
      color: #0d6efd;
    }

    #studentsContainer {
      margin-top: 24px;
    }
  </style>
</head>

<body class="p-0">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-3 sidebar">
        <h4>ğŸ›  å¾Œå°è¨­å®š</h4>
        <div class="mb-3">
          <label for="classSelect" class="form-label">é¸æ“‡ç­ç´š</label>
          <select id="classSelect" class="form-select">
            <option value="all">æ‰€æœ‰ç­ç´š</option>
          </select>
        </div>
        <div class="mb-3">
          <button class="btn btn-primary w-100 mb-2" id="refreshBtn">åˆ·æ–°çµ±è¨ˆ</button>
          <button class="btn btn-success w-100 mb-2" id="exportBtn">åŒ¯å‡º Excel</button>
          <button class="btn btn-info w-100" id="manageStudentsBtn">å­¸ç”Ÿè³‡æ–™</button>
        </div>
        <hr>
        <h6>å…¶ä»–è¨­å®š</h6>
        <ul class="list-unstyled">
          <li><a href="/approve_company">å¯©æ ¸å…¬å¸</a></li>
          <li><a href="#">ç®¡ç†å­¸ç”Ÿ</a></li>
        </ul>
      </div>

      <div class="col-md-9 p-4">
        <h2 class="mb-4 text-center">ğŸ“Š å¯¦ç¿’å…¬å¸çµ±è¨ˆå„€è¡¨æ¿</h2>
        <div class="row g-4">
          <div class="col-lg-6">
            <div class="chart-container">
              <h5 class="text-center">ğŸ¢ å„å…¬å¸è¢«é¸å¿—é¡˜æ¬¡æ•¸ï¼ˆå‰äº”åï¼‰</h5>
              <canvas id="companyChart"></canvas>
            </div>
          </div>
          <div class="col-lg-3">
            <div class="chart-container">
              <h5 class="text-center">ğŸ“„ å±¥æ­·ç¹³äº¤ç‡</h5>
              <canvas id="resumeChart"></canvas>
            </div>
          </div>
          <div class="col-lg-3">
            <div class="chart-container">
              <h5 class="text-center">ğŸ¯ å¿—é¡˜åºå¡«å¯«ç‡</h5>
              <canvas id="preferenceChart"></canvas>
            </div>
          </div>
        </div>

        <div class="row g-4 mt-4">
          <div class="col-12">
            <div id="classChartContainer" class="chart-container">
              <h2>ç­ç´šå¯¦ç¿’é€²åº¦åˆ†æ</h2>
              <p>è«‹é¸æ“‡ä¸€å€‹ç­ç´šä»¥æŸ¥çœ‹è©³ç´°å¯¦ç¿’çµ±è¨ˆåœ–è¡¨ã€‚</p>
            </div>
          </div>
        </div>

        <div id="studentsContainer"></div>
      </div>
    </div>
  </div>

  <script>
    let companyChart, resumeChart, preferenceChart;
    let myClassChart = null; // æ–°å¢ï¼šç”¨æ–¼å„²å­˜å–®ä¸€ç­ç´š Chart å¯¦ä¾‹

    // è¼‰å…¥ç­ç´šåˆ—è¡¨
    async function loadClasses() {
      const res = await fetch("/ta/statistics/api/get_classes"); // ä¿®æ­£: ç¢ºä¿è·¯ç”±æ­£ç¢º
      const data = await res.json();
      const select = document.getElementById("classSelect");

      if (data.success) {
        data.classes.forEach(c => {
          const option = document.createElement("option");
          option.value = c.id;
          option.textContent = `${c.department.replace('ç®¡ç§‘', '')}${c.name}`;
          select.appendChild(option);
        });
      }
    }

    // è¼‰å…¥çµ±è¨ˆè³‡æ–™ (åŸæœ‰çš„ä¸‰å€‹åœ–è¡¨)
    async function loadData(classId = "all") {
      let url = "/ta/statistics/api/manage_companies_stats"; 
      if (classId !== "all") url += `?class_id=${classId}`;

      const res = await fetch(url);
      const data = await res.json();

      if (!data.success) {
        alert("è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—ï¼š" + data.message);
        return;
      }

      // å…¬å¸å¿—é¡˜å‰äº”å
      const companies = data.top_companies.map(c => c.company_name);
      const counts = data.top_companies.map(c => c.preference_count);

      if (companyChart) companyChart.destroy();
      companyChart = new Chart(document.getElementById("companyChart"), {
        type: "bar",
        data: {
          labels: companies,
          datasets: [{ label: "å¿—é¡˜æ¬¡æ•¸", data: counts, backgroundColor: "#4e79a7" }]
        },
        options: { scales: { y: { beginAtZero: true } } }
      });

      const resumeData = [data.resume_stats.uploaded, data.resume_stats.not_uploaded];
      const resumeTotal = resumeData.reduce((a, b) => a + b, 0);

      if (resumeChart) resumeChart.destroy();
      resumeChart = new Chart(document.getElementById("resumeChart"), {
        type: "doughnut",
        data: {
          labels: ["å·²ä¸Šå‚³", "æœªä¸Šå‚³"],
          datasets: [{ data: resumeData, backgroundColor: ["#59a14f", "#e15759"] }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const value = context.raw;
                  const percent = ((value / resumeTotal) * 100).toFixed(1) + '%';
                  return `${context.label}: ${value} (${percent})`;
                }
              }
            }
          }
        }
      });

      const prefData = [data.preference_stats.filled, data.preference_stats.not_filled];
      const prefTotal = prefData.reduce((a, b) => a + b, 0);

      if (preferenceChart) preferenceChart.destroy();
      preferenceChart = new Chart(document.getElementById("preferenceChart"), {
        type: "doughnut",
        data: {
          labels: ["å·²å¡«å¯«", "æœªå¡«å¯«"],
          datasets: [{ data: prefData, backgroundColor: ["#edc948", "#bab0ab"] }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const value = context.raw;
                  const percent = ((value / prefTotal) * 100).toFixed(1) + '%';
                  return `${context.label}: ${value} (${percent})`;
                }
              }
            }
          }
        }
      });
    }

    // æ–°å¢å‡½å¼ï¼šè¼‰å…¥å–®ä¸€ç­ç´šçš„çµ±è¨ˆåœ–è¡¨
    async function loadClassStats(classId, className) {
      const chartContainer = document.getElementById("classChartContainer");

      // è™•ç†ã€Œæ‰€æœ‰ç­ç´šã€çš„ç‰¹æ®Šæƒ…æ³
      if (classId === 'all') {
        if (myClassChart) { myClassChart.destroy(); myClassChart = null; }
        chartContainer.innerHTML = '<h2>ç­ç´šå¯¦ç¿’é€²åº¦åˆ†æ</h2><p>è«‹é¸æ“‡ä¸€å€‹ç­ç´šä»¥æŸ¥çœ‹è©³ç´°å¯¦ç¿’çµ±è¨ˆåœ–è¡¨ã€‚</p>';
        return;
      }

      // æ¸…ç©ºä¸¦æº–å‚™æ–°çš„ Chart å…ƒç´ 
      chartContainer.innerHTML = '<h2>' + className + ' å¯¦ç¿’çµ±è¨ˆåˆ†æ</h2><canvas id="classStatsChart"></canvas>';

      try {
        // å‘¼å«æ–°çš„ API è·¯ç”±
        const res = await fetch(`/ta/statistics/api/get_class_stats/${classId}`);
        const data = await res.json();

        if (!data.success) {
          if (myClassChart) { myClassChart.destroy(); myClassChart = null; }
          chartContainer.innerHTML = `<div class="text-danger">è¼‰å…¥çµ±è¨ˆåœ–è¡¨å¤±æ•—ï¼š${data.message}</div>`;
          return;
        }

        const stats = data.stats;
        const ctx = document.getElementById('classStatsChart').getContext('2d');

        // éŠ·æ¯€èˆŠçš„ Chart å¯¦ä¾‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (myClassChart) {
          myClassChart.destroy();
        }

        // ä½¿ç”¨ Chart.js ç¹ªè£½é•·æ¢åœ–
        myClassChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['ç¸½å­¸ç”Ÿæ•¸', 'å·²ä¸Šå‚³å±¥æ­·', 'å·²å¡«å¯«å¿—é¡˜'],
            datasets: [{
              label: 'äººæ•¸',
              data: [
                stats.total_students,
                stats.students_with_resume,
                stats.students_with_preference
              ],
              backgroundColor: [
                'rgba(54, 162, 235, 0.7)', // è—è‰²: ç¸½å­¸ç”Ÿæ•¸
                'rgba(75, 192, 192, 0.7)', // ç¶ è‰²: å·²ä¸Šå‚³å±¥æ­·
                'rgba(153, 102, 255, 0.7)' // ç´«è‰²: å·²å¡«å¯«å¿—é¡˜
              ],
              borderColor: [
                'rgba(54, 162, 235, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                // è¨­å®š Y è»¸çš„æœ€å¤§å€¼ç•¥å¤§æ–¼ç¸½å­¸ç”Ÿæ•¸ï¼Œä¸”è‡³å°‘ç‚º 5
                max: stats.total_students > 0 ? Math.ceil(stats.total_students * 1.05) : 5,
                ticks: {
                  precision: 0 // ç¢ºä¿ Y è»¸åˆ»åº¦æ˜¯æ•´æ•¸
                }
              },
              x: {
                grid: {
                  display: false
                }
              }
            },
            plugins: {
              legend: {
                display: false
              },
              title: {
                display: true,
                text: stats.class_name + ' å¯¦ç¿’é€²åº¦çµ±è¨ˆ'
              }
            }
          }
        });

      } catch (error) {
        console.error("Fetch error:", error);
        if (myClassChart) { myClassChart.destroy(); myClassChart = null; }
        chartContainer.innerHTML = `<div class="text-danger">ç¶²è·¯é€£ç·šæˆ–è³‡æ–™è™•ç†éŒ¯èª¤</div>`;
      }
    }


    // ç®¡ç†å­¸ç”Ÿ
    document.getElementById("manageStudentsBtn").addEventListener("click", async () => {
      const classId = document.getElementById("classSelect").value;
      const res = await fetch("/ta/statistics/api/get_students_by_class?class_id=" + classId); // ä¿®æ­£: ç¢ºä¿è·¯ç”±æ­£ç¢º
      const data = await res.json();
      const container = document.getElementById("studentsContainer");
      container.innerHTML = "";

      if (!data.success) {
        container.innerHTML = `<div class="text-danger">è¼‰å…¥å­¸ç”Ÿè³‡æ–™å¤±æ•—ï¼š${data.message}</div>`;
        return;
      }

      if (data.students.length === 0) {
        container.innerHTML = "<div>è©²ç­ç´šæ²’æœ‰å­¸ç”Ÿè³‡æ–™</div>";
        return;
      }

      let html = `<table class="table table-striped">
    <thead><tr>
      <th>å­¸è™Ÿ</th>
      <th>å§“å</th>
      <th>Email</th>
      <th>å±¥æ­·ä¸Šå‚³</th>
      <th>å¿—é¡˜å¡«å¯«</th>
    </tr></thead>
    <tbody>`;

      data.students.forEach(s => {
        html += `<tr>
      <td>${s.username}</td>
      <td>${s.name}</td>
      <td>${s.email}</td>
      <td>${s.resume_count > 0 ? 'âœ…' : 'âŒ'}</td>
      <td>${s.preference_count > 0 ? 'âœ…' : 'âŒ'}</td>
    </tr>`;
      });

      html += "</tbody></table>";
      container.innerHTML = html;
    });

    // åˆ·æ–°çµ±è¨ˆ (ä¿®æ”¹ï¼šåŒæ™‚å‘¼å« loadData å’Œ loadClassStats)
    document.getElementById("refreshBtn").addEventListener("click", () => {
      const classSelect = document.getElementById("classSelect");
      const classId = classSelect.value;
      const className = classSelect.options[classSelect.selectedIndex].text;

      loadData(classId); // è¼‰å…¥åŸæœ‰ 3 å€‹åœ–è¡¨
      loadClassStats(classId, className); // è¼‰å…¥æ–°çš„ç­ç´šçµ±è¨ˆåœ–è¡¨
    });

    // åŒ¯å‡º Excel
    document.getElementById("exportBtn").addEventListener("click", () => {
      const classId = document.getElementById("classSelect").value;
      window.location.href = `/ta/statistics/api/export_companies_stats${classId !== "all" ? '?class_id=' + classId : ''}`; // ä¿®æ­£: ç¢ºä¿è·¯ç”±æ­£ç¢º
    });

    // åˆå§‹è¼‰å…¥
    loadClasses();
    loadData();
    loadClassStats("all", "æ‰€æœ‰ç­ç´š"); // åˆå§‹è¼‰å…¥ç­ç´šçµ±è¨ˆ (é¡¯ç¤ºé è¨­æ–‡å­—)
  </script>
</body>

</html>