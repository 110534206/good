<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <title>æ™ºæ…§å¯¦ç¿’å¹³å° | é€šçŸ¥ä¸­å¿ƒ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      padding: 2rem;
      font-family: "Noto Sans TC", sans-serif;
      background: #f2f6fc;
    }

    h1 {
      font-weight: 700;
      color: #1a2b4c;
    }

    /* æœå°‹æ¡† */
    #searchInput {
      max-width: 380px;
      border-radius: 10px;
      padding: 10px 14px;
      border: 1px solid #c8d6e5;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
    }

    /* åˆ†é¡æ¨™é¡Œå¡ç‰‡ */
    .category-title {
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      padding: 12px 16px;
      background: white;
      border: 1px solid #dce7f7;
      margin-top: 14px;
      border-radius: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.06);
      transition: 0.2s;
    }

    .category-title:hover {
      background: #f5f9ff;
      transform: translateY(-2px);
    }

    /* ç®­é ­å‹•ç•« */
    .arrow {
      transition: transform 0.25s;
    }

    .arrow.open {
      transform: rotate(90deg);
    }

    /* æ•¸å­—å¾½ç«  */
    .category-count {
      background: #0d6efd;
      color: white;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    /* é€šçŸ¥å¡ç‰‡ */
    .notif-item {
      border: 1px solid #e1e7f0;
      border-radius: 12px;
      padding: 14px;
      margin-top: 10px;
      background: white;
      cursor: pointer;
      transition: 0.15s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
    }

    .notif-item:hover {
      background: #f8fbff;
      transform: translateX(3px);
    }

    /* æœªè®€é€šçŸ¥ */
    .notif-unread {
      border-left: 4px solid #0d6efd;
      background: #eaf3ff;
    }

    /* è©³ç´°å…§å®¹å€å¡Š */
    .notif-detail {
      display: none;
      margin-top: 12px;
      padding: 12px 16px;
      background: #f0f6ff;
      border-left: 3px solid #0d6efd;
      border-radius: 8px;
      animation: fadeIn 0.25s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    /* æŒ‰éˆ•æ’ç‰ˆ */
    .notif-actions button {
      margin-right: 8px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1 class="mb-4">é€šçŸ¥ä¸­å¿ƒ</h1>

    <input type="text" id="searchInput" class="form-control mb-4" placeholder="æœå°‹é€šçŸ¥ï¼ˆæ¨™é¡Œ / å…§å®¹ï¼‰...">

    <div id="groupContainer"></div>
  </div>

  <script>
  let allNotifications = [];

  const categoryNames = {
    resume: "ğŸ“„ å±¥æ­·ç›¸é—œé€šçŸ¥",
    ranking: "ğŸ’¡ å¿—é¡˜åºç›¸é—œé€šçŸ¥",
    company: "ğŸ¢ å¯¦ç¿’å…¬å¸é€šçŸ¥",
    system: "âš™ï¸ ç³»çµ±é€šçŸ¥",
    approval: "ğŸ“ å¯©æ ¸é€šçŸ¥",
    general: "ğŸ“¢ ä¸€èˆ¬é€šçŸ¥"
  };

  async function loadNotifications() {
    try {
      const res = await fetch("/api/my_notifications");
      const data = await res.json();

      if (!data.success) {
        document.getElementById("groupContainer").innerHTML =
          `<div class="alert alert-danger">${data.message}</div>`;
        return;
      }

      // ä¿®æ­£ï¼šæ²’æœ‰ category æ™‚ fallback è‡³ general
      allNotifications = data.notifications.map(n => ({
        ...n,
        category: n.category || "general"
      }));

      renderGroups();
    } catch (err) {
      document.getElementById("groupContainer").innerHTML =
        `<div class="alert alert-danger">ç„¡æ³•è¼‰å…¥é€šçŸ¥</div>`;
    }
  }

  function renderGroups() {
    const keyword = document.getElementById("searchInput").value.toLowerCase();
    const container = document.getElementById("groupContainer");
    container.innerHTML = "";

    const groups = {};

    allNotifications.forEach(n => {
      const cat = n.category || "general";

      // ç¢ºä¿åˆ†é¡å­˜åœ¨
      if (!groups[cat]) groups[cat] = [];

      // æ”¯æ´æœå°‹
      if (
        n.title.toLowerCase().includes(keyword) ||
        n.message.toLowerCase().includes(keyword)
      ) {
        groups[cat].push(n);
      }
    });

    Object.keys(groups).forEach(cat => {
      const list = groups[cat];
      if (list.length === 0) return;

      const section = document.createElement("div");

      // ==== åˆ†é¡æ¨™é¡Œ ====
      const header = document.createElement("div");
      header.className = "category-title";

      header.innerHTML = `
        <div>${categoryNames[cat] || "ğŸ“ " + cat}</div>
        <div class="d-flex align-items-center">
          <span class="category-count">${list.length}</span>
          <span class="arrow ms-2">â–¶</span>
        </div>
      `;

      const arrow = header.querySelector(".arrow");

      // é è¨­æ”¶åˆ (ä½ é¸ A)
      const box = document.createElement("div");
      box.style.display = "none";

      header.addEventListener("click", () => {
        box.style.display = box.style.display === "block" ? "none" : "block";
        arrow.classList.toggle("open");
      });

      // ==== é€šçŸ¥åˆ—è¡¨ ====
      list.forEach(n => {
        const item = document.createElement("div");
        item.className = "notif-item " + (n.is_read ? "" : "notif-unread");

        const titleDiv = document.createElement("div");
        titleDiv.innerHTML = `
          <strong style="font-size:1.05rem;">${n.title}</strong>
          <span class="text-muted float-end">${formatDate(n.created_at)}</span>
        `;

        const detailDiv = document.createElement("div");
        detailDiv.className = "notif-detail";
        detailDiv.innerHTML = `<p style="white-space:pre-line;">${n.message}</p>`;

        item.appendChild(titleDiv);
        item.appendChild(detailDiv);

        // å±•é–‹è©³ç´°å…§å®¹
        item.addEventListener("click", () => {
          detailDiv.style.display =
            detailDiv.style.display === "block" ? "none" : "block";
        });

        addActionButtons(detailDiv, n);

        box.appendChild(item);
      });

      section.appendChild(header);
      section.appendChild(box);
      container.appendChild(section);
    });
  }

  function addActionButtons(detailDiv, n) {
    const div = document.createElement("div");
    div.className = "notif-actions mt-2";

    if (!n.is_read) {
      const readBtn = document.createElement("button");
      readBtn.className = "btn btn-success btn-sm";
      readBtn.innerHTML = "âœ” å·²è®€";
      readBtn.onclick = e => {
        e.stopPropagation();
        markRead(n.id);
      };
      div.appendChild(readBtn);
    }

    const delBtn = document.createElement("button");
    delBtn.className = "btn btn-danger btn-sm";
    delBtn.innerHTML = "ğŸ—‘ åˆªé™¤";
    delBtn.onclick = e => {
      e.stopPropagation();
      deleteNotif(n.id);
    };
    div.appendChild(delBtn);

    detailDiv.appendChild(div);
  }

  async function markRead(id) {
    await fetch(`/api/mark_read/${id}`, { method: "POST" });
    loadNotifications();
  }

  async function deleteNotif(id) {
    if (!confirm("ç¢ºå®šè¦åˆªé™¤ï¼Ÿ")) return;
    await fetch(`/api/notification/delete/${id}`, { method: "DELETE" });
    loadNotifications();
  }

  function formatDate(d) {
    return new Date(d).toLocaleString("zh-TW", { hour12: false });
  }

  document.getElementById("searchInput").addEventListener("input", renderGroups);
  loadNotifications();
</script>

</body>
</html>
