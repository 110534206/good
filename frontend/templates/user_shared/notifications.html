<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <title>æ™ºæ…§å¯¦ç¿’å¹³å° | é€šçŸ¥ä¸­å¿ƒ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding: 2rem;
      font-family: "Noto Sans TC", sans-serif;
      background: #f8fafc;
    }

    h1 {
      color: #0d6efd;
      margin-bottom: 2rem;
    }

    .unread {
      background-color: #e9f3ff;
      font-weight: bold;
    }

    .read {
      color: #555;
    }

    .btn-sm {
      margin-right: 0.25rem;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>é€šçŸ¥ä¸­å¿ƒ</h1>

    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>æ¨™é¡Œ</th>
          <th>å…§å®¹</th>
          <th>æ™‚é–“</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="notifTable"></tbody>
    </table>
  </div>

  <script>
    // ------------------------------------
    //  å» å•†å¯©æ ¸ JS å‡½å¼
    // ------------------------------------
    async function approveVendor(notifId, vendorUserId) {
        if (!confirm('ç¢ºå®šè¦é€šéè©²å» å•†çš„å¸³è™Ÿå¯©æ ¸å—ï¼Ÿ')) return;

        // 1. èª¿ç”¨å¾Œç«¯å¯©æ ¸ API
        const res = await fetch(`/admin/api/approve_vendor/${vendorUserId}`, { method: 'POST' }); 
        const data = await res.json();

        if (data.success) {
            alert(data.message);
            // 2. å¯©æ ¸æˆåŠŸå¾Œï¼Œå°‡è©²é€šçŸ¥æ¨™è¨˜ç‚ºå·²è®€ (é¿å…é‡è¤‡æ“ä½œ)
            await markRead(notifId); 
            loadNotifications(); // é‡æ–°è¼‰å…¥é€šçŸ¥åˆ—è¡¨
        } else {
            alert('å¯©æ ¸å¤±æ•—: ' + data.message);
        }
    }

    // ------------------------------------
    // è¼‰å…¥é€šçŸ¥å‡½å¼
    // ------------------------------------
    async function loadNotifications() {
      const res = await fetch('/api/my_notifications');
      const data = await res.json();
      const tbody = document.getElementById('notifTable');
      tbody.innerHTML = '';

      if (!data.success) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">${data.message || 'è¼‰å…¥å¤±æ•—'}</td></tr>`;
        return;
      }

      data.notifications.forEach(n => {
        const row = document.createElement('tr');
        row.className = n.is_read ? 'read' : 'unread';

        let actionButton = '';
        // ğŸ¯ æ ¸å¿ƒä¿®æ”¹ï¼šæª¢æŸ¥æ˜¯å¦ç‚ºå¯©æ ¸é€£çµ
        const isApprovalLink = n.link_url && n.link_url.startsWith('/admin/api/approve_vendor/');

        if (isApprovalLink) {
            // æå–å» å•† User ID (n.link_url çš„æœ€å¾Œä¸€éƒ¨åˆ†)
            const userId = n.link_url.split('/').pop();
            // n.id æ˜¯é€šçŸ¥IDï¼Œç”¨æ–¼ markReadï¼›userId æ˜¯å» å•†IDï¼Œç”¨æ–¼ approveVendor API
            // åªæœ‰æœªè®€é€šçŸ¥æ‰é¡¯ç¤ºå¯©æ ¸æŒ‰éˆ•
            if (!n.is_read) {
                 actionButton = `<button class="btn btn-sm btn-success" onclick="approveVendor(${n.id}, ${userId})">åŒæ„å¯©æ ¸</button>`;
            } else {
                 actionButton = `<span class="badge bg-success">å·²å¯©æ ¸</span>`;
            }
        } else {
            // ä¿æŒç¾æœ‰çš„ "å‰å¾€" é€£çµé‚è¼¯
            actionButton = n.link_url ? `<a href="${n.link_url}" class="btn btn-sm btn-primary">å‰å¾€</a>` : '';
        }
        
        row.innerHTML = `
        <td>${n.is_read ? 'âœ…' : 'ğŸ†•'} ${n.title}</td>
        <td>${n.message.replace(/\\n/g, '<br>')}</td>
        <td>${new Date(n.created_at).toLocaleString('zh-TW', { hour12: false })}</td>
        <td>
          ${actionButton} 
          ${!n.is_read && !isApprovalLink ? `<button class="btn btn-sm btn-success" onclick="markRead(${n.id})">å·²è®€</button>` : ''}
          <button class="btn btn-sm btn-danger" onclick="deleteNotif(${n.id})">åˆªé™¤</button>
        </td>
      `;
        tbody.appendChild(row);
      });
    }

    async function markRead(id) {
      const res = await fetch(`/api/mark_read/${id}`, { method: 'POST' });
      const data = await res.json();
      if (!data.success) return alert(data.message);
      // é‡æ–°è¼‰å…¥ä»¥æ›´æ–° UI
      loadNotifications();
    }
    
    async function deleteNotif(id) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡é€šçŸ¥å—ï¼Ÿ')) return;
        const res = await fetch(`/api/delete_notification/${id}`, { method: 'POST' });
        const data = await res.json();
        if (!data.success) return alert(data.message);
        loadNotifications(); // é‡æ–°è¼‰å…¥é€šçŸ¥åˆ—è¡¨
    }
    loadNotifications(); // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
</script>
</body>

</html>