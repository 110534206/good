<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ™ºæ…§å¯¦ç¿’å¹³å° | é€šçŸ¥ä¸­å¿ƒ</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    header {
      background: #0454a3;
      color: white;
      padding: 1rem 2rem;
      text-align: center;
      font-size: 1.5rem;
    }

    /* ä¸‰æ¢ç·šé¸å–®æŒ‰éˆ•æ¨£å¼ */
    .top-bar-left {
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 1100;
    }

    .top-bar-left #menu-btn {
      width: 30px;
      height: 22px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      background: none;
      border: none;
      padding: 0;
    }

    .top-bar-left #menu-btn span {
      display: block;
      width: 100%;
      height: 3px;
      background-color: white;
      border-radius: 2px;
      transition: all 0.3s ease;
    }

    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --muted: #6b7280;
      --primary: #0454a3;
      --glass: rgba(255, 255, 255, 0.85);
      --accent: #0b5ed7;
    }

    body {
      font-family: "Noto Sans TC", sans-serif;
      background: linear-gradient(180deg, #f0f4f8, #e8f0f8 120px);
      margin: 0;
      padding: 0;
      padding-top: 0;
      min-height: 100vh;
    }

    .container {
      max-width: 1000px;
      margin: 2rem auto;
      margin-top: 2rem;
      border-radius: 12px;
    }


    /* ã€ä¿®æ”¹ã€‘app-shell ç‚ºå–®æ¬„ï¼Œä¸¦èª¿æ•´æœ€å¤§å¯¬åº¦ */
    .app-shell {
      max-width: 900px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr;
      /* å–®æ¬„ */
      gap: 1rem;
    }

    /* header */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .topbar .title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #0f1724;
    }

    .topbar .controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    /* left column - main list */
    .left-panel {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.95), #ffffff 40%);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(13, 52, 122, 0.08);
      min-height: 70vh;
      overflow: auto;
      position: relative;
    }

    .unread-badge {
      position: absolute;
      top: 12px;
      right: 16px;
      background: #ff4d4f;
      color: #fff;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(255, 77, 79, 0.25);
      z-index: 10;
    }

    .unread-badge span {
      font-weight: 700;
    }

    .unread-badge.inline {
      position: static;
      margin-left: auto;
      flex-shrink: 0;
    }

    /* æœå°‹/ç¯©é¸åˆ— */
    .search-filter-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eef6ff;
      flex-wrap: wrap;
    }

    #searchInput {
      padding: 6px 12px;
      height: 38px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      flex-grow: 1;
      max-width: 360px;
    }

    /* filter row */
    .chip {
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .chip.active {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 6px 18px rgba(13, 110, 253, 0.12)
    }

    .chip.outline {
      background: transparent;
      border: 1px solid #e6eefb;
      color: var(--muted)
    }

    /* group header */
    .group-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      margin-bottom: 6px;
      padding: 8px 10px;
      border-radius: 10px;
      background: linear-gradient(90deg, rgba(248, 250, 252, 0.8), rgba(240, 247, 255, 0.8));
      border: 1px solid #e0e8f5;
      font-weight: 600;
    }

    .group-title {
      font-size: 0.95rem;
      color: #0b2540;
    }

    .sort-btn-group {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .sort-btn {
      padding: 4px 6px;
      line-height: 1;
      border-radius: 4px;
      background: transparent;
      border: none;
      color: var(--muted);
      transition: color 0.1s ease;
    }

    .sort-btn:hover {
      color: var(--accent);
    }

    .sort-btn.active {
      color: var(--primary);
      font-weight: 700;
    }

    /* notification card */
    .notif-card {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      background: #ffffff;
      border-radius: 12px;
      padding: 12px;
      border: 1px solid #e8f0f8;
      margin-bottom: 10px;
      transition: transform .12s ease, box-shadow .12s ease;
      cursor: pointer;
    }

    .notif-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 30px rgba(13, 52, 122, 0.06);
    }

    .notif-left {
      min-width: 48px;
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      background: linear-gradient(180deg, #eff6ff, #fff);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: var(--accent);
      border: 1px solid #e6eefb;
    }

    .notif-body {
      flex: 1;
    }

    .notif-meta {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .notif-title {
      font-weight: 700;
      margin-bottom: 6px;
      color: #0f1724;
    }

    .badge-tag {
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 999px;
      margin-right: 6px;
    }

    /* unread style - æœªè®€ç‚ºç™½è‰² */
    .notif-unread {
      border-left: 4px solid var(--primary);
      background: #ffffff;
    }

    /* read style - å·²è®€ç‚ºç°è‰² */
    .notif-read {
      background: #f5f5f5;
      border-left: 4px solid transparent;
    }

    /* pinned */
    .pin-icon {
      color: #b5c7ff;
    }

    .pinned {
      border-left-color: #ffbf00 !important;
    }

    /* ç§‘åŠ©ã€Œæ™‚ç¨‹ã€é¡åˆ¥ä¸­çš„å…¬å‘Šé¡è‰²å€åˆ† */
    .notif-card.announcement-not-started {
      border-left-color: #0d6efd !important;  /* è—è‰²ï¼šæœªé–‹å§‹ */
      background: linear-gradient(90deg, rgba(13, 110, 253, 0.05), #ffffff);
    }

    .notif-card.announcement-ended {
      border-left-color: #6c757d !important;  /* ç°è‰²ï¼šå·²çµæŸ */
      background: linear-gradient(90deg, rgba(108, 117, 125, 0.05), #f5f5f5);
      opacity: 0.85;
    }

    /* detail small buttons */
    .meta-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    /* ã€ç§»é™¤ã€‘å³å´é¢æ¿å’Œ Drawer æ¨£å¼ */
    .right-panel,
    .drawer {
      display: none !important;
    }

    /* small helpers */
    .muted {
      color: var(--muted);
    }

    .small {
      font-size: 0.85rem;
    }

    .actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    /* unread counter badge - æ¨£å¼å·²ç”± .unread-badge çµ±ä¸€è™•ç† */

    /* tiny input style */
    input[type="date"] {
      height: 38px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #e6eefb;
      background: white;
    }

    /* å´é‚Šé¸å–®æ¨£å¼ */
    #side-menu {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 320px;
      max-width: 80vw;
      background-color: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(6px);
      box-shadow: 3px 0 12px rgba(0, 0, 0, 0.6);
      padding: 2rem 1.5rem;
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
      z-index: 1200;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      color: #fff;
      user-select: none;
    }

    #side-menu.open {
      transform: translateX(0);
    }

    #side-menu .menu-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      margin-bottom: 1.5rem;
    }

    #side-menu h2 {
      margin: 0;
      font-weight: 700;
      font-size: 1.5rem;
      text-align: left;
      flex: 1;
      color: white;
    }

    #close-btn {
      font-size: 2.2rem;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      line-height: 1;
      width: 2.5rem;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      margin: 0;
    }

    #menu-content {
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    #side-menu a {
      display: block;
      width: 100%;
      padding: 0.6rem 0;
      font-size: 1.1rem;
      color: #e2e8f0;
      text-decoration: none;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }

    #side-menu a:hover {
      background-color: rgba(255, 255, 255, 0.18);
      color: #fff;
    }

    /* ç§‘åŠ©å°ˆç”¨æŒ‰éˆ•å€åŸŸ */
    #ta-actions {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eef6ff;
    }
    
    #ta-actions .btn {
      white-space: nowrap;
      flex-shrink: 0;
    }
  </style>
</head>

<body>
  <header>é€šçŸ¥ä¸­å¿ƒ</header>
  <div class="top-bar-left">
    <button id="menu-btn" title="é¸å–®" role="button" tabindex="0" aria-label="é–‹å•Ÿå´é‚Šé¸å–®">
      <span></span>
      <span></span>
      <span></span>
    </button>
  </div>
  <div class="container">

    <div class="app-shell">

      <div class="left-panel">

        <div class="unread-badge" id="unreadBadgeTopRight">
          æœªè®€ <span id="unreadCounterTopRight">0</span>
        </div>

        <!-- ç§‘åŠ©å°ˆç”¨æŒ‰éˆ•å€åŸŸï¼ˆåœ¨æœå°‹æ¡†ä¸Šæ–¹é å³å°é½Šï¼‰ -->
        <div id="ta-actions" style="display: none; justify-content: flex-end; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
          <button id="btn-publish" class="btn btn-primary">â• ç™¼å¸ƒå…¬å‘Šèˆ‡æˆªæ­¢æ™‚é–“</button>
        </div>

        <div class="search-filter-row">
          <input id="searchInput" placeholder="æœå°‹ï¼ˆæ¨™é¡Œ/å…§å®¹ï¼‰" type="text">

          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"
              aria-expanded="false" id="filterDropdownBtn">
              <span id="currentFilterLabel">å…¨éƒ¨</span>
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item active" href="#" data-filter="all">å…¨éƒ¨</a></li>
              <li><a class="dropdown-item" href="#" data-filter="unread">æœªè®€</a></li>
              <li><a class="dropdown-item" href="#" data-filter="read">å·²è®€</a></li>
              <li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li><a class="dropdown-item text-danger" href="#" id="clearPinned">æ¸…é™¤æ‰€æœ‰ç½®é ‚</a></li>
            </ul>
          </div>

          <!-- ç§‘åŠ©å°ˆç”¨ï¼šç‹€æ…‹ä¸‹æ‹‰é¸å–® -->
          <div class="dropdown" id="statusDropdown" style="display: none;">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"
              aria-expanded="false" id="statusDropdownBtn">
              <span id="currentStatusLabel">é€²è¡Œä¸­</span>
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item active" href="#" data-status="ongoing">é€²è¡Œä¸­</a></li>
              <li><a class="dropdown-item" href="#" data-status="not-started">æœªé–‹å§‹</a></li>
              <li><a class="dropdown-item" href="#" data-status="ended">å·²çµæŸ</a></li>
            </ul>
          </div>

          <div class="unread-badge inline" id="unreadBadgeSearchRow">
            æœªè®€ <span id="unreadCounterSearchRow">0</span>
          </div>
        </div>

        <div class="d-flex gap-2 flex-wrap mb-3 align-items-center" id="categoryFilter">
          <label class="small muted me-1 mb-0" style="line-height: 1.5;">é¡åˆ¥</label>
          <div class="chip outline active" data-category="all">å…¨éƒ¨é€šçŸ¥</div>
          <div class="chip outline" data-category="announcement">å…¬å‘Š</div>
          <div class="chip outline" data-category="resume">å±¥æ­·</div>
          <div class="chip outline" data-category="ranking">å¿—é¡˜åº</div>
          <div class="chip outline" data-category="company">å¯¦ç¿’å…¬å¸</div>
          <div class="chip outline" data-category="approval" id="approval-filter" style="display: none;">æ™‚ç¨‹</div>
          <div class="unread-badge" id="unreadBadgeTA" style="position: static; margin-left: auto; display: none;">
            æœªè®€ <span id="unreadCounterTA">0</span>
          </div>
        </div>

        <div id="listContainer"></div>
      </div>

    </div>
  </div>

  <!-- å´é‚Šé¸å–® -->
  <nav id="side-menu" aria-hidden="true" role="navigation" aria-label="åŠŸèƒ½é¸å–®">
    <div class="menu-header">
      <h2>åŠŸèƒ½é¸å–®</h2>
      <button id="close-btn" aria-label="é—œé–‰åŠŸèƒ½é¸å–®">Ã—</button>
    </div>
    <div id="menu-content"></div>
  </nav>

  <div class="modal fade" id="notifModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">é€šçŸ¥</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="modalBody"></div>
        </div>
        <div class="modal-footer">
          <a class="btn btn-primary" id="modalLink" href="#" target="_blank" style="display:none;">å‰å¾€å…§å®¹</a>
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">é—œé–‰</button>
          <button class="btn btn-danger" id="modalDelete">åˆªé™¤</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç§‘åŠ©å°ˆç”¨ Modalï¼šå¡«å¯«å¿—é¡˜åºæˆªæ­¢æ™‚é–“ -->
  <div class="modal fade" id="prefDeadlineModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" style="font-weight: bold;">æ–°å¢ä½œæ¥­æˆªæ­¢æ™‚é–“</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3"><label class="form-label">æ¨™é¡Œ</label><input id="pref-title" class="form-control"></div>
          <div class="mb-3"><label class="form-label">å…§å®¹</label><textarea id="pref-content" class="form-control" rows="4"></textarea></div>
          <div class="mb-3"><label class="form-label">ç™¼é€å°è±¡</label>
            <select id="pref-target-roles" class="form-select">
              <option value="">è«‹é¸æ“‡ç™¼é€å°è±¡</option>
              <option value="all">å…¨éƒ¨ä½¿ç”¨è€…</option>
              <option value="student">å­¸ç”Ÿ</option>
              <option value="teacher">æŒ‡å°è€å¸«</option>
              <option value="director">ä¸»ä»»</option>
              <option value="class_teacher">ç­å°</option>
            </select>
          </div>
          <div class="mb-3"><label class="form-label">é–‹å§‹æ™‚é–“</label><input id="pref-start" type="datetime-local" class="form-control"></div>
          <div class="mb-3"><label class="form-label">çµæŸæ™‚é–“</label><input id="pref-end" type="datetime-local" class="form-control"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button id="btn-save-pref-deadline" type="button" class="btn btn-primary">å„²å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç§‘åŠ©å°ˆç”¨ Modalï¼šä¸Šå‚³å±¥æ­·æˆªæ­¢æ™‚é–“ -->
  <div class="modal fade" id="resumeDeadlineModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" style="font-weight: bold;">æ–°å¢ä½œæ¥­æˆªæ­¢æ™‚é–“</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3"><label class="form-label">æ¨™é¡Œ</label><input id="resume-title" class="form-control"></div>
          <div class="mb-3"><label class="form-label">å…§å®¹</label><textarea id="resume-content" class="form-control" rows="4"></textarea></div>
          <div class="mb-3"><label class="form-label">ç™¼é€å°è±¡</label>
            <select id="resume-target-roles" class="form-select">
              <option value="">è«‹é¸æ“‡ç™¼é€å°è±¡</option>
              <option value="all">å…¨éƒ¨ä½¿ç”¨è€…</option>
              <option value="student">å­¸ç”Ÿ</option>
              <option value="teacher">æŒ‡å°è€å¸«</option>
              <option value="director">ä¸»ä»»</option>
              <option value="class_teacher">ç­å°</option>
            </select>
          </div>
          <div class="mb-3"><label class="form-label">é–‹å§‹æ™‚é–“</label><input id="resume-start" type="datetime-local" class="form-control"></div>
          <div class="mb-3"><label class="form-label">çµæŸæ™‚é–“</label><input id="resume-end" type="datetime-local" class="form-control"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button id="btn-save-resume-deadline" type="button" class="btn btn-primary">å„²å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç§‘åŠ©å°ˆç”¨ Modalï¼šé¸æ“‡ç™¼å¸ƒé¡å‹ -->
  <div class="modal fade" id="publishTypeModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" style="font-weight: bold;">é¸æ“‡ç™¼å¸ƒé¡å‹</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="d-grid gap-2">
            <button type="button" class="btn btn-outline-primary btn-lg" id="btn-select-announcement">
              ğŸ“¢ æ–°å¢å…¬å‘Š
            </button>
            <button type="button" class="btn btn-outline-success btn-lg" id="btn-select-pref-deadline">
              ğŸ“ å¡«å¯«å¿—é¡˜åºæˆªæ­¢æ™‚é–“
            </button>
            <button type="button" class="btn btn-outline-success btn-lg" id="btn-select-resume-deadline">
              ğŸ“ ä¸Šå‚³å±¥æ­·æˆªæ­¢æ™‚é–“
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç§‘åŠ©å°ˆç”¨ Modalï¼šæ–°å¢å…¬å‘Š -->
  <div class="modal fade" id="annModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="annModalTitle" style="font-weight: bold;">æ–°å¢å…¬å‘Š</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3"><label class="form-label">æ¨™é¡Œ</label><input id="ann-title" class="form-control"></div>
          <div class="mb-3"><label class="form-label">å…§å®¹</label><textarea id="ann-content" class="form-control" rows="4"></textarea></div>
          <div class="mb-3"><label class="form-label">ç™¼é€å°è±¡</label>
            <select id="ann-target-roles" class="form-select">
              <option value="">è«‹é¸æ“‡ç™¼é€å°è±¡</option>
              <option value="all">å…¨éƒ¨ä½¿ç”¨è€…</option>
              <option value="student">å­¸ç”Ÿ</option>
              <option value="teacher">æŒ‡å°è€å¸«</option>
              <option value="director">ä¸»ä»»</option>
              <option value="class_teacher">ç­å°</option>
            </select>
          </div>
          <div class="mb-3"><label class="form-label">é–‹å§‹æ™‚é–“</label><input id="ann-start" type="datetime-local" class="form-control"></div>
          <div class="mb-3"><label class="form-label">çµæŸæ™‚é–“</label><input id="ann-end" type="datetime-local" class="form-control"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button id="btn-save-ann" type="button" class="btn btn-primary">å„²å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ---------- åˆå§‹ç‹€æ…‹ ----------
    let allNotifications = [];
    let visibleNotifications = [];
    let pinnedSet = new Set(JSON.parse(localStorage.getItem('notif_pinned') || '[]'));
    let currentCategoryFilter = 'all';
    let currentReadFilter = 'all';
    let currentStatusFilter = 'ongoing'; // é è¨­ç‚ºã€Œé€²è¡Œä¸­ã€
    let currentSortOrder = 'desc';

    // å…ƒä»¶
    const listContainer = document.getElementById('listContainer');
    const searchInput = document.getElementById('searchInput');
    const unreadCounterTopRight = document.getElementById('unreadCounterTopRight');
    const unreadCounterSearchRow = document.getElementById('unreadCounterSearchRow');
    const currentFilterLabel = document.getElementById('currentFilterLabel');

    // modal components
    const notifModal = new bootstrap.Modal(document.getElementById('notifModal'), {});
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalLink = document.getElementById('modalLink');
    const modalDelete = document.getElementById('modalDelete'); // æ–°å¢åˆªé™¤æŒ‰éˆ•å…ƒä»¶

    // helper: format date & relative group
    function formatDateTime(d) {
      const dt = new Date(d);
      return dt.toLocaleString('zh-TW', { hour12: false, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
    }

    // helper: å°‡é¡åˆ¥è½‰æ›ç‚ºä¸­æ–‡é¡¯ç¤º
    function getCategoryLabel(category, title = '') {
      // å¦‚æœæ¨™é¡ŒåŒ…å«ã€Œå…¬å‘Šã€ï¼Œå„ªå…ˆé¡¯ç¤ºç‚ºã€Œå…¬å‘Šã€ï¼ˆå…¼å®¹èˆŠæ•¸æ“šï¼‰
      if (title && title.includes('å…¬å‘Š') && !title.includes('é¢è©¦é€šçŸ¥') && !title.includes('éŒ„å–é€šçŸ¥')) {
        return 'å…¬å‘Š';
      }
      
      const categoryMap = {
        'announcement': 'å…¬å‘Š',
        'resume': 'å±¥æ­·',
        'ranking': 'å¿—é¡˜åº',
        'company': 'å¯¦ç¿’å…¬å¸',
        'approval': 'æ™‚ç¨‹',
        'general': 'ä¸€èˆ¬',
        'preferences': 'å¿—é¡˜åº'  // å…¼å®¹èˆŠçš„ preferences é¡åˆ¥
      };
      return categoryMap[category] || category || 'ä¸€èˆ¬';
    }

    function groupLabelForDate(d) {
      const dt = new Date(d);
      const today = new Date();
      // ç¢ºä¿åªæ¯”è¼ƒæ—¥æœŸéƒ¨åˆ†
      const diff = (today.setHours(0, 0, 0, 0) - new Date(dt).setHours(0, 0, 0, 0)) / (24 * 3600 * 1000);
      if (diff === 0) return 'ä»Šå¤©';
      if (diff === 1) return 'æ˜¨å¤©';
      if (diff <= 6) return 'æœ¬é€±';
      return 'æ›´æ—©ä¹‹å‰';
    }

    // fetch notifications
    async function loadNotifications() {
      try {
        const res = await fetch('/api/my_notifications');
        const data = await res.json();
        if (!data.success) {
          listContainer.innerHTML = `<div class="alert alert-danger">${data.message || 'è®€å–å¤±æ•—'}</div>`;
          return;
        }

        allNotifications = data.notifications.map(n => {
          const title = n.title || '(ç„¡æ¨™é¡Œ)';
          const category = n.category || 'general';
          // å¦‚æœæ¨™é¡ŒåŒ…å«ã€Œå…¬å‘Šã€ï¼Œå°‡é¡åˆ¥è¨­ç‚º "announcement"ï¼ˆå…¼å®¹èˆŠæ•¸æ“šï¼‰
          const finalCategory = (title.includes('å…¬å‘Š') && !title.includes('é¢è©¦é€šçŸ¥') && !title.includes('éŒ„å–é€šçŸ¥')) 
            ? 'announcement' 
            : category;
          
          return {
            id: n.id,
            title: title,
            message: n.message || '',
            category: finalCategory,
            tags: n.tags || (n.tag ? [n.tag] : []),
            is_read: !!n.is_read,
            created_at: n.created_at || n.createdAt || new Date().toISOString(),
            url: n.url || n.link || null,
            link_url: n.link_url || n.url || n.link || null,  // ä¿å­˜ link_url ç”¨æ–¼æå–å…¬å‘Š ID
            start_time: n.start_time || null,  // ä¿å­˜å…¬å‘Šçš„é–‹å§‹æ™‚é–“
            end_time: n.end_time || null,  // ä¿å­˜å…¬å‘Šçš„çµæŸæ™‚é–“
            meta: n.meta || {}
          };
        });

        allNotifications.forEach(n => { n.pinned = pinnedSet.has(String(n.id)); });

        // sort: pinned first, then unread, then newest
        allNotifications.sort((a, b) => {
          if ((a.pinned ? 1 : 0) !== (b.pinned ? 1 : 0)) return (b.pinned ? 1 : 0) - (a.pinned ? 1 : 0);
          if ((a.is_read ? 1 : 0) !== (b.is_read ? 1 : 0)) return (a.is_read ? 1 : 0) - (b.is_read ? 1 : 0);
          return new Date(b.created_at) - new Date(a.created_at);
        });

        render();
      } catch (err) {
        console.error(err);
        listContainer.innerHTML = `<div class="alert alert-danger">ç„¡æ³•è¼‰å…¥é€šçŸ¥</div>`;
      }
    }

    // render list with grouping
    function render() {
      const keyword = (searchInput.value || '').trim().toLowerCase();

      // 1. ç¯©é¸
      const now = new Date();
      // åˆ¤æ–·æ˜¯å¦ç‚ºç§‘åŠ©
      const isTA = document.getElementById('ta-actions')?.style.display === 'flex';
      
      visibleNotifications = allNotifications.filter(n => {
        // åˆ¤æ–·å…¬å‘Šæ˜¯å¦å·²é–‹å§‹
        let isStarted = true;  // é è¨­ç‚ºå·²é–‹å§‹
        if (n.start_time) {
          try {
            const startTime = new Date(n.start_time);
            isStarted = startTime <= now;
          } catch (e) {
            // å¦‚æœæ™‚é–“è§£æå¤±æ•—ï¼Œé è¨­ç‚ºå·²é–‹å§‹
            isStarted = true;
          }
        }
        
        // åˆ¤æ–·å…¬å‘Šæ˜¯å¦å·²çµæŸ
        let isEnded = false;
        if (n.end_time) {
          try {
            const endTime = new Date(n.end_time);
            isEnded = endTime < now;
          } catch (e) {
            // å¦‚æœæ™‚é–“è§£æå¤±æ•—ï¼Œé è¨­ç‚ºæœªçµæŸ
            isEnded = false;
          }
        }
        
        // åˆ¤æ–·æ˜¯å¦ç‚ºå…¬å‘Š
        const isAnnouncement = n.category === 'announcement' || 
          (n.title.includes('å…¬å‘Š') && !n.title.includes('é¢è©¦é€šçŸ¥') && !n.title.includes('éŒ„å–é€šçŸ¥'));
        
        // é¡åˆ¥ç¯©é¸ï¼šå¦‚æœé¸æ“‡ã€Œå…¬å‘Šã€ï¼Œä¹Ÿè¦åŒ…å«æ¨™é¡ŒåŒ…å«ã€Œå…¬å‘Šã€çš„é€šçŸ¥ï¼ˆå…¼å®¹èˆŠæ•¸æ“šï¼‰
        if (currentCategoryFilter !== 'all') {
          if (currentCategoryFilter === 'announcement') {
            // å…¬å‘Šé¡åˆ¥ï¼šåªé¡¯ç¤ºå…¬å‘Š
            if (!isAnnouncement) return false;
            // ç§‘åŠ©ï¼šæ ¹æ“šç‹€æ…‹ç¯©é¸
            if (isTA) {
              if (currentStatusFilter === 'ongoing') {
                // é€²è¡Œä¸­ï¼šå·²é–‹å§‹ä¸”æœªçµæŸ
                if (!isStarted || isEnded) return false;
              } else if (currentStatusFilter === 'not-started') {
                // æœªé–‹å§‹ï¼šå°šæœªé–‹å§‹
                if (isStarted) return false;
              } else if (currentStatusFilter === 'ended') {
                // å·²çµæŸï¼šå·²çµæŸ
                if (!isEnded) return false;
              }
            } else {
              // å…¶ä»–è§’è‰²ï¼šåªé¡¯ç¤ºå·²é–‹å§‹ä¸”æœªçµæŸçš„å…¬å‘Š
              if (!isStarted || isEnded) return false;
            }
          } else if (currentCategoryFilter === 'approval') {
            // æ™‚ç¨‹é¡åˆ¥ï¼ˆåƒ…ç§‘åŠ©å¯è¦‹ï¼‰
            if (!isAnnouncement) return false;
            if (isTA) {
              // ç§‘åŠ©ï¼šæ ¹æ“šç‹€æ…‹ç¯©é¸é¡¯ç¤ºå°æ‡‰çš„å…¬å‘Š
              if (currentStatusFilter === 'not-started') {
                // é¸æ“‡ã€Œæœªé–‹å§‹ã€ï¼šåªé¡¯ç¤ºæœªé–‹å§‹çš„å…¬å‘Š
                if (isStarted) return false;
              } else if (currentStatusFilter === 'ended') {
                // é¸æ“‡ã€Œå·²çµæŸã€ï¼šåªé¡¯ç¤ºå·²çµæŸçš„å…¬å‘Š
                if (!isEnded) return false;
              } else {
                // é è¨­ï¼šé¡¯ç¤ºæœªé–‹å§‹çš„å…¬å‘Š + å·²çµæŸçš„å…¬å‘Šï¼ˆæ’é™¤é€²è¡Œä¸­çš„ï¼‰
                if (isStarted && !isEnded) return false;
              }
            } else {
              // å…¶ä»–è§’è‰²ä¸æ‡‰è©²çœ‹åˆ°ã€Œæ™‚ç¨‹ã€é¡åˆ¥ï¼Œä½†ç‚ºäº†å®‰å…¨èµ·è¦‹é‚„æ˜¯éæ¿¾
              return false;
            }
          } else {
            // å…¶ä»–é¡åˆ¥ï¼šåš´æ ¼åŒ¹é…ï¼ˆç‹€æ…‹ç¯©é¸ä¸é©ç”¨æ–¼éå…¬å‘Šé¡åˆ¥ï¼‰
            if (n.category !== currentCategoryFilter) return false;
          }
        } else {
          // ã€Œå…¨éƒ¨é€šçŸ¥ã€ï¼šæ ¹æ“šç‹€æ…‹ç¯©é¸é¡¯ç¤º
          if (isTA && isAnnouncement) {
            // ç§‘åŠ©åœ¨ã€Œå…¨éƒ¨é€šçŸ¥ã€ä¸­ï¼Œæ ¹æ“šç‹€æ…‹ç¯©é¸é¡¯ç¤ºå…¬å‘Š
            if (currentStatusFilter === 'ongoing') {
              // é€²è¡Œä¸­ï¼šå·²é–‹å§‹ä¸”æœªçµæŸ
              if (!isStarted || isEnded) return false;
            } else if (currentStatusFilter === 'not-started') {
              // æœªé–‹å§‹ï¼šå°šæœªé–‹å§‹
              if (isStarted) return false;
            } else if (currentStatusFilter === 'ended') {
              // å·²çµæŸï¼šå·²çµæŸ
              if (!isEnded) return false;
            }
          } else if (isAnnouncement && (!isStarted || isEnded)) {
            // å…¶ä»–è§’è‰²ï¼šã€Œå…¨éƒ¨é€šçŸ¥ã€åªé¡¯ç¤ºå·²é–‹å§‹ä¸”æœªçµæŸçš„å…¬å‘Š
            return false;
          }
        }
        
        // å…¶ä»–è§’è‰²ï¼šæ’é™¤å·²çµæŸçš„å…¬å‘Šï¼ˆéç§‘åŠ©ï¼‰
        if (!isTA && isAnnouncement && isEnded) {
          return false;
        }
        
        if (currentReadFilter === 'unread' && n.is_read) return false;
        if (currentReadFilter === 'read' && !n.is_read) return false;
        if (currentReadFilter === 'pinned' && !n.pinned) return false;
        if (keyword) {
          const hay = (n.title + ' ' + n.message).toLowerCase();
          if (!hay.includes(keyword)) return false;
        }
        return true;
      });

      // 2. åˆ†çµ„
      const groups = {};
      visibleNotifications.forEach(n => {
        const g = groupLabelForDate(n.created_at);
        if (!groups[g]) groups[g] = [];
        groups[g].push(n);
      });

      // 3. æ¸²æŸ“
      listContainer.innerHTML = '';
      if (visibleNotifications.length === 0) {
        listContainer.innerHTML = `<div class="alert alert-warning text-center">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é€šçŸ¥ã€‚</div>`;
        updateUnreadBadge();
        return;
      }

      // ç¢ºä¿åˆ†çµ„é †åºï¼šä»Šå¤©ã€æ˜¨å¤©ã€æœ¬é€±ã€æ›´æ—©
      const order = ['ä»Šå¤©', 'æ˜¨å¤©', 'æœ¬é€±', 'æ›´æ—©ä¹‹å‰'];
      order.forEach(label => {
        if (!groups[label]) return;
        const section = document.createElement('div');

        // æ‡‰ç”¨ç•¶å‰æ’åºåˆ°è©²çµ„é€šçŸ¥
        const currentGroup = groups[label];
        currentGroup.sort((a, b) => {
          const dateA = new Date(a.created_at);
          const dateB = new Date(b.created_at);
          return currentSortOrder === 'desc' ? dateB - dateA : dateA - dateB;
        });

        // Group Header
        const header = document.createElement('div');
        header.className = 'group-header';

        const sortControls = document.createElement('div');
        sortControls.className = 'sort-btn-group';
        sortControls.innerHTML = `
            <div class="small muted">æŒ‰æ™‚é–“æ’åº</div>
            <button class="sort-btn ${currentSortOrder === 'desc' ? 'active' : ''}" data-sort-order="desc" title="é™å†ªæ’åºï¼ˆæ–°åˆ°èˆŠï¼‰">
                <i class="bi-arrow-down-short"></i>
            </button>
            <button class="sort-btn ${currentSortOrder === 'asc' ? 'active' : ''}" data-sort-order="asc" title="å‡å†ªæ’åºï¼ˆèˆŠåˆ°æ–°ï¼‰">
                <i class="bi-arrow-up-short"></i>
            </button>
        `;

        // æ’åºæŒ‰éˆ•äº‹ä»¶
        sortControls.querySelector('[data-sort-order="desc"]').onclick = () => { currentSortOrder = 'desc'; render(); };
        sortControls.querySelector('[data-sort-order="asc"]').onclick = () => { currentSortOrder = 'asc'; render(); };

        const titleSpan = document.createElement('div');
        titleSpan.className = 'group-title';
        titleSpan.innerHTML = `${label} <span class="muted small">ï¼ˆ${currentGroup.length}ï¼‰</span>`;

        header.appendChild(titleSpan);
        header.appendChild(sortControls);
        section.appendChild(header);

        const groupBody = document.createElement('div');
        groupBody.style.marginTop = '8px';

        // render notifications in this group
        currentGroup.forEach(n => {
          const card = document.createElement('div');
          
          // åˆ¤æ–·å…¬å‘Šç‹€æ…‹ï¼ˆåƒ…å°ç§‘åŠ©åœ¨ã€Œæ™‚ç¨‹ã€é¡åˆ¥ä¸­ï¼‰
          let announcementStatus = '';
          const isTACheck = document.getElementById('ta-actions')?.style.display === 'flex';
          const isApprovalCategoryCheck = currentCategoryFilter === 'approval';
          const isAnnouncementCheck = n.category === 'announcement' || 
            (n.title.includes('å…¬å‘Š') && !n.title.includes('é¢è©¦é€šçŸ¥') && !n.title.includes('éŒ„å–é€šçŸ¥'));
          
          if (isTACheck && isApprovalCategoryCheck && isAnnouncementCheck) {
            const now = new Date();
            let isStarted = true;
            let isEnded = false;
            
            if (n.start_time) {
              try {
                const startTime = new Date(n.start_time);
                isStarted = startTime <= now;
              } catch (e) {
                isStarted = true;
              }
            }
            
            if (n.end_time) {
              try {
                const endTime = new Date(n.end_time);
                isEnded = endTime < now;
              } catch (e) {
                isEnded = false;
              }
            }
            
            if (!isStarted) {
              announcementStatus = ' announcement-not-started';
            } else if (isEnded) {
              announcementStatus = ' announcement-ended';
            }
          }
          
          card.className = 'notif-card ' + (n.is_read ? 'notif-read' : 'notif-unread') + (n.pinned ? ' pinned' : '') + announcementStatus;
          card.dataset.id = n.id;

          const left = document.createElement('div'); left.className = 'notif-left';
          const avatar = document.createElement('div'); avatar.className = 'avatar';
          // æ ¹æ“šæ¨™é¡Œå…§å®¹æ±ºå®šé¡¯ç¤ºçš„å­—ï¼šéŒ„å–é€šçŸ¥é¡¯ç¤ºã€ŒéŒ„ã€ï¼Œå±¥æ­·ç›¸é—œé¡¯ç¤ºã€Œå±¥ã€ï¼Œé¢è©¦é€šçŸ¥é¡¯ç¤ºã€Œé¢ã€
          let avatarText = '';
          const title = n.title || '';
          if (title.includes('éŒ„å–')) {
            avatarText = 'éŒ„';
          } else if (title.includes('å±¥æ­·')) {
            avatarText = 'å±¥';
          } else if (title.includes('é¢è©¦')) {
            avatarText = 'é¢';
          } else {
            // å…¶ä»–æƒ…æ³å–ç¬¬ä¸€å€‹éç¬¦è™Ÿçš„å­—
            const firstChar = title.replace(/^[ã€\[\]()ï¼ˆï¼‰\s]+/, '').slice(0, 1);
            avatarText = firstChar || title.slice(0, 1) || '';
          }
          avatar.innerText = avatarText;
          left.appendChild(avatar);

          const body = document.createElement('div'); body.className = 'notif-body';
          const t = document.createElement('div'); t.className = 'notif-title';
          // tag badges
          let tagHtml = '';
          if (n.tags && n.tags.length) {
            n.tags.forEach(tag => {
              tagHtml += `<span class="badge bg-light text-muted badge-tag">#${tag}</span>`;
            });
          }
          t.innerHTML = `${tagHtml} ${n.title}`;
          const meta = document.createElement('div'); meta.className = 'notif-meta d-flex justify-content-between align-items-center';
          meta.innerHTML = `<div class="small muted">${getCategoryLabel(n.category, n.title)}</div><div class="small muted">${formatDateTime(n.created_at)}</div>`;

          body.appendChild(t);
          body.appendChild(meta);

          // actions area
          const actions = document.createElement('div');
          actions.className = 'meta-actions ms-2';

          // ã€ç§»é™¤ã€‘æ¨™ç‚ºå·²è®€æŒ‰éˆ•

          const btnPin = document.createElement('button');
          btnPin.className = 'btn btn-sm btn-outline-secondary';
          btnPin.innerHTML = '<i class="bi-pin-angle"></i>';
          btnPin.title = 'ç½®é ‚';
          btnPin.onclick = (e) => { e.stopPropagation(); togglePin(n.id); };

          // å¦‚æœæ˜¯ã€Œæ™‚ç¨‹ã€é¡åˆ¥ä¸­çš„å…¬å‘Šï¼Œä¸”æ˜¯ç§‘åŠ©ï¼Œæ·»åŠ ç·¨è¼¯æŒ‰éˆ•
          const isApprovalCategory = currentCategoryFilter === 'approval';
          const isAnnouncement = n.category === 'announcement' || 
            (n.title.includes('å…¬å‘Š') && !n.title.includes('é¢è©¦é€šçŸ¥') && !n.title.includes('éŒ„å–é€šçŸ¥'));
          const isTA = document.getElementById('ta-actions')?.style.display === 'flex';
          
          if (isApprovalCategory && isAnnouncement && isTA) {
            const btnEdit = document.createElement('button');
            btnEdit.className = 'btn btn-sm btn-outline-primary me-1';
            btnEdit.innerHTML = '<i class="bi-pencil"></i>';
            btnEdit.title = 'ç·¨è¼¯å…¬å‘Š';
            btnEdit.onclick = async (e) => { 
              e.stopPropagation(); 
              await editAnnouncementFromNotification(n); 
            };
            actions.appendChild(btnEdit);
          }

          const btnMore = document.createElement('button');
          btnMore.className = 'btn btn-sm btn-outline-secondary';
          btnMore.innerHTML = '<i class="bi-three-dots"></i>';
          btnMore.title = 'è©³ç´°/æ“ä½œ';
          btnMore.onclick = (e) => { e.stopPropagation(); showModal(n); }; // ã€ä¿®æ”¹ã€‘é–‹å•Ÿ Modal

          actions.appendChild(btnPin);
          actions.appendChild(btnMore);

          // combine
          card.appendChild(left);
          card.appendChild(body);
          card.appendChild(actions);

          // whole card click opens modal (detailed)
          card.addEventListener('click', () => { showModal(n); });

          groupBody.appendChild(card);
        });

        section.appendChild(groupBody);
        listContainer.appendChild(section);
      });

      updateUnreadBadge();
    }

    // ---------- æ“ä½œå‡½å¼ ----------
    async function markRead(id) {
      const item = allNotifications.find(x => String(x.id) === String(id));
      if (!item || item.is_read) return;
      item.is_read = true;
      render();
      try { await fetch(`/api/mark_read/${id}`, { method: 'POST' }); } catch (err) { console.warn('markRead api failed', err); }
    }

    function togglePin(id) {
      const item = allNotifications.find(x => String(x.id) === String(id));
      if (!item) return;
      item.pinned = !item.pinned;
      if (item.pinned) pinnedSet.add(String(id)); else pinnedSet.delete(String(id));
      localStorage.setItem('notif_pinned', JSON.stringify(Array.from(pinnedSet)));

      allNotifications.sort((a, b) => {
        if ((a.pinned ? 1 : 0) !== (b.pinned ? 1 : 0)) return (b.pinned ? 1 : 0) - (a.pinned ? 1 : 0);
        if ((a.is_read ? 1 : 0) !== (b.is_read ? 1 : 0)) return (a.is_read ? 1 : 0) - (b.is_read ? 1 : 0);
        return new Date(b.created_at) - new Date(a.created_at);
      });
      render();
    }

    async function deleteNotif(id) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡é€šçŸ¥ï¼Ÿ')) return;
      allNotifications = allNotifications.filter(x => String(x.id) !== String(id));
      render();
      try { await fetch(`/api/notification/delete/${id}`, { method: 'DELETE' }); } catch (err) { console.warn('delete api failed', err); }
      notifModal.hide(); // åˆªé™¤å¾Œé—œé–‰ Modal
    }

    // ã€ä¿®æ”¹ã€‘show bootstrap modal
    function showModal(n) {
      // ã€éœ€æ±‚ã€‘é»é–‹ Modal æ™‚è‡ªå‹•æ¨™ç‚ºå·²è®€
      if (!n.is_read) markRead(n.id);

      modalTitle.innerText = n.title;
      // é¡¯ç¤ºé€šçŸ¥å…§å®¹
      modalBody.innerHTML = `
        <div class="small muted mb-2">æ™‚é–“: ${formatDateTime(n.created_at)} | é¡åˆ¥: ${getCategoryLabel(n.category, n.title)}</div>
        <p style="white-space:pre-wrap;">${n.message}</p>
      `;

      // è™•ç†ã€Œå‰å¾€å…§å®¹ã€æŒ‰éˆ•
      if (n.url) {
        modalLink.href = n.url;
        modalLink.style.display = 'inline-block';
        // é»æ“Šå‰å¾€å¾Œé—œé–‰ Modal
        modalLink.onclick = () => { notifModal.hide(); };
      } else {
        modalLink.style.display = 'none';
      }

      // è™•ç†ã€Œåˆªé™¤ã€æŒ‰éˆ•
      modalDelete.onclick = () => { deleteNotif(n.id); };

      notifModal.show();
    }

    // unread badge update
    function updateUnreadBadge() {
      const count = allNotifications.filter(n => !n.is_read).length;
      // æ›´æ–°å³ä¸Šè§’å¾½ç« ï¼ˆå…¶ä»–è§’è‰²ï¼‰
      if (unreadCounterTopRight) {
        unreadCounterTopRight.innerText = count;
      }
      // æ›´æ–°æœå°‹æ¬„æ—çš„å¾½ç« ï¼ˆç§‘åŠ©ï¼‰
      if (unreadCounterSearchRow) {
        unreadCounterSearchRow.innerText = count;
      }
      // æ›´æ–°é¡åˆ¥æ—çš„å¾½ç« ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      const unreadCounterTA = document.getElementById('unreadCounterTA');
      if (unreadCounterTA) {
        unreadCounterTA.innerText = count;
      }
      document.title = count ? `(${count}) é€šçŸ¥ä¸­å¿ƒ` : 'é€šçŸ¥ä¸­å¿ƒ';
    }


    // ---------- äº‹ä»¶è™•ç†èˆ‡åˆå§‹åŒ– ----------

    // search input
    searchInput.addEventListener('input', () => render());

    // ä¸‹æ‹‰é¸å–®ç¯©é¸é‚è¼¯
    document.querySelectorAll('#filterDropdownBtn').forEach(btn => {
      const menu = btn.nextElementSibling;
      if (menu) {
        menu.querySelectorAll('a').forEach(item => {
          item.addEventListener('click', (e) => {
            e.preventDefault();
            const filter = e.currentTarget.dataset.filter;
            if (filter) {
              currentReadFilter = filter;
              menu.querySelectorAll('a').forEach(i => i.classList.remove('active'));
              e.currentTarget.classList.add('active');

              // æ›´æ–°æŒ‰éˆ•æ¨™ç±¤
              currentFilterLabel.innerText = e.currentTarget.innerText.replace('ğŸ“Œ', '').trim();

              render();
            }
          });
        });
      }
    });

    // ç‹€æ…‹ä¸‹æ‹‰é¸å–®ç¯©é¸é‚è¼¯ï¼ˆåœ¨é é¢è¼‰å…¥æ™‚ç¶å®šï¼‰
    function bindStatusDropdownEvents() {
      const statusDropdownBtn = document.getElementById('statusDropdownBtn');
      if (statusDropdownBtn) {
        const statusMenu = statusDropdownBtn.nextElementSibling;
        if (statusMenu) {
          // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
          statusMenu.querySelectorAll('a').forEach(item => {
            const newItem = item.cloneNode(true);
            item.parentNode.replaceChild(newItem, item);
          });
          
          // é‡æ–°ç¶å®šäº‹ä»¶
          statusMenu.querySelectorAll('a').forEach(item => {
            item.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              const status = e.currentTarget.dataset.status;
              if (status) {
                currentStatusFilter = status;
                statusMenu.querySelectorAll('a').forEach(i => i.classList.remove('active'));
                e.currentTarget.classList.add('active');

                // æ›´æ–°æŒ‰éˆ•æ¨™ç±¤
                const currentStatusLabel = document.getElementById('currentStatusLabel');
                if (currentStatusLabel) {
                  currentStatusLabel.innerText = e.currentTarget.innerText.trim();
                }

                // æ ¹æ“šé¸æ“‡çš„ç‹€æ…‹è‡ªå‹•åˆ‡æ›åˆ°å°æ‡‰çš„é¡åˆ¥é é¢
                if (status === 'ongoing') {
                  // é¸æ“‡ã€Œé€²è¡Œä¸­ã€â†’ è·³è½‰åˆ°ã€Œå…¨éƒ¨é€šçŸ¥ã€é¡åˆ¥
                  currentCategoryFilter = 'all';
                  document.querySelectorAll('#categoryFilter .chip').forEach(b => b.classList.remove('active'));
                  const allChip = document.querySelector('#categoryFilter .chip[data-category="all"]');
                  if (allChip) {
                    allChip.classList.add('active');
                  }
                } else if (status === 'not-started' || status === 'ended') {
                  // é¸æ“‡ã€Œæœªé–‹å§‹ã€æˆ–ã€Œå·²çµæŸã€â†’ è·³è½‰åˆ°ã€Œæ™‚ç¨‹ã€é¡åˆ¥
                  currentCategoryFilter = 'approval';
                  document.querySelectorAll('#categoryFilter .chip').forEach(b => b.classList.remove('active'));
                  const approvalChip = document.querySelector('#categoryFilter .chip[data-category="approval"]');
                  if (approvalChip) {
                    approvalChip.classList.add('active');
                  }
                }

                // ç«‹å³è§¸ç™¼é‡æ–°æ¸²æŸ“
                render();
              }
            });
          });
        }
      }
    }
    
    // åˆå§‹ç¶å®š
    bindStatusDropdownEvents();

    // é¡åˆ¥ç¯©é¸
    document.querySelectorAll('#categoryFilter .chip').forEach(btn => {
      btn.addEventListener('click', (e) => {
        currentCategoryFilter = e.currentTarget.dataset.category || 'all';
        document.querySelectorAll('#categoryFilter .chip').forEach(b => b.classList.remove('active'));
        e.currentTarget.classList.add('active');
        render();
      });
    });

    // å…¶ä»– UI actions
    // é‡æ–°æ•´ç†æŒ‰éˆ•å·²ç§»é™¤

    // ã€ç§»é™¤ã€‘document.getElementById('openAll') äº‹ä»¶

    // ã€ç§»é™¤ã€‘document.getElementById('drawerClose') äº‹ä»¶

    // æ¸…é™¤æ‰€æœ‰ç½®é ‚
    document.getElementById('clearPinned').addEventListener('click', (e) => {
      e.preventDefault();
      if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç½®é ‚å—ï¼Ÿ')) return;
      pinnedSet.clear();
      localStorage.setItem('notif_pinned', JSON.stringify([]));
      allNotifications.forEach(n => n.pinned = false);
      render();
    });

    // ã€ç§»é™¤ã€‘close drawer when clicking outside ç›¸é—œäº‹ä»¶

    // ---------- ç§‘åŠ©å°ˆç”¨åŠŸèƒ½ï¼šå…¬å‘Šç®¡ç† ----------
    let prefDeadlineModal, resumeDeadlineModal, annModal;
    let editId = null;

    // å¾é€šçŸ¥ç·¨è¼¯å…¬å‘Šï¼ˆå…¨å±€å‡½æ•¸ï¼Œå¯åœ¨æ¸²æŸ“æ™‚èª¿ç”¨ï¼‰
    async function editAnnouncementFromNotification(notification) {
      try {
        // ç¢ºä¿ Modal å·²åˆå§‹åŒ–
        if (!annModal) {
          annModal = new bootstrap.Modal(document.getElementById('annModal'));
        }
        
        // å¾ link_url æå–å…¬å‘Š ID
        let annId = null;
        if (notification.url || notification.link_url) {
          const linkUrl = notification.url || notification.link_url;
          const match = linkUrl.match(/\/view_announcement\/(\d+)/);
          if (match) {
            annId = parseInt(match[1]);
          }
        } else if (String(notification.id).startsWith('ann_')) {
          annId = parseInt(String(notification.id).replace('ann_', ''));
        }
        
        if (!annId) {
          alert('ç„¡æ³•ç²å–å…¬å‘ŠID');
          return;
        }
        
        // ç²å–å…¬å‘Šè©³æƒ…
        const res = await fetch(`/announcement/api/get/${annId}`);
        const result = await res.json();
        
        if (!result.success || !result.data) {
          alert('ç„¡æ³•è¼‰å…¥å…¬å‘Šè©³æƒ…ï¼š' + (result.message || 'æœªçŸ¥éŒ¯èª¤'));
          return;
        }
        
        const ann = result.data;
        editId = annId;
        document.getElementById('annModalTitle').innerText = 'ç·¨è¼¯å…¬å‘Š';
        document.getElementById('ann-title').value = ann.title || '';
        document.getElementById('ann-content').value = ann.content || '';
        
        // æ ¼å¼åŒ–æ™‚é–“ç‚º datetime-local æ ¼å¼ (YYYY-MM-DDTHH:mm)
        if (ann.start_time) {
          // è™•ç†å„ç¨®æ™‚é–“æ ¼å¼
          let startTimeStr = ann.start_time;
          if (startTimeStr.includes(' ')) {
            startTimeStr = startTimeStr.replace(' ', 'T').substring(0, 16);
          } else if (startTimeStr.includes('T')) {
            startTimeStr = startTimeStr.substring(0, 16);
          }
          document.getElementById('ann-start').value = startTimeStr;
        } else {
          document.getElementById('ann-start').value = '';
        }
        
        if (ann.end_time) {
          // è™•ç†å„ç¨®æ™‚é–“æ ¼å¼
          let endTimeStr = ann.end_time;
          if (endTimeStr.includes(' ')) {
            endTimeStr = endTimeStr.replace(' ', 'T').substring(0, 16);
          } else if (endTimeStr.includes('T')) {
            endTimeStr = endTimeStr.substring(0, 16);
          }
          document.getElementById('ann-end').value = endTimeStr;
        } else {
          document.getElementById('ann-end').value = '';
        }
        
        // è¼‰å…¥ç™¼é€å°è±¡ï¼ˆå¦‚æœå¾Œç«¯æœ‰è¿”å›ï¼‰
        const annTargetRoles = document.getElementById('ann-target-roles');
        if (annTargetRoles) {
          annTargetRoles.value = '';
          if (ann.target_roles && Array.isArray(ann.target_roles) && ann.target_roles.length > 0) {
            const firstRole = ann.target_roles[0];
            const option = Array.from(annTargetRoles.options).find(opt => opt.value === firstRole);
            if (option) {
              annTargetRoles.value = firstRole;
            }
          }
        }
        
        // é¡¯ç¤º Modal
        annModal.show();
      } catch (error) {
        console.error('è¼‰å…¥å…¬å‘Šè©³æƒ…å¤±æ•—:', error);
        alert('è¼‰å…¥å…¬å‘Šè©³æƒ…å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼š' + error.message);
      }
    }

    function initTAActions() {
      // åˆå§‹åŒ– Modal
      const publishTypeModal = new bootstrap.Modal(document.getElementById('publishTypeModal'));
      prefDeadlineModal = new bootstrap.Modal(document.getElementById('prefDeadlineModal'));
      resumeDeadlineModal = new bootstrap.Modal(document.getElementById('resumeDeadlineModal'));
      annModal = new bootstrap.Modal(document.getElementById('annModal'));

      // ç™¼å¸ƒå…¬å‘Šèˆ‡æˆªæ­¢æ™‚é–“æŒ‰éˆ•
      document.getElementById('btn-publish').onclick = () => {
        publishTypeModal.show();
      };

      // é¸æ“‡æ–°å¢å…¬å‘Š
      document.getElementById('btn-select-announcement').onclick = () => {
        publishTypeModal.hide();
        editId = null;
        document.getElementById('annModalTitle').innerText = 'æ–°å¢å…¬å‘Š';
        document.querySelectorAll('#annModal input:not([type=checkbox]), textarea').forEach(i => i.value = '');
        // é‡ç½®ç™¼é€å°è±¡ä¸‹æ‹‰é¸å–®
        const annTargetRoles = document.getElementById('ann-target-roles');
        Array.from(annTargetRoles.options).forEach(opt => opt.selected = false);
        setTimeout(() => {
          annModal.show();
        }, 300);
      };

      // é¸æ“‡å¡«å¯«å¿—é¡˜åºæˆªæ­¢æ™‚é–“
      document.getElementById('btn-select-pref-deadline').onclick = () => {
        publishTypeModal.hide();
        document.getElementById('pref-title').value = '[ä½œæ¥­]å¡«å¯«å¿—é¡˜åºæˆªæ­¢æ™‚é–“';
        document.getElementById('pref-content').value = 'è«‹æ³¨æ„!å¡«å¯«å¿—é¡˜åºçš„æˆªæ­¢æ™‚é–“ç‚º:è«‹é¸æ“‡çµæŸæ™‚é–“,è«‹å‹™å¿…åœ¨æˆªæ­¢æ™‚é–“å‰å®Œæˆå¿—é¡˜åºå¡«å¯«ã€‚';
        document.getElementById('pref-start').value = '';
        document.getElementById('pref-end').value = '';
        // é‡ç½®ç™¼é€å°è±¡ä¸‹æ‹‰é¸å–®
        const prefTargetRoles = document.getElementById('pref-target-roles');
        if (prefTargetRoles) prefTargetRoles.value = '';
        setTimeout(() => {
          prefDeadlineModal.show();
        }, 300);
      };

      // é¸æ“‡ä¸Šå‚³å±¥æ­·æˆªæ­¢æ™‚é–“
      document.getElementById('btn-select-resume-deadline').onclick = () => {
        publishTypeModal.hide();
        document.getElementById('resume-title').value = '[ä½œæ¥­]ä¸Šå‚³å±¥æ­·æˆªæ­¢æ™‚é–“';
        document.getElementById('resume-content').value = 'è«‹æ³¨æ„!ä¸Šå‚³å±¥æ­·çš„æˆªæ­¢æ™‚é–“ç‚º:è«‹é¸æ“‡çµæŸæ™‚é–“,è«‹å‹™å¿…åœ¨æˆªæ­¢æ™‚é–“å‰å®Œæˆå±¥æ­·ä¸Šå‚³ã€‚';
        document.getElementById('resume-start').value = '';
        document.getElementById('resume-end').value = '';
        // é‡ç½®ç™¼é€å°è±¡ä¸‹æ‹‰é¸å–®
        const resumeTargetRoles = document.getElementById('resume-target-roles');
        if (resumeTargetRoles) resumeTargetRoles.value = '';
        setTimeout(() => {
          resumeDeadlineModal.show();
        }, 300);
      };

      // ç•¶çµæŸæ™‚é–“æ”¹è®Šæ™‚ï¼Œè‡ªå‹•æ›´æ–°å…§å®¹ä¸­çš„æˆªæ­¢æ™‚é–“
      document.getElementById('pref-end').addEventListener('change', function() {
        const endTime = this.value;
        if (endTime) {
          const formattedTime = endTime.replace('T', ' ');
          const content = document.getElementById('pref-content');
          content.value = `è«‹æ³¨æ„!å¡«å¯«å¿—é¡˜åºçš„æˆªæ­¢æ™‚é–“ç‚º:${formattedTime},è«‹å‹™å¿…åœ¨æˆªæ­¢æ™‚é–“å‰å®Œæˆå¿—é¡˜åºå¡«å¯«ã€‚`;
        }
      });

      document.getElementById('resume-end').addEventListener('change', function() {
        const endTime = this.value;
        if (endTime) {
          const formattedTime = endTime.replace('T', ' ');
          const content = document.getElementById('resume-content');
          content.value = `è«‹æ³¨æ„!ä¸Šå‚³å±¥æ­·çš„æˆªæ­¢æ™‚é–“ç‚º:${formattedTime},è«‹å‹™å¿…åœ¨æˆªæ­¢æ™‚é–“å‰å®Œæˆå±¥æ­·ä¸Šå‚³ã€‚`;
        }
      });

      // å„²å­˜å¡«å¯«å¿—é¡˜åºæˆªæ­¢æ™‚é–“
      document.getElementById('btn-save-pref-deadline').onclick = async () => {
        const title = document.getElementById('pref-title').value;
        const content = document.getElementById('pref-content').value;
        const startTime = document.getElementById('pref-start').value;
        const endTime = document.getElementById('pref-end').value;
        const prefTargetSelect = document.getElementById('pref-target-roles');
        const targetRole = prefTargetSelect ? prefTargetSelect.value : '';
        
        if (!title || !startTime || !endTime) {
          alert('è«‹å®Œæ•´å¡«å¯«æ¨™é¡Œã€é–‹å§‹æ™‚é–“èˆ‡çµæŸæ™‚é–“');
          return;
        }
        
        if (!targetRole) {
          alert('è«‹é¸æ“‡ç™¼é€å°è±¡');
          return;
        }

        try {
          const res = await fetch('/announcement/api/save_deadlines', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              pref_deadline: endTime,
              title: title,
              content: content,
              start_time: startTime.replace('T', ' '),
              end_time: endTime.replace('T', ' '),
              target_roles: [targetRole]
            })
          });

          const result = await res.json();
          
          if (result.success) {
            prefDeadlineModal.hide();
            // é‡ç½®ç¯©é¸æ¢ä»¶ï¼Œç¢ºä¿æ–°é€šçŸ¥å¯è¦‹
            currentCategoryFilter = 'all';
            currentReadFilter = 'all';
            document.querySelectorAll('#categoryFilter .chip').forEach(b => b.classList.remove('active'));
            document.querySelector('#categoryFilter .chip[data-category="all"]')?.classList.add('active');
            document.querySelectorAll('.dropdown-menu a').forEach(i => i.classList.remove('active'));
            document.querySelector('.dropdown-menu a[data-filter="all"]')?.classList.add('active');
            currentFilterLabel.innerText = 'å…¨éƒ¨';
            // é‡æ–°è¼‰å…¥é€šçŸ¥åˆ—è¡¨
            await loadNotifications();
            alert('å„²å­˜æˆåŠŸï¼æ–°é€šçŸ¥å·²å‡ºç¾åœ¨åˆ—è¡¨ä¸­ã€‚');
          } else {
            alert('å„²å­˜å¤±æ•—ï¼š' + (result.message || 'æœªçŸ¥éŒ¯èª¤'));
          }
        } catch (error) {
          console.error('å„²å­˜æˆªæ­¢æ™‚é–“å¤±æ•—:', error);
          alert('å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
      };

      // å„²å­˜ä¸Šå‚³å±¥æ­·æˆªæ­¢æ™‚é–“
      document.getElementById('btn-save-resume-deadline').onclick = async () => {
        const title = document.getElementById('resume-title').value;
        const content = document.getElementById('resume-content').value;
        const startTime = document.getElementById('resume-start').value;
        const endTime = document.getElementById('resume-end').value;
        const resumeTargetSelect = document.getElementById('resume-target-roles');
        const targetRole = resumeTargetSelect ? resumeTargetSelect.value : '';
        
        if (!title || !startTime || !endTime) {
          alert('è«‹å®Œæ•´å¡«å¯«æ¨™é¡Œã€é–‹å§‹æ™‚é–“èˆ‡çµæŸæ™‚é–“');
          return;
        }
        
        if (!targetRole) {
          alert('è«‹é¸æ“‡ç™¼é€å°è±¡');
          return;
        }

        try {
          const res = await fetch('/announcement/api/save_deadlines', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              resume_deadline: endTime,
              title: title,
              content: content,
              start_time: startTime.replace('T', ' '),
              end_time: endTime.replace('T', ' '),
              target_roles: [targetRole]
            })
          });

          const result = await res.json();
          
          if (result.success) {
            resumeDeadlineModal.hide();
            // é‡ç½®ç¯©é¸æ¢ä»¶ï¼Œç¢ºä¿æ–°é€šçŸ¥å¯è¦‹
            currentCategoryFilter = 'all';
            currentReadFilter = 'all';
            document.querySelectorAll('#categoryFilter .chip').forEach(b => b.classList.remove('active'));
            document.querySelector('#categoryFilter .chip[data-category="all"]')?.classList.add('active');
            document.querySelectorAll('.dropdown-menu a').forEach(i => i.classList.remove('active'));
            document.querySelector('.dropdown-menu a[data-filter="all"]')?.classList.add('active');
            currentFilterLabel.innerText = 'å…¨éƒ¨';
            // é‡æ–°è¼‰å…¥é€šçŸ¥åˆ—è¡¨
            await loadNotifications();
            alert('å„²å­˜æˆåŠŸï¼æ–°é€šçŸ¥å·²å‡ºç¾åœ¨åˆ—è¡¨ä¸­ã€‚');
          } else {
            alert('å„²å­˜å¤±æ•—ï¼š' + (result.message || 'æœªçŸ¥éŒ¯èª¤'));
          }
        } catch (error) {
          console.error('å„²å­˜æˆªæ­¢æ™‚é–“å¤±æ•—:', error);
          alert('å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
      };

      // å„²å­˜æ–°å¢/ç·¨è¼¯å…¬å‘Š
      document.getElementById('btn-save-ann').onclick = async () => {
        const annTargetSelect = document.getElementById('ann-target-roles');
        const targetRole = annTargetSelect ? annTargetSelect.value : '';
        
        let target_roles = [];
        if (targetRole === 'all') {
          target_roles = ['student', 'teacher', 'director', 'class_teacher'];
        } else if (targetRole) {
          target_roles = [targetRole];
        }
        
        const payload = {
          title: document.getElementById('ann-title').value,
          content: document.getElementById('ann-content').value,
          start_time: document.getElementById('ann-start').value.replace('T', ' '),
          end_time: document.getElementById('ann-end').value.replace('T', ' '),
          is_published: 1,  // æ–°å¢/ç·¨è¼¯å…¬å‘Šæ™‚é è¨­ç‚ºå·²ç™¼å¸ƒï¼Œç«‹å³åŒæ­¥åˆ°é€šçŸ¥åˆ—è¡¨
          target_roles: target_roles
        };
        
        if (!payload.title || !payload.start_time || !payload.end_time) {
          alert('è«‹å®Œæ•´å¡«å¯«æ¨™é¡Œã€é–‹å§‹æ™‚é–“èˆ‡çµæŸæ™‚é–“');
          return;
        }
        
        if (!targetRole) {
          alert('è«‹é¸æ“‡ç™¼é€å°è±¡');
          return;
        }

        const url = editId ? `/announcement/api/update/${editId}` : '/announcement/api/create';
        const isEditing = !!editId;
        try {
          const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const result = await res.json();
          if (result.success) {
            annModal.hide();
            // å¦‚æœæ˜¯åœ¨ã€Œæ™‚ç¨‹ã€é¡åˆ¥ä¸­ç·¨è¼¯ï¼Œä¿å­˜å¾Œä¿æŒåœ¨ã€Œæ™‚ç¨‹ã€é¡åˆ¥
            const wasInApprovalCategory = currentCategoryFilter === 'approval';
            
            if (!wasInApprovalCategory) {
              // å¦‚æœä¸æ˜¯åœ¨ã€Œæ™‚ç¨‹ã€é¡åˆ¥ï¼Œé‡ç½®ç¯©é¸æ¢ä»¶
              currentCategoryFilter = 'all';
              currentReadFilter = 'all';
              document.querySelectorAll('#categoryFilter .chip').forEach(b => b.classList.remove('active'));
              document.querySelector('#categoryFilter .chip[data-category="all"]')?.classList.add('active');
              document.querySelectorAll('.dropdown-menu a').forEach(i => i.classList.remove('active'));
              document.querySelector('.dropdown-menu a[data-filter="all"]')?.classList.add('active');
              currentFilterLabel.innerText = 'å…¨éƒ¨';
            }
            
            // é‡ç½®ç·¨è¼¯ ID
            editId = null;
            
            // é‡æ–°è¼‰å…¥é€šçŸ¥åˆ—è¡¨
            await loadNotifications();
            alert('å„²å­˜æˆåŠŸï¼' + (isEditing ? 'å…¬å‘Šå·²æ›´æ–°ã€‚' : 'æ–°é€šçŸ¥å·²å‡ºç¾åœ¨åˆ—è¡¨ä¸­ã€‚'));
          } else {
            alert('å„²å­˜å¤±æ•—ï¼š' + (result.message || 'æœªçŸ¥éŒ¯èª¤'));
          }
        } catch (error) {
          console.error('å„²å­˜å…¬å‘Šå¤±æ•—:', error);
          alert('å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
      };
    }

    // ---------- å‹•æ…‹ç”Ÿæˆé¸å–® ----------
    function renderMenu() {
      const menuContent = document.getElementById('menu-content');
      if (!menuContent) return;

      // ç²å–ç”¨æˆ¶è§’è‰²
      fetch('/api/profile')
        .then(res => res.json())
        .then(profileData => {
          const userRole = profileData.success && profileData.user ? profileData.user.role : null;
          const displayRole = profileData.success && profileData.user ? profileData.user.display_role : null;
          const isHomeroom = profileData.success && profileData.user ? (profileData.user.is_homeroom === true) : false;

          // å¦‚æœæ˜¯ç§‘åŠ©ï¼Œé¡¯ç¤ºæŒ‰éˆ•ä¸¦åˆå§‹åŒ–åŠŸèƒ½
          const taActions = document.getElementById('ta-actions');
          const approvalFilter = document.getElementById('approval-filter');
          const statusDropdown = document.getElementById('statusDropdown');
          const unreadBadgeTopRight = document.getElementById('unreadBadgeTopRight');
          const unreadBadgeSearchRow = document.getElementById('unreadBadgeSearchRow');
          const unreadBadgeTA = document.getElementById('unreadBadgeTA');
          
          if (userRole === 'ta') {
            if (taActions) {
              taActions.style.display = 'flex';
              taActions.style.justifyContent = 'flex-end';
            }
            // é¡¯ç¤ºã€Œæ™‚ç¨‹ã€é¡åˆ¥ç¯©é¸å™¨
            if (approvalFilter) {
              approvalFilter.style.display = 'block';
            }
            // é¡¯ç¤ºç‹€æ…‹ä¸‹æ‹‰é¸å–®
            if (statusDropdown) {
              statusDropdown.style.display = 'block';
              // é‡æ–°ç¶å®šç‹€æ…‹ä¸‹æ‹‰é¸å–®äº‹ä»¶ï¼ˆç¢ºä¿äº‹ä»¶æ­£ç¢ºç¶å®šï¼‰
              setTimeout(() => {
                bindStatusDropdownEvents();
              }, 100);
            }
            // ç§‘åŠ©ï¼šéš±è—å³ä¸Šè§’å¾½ç« ï¼Œé¡¯ç¤ºæœå°‹æ¬„æ—çš„å¾½ç« ï¼Œéš±è—é¡åˆ¥æ—çš„å¾½ç« 
            if (unreadBadgeTopRight) {
              unreadBadgeTopRight.style.display = 'none';
            }
            if (unreadBadgeSearchRow) {
              unreadBadgeSearchRow.style.display = 'flex';
            }
            if (unreadBadgeTA) {
              unreadBadgeTA.style.display = 'none';
            }
            initTAActions();
          } else {
            // å…¶ä»–è§’è‰²éš±è—æŒ‰éˆ•å’Œã€Œæ™‚ç¨‹ã€é¡åˆ¥
            if (taActions) {
              taActions.style.display = 'none';
            }
            // éš±è—ã€Œæ™‚ç¨‹ã€é¡åˆ¥ç¯©é¸å™¨
            if (approvalFilter) {
              approvalFilter.style.display = 'none';
            }
            // éš±è—ç‹€æ…‹ä¸‹æ‹‰é¸å–®
            if (statusDropdown) {
              statusDropdown.style.display = 'none';
            }
            // å…¶ä»–è§’è‰²ï¼šé¡¯ç¤ºå³ä¸Šè§’å¾½ç« ï¼Œéš±è—æœå°‹æ¬„æ—çš„å¾½ç« ï¼Œéš±è—é¡åˆ¥æ—çš„å¾½ç« 
            if (unreadBadgeTopRight) {
              unreadBadgeTopRight.style.display = 'block';
            }
            if (unreadBadgeSearchRow) {
              unreadBadgeSearchRow.style.display = 'none';
            }
            if (unreadBadgeTA) {
              unreadBadgeTA.style.display = 'none';
            }
            // å¦‚æœç•¶å‰é¸ä¸­ã€Œæ™‚ç¨‹ã€é¡åˆ¥ï¼Œåˆ‡æ›å›ã€Œå…¨éƒ¨é€šçŸ¥ã€
            if (currentCategoryFilter === 'approval') {
              currentCategoryFilter = 'all';
              document.querySelectorAll('#categoryFilter .chip').forEach(b => b.classList.remove('active'));
              document.querySelector('#categoryFilter .chip[data-category="all"]')?.classList.add('active');
              render();
            }
          }

          let menuItems = [];

          if (userRole === 'student') {
            // å­¸ç”Ÿé¸å–®
            menuItems = [
              { href: '/student_home', text: 'é¦–é ' },
              { href: '/profile', text: 'å€‹äººè³‡æ–™' },
              { href: '/upload_resume', text: 'ä¸Šå‚³å±¥æ­·' },
              { href: '/fill_preferences', text: 'å¡«å¯«å¿—é¡˜åº' },
              { href: '/ai_edit_resume', text: 'AIä¿®æ”¹å±¥æ­·' },
              { href: '/intern_achievement', text: 'å­¸ç”Ÿåª’åˆçµæœ' },
              { href: '/intern_experience', text: 'å¯¦ç¿’å¿ƒå¾—' },
              { href: '/notifications', text: 'é€šçŸ¥' },
              { href: '/login', text: 'ç™»å‡º' }
            ];
          } else if (userRole === 'vendor') {
            // å» å•†é¸å–®
            menuItems = [
              { href: '/vendor_home', text: 'é¦–é ' },
              { href: '/profile', text: 'å€‹äººè³‡æ–™' },
              { href: '/vendor_review_resume', text: 'å­¸ç”Ÿå±¥æ­·å¯©æ ¸' },
              { href: '/manage_positions', text: 'è·ä½éœ€æ±‚ç®¡ç†' },
              { href: '/confirm_matching', text: 'åª’åˆçµæœ' },
              { href: '/publish_announcements', text: 'ç™¼å¸ƒå…¬å‘Š' },
              { href: '/reviews_resumes_notifications', text: 'æŸ¥çœ‹å±¥æ­·èˆ‡é€šçŸ¥' },
              { href: '/notifications', text: 'é€šçŸ¥' },
              { href: '/login', text: 'ç™»å‡º' }
            ];
          } else if (displayRole === 'ç­å°å¸«') {
            // ç­å°å¸«é¸å–®ï¼ˆç­å°æœ‰è‡ªå·±çš„ä¸»é  /class_teacher_homeï¼‰
            // ä½¿ç”¨ display_role åˆ¤æ–·ç•¶å‰æ˜¯å¦ä»¥ç­å°èº«ä»½ç™»å…¥
            menuItems = [
              { href: '/class_teacher_home', text: 'é¦–é ' },
              { href: '/profile', text: 'å€‹äººè³‡æ–™' },
              { href: '/review_resume', text: 'æŸ¥çœ‹å­¸ç”Ÿå±¥æ­·' },
              { href: '/review_preferences', text: 'å¯©æ ¸å¿—é¡˜åº' },
              { href: '/admission/results', text: 'æŸ¥è©¢å­¸ç”ŸéŒ„å–çµæœ' },
              { href: '/notifications', text: 'é€šçŸ¥' },
              { href: '/login', text: 'ç™»å‡º' }
            ];
          } else if (userRole === 'director') {
            // ä¸»ä»»é¸å–®ï¼ˆä¸»ä»»æœ‰è‡ªå·±çš„ä¸»é  /director_homeï¼‰
            menuItems = [
              { href: '/director_home', text: 'é¦–é ' },
              { href: '/profile', text: 'å€‹äººè³‡æ–™' },
              { href: '/review_resume', text: 'å­¸ç”Ÿå±¥æ­·å¯©æ ¸' },
              { href: '/upload_company', text: 'å»ºç«‹å¯¦ç¿’æ©Ÿæœƒ' },
              { href: '/admission_results', text: 'æŸ¥çœ‹éŒ„å–çµæœ' },
              { href: '/manage_vendor', text: 'å¯¦ç¿’å» å•†ç®¡ç†' },
              { href: '/notifications', text: 'é€šçŸ¥' },
              { href: '/login', text: 'ç™»å‡º' }
            ];
          } else if (userRole === 'teacher') {
            // æŒ‡å°è€å¸«é¸å–®ï¼ˆæŒ‡å°è€å¸«æœ‰è‡ªå·±çš„ä¸»é  /teacher_homeï¼‰
            menuItems = [
              { href: '/teacher_home', text: 'é¦–é ' },
              { href: '/profile', text: 'å€‹äººè³‡æ–™' },
              { href: '/upload_company', text: 'å»ºç«‹å¯¦ç¿’æ©Ÿæœƒ' },
              { href: '/admission_results', text: 'æŸ¥çœ‹éŒ„å–çµæœ' },
              { href: '/manage_vendor', text: 'å¯¦ç¿’å» å•†ç®¡ç†' },
              { href: '/notifications', text: 'æŸ¥çœ‹å…¬å‘Š' },
              { href: '/review_resume', text: 'å­¸ç”Ÿå±¥æ­·å¯©æ ¸' },
              { href: '/login', text: 'ç™»å‡º' }
            ];
          } else if (userRole === 'ta') {
            // ç§‘åŠ©é¸å–®
            menuItems = [
              { href: '/ta_home', text: 'é¦–é ' },
              { href: '/profile', text: 'å€‹äººè³‡æ–™' },
              { href: '/notifications', text: 'é€šçŸ¥' },
              { href: '/ta/statistics/manage_companies', text: 'å¯¦ç¿’å» å•†ç®¡ç†' },
              { href: '/ta/interview_schedule', text: 'è¡Œäº‹æ›†' },
              { href: '/final_results', text: 'åª’åˆçµæœç¢ºèª' },
              { href: '/admin/absence_default_range', text: 'ç¼ºå‹¤é è¨­å­¸æœŸç¯„åœè¨­å®š' },
              { href: '/ta/upload_standard_courses', text: 'å°ˆæ¥­æ ¸å¿ƒç§‘ç›®ç®¡ç†' },
              { href: '/login', text: 'ç™»å‡º' }
            ];
          } else if (userRole === 'admin') {
            // ç®¡ç†å“¡é¸å–®
            menuItems = [
              { href: '/admin_home', text: 'é¦–é ' },
              { href: '/profile', text: 'å€‹äººè³‡æ–™' },
              { href: '/announcement/manage_announcements', text: 'å…¬å‘Šç®¡ç†' },
              { href: '/ta/statistics/manage_companies', text: 'å¯¦ç¿’å» å•†ç®¡ç†' },
              { href: '/final_results', text: 'å¿—é¡˜åºçµæœ' },
              { href: '/notifications', text: 'é€šçŸ¥' },
              { href: '/admin/absence_default_range', text: 'ç¼ºå‹¤é è¨­å­¸æœŸç¯„åœè¨­å®š' },
              { href: '/ta/upload_standard_courses', text: 'å°ˆæ¥­æ ¸å¿ƒç§‘ç›®ç®¡ç†' },
              { href: '/login', text: 'ç™»å‡º' }
            ];
          } else {
            // é è¨­é¸å–®ï¼ˆå…¶ä»–è§’è‰²æˆ–æœªç™»å…¥ï¼‰
            menuItems = [
              { href: '/login', text: 'ç™»å…¥' }
            ];
          }

          menuContent.innerHTML = menuItems.map(item => 
            `<a href="${item.href}">${item.text}</a>`
          ).join('');
        })
        .catch(err => {
          console.error('ç²å–ç”¨æˆ¶è³‡æ–™å¤±æ•—:', err);
          // å¦‚æœç²å–å¤±æ•—ï¼Œé¡¯ç¤ºé è¨­é¸å–®
          menuContent.innerHTML = '<a href="/login">ç™»å…¥</a>';
        });
    }

    // init
    (async function init() {
      await loadNotifications();
      // ã€ç§»é™¤ã€‘refreshTagList();

      // å‹•æ…‹ç”Ÿæˆé¸å–®
      renderMenu();

      // å´é‚Šé¸å–®æ§åˆ¶
      const menuBtn = document.getElementById('menu-btn');
      const sideMenu = document.getElementById('side-menu');
      const closeBtn = document.getElementById('close-btn');

      if (menuBtn) {
        menuBtn.addEventListener('click', () => {
          if (sideMenu) {
            sideMenu.classList.add('open');
            sideMenu.setAttribute('aria-hidden', 'false');
          }
        });
      }

      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          if (sideMenu) {
            sideMenu.classList.remove('open');
            sideMenu.setAttribute('aria-hidden', 'true');
          }
        });
      }

      // é»æ“Šé¸å–®å¤–éƒ¨é—œé–‰é¸å–®
      document.addEventListener('click', (e) => {
        if (sideMenu && menuBtn) {
          if (!sideMenu.contains(e.target) && !menuBtn.contains(e.target) && sideMenu.classList.contains('open')) {
            sideMenu.classList.remove('open');
            sideMenu.setAttribute('aria-hidden', 'true');
          }
        }
      });
    })();

  </script>
</body>

</html>