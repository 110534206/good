<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>智慧實習平台 | 新增職缺</title>
  <style>
    :root {
      --color-primary: #0066cc;
      --color-primary-dark: #024689;
      --color-border: #e2e8f0;
      --color-bg: #f5f7fb;
      --color-card: #ffffff;
      --color-text: #1f2933;
      --color-muted: #64748b;
      --color-success: #16a34a;
      --color-danger: #dc2626;
      --shadow-sm: 0 1px 2px rgba(15, 23, 42, 0.08);
      --shadow-md: 0 8px 24px rgba(15, 23, 42, 0.08);
      --radius-md: 12px;
      --radius-lg: 16px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Noto Sans TC', sans-serif;
      background: var(--color-bg);
      color: var(--color-text);
      margin: 0;
      min-height: 100vh;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    .container {
      width: 100%;
      max-width: 1080px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background-color: #fff;
      z-index: 1200;
      display: flex;
      align-items: center;
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.12);
    }

    .top-bar>.container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 24px;
      height: 100%;
    }

    .top-bar-right {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
    }

    .top-bar-right .btn-link {
      color: var(--color-primary);
      background-color: transparent;
      border: 1.5px solid var(--color-primary);
      padding: 0.3rem 0.7rem;
      border-radius: 6px;
      transition: background-color 0.3s ease, color 0.3s ease;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .top-bar-right .btn-link:hover {
      background-color: var(--color-primary);
      color: #fff;
    }

    #login-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.2s ease;
    }

    #login-avatar:hover {
      border-color: var(--color-primary);
    }

    main.management-container {
      padding: 96px 0 64px;
    }

    .page-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      background: #fff;
      border-radius: var(--radius-lg);
      padding: 28px 32px;
      border: 1px solid var(--color-border);
      box-shadow: var(--shadow-md);
      margin-bottom: 28px;
    }

    .page-eyebrow {
      font-size: 0.85rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--color-primary);
      font-weight: 600;
    }

    .page-header h1 {
      margin: 4px 0 8px;
      font-size: 1.9rem;
    }

    .page-header p {
      margin: 0;
      color: var(--color-muted);
    }

    .page-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .panel {
      background: var(--color-card);
      border-radius: var(--radius-lg);
      padding: 32px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--color-border);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    label {
      font-weight: 600;
      color: var(--color-muted);
    }

    select,
    input,
    textarea {
      width: 100%;
      padding: 11px 12px;
      border-radius: 10px;
      border: 1px solid var(--color-border);
      font-size: 0.95rem;
      background: #fff;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    select[multiple] {
      padding: 8px 12px;
    }

    select[multiple] option {
      padding: 6px 8px;
      margin: 2px 0;
    }

    select[multiple] option:checked {
      background: var(--color-primary);
      color: #fff;
    }

    select:focus,
    input:focus,
    textarea:focus {
      border-color: var(--color-primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.15);
    }

    textarea {
      min-height: 140px;
      resize: vertical;
    }

    .form-actions {
      margin-top: 28px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: flex-end;
    }

    .btn {
      border-radius: 10px;
      padding: 11px 20px;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      border: none;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn:disabled {
      cursor: not-allowed;
      opacity: 0.6;
      box-shadow: none;
    }

    .btn-primary {
      background: var(--color-primary);
      color: #fff;
      box-shadow: 0 4px 12px rgba(0, 102, 204, 0.25);
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--color-primary-dark);
      transform: translateY(-1px);
    }

    .btn-outline {
      background: #fff;
      border: 1px solid var(--color-border);
      color: var(--color-text);
    }

    .btn-outline:hover:not(:disabled) {
      border-color: var(--color-primary);
      color: var(--color-primary);
    }

    .btn-ghost {
      background: rgba(15, 23, 42, 0.05);
      color: var(--color-text);
    }

    .btn-ghost:hover:not(:disabled) {
      background: rgba(15, 23, 42, 0.08);
    }

    .empty-hint {
      background: #fff7ed;
      color: #b45309;
      padding: 12px 16px;
      border-radius: 10px;
      margin: 16px 0 0;
      border: 1px solid #fed7aa;
      display: none;
    }

    .empty-hint.show {
      display: block;
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      min-width: 240px;
      max-width: 360px;
      padding: 14px 16px;
      background: var(--color-text);
      color: #fff;
      border-radius: 12px;
      box-shadow: 0 12px 32px rgba(15, 23, 42, 0.2);
      display: none;
      z-index: 1500;
      font-weight: 600;
    }

    .toast.show {
      display: block;
      animation: fade-in 0.2s ease;
    }

    .toast.success {
      background: var(--color-success);
    }

    .toast.error {
      background: var(--color-danger);
    }

    @keyframes fade-in {
      from {
        transform: translateY(8px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    #side-menu {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 320px;
      max-width: 80vw;
      background-color: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(6px);
      box-shadow: 3px 0 12px rgba(0, 0, 0, 0.6);
      padding: 2rem 1.5rem;
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
      z-index: 1300;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      color: #fff;
      user-select: none;
    }

    #side-menu.open {
      transform: translateX(0);
    }

    #close-btn {
      position: absolute;
      top: 2rem;
      right: 1.6rem;
      font-size: 2.2rem;
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      line-height: 1;
      width: 2.4rem;
      height: 2.4rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #side-menu h2 {
      margin: 3.5rem 0 1.5rem;
      font-weight: 700;
      font-size: 1.6rem;
    }

    #side-menu a {
      display: block;
      width: 100%;
      padding: 0.6rem 0;
      font-size: 1.1rem;
      color: #e2e8f0;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }

    #side-menu a:hover {
      background-color: rgba(255, 255, 255, 0.18);
      color: #fff;
    }

    @media (max-width: 768px) {
      .page-header {
        padding: 20px;
      }

      .panel {
        padding: 20px;
      }
    }
  </style>
</head>

<body>
  <div class="top-bar">
    <div class="container">
      <div class="top-bar-left">
      </div>
      <div class="top-bar-right">
        <a href="/profile">
          <img src="{{ url_for('static', filename='images/avatar.png') }}" alt="頭像" id="login-avatar" />
        </a>
        <div class="dropdown" style="position: relative;">
          <button id="accountDropdownBtn" class="btn-link" aria-expanded="false">帳號 ▾</button>
          <div id="accountDropdownMenu" class="dropdown-menu"
            style="position:absolute; right:0; top:120%; background:#fff; border:1px solid #ccc; border-radius:10px; padding:8px; min-width:180px; display:none; box-shadow:0 12px 28px rgba(15,23,42,0.16);">
            <a href="/profile" class="btn-link" style="display:block; border:none; margin:4px 0;">個人資料</a>
            <a href="/logout" class="btn-link" style="display:block; border:none; margin:4px 0;">登出</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <main class="management-container container">
    <section class="panel" aria-label="新增職缺表單">
      <h1 id="pageTitle" style="margin-top: 0; margin-bottom: 24px; font-size: 1.9rem;">填寫職缺資訊</h1>
      <form id="positionForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="formCode">編號</label>
            <input id="formCode" type="text" readonly style="background-color: #f5f5f5;" />
          </div>
          <div class="form-group">
            <label for="formCompany">單位名稱 <span style="color: var(--color-danger);">*</span></label>
            <select id="formCompany" required>
              <option value="">資料載入中...</option>
            </select>
          </div>
          <div class="form-group">
            <label for="formResponsible">負責人</label>
            <input id="formResponsible" type="text" maxlength="50" />
          </div>
          <div class="form-group">
            <label for="formTaxId">統一編號</label>
            <input id="formTaxId" type="text" placeholder="例如：12345678" maxlength="20" />
          </div>
          <div class="form-group">
            <label for="formContact">聯絡人</label>
            <input id="formContact" type="text" maxlength="50" />
          </div>
          <div class="form-group">
            <label for="formContactTitle">職稱</label>
            <input id="formContactTitle" type="text" placeholder="例如：人事經理" maxlength="50" />
          </div>
          <div class="form-group">
            <label for="formPhone">聯絡電話</label>
            <input id="formPhone" type="tel" placeholder="例如：02-1234-5678" maxlength="30" />
          </div>
          <div class="form-group">
            <label for="formFax">傳真</label>
            <input id="formFax" type="tel" placeholder="例如：02-1234-5679" maxlength="30" />
          </div>
          <div class="form-group">
            <label for="formAddress">地址</label>
            <input id="formAddress" type="text" placeholder="例如：台北市信義區信義路五段7號" maxlength="200" />
          </div>
          <div class="form-group">
            <label for="formTransport">交通說明</label>
            <select id="formTransport" multiple style="min-height: 100px;">
              <option value="捷運">捷運</option>
              <option value="公車">公車</option>
              <option value="開車">開車</option>
              <option value="機車">機車</option>
              <option value="腳踏車">腳踏車</option>
              <option value="步行">步行</option>
              <option value="計程車">計程車</option>
              <option value="YouBike">YouBike</option>
              <option value="其他">其他</option>
            </select>
            <small style="display: block; margin-top: 6px; color: var(--color-muted); font-size: 0.875rem;">可按住 Ctrl (Windows) 或 Cmd (Mac) 鍵進行多選</small>
          </div>
          <div class="form-group">
            <label for="formEmail">E-mail</label>
            <input id="formEmail" type="email" placeholder="例如：contact@example.com" maxlength="100" />
          </div>
        </div>
        <div class="form-grid" style="margin-top: 20px;">
          <div class="form-group">
            <label for="formTitle">職缺名稱 <span style="color: var(--color-danger);">*</span></label>
            <input id="formTitle" type="text" placeholder="例如：資料分析實習生" required maxlength="100" />
          </div>
          <div class="form-group">
            <label for="formSlots">需求名額 <span style="color: var(--color-danger);">*</span></label>
            <input id="formSlots" type="number" min="1" step="1" required />
          </div>
          <div class="form-group">
            <label for="formPeriodStart">實習期間 - 開始日期</label>
            <input id="formPeriodStart" type="date" placeholder="點選或輸入日期" />
          </div>
          <div class="form-group">
            <label for="formPeriodEnd">實習期間 - 結束日期</label>
            <input id="formPeriodEnd" type="date" placeholder="點選或輸入日期" />
          </div>
          <div class="form-group">
            <label for="formPeriodNote">期間備註 (可留空)</label>
            <input id="formPeriodNote" type="text" placeholder="例如：暑期實習" maxlength="50" />
          </div>
          <div class="form-group">
            <label for="formWorkTime">上班時間 / 方式</label>
            <input id="formWorkTime" type="text" placeholder="例如：週一至週五，09:00-18:00，可遠端" maxlength="160" />
          </div>
          <div class="form-group">
            <label for="formSalary">薪資 / 津貼 (可留空)</label>
            <input id="formSalary" type="text" placeholder="例如：月薪 30,000" maxlength="120" />
          </div>
        </div>
        <div class="form-group" style="margin-top: 20px;">
          <label for="formCompanyIntro">單位簡介</label>
          <textarea id="formCompanyIntro" placeholder="請輸入單位簡介" maxlength="1000"></textarea>
        </div>
        <div class="form-group" style="margin-top: 16px;">
          <label for="formBusinessScope">營業項目</label>
          <textarea id="formBusinessScope" placeholder="請輸入營業項目" maxlength="500"></textarea>
        </div>
        <div class="form-group" style="margin-top: 16px;">
          <label for="formDescription">職務說明</label>
          <textarea id="formDescription" placeholder="簡述職務內容、所需技能與工作重點" maxlength="1500"></textarea>
        </div>
        <div class="form-group" style="margin-top: 16px;">
          <label for="formRemark">備註 (可留空)</label>
          <textarea id="formRemark" placeholder="補充資訊、報到注意事項等" maxlength="800"></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-ghost" id="cancelFormBtn">取消</button>
          <button type="submit" class="btn btn-primary" id="submitFormBtn">儲存職缺</button>
        </div>
        <p id="noCompanyHint" class="empty-hint">目前尚未建立與您對接指導老師關聯的公司資料，無法新增職缺。請聯絡指導老師或平台管理員協助建立。</p>
      </form>
    </section>
  </main>

  <nav id="side-menu" aria-hidden="true" role="navigation" aria-label="廠商功能選單">
    <button id="close-btn" aria-label="關閉功能選單">×</button>
    <h2>廠商功能</h2>
    <a href="/vendor_home">首頁總覽</a>
    <a href="/vendor_review_resume">履歷審核</a>
    <a href="/manage_positions">職位需求管理</a>
    <a href="/confirm_matching">媒合結果確認</a>
    <a href="/publish_announcements">公告發布</a>
  </nav>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    (() => {
      'use strict';

      const state = {
        companies: [],
        jobId: null,
        isEditMode: false
      };

      // 從 URL 取得 job_id（如果有的話）
      const pathParts = window.location.pathname.split('/');
      if (pathParts[pathParts.length - 2] === 'edit' && pathParts[pathParts.length - 1]) {
        state.jobId = parseInt(pathParts[pathParts.length - 1], 10);
        state.isEditMode = !isNaN(state.jobId);
      }

      const els = {
        form: document.getElementById('positionForm'),
        formCode: document.getElementById('formCode'),
        formCompany: document.getElementById('formCompany'),
        formResponsible: document.getElementById('formResponsible'),
        formTaxId: document.getElementById('formTaxId'),
        formContact: document.getElementById('formContact'),
        formContactTitle: document.getElementById('formContactTitle'),
        formPhone: document.getElementById('formPhone'),
        formFax: document.getElementById('formFax'),
        formAddress: document.getElementById('formAddress'),
        formTransport: document.getElementById('formTransport'),
        formEmail: document.getElementById('formEmail'),
        formCompanyIntro: document.getElementById('formCompanyIntro'),
        formBusinessScope: document.getElementById('formBusinessScope'),
        formTitle: document.getElementById('formTitle'),
        formSlots: document.getElementById('formSlots'),
        formPeriodStart: document.getElementById('formPeriodStart'),
        formPeriodEnd: document.getElementById('formPeriodEnd'),
        formPeriodNote: document.getElementById('formPeriodNote'),
        formWorkTime: document.getElementById('formWorkTime'),
        formSalary: document.getElementById('formSalary'),
        formDescription: document.getElementById('formDescription'),
        formRemark: document.getElementById('formRemark'),
        cancelFormBtn: document.getElementById('cancelFormBtn'),
        submitFormBtn: document.getElementById('submitFormBtn'),
        noCompanyHint: document.getElementById('noCompanyHint'),
        toast: document.getElementById('toast'),
        pageTitle: document.getElementById('pageTitle')
      };

      function escapeHtml(str) {
        if (typeof str !== 'string') return '';
        return str.replace(/[&<>"']/g, (char) => {
          const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;'
          };
          return map[char] || char;
        });
      }

      async function generatePositionCode() {
        // 獲取民國年度（前3碼）
        const now = new Date();
        const rocYear = now.getFullYear() - 1911;
        const yearPrefix = rocYear.toString().padStart(3, '0');
        
        try {
          // 從後端獲取下一個編號
          const response = await fetch('/vendor/api/positions/next_code', {
            headers: { 'Accept': 'application/json' },
            credentials: 'include'
          });
          const result = await response.json();
          
          if (result.success && result.code) {
            return result.code;
          } else {
            // 如果後端失敗，使用預設值
            return yearPrefix + '001';
          }
        } catch (error) {
          console.error('獲取編號失敗:', error);
          // 如果請求失敗，使用預設值
          return yearPrefix + '001';
        }
      }

      function showToast(message, type = 'info') {
        if (!els.toast) return;
        els.toast.textContent = message;
        els.toast.className = `toast show ${type}`;
        clearTimeout(els.toast._timer);
        els.toast._timer = setTimeout(() => {
          els.toast.classList.remove('show');
        }, 3600);
      }

      function parseDateInput(dateStr) {
        // 解析 YYYY-MM-DD 或 yyyy/mm/dd 格式
        if (!dateStr || !dateStr.trim()) return null;
        try {
          // 統一處理為標準格式
          let dateValue = dateStr.trim();
          // 如果是 YYYY-MM-DD 格式，直接使用
          if (/^\d{4}-\d{2}-\d{2}$/.test(dateValue)) {
            const date = new Date(dateValue + 'T00:00:00');
            if (!isNaN(date.getTime())) {
              return date;
            }
          }
          // 如果是 yyyy/mm/dd 格式，轉換
          const parts = dateValue.replace(/-/g, '/').split('/');
          if (parts.length >= 2) {
            const year = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10);
            const day = parts[2] ? parseInt(parts[2], 10) : 1;
            
            // 驗證日期是否有效
            if (isNaN(year) || isNaN(month) || isNaN(day)) return null;
            if (year < 1000 || year > 9999) return null;
            if (month < 1 || month > 12) return null;
            if (day < 1 || day > 31) return null;
            
            const date = new Date(year, month - 1, day);
            // 驗證日期是否有效（例如 2月30日會被調整）
            if (date.getFullYear() !== year || date.getMonth() !== month - 1 || date.getDate() !== day) {
              return null;
            }
            return date;
          }
        } catch (e) {
          return null;
        }
        return null;
      }

      function formatPeriodString(startDate, endDate, note) {
        if (!startDate && !endDate) return '';
        const parts = [];
        
        // 處理開始日期和結束日期
        if (startDate && endDate) {
          const start = parseDateInput(startDate.trim());
          const end = parseDateInput(endDate.trim());
          if (start && !isNaN(start.getTime()) && end && !isNaN(end.getTime())) {
            const startStr = `${start.getFullYear()}/${String(start.getMonth() + 1).padStart(2, '0')}`;
            const endStr = `${end.getFullYear()}/${String(end.getMonth() + 1).padStart(2, '0')}`;
            parts.push(`${startStr} - ${endStr}`);
          } else if (startDate.trim() && endDate.trim()) {
            // 如果解析失敗，但輸入不為空，嘗試格式化為 yyyy/mm 格式
            const startParsed = parseDateInput(startDate.trim());
            const endParsed = parseDateInput(endDate.trim());
            if (startParsed && endParsed) {
              parts.push(`${startParsed.getFullYear()}/${String(startParsed.getMonth() + 1).padStart(2, '0')} - ${endParsed.getFullYear()}/${String(endParsed.getMonth() + 1).padStart(2, '0')}`);
            } else {
              parts.push(`${startDate.trim()} - ${endDate.trim()}`);
            }
          }
        } else if (startDate) {
          const start = parseDateInput(startDate.trim());
          if (start && !isNaN(start.getTime())) {
            parts.push(`${start.getFullYear()}/${String(start.getMonth() + 1).padStart(2, '0')}`);
          } else if (startDate.trim()) {
            parts.push(startDate.trim());
          }
        } else if (endDate) {
          const end = parseDateInput(endDate.trim());
          if (end && !isNaN(end.getTime())) {
            parts.push(`- ${end.getFullYear()}/${String(end.getMonth() + 1).padStart(2, '0')}`);
          } else if (endDate.trim()) {
            parts.push(`- ${endDate.trim()}`);
          }
        }
        
        if (note && note.trim()) {
          parts.push(`(${note.trim()})`);
        }
        return parts.join(' ');
      }

      function formatDateForDisplay(dateStr) {
        // 將 YYYY-MM-DD 或 yyyy/mm/dd 格式轉換為 YYYY-MM-DD 格式（用於 date input）
        if (!dateStr) return '';
        // 如果已經是 YYYY-MM-DD 格式，直接返回
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
          return dateStr;
        }
        // 如果是 yyyy/mm/dd 格式，轉換為 YYYY-MM-DD
        const parts = dateStr.replace(/-/g, '/').split('/');
        if (parts.length >= 3) {
          return `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
        }
        return dateStr;
      }

      function parsePeriodString(periodStr) {
        if (!periodStr) return { start: '', end: '', note: '' };
        // 解析格式：2025/07 - 2025/09 (暑期)
        const match = periodStr.match(/(\d{4}\/\d{2})\s*-\s*(\d{4}\/\d{2})\s*(?:\(([^)]+)\))?/);
        if (match) {
          const [, startPart, endPart, note] = match;
          const [startYear, startMonth] = startPart.split('/');
          const [endYear, endMonth] = endPart.split('/');
          return {
            start: `${startYear}-${startMonth.padStart(2, '0')}-01`,
            end: `${endYear}-${endMonth.padStart(2, '0')}-01`,
            note: note || ''
          };
        }
        // 嘗試解析單一日期：2025/07
        const singleMatch = periodStr.match(/(\d{4}\/\d{2})/);
        if (singleMatch) {
          const [year, month] = singleMatch[1].split('/');
          return {
            start: `${year}-${month.padStart(2, '0')}-01`,
            end: '',
            note: periodStr.replace(singleMatch[0], '').trim().replace(/[()]/g, '').trim()
          };
        }
        return { start: '', end: '', note: periodStr };
      }

      function toggleFormAvailability(hasCompanies) {
        const fields = els.form.querySelectorAll('input, select, textarea');
        fields.forEach((field) => {
          field.disabled = !hasCompanies;
        });
        els.submitFormBtn.disabled = !hasCompanies;
        els.noCompanyHint.classList.toggle('show', !hasCompanies);
      }

      function populateCompanies() {
        const { companies } = state;
        if (!companies.length) {
          els.formCompany.innerHTML = '<option value="">尚無可用公司</option>';
          toggleFormAvailability(false);
          return;
        }
        const options = ['<option value="">請選擇公司</option>'];
        companies.forEach((company) => {
          options.push(
            `<option value="${company.id}">${escapeHtml(company.name || `公司 #${company.id}`)}</option>`
          );
        });
        els.formCompany.innerHTML = options.join('');
        toggleFormAvailability(true);
      }

      async function loadCompanies() {
        try {
          const response = await fetch('/vendor/api/positions', {
            headers: { 'Accept': 'application/json' },
            credentials: 'include'
          });
          const result = await response.json();
          if (!response.ok || !result.success) {
            throw new Error(result.message || '載入失敗');
          }
          state.companies = result.companies || [];
          populateCompanies();
          
          // 如果是編輯模式，載入職缺資料
          if (state.isEditMode && state.jobId) {
            await loadJobData();
          }
        } catch (error) {
          showToast(error.message || '資料載入失敗，請稍後再試', 'error');
          state.companies = [];
          populateCompanies();
        }
      }

      async function loadJobData() {
        try {
          const response = await fetch(`/vendor/api/positions/${state.jobId}`, {
            headers: { 'Accept': 'application/json' },
            credentials: 'include'
          });
          const result = await response.json();
          if (!response.ok || !result.success) {
            throw new Error(result.message || '載入職缺資料失敗');
          }
          
          const job = result.item;
          if (job) {
            if (els.formCode) els.formCode.value = job.code || '';
            els.formCompany.value = job.company_id || '';
            if (els.formResponsible) els.formResponsible.value = job.responsible || '';
            if (els.formTaxId) els.formTaxId.value = job.tax_id || '';
            if (els.formContact) els.formContact.value = job.contact || '';
            if (els.formContactTitle) els.formContactTitle.value = job.contact_title || '';
            if (els.formPhone) els.formPhone.value = job.phone || '';
            if (els.formFax) els.formFax.value = job.fax || '';
            if (els.formAddress) els.formAddress.value = job.address || '';
            // 處理交通說明的多選
            if (els.formTransport && job.transport) {
              const transportValues = job.transport.split(',').map(v => v.trim()).filter(v => v);
              Array.from(els.formTransport.options).forEach(option => {
                option.selected = transportValues.includes(option.value);
              });
            }
            if (els.formEmail) els.formEmail.value = job.email || '';
            if (els.formCompanyIntro) els.formCompanyIntro.value = job.company_intro || '';
            if (els.formBusinessScope) els.formBusinessScope.value = job.business_scope || '';
            els.formTitle.value = job.title || '';
            els.formSlots.value = job.slots || '';
            
            // 解析日期字串
            const periodData = parsePeriodString(job.period || '');
            els.formPeriodStart.value = formatDateForDisplay(periodData.start || '');
            els.formPeriodEnd.value = formatDateForDisplay(periodData.end || '');
            els.formPeriodNote.value = periodData.note || '';
            
            els.formWorkTime.value = job.work_time || '';
            els.formSalary.value = job.salary || '';
            els.formDescription.value = job.description || '';
            els.formRemark.value = job.remark || '';
            
            // 更新頁面標題
            if (els.pageTitle) els.pageTitle.textContent = '編輯職缺資訊';
            if (els.submitFormBtn) els.submitFormBtn.textContent = '更新職缺';
          }
        } catch (error) {
          showToast(error.message || '載入職缺資料失敗，請稍後再試', 'error');
        }
      }

      async function submitForm(event) {
        event.preventDefault();
        if (!state.companies.length) {
          showToast('尚未建立任何公司，無法新增職缺。', 'error');
          return;
        }

        // 組合日期字串
        const periodStr = formatPeriodString(
          els.formPeriodStart.value,
          els.formPeriodEnd.value,
          els.formPeriodNote.value
        );

        const payload = {
          code: els.formCode ? els.formCode.value.trim() : '',
          company_id: els.formCompany.value,
          responsible: els.formResponsible ? els.formResponsible.value.trim() : '',
          tax_id: els.formTaxId ? els.formTaxId.value.trim() : '',
          contact: els.formContact ? els.formContact.value.trim() : '',
          contact_title: els.formContactTitle ? els.formContactTitle.value.trim() : '',
          phone: els.formPhone ? els.formPhone.value.trim() : '',
          fax: els.formFax ? els.formFax.value.trim() : '',
          address: els.formAddress ? els.formAddress.value.trim() : '',
          transport: els.formTransport ? Array.from(els.formTransport.selectedOptions).map(opt => opt.value).join(', ') : '',
          email: els.formEmail ? els.formEmail.value.trim() : '',
          company_intro: els.formCompanyIntro ? els.formCompanyIntro.value.trim() : '',
          business_scope: els.formBusinessScope ? els.formBusinessScope.value.trim() : '',
          title: els.formTitle.value.trim(),
          slots: els.formSlots.value,
          period: periodStr,
          work_time: els.formWorkTime.value.trim(),
          salary: els.formSalary.value.trim() || null,
          description: els.formDescription.value.trim(),
          remark: els.formRemark.value.trim(),
          is_active: true
        };

        if (!payload.company_id) {
          showToast('請選擇所屬公司。', 'error');
          return;
        }
        if (!payload.title) {
          showToast('請輸入職缺名稱。', 'error');
          return;
        }

        els.submitFormBtn.disabled = true;
        try {
          const url = state.isEditMode 
            ? `/vendor/api/positions/${state.jobId}`
            : '/vendor/api/positions';
          const method = state.isEditMode ? 'PUT' : 'POST';
          
          const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(payload)
          });
          const result = await response.json();
          if (!response.ok || !result.success) {
            throw new Error(result.message || '儲存失敗');
          }
          showToast(state.isEditMode ? '職缺更新成功' : '職缺新增成功', 'success');
          setTimeout(() => {
            window.location.href = '/manage_positions';
          }, 800);
        } catch (error) {
          showToast(error.message || '儲存失敗，請稍後再試', 'error');
          els.submitFormBtn.disabled = false;
        }
      }


      function bindDateInputs() {
        // type="date" 輸入框會自動處理日期格式驗證，無需額外限制
        // 使用者可以點選日期選擇器或手動輸入日期
        const dateInputs = [els.formPeriodStart, els.formPeriodEnd];
        
        dateInputs.forEach(input => {
          if (!input) return;
          
          // 當輸入日期時，可以進行額外的格式化（如果需要）
          // 但 date input 本身已經有良好的驗證機制
          input.addEventListener('change', function() {
            // 確保日期格式正確（date input 會自動處理）
            if (this.value && !/^\d{4}-\d{2}-\d{2}$/.test(this.value)) {
              // 如果格式不對，嘗試轉換
              const date = parseDateInput(this.value);
              if (date && !isNaN(date.getTime())) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                this.value = `${year}-${month}-${day}`;
              }
            }
          });
        });
      }

      function bindEvents() {
        els.form.addEventListener('submit', submitForm);
        els.cancelFormBtn.addEventListener('click', () => {
          if (document.referrer && document.referrer.includes('/manage_positions')) {
            history.back();
          } else {
            window.location.href = '/manage_positions';
          }
        });
        bindDateInputs();
      }

      function initMenu() {
        const sideMenu = document.getElementById('side-menu');
        const closeBtn = document.getElementById('close-btn');
        if (closeBtn) {
          closeBtn.addEventListener('click', () => {
            sideMenu.classList.remove('open');
            sideMenu.setAttribute('aria-hidden', 'true');
          });
        }
        document.addEventListener('click', (event) => {
          if (sideMenu && !sideMenu.contains(event.target)) {
            sideMenu.classList.remove('open');
            sideMenu.setAttribute('aria-hidden', 'true');
          }
        });
      }

      function initAccountDropdown() {
        const btn = document.getElementById('accountDropdownBtn');
        const menu = document.getElementById('accountDropdownMenu');
        if (!btn || !menu) return;
        btn.addEventListener('click', () => {
          const open = menu.style.display === 'block';
          menu.style.display = open ? 'none' : 'block';
          btn.setAttribute('aria-expanded', String(!open));
        });
        document.addEventListener('click', (event) => {
          if (!menu.contains(event.target) && !btn.contains(event.target)) {
            menu.style.display = 'none';
            btn.setAttribute('aria-expanded', 'false');
          }
        });
      }

      function loadAvatar() {
        fetch('/api/profile', { credentials: 'include' })
          .then((res) => res.ok ? res.json() : Promise.reject())
          .then((data) => {
            if (data && data.success && data.user && data.user.avatar_url) {
              const rawUrl = data.user.avatar_url.startsWith('http')
                ? data.user.avatar_url
                : window.location.origin + data.user.avatar_url;
              const avatarUrl = `${rawUrl}${rawUrl.includes('?') ? '&' : '?'}t=${Date.now()}`;
              const avatar = document.getElementById('login-avatar');
              if (avatar) {
                avatar.src = avatarUrl;
              }
            }
          })
          .catch(() => { /* ignore avatar errors */ });
      }

      async function init() {
        initMenu();
        initAccountDropdown();
        loadAvatar();
        bindEvents();
        // 如果是新增模式，自動生成編號（前3碼：民國年度，後3碼：順序號碼）
        if (!state.isEditMode && els.formCode) {
          els.formCode.value = await generatePositionCode();
        }
        loadCompanies();
      }

      document.addEventListener('DOMContentLoaded', init);
    })();
  </script>
</body>

</html>


