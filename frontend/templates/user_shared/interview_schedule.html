<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <title>æ™ºæ…§å¯¦ç¿’å¹³å° | è¡Œäº‹æ›†</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Noto Sans TC", sans-serif;
      background: #f9fafb;
      margin: 0;
      overflow-x: hidden;
    }

    h2 {
      font-weight: 600;
      color: #333;
    }

    header {
      background: linear-gradient(135deg, #0055a8 0%, #006acb 50%, #004f94 100%);
      border-bottom: none;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 8px 20px rgba(0, 68, 148, 0.35);
    }

    .topbar {
      max-width: 1800px;
      margin: 0 auto;
      padding: 18px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: #fff;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .topbar-left #menu-btn {
      width: 30px;
      height: 22px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      background: none;
      border: none;
      padding: 0;
    }

    .topbar-left #menu-btn span {
      display: block;
      width: 100%;
      height: 3px;
      background-color: white;
      border-radius: 2px;
      transition: all 0.3s ease;
    }

    .topbar h1 {
      font-size: 1.5rem;
      margin: 0;
      text-align: center;
      color: #fff;
      flex: 1;
    }

    /* å´é‚Šé¸å–®æ¨£å¼ */
    #side-menu {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 320px;
      max-width: 80vw;
      background-color: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(6px);
      box-shadow: 3px 0 12px rgba(0, 0, 0, 0.6);
      padding: 2rem 1.5rem;
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
      z-index: 1300;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      color: #fff;
      user-select: none;
      border-top-right-radius: 24px;
      border-bottom-right-radius: 24px;
    }

    #side-menu.open {
      transform: translateX(0);
    }

    #side-menu h2 {
      margin: 0;
      font-weight: 700;
      font-size: 1.5rem;
      text-align: left;
      flex: 1;
      color: white;
    }

    #side-menu .menu-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      margin-bottom: 1.5rem;
    }

    #close-btn {
      font-size: 1.5rem;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      line-height: 1;
      width: auto;
      height: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      margin: 0;
    }

    #menu-content {
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    #side-menu a {
      display: block;
      width: 100%;
      padding: 0.6rem 0;
      font-size: 1.1rem;
      color: #e2e8f0;
      text-decoration: none;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }

    #side-menu a:hover {
      background: rgba(255, 255, 255, 0.18);
      color: #fff;
    }


    .main-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 60px;
      margin-top: 2rem;
    }

    /* è¡¨æ ¼æ¨£å¼ - èˆ‡åœ–ç‰‡æ ¼å¼ç›¸åŒ */
    .table {
      border-collapse: separate;
      border-spacing: 0;
    }

    .table thead th {
      text-align: center;
      background-color: #fafafb;
      font-weight: 600;
      border: 1px solid #dee2e6;
      padding: 0.75rem;
      vertical-align: middle;
    }

    .table tbody td {
      text-align: center;
      vertical-align: middle;
      border: 1px solid #dee2e6;
      padding: 0.75rem;
      background-color: #ffffff;
    }

    .table tbody tr {
      background-color: #ffffff;
    }

    .table tbody tr:hover {
      background-color: rgba(184, 177, 177, 0.03);
    }

    .table tbody tr:hover td {
      background-color: rgba(0, 0, 0, 0.03);
    }

    /* ç‹€æ…‹æ¨™ç±¤æ¨£å¼ */
    .status-badge {
      font-size: 0.9em;
      padding: 0.3em 0.8em;
      border-radius: 0.25rem;
      display: inline-block;
      font-weight: 600;
      border: none;
    }

    /* å·²æ ¸å‡†ç‹€æ…‹ä½¿ç”¨èˆ‡ btn-success å®Œå…¨ç›¸åŒçš„é¡è‰²å’Œæ¨£å¼ */
    .status-badge.btn-success {
      background-color: #198754;
      border-color: #198754;
      color: #ffffff;
    }
    
    .status-badge.btn-success:hover {
      background-color: #157347;
      border-color: #146c43;
      color: #ffffff;
    }
    
    .status-badge.btn-success:disabled {
      background-color: #198754;
      border-color: #198754;
      color: #ffffff;
      opacity: 1;
    }

    /* æŒ‰éˆ•æ¨£å¼ */
    .btn-sm {
      padding: 0.25rem 0.75rem;
      font-size: 0.875rem;
    }

    /* è¡Œäº‹æ›†æ¨£å¼ - èˆ‡å» å•†ç›¸åŒ */
    #calendarContainer {
      padding: 20px;
    }

    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }

    /* é¢è©¦æ’ç¨‹è©³æƒ…æ¨¡æ…‹æ¡†æ¨£å¼ */
    #interviewDetailModal .modal-dialog {
      max-width: 800px;
    }

    .interview-detail-row {
      padding: 10px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .interview-detail-row:last-child {
      border-bottom: none;
    }

    .interview-detail-label {
      font-weight: 600;
      color: #495057;
      margin-bottom: 6px;
      font-size: 0.9rem;
      width: 100px;
      display: inline-block;
    }

    .interview-detail-value {
      color: #212529;
      font-size: 1rem;
      display: inline-block;
      white-space: pre-wrap;
    }

    .interview-detail-notes {
      background: #ffffff;
      padding: 12px;
      border: 1px solid #dee2e6;
      white-space: pre-wrap;
      line-height: 1.6;
      margin-top: 8px;
      font-size: 0.95rem;
    }

  </style>
</head>

<body class="p-0">
  <header>
    <div class="topbar">
      <div class="topbar-left">
        <button id="menu-btn" title="é¸å–®" role="button" tabindex="0" aria-label="é–‹å•Ÿå´é‚Šé¸å–®">
          <span></span><span></span><span></span>
        </button>
      </div>
      <h1>è¡Œäº‹æ›†</h1>
      <div style="width: 30px;"></div>
    </div>
  </header>

  <!-- å´é‚Šé¸å–® -->
  <nav id="side-menu" aria-hidden="true" role="navigation" aria-label="åŠŸèƒ½é¸å–®">
    <div class="menu-header">
      <h2>åŠŸèƒ½é¸å–®</h2>
      <button id="close-btn" aria-label="é—œé–‰åŠŸèƒ½é¸å–®">Ã—</button>
    </div>
    <div id="menu-content">
      <div id="menu-links">
        <!-- é¸å–®é€£çµå°‡æ ¹æ“šç”¨æˆ¶è§’è‰²å‹•æ…‹è¼‰å…¥ -->
      </div>
    </div>
  </nav>

  <div class="container-fluid p-0">
    <div class="main-content">
      <div class="p-4">
        <!-- è¡Œäº‹æ›†å…§å®¹å€åŸŸ -->
        <div class="mb-4">
          <div class="card shadow-sm">
            <div class="card-body p-4">
              <div id="calendarContainer">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                  <button id="prevMonthBtn" class="btn btn-outline-secondary" style="padding: 8px 16px;">â€¹ ä¸Šå€‹æœˆ</button>
                  <h4 id="currentMonthYear" style="margin: 0; font-weight: 600;"></h4>
                  <button id="nextMonthBtn" class="btn btn-outline-secondary" style="padding: 8px 16px;">ä¸‹å€‹æœˆ â€º</button>
                </div>
                <div id="calendar"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- é¢è©¦æ’ç¨‹è©³æƒ…æ¨¡æ…‹æ¡† -->
        <div class="modal fade" id="interviewDetailModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">é¢è©¦æ’ç¨‹è©³æƒ…</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div id="interviewDetailContent">
                  <!-- è©³æƒ…å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // æ ¹æ“šç”¨æˆ¶è§’è‰²è¼‰å…¥å´é‚Šé¸å–®
    async function loadMenuByRole() {
      try {
        const res = await fetch('/api/profile');
        const data = await res.json();
        const role = data.user?.role || '';
        const menuContent = document.getElementById('menu-content');
        
        let menuItems = '';
        
        if (role === 'director') {
          // ä¸»ä»»çš„é¸å–®
          menuItems = `
            <a href="/director_home">é¦–é </a>
            <a href="/profile">å€‹äººè³‡æ–™</a>
            <a href="/approve_company">å¯©æ ¸å¯¦ç¿’å–®ä½</a>
            <a href="/review_resume?mode=director">å¯©æ ¸å¯¦ç¿’å±¥æ­·</a>
            <a href="/interview_schedule">è¡Œäº‹æ›†</a>
            <a href="/notifications">ç®¡ç†å…¬å‘Š</a>
            <a href="/admin_statistics">çµ±è¨ˆè³‡æ–™</a>
            <a href="/login">ç™»å‡º</a>
          `;
        } else if (role === 'teacher') {
          // æŒ‡å°è€å¸«çš„é¸å–®
          menuItems = `
            <a href="/teacher_home">é¦–é </a>
            <a href="/profile">å€‹äººè³‡æ–™</a>
            <a href="/notifications">å…¬å‘Š</a>
            <a href="/upload_company">å»ºç«‹å¯¦ç¿’æ©Ÿæœƒ</a>
            <a href="/review_resume">å­¸ç”Ÿå±¥æ­·å¯©æ ¸</a>
            <a href="/manage_vendor">å¯¦ç¿’å» å•†ç®¡ç†</a>
            <a href="/interview_schedule">è¡Œäº‹æ›†</a>
            <a href="/admission_results">æŸ¥çœ‹éŒ„å–çµæœ</a>
            <a href="/review_experience">å¯©æ ¸å¯¦ç¿’å¿ƒå¾—</a>
            <a href="/login">ç™»å‡º</a>
          `;
        } else if (role === 'student') {
          // å­¸ç”Ÿçš„é¸å–®
          menuItems = `
            <a href="/student_home">é¦–é </a>
            <a href="/profile">å€‹äººè³‡æ–™</a>
            <a href="/resume_folders">å±¥æ­·ç®¡ç†</a>
            <a href="/fill_preferences">å¡«å¯«å¿—é¡˜åº</a>
            <a href="/look_company">æŠ•éå±¥æ­·</a>
            <a href="/notifications">é€šçŸ¥</a>
            <a href="/interview_schedule">è¡Œäº‹æ›†</a>
            <a href="/intern_achievement">å­¸ç”Ÿåª’åˆçµæœ</a>
            <a href="/intern_experience">å¯¦ç¿’å¿ƒå¾—</a>
            <a href="/login">ç™»å‡º</a>
          `;
        } else if (role === 'class_teacher') {
          // ç­å°çš„é¸å–®ï¼ˆèˆ‡ class_teacher_home ä¸€è‡´ï¼‰
          menuItems = `
            <a href="/class_teacher_home">é¦–é </a>
            <a href="/profile">å€‹äººè³‡æ–™</a>
            <a href="/class_review_resume">æŸ¥çœ‹å­¸ç”Ÿå±¥æ­·</a>
            <a href="/review_preferences">å¯©æ ¸å¿—é¡˜åº</a>
            <a href="/interview_schedule">è¡Œäº‹æ›†</a>
            <a href="/notifications">é€šçŸ¥</a>
            <a href="/admission/results">æŸ¥è©¢å­¸ç”ŸéŒ„å–çµæœ</a>
            <a href="/login">ç™»å‡º</a>
          `;
        } else {
          // ç§‘åŠ©çš„é¸å–®ï¼ˆé è¨­ï¼‰
          menuItems = `
            <a href="/ta_home">é¦–é </a>
            <a href="/profile">å€‹äººè³‡æ–™</a>
            <a href="/notifications">é€šçŸ¥</a>
            <a href="/ta/statistics/manage_companies">å¯¦ç¿’å» å•†ç®¡ç†</a>
            <a href="/ta/interview_schedule">è¡Œäº‹æ›†</a>
            <a href="/admin/absence_default_range">ç¼ºå‹¤é è¨­å­¸æœŸç¯„åœè¨­å®š</a>
            <a href="/ta/upload_standard_courses">å°ˆæ¥­æ ¸å¿ƒç§‘ç›®ç®¡ç†</a>
            <a href="/ta_assistant_dashboard">åª’åˆçµæœç®¡ç†ä¸­å¿ƒ</a>
            <a href="/login">ç™»å‡º</a>
          `;
        }
        
        menuContent.innerHTML = menuItems;
      } catch (err) {
        console.error('è¼‰å…¥é¸å–®å¤±æ•—:', err);
        // å¦‚æœè¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­çš„ç§‘åŠ©é¸å–®
        document.getElementById('menu-content').innerHTML = `
          <a href="/ta_home">é¦–é </a>
          <a href="/profile">å€‹äººè³‡æ–™</a>
          <a href="/notifications">é€šçŸ¥</a>
          <a href="/ta/statistics/manage_companies">å¯¦ç¿’å» å•†ç®¡ç†</a>
          <a href="/ta/interview_schedule">è¡Œäº‹æ›†</a>
          <a href="/final_results">åª’åˆçµæœç¢ºèª</a>
          <a href="/admin/absence_default_range">ç¼ºå‹¤é è¨­å­¸æœŸç¯„åœè¨­å®š</a>
          <a href="/ta/upload_standard_courses">å°ˆæ¥­æ ¸å¿ƒç§‘ç›®ç®¡ç†</a>
          <a href="/login">ç™»å‡º</a>
        `;
      }
    }

    // é¸å–®é–‹é—œé‚è¼¯
    const menuBtn = document.getElementById("menu-btn");
    const sideMenu = document.getElementById("side-menu");
    const closeBtn = document.getElementById("close-btn");

    menuBtn.addEventListener("click", () => {
      sideMenu.classList.add("open");
      sideMenu.setAttribute("aria-hidden", "false");
    });

    closeBtn.addEventListener("click", () => {
      sideMenu.classList.remove("open");
      sideMenu.setAttribute("aria-hidden", "true");
    });

    // å¦‚æœé»æ“Š menu ä»¥å¤–çš„åœ°æ–¹å°±é—œé–‰é¸å–®
    document.addEventListener("click", (e) => {
      if (
        !sideMenu.contains(e.target) &&
        !menuBtn.contains(e.target)
      ) {
        sideMenu.classList.remove("open");
        sideMenu.setAttribute("aria-hidden", "true");
      }
    });

    // è¡Œäº‹æ›†ç›¸é—œè®Šæ•¸å’Œå‡½æ•¸ - èˆ‡å» å•†ç›¸åŒ
    let currentCalendarDate = new Date();
    // å­˜å„²é¢è©¦æ’ç¨‹ï¼ˆæ ¼å¼ï¼š'YYYY-MM-DD' => {timeStart: 'HH:MM', timeEnd: 'HH:MM', location: '...', notes: '...', companyName: '...', studentName: '...'}ï¼‰
    const interviewSchedules = new Map();
    // å­˜å„²æ‰€æœ‰å» å•†çš„é¢è©¦æ’ç¨‹ï¼ˆç”¨æ–¼é¡¯ç¤ºå…¶ä»–å» å•†å·²é ç´„çš„æ™‚é–“ï¼‰
    const allVendorSchedules = new Map();
    // å­˜å„²æˆªæ­¢æ™‚é–“
    let preferenceDeadlineDate = null;  // å¡«å¯«å¿—é¡˜åºæˆªæ­¢æ—¥æœŸ
    let preferenceDeadlineTime = null;  // å¡«å¯«å¿—é¡˜åºæˆªæ­¢æ™‚é–“
    let resumeDeadlineDate = null;  // ä¸Šå‚³å±¥æ­·æˆªæ­¢æ—¥æœŸ
    let resumeDeadlineTime = null;  // ä¸Šå‚³å±¥æ­·æˆªæ­¢æ™‚é–“

    // å¾å¾Œç«¯è¼‰å…¥æ‰€æœ‰å» å•†çš„é¢è©¦æ’ç¨‹
    async function loadAllVendorSchedules() {
      try {
        const res = await fetch('/ta/statistics/api/interview_schedules');
        const data = await res.json();
        if (data.success && data.schedules) {
          allVendorSchedules.clear();
          interviewSchedules.clear();
          
          // æŒ‰æ—¥æœŸåˆ†çµ„
          data.schedules.forEach(schedule => {
            const date = schedule.date;
            if (!allVendorSchedules.has(date)) {
              allVendorSchedules.set(date, []);
            }
            allVendorSchedules.get(date).push(schedule);
            
            // åŒæ™‚å­˜å„²åˆ° interviewSchedules ä»¥ä¾¿é¡¯ç¤º
            if (!interviewSchedules.has(date)) {
              interviewSchedules.set(date, {
                timeStart: schedule.time_start || '',
                timeEnd: schedule.time_end || '',
                location: schedule.location || '',
                companyName: schedule.company_name || '',
                studentName: schedule.student_name || '',
                vendorName: schedule.vendor_name || ''
              });
            }
          });
          console.log('âœ… å·²è¼‰å…¥æ‰€æœ‰å» å•†çš„é¢è©¦æ’ç¨‹:', allVendorSchedules);
        }
      } catch (err) {
        console.error('è¼‰å…¥æ‰€æœ‰å» å•†é¢è©¦æ’ç¨‹å¤±æ•—:', err);
      }
    }

    // è¼‰å…¥æˆªæ­¢æ™‚é–“
    async function loadDeadlines() {
      try {
        const res = await fetch('/ta/statistics/api/deadlines');
        const data = await res.json();
        if (data.success) {
          preferenceDeadlineDate = data.preference_deadline_date;
          preferenceDeadlineTime = data.preference_deadline_time;
          resumeDeadlineDate = data.resume_deadline_date;
          resumeDeadlineTime = data.resume_deadline_time;
          console.log('âœ… å·²è¼‰å…¥æˆªæ­¢æ™‚é–“:', { 
            preferenceDeadlineDate, 
            preferenceDeadlineTime,
            resumeDeadlineDate, 
            resumeDeadlineTime 
          });
        }
      } catch (err) {
        console.error('è¼‰å…¥æˆªæ­¢æ™‚é–“å¤±æ•—:', err);
      }
    }

    // æ”¹è®Šæœˆä»½
    function changeMonth(direction) {
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
      renderCalendar();
    }

    // æ¸²æŸ“è¡Œäº‹æ›† - èˆ‡å» å•†ç›¸åŒæ¨£å¼
    function renderCalendar() {
      const calendar = document.getElementById("calendar");
      const monthYear = document.getElementById("currentMonthYear");
      
      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();
      
      // è¨­ç½®æœˆä»½å¹´ä»½æ¨™é¡Œ
      const monthNames = ["ä¸€æœˆ", "äºŒæœˆ", "ä¸‰æœˆ", "å››æœˆ", "äº”æœˆ", "å…­æœˆ", 
                          "ä¸ƒæœˆ", "å…«æœˆ", "ä¹æœˆ", "åæœˆ", "åä¸€æœˆ", "åäºŒæœˆ"];
      monthYear.textContent = `${year}å¹´ ${monthNames[month]}`;
      
      // ç²å–ç•¶æœˆç¬¬ä¸€å¤©å’Œæœ€å¾Œä¸€å¤©
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay(); // 0 = æ˜ŸæœŸæ—¥, 1 = æ˜ŸæœŸä¸€, ...
      
      // æ¸…ç©ºæœˆæ›†
      calendar.innerHTML = "";
      
      // æ·»åŠ æ˜ŸæœŸæ¨™é¡Œ
      const weekDays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
      weekDays.forEach(day => {
        const dayHeader = document.createElement("div");
        dayHeader.style.cssText = "padding: 12px; text-align: center; font-weight: 600; background-color: #f1f5f9; border-radius: 8px;";
        dayHeader.textContent = day;
        calendar.appendChild(dayHeader);
      });
      
      // æ·»åŠ ç©ºç™½æ ¼å­ï¼ˆæœˆåˆï¼‰
      for (let i = 0; i < startingDayOfWeek; i++) {
        const emptyCell = document.createElement("div");
        emptyCell.style.cssText = "padding: 12px; min-height: 80px; border: 1px solid #e2e8f0; border-radius: 8px; background-color: #f9fafb;";
        calendar.appendChild(emptyCell);
      }
      
      // æ·»åŠ æ—¥æœŸæ ¼å­
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      for (let day = 1; day <= daysInMonth; day++) {
        const dateCell = document.createElement("div");
        const cellDate = new Date(year, month, day);
        cellDate.setHours(0, 0, 0, 0);
        
        const isToday = cellDate.getTime() === today.getTime();
        const isPast = cellDate < today;
        
        dateCell.style.cssText = `
          padding: 12px;
          min-height: 80px;
          border: 1px solid #e2e8f0;
          border-radius: 8px;
          background-color: ${isToday ? '#e3f2fd' : isPast ? '#f9fafb' : '#ffffff'};
          cursor: ${isPast ? 'not-allowed' : 'pointer'};
          transition: background-color 0.2s;
        `;
        
        // æ—¥æœŸæ•¸å­—
        const dayNumber = document.createElement("div");
        dayNumber.style.cssText = `
          font-weight: ${isToday ? '700' : '600'};
          font-size: 1rem;
          color: ${isToday ? '#0055a8' : isPast ? '#94a3b8' : '#1e293b'};
          margin-bottom: 4px;
        `;
        dayNumber.textContent = day;
        dateCell.appendChild(dayNumber);
        
        // æª¢æŸ¥æ˜¯å¦æœ‰é¢è©¦å®‰æ’
        const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const hasOwnInterview = interviewSchedules.has(dateKey);
        const hasOtherVendorInterviews = allVendorSchedules.has(dateKey);
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºæˆªæ­¢æ™‚é–“
        const isPreferenceDeadline = preferenceDeadlineDate === dateKey;
        const isResumeDeadline = resumeDeadlineDate === dateKey;
        
        // é¡¯ç¤ºæˆªæ­¢æ™‚é–“æ¨™è¨˜ï¼ˆåˆ†æˆå…©åˆ—é¡¯ç¤ºï¼‰
        if (isPreferenceDeadline || isResumeDeadline) {
          // å¿—é¡˜åºæˆªæ­¢
          if (isPreferenceDeadline) {
            const preferenceBadge = document.createElement("div");
            preferenceBadge.style.cssText = `
              font-size: 0.7rem;
              color: #fff;
              background-color: #dc3545;
              padding: 2px 6px;
              border-radius: 4px;
              margin-top: 4px;
              display: block;
              width: 100%;
              margin-bottom: 2px;
              font-weight: 600;
            `;
            preferenceBadge.textContent = preferenceDeadlineTime 
              ? `å¿—é¡˜åºæˆªæ­¢ ${preferenceDeadlineTime}`
              : 'å¿—é¡˜åºæˆªæ­¢';
            dateCell.appendChild(preferenceBadge);
          }
          
          // å±¥æ­·æˆªæ­¢
          if (isResumeDeadline) {
            const resumeBadge = document.createElement("div");
            resumeBadge.style.cssText = `
              font-size: 0.7rem;
              color: #fff;
              background-color: #dc3545;
              padding: 2px 6px;
              border-radius: 4px;
              margin-top: 4px;
              display: block;
              width: 100%;
              margin-bottom: 2px;
              font-weight: 600;
            `;
            resumeBadge.textContent = resumeDeadlineTime 
              ? `å±¥æ­·æˆªæ­¢ ${resumeDeadlineTime}`
              : 'å±¥æ­·æˆªæ­¢';
            dateCell.appendChild(resumeBadge);
          }
        }
        
        // é¡¯ç¤ºæ‰€æœ‰é¢è©¦æ’ç¨‹ï¼ˆå¾è³‡æ–™åº«è¼‰å…¥çš„è³‡æ–™ï¼‰
        if (hasOtherVendorInterviews) {
          const schedules = allVendorSchedules.get(dateKey);
          
          if (schedules && schedules.length > 0) {
            // ç‚ºæ¯å€‹é¢è©¦æ’ç¨‹å‰µå»ºæ¨™ç±¤
            schedules.forEach((schedule, index) => {
              const timeStart = schedule.time_start || '';
              const timeEnd = schedule.time_end || '';
              
              // æ ¼å¼åŒ–æ™‚é–“é¡¯ç¤º
              let timeDisplay = '';
              if (timeStart && timeEnd) {
                const startTime = timeStart.substring(0, 5); // å– HH:MM
                const endTime = timeEnd.substring(0, 5); // å– HH:MM
                timeDisplay = ` ${startTime}-${endTime}`;
              } else if (timeStart) {
                const startTime = timeStart.substring(0, 5);
                timeDisplay = ` ${startTime}`;
              }
              
              // å‰µå»ºæ¨™ç±¤ï¼ˆè—è‰²è¡¨ç¤ºé¢è©¦ï¼Œç´…è‰²è¡¨ç¤ºå·²æ’é¢è©¦ï¼‰
              const interviewBadge = document.createElement("div");
              interviewBadge.style.cssText = `
                font-size: 0.75rem;
                color: #fff;
                background-color: #0dcaf0;
                padding: 2px 6px;
                border-radius: 4px;
                margin-top: 4px;
                display: inline-block;
                white-space: nowrap;
                width: 100%;
                margin-bottom: 2px;
                cursor: pointer;
                transition: background-color 0.2s;
              `;
              
              // é¡¯ç¤ºå…¬å¸åç¨±å’Œæ™‚é–“
              const companyName = schedule.company_name || 'æœªçŸ¥å…¬å¸';
              const studentName = schedule.student_name || '';
              const displayText = studentName ? `${companyName} - ${studentName}${timeDisplay}` : `${companyName}${timeDisplay}`;
              interviewBadge.textContent = displayText.length > 20 ? displayText.substring(0, 17) + '...' : displayText;
              interviewBadge.title = `é»æ“ŠæŸ¥çœ‹è©³æƒ…ï¼š${companyName} - ${studentName || 'æœªçŸ¥å­¸ç”Ÿ'}${timeDisplay}${schedule.location ? ' - ' + schedule.location : ''}`;
              
              // æ·»åŠ é»æ“Šäº‹ä»¶
              interviewBadge.addEventListener('click', (e) => {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°æ—¥æœŸæ ¼å­
                showInterviewDetail(schedule);
              });
              
              // æ·»åŠ æ‡¸åœæ•ˆæœ
              interviewBadge.addEventListener('mouseenter', () => {
                interviewBadge.style.backgroundColor = '#0aa2c0';
              });
              interviewBadge.addEventListener('mouseleave', () => {
                interviewBadge.style.backgroundColor = '#0dcaf0';
              });
              
              dateCell.appendChild(interviewBadge);
            });
          }
        }
        
        // æ·»åŠ é»é¸äº‹ä»¶ï¼ˆééå»çš„æ—¥æœŸï¼‰
        if (!isPast) {
          dateCell.addEventListener('click', () => {
            // é»æ“Šæ—¥æœŸæ™‚çš„è™•ç†ï¼ˆå¯ç”¨æ–¼æŸ¥çœ‹æˆ–ç·¨è¼¯é¢è©¦æ’ç¨‹ï¼‰
            console.log('é»æ“Šæ—¥æœŸ: ' + dateKey);
          });
          dateCell.addEventListener('mouseenter', () => {
            dateCell.style.backgroundColor = '#f0f9ff';
          });
          dateCell.addEventListener('mouseleave', () => {
            dateCell.style.backgroundColor = isToday ? '#e3f2fd' : '#ffffff';
          });
        } else {
          dateCell.style.opacity = '0.6';
        }
        
        calendar.appendChild(dateCell);
      }
    }

    // é¡¯ç¤ºé¢è©¦æ’ç¨‹è©³æƒ…
    function showInterviewDetail(schedule) {
      const modal = new bootstrap.Modal(document.getElementById('interviewDetailModal'));
      const content = document.getElementById('interviewDetailContent');
      
      const companyName = schedule.company_name || 'æœªçŸ¥å…¬å¸';
      const studentName = schedule.student_name || 'æœªçŸ¥å­¸ç”Ÿ';
      const vendorName = schedule.vendor_name || 'æœªçŸ¥å» å•†';
      const date = schedule.date || '';
      const timeStart = schedule.time_start || '';
      const timeEnd = schedule.time_end || '';
      const location = schedule.location || 'æœªæŒ‡å®š';
      const notes = schedule.notes || '';  // é¢è©¦é ˆçŸ¥ï¼ˆå‚™è¨»ï¼‰
      const createdAt = schedule.created_at || '';
      
      // æ ¼å¼åŒ–æ™‚é–“é¡¯ç¤º
      let timeDisplay = '';
      if (timeStart && timeEnd) {
        timeDisplay = `${timeStart.substring(0, 5)} - ${timeEnd.substring(0, 5)}`;
      } else if (timeStart) {
        timeDisplay = timeStart.substring(0, 5);
      } else {
        timeDisplay = 'æœªæŒ‡å®š';
      }
      
      // æ ¼å¼åŒ–æ—¥æœŸé¡¯ç¤º
      let dateDisplay = '';
      if (date) {
        const dateObj = new Date(date);
        const year = dateObj.getFullYear();
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const day = String(dateObj.getDate()).padStart(2, '0');
        const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const weekDay = weekDays[dateObj.getDay()];
        dateDisplay = `${year}å¹´${month}æœˆ${day}æ—¥ï¼ˆ${weekDay}ï¼‰`;
      }
      
      // è½‰ç¾© HTML ä»¥é˜²æ­¢ XSS
      const escapeHtml = (text) => {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      };

      content.innerHTML = `
        <div class="interview-detail-row">
          <span class="interview-detail-label">å…¬å¸åç¨±</span>
          <span class="interview-detail-value">${escapeHtml(companyName)}</span>
        </div>
        <div class="interview-detail-row">
          <span class="interview-detail-label">å­¸ç”Ÿå§“å</span>
          <span class="interview-detail-value">${escapeHtml(studentName)}</span>
        </div>
        ${vendorName && vendorName !== 'æœªçŸ¥å» å•†' ? `
        <div class="interview-detail-row">
          <span class="interview-detail-label">å» å•†è¯çµ¡äºº</span>
          <span class="interview-detail-value">${escapeHtml(vendorName)}</span>
        </div>
        ` : ''}
        <div class="interview-detail-row">
          <span class="interview-detail-label">é¢è©¦æ—¥æœŸ</span>
          <span class="interview-detail-value">${escapeHtml(dateDisplay)}</span>
        </div>
        <div class="interview-detail-row">
          <span class="interview-detail-label">é¢è©¦æ™‚é–“</span>
          <span class="interview-detail-value">${escapeHtml(timeDisplay)}</span>
        </div>
        <div class="interview-detail-row">
          <span class="interview-detail-label">é¢è©¦åœ°é»</span>
          <span class="interview-detail-value">${escapeHtml(location)}</span>
        </div>
        ${notes ? `
        <div class="interview-detail-row">
          <span class="interview-detail-label">é¢è©¦é ˆçŸ¥</span>
          <span class="interview-detail-value">${escapeHtml(notes)}</span>
        </div>
        ` : ''}
        ${createdAt ? `
        <div class="interview-detail-row">
          <span class="interview-detail-label">å»ºç«‹æ™‚é–“</span>
          <span class="interview-detail-value" style="color: #6c757d; font-size: 0.9rem;">${escapeHtml(createdAt)}</span>
        </div>
        ` : ''}
      `;
      
      modal.show();
    }

    // è‡ªå‹•åˆ·æ–°é¢è©¦æ’ç¨‹çš„å®šæ™‚å™¨
    let scheduleRefreshInterval = null;
    
    // å•Ÿå‹•è‡ªå‹•åˆ·æ–°ï¼ˆæ¯30ç§’åˆ·æ–°ä¸€æ¬¡ï¼‰
    function startScheduleAutoRefresh() {
      // æ¸…é™¤ç¾æœ‰çš„å®šæ™‚å™¨ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
      if (scheduleRefreshInterval) {
        clearInterval(scheduleRefreshInterval);
      }
      
      // è¨­ç½®æ–°çš„å®šæ™‚å™¨
      scheduleRefreshInterval = setInterval(async () => {
        console.log('ğŸ”„ è‡ªå‹•åˆ·æ–°é¢è©¦æ’ç¨‹...');
        await loadAllVendorSchedules();
        renderCalendar();
      }, 30000); // 30ç§’åˆ·æ–°ä¸€æ¬¡
      
      console.log('âœ… å·²å•Ÿå‹•é¢è©¦æ’ç¨‹è‡ªå‹•åˆ·æ–°ï¼ˆæ¯30ç§’ï¼‰');
    }
    
    // åœæ­¢è‡ªå‹•åˆ·æ–°
    function stopScheduleAutoRefresh() {
      if (scheduleRefreshInterval) {
        clearInterval(scheduleRefreshInterval);
        scheduleRefreshInterval = null;
        console.log('å·²åœæ­¢é¢è©¦æ’ç¨‹è‡ªå‹•åˆ·æ–°');
      }
    }
    
    // åˆå§‹åŒ–è¡Œäº‹æ›†
    document.addEventListener('DOMContentLoaded', async function() {
      // æ ¹æ“šç”¨æˆ¶è§’è‰²è¼‰å…¥å´é‚Šé¸å–®
      await loadMenuByRole();
      // è¼‰å…¥æˆªæ­¢æ™‚é–“
      await loadDeadlines();
      // è¼‰å…¥æ‰€æœ‰å» å•†çš„é¢è©¦æ’ç¨‹
      await loadAllVendorSchedules();
      // æ¸²æŸ“è¡Œäº‹æ›†
      renderCalendar();
      
      // å•Ÿå‹•è‡ªå‹•åˆ·æ–°
      startScheduleAutoRefresh();
      
      // ç¶å®šæœˆä»½åˆ‡æ›æŒ‰éˆ•
      document.getElementById('prevMonthBtn').addEventListener('click', () => changeMonth(-1));
      document.getElementById('nextMonthBtn').addEventListener('click', () => changeMonth(1));
      
      // ç•¶é é¢å¤±å»ç„¦é»æ™‚åœæ­¢è‡ªå‹•åˆ·æ–°ï¼Œç²å¾—ç„¦é»æ™‚é‡æ–°å•Ÿå‹•
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          stopScheduleAutoRefresh();
        } else {
          // é é¢é‡æ–°å¯è¦‹æ™‚ï¼Œç«‹å³åˆ·æ–°ä¸€æ¬¡ï¼Œç„¶å¾Œé‡æ–°å•Ÿå‹•è‡ªå‹•åˆ·æ–°
          loadAllVendorSchedules().then(() => {
            renderCalendar();
            startScheduleAutoRefresh();
          });
        }
      });
    });
  </script>
</body>

</html>

