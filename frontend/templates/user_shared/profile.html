<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>智慧實習平台 | 個人資料管理</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f4f8;
      padding: 20px;
    }

    .container {
      max-width: 400px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 15px;
    }

    input,
    select {
      /* 確保 input 和 select 的寬度一致，達到對齊效果 */
      width: 96%;
      padding: 8px;
      margin-top: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    input[readonly],
    select:disabled {
      background: #eee;
    }

    .avatar-preview {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid #ccc;
      margin: 0 auto 10px;
      display: block;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .buttons {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      background: #007bff;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .password-container {
      position: relative;
      margin-bottom: 24px;
    }

    .toggle-password {
      position: absolute;
      top: 10px;
      right: 16px;
      font-size: 20px;
      cursor: pointer;
      color: #666;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>個人資料</h2>

    <img id="avatarPreview" class="avatar-preview" src="https://via.placeholder.com/100?text=頭像" alt="頭像預覽" />
    <input type="hidden" id="isHomeroom" value="false" />
    <input type="hidden" id="userClassId" />
    <div id="page1" class="page active">
      <label for="avatarUpload">上傳頭像</label>
      <input type="file" id="avatarUpload" accept="image/*" />

      <label for="identity">身分</label>
      <input id="identity" type="text" readonly />

      <div id="admissionYearField">
        <label id="admissionYearLabel" for="admissionYear">入學屆數</label>
        <input id="admissionYear" type="text" readonly />
      </div>

      <div id="currentSemesterContainer">
        <label for="currentSemesterCode">實習學期</label>
        <input id="currentSemesterCode" type="text" readonly />
      </div>

      <div id="studentFields" class="role-specific-fields" style="display: none;">
        <label for="combinedClass">班級/年級</label>
        <input id="combinedClass" type="text" readonly />

        <div id="managedClassesContainer" class="role-specific-fields" style="display: none;">
          <label for="managedClasses">管理班級</label>
          <input id="managedClasses" type="text" readonly />
        </div>
      </div>

      <div id="advisorField" class="role-specific-fields" style="display: none;">
        <label for="advisorName">指導老師</label>
        <input id="advisorName" type="text" readonly />
      </div>
    </div>

      <div id="page2" class="page">

      <label id="nameLabel" for="name">姓名</label>
      <input id="name" type="text" />

      <label for="email">電子郵件</label>
      <input id="email" type="email" readonly />

        <div id="studentIdField">
          <label id="studentIdLabel" for="studentId">帳號</label>
          <input id="studentId" type="text" readonly />
        </div>

      <label for="oldPassword">舊密碼</label>
      <div class="password-container">
        <input type="password" id="oldPassword" />
        <span class="toggle-password" data-target="oldPassword"><i class="fas fa-eye-slash"></i></span>
      </div>

      <label for="newPassword">新密碼</label>
      <div class="password-container">
        <input type="password" id="newPassword" />
        <span class="toggle-password" data-target="newPassword"><i class="fas fa-eye-slash"></i></span>
      </div>
    </div>

    <div class="buttons">
      <button id="prevBtn" disabled>上一頁</button>
      <button id="nextBtn">下一頁</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const pages = document.querySelectorAll('.page');
      let currentPage = 0;
      let userRole = ''; // 用來儲存跳轉時使用的 role

      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const currentSemesterInput = document.getElementById('currentSemesterCode');
      const studentFields = document.getElementById('studentFields');
      const managedClassesContainer = document.getElementById('managedClassesContainer');
      const userClassIdInput = document.getElementById('userClassId');
      const admissionYearField = document.getElementById('admissionYearField');
      const studentIdField = document.getElementById('studentIdField');
      const nameLabel = document.getElementById('nameLabel');

      /**
       * 將 admission_year 與純班序組合成「X年級X班」顯示（與 user_management 邏輯一致）
       * @param {number|null} activeSemesterYear - 當前學年（如 113）
       * @param {number|string|null} admissionYear - 入學屆數
       * @param {string} department - 科系（如 資管科）
       * @param {string} className - 純班序（如 忠、孝）
       * @returns {string} 例如「資管 四孝」
       */
      function formatClassWithGrade(activeSemesterYear, admissionYear, department, className) {
        const dept = (department || '').trim(); // 保留完整科系，如 資管科
        const cname = (className || '').trim();
        if (!cname) return dept || '-';
        const sy = activeSemesterYear != null ? parseInt(activeSemesterYear, 10) : NaN;
        const ay = admissionYear != null && admissionYear !== '' ? parseInt(admissionYear, 10) : NaN;
        if (isNaN(sy) || isNaN(ay)) return (dept ? dept + ' ' + cname : cname);
        const gradeNum = sy - ay + 1;
        const gradeLabels = ['一', '二', '三', '四', '五', '六'];
        const gradeChar = (gradeNum >= 1 && gradeNum <= 6) ? gradeLabels[gradeNum - 1] : (gradeNum > 0 ? String(gradeNum) : '');
        return gradeChar ? (dept ? dept + ' ' + gradeChar + cname : gradeChar + cname) : (dept ? dept + ' ' + cname : cname);
      }

      function showPage(index) {
        pages.forEach((page, i) => page.classList.toggle('active', i === index));
        prevBtn.disabled = index === 0;
        nextBtn.textContent = index === pages.length - 1 ? '完成' : '下一頁';
      }

      function showRoleSpecificFields(role, isHomeroom) {
        const advisorField = document.getElementById('advisorField');
        const studentFieldsEl = document.getElementById('studentFields');
        const admissionYearLabel = document.getElementById('admissionYearLabel');

        document.querySelectorAll('.role-specific-fields').forEach(field => {
          field.style.display = 'none';
        });

        document.getElementById('currentSemesterContainer').style.display = 'none';

        if (nameLabel) nameLabel.textContent = '姓名';
        if (studentIdField) studentIdField.style.display = '';
        if (studentIdLabel) studentIdLabel.textContent = '帳號';

        // 學生：入學屆數；班導：帶班班級、年級（classes_teacher）；指導老師：指導學生所屬班級（teacher_student_relations）；主任：不顯示此欄位
        if (admissionYearField) {
          if (role === 'student') {
            admissionYearField.style.display = '';
            if (admissionYearLabel) admissionYearLabel.textContent = '入學屆數';
            document.getElementById('admissionYear').value = document.getElementById('admissionYear').value || '';
          } else if (role === 'class_teacher') {
            admissionYearField.style.display = 'block';
            if (admissionYearLabel) admissionYearLabel.textContent = '帶班班級、年級';
            const ayEl = document.getElementById('admissionYear');
            if (ayEl) ayEl.value = ayEl.dataset.homeroomDisplay || '';
          } else if (role === 'teacher') {
            admissionYearField.style.display = 'block';
            if (admissionYearLabel) admissionYearLabel.textContent = '指導學生所屬班級';
            const ayEl = document.getElementById('admissionYear');
            if (ayEl) ayEl.value = ayEl.dataset.guidedDisplay || '';
          } else {
            admissionYearField.style.display = 'none';
          }
        }

        if (role === 'vendor') {
          if (nameLabel) nameLabel.textContent = '公司名稱';
          if (advisorField) advisorField.style.display = 'block';
          return;
        }

        if (advisorField) advisorField.style.display = 'none';

        if (role === 'student') {
          if (studentFieldsEl) studentFieldsEl.style.display = 'block';
          document.getElementById('currentSemesterContainer').style.display = 'block';
        } else if (isHomeroom) {
          if (managedClassesContainer) managedClassesContainer.style.display = 'block';
        }
      }

      // 載入用戶資料
      fetch('/api/profile')
        .then(res => {
          if (!res.ok) throw new Error('無法取得用戶資料');
          return res.json();
        })
        .then(data => {
          if (!data.success) throw new Error(data.message || '取得資料失敗');
          const user = data.user;
          userRole = user.role; // 儲存當前活躍角色

          const isHomeroom = user.is_homeroom || false;

          // 填入基礎資料
          document.getElementById('identity').value = user.display_role || '';
          document.getElementById('name').value = user.name || '';
          document.getElementById('email').value = user.email || '';
          const admissionYearEl = document.getElementById('admissionYear');
          if (admissionYearEl) {
            if (userRole === 'teacher' || userRole === 'director' || userRole === 'class_teacher') {
              const homeroomVal = user.homeroom_class_display || '';
              const guidedVal = user.guided_class_display || '';
              admissionYearEl.dataset.homeroomDisplay = homeroomVal;
              admissionYearEl.dataset.guidedDisplay = guidedVal;
              admissionYearEl.value = (userRole === 'class_teacher' ? homeroomVal : guidedVal);
            } else {
              admissionYearEl.value = user.admission_year || '';
              admissionYearEl.dataset.homeroomDisplay = '';
              admissionYearEl.dataset.guidedDisplay = '';
            }
          }
          document.getElementById('studentId').value = user.username || '';
          
          // 根據 user_changed 字段控制帳號是否可編輯
          const studentIdInput = document.getElementById('studentId');
          if (studentIdInput) {
            const userChanged = user.user_changed === 0 || user.user_changed === null || user.user_changed === undefined;
            if (userChanged) {
              // user_changed = 0 或 null，允許修改
              studentIdInput.removeAttribute('readonly');
              studentIdInput.style.backgroundColor = '';
              studentIdInput.title = '可以修改帳號（僅能修改一次）';
            } else {
              // user_changed = 1，不允許修改
              studentIdInput.setAttribute('readonly', 'readonly');
              studentIdInput.style.backgroundColor = '#f8f9fa';
              studentIdInput.title = '帳號已修改過，無法再次修改';
            }
          }
          document.getElementById('avatarPreview').src = user.avatar_url
            ? user.avatar_url + '?t=' + Date.now()
            : 'https://via.placeholder.com/100?text=頭像';

          userClassIdInput.value = user.class_id || ''; // 儲存 class_id 供儲存時使用

          // ⭐️ 修正點 B: 填入唯讀的實習學期資料 ⭐️
          currentSemesterInput.value = user.current_semester_display || '';

          // 填入角色特定資料：學生僅顯示「班級/年級」一欄，格式 資管科四孝
          if (userRole === 'student') {
            let classDisplay = user.class_display_name || '';
            const dept = (user.department || '').trim();
            const cname = (user.class_name || '').trim();
            const ayStr = (user.admission_year != null && user.admission_year !== '') ? String(user.admission_year).trim() : '';
            const codeStr = (user.current_semester_display || '').toString();
            const apiYear = user.active_semester_year != null && user.active_semester_year !== '' ? parseInt(String(user.active_semester_year), 10) : NaN;
            const activeYear = !isNaN(apiYear) ? apiYear : (codeStr.length >= 3 ? parseInt(codeStr.substring(0, 3), 10) : NaN);
            if (dept && cname && ayStr && !isNaN(activeYear)) {
              const ay = parseInt(ayStr, 10);
              if (!isNaN(ay)) {
                const gradeNum = activeYear - ay + 1;
                const gradeLabels = ['一', '二', '三', '四', '五', '六'];
                const gradeChar = (gradeNum >= 1 && gradeNum <= 6) ? gradeLabels[gradeNum - 1] : (gradeNum > 0 ? String(gradeNum) : '');
                classDisplay = gradeChar ? `${dept} ${gradeChar}${cname}` : `${dept} ${cname}`;
              }
            }
            document.getElementById('combinedClass').value = classDisplay || '';
          } else if (isHomeroom) {
            document.getElementById('managedClasses').value = user.class_display_name || '';
          } else if (userRole === 'vendor') {
            // 填入指導老師資訊
            const advisorNameInput = document.getElementById('advisorName');
            if (advisorNameInput) {
              advisorNameInput.value = user.advisor_name || '';
              console.log('指導老師名稱已填入:', user.advisor_name || '(無)');
            } else {
              console.error('找不到 advisorName 輸入框');
            }
          }

          // 根據使用者身分顯示相應的欄位
          showRoleSpecificFields(userRole, isHomeroom);
          
          // 如果是廠商，再次確認指導老師欄位已顯示
          if (userRole === 'vendor') {
            const advisorField = document.getElementById('advisorField');
            if (advisorField) {
              advisorField.style.display = 'block';
              console.log('指導老師欄位已顯示');
            } else {
              console.error('找不到 advisorField 元素');
            }
          }

        })
        .catch(err => alert('載入資料失敗：' + err.message));

      // -------------------------------------------------------------
      // 頁面切換與資料儲存
      // -------------------------------------------------------------

      prevBtn.addEventListener('click', () => {
        if (currentPage > 0) {
          currentPage--;
          showPage(currentPage);
        }
      });

      nextBtn.addEventListener('click', () => {
        if (currentPage < pages.length - 1) {
          currentPage++;
          showPage(currentPage);
        } else {
          // 完成按鈕，送出資料
          saveProfile();
        }
      });

      function saveProfile() {
        nextBtn.disabled = true; // 避免重複送出

        // 上傳頭像（如果有）
        function uploadAvatar() {
          const avatarFile = document.getElementById('avatarUpload').files[0];
          if (!avatarFile) return Promise.resolve(null);

          const formData = new FormData();
          formData.append('avatar', avatarFile);

          return fetch('/api/upload_avatar', {
            method: 'POST',
            body: formData,
          })
            .then(res => res.json())
            .then(data => {
              if (!data.success) throw new Error(data.message || '頭像上傳失敗');
              return data.avatar_url;
            });
        }

        uploadAvatar()
          .then(avatarUrl => {
            if (avatarUrl) {
              document.getElementById('avatarPreview').src = avatarUrl + '?t=' + Date.now();
            }

            // 更新個人資料
            const roleDisplayValue = document.getElementById('identity').value;
            const classIdToSend = userRole === 'student' ? userClassIdInput.value : null;

            const payload = {
              username: document.getElementById('studentId').value || '',
              role: roleDisplayValue,
              name: document.getElementById('name').value,
              class_id: classIdToSend,
              // ❌ 修正點 C: 移除 current_semester_code，因為它是唯讀且不參與更新 ❌
            };


            return fetch('/api/saveProfile', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
            })
              .then(res => res.json())
              .then(data => {
                if (!data.success) throw new Error(data.message || '更新個人資料失敗');
                return {
                  roleValue: data.role,
                  isHomeroom: data.is_homeroom,
                };
              });
          })
          .then(({ roleValue, isHomeroom }) => {
            // 變更密碼（如果有填）
            const oldPwd = document.getElementById('oldPassword').value.trim();
            const newPwd = document.getElementById('newPassword').value.trim();

            let finalRedirectUrl = '/student_home'; // 預設跳轉

            if (roleValue === 'student') {
              finalRedirectUrl = '/student_home';
            } else if (roleValue === 'ta') {
              finalRedirectUrl = '/ta_home';
            } else if (roleValue === 'teacher' || roleValue === 'director') {
              finalRedirectUrl = isHomeroom ? '/class_teacher_home' : `/${roleValue}_home`;
            } else if (roleValue === 'admin') {
              finalRedirectUrl = '/admin_home';
            } else if (roleValue === 'vendor') {
              finalRedirectUrl = '/vendor_home';
            }


            if (oldPwd || newPwd) {
              return fetch('/api/change_password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ old_password: oldPwd, new_password: newPwd }),
              })
                .then(res => res.json())
                .then(data => {
                  nextBtn.disabled = false;
                  if (!data.success) throw new Error(data.message || '密碼變更失敗');
                  alert('資料更新成功！密碼已變更。');
                  window.location.href = finalRedirectUrl;
                });
            } else {
              nextBtn.disabled = false;
              
              // 如果修改了帳號，重新獲取用戶資料以更新 user_changed 狀態
              const studentIdInput = document.getElementById('studentId');
              if (studentIdInput && !studentIdInput.hasAttribute('readonly')) {
                // 帳號是可編輯的，可能在這次保存中被修改了
                fetch('/api/profile')
                  .then(res => res.json())
                  .then(profileData => {
                    if (profileData.success && profileData.user) {
                      const userChanged = profileData.user.user_changed === 0 || profileData.user.user_changed === null || profileData.user.user_changed === undefined;
                      if (!userChanged) {
                        // 帳號已被修改，設置為只讀
                        studentIdInput.setAttribute('readonly', 'readonly');
                        studentIdInput.style.backgroundColor = '#f8f9fa';
                        studentIdInput.title = '帳號已修改過，無法再次修改';
                      }
                    }
                  })
                  .catch(err => console.error('重新獲取用戶資料失敗:', err));
              }
              
              alert('資料更新成功！');
              window.location.href = finalRedirectUrl;
            }
          })
          .catch(err => {
            nextBtn.disabled = false; // 發生錯誤時恢復按鈕
            alert('錯誤: ' + err.message);
          });
      }

      // 頭像預覽功能
      document.getElementById('avatarUpload').addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = event => {
            document.getElementById('avatarPreview').src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
      });

      // 密碼顯示/隱藏邏輯
      document.querySelectorAll('.toggle-password').forEach(toggle => {
        toggle.addEventListener('click', function () {
          const targetId = this.getAttribute('data-target');
          const passwordInput = document.getElementById(targetId);
          const icon = this.querySelector('i');

          if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            icon.classList.replace('fa-eye-slash', 'fa-eye');
          } else {
            passwordInput.type = 'password';
            icon.classList.replace('fa-eye', 'fa-eye-slash');
          }
        });
      });

      showPage(currentPage);
    });
  </script>
</body>

</html>
```