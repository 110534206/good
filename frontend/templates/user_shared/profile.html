<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>個人資料管理</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f4f8;
      padding: 20px;
    }

    .container {
      max-width: 400px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 15px;
    }

    input,
    select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    input[readonly] {
      background: #eee;
    }

    .avatar-preview {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid #ccc;
      margin: 0 auto 10px;
      display: block;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .buttons {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      background: #007bff;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>個人資料</h2>

    <!-- 頭像預覽 -->
    <img id="avatarPreview" class="avatar-preview" src="https://via.placeholder.com/100?text=頭像" alt="頭像預覽" />

    <!-- 頁面1 -->
    <div id="page1" class="page active">
      <label for="avatarUpload">上傳頭像</label>
      <input type="file" id="avatarUpload" accept="image/*" />

      <label for="identity">身分</label>
      <input id="identity" type="text" readonly />

      <label for="combinedClass">班級</label>
      <input id="combinedClass" type="text" readonly />

      <label for="name">姓名</label>
      <input id="name" type="text" />

      <label for="studentId">學號</label>
      <input id="studentId" type="text" readonly />

    </div>

    <!-- 頁面2 -->
    <div id="page2" class="page">
      <label for="email">電子郵件</label>
      <input id="email" type="email" readonly />

      <label for="oldPassword">舊密碼</label>
      <input type="password" id="oldPassword" />

      <label for="newPassword">新密碼</label>
      <input type="password" id="newPassword" />

      <label for="confirmPassword">確認新密碼</label>
      <input type="password" id="confirmPassword" />
    </div>

    <div class="buttons">
      <button id="prevBtn" disabled>上一頁</button>
      <button id="nextBtn">下一頁</button>
    </div>
  </div>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // 取得登入使用者資料
    fetch('/api/get_user_info')
      .then(res => res.json())
      .then(data => {
        if (!data.success) throw new Error(data.message || '取得資料失敗');
        const user = data.user;

        // 頭像
        document.getElementById('avatarPreview').src =
          user.avatar_url || 'https://via.placeholder.com/100?text=頭像';

        // 身分轉換
        const roleMap = {
          "student": "學生",
          "teacher": "教師",
          "director": "主任",
          "ta": "科助",
          "admin": "管理員"
        };
        document.getElementById('identity').value = roleMap[user.role] || '';

        // 如果是科助，隱藏班級欄位
        if (user.role === 'ta') {
          const classLabel = document.querySelector('label[for="combinedClass"]');
          const classInput = document.getElementById('combinedClass');
          if (classLabel) classLabel.style.display = 'none';
          if (classInput) classInput.style.display = 'none';
        }

        // 班級顯示 & 存 class_id
        if (user.classes && user.classes.length > 0) {
          document.getElementById('combinedClass').value = user.classes
            .map(c => (c.department.replace("管科", "") + c.name))
            .join("、");
        } else {
          document.getElementById('combinedClass').value = user.class_display_name || '';
        }
        window.classId = user.class_id || null;

        // 其他欄位
        document.getElementById('name').value = user.name || '';
        document.getElementById('studentId').value = user.username || '';
        document.getElementById('email').value = user.email || '';
      })
      .catch(err => {
        console.error(err);
        alert('無法取得使用者資料');
      });

    // 上傳表單送出
    document.getElementById('saveBtn').addEventListener('click', async () => {
      try {
        const roleMapReverse = {
          "學生": "student",
          "教師": "teacher",
          "主任": "director",
          "科助": "ta",
          "管理員": "admin"
        };

        const roleValue = roleMapReverse[document.getElementById('identity').value] || 'student';

        const payload = {
          username: document.getElementById('studentId').value,
          role: roleValue,
          name: document.getElementById('name').value,
          class_id: roleValue === 'ta' ? null : window.classId, // ✅ TA 不送出 class_id
        };

        const formData = new FormData();
        formData.append('data', JSON.stringify(payload));

        const avatarFile = document.getElementById('avatar').files[0];
        if (avatarFile) {
          formData.append('avatar', avatarFile);
        }

        const res = await fetch('/api/update_user_info', {
          method: 'POST',
          body: formData
        });

        const result = await res.json();
        if (!result.success) throw new Error(result.message || '更新失敗');

        alert('更新成功！');
        // ✅ 更新成功後導回主頁（可改為你要的頁面）
        window.location.href = '/student-home.html';

      } catch (err) {
        console.error(err);
        alert('更新時發生錯誤：' + err.message);
      }
    });
  });
</script>

</body>

</html>