<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>智慧實習平台 | 個人資料管理</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f4f8;
      padding: 20px;
    }

    .container {
      max-width: 400px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 15px;
    }

    input,
    select {
      width: 96%;
      padding: 8px;
      margin-top: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    input[readonly] {
      background: #eee;
    }

    .avatar-preview {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid #ccc;
      margin: 0 auto 10px;
      display: block;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .buttons {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      background: #007bff;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .password-container {
      position: relative;
      margin-bottom: 24px;
    }

    .toggle-password {
      position: absolute;
      top: 10px; 
      right: 16px;
      font-size: 20px;
      cursor: pointer;
      color: #666;
    }
    
    #error-message {
      display: none;
      font-weight: bold;
      color: rgb(184, 59, 59);
      margin-bottom: 15px;
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>個人資料</h2>

    <img id="avatarPreview" class="avatar-preview" src="https://via.placeholder.com/100?text=頭像" alt="頭像預覽" />
    <input type="hidden" id="isHomeroom" value="false" /> <div id="page1" class="page active">
      <label for="avatarUpload">上傳頭像</label>
      <input type="file" id="avatarUpload" accept="image/*" />

      <label for="identity">身分</label>
      <input id="identity" type="text" readonly />

      <label for="admissionYear" id="admissionYearLabel">入學屆數</label> <input id="admissionYear" type="text" readonly />

      <div id="studentFields" class="role-specific-fields" style="display: none;">
        <label for="combinedClass">班級</label>
        <input id="combinedClass" type="text" readonly />

        <label for="studentId">學號</label>
        <input id="studentId" type="text" readonly />
      </div>

     <div id="managedClassesContainer" class="role-specific-fields" style="display: none;">
        <label for="managedClasses">管理班級</label>
        <input id="managedClasses" type="text" readonly />
     </div>
        
     <div id="teacherFields" class="role-specific-fields" style="display: none;">
        <input id="teacherId" type="hidden" /> 
     </div>

     <div id="directorFields" class="role-specific-fields" style="display: none;">
        <input id="directorId" type="hidden" /> 
     </div>

      <div id="taFields" class="role-specific-fields" style="display: none;">
        <label for="taId">科助編號</label>
        <input id="taId" type="text" readonly />
      </div>

      <div id="adminFields" class="role-specific-fields" style="display: none;">
        <label for="adminId">管理員編號</label>
        <input id="adminId" type="text" readonly />
      </div>
</div>

    <div id="page2" class="page">
      <label for="name">姓名</label>
      <input id="name" type="text" readonly />

      <label for="email">電子郵件</label>
      <input id="email" type="email" readonly />

      <label for="oldPassword">舊密碼</label>
      <div class="password-container">
        <input type="password" id="oldPassword" />
        <span class="toggle-password" data-target="oldPassword">
          <i class="fas fa-eye-slash"></i>
        </span>
      </div>

      <label for="newPassword">新密碼</label>
      <div class="password-container">
        <input type="password" id="newPassword" />
        <span class="toggle-password" data-target="newPassword">
          <i class="fas fa-eye-slash"></i>
        </span>
      </div>
    </div>

    <div class="buttons">
      <button id="prevBtn" disabled>上一頁</button>
      <button id="nextBtn">下一頁</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const pages = document.querySelectorAll('.page');
      let currentPage = 0;

      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const managedClassesContainer = document.getElementById('managedClassesContainer');
      const managedClassesInput = document.getElementById('managedClasses');
      const admissionYearLabel = document.getElementById('admissionYearLabel'); // 取得標籤元素

      // 用來儲存 class_id 後續更新用
      window.classId = null;
      // 用來儲存學生班級資料，以便計算入學屆數
      window.classData = null; 

      const roleMap = {
        "student": "學生",
        "teacher": "指導老師",
        "director": "主任",
        "ta": "科助",
        "admin": "管理員"
      };
      const roleMapReverse = {
        "學生": "student",
        "指導老師": "teacher",
        "主任": "director",
        "科助": "ta",
        "管理員": "admin"
      };

      function showPage(index) {
        pages.forEach((page, i) => page.classList.toggle('active', i === index));
        prevBtn.disabled = index === 0;
        nextBtn.textContent = index === pages.length - 1 ? '完成' : '下一頁';
      }

      // 根據使用者身分顯示相應的欄位
      function showRoleSpecificFields(role, isHomeroom) {
        // 隱藏所有角色專用欄位
        const allRoleFields = document.querySelectorAll('.role-specific-fields');
        allRoleFields.forEach(field => {
          field.style.display = 'none';
        });

        // 根據角色顯示相應欄位
        switch (role) {
          case 'student':
            document.getElementById('studentFields').style.display = 'block';
            break;
          case 'teacher':
            document.getElementById('teacherFields').style.display = 'block';
            if (isHomeroom) {
              managedClassesContainer.style.display = 'block';
            }
            break;
          case 'director':
            document.getElementById('directorFields').style.display = 'block';
            if (isHomeroom) {
              managedClassesContainer.style.display = 'block';
            }
            break;
          case 'ta':
            document.getElementById('taFields').style.display = 'block';
            break;
          case 'admin':
            document.getElementById('adminFields').style.display = 'block';
            break;
        }
      }

      // 計算入學屆數（例如：資五孝 -> 110）
      function calculateAdmissionYear(classDisplayName) {
        if (!classDisplayName) return '';
        
        // 假設班級名稱格式為：[科別][屆數簡稱][班級名稱]
        // 範例: "資五孝", "管一愛", "管科五孝"
        const match = classDisplayName.match(/([一二三四五六七八九十]|[0-9]+)/); // 找到第一個數字或中文數字
        
        if (match) {
            const classYearMap = {
                "一": 1, "二": 2, "三": 3, "四": 4, "五": 5, 
                "1": 1, "2": 2, "3": 3, "4": 4, "5": 5 
            };
            const currentYear = new Date().getFullYear(); // 例如 2025 (實際年份)
            const currentROCYear = currentYear - 1911; // 例如 114 (實際學年度)
            
            let grade = match[0];
            let gradeNum = parseInt(grade);
            
            if (isNaN(gradeNum)) {
                // 如果是中文數字，轉換成數字
                gradeNum = classYearMap[grade] || 0;
            }

            if (gradeNum >= 1 && gradeNum <= 5) {
                // 假設今年的新生是 currentROCYear 屆 (五年制), 
                // 屆數計算公式: 實際學年度 - (年級 - 1)
                // 例如: 114學年度的五 (5) 年級 => 114 - (5 - 1) = 110 屆
                const admissionYear = currentROCYear - (gradeNum - 1);
                return admissionYear.toString();
            }
        }
        
        // 如果無法從班級名稱判斷，則使用後端傳來的 admission_year (從學號前三碼取得)
        const admissionYearFromBackend = document.getElementById('admissionYear').value;
        if (admissionYearFromBackend) return admissionYearFromBackend;
        
        return '';
      }

      // 載入用戶資料
      fetch('/api/profile')
        .then(res => {
          if (!res.ok) throw new Error('無法取得用戶資料');
          return res.json();
        })
        .then(data => {
          if (!data.success) throw new Error(data.message || '取得資料失敗');
          const user = data.user;

          // 儲存班導師狀態
          const isHomeroom = user.is_homeroom || false;
          document.getElementById('isHomeroom').value = isHomeroom ? 'true' : 'false';

          // 頭像 - 加上時間戳避免快取造成顯示舊圖
          const initialAvatarUrl = user.avatar_url ? (user.avatar_url + '?t=' + Date.now()) : 'https://via.placeholder.com/100?text=頭像';
          document.getElementById('avatarPreview').src = initialAvatarUrl;

          // 身分轉換
          const role = user.role;
          document.getElementById('identity').value = roleMap[role] || '';

          // 根據使用者身分顯示相應的欄位
          showRoleSpecificFields(role, isHomeroom);

          // -------------------------------------------------------------
          // 根據身分填入相應的資料
          // -------------------------------------------------------------
          if (role === 'student') {
            const classDisplayName = user.class_display_name || '';
            document.getElementById('combinedClass').value = classDisplayName;
            window.classId = user.class_id || null;
            document.getElementById('studentId').value = user.username || '';

            // 標題設定為「入學屆數」
            admissionYearLabel.textContent = '入學屆數';
            
            // 入學屆數 (學生: 使用班級名稱計算，若無則使用後端學號屆數)
            const admissionYear = calculateAdmissionYear(classDisplayName) || user.admission_year || '';
            document.getElementById('admissionYear').value = admissionYear;
          } else if (role === 'teacher' || role === 'director') {
            
            // 隱藏的 ID 欄位
            if (role === 'teacher') {
                document.getElementById('teacherId').value = user.username || '';
            } else {
                document.getElementById('directorId').value = user.username || '';
            }

            // 管理班級 (只有班導師/主任有)
            if (isHomeroom) {
              const classDisplayName = user.class_display_name || '';
              managedClassesInput.value = classDisplayName;
              
              // 標題設定為「班級屆數」
              admissionYearLabel.textContent = '班級屆數'; 

              // 如果有多個班級，取第一個班級計算入學屆數
              const firstClass = classDisplayName.split('、')[0].trim();
              const admissionYear = calculateAdmissionYear(firstClass);
              document.getElementById('admissionYear').value = admissionYear;
              
              managedClassesContainer.style.display = 'block';
            } else {
               // 非班導師/主任，入學屆數欄位標題為「入學屆數」，內容為空
               admissionYearLabel.textContent = '入學屆數'; 
               document.getElementById('admissionYear').value = '';
            }

          } else if (role === 'ta') {
            document.getElementById('taId').value = user.username || '';
            admissionYearLabel.textContent = '入學屆數'; 
            document.getElementById('admissionYear').value = ''; 
          } else if (role === 'admin') {
            document.getElementById('adminId').value = user.username || '';
            admissionYearLabel.textContent = '入學屆數'; 
            document.getElementById('admissionYear').value = ''; 
          }

          document.getElementById('name').value = user.name || '';
          document.getElementById('email').value = user.email || '';
        })
        .catch(err => alert(err.message));
        
      // -------------------------------------------------------------
      // 頁面切換與資料儲存（與上次版本相同，為維持完整性保留）
      // -------------------------------------------------------------

      prevBtn.addEventListener('click', () => {
        if (currentPage > 0) {
          currentPage--;
          showPage(currentPage);
        }
      });

      nextBtn.addEventListener('click', () => {
        if (currentPage < pages.length - 1) {
          currentPage++;
          showPage(currentPage);
        } else {
          // 完成按鈕，送出資料
          
          nextBtn.disabled = true; // 避免重複送出

          const avatarFile = document.getElementById('avatarUpload').files[0];

          // 上傳頭像（如果有）
          function uploadAvatar() {
            if (!avatarFile) return Promise.resolve(null);

            const formData = new FormData();
            formData.append('avatar', avatarFile);

            return fetch('/api/upload_avatar', {
              method: 'POST',
              body: formData,
            })
              .then(res => res.json())
              .then(data => {
                if (!data.success) throw new Error(data.message || '頭像上傳失敗');
                return data.avatar_url; // 回傳頭像URL
              });
          }

          uploadAvatar()
            .then(avatarUrl => {
              // 如果有新的頭像URL，更新預覽（加上時間戳避免被舊圖覆蓋）
              if (avatarUrl) {
                document.getElementById('avatarPreview').src = avatarUrl + '?t=' + Date.now();
              }

              // 更新個人資料
              const roleDisplayValue = document.getElementById('identity').value;
              const roleValue = roleMapReverse[roleDisplayValue] || 'student'; // 取得英文 role

              // 學生身分才需要 class_id
              const classIdToSend = roleValue === 'student' ? window.classId : null;

              if (roleValue === 'student' && !classIdToSend) {
                alert('學生身分必須選擇班級！');
                throw new Error('學生身分缺少班級');
              }

              // 根據身分取得相應的 username
              let username = '';
              if (roleValue === 'student') {
                username = document.getElementById('studentId').value;
              } else if (roleValue === 'teacher') {
                username = document.getElementById('teacherId').value;
              } else if (roleValue === 'director') {
                username = document.getElementById('directorId').value;
              } else if (roleValue === 'ta') {
                username = document.getElementById('taId').value;
              } else if (roleValue === 'admin') {
                username = document.getElementById('adminId').value;
              }

              const payload = {
                username: username,
                // 後端 /api/saveProfile 預期收到中文 role 顯示值 (role_display)
                role: roleDisplayValue,
                name: document.getElementById('name').value,
                class_id: classIdToSend,
              };

              return fetch('/api/saveProfile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
              })
                .then(res => res.json())
                .then(data => {
                  if (!data.success) throw new Error(data.message || '更新個人資料失敗');
                  return { 
                      avatarUrl, 
                      roleValue: data.role, // 使用後端回傳的 role
                      isHomeroom: data.is_homeroom, // 使用後端回傳的 is_homeroom
                  }; 
                });
            })
            .then(({ roleValue, isHomeroom }) => {
              // 變更密碼（如果有填）
              const oldPwd = document.getElementById('oldPassword').value.trim();
              const newPwd = document.getElementById('newPassword').value.trim();
              const confirmPwdInput = document.getElementById('newPassword'); // 確認密碼欄位已被移除，故不再檢查
              
              let finalRedirectUrl = '';
              if (roleValue === 'student') {
                  finalRedirectUrl = '/student_home';
              } else if (roleValue === 'ta') {
                  finalRedirectUrl = '/ta_home';
              } else if (roleValue === 'teacher' || roleValue === 'director') {
                  // 判斷是否為班導師
                  finalRedirectUrl = isHomeroom ? '/class_teacher_home' : `/${roleValue}_home`;
              } else {
                  finalRedirectUrl = '/student_home'; // 預設跳轉
              }

              if (oldPwd || newPwd) {
                return fetch('/api/change_password', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ old_password: oldPwd, new_password: newPwd }),
                })
                  .then(res => res.json())
                  .then(data => {
                    nextBtn.disabled = false; // 恢復按鈕
                    if (!data.success) throw new Error(data.message || '變更密碼失敗');
                    alert('資料及密碼更新成功！');
                    window.location.href = finalRedirectUrl;
                  });
              } else {
                nextBtn.disabled = false; // 恢復按鈕
                alert('資料更新成功！');
                window.location.href = finalRedirectUrl;
              }
            })
            .catch(err => {
                nextBtn.disabled = false; // 發生錯誤時恢復按鈕
                alert(err.message);
            });
        }
      });

      // 頭像預覽功能
      document.getElementById('avatarUpload').addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = event => {
            document.getElementById('avatarPreview').src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
      });

      // 密碼顯示/隱藏邏輯
      document.querySelectorAll('.toggle-password').forEach(toggle => {
        toggle.addEventListener('click', function () {
          const targetId = this.getAttribute('data-target');
          const passwordInput = document.getElementById(targetId);
          const icon = this.querySelector('i');

          if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            icon.classList.replace('fa-eye-slash', 'fa-eye');
          } else {
            passwordInput.type = 'password';
            icon.classList.replace('fa-eye', 'fa-eye-slash');
          }
        });
      });

      showPage(currentPage);
    });
  </script>
</body>

</html>