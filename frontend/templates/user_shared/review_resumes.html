<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>智慧實習平台 | 履歷審核</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: #ffffff;
      color: #333;
      overflow-x: hidden;
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 0.75rem;
    }

    /* 頂端列 */
    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background-color: #fff;
      z-index: 1100;
      display: flex;
      align-items: center;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }

    .top-bar > .container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 100%;
      gap: 30px;
    }

    .top-bar-left {
      display: flex;
      align-items: center;
      gap: 18px;
    }

    .brand {
      font-size: 1.1rem;
      font-weight: 700;
      color: #0066cc;
    }

    .top-bar-left #menu-btn {
      width: 30px;
      height: 22px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .top-bar-left #menu-btn span {
      height: 4px;
      background-color: #333;
      border-radius: 2px;
    }

    .top-bar-right {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
    }

    .btn-link {
      color: #0066cc;
      background-color: transparent;
      border: 1.5px solid #0066cc;
      padding: 0.35rem 0.8rem;
      border-radius: 6px;
      transition: background-color 0.3s ease, color 0.3s ease;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .btn-link:hover {
      background-color: #0066cc;
      color: #fff;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      cursor: pointer;
      margin-top: 6px;
    }

    /* 側邊選單 */
    #side-menu {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 320px;
      max-width: 80vw;
      background-color: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(6px);
      box-shadow: 3px 0 12px rgb(0 0 0 / 0.7);
      padding: 2rem 1.5rem;
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
      z-index: 1150;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      color: #fff;
    }

    #side-menu.open {
      transform: translateX(0);
    }

    .menu-close {
      align-self: flex-end;
      font-size: 1.5rem;
      cursor: pointer;
    }

    .menu-section {
      margin-top: 2rem;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .menu-section a {
      color: rgba(255, 255, 255, 0.85);
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .menu-section a:hover {
      color: #fff;
    }

    /* 內容區 */
    /* Hero Section - 藍色顯示條樣式 (已修改) */
    header.hero {
      position: relative;
      width: 100%;
      background-color: #0066cc; /* 藍色背景 */
      height: 70px; /* 固定高度，形成條狀 */
      margin-top: 0;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: center; /* 垂直置中 */
      color: #fff;
      text-align: center; /* 確保文字水平置中 */
    }

    header.hero h1 {
      font-size: 1.5rem; /* 調整字體大小 */
      font-weight: 700;
      text-shadow: none; /* 移除陰影 */
    }

    main {
      padding: 1rem 0 2rem;
    }

    .page-title {
      text-align: center;
      margin-bottom: 2.5rem;
    }

    .page-title h2 {
      font-size: 1.8rem;
      color: #024689;
      margin-bottom: 0.5rem;
    }

    .page-title p {
      color: #666;
      font-size: 0.95rem;
    }

    .filters {
      background-color: #f1f6fb;
      border: 1px solid #cfe0f5;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      display: grid;
      grid-template-columns: repeat(4, minmax(160px, 1fr));
      gap: 1rem 1.5rem;
    }

    .filters .field {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #024689;
      letter-spacing: 0.02em;
    }

    input[type="text"],
    select {
      width: 100%;
      padding: 0.55rem 0.65rem;
      border-radius: 8px;
      border: 1px solid #bfd0e7;
      font-size: 0.95rem;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    input[type="text"]:focus,
    select:focus {
      border-color: #0066cc;
      box-shadow: 0 0 0 4px rgba(0, 102, 204, 0.15);
      outline: none;
    }

    .filters-actions {
      display: flex;
      gap: 0.75rem;
      align-items: flex-end;
    }

    .btn-primary {
      background-color: #0066cc;
      color: #fff;
      border: none;
      padding: 0.65rem 1.4rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.15s ease;
    }

    .btn-primary:hover {
      background-color: #024689;
    }

    .btn-primary:active {
      transform: scale(0.98);
    }

    .btn-secondary {
      background-color: transparent;
      color: #024689;
      border: 1.5px solid #024689;
      padding: 0.65rem 1.4rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .btn-secondary:hover {
      background-color: #edf4fb;
    }

    /* 統計區 */
    .stats {
      display: grid;
      grid-template-columns: repeat(3, minmax(160px, 1fr));
      gap: 1rem;
      margin: 1rem auto 2.5rem;
      justify-items: center;
      justify-content: center;
      max-width: 720px;
    }

    .stat-card {
      background: linear-gradient(130deg, #0066cc, #59a9f2);
      color: #fff;
      border-radius: 12px;
      padding: 1.25rem;
      box-shadow: 0 6px 16px rgba(0, 78, 140, 0.2);
      text-align: center;
    }

    .stat-card span {
      display: block;
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 0.4rem;
    }

    .stat-card strong {
      font-size: 1.6rem;
      font-weight: 700;
    }

    /* 履歷列表 */
    .results {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 2rem;
      align-items: flex-start;
    }

    .cards {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .resume-card {
      border: 1.5px solid #d7e3f3;
      border-radius: 14px;
      padding: 1.5rem;
      display: flex;
      gap: 1.25rem;
      box-shadow: 0 3px 12px rgba(2, 70, 137, 0.08);
      transition: border-color 0.3s ease, transform 0.2s ease;
    }

    .resume-card:hover {
      border-color: #0066cc;
      transform: translateY(-3px);
    }

    .resume-card.active {
      border-color: #0066cc;
      box-shadow: 0 6px 18px rgba(2, 70, 137, 0.18);
      transform: translateY(-2px);
    }

    .empty-state {
      padding: 2rem 1.5rem;
      border: 1.5px dashed #bfd0e7;
      border-radius: 12px;
      text-align: center;
      color: #566174;
      font-size: 0.95rem;
      background-color: #f7f9fc;
    }

    .empty-text {
      color: #9aa6b6;
      font-size: 0.9rem;
    }

    .history .history-comment {
      color: #024689;
      font-style: italic;
    }

    .resume-card .avatar {
      width: 64px;
      height: 64px;
      margin-top: 0;
    }

    .resume-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .resume-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    .resume-header h3 {
      font-size: 1.2rem;
      color: #024689;
    }

    .resume-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      font-size: 0.85rem;
      color: #566174;
    }

    .badge {
      background-color: #edf4fb;
      color: #024689;
      border-radius: 999px;
      padding: 0.25rem 0.75rem;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .resume-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .resume-actions .btn-primary {
      padding: 0.55rem 1rem;
    }

    .resume-actions .btn-secondary {
      padding: 0.55rem 1rem;
    }

    .state-tag {
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
      background-color: #f7f9fc;
      border: 1px solid #d7e3f3;
      color: #024689;
    }

    /* 履歷詳情側欄 */
    .detail-panel {
      position: sticky;
      top: 90px;
      border: 1.5px solid #d7e3f3;
      border-radius: 14px;
      padding: 1.5rem;
      box-shadow: 0 6px 20px rgba(2, 70, 137, 0.12);
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
      max-height: calc(100vh - 120px);
      overflow-y: auto;
      background-color: #fff;
    }

    .detail-header {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .detail-header .avatar {
      width: 72px;
      height: 72px;
      margin-top: 0;
    }

    .detail-header h3 {
      font-size: 1.3rem;
      color: #024689;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(120px, 1fr));
      gap: 0.75rem 1rem;
    }

    .info-grid span {
      font-size: 0.85rem;
      color: #566174;
    }

    .section-title {
      font-size: 1rem;
      font-weight: 700;
      color: #024689;
      margin-bottom: 0.5rem;
    }

    .detail-section {
      border-top: 1px solid #e3ecf7;
      padding-top: 1rem;
    }

    .detail-section:first-of-type {
      border-top: none;
      padding-top: 0;
    }

    .tag-group {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .history {
      font-size: 0.85rem;
      color: #566174;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .history strong {
      color: #024689;
    }

    .detail-actions {
      display: flex;
      gap: 0.75rem;
    }

    .detail-bottom-actions {
      margin-top: 1.25rem;
      display: flex;
      justify-content: center;
      gap: 1rem;
    }

    .detail-bottom-actions.hidden {
      display: none;
    }

    /* 審核對話框 */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.48);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1200;
      padding: 1rem;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal {
      background-color: #fff;
      border-radius: 16px;
      padding: 1.75rem;
      width: min(520px, 100%);
      box-shadow: 0 18px 48px rgba(0, 32, 70, 0.25);
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .modal h4 {
      font-size: 1.2rem;
      color: #024689;
    }

    textarea {
      width: 100%;
      min-height: 120px;
      padding: 0.75rem;
      border-radius: 10px;
      border: 1.5px solid #bfd0e7;
      resize: vertical;
      font-size: 0.95rem;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    textarea:focus {
      border-color: #0066cc;
      box-shadow: 0 0 0 4px rgba(0, 102, 204, 0.1);
      outline: none;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }

    footer {
      margin: 3rem 0 2rem;
      text-align: center;
      color: #9aa6b6;
      font-size: 0.8rem;
    }

    /* 響應式 */
    @media (max-width: 1024px) {
      .filters,
      .stats {
        grid-template-columns: repeat(2, minmax(160px, 1fr));
      }

      .results {
        grid-template-columns: 1fr;
      }

      .detail-panel {
        position: static;
        max-height: none;
      }
    }

    @media (max-width: 768px) {
      .filters {
        grid-template-columns: repeat(1, minmax(0, 1fr));
      }

      .filters-actions {
        grid-column: 1 / -1;
      }

      .stats {
        grid-template-columns: repeat(1, minmax(160px, 1fr));
      }

      .resume-card {
        flex-direction: column;
        align-items: flex-start;
      }

      .resume-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.4rem;
      }

      .detail-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  

  <aside id="side-menu" aria-hidden="true">
    <span class="menu-close" id="menu-close-btn">&times;</span>
    <nav class="menu-section">
      <a href="#">儀表板</a>
      <a href="#">職缺管理</a>
      <a href="#">履歷審核</a>
      <a href="#">面試排程</a>
      <a href="#">帳戶設定</a>
    </nav>
  </aside>

  <header class="hero">
    <h1>履歷審核中心</h1>
  </header>

  

    <section class="stats" aria-label="摘要統計">
      <article class="stat-card">
        <span>待審履歷</span>
        <strong id="stat-pending">0</strong>
      </article>
      <article class="stat-card">
        <span>已通過</span>
        <strong id="stat-approved">0</strong>
      </article>
      <article class="stat-card">
        <span>已退回</span>
        <strong id="stat-rejected">0</strong>
      </article>
    </section>

    <section class="results">
      <div class="cards" id="resume-list"></div>

      <aside class="detail-panel" id="detail-panel" aria-live="polite">
        <div class="detail-header">
          <img src="/static/images/avatar-default.png" alt="履歷頭像" class="avatar" id="detail-avatar" />
          <div>
            <h3 id="detail-name">請選擇學生</h3>
            <span class="state-tag" id="detail-status">—</span>
          </div>
        </div>

        <div class="info-grid">
          <span id="detail-position"><strong>投遞職缺：</strong><span class="value">—</span></span>
          <span id="detail-applied-date"><strong>投遞日期：</strong><span class="value">—</span></span>
          <span id="detail-school"><strong>學校科系：</strong><span class="value">—</span></span>
          <span id="detail-start-date"><strong>可開始日期：</strong><span class="value">—</span></span>
        </div>

        <div class="detail-section">
          <h4 class="section-title">自我簡介</h4>
          <p id="detail-intro">尚未選擇任何履歷。</p>
        </div>

        <div class="detail-section">
          <h4 class="section-title">作品 / 附件</h4>
          <ul id="detail-portfolio-list"></ul>
        </div>

        <div class="detail-section">
          <h4 class="section-title">核心技能</h4>
          <div class="tag-group" id="detail-skills"></div>
        </div>

        <div class="detail-section">
          <h4 class="section-title">審核歷程</h4>
          <div class="history" id="detail-history"></div>
        </div>

        <div class="detail-actions" id="detail-actions"></div>

      <div class="detail-bottom-actions" id="detail-bottom-actions">
        <button type="button" class="btn-primary" data-action="approve">通過</button>
        <button type="button" class="btn-secondary" data-action="reject">不通過</button>
      </div>
      </aside>
    </section>
  </main>

  <footer>
    智慧實習平台 © 2025
  </footer>

  <div class="modal-backdrop" id="review-modal" aria-hidden="true">
    <div class="modal">
      <h4 id="modal-title">審核備註</h4>
      <p id="modal-desc">請填寫審核備註，將同步通知學生。</p>
      <textarea id="modal-comment" placeholder="例：請補充作品集連結，我們再進一步聯繫。"></textarea>
      <div class="modal-actions">
        <button class="btn-secondary" type="button" data-modal="cancel">取消</button>
        <button class="btn-primary" type="button" data-modal="confirm">送出</button>
      </div>
    </div>
  </div>

  <script>
    const menuBtn = document.getElementById('menu-btn');
    const menu = document.getElementById('side-menu');
    const menuCloseBtn = document.getElementById('menu-close-btn');
    const modalBackdrop = document.getElementById('review-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalDesc = document.getElementById('modal-desc');
    const modalCancel = document.querySelector('[data-modal="cancel"]');
    const modalConfirm = document.querySelector('[data-modal="confirm"]');
    const modalComment = document.getElementById('modal-comment');
    const modalConfirmOriginalText = modalConfirm.textContent;

    const statusLabels = {
      pending: '待審核',
      approved: '已通過',
      rejected: '已退回',
    };

    const actionEndpoints = {
      approve: 'approve',
      reject: 'reject',
      comment: 'comment',
      reopen: 'reopen',
    };

    let applications = [];
    let selectedApplicationId = null;
    let pendingAction = null;

    const cardsContainer = document.getElementById('resume-list');
    const detailAvatar = document.getElementById('detail-avatar');
    const detailName = document.getElementById('detail-name');
    const detailStatus = document.getElementById('detail-status');
    const detailPosition = document.querySelector('#detail-position .value');
    const detailAppliedDate = document.querySelector('#detail-applied-date .value');
    const detailSchool = document.querySelector('#detail-school .value');
    const detailStartDate = document.querySelector('#detail-start-date .value');
    const detailIntro = document.getElementById('detail-intro');
    const detailPortfolio = document.getElementById('detail-portfolio-list');
    const detailSkills = document.getElementById('detail-skills');
    const detailHistory = document.getElementById('detail-history');
    const detailActions = document.getElementById('detail-actions');
    const detailBottomActions = document.getElementById('detail-bottom-actions');

    const filterPosition = document.getElementById('filter-position');
    const filterStatus = document.getElementById('filter-status');
    const filterSchool = document.getElementById('filter-school');
    const filterKeyword = document.getElementById('filter-keyword');
    const filterApplyBtn = document.getElementById('filter-apply');
    const filterResetBtn = document.getElementById('filter-reset');

    const statPending = document.getElementById('stat-pending');
    const statApproved = document.getElementById('stat-approved');
    const statRejected = document.getElementById('stat-rejected');
    const statNew = document.getElementById('stat-new');

    const toggleMenu = (isOpen) => {
      menu.classList.toggle('open', isOpen);
      menu.setAttribute('aria-hidden', (!isOpen).toString());
    };

    menuBtn.addEventListener('click', () => toggleMenu(true));
    menuCloseBtn.addEventListener('click', () => toggleMenu(false));
    menu.addEventListener('click', (event) => {
      if (event.target === menu) toggleMenu(false);
    });

    const createEmptyNode = (text, tag = 'span') => {
      const node = document.createElement(tag);
      node.className = 'empty-text';
      node.textContent = text;
      return node;
    };

    const openModal = (action, name) => {
      const textMap = {
        approve: {
          title: `通過「${name}」履歷`,
          desc: '若需補充通知，可在下方備註；備註將寫入審核歷程。',
        },
        reject: {
          title: `退回「${name}」履歷`,
          desc: '請說明退回原因，此訊息將通知學生並記錄於歷程。',
        },
        comment: {
          title: `備註「${name}」履歷`,
          desc: '僅供內部成員參考，不會通知學生。',
        },
        reopen: {
          title: `重新審核「${name}」履歷`,
          desc: '此動作會將狀態改回待審核，可補充說明原因（選填）。',
        },
      };
      const content = textMap[action] || textMap.comment;
      modalTitle.textContent = content.title;
      modalDesc.textContent = content.desc;
      modalComment.value = '';
      modalBackdrop.classList.add('show');
      modalBackdrop.setAttribute('aria-hidden', 'false');
      modalComment.focus();
    };

    const closeModal = () => {
      modalBackdrop.classList.remove('show');
      modalBackdrop.setAttribute('aria-hidden', 'true');
      modalComment.value = '';
      pendingAction = null;
    };

    const fetchJSON = async (url, options = {}) => {
      const config = { ...options };
      config.headers = {
        Accept: 'application/json',
        ...(config.headers || {}),
      };
      if (config.body && typeof config.body !== 'string') {
        config.headers['Content-Type'] = 'application/json';
        config.body = JSON.stringify(config.body);
      }
      const response = await fetch(url, config);
      if (!response.ok) {
        let message = response.statusText;
        try {
          const data = await response.json();
          if (data && data.error) {
            message = data.error;
          }
        } catch (error) {
          message = await response.text();
        }
        throw new Error(message || '發生未知錯誤');
      }
      if (response.status === 204) {
        return null;
      }
      return response.json();
    };

    const getAvailableActions = (application) => {
      const actions = [
        { action: 'view', label: '查看履歷', variant: 'primary' },
      ];
      switch (application.status) {
        case 'pending':
          actions.push({ action: 'approve', label: '通過', variant: 'primary' });
          actions.push({ action: 'reject', label: '退回', variant: 'secondary' });
          break;
        case 'approved':
          actions.push({ action: 'comment', label: '備註', variant: 'secondary' });
          break;
        case 'rejected':
          actions.push({ action: 'reopen', label: '重新審核', variant: 'secondary' });
          break;
        default:
          break;
      }
      return actions;
    };

    const renderCards = (list, activeId) => {
      cardsContainer.innerHTML = '';
      if (!list.length) {
        const empty = document.createElement('div');
        empty.className = 'empty-state';
        empty.textContent = '目前沒有符合條件的履歷';
        cardsContainer.appendChild(empty);
        return;
      }
      list.forEach((application) => {
        const card = document.createElement('article');
        card.className = 'resume-card';
        if (application.id === activeId) {
          card.classList.add('active');
        }
        card.dataset.id = application.id;
        card.dataset.name = application.name;
        card.innerHTML = `
          <img src="${application.avatar || '/static/images/avatar-default.png'}" alt="${application.name}頭像" class="avatar" />
          <div class="resume-body">
            <div class="resume-header">
              <h3>${application.name}</h3>
              <span class="state-tag">${application.status_label || statusLabels[application.status] || '—'}</span>
            </div>
            <div class="resume-meta">
              <span>投遞職缺：${application.position_label}</span>
              <span>${application.school_label}</span>
              <span>投遞日期：${application.applied_date}</span>
            </div>
            <div class="tag-group">
              ${(application.skills || []).map((skill) => `<span class="badge">${skill}</span>`).join('')}
            </div>
            <div class="resume-actions">
              ${getAvailableActions(application).map((action) => `
                <button class="${action.variant === 'primary' ? 'btn-primary' : 'btn-secondary'}" type="button" data-action="${action.action}">${action.label}</button>
              `).join('')}
            </div>
          </div>
        `;
        cardsContainer.appendChild(card);
      });
    };

    const renderSummary = (summary = {}) => {
      statPending.textContent = summary.pending ?? 0;
      statApproved.textContent = summary.approved ?? 0;
      statRejected.textContent = summary.rejected ?? 0;
      statNew.textContent = summary.new_this_week ?? 0;
    };

    const renderSkills = (skills) => {
      detailSkills.innerHTML = '';
      if (!skills || !skills.length) {
        detailSkills.appendChild(createEmptyNode('尚未提供技能'));
        return;
      }
      skills.forEach((skill) => {
        const span = document.createElement('span');
        span.className = 'badge';
        span.textContent = skill;
        detailSkills.appendChild(span);
      });
    };

    const renderPortfolio = (items) => {
      detailPortfolio.innerHTML = '';
      if (!items || !items.length) {
        detailPortfolio.appendChild(createEmptyNode('尚未提供附件', 'li'));
        return;
      }
      items.forEach((item) => {
        const li = document.createElement('li');
        const link = document.createElement('a');
        link.href = item.url || '#';
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        link.textContent = item.label || '附件';
        li.appendChild(link);
        detailPortfolio.appendChild(li);
      });
    };

    const renderHistory = (history) => {
      detailHistory.innerHTML = '';
      if (!history || !history.length) {
        detailHistory.appendChild(createEmptyNode('尚無歷程紀錄'));
        return;
      }
      history.forEach((entry) => {
        const row = document.createElement('span');
        const timestampNode = document.createElement('strong');
        timestampNode.textContent = entry.timestamp;
        row.appendChild(timestampNode);
        row.appendChild(document.createTextNode(` - ${entry.text}`));
        if (entry.type === 'comment') {
          row.classList.add('history-comment');
        }
        detailHistory.appendChild(row);
      });
    };

    const renderDetailActions = (application) => {
      detailActions.innerHTML = '';
      const actions = getAvailableActions(application).filter((action) => action.action !== 'view');
      if (!actions.length) {
        detailActions.appendChild(createEmptyNode('目前無可用操作'));
        updateBottomActions(application);
        return;
      }
      actions.forEach((action) => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = action.variant === 'primary' ? 'btn-primary' : 'btn-secondary';
        button.dataset.action = action.action;
        button.textContent = action.label;
        detailActions.appendChild(button);
      });
      updateBottomActions(application);
    };

    const updateBottomActions = (application) => {
      if (!detailBottomActions) {
        return;
      }
      const approveBtn = detailBottomActions.querySelector('[data-action="approve"]');
      const rejectBtn = detailBottomActions.querySelector('[data-action="reject"]');
      const actions = getAvailableActions(application);
      const hasApprove = actions.some((action) => action.action === 'approve');
      const hasReject = actions.some((action) => action.action === 'reject');
      
      // ▼▼▼ 修改 2: 這裡的邏輯被移除了，不再切換 hidden class ▼▼▼
      // const shouldShow = hasApprove || hasReject;
      // detailBottomActions.classList.toggle('hidden', !shouldShow);

      // 我們保留按鈕的 style.display 控制，這樣 "通過" 按鈕在 "已通過" 狀態時仍會隱藏
      // 但整個區塊 (detail-bottom-actions) 會保持可見
      if (approveBtn) {
        approveBtn.style.display = hasApprove ? '' : 'none';
      }
      if (rejectBtn) {
        rejectBtn.style.display = hasReject ? '' : 'none';
      }
      // ▲▲▲ 修改 2 結束 ▲▲▲
    };

    const renderDetail = (application) => {
      detailAvatar.src = application.avatar || '/static/images/avatar-default.png';
      detailName.textContent = application.name || '—';
      detailStatus.textContent = application.status_label || statusLabels[application.status] || '—';
      detailPosition.textContent = application.position_label || '—';
      detailAppliedDate.textContent = application.applied_date || '—';
      detailSchool.textContent = application.school_label || '—';
      detailStartDate.textContent = application.start_date || '—';
      detailIntro.textContent = application.summary || '尚未提供自我簡介';
      renderPortfolio(application.portfolio);
      renderSkills(application.skills);
      renderHistory(application.history);
      renderDetailActions(application);
    };

    const clearDetail = () => {
      detailAvatar.src = '/static/images/avatar-default.png';
      detailName.textContent = '請選擇學生';
      detailStatus.textContent = '—';
      detailPosition.textContent = '—';
      detailAppliedDate.textContent = '—';
      detailSchool.textContent = '—';
      detailStartDate.textContent = '—';
      detailIntro.textContent = '尚未選擇任何履歷。';
      detailPortfolio.innerHTML = '';
      detailPortfolio.appendChild(createEmptyNode('尚未提供附件', 'li'));
      detailSkills.innerHTML = '';
      detailSkills.appendChild(createEmptyNode('尚未提供技能'));
      detailHistory.innerHTML = '';
      detailHistory.appendChild(createEmptyNode('尚無歷程紀錄'));
      detailActions.innerHTML = '';
      detailActions.appendChild(createEmptyNode('請先選擇履歷'));
      if (detailBottomActions) {
        // ▼▼▼ 修改 3: 從 .add('hidden') 改為 .remove('hidden') ▼▼▼
        detailBottomActions.classList.remove('hidden');
        
        // 同時確保按鈕在清除時顯示，以符合初始狀態
        const approveBtn = detailBottomActions.querySelector('[data-action="approve"]');
        const rejectBtn = detailBottomActions.querySelector('[data-action="reject"]');
         if (approveBtn) {
          approveBtn.style.display = '';
        }
        if (rejectBtn) {
          rejectBtn.style.display = '';
        }
      }
    };

    const loadApplicationDetail = async (applicationId) => {
      if (!applicationId) {
        clearDetail();
        return;
      }
      try {
        const response = await fetchJSON(`/vendor/api/applications/${applicationId}`);
        if (response && response.item) {
          renderDetail(response.item);
        }
      } catch (error) {
        alert(`讀取履歷詳情失敗：${error.message}`);
      }
    };

    const loadApplications = async (options = {}) => {
      const params = new URLSearchParams();
      if (filterStatus.value) params.set('status', filterStatus.value);
      if (filterPosition.value) params.set('position', filterPosition.value);
      if (filterSchool.value) params.set('school', filterSchool.value);
      if (filterKeyword.value.trim()) params.set('keyword', filterKeyword.value.trim());
      const query = params.toString();
      const url = query ? `/vendor/api/applications?${query}` : '/vendor/api/applications';
      const data = await fetchJSON(url);
      applications = data.items || [];
      renderSummary(data.summary);
      if (!applications.length) {
        selectedApplicationId = null;
        renderCards([], null);
        if (!options.skipDetailFetch) {
          clearDetail();
        }
        return;
      }
      let targetId = options.selectId || selectedApplicationId;
      if (!targetId || !applications.some((item) => item.id === targetId)) {
        targetId = applications[0].id;
      }
      selectedApplicationId = targetId;
      renderCards(applications, selectedApplicationId);
      if (options.skipDetailFetch && options.detailData) {
        renderDetail(options.detailData);
      } else {
        await loadApplicationDetail(selectedApplicationId);
      }
    };

    const selectApplication = (applicationId, forceFetch = true) => {
      if (!applicationId) return;
      if (selectedApplicationId !== applicationId) {
        selectedApplicationId = applicationId;
        renderCards(applications, selectedApplicationId);
      }
      if (forceFetch) {
        loadApplicationDetail(applicationId);
      }
    };

    cardsContainer.addEventListener('click', (event) => {
      const card = event.target.closest('.resume-card');
      if (!card) return;
      const action = event.target.dataset.action;
      const applicationId = card.dataset.id;
      const applicationName = card.dataset.name;
      if (action && action !== 'view') {
        pendingAction = { action, appId: applicationId, name: applicationName };
        openModal(action, applicationName);
        return;
      }
      selectApplication(applicationId, true);
    });

    detailActions.addEventListener('click', (event) => {
      const action = event.target.dataset.action;
      if (!action || !selectedApplicationId) return;
      pendingAction = { action, appId: selectedApplicationId, name: detailName.textContent };
      openModal(action, detailName.textContent);
    });

    if (detailBottomActions) {
      detailBottomActions.addEventListener('click', (event) => {
        const action = event.target.dataset.action;
        if (!action || !selectedApplicationId) return;
        pendingAction = { action, appId: selectedApplicationId, name: detailName.textContent };
        openModal(action, detailName.textContent);
      });
    }

    filterApplyBtn.addEventListener('click', () => {
      loadApplications({ selectId: null }).catch((error) => {
        alert(`載入履歷列表失敗：${error.message}`);
      });
    });

    filterResetBtn.addEventListener('click', () => {
      filterPosition.value = '';
      filterStatus.value = '';
      filterSchool.value = '';
      filterKeyword.value = '';
      loadApplications({ selectId: null }).catch((error) => {
        alert(`載入履歷列表失敗：${error.message}`);
      });
    });

    filterKeyword.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        loadApplications({ selectId: null }).catch((error) => {
          alert(`載M入履歷列表失敗：${error.message}`);
        });
      }
    });

    modalCancel.addEventListener('click', closeModal);

    modalConfirm.addEventListener('click', async () => {
      if (!pendingAction) {
        closeModal();
        return;
      }
      const currentAction = { ...pendingAction };
      const endpoint = actionEndpoints[currentAction.action];
      if (!endpoint) {
        closeModal();
        return;
      }
      modalConfirm.disabled = true;
      modalConfirm.textContent = '送出中...';
      try {
        const payload = {};
        if (modalComment.value.trim()) {
          payload.comment = modalComment.value.trim();
        }
        const response = await fetchJSON(`/vendor/api/applications/${currentAction.appId}/${endpoint}`, {
          method: 'POST',
          body: payload,
        });
        const updatedItem = response && response.item ? response.item : null;
        closeModal();
        if (updatedItem) {
          await loadApplications({
            selectId: updatedItem.id,
            skipDetailFetch: true,
            detailData: updatedItem,
          });
        } else {
          await loadApplications({ selectId: currentAction.appId });
        }
      } catch (error) {
        alert(`操作失敗：${error.message}`);
      } finally {
        modalConfirm.disabled = false;
        modalConfirm.textContent = modalConfirmOriginalText;
      }
    });

    modalBackdrop.addEventListener('click', (event) => {
      if (event.target === modalBackdrop) {
        closeModal();
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && modalBackdrop.classList.contains('show')) {
        closeModal();
      }
    });

    clearDetail();

    loadApplications().catch((error) => {
      alert(`載入履歷列表失敗：${error.message}`);
    });
  </script>
</body>
</html>