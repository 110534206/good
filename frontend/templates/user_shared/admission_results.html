<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>智慧實習平台 | 查看錄取結果</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    header {
      background: #0454a3;
      color: white;
      padding: 1rem 2rem;
      text-align: center;
      font-size: 1.5rem;
      font-weight: 600;
    }

    body {
      font-family: "Noto Sans TC", sans-serif;
      background: #f7f9fc;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1400px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    .card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .filter-bar {
      display: flex;
      gap: 0.75rem;
      flex-wrap: nowrap;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .filter-bar .form-select,
    .filter-bar .form-control {
      flex: 1;
      min-width: 0;
    }
    
    .filter-bar .btn {
      flex-shrink: 0;
    }

    .table {
      margin-bottom: 0;
    }

    .table thead th {
      background-color: #e9f3ff;
      color: #004a99;
      font-weight: 600;
      text-align: center;
      vertical-align: middle;
      border-bottom: 2px solid #0066cc;
    }

    .table tbody td {
      text-align: center;
      vertical-align: middle;
    }

    .table-striped > tbody > tr:nth-of-type(odd) {
      background-color: rgba(0, 0, 0, 0.02);
    }

    .status-badge {
      display: inline-block;
      padding: 0.35em 0.65em;
      font-size: 0.875rem;
      font-weight: 600;
      border-radius: 0.5rem;
      white-space: nowrap;
    }

    .status-badge.admitted {
      background-color: #28a745;
      color: white;
    }

    .status-badge.pending {
      background-color: #ffc107;
      color: #212529;
    }

    .status-badge.not-admitted {
      background-color: #6c757d;
      color: white;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #6c757d;
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .count-badge {
      display: inline-block;
      background-color: #0066cc;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.875rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }

    @media (max-width: 768px) {
      .filter-bar {
        flex-direction: column;
      }

      .filter-bar .form-select,
      .filter-bar .form-control {
        width: 100%;
      }

      .table {
        font-size: 0.875rem;
      }
    }
  </style>
</head>
<body>
  <header>查看錄取結果</header>
  
  <div class="container">
    <div class="card">
      <div class="filter-bar">
        <select id="semesterFilter" class="form-select">
          <option value="">所有學期</option>
        </select>
        <select id="classFilter" class="form-select">
          <option value="">所有班級</option>
        </select>
        <select id="companyFilter" class="form-select">
          <option value="">所有公司</option>
        </select>
        <input type="text" id="keywordSearch" class="form-control" placeholder="搜尋學生姓名、學號、公司名稱或班級..." />
        <button class="btn btn-primary" onclick="loadAdmissions()">
          <i class="fas fa-search"></i> 搜尋
        </button>
      </div>

      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">錄取結果列表</h5>
        <span class="count-badge" id="resultCount">0 筆</span>
      </div>

      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th>學號</th>
              <th>姓名</th>
              <th>學期</th>
              <th>班級</th>
              <th>錄取公司</th>
              <th>職缺名稱</th>
              <th>指導老師</th>
              <th>狀態</th>
            </tr>
          </thead>
          <tbody id="admissionTableBody">
            <tr>
              <td colspan="8" class="text-center text-muted py-4">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                載入中...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="emptyState" class="empty-state" style="display: none;">
        <i class="fas fa-inbox"></i>
        <p>目前沒有錄取紀錄</p>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let allAdmissions = [];
    let allClasses = [];
    let allCompanies = [];
    let allSemesters = [];

    // 頁面載入時初始化
    document.addEventListener('DOMContentLoaded', function() {
      initSemesterFilter();
      loadClasses();
      loadOpenCompanies();
      loadAdmissions();
      
      // 綁定搜尋框 Enter 鍵事件
      document.getElementById('keywordSearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          loadAdmissions();
        }
      });
    });

    // 載入班級列表
    async function loadClasses() {
      try {
        const response = await fetch('/ta/statistics/api/get_classes');
        const data = await response.json();
        
        console.log('班級 API 響應:', data); // 調試信息
        
        const classFilter = document.getElementById('classFilter');
        
        if (data.success && data.classes) {
          allClasses = data.classes;
          console.log('所有班級數據:', allClasses); // 調試信息
          
          // 只顯示第一個包含「忠」的班級和第一個包含「孝」的班級
          const zhongClass = allClasses.find(cls => {
            const className = cls.name || '';
            const fullName = `${cls.department || ''} ${cls.name || ''}`.trim();
            return className.includes('忠') || fullName.includes('忠');
          });
          
          const xiaoClass = allClasses.find(cls => {
            const className = cls.name || '';
            const fullName = `${cls.department || ''} ${cls.name || ''}`.trim();
            return className.includes('孝') || fullName.includes('孝');
          });
          
          // 添加忠班選項
          if (zhongClass) {
            const option = document.createElement('option');
            option.value = zhongClass.id;
            option.textContent = '忠班';
            classFilter.appendChild(option);
          }
          
          // 添加孝班選項
          if (xiaoClass) {
            const option = document.createElement('option');
            option.value = xiaoClass.id;
            option.textContent = '孝班';
            classFilter.appendChild(option);
          }
          
          if (!zhongClass && !xiaoClass) {
            console.warn('沒有找到包含「忠」或「孝」的班級');
          }
        } else {
          console.error('API 返回失敗:', data.message || '未知錯誤');
        }
      } catch (error) {
        console.error('載入班級列表失敗:', error);
      }
    }

    // 載入開放中的公司列表
    async function loadOpenCompanies() {
      try {
        const response = await fetch('/api/get_reviewed_companies');
        const data = await response.json();
        
        const companyFilter = document.getElementById('companyFilter');
        const currentValue = companyFilter.value;
        
        // 清空現有選項（保留「所有公司」）
        companyFilter.innerHTML = '<option value="">所有公司</option>';
        
        if (data.success && data.companies) {
          // 只顯示開放中的公司
          const openCompanies = data.companies.filter(company => company.is_open_current_semester === true);
          
          // 添加公司選項
          openCompanies
            .sort((a, b) => (a.company_name || '').localeCompare(b.company_name || '', 'zh-TW'))
            .forEach(company => {
              const option = document.createElement('option');
              option.value = company.id;
              option.textContent = company.company_name || '-';
              companyFilter.appendChild(option);
            });
        }
        
        // 恢復之前選擇的值
        if (currentValue) {
          companyFilter.value = currentValue;
        }
      } catch (error) {
        console.error('載入開放中公司列表失敗:', error);
      }
    }

    // 載入錄取結果
    async function loadAdmissions() {
      const tbody = document.getElementById('admissionTableBody');
      const emptyState = document.getElementById('emptyState');
      const resultCount = document.getElementById('resultCount');
      
      // 顯示載入中
      tbody.innerHTML = `
        <tr>
          <td colspan="11" class="text-center text-muted py-4">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            載入中...
          </td>
        </tr>
      `;
      emptyState.style.display = 'none';

      // 獲取篩選條件
      const semester = document.getElementById('semesterFilter').value;
      const classId = document.getElementById('classFilter').value;
      const companyId = document.getElementById('companyFilter').value;
      const keyword = document.getElementById('keywordSearch').value.trim();

      // 構建查詢參數
      const params = new URLSearchParams();
      if (semester) params.append('semester', semester);
      if (classId) params.append('class_id', classId);
      if (companyId) params.append('company_id', companyId);
      if (keyword) params.append('keyword', keyword);

      try {
        const response = await fetch(`/admission/api/get_all_admissions?${params.toString()}`);
        const data = await response.json();
        
        if (data.success) {
          allAdmissions = data.students || [];
          renderTable(allAdmissions);
          resultCount.textContent = `${data.count || 0} 筆`;
          
          // 學期選單已在頁面載入時初始化，無需更新
        } else {
          tbody.innerHTML = `
            <tr>
              <td colspan="11" class="text-center text-danger py-4">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${data.message || '載入失敗'}
              </td>
            </tr>
          `;
          resultCount.textContent = '0 筆';
        }
      } catch (error) {
        console.error('載入錄取結果失敗:', error);
        tbody.innerHTML = `
          <tr>
            <td colspan="11" class="text-center text-danger py-4">
              <i class="fas fa-exclamation-triangle me-2"></i>
              載入失敗，請稍後再試
            </td>
          </tr>
        `;
        resultCount.textContent = '0 筆';
      }
    }

    // 初始化學期選單（固定顯示 1132 和 1142）
    function initSemesterFilter() {
      const semesterFilter = document.getElementById('semesterFilter');
      const currentValue = semesterFilter.value;
      
      // 清空現有選項（保留「所有學期」）
      semesterFilter.innerHTML = '<option value="">所有學期</option>';
      
      // 添加固定的學期選項：1132 和 1142
      const fixedSemesters = ['1132', '1142'];
      fixedSemesters.forEach(sem => {
        const option = document.createElement('option');
        option.value = sem;
        option.textContent = sem;
        semesterFilter.appendChild(option);
      });
      
      // 恢復之前選擇的值
      if (currentValue) {
        semesterFilter.value = currentValue;
      }
    }

    // 渲染表格
    function renderTable(admissions) {
      const tbody = document.getElementById('admissionTableBody');
      const emptyState = document.getElementById('emptyState');
      
      if (admissions.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }
      
      emptyState.style.display = 'none';
      tbody.innerHTML = '';
      
      admissions.forEach(adm => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${escapeHtml(adm.student_number || '-')}</td>
          <td>${escapeHtml(adm.student_name || '-')}</td>
          <td>${escapeHtml(adm.semester || '-')}</td>
          <td>${escapeHtml(adm.class_name || '-')}</td>
          <td>${escapeHtml(adm.company_name || '-')}</td>
          <td>${escapeHtml(adm.job_title || '-')}</td>
          <td>${escapeHtml(adm.teacher_name || '-')}</td>
          <td>
            ${getStatusBadge(adm)}
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // 獲取狀態標籤
    function getStatusBadge(adm) {
      // 如果有錄取關係（relation_id 存在），表示已錄取
      if (adm.relation_id) {
        return '<span class="status-badge admitted">已錄取</span>';
      }
      
      // 根據 preference_status 判斷狀態
      const status = adm.preference_status;
      if (status === 'pending') {
        return '<span class="status-badge pending">審核中</span>';
      } else if (status === 'rejected') {
        return '<span class="status-badge not-admitted">未錄取</span>';
      } else if (status === 'approved') {
        return '<span class="status-badge admitted">已錄取</span>';
      }
      
      // 預設顯示已錄取（因為有錄取關係）
      return '<span class="status-badge admitted">已錄取</span>';
    }

    // HTML 轉義函數
    function escapeHtml(text) {
      if (text == null) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
