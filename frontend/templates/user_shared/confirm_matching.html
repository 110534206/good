<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>智慧實習平台 | 廠商媒合結果</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root {
      --brand-blue: #0066cc;
      --brand-blue-dark: #024689;
      --bg-light: #f5f8ff;
      --border-light: #dbe4f4;
      --text-dark: #1f2937;
      --text-muted: #6b7280;
      --success-green: #0ea5e9;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Noto Sans TC", "Segoe UI", sans-serif;
      background: #ffffff;
      color: var(--text-dark);
      position: relative;
      min-height: 100vh;
      overflow-x: hidden;
    }

    header {
      background: linear-gradient(135deg, #0055a8 0%, #006acb 50%, #004f94 100%);
      border-bottom: none;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 8px 20px rgba(0, 68, 148, 0.35);
    }

    .topbar {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      position: relative;
    }

    .topbar h1 {
      font-size: 1.5rem;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      color: #fff;
      flex: 1;
      text-align: center;
    }

    .topbar h1 i {
      color: #ffe27a;
    }

    .topbar a {
      color: #fff;
      text-decoration: none;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 9999px;
      border: 1px solid rgba(255, 255, 255, 0.75);
      transition: all 0.2s ease;
      background: rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
      position: absolute;
      right: 24px;
      top: 50%;
      transform: translateY(-50%);
    }

    .topbar a:hover {
      background: rgba(255, 255, 255, 0.25);
      color: #fff;
    }

    main {
      max-width: 1200px;
      margin: 24px auto 60px;
      padding: 0 24px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .card {
      background: #fff;
      border-radius: 22px;
      border: 1px solid rgba(0, 0, 0, 0.04);
      padding: 28px;
      box-shadow: 0 15px 45px rgba(9, 51, 121, 0.1);
    }

    .card h2 {
      font-size: 1.25rem;
      margin-top: 0;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card h2 i {
      color: var(--brand-blue);
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .summary-item {
      border: 1px solid rgba(0, 0, 0, 0.06);
      border-radius: 16px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: #fff;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.02);
    }

    .summary-item span:first-child {
      font-size: 0.95rem;
      color: var(--text-muted);
    }

    .summary-item span:last-child {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--brand-blue-dark);
    }

    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      margin-bottom: 16px;
    }

    .filter-bar label {
      font-weight: 600;
      color: var(--text-muted);
    }

    .filter-bar select,
    .filter-bar input {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border-light);
      min-width: 220px;
      font-size: 0.95rem;
      background: #fff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: rgba(0, 102, 204, 0.08);
    }

    th, td {
      padding: 12px 14px;
      text-align: left;
      border-bottom: 1px solid var(--border-light);
      font-size: 0.95rem;
      vertical-align: middle;
    }

    th {
      font-weight: 600;
      color: var(--brand-blue-dark);
    }

    tbody tr:hover {
      background: rgba(0, 102, 204, 0.05);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 600;
      background: rgba(0, 102, 204, 0.12);
      color: var(--brand-blue-dark);
    }

    .empty-state {
      padding: 36px 0;
      text-align: center;
      color: var(--text-muted);
      font-size: 1rem;
    }

    .empty-state i {
      font-size: 2.4rem;
      margin-bottom: 16px;
      color: rgba(0, 102, 204, 0.35);
    }

    .loading {
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-muted);
    }

    .loading .spinner {
      width: 18px;
      height: 18px;
      border: 3px solid rgba(0, 102, 204, 0.2);
      border-top-color: var(--brand-blue);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 768px) {
      .topbar {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }

      main {
        padding: 0 16px;
      }

      .filter-bar select,
      .filter-bar input {
        min-width: 100%;
      }

      table {
        display: block;
        overflow-x: auto;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <h1>媒合結果確認</h1>
      <a href="/vendor_home"><i class="fa-solid fa-home"></i>返回廠商首頁</a>
    </div>
  </header>

  <main>
    <section class="card">
      <h2><i class="fa-solid fa-chart-pie"></i>媒合摘要</h2>
      <div id="summaryContent" class="summary-grid">
        <div class="summary-item">
          <span>公司職缺數</span>
          <span id="summaryJobCount">-</span>
        </div>
        <div class="summary-item">
          <span>媒合學生數</span>
          <span id="summaryStudentCount">-</span>
        </div>
      </div>
      <div id="companyBreakdown" class="summary-grid" style="margin-top: 8px;"></div>
    </section>

    <section class="card">
      <h2><i class="fa-solid fa-users-gear"></i>媒合學生列表</h2>
      <div class="filter-bar">
        <label for="companyFilter">選擇職缺</label>
        <select id="companyFilter">
          <option value="">選擇職缺</option>
        </select>

        <label for="keywordInput">搜尋學生姓名</label>
        <input id="keywordInput" type="search" placeholder="輸入學生姓名">
      </div>

      <div id="tableContainer">
        <div class="loading" id="loadingState">
          <span class="spinner"></span> 資料載入中...
        </div>
      </div>
    </section>
  </main>

  <script>
    const positionFilter = document.getElementById('companyFilter');
    const keywordInput = document.getElementById('keywordInput');
    const summaryJobCount = document.getElementById('summaryJobCount');
    const summaryStudentCount = document.getElementById('summaryStudentCount');
    const summaryGrid = document.getElementById('companyBreakdown');
    const tableContainer = document.getElementById('tableContainer');

    let cachedMatches = [];
    let vendorJobs = [];
    let totalJobCount = 0; // 從職位需求管理頁面獲取的職缺總數
    let hasLoadedPositions = false; // 標記是否已經加載過職位數據
    let currentSummary = null; // 保存當前的摘要數據
    let studentResumes = []; // 從學生履歷API獲取的學生列表

    async function loadVendorPositions() {
      if (!positionFilter) return;
      positionFilter.innerHTML = '<option value="">載入職缺中...</option>';
      try {
        const res = await fetch('/vendor/api/positions', {
          headers: { 'Accept': 'application/json' },
          credentials: 'include'
        });
        const data = await res.json();
        if (!res.ok || !data.success) {
          throw new Error(data.message || '載入職缺失敗');
        }
        vendorJobs = data.items || [];
        // 從職位需求管理API獲取職缺總數
        totalJobCount = (data.stats && typeof data.stats.total === 'number') ? data.stats.total : vendorJobs.length;
        hasLoadedPositions = true; // 標記已加載職位數據
        
        positionFilter.innerHTML = '<option value="">選擇職缺</option>';
        const fragment = document.createDocumentFragment();
        vendorJobs.forEach(job => {
          if (!job || typeof job.id === 'undefined') {
            return;
          }
          const option = document.createElement('option');
          option.value = job.id;
          option.textContent = job.title || '未命名職缺';
          fragment.appendChild(option);
        });
        positionFilter.appendChild(fragment);
        
        // 如果已經有摘要數據，重新渲染摘要以更新職缺數
        if (currentSummary) {
          renderSummary(currentSummary);
        } else {
          // 否則直接更新職缺數
          if (summaryJobCount) {
            summaryJobCount.textContent = totalJobCount;
          }
        }
      } catch (error) {
        console.error('載入職缺清單失敗:', error);
        positionFilter.innerHTML = '<option value="">選擇職缺</option>';
      }
    }

    function calculateJobCount(summary) {
      // 優先使用從職位需求管理頁面獲取的職缺數
      if (hasLoadedPositions) {
        return totalJobCount;
      }
      // 備用方案：從摘要中獲取
      if (summary && typeof summary.total_jobs === 'number') {
        return summary.total_jobs;
      }
      // 最後備用方案：從媒合結果中計算
      const jobKeys = new Set();
      cachedMatches.forEach(item => {
        const jobId = item.job_id;
        if (jobId) {
          jobKeys.add(`job-${jobId}`);
        } else {
          const fallbackKey = `${item.company_id || 'company'}-${item.job_title || ''}`;
          jobKeys.add(fallbackKey);
        }
      });
      return jobKeys.size;
    }

    async function loadStudentResumes() {
      try {
        const res = await fetch('/api/get_class_resumes', {
          headers: { 'Accept': 'application/json' },
          credentials: 'include'
        });
        const data = await res.json();
        if (res.ok && data.success) {
          studentResumes = data.resumes || [];
          // 如果有已保存的摘要，重新渲染以更新學生數
          if (currentSummary) {
            renderSummary(currentSummary);
          }
        }
      } catch (error) {
        console.error('載入學生履歷失敗:', error);
      }
    }

    function calculateStudentCount() {
      // 從學生履歷API獲取的學生數量（去重，每個學生只計算一次）
      if (studentResumes && studentResumes.length > 0) {
        const uniqueStudents = new Set();
        studentResumes.forEach(resume => {
          const studentId = resume.student_number || resume.username || resume.user_id;
          if (studentId) {
            uniqueStudents.add(String(studentId));
          }
        });
        return uniqueStudents.size;
      }
      // 備用方案：從媒合結果中計算
      if (cachedMatches && cachedMatches.length > 0) {
        const uniqueStudents = new Set();
        cachedMatches.forEach(match => {
          const studentId = match.student_id || match.student_number;
          if (studentId) {
            uniqueStudents.add(String(studentId));
          }
        });
        return uniqueStudents.size;
      }
      return 0;
    }

    function renderSummary(summary) {
      // 保存摘要數據，以便在職位數據加載完成後可以重新渲染
      currentSummary = summary || {};
      
      const jobCount = calculateJobCount(summary);
      summaryJobCount.textContent = jobCount;
      
      // 從學生履歷API獲取學生數
      const studentCount = calculateStudentCount();
      summaryStudentCount.textContent = studentCount || summary.total_students || 0;

      summaryGrid.innerHTML = '';
      if (summary.by_company && summary.by_company.length) {
        summary.by_company.forEach(item => {
          const block = document.createElement('div');
          block.className = 'summary-item';
          block.innerHTML = `
            <span>${item.company_name}</span>
            <span>${item.matched_students}</span>
          `;
          summaryGrid.appendChild(block);
        });
      }
    }

    function renderTable(matches) {
      if (!matches.length) {
        tableContainer.innerHTML = `
          <div class="empty-state">
            <i class="fa-solid fa-circle-info"></i>
            <div>尚無媒合紀錄或尚未與任何公司關聯。</div>
          </div>
        `;
        return;
      }

      const rowsHtml = matches.map(row => `
        <tr>
          <td>
            <div style="font-weight:600;">${row.student_name || '-'}</div>
            <div class="text-muted" style="font-size:0.85rem;color:var(--text-muted);">${row.student_number || ''}</div>
          </td>
          <td>${row.class_department ? `${row.class_department}${row.class_name || ''}` : (row.class_name || '-')}</td>
          <td>${row.student_email || '-'}</td>
          <td>
            <div style="font-weight:600;">${row.company_name}</div>
            <div class="badge"><i class="fa-solid fa-briefcase"></i>${row.job_title || '未指定職缺'}</div>
          </td>
          <td>
            <div>志願序：${row.preference_order ?? '—'}</div>
            <div style="font-size:0.85rem;color:var(--text-muted);">提交時間：${row.preference_submitted_at || '-'}</div>
          </td>
          <td>
            <div>媒合時間：${row.admitted_at || '-'}</div>
            <div style="font-size:0.85rem;color:var(--text-muted);">學期：${row.semester || '-'}</div>
          </td>
        </tr>
      `).join('');

      tableContainer.innerHTML = `
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>學生</th>
                <th>班級</th>
                <th>Email</th>
                <th>媒合公司 / 職缺</th>
                <th>錄取志願</th>
                <th>媒合資訊</th>
              </tr>
            </thead>
            <tbody>${rowsHtml}</tbody>
          </table>
        </div>
      `;
    }

    function applyFilters() {
      const selectedJob = positionFilter.value;
      const keyword = keywordInput.value.trim().toLowerCase();

      // 構建學生履歷的姓名映射表（用於搜索）
      let studentNameMap = new Map(); // key: student_number, value: student_name
      if (studentResumes && studentResumes.length > 0) {
        studentResumes.forEach(resume => {
          const studentId = resume.student_number || resume.username;
          const studentName = resume.student_name || resume.name;
          if (studentId && studentName) {
            studentNameMap.set(String(studentId), studentName.toLowerCase());
          }
        });
      }
      
      const filtered = cachedMatches.filter(item => {
        const matchJob = !selectedJob || (item.job_id && String(item.job_id) === selectedJob);
        
        const studentNumber = String(item.student_number || '');
        
        // 如果學生履歷列表已加載，只顯示在列表中的學生
        if (studentNameMap.size > 0) {
          const studentNameFromResume = studentNameMap.get(studentNumber);
          // 如果學生不在履歷列表中，過濾掉
          if (!studentNameFromResume) {
            return false;
          }
          // 如果有搜索關鍵字，檢查學生姓名是否匹配
          if (keyword) {
            return matchJob && studentNameFromResume.includes(keyword);
          }
          // 沒有搜索關鍵字，只檢查職缺匹配
          return matchJob;
        }
        
        // 如果履歷列表未加載，使用原來的邏輯
        if (keyword) {
          return matchJob && (item.student_name && item.student_name.toLowerCase().includes(keyword));
        }
        return matchJob;
      });

      renderTable(filtered);
    }

    async function loadMatchingResults() {
      try {
        const res = await fetch('/admission/api/vendor_matching_results');
        if (!res.ok) {
          throw new Error('伺服器回應失敗');
        }

        const data = await res.json();
        if (!data.success) {
          throw new Error(data.message || '查詢失敗');
        }

        const { matches, summary, message } = data;

        cachedMatches = matches || [];
        renderSummary(summary || { total_jobs: 0, total_students: 0, by_company: [] });

        if (message && !(matches && matches.length)) {
          tableContainer.innerHTML = `
            <div class="empty-state">
              <i class="fa-solid fa-circle-info"></i>
              <div>${message}</div>
            </div>
          `;
          return;
        }

        applyFilters();
      } catch (error) {
        console.error('媒合結果載入失敗:', error);
        tableContainer.innerHTML = `
          <div class="empty-state">
            <i class="fa-solid fa-triangle-exclamation"></i>
            <div>媒合結果載入失敗：${error.message}</div>
          </div>
        `;
      }
    }

    positionFilter.addEventListener('change', applyFilters);
    keywordInput.addEventListener('input', () => {
      window.clearTimeout(keywordInput._timer);
      keywordInput._timer = setTimeout(applyFilters, 220);
    });

    loadVendorPositions();
    loadStudentResumes();
    loadMatchingResults();
  </script>
</body>
</html>

