<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <title>æ™ºæ…§å¯¦ç¿’å¹³å° | å­¸ç”Ÿç®¡ç†</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    header {
      background: #0066cc;
      color: white;
      padding: 1rem 2rem;
      text-align: center;
      font-size: 1.5rem;
    }

    body {
      font-family: "Noto Sans TC", sans-serif;
      background: #f7f9fc;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1200px;
      margin: auto;
      padding: 2rem;
    }

    /* è¡¨æ ¼ */
    table thead th,
    table td {
      text-align: center;
      vertical-align: middle;
      font-size: 0.95rem;
    }

    .custom-header-blue {
      background-color: #0066cc;
      color: white;
      border-color: #0066cc;
    }

    .filter-section {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .table-container {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 1.5rem;
    }

    .chart-container {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 1.5rem;
    }

    .chart-container h2 {
      font-size: 1.25rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 1rem;
    }

    .chart-container canvas {
      max-height: 300px;
    }

    /* çµ±è¨ˆåœ–è¡¨å®¹å™¨æ¨£å¼ - èˆ‡å…¬å¸ç®¡ç†é é¢ä¸€è‡´ */
    #statsChartsContainer {
      display: flex !important;
      flex-wrap: nowrap;
    }
    
    .stats-chart-container {
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 24px;
      flex: 1;
      min-width: 0;
    }
    
    .stats-chart-container h5 {
      font-size: 1rem;
      margin-bottom: 12px;
    }
    
    .stats-chart-container canvas {
      max-height: 250px;
    }
    
    @media (max-width: 768px) {
      #statsChartsContainer {
        flex-wrap: wrap;
      }
      .stats-chart-container {
        flex: 0 0 100%;
      }
    }
  </style>
</head>

<body>
  <header>å­¸ç”Ÿå±¥æ­·ç®¡ç†</header>
  <div class="container">
    <div class="filter-section">
      <div class="row align-items-end">
        <div class="col-md-3">
          <label for="classSelect" class="form-label">é¸æ“‡ç­ç´š</label>
          <select id="classSelect" class="form-select">
            <option value="all">æ‰€æœ‰ç­ç´š</option>
          </select>
        </div>
        <div class="col-md-3">
          <button class="btn btn-primary w-100" id="loadBtn">å­¸ç”Ÿè³‡æ–™</button>
        </div>
        <div class="col-md-3">
          <button class="btn btn-success w-100" id="exportBtn">åŒ¯å‡º Excel</button>
        </div>
        <div class="col-md-3">
          <a href="/ta/statistics/manage_companies" class="btn btn-outline-secondary w-100">è¿”å›çµ±è¨ˆé é¢</a>
        </div>
      </div>
    </div>

    <!-- çµ±è¨ˆåœ–è¡¨å€åŸŸ -->
    <div class="row g-4 mb-4" id="statsChartsContainer" style="display: none;">
      <div class="col-md-4 col-sm-12">
        <div class="stats-chart-container">
          <h5 class="text-center">ğŸ¢ å„å…¬å¸è¢«é¸å¿—é¡˜æ¬¡æ•¸</h5>
          <canvas id="companyChart"></canvas>
        </div>
      </div>
      <div class="col-md-4 col-sm-12">
        <div class="stats-chart-container">
          <h5 class="text-center">ğŸ“„ å±¥æ­·ç¹³äº¤ç‡</h5>
          <canvas id="resumeChart"></canvas>
        </div>
      </div>
      <div class="col-md-4 col-sm-12">
        <div class="stats-chart-container">
          <h5 class="text-center">ğŸ¯ å¿—é¡˜åºå¡«å¯«ç‡</h5>
          <canvas id="preferenceChart"></canvas>
        </div>
      </div>
    </div>

    <div id="classChartContainer" class="chart-container" style="display: none;">
      <h2>ç­ç´šå¯¦ç¿’é€²åº¦åˆ†æ</h2>
      <p>è«‹é¸æ“‡ä¸€å€‹ç­ç´šä»¥æŸ¥çœ‹è©³ç´°å¯¦ç¿’çµ±è¨ˆåœ–è¡¨ã€‚</p>
    </div>

    <div class="table-container">
      <table class="table table-bordered table-striped table-hover align-middle">
        <thead class="custom-header-blue">
          <tr>
            <th>å­¸è™Ÿ</th>
            <th>å§“å</th>
            <th>Email</th>
            <th>å±¥æ­·ä¸Šå‚³</th>
            <th>å¿—é¡˜å¡«å¯«</th>
          </tr>
        </thead>
        <tbody id="studentsTableBody">
          <tr>
            <td colspan="5" class="text-center text-muted">è«‹é¸æ“‡ç­ç´šä¸¦é»æ“Šã€Œå­¸ç”Ÿè³‡æ–™ã€</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let myClassChart = null; // ç”¨æ–¼å„²å­˜å–®ä¸€ç­ç´š Chart å¯¦ä¾‹
    let companyChart, resumeChart, preferenceChart; // ç”¨æ–¼å„²å­˜çµ±è¨ˆåœ–è¡¨å¯¦ä¾‹

    // è¼‰å…¥ç­ç´šåˆ—è¡¨
    async function loadClasses() {
      try {
        const res = await fetch("/ta/statistics/api/get_classes");
        const data = await res.json();
        const select = document.getElementById("classSelect");

        if (data.success) {
          // è¦æ’é™¤çš„ç­ç´šåç¨±
          const excludedClasses = ['è³‡ä¸€å­', 'è³‡äºŒå­', 'è³‡ä¸‰å­', 'è³‡ä¸€å¿ ', 'è³‡äºŒå¿ ', 'è³‡ä¸‰å¿ '];
          
          data.classes.forEach(c => {
            const className = `${c.department.replace('ç®¡ç§‘', '')}${c.name}`;
            // éæ¿¾æ‰è³‡ä¸€å­åˆ°è³‡ä¸‰å­å’Œè³‡ä¸€å¿ åˆ°è³‡ä¸‰å¿ 
            if (!excludedClasses.some(excluded => className.includes(excluded))) {
              const option = document.createElement("option");
              option.value = c.id;
              option.textContent = className;
              select.appendChild(option);
            }
          });
        }
      } catch (error) {
        console.error("è¼‰å…¥ç­ç´šåˆ—è¡¨å¤±æ•—:", error);
      }
    }

    // è¼‰å…¥å–®ä¸€ç­ç´šçš„çµ±è¨ˆåœ–è¡¨
    async function loadClassStats(classId, className) {
      const chartContainer = document.getElementById("classChartContainer");

      // è™•ç†ã€Œæ‰€æœ‰ç­ç´šã€çš„ç‰¹æ®Šæƒ…æ³
      if (classId === 'all') {
        chartContainer.style.display = 'none';
        if (myClassChart) { 
          myClassChart.destroy(); 
          myClassChart = null; 
        }
        return;
      }

      // é¡¯ç¤ºåœ–è¡¨å®¹å™¨
      chartContainer.style.display = 'block';

      // æ¸…ç©ºä¸¦æº–å‚™æ–°çš„ Chart å…ƒç´ 
      chartContainer.innerHTML = '<h2>' + className + ' å¯¦ç¿’çµ±è¨ˆåˆ†æ</h2><canvas id="classStatsChart"></canvas>';

      try {
        // å‘¼å«æ–°çš„ API è·¯ç”±
        const res = await fetch(`/ta/statistics/api/get_class_stats/${classId}`);
        const data = await res.json();

        if (!data.success) {
          if (myClassChart) { myClassChart.destroy(); myClassChart = null; }
          chartContainer.innerHTML = `<div class="text-danger">è¼‰å…¥çµ±è¨ˆåœ–è¡¨å¤±æ•—ï¼š${data.message}</div>`;
          return;
        }

        const stats = data.stats;
        const ctx = document.getElementById('classStatsChart').getContext('2d');

        // éŠ·æ¯€èˆŠçš„ Chart å¯¦ä¾‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (myClassChart) {
          myClassChart.destroy();
        }

        // ä½¿ç”¨ Chart.js ç¹ªè£½é•·æ¢åœ–
        myClassChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['ç¸½å­¸ç”Ÿæ•¸', 'å·²ä¸Šå‚³å±¥æ­·', 'å·²å¡«å¯«å¿—é¡˜'],
            datasets: [{
              label: 'äººæ•¸',
              data: [
                stats.total_students,
                stats.students_with_resume,
                stats.students_with_preference
              ],
              backgroundColor: [
                'rgba(54, 162, 235, 0.7)', // è—è‰²: ç¸½å­¸ç”Ÿæ•¸
                'rgba(75, 192, 192, 0.7)', // ç¶ è‰²: å·²ä¸Šå‚³å±¥æ­·
                'rgba(153, 102, 255, 0.7)' // ç´«è‰²: å·²å¡«å¯«å¿—é¡˜
              ],
              borderColor: [
                'rgba(54, 162, 235, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                // è¨­å®š Y è»¸çš„æœ€å¤§å€¼ç•¥å¤§æ–¼ç¸½å­¸ç”Ÿæ•¸ï¼Œä¸”è‡³å°‘ç‚º 5
                max: stats.total_students > 0 ? Math.ceil(stats.total_students * 1.05) : 5,
                ticks: {
                  precision: 0 // ç¢ºä¿ Y è»¸åˆ»åº¦æ˜¯æ•´æ•¸
                }
              },
              x: {
                grid: {
                  display: false
                }
              }
            },
            plugins: {
              legend: {
                display: false
              },
              title: {
                display: true,
                text: stats.class_name + ' å¯¦ç¿’é€²åº¦çµ±è¨ˆ'
              }
            }
          }
        });

      } catch (error) {
        console.error("Fetch error:", error);
        if (myClassChart) { myClassChart.destroy(); myClassChart = null; }
        chartContainer.innerHTML = `<div class="text-danger">ç¶²è·¯é€£ç·šæˆ–è³‡æ–™è™•ç†éŒ¯èª¤</div>`;
      }
    }

    // è¼‰å…¥å­¸ç”Ÿè³‡æ–™
    async function loadStudents() {
      const classId = document.getElementById("classSelect").value;
      const className = document.getElementById("classSelect").options[document.getElementById("classSelect").selectedIndex].text;
      const tbody = document.getElementById("studentsTableBody");
      tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">è¼‰å…¥ä¸­...</td></tr>`;

      try {
        const res = await fetch(`/ta/statistics/api/get_students_by_class?class_id=${classId}`);
        const data = await res.json();

        if (!data.success) {
          tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">è¼‰å…¥å¤±æ•—ï¼š${data.message}</td></tr>`;
          return;
        }

        if (data.students.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">è©²ç­ç´šæ²’æœ‰å­¸ç”Ÿè³‡æ–™</td></tr>`;
          return;
        }

        tbody.innerHTML = data.students.map(s => `
          <tr>
            <td>${s.username}</td>
            <td>${s.name}</td>
            <td>${s.email}</td>
            <td>${s.resume_count > 0 ? 'âœ…' : 'âŒ'}</td>
            <td>${s.preference_count > 0 ? 'âœ…' : 'âŒ'}</td>
          </tr>
        `).join("");

        // è¼‰å…¥ç­ç´šçµ±è¨ˆåœ–è¡¨
        loadClassStats(classId, className);
        
        // è¼‰å…¥çµ±è¨ˆåœ–è¡¨ï¼ˆä¸‰å€‹åœ–è¡¨ï¼‰
        loadStatsCharts(classId);

      } catch (error) {
        console.error("è¼‰å…¥å­¸ç”Ÿè³‡æ–™å¤±æ•—:", error);
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">ä¼ºæœå™¨éŒ¯èª¤ï¼Œè¼‰å…¥å¤±æ•—ã€‚</td></tr>`;
      }
    }

    // è¼‰å…¥çµ±è¨ˆåœ–è¡¨ï¼ˆä¸‰å€‹åœ–è¡¨ï¼šå„å…¬å¸è¢«é¸å¿—é¡˜æ¬¡æ•¸ã€å±¥æ­·ç¹³äº¤ç‡ã€å¿—é¡˜åºå¡«å¯«ç‡ï¼‰
    async function loadStatsCharts(classId = "all") {
      const statsContainer = document.getElementById("statsChartsContainer");
      
      // é¡¯ç¤ºçµ±è¨ˆåœ–è¡¨å®¹å™¨ï¼ˆä½¿ç”¨ flex ç¢ºä¿æ©«å‘æ’åˆ—ï¼‰
      statsContainer.style.display = "flex";
      
      let url = "/ta/statistics/api/manage_companies_stats"; 
      if (classId !== "all") url += `?class_id=${classId}`;

      try {
        const res = await fetch(url);
        const data = await res.json();

        if (!data.success) {
          console.error("è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—ï¼š" + data.message);
          return;
        }

        // å„å…¬å¸è¢«é¸å¿—é¡˜æ¬¡æ•¸
        const companies = data.top_companies.map(c => c.company_name);
        const counts = data.top_companies.map(c => c.preference_count);

        if (companyChart) companyChart.destroy();
        companyChart = new Chart(document.getElementById("companyChart"), {
          type: "bar",
          data: {
            labels: companies,
            datasets: [{ label: "å¿—é¡˜æ¬¡æ•¸", data: counts, backgroundColor: "#4e79a7" }]
          },
          options: { 
            scales: { y: { beginAtZero: true } },
            plugins: {
              legend: { display: false }
            }
          }
        });

        // å±¥æ­·ç¹³äº¤ç‡
        const resumeData = [data.resume_stats.uploaded, data.resume_stats.not_uploaded];
        const resumeTotal = resumeData.reduce((a, b) => a + b, 0);

        if (resumeChart) resumeChart.destroy();
        resumeChart = new Chart(document.getElementById("resumeChart"), {
          type: "doughnut",
          data: {
            labels: ["å·²ä¸Šå‚³", "æœªä¸Šå‚³"],
            datasets: [{ data: resumeData, backgroundColor: ["#59a14f", "#e15759"] }]
          },
          options: {
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const value = context.raw;
                    const percent = resumeTotal > 0 ? ((value / resumeTotal) * 100).toFixed(1) + '%' : '0%';
                    return `${context.label}: ${value} (${percent})`;
                  }
                }
              }
            }
          }
        });

        // å¿—é¡˜åºå¡«å¯«ç‡
        const prefData = [data.preference_stats.filled, data.preference_stats.not_filled];
        const prefTotal = prefData.reduce((a, b) => a + b, 0);

        if (preferenceChart) preferenceChart.destroy();
        preferenceChart = new Chart(document.getElementById("preferenceChart"), {
          type: "doughnut",
          data: {
            labels: ["å·²å¡«å¯«", "æœªå¡«å¯«"],
            datasets: [{ data: prefData, backgroundColor: ["#edc948", "#bab0ab"] }]
          },
          options: {
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const value = context.raw;
                    const percent = prefTotal > 0 ? ((value / prefTotal) * 100).toFixed(1) + '%' : '0%';
                    return `${context.label}: ${value} (${percent})`;
                  }
                }
              }
            }
          }
        });
      } catch (error) {
        console.error("è¼‰å…¥çµ±è¨ˆåœ–è¡¨å¤±æ•—:", error);
        statsContainer.style.display = "none";
      }
    }

    // äº‹ä»¶ç›£è½
    document.getElementById("loadBtn").addEventListener("click", loadStudents);
    
    // ç•¶ç­ç´šé¸æ“‡æ”¹è®Šæ™‚è‡ªå‹•è¼‰å…¥è³‡æ–™
    document.getElementById("classSelect").addEventListener("change", function() {
      const classId = this.value;
      if (classId !== "all") {
        loadStudents();
      } else {
        // å¦‚æœé¸æ“‡ã€Œæ‰€æœ‰ç­ç´šã€ï¼Œæ¸…ç©ºè¡¨æ ¼å’Œåœ–è¡¨
        document.getElementById("studentsTableBody").innerHTML = 
          '<tr><td colspan="5" class="text-center text-muted">è«‹é¸æ“‡ç­ç´šä¸¦é»æ“Šã€Œå­¸ç”Ÿè³‡æ–™ã€</td></tr>';
        const chartContainer = document.getElementById("classChartContainer");
        chartContainer.style.display = 'none';
        if (myClassChart) { 
          myClassChart.destroy(); 
          myClassChart = null; 
        }
        // æ¸…ç©ºçµ±è¨ˆåœ–è¡¨
        const statsContainer = document.getElementById("statsChartsContainer");
        statsContainer.style.display = 'none';
        if (companyChart) { companyChart.destroy(); companyChart = null; }
        if (resumeChart) { resumeChart.destroy(); resumeChart = null; }
        if (preferenceChart) { preferenceChart.destroy(); preferenceChart = null; }
      }
    });

    // åŒ¯å‡º Excel (æ‰€æœ‰ç­ç´š)
    document.getElementById("exportBtn").addEventListener("click", () => {
      window.location.href = `/ta/statistics/api/export_companies_stats`; // åŒ¯å‡ºæ‰€æœ‰ç­ç´šçš„çµ±è¨ˆ
    });

    // åˆå§‹è¼‰å…¥ç­ç´šåˆ—è¡¨
    loadClasses();
  </script>
</body>

</html>

