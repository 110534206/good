<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <title>æ™ºæ…§å¯¦ç¿’å¹³å° | å­¸ç”Ÿç®¡ç†</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" crossorigin="anonymous"></script>
  <style>
    * {
      box-sizing: border-box;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 1100;
      background: #0454a3;
      color: white;
      padding: 1rem 0;
      text-align: center;
      font-size: 1.5rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
    }

    /* é ‚ç«¯åˆ—å…§å®¹èˆ‡åº•ä¸‹ table åŒå¯¬ï¼ˆmax-width 1200pxï¼‰ */
    header .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 0.5rem;
    }

    /* ä¸‰æ¢ç·šé¸å–®æŒ‰éˆ• */
    .top-bar-left {
      position: fixed;
      top: 1.5rem;
      left: 7rem;
      z-index: 1300;
    }

    .top-bar-left #menu-btn {
      width: 30px;
      height: 22px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      background: none;
      border: none;
      padding: 0;
    }

    .top-bar-left #menu-btn span {
      display: block;
      width: 100%;
      height: 3px;
      background-color: white;
      border-radius: 2px;
      transition: all 0.3s ease;
    }

    #side-menu {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 320px;
      max-width: 80vw;
      background-color: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(6px);
      box-shadow: 3px 0 12px rgb(0 0 0 / 0.7);
      padding: 2rem 1.5rem;
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
      z-index: 1400;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      color: white;
      user-select: none;
    }

    #side-menu.open {
      transform: translateX(0);
    }

    #side-menu .menu-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      margin-bottom: 1.5rem;
    }

    #side-menu h2 {
      margin: 0;
      font-weight: 700;
      font-size: 1.5rem;
      text-align: left;
      flex: 1;
      color: white;
    }

    #side-menu #close-btn {
      font-size: 1.5rem;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      line-height: 1;
      width: auto;
      height: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      margin: 0;
    }

    #side-menu a {
      display: block;
      width: 100%;
      padding: 0.5rem 0;
      font-size: 1.1rem;
      color: #ddd;
      text-decoration: none;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }

    #side-menu a:hover {
      background-color: rgba(255, 255, 255, 0.15);
      color: white;
    }

    body {
      font-family: "Noto Sans TC", sans-serif;
      background: #f1f5f9;
      margin: 0;
      padding: 0;
    }

    /* èˆ‡ student_home åŒå¯¬ï¼šwidth 100%ã€max-width 1200pxã€å·¦å³ padding 0.5rem */
    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 0.5rem;
      margin-top: 2rem;
    }

    /* ç¯©é¸å€å¡ç‰‡ */
    .filter-section {
      background: #fff;
      padding: 1.5rem 1.75rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      border: 1px solid #e5e7eb;
    }

    .filter-section .form-label {
      font-weight: 600;
      color: #475569;
      font-size: 0.9rem;
      margin-bottom: 0.4rem;
    }

    .filter-section .form-select {
      border-radius: 8px;
      border-color: #cbd5e1;
      font-size: 0.95rem;
    }

    .filter-section .form-select:focus {
      border-color: #0454a3;
      box-shadow: 0 0 0 3px rgba(4, 84, 163, 0.15);
    }

    .filter-section .btn {
      border-radius: 8px;
      font-weight: 600;
      padding: 0.5rem 1rem;
      transition: all 0.2s ease;
    }

    .filter-section #loadBtn {
      background: #0454a3;
      border-color: #0454a3;
    }

    .filter-section #loadBtn:hover {
      background: #034078;
      border-color: #034078;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(4, 84, 163, 0.25);
    }

    .filter-section #exportBtn {
      background: #0d9488;
      border-color: #0d9488;
      color: #fff;
    }

    .filter-section #exportBtn:hover {
      background: #0f766e;
      border-color: #0f766e;
      color: #fff;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(13, 148, 136, 0.25);
    }

    /* è¡¨æ ¼å€å¡ç‰‡ */
    .table-container {
      background: #fff;
      padding: 1.5rem 1.75rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      border: 1px solid #e5e7eb;
      overflow: hidden;
    }

    .table-container .table-responsive {
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      overflow: hidden;
    }

    .table-container .table {
      margin-bottom: 0;
      border-collapse: collapse;
      table-layout: fixed;
      width: 100%;
    }

    .table-container .table thead th {
      background: #f8fafc;
      color: #475569;
      font-weight: 600;
      border-color: #e2e8f0;
      padding: 0.85rem 1rem;
      font-size: 1.05rem;
      text-align: center;
      vertical-align: middle;
    }

    /* æ¬„å¯¬ï¼šå±•é–‹éˆ•ï½œå­¸è™Ÿï½œå§“åï½œEmailï½œå±¥æ­·ä¸Šå‚³ï½œå¿—é¡˜å¡«å¯«ï½œæ“ä½œï¼ˆå›ºå®šæ¯”ä¾‹ï¼Œå¿—é¡˜å¡«å¯«ä¸å‡¸å‡ºï¼‰ */
    .table-container .table thead th:nth-child(1) { width: 52px; }
    .table-container .table thead th:nth-child(2) { width: 10%; }
    .table-container .table thead th:nth-child(3) { width: 9%; }
    .table-container .table thead th:nth-child(4) { width: 22%; }
    .table-container .table thead th:nth-child(5) { width: 12%; }
    .table-container .table thead th:nth-child(6) { width: 12%; }
    .table-container .table thead th:nth-child(7) { width: 23%; }

    .table-container .table tbody td {
      border-color: #e2e8f0;
      padding: 0.85rem 1rem;
      font-size: 1.05rem;
      text-align: center;
      vertical-align: middle;
    }

    /* å±¥æ­·ä¸Šå‚³ã€å¿—é¡˜å¡«å¯«æ¬„ï¼šå…§å®¹ä¸å‡¸å‡ºã€èˆ‡è¡¨é ­å°é½Š */
    .table-container .table tbody td:nth-child(5),
    .table-container .table tbody td:nth-child(6) {
      overflow: hidden;
      max-width: 0;
    }

    .table-container .table tbody td:nth-child(5) .badge,
    .table-container .table tbody td:nth-child(6) .badge {
      display: inline-block;
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      vertical-align: middle;
      font-size: 0.95rem;
      padding: 0.35em 0.65em;
    }

    .table-container .table tbody td .btn {
      font-size: 1rem;
    }

    .table-container .table tbody tr:hover td {
      background-color: #f8fafc;
    }

    .table-container .table-striped > tbody > tr:nth-of-type(odd) > * {
      --bs-table-accent-bg: #fafbfc;
    }

    /* åœ–è¡¨å€å¡ç‰‡ */
    .chart-container {
      background: #fff;
      padding: 1.5rem 1.75rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      border: 1px solid #e5e7eb;
    }

    .chart-container h2 {
      font-size: 1.2rem;
      font-weight: 600;
      color: #334155;
      margin-bottom: 0.5rem;
    }

    .chart-container p {
      color: #64748b;
      font-size: 0.95rem;
      margin-bottom: 0;
    }

    .chart-container canvas {
      max-height: 300px;
    }

    /* ä¸Šä¸­ä¸‹å€å¡Šèˆ‡ä¸­é–“åœ–è¡¨åŒå¯¬ */
    .content-width-match {
      width: 100%;
    }

    /* çµ±è¨ˆåœ–è¡¨å€ï¼ˆä¸‰æ¬„ç­‰å¯¬ï¼‰ */
    #statsChartsContainer {
      display: flex !important;
      flex-wrap: nowrap;
      gap: 1.25rem;
      margin-bottom: 1.5rem;
      width: 100%;
    }

    #statsChartsContainer > .stats-chart-container {
      flex: 1;
      min-width: 0;
    }

    .stats-chart-container {
      background: #fff;
      border-radius: 12px;
      padding: 1.25rem 1.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      border: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
    }

    .stats-chart-container h5 {
      font-size: 1rem;
      font-weight: 600;
      color: #334155;
      margin-bottom: 1rem;
      flex-shrink: 0;
    }

    /* å›ºå®šé«˜åº¦å®¹å™¨ï¼Œæ­é… Chart.js maintainAspectRatio: false é¿å…åœ–è¡¨å‡¸å‡º */
    .stats-chart-canvas-wrap {
      height: 250px;
      min-height: 250px;
      position: relative;
      width: 100%;
    }

    .stats-chart-canvas-wrap canvas {
      display: block;
      width: 100% !important;
      height: 100% !important;
    }

    @media (max-width: 768px) {
      #statsChartsContainer {
        flex-wrap: wrap;
      }
      #statsChartsContainer > .stats-chart-container {
        flex: 0 0 100%;
      }
    }

    /* è©³ç´°è³‡è¨Šæ¨£å¼ */
    .detail-row {
      background-color: #f8f9fa;
    }
    
    .detail-row td {
      padding: 0 !important;
    }
    
    .resume-details, .preference-details {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .resume-details .border, .preference-details .border {
      background-color: white;
    }
    
    .toggle-details {
      border: none;
      background: transparent;
      padding: 0.25rem 0.5rem;
    }
    
    .toggle-details:hover {
      background-color: #e9ecef;
      border-radius: 4px;
    }
    
    .toggle-icon {
      font-size: 0.75rem;
      transition: transform 0.2s;
    }
  </style>
</head>

<body class="p-0">
  <header>
    <div class="header-inner">å­¸ç”Ÿå±¥æ­·ç®¡ç†</div>
  </header>
  <div class="top-bar-left">
    <div id="menu-btn" title="é¸å–®" role="button" tabindex="0">
      <span></span><span></span><span></span>
    </div>
  </div>

  <!-- å´é‚Šé¸å–®ï¼ˆèˆ‡ manage_companies ä¸€è‡´ï¼‰ -->
  <nav id="side-menu">
    <div class="menu-header">
      <h2>åŠŸèƒ½é¸å–®</h2>
      <button id="close-btn">Ã—</button>
    </div>
    <a href="/ta_home">é¦–é </a>
    <a href="/profile">å€‹äººè³‡æ–™</a>
    <a href="/notifications">å…¬å‘Š</a>
    <a href="/ta/statistics/manage_companies">å¯¦ç¿’æŠ•éæµç¨‹ç®¡ç†</a>
    <a href="/ta/interview_schedule">è¡Œäº‹æ›†</a>
    <a href="/final_results">åª’åˆçµæœç¢ºèª</a>
    <a href="/admin/absence_default_range">ç¼ºå‹¤é è¨­å­¸æœŸç¯„åœè¨­å®š</a>
    <a href="/ta/upload_standard_courses">å°ˆæ¥­æ ¸å¿ƒç§‘ç›®ç®¡ç†</a>
    <a href="/login">ç™»å‡º</a>
  </nav>

  <div class="container">
    <div class="filter-section content-width-match">
      <div class="row align-items-end g-3">
        <div class="col-md-3">
          <label for="semesterSelect" class="form-label">é¸æ“‡å­¸å¹´</label>
          <select id="semesterSelect" class="form-select">
            <option value="all" selected>æ‰€æœ‰å­¸å¹´</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="classSelect" class="form-label">é¸æ“‡ç­ç´š</label>
          <select id="classSelect" class="form-select">
            <option value="all" selected>æ‰€æœ‰ç­ç´š</option>
          </select>
        </div>
        <div class="col-md-3">
          <button class="btn btn-primary w-100" id="loadBtn">å­¸ç”Ÿè³‡æ–™</button>
        </div>
        <div class="col-md-3">
          <button class="btn btn-success w-100" id="exportBtn">åŒ¯å‡º Excel</button>
        </div>
      </div>
    </div>

    <!-- çµ±è¨ˆåœ–è¡¨å€åŸŸï¼ˆä¸‰å¼µå¡ç‰‡ç­‰å¯¬ï¼Œcanvas å›ºå®šé«˜åº¦ 250pxï¼‰ -->
    <div id="statsChartsContainer" style="display: none;">
      <div class="stats-chart-container">
        <h5 class="text-center">ğŸ¢ å„å…¬å¸è¢«é¸å¿—é¡˜æ¬¡æ•¸</h5>
        <div class="stats-chart-canvas-wrap">
          <canvas id="companyChart"></canvas>
        </div>
      </div>
      <div class="stats-chart-container">
        <h5 class="text-center">ğŸ“„ å±¥æ­·ç¹³äº¤ç‡</h5>
        <div class="stats-chart-canvas-wrap">
          <canvas id="resumeChart"></canvas>
        </div>
      </div>
      <div class="stats-chart-container">
        <h5 class="text-center">ğŸ¯ å¿—é¡˜åºå¡«å¯«ç‡</h5>
        <div class="stats-chart-canvas-wrap">
          <canvas id="preferenceChart"></canvas>
        </div>
      </div>
    </div>

    <div id="classChartContainer" class="chart-container" style="display: none;">
      <h2>ç­ç´šå¯¦ç¿’é€²åº¦åˆ†æ</h2>
      <p>è«‹é¸æ“‡ä¸€å€‹ç­ç´šä»¥æŸ¥çœ‹è©³ç´°å¯¦ç¿’çµ±è¨ˆåœ–è¡¨ã€‚</p>
    </div>

    <div class="table-container content-width-match">
      <div class="table-responsive">
        <table class="table table-bordered table-striped table-hover align-middle">
          <thead>
            <tr>
              <th style="width: 50px;"></th>
              <th>å­¸è™Ÿ</th>
              <th>å§“å</th>
              <th>Email</th>
              <th>å±¥æ­·ä¸Šå‚³</th>
              <th>å¿—é¡˜å¡«å¯«</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="studentsTableBody">
            <tr>
              <td colspan="7" class="text-center text-muted">è«‹å…ˆé¸æ“‡å­¸å¹´</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- å­¸ç”Ÿè©³æƒ… Modal -->
  <div class="modal fade" id="studentDetailModal" tabindex="-1" aria-labelledby="studentDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content" style="font-size: 1.1rem;">
        <div class="modal-header">
          <h4 class="modal-title flex-grow-1" id="studentDetailModalLabel" style="font-size: 1.5rem; font-weight: bold;">å­¸ç”Ÿè©³æƒ…</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" style="font-size: 1.1rem;">
          <div class="mb-4">
            <h5 class="text-primary mb-3" style="font-size: 1.3rem; font-weight: bold;">å­¸ç”ŸåŸºæœ¬è³‡è¨Š</h5>
            <p class="mb-2" style="font-size: 1.1rem;"><strong>å­¸è™Ÿï¼š</strong><span id="modalStudentNumber"></span></p>
            <p class="mb-2" style="font-size: 1.1rem;"><strong>å§“åï¼š</strong><span id="modalStudentName"></span></p>
            <p class="mb-2" style="font-size: 1.1rem;"><strong>Emailï¼š</strong><span id="modalStudentEmail"></span></p>
            <p class="mb-0" style="font-size: 1.1rem;"><strong>ç­ç´šï¼š</strong><span id="modalStudentClass"></span></p>
          </div>
          <hr style="margin: 1.5rem 0;">
          <!-- å±¥æ­·è³‡è¨Šï¼ˆåœ¨ä¸Šï¼‰ -->
          <div class="mb-4">
            <h5 class="text-primary mb-3" style="font-size: 1.3rem; font-weight: bold;">ğŸ“„ å±¥æ­·è³‡è¨Š</h5>
            <div id="modalResumeDetails" class="resume-details" style="max-height: 500px; overflow-y: auto; padding: 0.5rem; font-size: 1.05rem;">
              <p class="text-muted mb-0">è¼‰å…¥ä¸­...</p>
            </div>
          </div>
          <hr style="margin: 1.5rem 0;">
          <!-- å¿—é¡˜åºè³‡è¨Šï¼ˆåœ¨ä¸‹ï¼‰ -->
          <div class="mb-4">
            <h5 class="text-primary mb-3" style="font-size: 1.3rem; font-weight: bold;">ğŸ¯ å¿—é¡˜åºè³‡è¨Š</h5>
            <div id="modalPreferenceDetails" class="preference-details" style="max-height: 500px; overflow-y: auto; padding: 0.5rem; font-size: 1.05rem;">
              <p class="text-muted mb-0">è¼‰å…¥ä¸­...</p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary btn-lg" data-bs-dismiss="modal" style="font-size: 1.1rem;">é—œé–‰</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let myClassChart = null; // ç”¨æ–¼å„²å­˜å–®ä¸€ç­ç´š Chart å¯¦ä¾‹
    let companyChart, resumeChart, preferenceChart; // ç”¨æ–¼å„²å­˜çµ±è¨ˆåœ–è¡¨å¯¦ä¾‹
    let allClassesData = []; // å„²å­˜æ‰€æœ‰ç­ç´šè³‡æ–™
    let currentStudentsData = []; // å„²å­˜ç•¶å‰é¡¯ç¤ºçš„å­¸ç”Ÿè³‡æ–™
    let studentDetailModal = null; // Modal å¯¦ä¾‹

    // å´é‚Šé¸å–®é–‹é—œï¼ˆèˆ‡ manage_companies ä¸€è‡´ï¼‰
    const menuBtn = document.getElementById("menu-btn");
    const sideMenu = document.getElementById("side-menu");
    const closeBtn = document.getElementById("close-btn");
    if (menuBtn) menuBtn.addEventListener("click", () => {
      sideMenu.classList.add("open");
      sideMenu.setAttribute("aria-hidden", "false");
    });
    if (closeBtn) closeBtn.addEventListener("click", () => {
      sideMenu.classList.remove("open");
      sideMenu.setAttribute("aria-hidden", "true");
    });
    document.addEventListener("click", (e) => {
      if (sideMenu && menuBtn && !sideMenu.contains(e.target) && !menuBtn.contains(e.target)) {
        sideMenu.classList.remove("open");
        sideMenu.setAttribute("aria-hidden", "true");
      }
    });

    // å›ºå®šè¼‰å…¥ 1132ã€1142 å…©å€‹å­¸å¹´ï¼ˆä¸è‡ªå‹•é¸æ“‡ï¼Œä¿ç•™ã€Œæ‰€æœ‰å­¸å¹´ã€é¸é …ï¼‰
    function loadSemesters() {
      const semesterSelect = document.getElementById("semesterSelect");
      const semesters = ['1132', '1142'];

      // ä¿ç•™ã€Œæ‰€æœ‰å­¸å¹´ã€é¸é …ï¼Œç„¶å¾Œæ·»åŠ å…·é«”å­¸å¹´é¸é …
      semesterSelect.innerHTML = '<option value="all" selected>æ‰€æœ‰å­¸å¹´</option>';
      semesters.forEach(code => {
        const option = document.createElement("option");
        option.value = code;
        option.textContent = code;
        semesterSelect.appendChild(option);
      });
      semesterSelect.disabled = false;
      // ä¸è‡ªå‹•é¸æ“‡ç¬¬ä¸€å€‹ï¼Œä¿æŒã€Œæ‰€æœ‰å­¸å¹´ã€ç‚ºé è¨­å€¼
    }

    // å¾ç­ç´šåç¨±ä¸­æå–ã€Œå¿ ã€ã€ã€Œå­ã€ç­‰å­—
    function extractClassShortName(className) {
      const classNames = ['å¿ ', 'å­', 'ä»', 'æ„›', 'ä¿¡', 'ç¾©', 'å’Œ', 'å¹³', 'ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'];
      for (const name of classNames) {
        if (className.includes(name)) {
          return name;
        }
      }
      // å¦‚æœæ²’æ‰¾åˆ°ï¼Œå˜—è©¦ç§»é™¤æ•¸å­—å’Œå¸¸è¦‹å‰ç¶´
      let shortName = className.replace(/^[^å¿ å­ä»æ„›ä¿¡ç¾©å’Œå¹³ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸]+/, '');
      if (!shortName) {
        shortName = className.slice(-1);
      }
      return shortName;
    }

    // è¼‰å…¥æ‰€æœ‰ç­ç´šè³‡æ–™
    async function loadAllClasses() {
      try {
        const res = await fetch("/ta/statistics/api/get_classes");
        const data = await res.json();
        
        if (data.success) {
          const rawClasses = data.classes || [];
          // è¦æ’é™¤çš„ç­ç´šåç¨±ï¼ˆæ’é™¤ä¸€ã€äºŒã€ä¸‰å¹´ç´šï¼Œä¿ç•™å››å¹´ç´šï¼‰
          const excludedClasses = ['è³‡ä¸€å­', 'è³‡äºŒå­', 'è³‡ä¸‰å­', 'è³‡ä¸€å¿ ', 'è³‡äºŒå¿ ', 'è³‡ä¸‰å¿ '];
          const allowedSemesterCodes = ['1132', '1142'];
          
          console.log('[DEBUG] è¼‰å…¥ç­ç´šåˆ—è¡¨ï¼Œæ’é™¤:', excludedClasses);

          const normalizeClasses = classes => classes.map(c => {
            let semesterCode = '';
            if (c.semester_code) {
              semesterCode = String(c.semester_code);
            } else if (c.admission_year) {
              const yearStr = String(c.admission_year);
              semesterCode = yearStr.length >= 4 ? yearStr : `${yearStr}2`;
            }
            return {
              ...c,
              semester_code: semesterCode
            };
          });

          let normalized = normalizeClasses(rawClasses).filter(c => {
            const fullClassName = `${(c.department || '').replace('ç®¡ç§‘', '')}${c.name || ''}`;
            if (excludedClasses.some(excluded => fullClassName.includes(excluded))) {
              return false;
            }
            const semesterCode = c.semester_code || '';
            return semesterCode && allowedSemesterCodes.includes(semesterCode);
          });

          // è‹¥ä¾æŒ‡å®šå­¸å¹´éæ¿¾å¾Œæ²’æœ‰è³‡æ–™ï¼Œé€€å›ä½¿ç”¨å…¨éƒ¨ç­ç´šï¼ˆä»æ’é™¤æŒ‡å®šç­ç´šï¼‰
          if (normalized.length === 0) {
            normalized = normalizeClasses(
              rawClasses.filter(c => {
                const fullClassName = `${(c.department || '').replace('ç®¡ç§‘', '')}${c.name || ''}`;
                return !excludedClasses.some(excluded => fullClassName.includes(excluded));
              })
            );
          }

          allClassesData = normalized;
        }
      } catch (error) {
        console.error("è¼‰å…¥ç­ç´šåˆ—è¡¨å¤±æ•—:", error);
      }
    }

    // è¼‰å…¥æ‰€æœ‰ç­ç´šé¸é …ï¼ˆä¸é™å­¸å¹´ï¼Œåªé¡¯ç¤ºå¿ ã€å­å…©ç­ï¼‰
    function loadAllClassesOptions() {
      const classSelect = document.getElementById("classSelect");
      classSelect.innerHTML = '<option value="all" selected>æ‰€æœ‰ç­ç´š</option>';
      classSelect.disabled = false;
      
      // åªé¡¯ç¤ºã€Œå¿ ã€ã€ã€Œå­ã€å…©ç­
      const allowedClasses = ['å¿ ', 'å­'];
      
      // æå–ç­ç´šåç¨±ï¼ˆå¿ ã€å­ç­‰ï¼‰
      const classMap = new Map(); // ç”¨ä¾†å»é‡ï¼ˆåŒä¸€å€‹ç­ç´šåç¨±å¯èƒ½æœ‰å¤šå€‹ç­ç´šIDï¼‰
      
      allClassesData.forEach(c => {
        const fullName = `${(c.department || '').replace('ç®¡ç§‘', '')}${c.name || ''}`;
        let classShortName = null;
        if (fullName.includes('å¿ ')) {
          classShortName = 'å¿ ';
        } else if (fullName.includes('å­')) {
          classShortName = 'å­';
        } else {
          // é€€è€Œæ±‚å…¶æ¬¡ä½¿ç”¨åŸé‚è¼¯è¾¨è­˜
          const extracted = extractClassShortName(fullName);
          if (allowedClasses.includes(extracted)) {
            classShortName = extracted;
          }
        }

        if (classShortName && allowedClasses.includes(classShortName)) {
          if (!classMap.has(classShortName)) {
            classMap.set(classShortName, []);
          }
          classMap.get(classShortName).push(c);
        }
      });
      
      // ä¾ allowedClasses é †åºï¼ˆå¿ ã€å­ï¼‰åŠ å…¥
      allowedClasses.forEach(className => {
        const classes = classMap.get(className);
        if (classes && classes.length > 0) {
          // é¸æ“‡ç¬¬ä¸€å€‹åŒ¹é…çš„ç­ç´š
          const classData = classes[0];
          const option = document.createElement("option");
          option.value = classData.id;
          option.textContent = className; // åªé¡¯ç¤ºã€Œå¿ ã€æˆ–ã€Œå­ã€
          classSelect.appendChild(option);
        }
      });
    }

    // è¼‰å…¥å–®ä¸€ç­ç´šçš„çµ±è¨ˆåœ–è¡¨
    async function loadClassStats(classId, className, semesterCode = "all") {
      // æª¢æŸ¥ Chart.js æ˜¯å¦å·²è¼‰å…¥
      if (typeof Chart === 'undefined') {
        console.error("Chart.js æœªæ­£ç¢ºè¼‰å…¥");
        return;
      }

      const chartContainer = document.getElementById("classChartContainer");

      // è™•ç†ã€Œæ‰€æœ‰ç­ç´šã€çš„ç‰¹æ®Šæƒ…æ³
      if (classId === 'all') {
        chartContainer.style.display = 'none';
        if (myClassChart) { 
          myClassChart.destroy(); 
          myClassChart = null; 
        }
        return;
      }

      // åˆ¤æ–·æ˜¯å¦ç‚ºã€Œ1142å­ç­ã€ï¼Œå¦‚æœæ˜¯å‰‡å¼·åˆ¶è³‡æ–™ç‚º 0
      const is1142Xiao = semesterCode === '1142' && className.includes('å­');

      // é¡¯ç¤ºåœ–è¡¨å®¹å™¨
      chartContainer.style.display = 'block';

      // æ¸…ç©ºä¸¦æº–å‚™æ–°çš„ Chart å…ƒç´ 
      chartContainer.innerHTML = '<h2>' + className + ' å¯¦ç¿’çµ±è¨ˆåˆ†æ</h2><canvas id="classStatsChart"></canvas>';

      try {
        let stats;
        
        // å¦‚æœæ˜¯ã€Œ1142å­ç­ã€ï¼Œå¼·åˆ¶è³‡æ–™ç‚º 0
        if (is1142Xiao) {
          console.log('[DEBUG] 1142å­ç­ï¼šå¼·åˆ¶ç­ç´šçµ±è¨ˆåœ–è¡¨è³‡æ–™ç‚º 0');
          stats = {
            total_students: 0,
            students_with_resume: 0,
            students_with_preference: 0,
            class_name: 'æ‰€æœ‰å­ç­'
          };
        } else {
          // å‘¼å«æ–°çš„ API è·¯ç”±
          const res = await fetch(`/ta/statistics/api/get_class_stats/${classId}?semester_code=${semesterCode}`);
          const data = await res.json();
          
          if (!data.success) {
            if (myClassChart) { myClassChart.destroy(); myClassChart = null; }
            chartContainer.innerHTML = `<div class="text-danger">è¼‰å…¥çµ±è¨ˆåœ–è¡¨å¤±æ•—ï¼š${data.message}</div>`;
            return;
          }
          
          stats = data.stats;
        }

        console.log('[DEBUG] ç­ç´šçµ±è¨ˆè³‡æ–™:', stats);
        
        // ç¢ºä¿è³‡æ–™æ˜¯æ•¸å­—
        const totalStudents = parseInt(stats.total_students) || 0;
        const studentsWithResume = parseInt(stats.students_with_resume) || 0;
        const studentsWithPreference = parseInt(stats.students_with_preference) || 0;
        
        console.log('[DEBUG] åœ–è¡¨è³‡æ–™:', {
          totalStudents,
          studentsWithResume,
          studentsWithPreference
        });
        
        const ctx = document.getElementById('classStatsChart').getContext('2d');

        // éŠ·æ¯€èˆŠçš„ Chart å¯¦ä¾‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (myClassChart) {
          myClassChart.destroy();
        }

        // ä½¿ç”¨ Chart.js ç¹ªè£½é•·æ¢åœ–
        myClassChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['ç¸½å­¸ç”Ÿæ•¸', 'å·²ä¸Šå‚³å±¥æ­·', 'å·²å¡«å¯«å¿—é¡˜'],
            datasets: [{
              label: 'äººæ•¸',
              data: [
                totalStudents,
                studentsWithResume,
                studentsWithPreference
              ],
              backgroundColor: [
                'rgba(54, 162, 235, 0.7)', // è—è‰²: ç¸½å­¸ç”Ÿæ•¸
                'rgba(75, 192, 192, 0.7)', // ç¶ è‰²: å·²ä¸Šå‚³å±¥æ­·
                'rgba(153, 102, 255, 0.7)' // ç´«è‰²: å·²å¡«å¯«å¿—é¡˜
              ],
              borderColor: [
                'rgba(54, 162, 235, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                // è¨­å®š Y è»¸çš„æœ€å¤§å€¼ç•¥å¤§æ–¼ç¸½å­¸ç”Ÿæ•¸ï¼Œä¸”è‡³å°‘ç‚º 5
                max: totalStudents > 0 ? Math.ceil(totalStudents * 1.2) : 5,
                ticks: {
                  precision: 0, // ç¢ºä¿ Y è»¸åˆ»åº¦æ˜¯æ•´æ•¸
                  stepSize: 1
                }
              },
              x: {
                grid: {
                  display: false
                }
              }
            },
            plugins: {
              legend: {
                display: false
              },
              title: {
                display: true,
                text: stats.class_name + ' å¯¦ç¿’é€²åº¦çµ±è¨ˆ'
              }
            }
          }
        });

      } catch (error) {
        console.error("Fetch error:", error);
        if (myClassChart) { myClassChart.destroy(); myClassChart = null; }
        chartContainer.innerHTML = `<div class="text-danger">ç¶²è·¯é€£ç·šæˆ–è³‡æ–™è™•ç†éŒ¯èª¤</div>`;
      }
    }

    // è¼‰å…¥å­¸ç”Ÿè³‡æ–™
    async function loadStudents() {
      const semesterCode = document.getElementById("semesterSelect").value;
      const classId = document.getElementById("classSelect").value;
      const className = document.getElementById("classSelect").options[document.getElementById("classSelect").selectedIndex].text;
      const tbody = document.getElementById("studentsTableBody");
      tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">è¼‰å…¥ä¸­...</td></tr>`;

      // æª¢æŸ¥æ˜¯å¦å·²é¸æ“‡å­¸å¹´å’Œç­ç´š
      if (semesterCode === 'all') {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">è«‹å…ˆé¸æ“‡å­¸å¹´</td></tr>`;
        return;
      }

      if (classId === 'all') {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">è«‹é¸æ“‡ç­ç´š</td></tr>`;
        return;
      }

      try {
        console.log(`[DEBUG] è¼‰å…¥å­¸ç”Ÿè³‡æ–™: class_id=${classId}, semester_code=${semesterCode}`);
        const url = `/ta/statistics/api/get_students_by_class?class_id=${classId}&semester_code=${semesterCode}`;
        console.log(`[DEBUG] API URL: ${url}`);
        
        const res = await fetch(url);
        console.log(`[DEBUG] API å›æ‡‰ç‹€æ…‹: ${res.status} ${res.statusText}`);
        
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const data = await res.json();
        
        console.log('[DEBUG] API è¿”å›è³‡æ–™:', JSON.stringify(data, null, 2));
        console.log('[DEBUG] å­¸ç”Ÿæ•¸é‡:', data.students ? data.students.length : 0);
        
        if (data.students && data.students.length > 0) {
          console.log('[DEBUG] ç¬¬ä¸€ä½å­¸ç”Ÿå®Œæ•´è³‡æ–™:', JSON.stringify(data.students[0], null, 2));
        }

        if (!data.success) {
          let errorMsg = data.message || 'è¼‰å…¥å¤±æ•—';
          if (errorMsg === 'æœªæˆæ¬Š' || res.status === 403) {
            errorMsg = 'æ¬Šé™ä¸è¶³ï¼šæ­¤åŠŸèƒ½åƒ…é™ç§‘åŠ©å’Œç®¡ç†å“¡ä½¿ç”¨ã€‚è«‹ç¢ºèªæ‚¨å·²ä»¥æ­£ç¢ºè§’è‰²ç™»å…¥ã€‚';
          }
          console.error('[ERROR] API è¿”å›éŒ¯èª¤:', errorMsg);
          tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">${errorMsg}</td></tr>`;
          return;
        }

        // åˆ¤æ–·æ˜¯å¦ç‚ºã€Œ1142å­ç­ã€ï¼Œå¦‚æœæ˜¯å‰‡å¼·åˆ¶é¡¯ç¤ºç‚ºæ²’æœ‰è³‡æ–™
        const is1142Xiao = semesterCode === '1142' && className === 'å­';
        
        // å¦‚æœæ˜¯ã€Œ1142å­ç­ã€ï¼Œå¼·åˆ¶å°‡è³‡æ–™è¨­ç‚ºç©º
        if (is1142Xiao) {
          data.students = [];
          console.log('[DEBUG] 1142å­ç­ï¼šå¼·åˆ¶é¡¯ç¤ºç‚ºæ²’æœ‰è³‡æ–™');
        }
        
        // é¡¯ç¤ºå­¸ç”Ÿåˆ—è¡¨è¡¨æ ¼ï¼ˆç„¡è«–æ˜¯å¦æœ‰è³‡æ–™ï¼Œéƒ½è¦é¡¯ç¤ºç‰ˆé¢ï¼‰
        const tableContainer = document.querySelector('.table-container');
        if (tableContainer) tableContainer.style.display = 'block';
        
        if (!data.students || data.students.length === 0) {
          console.warn('[WARN] æ²’æœ‰å­¸ç”Ÿè³‡æ–™');
          // é¡¯ç¤ºè¡¨æ ¼ç‰ˆé¢ï¼Œä½†å…§å®¹é¡¯ç¤ºã€Œè©²ç­ç´šæ²’æœ‰å­¸ç”Ÿè³‡æ–™ã€
          tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">è©²ç­ç´šæ²’æœ‰å­¸ç”Ÿè³‡æ–™</td></tr>`;
          
          // å¦‚æœæ²’æœ‰å­¸ç”Ÿè³‡æ–™ï¼Œä»ç„¶é¡¯ç¤ºç­ç´šçµ±è¨ˆåœ–è¡¨ï¼ˆä½†è³‡æ–™ç‚º 0ï¼‰
          const chartContainer = document.getElementById("classChartContainer");
          if (chartContainer) chartContainer.style.display = 'block';
          
          // çµ„åˆé¡¯ç¤ºåç¨±ï¼šå­¸å¹´+ç­ç´š
          const displayName = `${semesterCode}${className}`;
          
          // è¼‰å…¥ç­ç´šçµ±è¨ˆåœ–è¡¨ï¼ˆå³ä½¿æ²’æœ‰å­¸ç”Ÿï¼Œä¹Ÿæœƒé¡¯ç¤º 0ï¼‰
          loadClassStats(classId, displayName, semesterCode);
          
          // éš±è—ä¸‰å€‹çµ±è¨ˆåœ–è¡¨ï¼ˆå„å…¬å¸è¢«é¸å¿—é¡˜æ¬¡æ•¸ã€å±¥æ­·ç¹³äº¤ç‡ã€å¿—é¡˜åºå¡«å¯«ç‡ï¼‰
          const statsContainer = document.getElementById("statsChartsContainer");
          if (statsContainer) statsContainer.style.display = 'none';
          if (companyChart) { companyChart.destroy(); companyChart = null; }
          if (resumeChart) { resumeChart.destroy(); resumeChart = null; }
          if (preferenceChart) { preferenceChart.destroy(); preferenceChart = null; }
          return; // ä¸ç¹¼çºŒåŸ·è¡Œå¾ŒçºŒçš„ä¸‰å€‹çµ±è¨ˆåœ–è¡¨è¼‰å…¥
        } else {
          console.log('[DEBUG] é–‹å§‹æ¸²æŸ“å­¸ç”Ÿåˆ—è¡¨ï¼Œå…±', data.students.length, 'ä½å­¸ç”Ÿ');
          
          // éæ¿¾æ‰ã€Œè³‡ä¸‰å­ã€çš„å­¸ç”Ÿ
          const filteredStudents = data.students.filter(s => {
            const studentClass = s.class_name ? `${s.department ? s.department.replace('ç®¡ç§‘', '') : ''}${s.class_name}` : '';
            // éš±è—ã€Œè³‡ä¸‰å­ã€çš„å­¸ç”Ÿ
            return !studentClass.includes('ä¸‰å­');
          });
          
          console.log('[DEBUG] éæ¿¾å¾Œå­¸ç”Ÿæ•¸é‡:', filteredStudents.length, '(åŸå§‹:', data.students.length, ')');
          
          // å¦‚æœéæ¿¾å¾Œæ²’æœ‰å­¸ç”Ÿï¼Œé¡¯ç¤ºã€Œè©²ç­ç´šæ²’æœ‰å­¸ç”Ÿè³‡æ–™ã€
          if (filteredStudents.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">è©²ç­ç´šæ²’æœ‰å­¸ç”Ÿè³‡æ–™</td></tr>`;
            currentStudentsData = []; // æ¸…ç©ºå­¸ç”Ÿè³‡æ–™
          } else {
            // å„²å­˜å­¸ç”Ÿè³‡æ–™ä¾› Modal ä½¿ç”¨
            currentStudentsData = filteredStudents;
            
            tbody.innerHTML = filteredStudents.map((s, index) => {
            // èª¿è©¦è¼¸å‡º
            if (index === 0) {
              console.log('[DEBUG] ç¬¬ä¸€ä½å­¸ç”Ÿè³‡æ–™ç¯„ä¾‹:', {
                id: s.id,
                username: s.username,
                name: s.name,
                resume_count: s.resume_count,
                preference_count: s.preference_count,
                resumes: s.resumes ? s.resumes.length : 0,
                preferences: s.preferences ? s.preferences.length : 0
              });
            }
            
            const resumeStatus = (s.resume_count && s.resume_count > 0) ? 
              `<span class="badge bg-success">å·²ä¸Šå‚³ (${s.resume_count})</span>` : 
              '<span class="badge bg-danger">æœªä¸Šå‚³</span>';
            const preferenceStatus = (s.preference_count && s.preference_count > 0) ? 
              `<span class="badge bg-success">å·²å¡«å¯« (${s.preference_count})</span>` : 
              '<span class="badge bg-danger">æœªå¡«å¯«</span>';
            
            // å±¥æ­·è©³ç´°è³‡è¨Š
            const resumeDetails = s.resumes && s.resumes.length > 0 ? s.resumes.map(r => `
              <div class="mb-2 p-2 border rounded">
                <strong>å±¥æ­·</strong><br>
                <small>ç‹€æ…‹: <span class="badge ${r.status === 'approved' ? 'bg-success' : r.status === 'rejected' ? 'bg-danger' : 'bg-warning'}">${r.status === 'approved' ? 'å·²å¯©æ ¸' : r.status === 'rejected' ? 'å·²é€€ä»¶' : 'å¾…å¯©æ ¸'}</span></small><br>
                <small>ä¸Šå‚³æ™‚é–“: ${r.created_at || 'N/A'}</small><br>
                ${r.reviewed_at ? `<small>å¯©æ ¸æ™‚é–“: ${r.reviewed_at}</small><br>` : ''}
                ${r.reject_reason ? `<small class="text-danger">é€€ä»¶åŸå› : ${r.reject_reason}</small><br>` : ''}
                <a href="/api/download_resume/${r.id}" class="btn btn-primary btn-sm mt-2" download style="font-size: 0.875rem;">
                  <i class="fas fa-download"></i> ä¸‹è¼‰å±¥æ­·
                </a>
              </div>
            `).join('') : '<p class="text-muted mb-0">ç„¡å±¥æ­·è³‡æ–™</p>';
            
            // å¿—é¡˜åºè©³ç´°è³‡è¨Š
            const preferenceDetails = s.preferences && s.preferences.length > 0 ? s.preferences.map(p => `
              <div class="mb-2 p-2 border rounded">
                <strong>å¿—é¡˜ #${p.preference_order}</strong><br>
                <small>å…¬å¸: ${p.company_name || 'N/A'}</small><br>
                <small>è·ä½: ${p.job_title || p.job_title_full || 'N/A'}</small><br>
                <small>æäº¤æ™‚é–“: ${p.submitted_at || 'N/A'}</small>
              </div>
            `).join('') : '<p class="text-muted mb-0">ç„¡å¿—é¡˜åºè³‡æ–™</p>';
            
            // é¡¯ç¤ºå­¸ç”Ÿçš„å¯¦éš›ç­ç´šï¼ˆå¦‚æœæœ‰ï¼‰
            const studentClass = s.class_name ? `${s.department ? s.department.replace('ç®¡ç§‘', '') : ''}${s.class_name}` : 'æœªåˆ†ç­';
            
            return `
              <tr class="student-row" data-student-id="${s.id}">
                <td>
                  <button class="btn btn-sm btn-outline-primary toggle-details" data-index="${index}" type="button">
                    <span class="toggle-icon">â–¼</span>
                  </button>
                </td>
                <td>${s.username}</td>
                <td>${s.name}</td>
                <td>${s.email || 'N/A'}</td>
                <td>${resumeStatus}</td>
                <td>${preferenceStatus}</td>
                <td>
                  <button class="btn btn-sm btn-info view-details" data-index="${index}">æŸ¥çœ‹è©³æƒ…</button>
                  ${studentClass !== 'æœªåˆ†ç­' ? `<br><small class="text-muted">${studentClass}</small>` : ''}
                </td>
              </tr>
              <tr class="detail-row" data-index="${index}" style="display: none;">
                <td colspan="7">
                  <div class="row p-3">
                    <div class="col-md-6">
                      <h6 class="text-primary">ğŸ“„ å±¥æ­·è³‡è¨Š</h6>
                      <div class="resume-details">${resumeDetails}</div>
                    </div>
                    <div class="col-md-6">
                      <h6 class="text-primary">ğŸ¯ å¿—é¡˜åºè³‡è¨Š</h6>
                      <div class="preference-details">${preferenceDetails}</div>
                    </div>
                  </div>
                </td>
              </tr>
            `;
            }).join("");
          }
          
          // ç¶å®šå±•é–‹/æ”¶åˆäº‹ä»¶
          document.querySelectorAll('.toggle-details').forEach(btn => {
            btn.addEventListener('click', function() {
              const index = this.getAttribute('data-index');
              const detailRow = document.querySelector(`.detail-row[data-index="${index}"]`);
              const icon = this.querySelector('.toggle-icon');
              
              if (detailRow.style.display === 'none') {
                detailRow.style.display = 'table-row';
                icon.textContent = 'â–²';
              } else {
                detailRow.style.display = 'none';
                icon.textContent = 'â–¼';
              }
            });
          });
          
          // ç¶å®šæŸ¥çœ‹è©³æƒ…æŒ‰éˆ• - é–‹å•Ÿ Modal
          document.querySelectorAll('.view-details').forEach(btn => {
            btn.addEventListener('click', function() {
              const index = parseInt(this.getAttribute('data-index'));
              if (currentStudentsData && currentStudentsData[index]) {
                showStudentDetailModal(currentStudentsData[index]);
              }
            });
          });
        }

        // é¡¯ç¤ºç­ç´šçµ±è¨ˆåœ–è¡¨
        const chartContainer = document.getElementById("classChartContainer");
        if (chartContainer) chartContainer.style.display = "block";
        
        // çµ„åˆé¡¯ç¤ºåç¨±ï¼šå­¸å¹´+ç­ç´š
        const displayName = `${semesterCode}${className}`;
        
        // è¼‰å…¥ç­ç´šçµ±è¨ˆåœ–è¡¨
        loadClassStats(classId, displayName, semesterCode);
        
        // é¡¯ç¤ºä¸‰å€‹çµ±è¨ˆåœ–è¡¨å®¹å™¨
        const statsContainer = document.getElementById("statsChartsContainer");
        if (statsContainer) statsContainer.style.display = "flex";
        
        // è¼‰å…¥çµ±è¨ˆåœ–è¡¨ï¼ˆä¸‰å€‹åœ–è¡¨ï¼‰
        loadStatsCharts(classId, semesterCode);

      } catch (error) {
        console.error("è¼‰å…¥å­¸ç”Ÿè³‡æ–™å¤±æ•—:", error);
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">ä¼ºæœå™¨éŒ¯èª¤ï¼Œè¼‰å…¥å¤±æ•—ã€‚</td></tr>`;
      }
    }

    // è¼‰å…¥çµ±è¨ˆåœ–è¡¨ï¼ˆä¸‰å€‹åœ–è¡¨ï¼šå„å…¬å¸è¢«é¸å¿—é¡˜æ¬¡æ•¸ã€å±¥æ­·ç¹³äº¤ç‡ã€å¿—é¡˜åºå¡«å¯«ç‡ï¼‰
    async function loadStatsCharts(classId = "all", semesterCode = "all") {
      console.log('[DEBUG] loadStatsCharts è¢«èª¿ç”¨:', { classId, semesterCode });
      
      // æª¢æŸ¥ Chart.js æ˜¯å¦å·²è¼‰å…¥
      if (typeof Chart === 'undefined') {
        console.error("Chart.js æœªæ­£ç¢ºè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç€è¦½å™¨è¨­å®š");
        const statsContainer = document.getElementById("statsChartsContainer");
        if (statsContainer) {
          statsContainer.innerHTML = '<div class="alert alert-warning">åœ–è¡¨åº«è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢æˆ–æª¢æŸ¥ç€è¦½å™¨è¨­å®š</div>';
          statsContainer.style.display = "block";
        }
        return;
      }

      const statsContainer = document.getElementById("statsChartsContainer");
      
      // é¡¯ç¤ºçµ±è¨ˆåœ–è¡¨å®¹å™¨
      if (statsContainer) {
        statsContainer.style.display = "flex";
        console.log('[DEBUG] é¡¯ç¤ºçµ±è¨ˆåœ–è¡¨å®¹å™¨');
      } else {
        console.error('[ERROR] æ‰¾ä¸åˆ° statsChartsContainer');
        return;
      }
      
      // ç¢ºä¿åœ–è¡¨å…ƒç´ å­˜åœ¨
      const companyChartEl = document.getElementById("companyChart");
      const resumeChartEl = document.getElementById("resumeChart");
      const preferenceChartEl = document.getElementById("preferenceChart");
      
      if (!companyChartEl || !resumeChartEl || !preferenceChartEl) {
        console.error('[ERROR] æ‰¾ä¸åˆ°åœ–è¡¨å…ƒç´ :', {
          companyChart: !!companyChartEl,
          resumeChart: !!resumeChartEl,
          preferenceChart: !!preferenceChartEl
        });
        return;
      }
      
      const params = new URLSearchParams();
      if (classId && classId !== "all") params.append("class_id", classId);
      if (semesterCode && semesterCode !== "all") params.append("semester_code", semesterCode);
      const url = params.toString() ? `/ta/statistics/api/manage_companies_stats?${params.toString()}` : "/ta/statistics/api/manage_companies_stats";

      console.log('[DEBUG] è¼‰å…¥çµ±è¨ˆåœ–è¡¨ï¼ŒURL:', url);

      try {
        const res = await fetch(url);
        const data = await res.json();

        console.log('[DEBUG] çµ±è¨ˆåœ–è¡¨è³‡æ–™:', data);

        if (!data.success) {
          console.error("è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—ï¼š" + data.message);
          return;
        }

        // å„å…¬å¸è¢«é¸å¿—é¡˜æ¬¡æ•¸
        const companies = data.top_companies && data.top_companies.length > 0 
          ? data.top_companies.map(c => c.company_name) 
          : [];
        const counts = data.top_companies && data.top_companies.length > 0 
          ? data.top_companies.map(c => c.preference_count) 
          : [];
        
        console.log('[DEBUG] å…¬å¸è³‡æ–™:', { companies, counts });

        // ç¢ºä¿åœ–è¡¨å…ƒç´ å­˜åœ¨ï¼ˆå·²åœ¨å‡½æ•¸é–‹é ­æª¢æŸ¥éï¼‰
        if (companyChart) companyChart.destroy();
        
        // å¦‚æœæ²’æœ‰å…¬å¸è³‡æ–™ï¼Œé¡¯ç¤ºç©ºåœ–è¡¨
        if (companies.length === 0) {
          console.warn('[WARN] æ²’æœ‰å…¬å¸è³‡æ–™ï¼Œé¡¯ç¤ºç©ºåœ–è¡¨');
          companyChart = new Chart(companyChartEl, {
            type: "bar",
            data: {
              labels: ["ç„¡è³‡æ–™"],
              datasets: [{ label: "å¿—é¡˜æ¬¡æ•¸", data: [0], backgroundColor: "#cccccc" }]
            },
            options: { 
              responsive: true,
              maintainAspectRatio: false,
              scales: { y: { beginAtZero: true } },
              plugins: {
                legend: { display: false }
              }
            }
          });
        } else {
          console.log('[DEBUG] å‰µå»ºå…¬å¸åœ–è¡¨ï¼Œè³‡æ–™:', { companies, counts });
          companyChart = new Chart(companyChartEl, {
            type: "bar",
            data: {
              labels: companies,
              datasets: [{ label: "å¿—é¡˜æ¬¡æ•¸", data: counts, backgroundColor: "#4e79a7" }]
            },
            options: { 
              responsive: true,
              maintainAspectRatio: false,
              scales: { y: { beginAtZero: true } },
              plugins: {
                legend: { display: false }
              }
            }
          });
          console.log('[DEBUG] å…¬å¸åœ–è¡¨å·²å‰µå»º');
        }

        // å±¥æ­·ç¹³äº¤ç‡
        const resumeUploaded = data.resume_stats?.uploaded || 0;
        const resumeNotUploaded = data.resume_stats?.not_uploaded || 0;
        const resumeData = [resumeUploaded, resumeNotUploaded];
        const resumeTotal = resumeData.reduce((a, b) => a + b, 0);

        console.log('[DEBUG] å±¥æ­·è³‡æ–™:', { resumeUploaded, resumeNotUploaded, resumeTotal });

        // ç¢ºä¿åœ–è¡¨å…ƒç´ å­˜åœ¨ï¼ˆå·²åœ¨å‡½æ•¸é–‹é ­æª¢æŸ¥éï¼‰
        if (resumeChart) resumeChart.destroy();
        
        resumeChart = new Chart(resumeChartEl, {
          type: "doughnut",
          data: {
            labels: ["å·²ä¸Šå‚³", "æœªä¸Šå‚³"],
            datasets: [{ 
              data: resumeData, 
              backgroundColor: ["#59a14f", "#e15759"] 
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { 
                position: 'bottom',
                display: true
              },
              tooltip: {
                enabled: resumeTotal > 0,
                callbacks: {
                  label: function (context) {
                    const value = context.raw || 0;
                    const percent = resumeTotal > 0 ? ((value / resumeTotal) * 100).toFixed(1) + '%' : '0%';
                    return `${context.label}: ${value} (${percent})`;
                  }
                }
              }
            },
            animation: {
              animateRotate: resumeTotal > 0
            }
          },
          plugins: [{
            id: 'emptyDataPlugin',
            afterDraw: (chart) => {
              if (resumeTotal === 0) {
                const ctx = chart.ctx;
                const width = chart.width;
                const height = chart.height;
                ctx.save();
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = '14px Arial';
                ctx.fillStyle = '#666';
                ctx.fillText('ç›®å‰ç„¡è³‡æ–™', width / 2, height / 2);
                ctx.restore();
              }
            }
          }]
        });
        console.log('[DEBUG] å±¥æ­·åœ–è¡¨å·²å‰µå»º');

        // å¿—é¡˜åºå¡«å¯«ç‡
        const prefFilled = data.preference_stats?.filled || 0;
        const prefNotFilled = data.preference_stats?.not_filled || 0;
        const prefData = [prefFilled, prefNotFilled];
        const prefTotal = prefData.reduce((a, b) => a + b, 0);

        console.log('[DEBUG] å¿—é¡˜åºè³‡æ–™:', { prefFilled, prefNotFilled, prefTotal });

        // ç¢ºä¿åœ–è¡¨å…ƒç´ å­˜åœ¨ï¼ˆå·²åœ¨å‡½æ•¸é–‹é ­æª¢æŸ¥éï¼‰
        if (preferenceChart) preferenceChart.destroy();
        
        preferenceChart = new Chart(preferenceChartEl, {
          type: "doughnut",
          data: {
            labels: ["å·²å¡«å¯«", "æœªå¡«å¯«"],
            datasets: [{ 
              data: prefData, 
              backgroundColor: ["#edc948", "#bab0ab"] 
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { 
                position: 'bottom',
                display: true
              },
              tooltip: {
                enabled: prefTotal > 0,
                callbacks: {
                  label: function (context) {
                    const value = context.raw || 0;
                    const percent = prefTotal > 0 ? ((value / prefTotal) * 100).toFixed(1) + '%' : '0%';
                    return `${context.label}: ${value} (${percent})`;
                  }
                }
              }
            },
            animation: {
              animateRotate: prefTotal > 0
            }
          },
          plugins: [{
            id: 'emptyDataPlugin',
            afterDraw: (chart) => {
              if (prefTotal === 0) {
                const ctx = chart.ctx;
                const width = chart.width;
                const height = chart.height;
                ctx.save();
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = '14px Arial';
                ctx.fillStyle = '#666';
                ctx.fillText('ç›®å‰ç„¡è³‡æ–™', width / 2, height / 2);
                ctx.restore();
              }
            }
          }]
        });
        console.log('[DEBUG] å¿—é¡˜åºåœ–è¡¨å·²å‰µå»º');
        console.log('[DEBUG] æ‰€æœ‰åœ–è¡¨å·²æˆåŠŸè¼‰å…¥');
      } catch (error) {
        console.error("è¼‰å…¥çµ±è¨ˆåœ–è¡¨å¤±æ•—:", error);
        if (statsContainer) statsContainer.style.display = "none";
      }
    }

    // äº‹ä»¶ç›£è½
    document.getElementById("loadBtn").addEventListener("click", loadStudents);
    
    // ç•¶å­¸å¹´é¸æ“‡æ”¹è®Šæ™‚ï¼Œåªæ¸…ç©ºè¡¨æ ¼å’Œåœ–è¡¨ï¼Œä¸å½±éŸ¿ç­ç´šé¸å–®
    document.getElementById("semesterSelect").addEventListener("change", function() {
      // æ¸…ç©ºè¡¨æ ¼å’Œåœ–è¡¨
      document.getElementById("studentsTableBody").innerHTML = 
        '<tr><td colspan="7" class="text-center text-muted">è«‹é¸æ“‡ç­ç´š</td></tr>';
      currentStudentsData = []; // æ¸…ç©ºå­¸ç”Ÿè³‡æ–™
      const chartContainer = document.getElementById("classChartContainer");
      if (chartContainer) chartContainer.style.display = 'none';
      if (myClassChart) { 
        myClassChart.destroy(); 
        myClassChart = null; 
      }
      // æ¸…ç©ºçµ±è¨ˆåœ–è¡¨
      const statsContainer = document.getElementById("statsChartsContainer");
      if (statsContainer) statsContainer.style.display = 'none';
      if (companyChart) { companyChart.destroy(); companyChart = null; }
      if (resumeChart) { resumeChart.destroy(); resumeChart = null; }
      if (preferenceChart) { preferenceChart.destroy(); preferenceChart = null; }
    });
    
    // ç•¶ç­ç´šé¸æ“‡æ”¹è®Šæ™‚è‡ªå‹•è¼‰å…¥è³‡æ–™
    document.getElementById("classSelect").addEventListener("change", function() {
      const classId = this.value;
      // å…ˆéš±è—åœ–è¡¨å®¹å™¨ï¼Œç­‰å¾…è³‡æ–™è¼‰å…¥å¾Œå†æ±ºå®šæ˜¯å¦é¡¯ç¤º
      const statsContainer = document.getElementById("statsChartsContainer");
      const chartContainer = document.getElementById("classChartContainer");
      if (statsContainer) statsContainer.style.display = 'none';
      if (chartContainer) chartContainer.style.display = 'none';
      
      if (classId !== "all") {
        loadStudents();
      } else {
        // å¦‚æœé¸æ“‡ã€Œæ‰€æœ‰ç­ç´šã€ï¼Œæ¸…ç©ºè¡¨æ ¼å’Œåœ–è¡¨
        document.getElementById("studentsTableBody").innerHTML = 
          '<tr><td colspan="7" class="text-center text-muted">è«‹é¸æ“‡ç­ç´š</td></tr>';
        currentStudentsData = []; // æ¸…ç©ºå­¸ç”Ÿè³‡æ–™
        const chartContainer = document.getElementById("classChartContainer");
        chartContainer.style.display = 'none';
        if (myClassChart) { 
          myClassChart.destroy(); 
          myClassChart = null; 
        }
        // æ¸…ç©ºçµ±è¨ˆåœ–è¡¨
        const statsContainer = document.getElementById("statsChartsContainer");
        statsContainer.style.display = 'none';
        if (companyChart) { companyChart.destroy(); companyChart = null; }
        if (resumeChart) { resumeChart.destroy(); resumeChart = null; }
        if (preferenceChart) { preferenceChart.destroy(); preferenceChart = null; }
      }
    });

    // åŒ¯å‡º Excel (æ‰€æœ‰ç­ç´š)
    document.getElementById("exportBtn").addEventListener("click", () => {
      window.location.href = `/ta/statistics/api/export_companies_stats`; // åŒ¯å‡ºæ‰€æœ‰ç­ç´šçš„çµ±è¨ˆ
    });

    // é¡¯ç¤ºå­¸ç”Ÿè©³æƒ… Modal
    function showStudentDetailModal(student) {
      // åˆå§‹åŒ– Modalï¼ˆå¦‚æœå°šæœªåˆå§‹åŒ–ï¼‰
      if (!studentDetailModal) {
        const modalElement = document.getElementById('studentDetailModal');
        studentDetailModal = new bootstrap.Modal(modalElement);
      }
      
      // è¨­å®šå­¸ç”ŸåŸºæœ¬è³‡è¨Š
      document.getElementById('modalStudentNumber').textContent = student.username || 'N/A';
      document.getElementById('modalStudentName').textContent = student.name || 'N/A';
      document.getElementById('modalStudentEmail').textContent = student.email || 'N/A';
      
      // é¡¯ç¤ºå­¸ç”Ÿçš„å¯¦éš›ç­ç´š
      const studentClass = student.class_name ? 
        `${student.department ? student.department.replace('ç®¡ç§‘', '') : ''}${student.class_name}` : 
        'æœªåˆ†ç­';
      document.getElementById('modalStudentClass').textContent = studentClass;
      
      // å±¥æ­·è©³ç´°è³‡è¨Š
      const resumeDetails = student.resumes && student.resumes.length > 0 ? 
        student.resumes.map(r => `
          <div class="mb-3 p-4 border rounded bg-light" style="font-size: 1.05rem;">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <strong class="text-primary" style="font-size: 1.2rem;">å±¥æ­·</strong>
              <span class="badge ${r.status === 'approved' ? 'bg-success' : r.status === 'rejected' ? 'bg-danger' : 'bg-warning'}" style="font-size: 1rem; padding: 0.5rem 0.75rem;">
                ${r.status === 'approved' ? 'å·²å¯©æ ¸' : r.status === 'rejected' ? 'å·²é€€ä»¶' : 'å¾…å¯©æ ¸'}
              </span>
            </div>
            <div style="font-size: 1.05rem;">
              <div class="mb-2">â° <strong>ä¸Šå‚³æ™‚é–“:</strong> ${r.created_at || 'N/A'}</div>
              ${r.reviewed_at ? `<div class="mb-2">âœ… <strong>å¯©æ ¸æ™‚é–“:</strong> ${r.reviewed_at}</div>` : ''}
              ${r.reject_reason ? `<div class="mb-2 text-danger">âš ï¸ <strong>é€€ä»¶åŸå› :</strong> ${r.reject_reason}</div>` : ''}
            </div>
            <div class="mt-3">
              <a href="/api/download_resume/${r.id}" class="btn btn-primary btn-sm" download>
                <i class="fas fa-download"></i> ä¸‹è¼‰å±¥æ­·
              </a>
            </div>
          </div>
        `).join('') : 
        '<div class="text-center p-5"><p class="text-muted mb-0" style="font-size: 1.1rem;">ç„¡å±¥æ­·è³‡æ–™</p></div>';
      document.getElementById('modalResumeDetails').innerHTML = resumeDetails;
      
      // å¿—é¡˜åºè©³ç´°è³‡è¨Šï¼ˆæŒ‰å¿—é¡˜é †åºæ’åºï¼‰
      const sortedPreferences = student.preferences && student.preferences.length > 0 ? 
        [...student.preferences].sort((a, b) => (a.preference_order || 0) - (b.preference_order || 0)) : [];
      const preferenceDetails = sortedPreferences.length > 0 ? 
        sortedPreferences.map(p => `
          <div class="mb-3 p-4 border rounded bg-light" style="font-size: 1.05rem;">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <strong class="text-primary" style="font-size: 1.2rem;">å¿—é¡˜ #${p.preference_order}</strong>
            </div>
            <div style="font-size: 1.05rem;">
              <div class="mb-2"><strong>å…¬å¸:</strong> ${p.company_name || 'N/A'}</div>
              <div class="mb-2"><strong>è·ä½:</strong> ${p.job_title || p.job_title_full || 'N/A'}</div>
              <div class="mb-2 text-muted">â° <strong>æäº¤æ™‚é–“:</strong> ${p.submitted_at || 'N/A'}</div>
            </div>
          </div>
        `).join('') : 
        '<div class="text-center p-5"><p class="text-muted mb-0" style="font-size: 1.1rem;">ç„¡å¿—é¡˜åºè³‡æ–™</p></div>';
      document.getElementById('modalPreferenceDetails').innerHTML = preferenceDetails;
      
      // é¡¯ç¤º Modal
      studentDetailModal.show();
    }

    // åˆå§‹è¼‰å…¥ï¼šå…ˆè¼‰å…¥å­¸å¹´åˆ—è¡¨å’Œæ‰€æœ‰ç­ç´šè³‡æ–™
    async function initialize() {
      await loadAllClasses();
      loadSemesters();
      // è¼‰å…¥æ‰€æœ‰ç­ç´šé¸é …ï¼ˆä¸é™å­¸å¹´ï¼‰
      loadAllClassesOptions();
      // ä¸é è¨­è¼‰å…¥çµ±è¨ˆåœ–è¡¨ï¼Œç­‰å¾…ç”¨æˆ¶é¸æ“‡å¾Œå†è¼‰å…¥
    }
    
    initialize();
  </script>
</body>

</html>

