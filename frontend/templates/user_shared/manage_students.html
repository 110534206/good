<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <title>æ™ºæ…§å¯¦ç¿’å¹³å° | å­¸ç”Ÿç®¡ç†</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" crossorigin="anonymous"></script>
  <style>
    header {
      background: #0066cc;
      color: white;
      padding: 1rem 2rem;
      text-align: center;
      font-size: 1.5rem;
    }

    body {
      font-family: "Noto Sans TC", sans-serif;
      background: #f7f9fc;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1200px;
      margin: auto;
      padding: 2rem;
    }

    /* è¡¨æ ¼ */
    table thead th,
    table td {
      text-align: center;
      vertical-align: middle;
      font-size: 0.95rem;
    }

    .custom-header-blue {
      background-color: #0066cc;
      color: white;
      border-color: #0066cc;
    }

    .filter-section {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .table-container {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 1.5rem;
    }

    .chart-container {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 1.5rem;
    }

    .chart-container h2 {
      font-size: 1.25rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 1rem;
    }

    .chart-container canvas {
      max-height: 300px;
    }

    /* çµ±è¨ˆåœ–è¡¨å®¹å™¨æ¨£å¼ - èˆ‡å…¬å¸ç®¡ç†é é¢ä¸€è‡´ */
    #statsChartsContainer {
      display: flex !important;
      flex-wrap: nowrap;
    }
    
    .stats-chart-container {
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 24px;
      flex: 1;
      min-width: 0;
    }
    
    .stats-chart-container h5 {
      font-size: 1rem;
      margin-bottom: 12px;
    }
    
    .stats-chart-container canvas {
      max-height: 250px;
    }
    
    @media (max-width: 768px) {
      #statsChartsContainer {
        flex-wrap: wrap;
      }
      .stats-chart-container {
        flex: 0 0 100%;
      }
    }

    /* è©³ç´°è³‡è¨Šæ¨£å¼ */
    .detail-row {
      background-color: #f8f9fa;
    }
    
    .detail-row td {
      padding: 0 !important;
    }
    
    .resume-details, .preference-details {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .resume-details .border, .preference-details .border {
      background-color: white;
    }
    
    .toggle-details {
      border: none;
      background: transparent;
      padding: 0.25rem 0.5rem;
    }
    
    .toggle-details:hover {
      background-color: #e9ecef;
      border-radius: 4px;
    }
    
    .toggle-icon {
      font-size: 0.75rem;
      transition: transform 0.2s;
    }
  </style>
</head>

<body>
  <header>å­¸ç”Ÿå±¥æ­·ç®¡ç†</header>
  <div class="container">
    <div class="filter-section">
      <div class="row align-items-end">
        <div class="col-md-2">
          <label for="semesterSelect" class="form-label">é¸æ“‡å­¸å¹´</label>
          <select id="semesterSelect" class="form-select">
            <option value="all">æ‰€æœ‰å­¸å¹´</option>
          </select>
        </div>
        <div class="col-md-2">
          <label for="classSelect" class="form-label">é¸æ“‡ç­ç´š</label>
          <select id="classSelect" class="form-select" disabled>
            <option value="all">è«‹å…ˆé¸æ“‡å­¸å¹´</option>
          </select>
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100" id="loadBtn">å­¸ç”Ÿè³‡æ–™</button>
        </div>
        <div class="col-md-2">
          <button class="btn btn-success w-100" id="exportBtn">åŒ¯å‡º Excel</button>
        </div>
        <div class="col-md-2">
          <a href="/ta/statistics/manage_companies" class="btn btn-outline-secondary w-100">è¿”å›çµ±è¨ˆé é¢</a>
        </div>
      </div>
    </div>

    <!-- çµ±è¨ˆåœ–è¡¨å€åŸŸ -->
    <div class="row g-4 mb-4" id="statsChartsContainer" style="display: none;">
      <div class="col-md-4 col-sm-12">
        <div class="stats-chart-container">
          <h5 class="text-center">ğŸ¢ å„å…¬å¸è¢«é¸å¿—é¡˜æ¬¡æ•¸</h5>
          <canvas id="companyChart"></canvas>
        </div>
      </div>
      <div class="col-md-4 col-sm-12">
        <div class="stats-chart-container">
          <h5 class="text-center">ğŸ“„ å±¥æ­·ç¹³äº¤ç‡</h5>
          <canvas id="resumeChart"></canvas>
        </div>
      </div>
      <div class="col-md-4 col-sm-12">
        <div class="stats-chart-container">
          <h5 class="text-center">ğŸ¯ å¿—é¡˜åºå¡«å¯«ç‡</h5>
          <canvas id="preferenceChart"></canvas>
        </div>
      </div>
    </div>

    <div id="classChartContainer" class="chart-container" style="display: none;">
      <h2>ç­ç´šå¯¦ç¿’é€²åº¦åˆ†æ</h2>
      <p>è«‹é¸æ“‡ä¸€å€‹ç­ç´šä»¥æŸ¥çœ‹è©³ç´°å¯¦ç¿’çµ±è¨ˆåœ–è¡¨ã€‚</p>
    </div>

    <div class="table-container">
      <table class="table table-bordered table-striped table-hover align-middle">
        <thead class="custom-header-blue">
          <tr>
            <th style="width: 50px;"></th>
            <th>å­¸è™Ÿ</th>
            <th>å§“å</th>
            <th>Email</th>
            <th>å±¥æ­·ä¸Šå‚³</th>
            <th>å¿—é¡˜å¡«å¯«</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="studentsTableBody">
          <tr>
            <td colspan="7" class="text-center text-muted">è«‹é¸æ“‡ç­ç´šä¸¦é»æ“Šã€Œå­¸ç”Ÿè³‡æ–™ã€</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let myClassChart = null; // ç”¨æ–¼å„²å­˜å–®ä¸€ç­ç´š Chart å¯¦ä¾‹
    let companyChart, resumeChart, preferenceChart; // ç”¨æ–¼å„²å­˜çµ±è¨ˆåœ–è¡¨å¯¦ä¾‹
    let allClassesData = []; // å„²å­˜æ‰€æœ‰ç­ç´šè³‡æ–™

    // å›ºå®šè¼‰å…¥ 1132ã€1142 å…©å€‹å­¸å¹´
    function loadSemesters() {
      const semesterSelect = document.getElementById("semesterSelect");
      const semesters = ['1132', '1142'];

      semesterSelect.innerHTML = "";
      semesters.forEach(code => {
        const option = document.createElement("option");
        option.value = code;
        option.textContent = code;
        semesterSelect.appendChild(option);
      });
      semesterSelect.disabled = false;
      semesterSelect.value = semesters[0];
      loadClassesBySemester(semesters[0]);
    }

    // å¾ç­ç´šåç¨±ä¸­æå–ã€Œå¿ ã€ã€ã€Œå­ã€ç­‰å­—
    function extractClassShortName(className) {
      const classNames = ['å¿ ', 'å­', 'ä»', 'æ„›', 'ä¿¡', 'ç¾©', 'å’Œ', 'å¹³', 'ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'];
      for (const name of classNames) {
        if (className.includes(name)) {
          return name;
        }
      }
      // å¦‚æœæ²’æ‰¾åˆ°ï¼Œå˜—è©¦ç§»é™¤æ•¸å­—å’Œå¸¸è¦‹å‰ç¶´
      let shortName = className.replace(/^[^å¿ å­ä»æ„›ä¿¡ç¾©å’Œå¹³ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸]+/, '');
      if (!shortName) {
        shortName = className.slice(-1);
      }
      return shortName;
    }

    // è¼‰å…¥æ‰€æœ‰ç­ç´šè³‡æ–™
    async function loadAllClasses() {
      try {
        const res = await fetch("/ta/statistics/api/get_classes");
        const data = await res.json();
        
        if (data.success) {
          const rawClasses = data.classes || [];
          // è¦æ’é™¤çš„ç­ç´šåç¨±ï¼ˆæ’é™¤ä¸€ã€äºŒã€ä¸‰å¹´ç´šï¼Œä¿ç•™å››å¹´ç´šï¼‰
          const excludedClasses = ['è³‡ä¸€å­', 'è³‡äºŒå­', 'è³‡ä¸‰å­', 'è³‡ä¸€å¿ ', 'è³‡äºŒå¿ ', 'è³‡ä¸‰å¿ '];
          const allowedSemesterCodes = ['1132', '1142'];
          
          console.log('[DEBUG] è¼‰å…¥ç­ç´šåˆ—è¡¨ï¼Œæ’é™¤:', excludedClasses);

          const normalizeClasses = classes => classes.map(c => {
            let semesterCode = '';
            if (c.semester_code) {
              semesterCode = String(c.semester_code);
            } else if (c.admission_year) {
              const yearStr = String(c.admission_year);
              semesterCode = yearStr.length >= 4 ? yearStr : `${yearStr}2`;
            }
            return {
              ...c,
              semester_code: semesterCode
            };
          });

          let normalized = normalizeClasses(rawClasses).filter(c => {
            const fullClassName = `${(c.department || '').replace('ç®¡ç§‘', '')}${c.name || ''}`;
            if (excludedClasses.some(excluded => fullClassName.includes(excluded))) {
              return false;
            }
            const semesterCode = c.semester_code || '';
            return semesterCode && allowedSemesterCodes.includes(semesterCode);
          });

          // è‹¥ä¾æŒ‡å®šå­¸å¹´éæ¿¾å¾Œæ²’æœ‰è³‡æ–™ï¼Œé€€å›ä½¿ç”¨å…¨éƒ¨ç­ç´šï¼ˆä»æ’é™¤æŒ‡å®šç­ç´šï¼‰
          if (normalized.length === 0) {
            normalized = normalizeClasses(
              rawClasses.filter(c => {
                const fullClassName = `${(c.department || '').replace('ç®¡ç§‘', '')}${c.name || ''}`;
                return !excludedClasses.some(excluded => fullClassName.includes(excluded));
              })
            );
          }

          allClassesData = normalized;
        }
      } catch (error) {
        console.error("è¼‰å…¥ç­ç´šåˆ—è¡¨å¤±æ•—:", error);
      }
    }

    // æ ¹æ“šé¸æ“‡çš„å­¸å¹´è¼‰å…¥å°æ‡‰çš„ç­ç´šï¼ˆåªé¡¯ç¤ºå¿ ã€å­å…©ç­ï¼‰
    function loadClassesBySemester(semesterCode) {
      const classSelect = document.getElementById("classSelect");
      classSelect.innerHTML = '<option value="all" disabled selected>è«‹é¸æ“‡ç­ç´š</option>';
      
      if (semesterCode === 'all') {
        classSelect.disabled = true;
        return;
      }
      
      classSelect.disabled = false;
      
      // éæ¿¾å‡ºè©²å­¸å¹´çš„ç­ç´š
      let filteredClasses = allClassesData.filter(c => (c.semester_code || '') === String(semesterCode));
      // è‹¥è©²å­¸å¹´æ²’æœ‰è³‡æ–™ï¼Œé€€å›ä½¿ç”¨æ‰€æœ‰ç­ç´šä¸­ç¬¦åˆæ¢ä»¶çš„ç­ç´š
      if (filteredClasses.length === 0) {
        filteredClasses = [...allClassesData];
      }
      
      // åªé¡¯ç¤ºã€Œå¿ ã€ã€ã€Œå­ã€å…©ç­
      const allowedClasses = ['å¿ ', 'å­'];
      
      // æå–ç­ç´šåç¨±ï¼ˆå¿ ã€å­ç­‰ï¼‰
      const classMap = new Map(); // ç”¨ä¾†å»é‡ï¼ˆåŒä¸€å€‹ç­ç´šåç¨±å¯èƒ½æœ‰å¤šå€‹ç­ç´šIDï¼‰
      
      filteredClasses.forEach(c => {
        const fullName = `${(c.department || '').replace('ç®¡ç§‘', '')}${c.name || ''}`;
        console.log(`[DEBUG] æª¢æŸ¥ç­ç´š: fullName=${fullName}, id=${c.id}, department=${c.department}, name=${c.name}`);
        let classShortName = null;
        if (fullName.includes('å¿ ')) {
          classShortName = 'å¿ ';
        } else if (fullName.includes('å­')) {
          classShortName = 'å­';
        } else {
          // é€€è€Œæ±‚å…¶æ¬¡ä½¿ç”¨åŸé‚è¼¯è¾¨è­˜
          const extracted = extractClassShortName(fullName);
          if (allowedClasses.includes(extracted)) {
            classShortName = extracted;
          }
        }

        if (classShortName && allowedClasses.includes(classShortName)) {
          if (!classMap.has(classShortName)) {
            classMap.set(classShortName, []);
          }
          classMap.get(classShortName).push(c);
          console.log(`[DEBUG] åŠ å…¥ç­ç´šåˆ°åˆ—è¡¨: ${fullName} -> ${classShortName}`);
        }
      });
      
      // ä¾ allowedClasses é †åºï¼ˆå¿ ã€å­ï¼‰åŠ å…¥
      allowedClasses.forEach(className => {
        const classes = classMap.get(className);
        if (classes && classes.length > 0) {
          // å¦‚æœæœ‰å¤šå€‹ç­ç´šï¼Œé¸æ“‡ç¬¬ä¸€å€‹ï¼ˆé€šå¸¸æ˜¯å››å¹´ç´šçš„ï¼‰
          const classData = classes[0];
          const fullName = `${(classData.department || '').replace('ç®¡ç§‘', '')}${classData.name || ''}`;
          console.log(`[DEBUG] åŠ å…¥ä¸‹æ‹‰é¸å–®: ${fullName} (ID: ${classData.id}) -> ${className}`);
          const option = document.createElement("option");
          option.value = classData.id;
          option.textContent = className;
          classSelect.appendChild(option);
        } else {
          console.log(`[DEBUG] æ²’æœ‰æ‰¾åˆ° ${className} ç­ç´š`);
        }
      });

      // è‹¥æ²’æœ‰ä»»ä½•ç­ç´šå¯é¸ï¼Œç¹¼çºŒåœç”¨
      if (classSelect.options.length === 1) {
        classSelect.disabled = true;
        document.getElementById("studentsTableBody").innerHTML = 
          '<tr><td colspan="7" class="text-center text-muted">è©²å­¸å¹´ç›®å‰ç„¡å¯ç”¨ç­ç´š</td></tr>';
        return;
      }

      // é è¨­é¸æ“‡ç¬¬ä¸€å€‹ç­ç´šä¸¦è¼‰å…¥è³‡æ–™
      classSelect.selectedIndex = 1;
      loadStudents();
    }

    // è¼‰å…¥å–®ä¸€ç­ç´šçš„çµ±è¨ˆåœ–è¡¨
    async function loadClassStats(classId, className, semesterCode = "all") {
      // æª¢æŸ¥ Chart.js æ˜¯å¦å·²è¼‰å…¥
      if (typeof Chart === 'undefined') {
        console.error("Chart.js æœªæ­£ç¢ºè¼‰å…¥");
        return;
      }

      const chartContainer = document.getElementById("classChartContainer");

      // è™•ç†ã€Œæ‰€æœ‰ç­ç´šã€çš„ç‰¹æ®Šæƒ…æ³
      if (classId === 'all') {
        chartContainer.style.display = 'none';
        if (myClassChart) { 
          myClassChart.destroy(); 
          myClassChart = null; 
        }
        return;
      }

      // é¡¯ç¤ºåœ–è¡¨å®¹å™¨
      chartContainer.style.display = 'block';

      // æ¸…ç©ºä¸¦æº–å‚™æ–°çš„ Chart å…ƒç´ 
      chartContainer.innerHTML = '<h2>' + className + ' å¯¦ç¿’çµ±è¨ˆåˆ†æ</h2><canvas id="classStatsChart"></canvas>';

      try {
        // å‘¼å«æ–°çš„ API è·¯ç”±
        const res = await fetch(`/ta/statistics/api/get_class_stats/${classId}?semester_code=${semesterCode}`);
        const data = await res.json();

        if (!data.success) {
          if (myClassChart) { myClassChart.destroy(); myClassChart = null; }
          chartContainer.innerHTML = `<div class="text-danger">è¼‰å…¥çµ±è¨ˆåœ–è¡¨å¤±æ•—ï¼š${data.message}</div>`;
          return;
        }

        const stats = data.stats;
        console.log('[DEBUG] ç­ç´šçµ±è¨ˆè³‡æ–™:', stats);
        
        // ç¢ºä¿è³‡æ–™æ˜¯æ•¸å­—
        const totalStudents = parseInt(stats.total_students) || 0;
        const studentsWithResume = parseInt(stats.students_with_resume) || 0;
        const studentsWithPreference = parseInt(stats.students_with_preference) || 0;
        
        console.log('[DEBUG] åœ–è¡¨è³‡æ–™:', {
          totalStudents,
          studentsWithResume,
          studentsWithPreference
        });
        
        const ctx = document.getElementById('classStatsChart').getContext('2d');

        // éŠ·æ¯€èˆŠçš„ Chart å¯¦ä¾‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (myClassChart) {
          myClassChart.destroy();
        }

        // ä½¿ç”¨ Chart.js ç¹ªè£½é•·æ¢åœ–
        myClassChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['ç¸½å­¸ç”Ÿæ•¸', 'å·²ä¸Šå‚³å±¥æ­·', 'å·²å¡«å¯«å¿—é¡˜'],
            datasets: [{
              label: 'äººæ•¸',
              data: [
                totalStudents,
                studentsWithResume,
                studentsWithPreference
              ],
              backgroundColor: [
                'rgba(54, 162, 235, 0.7)', // è—è‰²: ç¸½å­¸ç”Ÿæ•¸
                'rgba(75, 192, 192, 0.7)', // ç¶ è‰²: å·²ä¸Šå‚³å±¥æ­·
                'rgba(153, 102, 255, 0.7)' // ç´«è‰²: å·²å¡«å¯«å¿—é¡˜
              ],
              borderColor: [
                'rgba(54, 162, 235, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                // è¨­å®š Y è»¸çš„æœ€å¤§å€¼ç•¥å¤§æ–¼ç¸½å­¸ç”Ÿæ•¸ï¼Œä¸”è‡³å°‘ç‚º 5
                max: totalStudents > 0 ? Math.ceil(totalStudents * 1.2) : 5,
                ticks: {
                  precision: 0, // ç¢ºä¿ Y è»¸åˆ»åº¦æ˜¯æ•´æ•¸
                  stepSize: 1
                }
              },
              x: {
                grid: {
                  display: false
                }
              }
            },
            plugins: {
              legend: {
                display: false
              },
              title: {
                display: true,
                text: stats.class_name + ' å¯¦ç¿’é€²åº¦çµ±è¨ˆ'
              }
            }
          }
        });

      } catch (error) {
        console.error("Fetch error:", error);
        if (myClassChart) { myClassChart.destroy(); myClassChart = null; }
        chartContainer.innerHTML = `<div class="text-danger">ç¶²è·¯é€£ç·šæˆ–è³‡æ–™è™•ç†éŒ¯èª¤</div>`;
      }
    }

    // è¼‰å…¥å­¸ç”Ÿè³‡æ–™
    async function loadStudents() {
      const semesterCode = document.getElementById("semesterSelect").value;
      const classId = document.getElementById("classSelect").value;
      const className = document.getElementById("classSelect").options[document.getElementById("classSelect").selectedIndex].text;
      const tbody = document.getElementById("studentsTableBody");
      tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">è¼‰å…¥ä¸­...</td></tr>`;

      // æª¢æŸ¥æ˜¯å¦å·²é¸æ“‡å­¸å¹´å’Œç­ç´š
      if (semesterCode === 'all') {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">è«‹å…ˆé¸æ“‡å­¸å¹´</td></tr>`;
        return;
      }

      if (classId === 'all') {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">è«‹é¸æ“‡ç­ç´š</td></tr>`;
        return;
      }

      try {
        console.log(`[DEBUG] è¼‰å…¥å­¸ç”Ÿè³‡æ–™: class_id=${classId}, semester_code=${semesterCode}`);
        const url = `/ta/statistics/api/get_students_by_class?class_id=${classId}&semester_code=${semesterCode}`;
        console.log(`[DEBUG] API URL: ${url}`);
        
        const res = await fetch(url);
        console.log(`[DEBUG] API å›æ‡‰ç‹€æ…‹: ${res.status} ${res.statusText}`);
        
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const data = await res.json();
        
        console.log('[DEBUG] API è¿”å›è³‡æ–™:', JSON.stringify(data, null, 2));
        console.log('[DEBUG] å­¸ç”Ÿæ•¸é‡:', data.students ? data.students.length : 0);
        
        if (data.students && data.students.length > 0) {
          console.log('[DEBUG] ç¬¬ä¸€ä½å­¸ç”Ÿå®Œæ•´è³‡æ–™:', JSON.stringify(data.students[0], null, 2));
        }

        if (!data.success) {
          let errorMsg = data.message || 'è¼‰å…¥å¤±æ•—';
          if (errorMsg === 'æœªæˆæ¬Š' || res.status === 403) {
            errorMsg = 'æ¬Šé™ä¸è¶³ï¼šæ­¤åŠŸèƒ½åƒ…é™ç§‘åŠ©å’Œç®¡ç†å“¡ä½¿ç”¨ã€‚è«‹ç¢ºèªæ‚¨å·²ä»¥æ­£ç¢ºè§’è‰²ç™»å…¥ã€‚';
          }
          console.error('[ERROR] API è¿”å›éŒ¯èª¤:', errorMsg);
          tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">${errorMsg}</td></tr>`;
          return;
        }

        if (!data.students || data.students.length === 0) {
          console.warn('[WARN] æ²’æœ‰å­¸ç”Ÿè³‡æ–™');
          tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">è©²ç­ç´šæ²’æœ‰å­¸ç”Ÿè³‡æ–™</td></tr>`;
        } else {
          console.log('[DEBUG] é–‹å§‹æ¸²æŸ“å­¸ç”Ÿåˆ—è¡¨ï¼Œå…±', data.students.length, 'ä½å­¸ç”Ÿ');
          tbody.innerHTML = data.students.map((s, index) => {
            // èª¿è©¦è¼¸å‡º
            if (index === 0) {
              console.log('[DEBUG] ç¬¬ä¸€ä½å­¸ç”Ÿè³‡æ–™ç¯„ä¾‹:', {
                id: s.id,
                username: s.username,
                name: s.name,
                resume_count: s.resume_count,
                preference_count: s.preference_count,
                resumes: s.resumes ? s.resumes.length : 0,
                preferences: s.preferences ? s.preferences.length : 0
              });
            }
            
            const resumeStatus = (s.resume_count && s.resume_count > 0) ? 
              `<span class="badge bg-success">å·²ä¸Šå‚³ (${s.resume_count})</span>` : 
              '<span class="badge bg-danger">æœªä¸Šå‚³</span>';
            const preferenceStatus = (s.preference_count && s.preference_count > 0) ? 
              `<span class="badge bg-success">å·²å¡«å¯« (${s.preference_count})</span>` : 
              '<span class="badge bg-danger">æœªå¡«å¯«</span>';
            
            // å±¥æ­·è©³ç´°è³‡è¨Š
            const resumeDetails = s.resumes && s.resumes.length > 0 ? s.resumes.map(r => `
              <div class="mb-2 p-2 border rounded">
                <strong>å±¥æ­· #${r.id}</strong><br>
                <small>ç‹€æ…‹: <span class="badge ${r.status === 'approved' ? 'bg-success' : r.status === 'rejected' ? 'bg-danger' : 'bg-warning'}">${r.status === 'approved' ? 'å·²å¯©æ ¸' : r.status === 'rejected' ? 'å·²é€€ä»¶' : 'å¾…å¯©æ ¸'}</span></small><br>
                <small>ä¸Šå‚³æ™‚é–“: ${r.created_at || 'N/A'}</small><br>
                ${r.reviewed_at ? `<small>å¯©æ ¸æ™‚é–“: ${r.reviewed_at}</small><br>` : ''}
                ${r.reject_reason ? `<small class="text-danger">é€€ä»¶åŸå› : ${r.reject_reason}</small>` : ''}
              </div>
            `).join('') : '<p class="text-muted mb-0">ç„¡å±¥æ­·è³‡æ–™</p>';
            
            // å¿—é¡˜åºè©³ç´°è³‡è¨Š
            const preferenceDetails = s.preferences && s.preferences.length > 0 ? s.preferences.map(p => `
              <div class="mb-2 p-2 border rounded">
                <strong>å¿—é¡˜ #${p.preference_order}</strong><br>
                <small>å…¬å¸: ${p.company_name || 'N/A'}</small><br>
                <small>è·ä½: ${p.job_title || p.job_title_full || 'N/A'}</small><br>
                <small>ç‹€æ…‹: <span class="badge ${p.status === 'approved' ? 'bg-success' : p.status === 'rejected' ? 'bg-danger' : 'bg-warning'}">${p.status === 'approved' ? 'å·²é€šé' : p.status === 'rejected' ? 'å·²é€€ä»¶' : 'å¾…å¯©æ ¸'}</span></small><br>
                <small>æäº¤æ™‚é–“: ${p.submitted_at || 'N/A'}</small>
              </div>
            `).join('') : '<p class="text-muted mb-0">ç„¡å¿—é¡˜åºè³‡æ–™</p>';
            
            // é¡¯ç¤ºå­¸ç”Ÿçš„å¯¦éš›ç­ç´šï¼ˆå¦‚æœæœ‰ï¼‰
            const studentClass = s.class_name ? `${s.department ? s.department.replace('ç®¡ç§‘', '') : ''}${s.class_name}` : 'æœªåˆ†ç­';
            
            return `
              <tr class="student-row" data-student-id="${s.id}">
                <td>
                  <button class="btn btn-sm btn-outline-primary toggle-details" data-index="${index}" type="button">
                    <span class="toggle-icon">â–¼</span>
                  </button>
                </td>
                <td>${s.username}</td>
                <td>${s.name}</td>
                <td>${s.email || 'N/A'}</td>
                <td>${resumeStatus}</td>
                <td>${preferenceStatus}</td>
                <td>
                  <button class="btn btn-sm btn-info view-details" data-index="${index}">æŸ¥çœ‹è©³æƒ…</button>
                  ${studentClass !== 'æœªåˆ†ç­' ? `<br><small class="text-muted">${studentClass}</small>` : ''}
                </td>
              </tr>
              <tr class="detail-row" data-index="${index}" style="display: none;">
                <td colspan="7">
                  <div class="row p-3">
                    <div class="col-md-6">
                      <h6 class="text-primary">ğŸ“„ å±¥æ­·è³‡è¨Š</h6>
                      <div class="resume-details">${resumeDetails}</div>
                    </div>
                    <div class="col-md-6">
                      <h6 class="text-primary">ğŸ¯ å¿—é¡˜åºè³‡è¨Š</h6>
                      <div class="preference-details">${preferenceDetails}</div>
                    </div>
                  </div>
                </td>
              </tr>
            `;
          }).join("");
          
          // ç¶å®šå±•é–‹/æ”¶åˆäº‹ä»¶
          document.querySelectorAll('.toggle-details').forEach(btn => {
            btn.addEventListener('click', function() {
              const index = this.getAttribute('data-index');
              const detailRow = document.querySelector(`.detail-row[data-index="${index}"]`);
              const icon = this.querySelector('.toggle-icon');
              
              if (detailRow.style.display === 'none') {
                detailRow.style.display = 'table-row';
                icon.textContent = 'â–²';
              } else {
                detailRow.style.display = 'none';
                icon.textContent = 'â–¼';
              }
            });
          });
          
          // ç¶å®šæŸ¥çœ‹è©³æƒ…æŒ‰éˆ•
          document.querySelectorAll('.view-details').forEach(btn => {
            btn.addEventListener('click', function() {
              const index = this.getAttribute('data-index');
              const detailRow = document.querySelector(`.detail-row[data-index="${index}"]`);
              const toggleBtn = document.querySelector(`.toggle-details[data-index="${index}"]`);
              
              if (detailRow.style.display === 'none') {
                detailRow.style.display = 'table-row';
                toggleBtn.querySelector('.toggle-icon').textContent = 'â–²';
              }
            });
          });
        }

        // çµ„åˆé¡¯ç¤ºåç¨±ï¼šå­¸å¹´+ç­ç´š
        const displayName = `${semesterCode}${className}`;
        
        // è¼‰å…¥ç­ç´šçµ±è¨ˆåœ–è¡¨
        loadClassStats(classId, displayName, semesterCode);
        
        // è¼‰å…¥çµ±è¨ˆåœ–è¡¨ï¼ˆä¸‰å€‹åœ–è¡¨ï¼‰
        loadStatsCharts(classId, semesterCode);

      } catch (error) {
        console.error("è¼‰å…¥å­¸ç”Ÿè³‡æ–™å¤±æ•—:", error);
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">ä¼ºæœå™¨éŒ¯èª¤ï¼Œè¼‰å…¥å¤±æ•—ã€‚</td></tr>`;
      }
    }

    // è¼‰å…¥çµ±è¨ˆåœ–è¡¨ï¼ˆä¸‰å€‹åœ–è¡¨ï¼šå„å…¬å¸è¢«é¸å¿—é¡˜æ¬¡æ•¸ã€å±¥æ­·ç¹³äº¤ç‡ã€å¿—é¡˜åºå¡«å¯«ç‡ï¼‰
    async function loadStatsCharts(classId = "all", semesterCode = "all") {
      // æª¢æŸ¥ Chart.js æ˜¯å¦å·²è¼‰å…¥
      if (typeof Chart === 'undefined') {
        console.error("Chart.js æœªæ­£ç¢ºè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç€è¦½å™¨è¨­å®š");
        const statsContainer = document.getElementById("statsChartsContainer");
        statsContainer.innerHTML = '<div class="alert alert-warning">åœ–è¡¨åº«è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢æˆ–æª¢æŸ¥ç€è¦½å™¨è¨­å®š</div>';
        return;
      }

      const statsContainer = document.getElementById("statsChartsContainer");
      
      // é¡¯ç¤ºçµ±è¨ˆåœ–è¡¨å®¹å™¨ï¼ˆCSS å·²è¨­ç½®ç‚º flexï¼‰
      statsContainer.style.display = "flex";
      
      const params = new URLSearchParams();
      if (classId && classId !== "all") params.append("class_id", classId);
      if (semesterCode && semesterCode !== "all") params.append("semester_code", semesterCode);
      const url = params.toString() ? `/ta/statistics/api/manage_companies_stats?${params.toString()}` : "/ta/statistics/api/manage_companies_stats";

      try {
        const res = await fetch(url);
        const data = await res.json();

        if (!data.success) {
          console.error("è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—ï¼š" + data.message);
          return;
        }

        // å„å…¬å¸è¢«é¸å¿—é¡˜æ¬¡æ•¸
        const companies = data.top_companies.map(c => c.company_name);
        const counts = data.top_companies.map(c => c.preference_count);

        if (companyChart) companyChart.destroy();
        companyChart = new Chart(document.getElementById("companyChart"), {
          type: "bar",
          data: {
            labels: companies,
            datasets: [{ label: "å¿—é¡˜æ¬¡æ•¸", data: counts, backgroundColor: "#4e79a7" }]
          },
          options: { 
            scales: { y: { beginAtZero: true } },
            plugins: {
              legend: { display: false }
            }
          }
        });

        // å±¥æ­·ç¹³äº¤ç‡
        const resumeUploaded = data.resume_stats?.uploaded || 0;
        const resumeNotUploaded = data.resume_stats?.not_uploaded || 0;
        const resumeData = [resumeUploaded, resumeNotUploaded];
        const resumeTotal = resumeData.reduce((a, b) => a + b, 0);

        if (resumeChart) resumeChart.destroy();
        
        resumeChart = new Chart(document.getElementById("resumeChart"), {
          type: "doughnut",
          data: {
            labels: ["å·²ä¸Šå‚³", "æœªä¸Šå‚³"],
            datasets: [{ 
              data: resumeData, 
              backgroundColor: ["#59a14f", "#e15759"] 
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { 
                position: 'bottom',
                display: true
              },
              tooltip: {
                enabled: resumeTotal > 0,
                callbacks: {
                  label: function (context) {
                    const value = context.raw || 0;
                    const percent = resumeTotal > 0 ? ((value / resumeTotal) * 100).toFixed(1) + '%' : '0%';
                    return `${context.label}: ${value} (${percent})`;
                  }
                }
              }
            },
            animation: {
              animateRotate: resumeTotal > 0
            }
          },
          plugins: [{
            id: 'emptyDataPlugin',
            afterDraw: (chart) => {
              if (resumeTotal === 0) {
                const ctx = chart.ctx;
                const width = chart.width;
                const height = chart.height;
                ctx.save();
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = '14px Arial';
                ctx.fillStyle = '#666';
                ctx.fillText('ç›®å‰ç„¡è³‡æ–™', width / 2, height / 2);
                ctx.restore();
              }
            }
          }]
        });

        // å¿—é¡˜åºå¡«å¯«ç‡
        const prefFilled = data.preference_stats?.filled || 0;
        const prefNotFilled = data.preference_stats?.not_filled || 0;
        const prefData = [prefFilled, prefNotFilled];
        const prefTotal = prefData.reduce((a, b) => a + b, 0);

        if (preferenceChart) preferenceChart.destroy();
        
        preferenceChart = new Chart(document.getElementById("preferenceChart"), {
          type: "doughnut",
          data: {
            labels: ["å·²å¡«å¯«", "æœªå¡«å¯«"],
            datasets: [{ 
              data: prefData, 
              backgroundColor: ["#edc948", "#bab0ab"] 
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { 
                position: 'bottom',
                display: true
              },
              tooltip: {
                enabled: prefTotal > 0,
                callbacks: {
                  label: function (context) {
                    const value = context.raw || 0;
                    const percent = prefTotal > 0 ? ((value / prefTotal) * 100).toFixed(1) + '%' : '0%';
                    return `${context.label}: ${value} (${percent})`;
                  }
                }
              }
            },
            animation: {
              animateRotate: prefTotal > 0
            }
          },
          plugins: [{
            id: 'emptyDataPlugin',
            afterDraw: (chart) => {
              if (prefTotal === 0) {
                const ctx = chart.ctx;
                const width = chart.width;
                const height = chart.height;
                ctx.save();
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = '14px Arial';
                ctx.fillStyle = '#666';
                ctx.fillText('ç›®å‰ç„¡è³‡æ–™', width / 2, height / 2);
                ctx.restore();
              }
            }
          }]
        });
      } catch (error) {
        console.error("è¼‰å…¥çµ±è¨ˆåœ–è¡¨å¤±æ•—:", error);
        statsContainer.style.display = "none";
      }
    }

    // äº‹ä»¶ç›£è½
    document.getElementById("loadBtn").addEventListener("click", loadStudents);
    
    // ç•¶å­¸å¹´é¸æ“‡æ”¹è®Šæ™‚ï¼Œè¼‰å…¥å°æ‡‰çš„ç­ç´šåˆ—è¡¨
    document.getElementById("semesterSelect").addEventListener("change", function() {
      const semesterCode = this.value;
      loadClassesBySemester(semesterCode);
      
      // æ¸…ç©ºè¡¨æ ¼å’Œåœ–è¡¨
      document.getElementById("studentsTableBody").innerHTML = 
        '<tr><td colspan="7" class="text-center text-muted">è«‹é¸æ“‡ç­ç´šä¸¦é»æ“Šã€Œå­¸ç”Ÿè³‡æ–™ã€</td></tr>';
      const chartContainer = document.getElementById("classChartContainer");
      chartContainer.style.display = 'none';
      if (myClassChart) { 
        myClassChart.destroy(); 
        myClassChart = null; 
      }
      // æ¸…ç©ºçµ±è¨ˆåœ–è¡¨
      const statsContainer = document.getElementById("statsChartsContainer");
      statsContainer.style.display = 'none';
      if (companyChart) { companyChart.destroy(); companyChart = null; }
      if (resumeChart) { resumeChart.destroy(); resumeChart = null; }
      if (preferenceChart) { preferenceChart.destroy(); preferenceChart = null; }
    });
    
    // ç•¶ç­ç´šé¸æ“‡æ”¹è®Šæ™‚è‡ªå‹•è¼‰å…¥è³‡æ–™
    document.getElementById("classSelect").addEventListener("change", function() {
      const classId = this.value;
      if (classId !== "all") {
        loadStudents();
      } else {
        // å¦‚æœé¸æ“‡ã€Œæ‰€æœ‰ç­ç´šã€ï¼Œæ¸…ç©ºè¡¨æ ¼å’Œåœ–è¡¨
        document.getElementById("studentsTableBody").innerHTML = 
          '<tr><td colspan="7" class="text-center text-muted">è«‹é¸æ“‡ç­ç´šä¸¦é»æ“Šã€Œå­¸ç”Ÿè³‡æ–™ã€</td></tr>';
        const chartContainer = document.getElementById("classChartContainer");
        chartContainer.style.display = 'none';
        if (myClassChart) { 
          myClassChart.destroy(); 
          myClassChart = null; 
        }
        // æ¸…ç©ºçµ±è¨ˆåœ–è¡¨
        const statsContainer = document.getElementById("statsChartsContainer");
        statsContainer.style.display = 'none';
        if (companyChart) { companyChart.destroy(); companyChart = null; }
        if (resumeChart) { resumeChart.destroy(); resumeChart = null; }
        if (preferenceChart) { preferenceChart.destroy(); preferenceChart = null; }
      }
    });

    // åŒ¯å‡º Excel (æ‰€æœ‰ç­ç´š)
    document.getElementById("exportBtn").addEventListener("click", () => {
      window.location.href = `/ta/statistics/api/export_companies_stats`; // åŒ¯å‡ºæ‰€æœ‰ç­ç´šçš„çµ±è¨ˆ
    });

    // åˆå§‹è¼‰å…¥ï¼šå…ˆè¼‰å…¥å­¸å¹´åˆ—è¡¨å’Œæ‰€æœ‰ç­ç´šè³‡æ–™
    async function initialize() {
      await loadAllClasses();
      loadSemesters();
      // é è¨­é¡¯ç¤ºå…¨éƒ¨ç­ç´šçµ±è¨ˆåœ–è¡¨
      loadStatsCharts();
    }
    
    initialize();
  </script>
</body>

</html>

