<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>履歷清單</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    body {
      background-color: #f8f9fa;
    }
    .container {
      margin-top: 40px;
    }
    .table td,
    .table th {
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-4"><i class="bi bi-list-task me-2"></i>履歷清單</h2>

    <!-- 履歷表格 -->
    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>上傳時間</th>
          <th>檔案名稱</th>
          <th>狀態</th>
          <th>留言</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="resumeTableBody">
        <tr>
          <td colspan="5" class="text-center">載入中...</td>
        </tr>
      </tbody>
    </table>

    <!-- 返回上傳履歷按鈕 -->
    <a href="/upload_resume" class="btn btn-outline-secondary mt-3">
      <i class="bi bi-arrow-left me-1"></i> 返回上傳履歷
    </a>
  </div>

  <script>
    // 頁面載入後取得履歷清單
    document.addEventListener("DOMContentLoaded", function () {
      const username = localStorage.getItem("username") || "guest"; // 從 localStorage 拿使用者名稱
      fetch(`/api/get_all_resumes?username=${username}`)
        .then(res => res.json())
        .then(data => {
          const tableBody = document.getElementById('resumeTableBody');
          tableBody.innerHTML = '';

          if (!data.success) {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">${data.message || '載入失敗'}</td></tr>`;
            return;
          }

          const resumes = data.resumes.sort((a, b) => new Date(b.upload_time) - new Date(a.upload_time));

          if (resumes.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center">尚無履歷資料</td></tr>`;
            return;
          }

          resumes.forEach(resume => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${new Date(resume.upload_time).toLocaleString()}</td>
              <td>${resume.filename}</td>
              <td>${mapStatusToBadge(resume.status)}</td>
              <td>
                <div>${resume.comment || '—'}</div>
                <input class="form-control mt-1" type="text" placeholder="新增留言" 
                  onkeydown="submitComment(event, '${resume.id}')">
              </td>
              <td>
                <a href="/api/download_resume?resume_id=${resume.id}" class="btn btn-outline-primary btn-sm">
                  <i class="bi bi-download"></i> 下載
                </a>
              </td>
            `;
            tableBody.appendChild(row);
          });
        })
        .catch(err => {
          console.error(err);
          document.getElementById('resumeTableBody').innerHTML =
            `<tr><td colspan="5" class="text-center text-danger">載入失敗</td></tr>`;
        });
    });

    // 狀態轉換為 Bootstrap badge
    function mapStatusToBadge(status) {
      switch (status) {
        case 'uploaded': return '<span class="badge bg-info">已上傳</span>';
        case 'reviewing': return '<span class="badge bg-warning text-dark">審查中</span>';
        case 'completed': return '<span class="badge bg-success">完成</span>';
        case 'rejected': return '<span class="badge bg-danger">退件</span>';
        default: return '<span class="badge bg-secondary">未知</span>';
      }
    }

    // 提交留言
    function submitComment(event, resumeId) {
      if (event.key === 'Enter') {
        const comment = event.target.value.trim();
        if (!comment) return;
        fetch('/api/submit_comment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ resume_id: resumeId, comment })
        }).then(res => {
          if (res.ok) {
            alert('留言成功');
            location.reload(); // 重新整理
          }
        });
      }
    }
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
