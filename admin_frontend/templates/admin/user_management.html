<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>用戶管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .table thead th {
            background-color: #0d6efd;
            color: white;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h2 class="mb-4">用戶管理</h2>
        <table class="table table-bordered table-hover align-middle">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>帳號</th>
                    <th>姓名</th>
                    <th>Email</th>
                    <th>角色</th>
                    <th>所屬班級</th>
                    <th>科系</th>
                    <th>帶班</th>
                    <th>建立時間</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="userTableBody"></tbody>
        </table>
    </div>

    <!-- 編輯用戶 Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">編輯用戶</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="mb-3">
                            <label class="form-label">帳號</label>
                            <input type="text" id="editUsername" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">姓名</label>
                            <input type="text" id="editName" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" id="editEmail" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">角色</label>
                            <select id="editRole" class="form-select" required>
                                <option value="student">學生</option>
                                <option value="teacher">教師</option>
                                <option value="director">主任</option>
                                <option value="admin">管理員</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">新密碼 (如不修改可留空)</label>
                            <input type="password" id="editPassword" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">所屬班級 ID (學生才需要)</label>
                            <input type="number" id="editClassId" class="form-control">
                        </div>
                        <button type="submit" class="btn btn-primary">儲存</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const roleMap = {
            student: '學生',
            teacher: '教師',
            director: '主任',
            admin: '管理員'
        };

        async function loadUsers() {
            try {
                const res = await fetch('/admin/api/get_all_users');
                const data = await res.json();
                if (!data.success) {
                    alert("載入失敗：" + data.message);
                    return;
                }

                const tbody = document.getElementById('userTableBody');
                tbody.innerHTML = "";

                data.users.forEach(user => {
                    const tr = document.createElement('tr');

                    tr.innerHTML = `
            <td>${user.id}</td>
            <td>${user.username}</td>
            <td>${user.name || ''}</td>
            <td>${user.email || ''}</td>
            <td>${roleMap[user.role] || user.role}</td>
            <td>${user.role === 'student' ? (user.class_name || '-') : '-'}</td>
            <td>${user.role === 'student' ? (user.department || '-') : '-'}</td>
            <td>${['teacher', 'director'].includes(user.role) ? (user.teaching_classes || '-') : '-'}</td>
            <td>${user.created_at || ''}</td>
            <td>
              <button class="btn btn-sm btn-warning" onclick="openEditModal(${user.id}, '${user.username}', '${user.name || ''}', '${user.email || ''}', '${user.role}', '${user.class_id || ''}')">編輯</button>
              <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">刪除</button>
            </td>
          `;

                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error("載入用戶錯誤：", err);
                alert("載入用戶失敗");
            }
        }

        // 打開編輯 Modal
        function openEditModal(id, username, name, email, role, classId) {
            const roleSelect = document.getElementById('editRole');
            const roleGroup = roleSelect.closest('.mb-3');
            const classIdInput = document.getElementById('editClassId');
            const classIdGroup = classIdInput.closest('.mb-3');

            // 重置角色選單
            roleSelect.innerHTML = '';

            // 根據角色控制角色選單內容與是否可修改
            if (role === 'teacher' || role === 'director') {
                // 教師與主任可選擇教師/主任
                roleSelect.disabled = false;
                ['teacher', 'director'].forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r;
                    opt.textContent = roleMap[r];
                    if (r === role) opt.selected = true;
                    roleSelect.appendChild(opt);
                });
            } else {
                // 學生與管理員不可修改角色
                const opt = document.createElement('option');
                opt.value = role;
                opt.textContent = roleMap[role] || role;
                opt.selected = true;
                roleSelect.appendChild(opt);
                roleSelect.disabled = true;
            }

            // 根據角色顯示/隱藏班級欄位
            if (role === 'student') {
                classIdGroup.style.display = '';
                classIdInput.value = classId || '';
            } else {
                classIdGroup.style.display = 'none';
                classIdInput.value = '';
            }

            // 填入其他欄位資料
            document.getElementById('editUserId').value = id;
            document.getElementById('editUsername').value = username;
            document.getElementById('editName').value = name;
            document.getElementById('editEmail').value = email;
            document.getElementById('editPassword').value = "";

            new bootstrap.Modal(document.getElementById('editUserModal')).show();
        }


        // 編輯用戶送出
        document.getElementById('editUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('editUserId').value;
            const payload = {
                username: document.getElementById('editUsername').value,
                name: document.getElementById('editName').value,
                email: document.getElementById('editEmail').value,
                role: document.getElementById('editRole').value,
                password: document.getElementById('editPassword').value,
                class_id: document.getElementById('editClassId').value || null
            };

            const res = await fetch(`/admin/api/update_user/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            alert(data.message);
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                loadUsers();
            }
        });

        // 刪除用戶
        async function deleteUser(id) {
            if (!confirm("確定要刪除這個用戶嗎？")) return;

            const res = await fetch(`/admin/api/delete_user/${id}`, { method: 'DELETE' });
            const data = await res.json();
            alert(data.message);
            if (data.success) {
                loadUsers();
            }
        }

        document.addEventListener('DOMContentLoaded', loadUsers);
    </script>
</body>

</html>