<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ç”¨æˆ¶ç®¡ç†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .table thead th {
            background-color: #0d6efd;
            color: white;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h2 class="mb-3">ç”¨æˆ¶ç®¡ç†</h2>
        <div class="d-flex gap-2 mb-3 flex-wrap">
            <input type="text" id="searchUsername" class="form-control w-auto" placeholder="æœå°‹å¸³è™Ÿ">
            <button class="btn btn-primary" onclick="searchUsers()">æœå°‹</button>
            <button class="btn btn-secondary" onclick="resetSearch()">é‡ç½®</button>
            <button class="btn btn-success ms-auto" onclick="openCreateModal()">æ–°å¢ç”¨æˆ¶</button>
        </div>
        <table class="table table-bordered table-hover align-middle">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>å¸³è™Ÿ</th>
                    <th>å§“å</th>
                    <th>Email</th>
                    <th>è§’è‰²</th>
                    <th>æ‰€å±¬ç­ç´š</th>
                    <th>ç§‘ç³»</th>
                    <th>å¸¶ç­</th>
                    <th>å»ºç«‹æ™‚é–“</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="userTableBody"></tbody>
        </table>
    </div>

    <!-- ç·¨è¼¯ç”¨æˆ¶ Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ç·¨è¼¯ç”¨æˆ¶</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="mb-3">
                            <label class="form-label">å¸³è™Ÿ</label>
                            <input type="text" id="editUsername" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">å§“å</label>
                            <input type="text" id="editName" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" id="editEmail" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">è§’è‰²</label>
                            <select id="editRole" class="form-select" required></select>
                        </div>
                        <div class="mb-3" id="editClassIdGroup" style="display: none;">
                            <label class="form-label">ç­ç´š</label>
                            <select id="editClassId" class="form-select"></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">å¯†ç¢¼ï¼ˆç•™ç©ºè¡¨ç¤ºä¸è®Šæ›´ï¼‰</label>
                            <input type="password" id="editPassword" class="form-control">
                        </div>
                </div>
                <button type="submit" class="btn btn-primary">å„²å­˜</button>
            </div>
        </div>
    </div>
    </div>

    <!-- æ–°å¢ç”¨æˆ¶ Modal -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ–°å¢ç”¨æˆ¶</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createUserForm">
                        <div class="mb-3">
                            <label class="form-label">å¸³è™Ÿ</label>
                            <input type="text" id="createUsername" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">å¯†ç¢¼</label>
                            <input type="password" id="createPassword" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">å§“å</label>
                            <input type="text" id="createName" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" id="createEmail" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">è§’è‰²</label>
                            <select id="createRole" class="form-select" required>
                                <option value="student">å­¸ç”Ÿ</option>
                                <option value="teacher">æ•™å¸«</option>
                                <option value="director">ä¸»ä»»</option>
                                <option value="ta">ç§‘åŠ©</option>
                                <option value="admin">ç®¡ç†å“¡</option>
                            </select>
                        </div>
                        <!-- ğŸ”§ã€1ã€‘æ–°å¢ç­ç´šæ¬„ä½ -->
                        <div class="mb-3" id="createClassIdGroup" style="display: none;">
                            <label class="form-label">ç­ç´š</label>
                            <select id="createClassId" class="form-select"></select>
                        </div>
                        <button type="submit" class="btn btn-primary">æ–°å¢</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- è¨­å®šå¸¶ç­ Modal -->
    <div class="modal fade" id="assignTeacherClassModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">è¨­å®šå¸¶ç­</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="assignTeacherId">
                    <div class="mb-3">
                        <label class="form-label">å¸¶ç­è§’è‰²</label>
                        <select id="assignTeacherRole" class="form-select">
                            <option value="ç­å°å¸«">ç­å°å¸«</option>
                            <option value="ä¸»ä»»">ä¸»ä»»</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ç­ç´š</label>
                        <select id="assignTeacherClassSelect" class="form-select"></select>
                    </div>
                    <button class="btn btn-primary" onclick="submitAssignTeacherClass()">å„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è¨­å®šå­¸ç”Ÿç­ç´š Modal -->
    <div class="modal fade" id="assignStudentClassModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">è¨­å®šå­¸ç”Ÿç­ç´š</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="assignStudentId">
                    <div class="mb-3">
                        <label class="form-label">ç­ç´š</label>
                        <select id="assignStudentClassSelect" class="form-select"></select>
                    </div>
                    <button class="btn btn-primary" onclick="submitAssignStudentClass()">å„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const roleMap = {
            student: 'å­¸ç”Ÿ',
            teacher: 'æ•™å¸«',
            director: 'ä¸»ä»»',
            ta: 'ç§‘åŠ©',
            admin: 'ç®¡ç†å“¡'
        };

        async function loadUsers() {
            try {
                const res = await fetch('/admin/api/get_all_users');
                const data = await res.json();
                if (!data.success) {
                    alert("è¼‰å…¥å¤±æ•—ï¼š" + data.message);
                    return;
                }

                const tbody = document.getElementById('userTableBody');
                tbody.innerHTML = "";

                data.users.forEach(user => {
                    const tr = document.createElement('tr');

                    tr.innerHTML = `
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${user.name || ''}</td>
                        <td>${user.email || ''}</td>
                        <td>${roleMap[user.role] || user.role}</td>
                        <td>${user.role === 'student' ? (user.class_name || '-') : '-'}</td>
                        <td>${user.role === 'student' ? (user.department || '-') : '-'}</td>
                        <td>${['teacher', 'director'].includes(user.role) ? (user.teaching_classes || '-') : '-'}</td>
                        <td>${user.created_at || ''}</td>
                        <td>
                          <button class="btn btn-sm btn-warning" onclick="openEditModal(${user.id}, '${user.username}', '${user.name || ''}', '${user.email || ''}', '${user.role}', '${user.class_id || ''}')">ç·¨è¼¯</button>
                          <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">åˆªé™¤</button>
                          ${user.role === 'student' ? `<button class="btn btn-sm btn-outline-primary" onclick="openAssignStudentClass(${user.id})">è¨­å®šç­ç´š</button>` : ''}
                          ${['teacher', 'director'].includes(user.role) ? `<button class="btn btn-sm btn-outline-secondary" onclick="openAssignTeacherClass(${user.id})">è¨­å®šå¸¶ç­</button>` : ''}
                        </td>
                    `;

                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error("è¼‰å…¥ç”¨æˆ¶éŒ¯èª¤ï¼š", err);
                alert("è¼‰å…¥ç”¨æˆ¶å¤±æ•—");
            }
        }

        async function searchUsers() {
            const username = document.getElementById('searchUsername').value.trim();

            const params = new URLSearchParams();
            if (username) params.append('username', username);

            const res = await fetch('/admin/api/search_users?' + params.toString());
            const data = await res.json();
            if (!data.success) { alert('æœå°‹å¤±æ•—'); return; }

            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';
            data.users.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.name || ''}</td>
                    <td>${user.email || ''}</td>
                    <td>${roleMap[user.role] || user.role}</td>
                    <td>${user.role === 'student' ? (user.class_name || '-') : '-'}</td>
                    <td>${user.role === 'student' ? (user.department || '-') : '-'}</td>
                    <td>${['teacher', 'director'].includes(user.role) ? (user.teaching_classes || '-') : '-'}</td>
                    <td>${user.created_at || ''}</td>
                    <td>
                      <button class="btn btn-sm btn-warning" onclick="openEditModal(${user.id}, '${user.username}', '${user.name || ''}', '${user.email || ''}', '${user.role}', '${user.class_id || ''}')">ç·¨è¼¯</button>
                      <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">åˆªé™¤</button>
                    </td>`;
                tbody.appendChild(tr);
            });
        }

        function resetSearch() {
            document.getElementById('searchUsername').value = '';
            loadUsers();
        }

        // ğŸ”§ã€2ã€‘openCreateModalï¼Œå­¸ç”Ÿé¡¯ç¤ºç­ç´šä¸¦è¼‰å…¥
        function openCreateModal() {
            const roleSelect = document.getElementById('createRole');
            const classGroup = document.getElementById('createClassIdGroup');
            const classSelect = document.getElementById('createClassId');

            // é è¨­é¸æ“‡ç¬¬ä¸€å€‹è§’è‰²
            roleSelect.selectedIndex = 0;

            roleSelect.onchange = () => {
                const isStudent = roleSelect.value === 'student';
                classGroup.style.display = isStudent ? '' : 'none';
                if (isStudent) loadClasses(classSelect);
            };

            // è§¸ç™¼ä¸€æ¬¡ä»¥å¥—ç”¨é¡¯ç¤ºé‚è¼¯
            roleSelect.dispatchEvent(new Event('change'));

            new bootstrap.Modal(document.getElementById('createUserModal')).show();
        }
        
        // ğŸ”§ã€4ã€‘openEditModalï¼Œå­¸ç”Ÿé¡¯ç¤ºç­ç´šé¸é …ä¸¦è¼‰å…¥
        function openEditModal(id, username, name, email, role, classId) {
            const roleSelect = document.getElementById('editRole');
            const classIdInput = document.getElementById('editClassId');
            const classIdGroup = document.getElementById('editClassIdGroup');

            roleSelect.innerHTML = '';

            if (role === 'teacher' || role === 'director') {
                roleSelect.disabled = false;
                ['teacher', 'director'].forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r;
                    opt.textContent = roleMap[r];
                    if (r === role) opt.selected = true;
                    roleSelect.appendChild(opt);
                });
            } else {
                const opt = document.createElement('option');
                opt.value = role;
                opt.textContent = roleMap[role] || role;
                opt.selected = true;
                roleSelect.appendChild(opt);
                roleSelect.disabled = true;
            }

            if (role === 'student') {
                classIdGroup.style.display = '';
                loadClasses(classIdInput).then(() => {
                    classIdInput.value = classId || '';
                });
            } else {
                classIdGroup.style.display = 'none';
                classIdInput.value = '';
            }

            document.getElementById('editUserId').value = id;
            document.getElementById('editUsername').value = username;
            document.getElementById('editName').value = name;
            document.getElementById('editEmail').value = email;
            document.getElementById('editPassword').value = "";

            new bootstrap.Modal(document.getElementById('editUserModal')).show();
        }

        // ç·¨è¼¯ç”¨æˆ¶é€å‡º
        document.getElementById('editUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('editUserId').value;
            const payload = {
                username: document.getElementById('editUsername').value,
                name: document.getElementById('editName').value,
                email: document.getElementById('editEmail').value,
                role: document.getElementById('editRole').value,
                password: document.getElementById('editPassword').value,
                class_id: document.getElementById('editClassId').value || null
            };

            const res = await fetch(`/admin/api/update_user/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            alert(data.message);
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                loadUsers();
            }
        });

        // åˆªé™¤ç”¨æˆ¶
        async function deleteUser(id) {
            if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹ç”¨æˆ¶å—ï¼Ÿ")) return;

            const res = await fetch(`/admin/api/delete_user/${id}`, { method: 'DELETE' });
            const data = await res.json();
            alert(data.message);
            if (data.success) {
                loadUsers();
            }
        }

        document.addEventListener('DOMContentLoaded', loadUsers);

        async function loadClasses(selectEl) {
            const res = await fetch('/admin/api/get_all_classes');
            const data = await res.json();
            if (!data.success) { alert('è¼‰å…¥ç­ç´šå¤±æ•—'); return; }
            selectEl.innerHTML = '';
            data.classes.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = `${c.department || ''} ${c.name}`.trim();
                selectEl.appendChild(opt);
            });
        }

        function openAssignStudentClass(userId) {
            document.getElementById('assignStudentId').value = userId;
            const sel = document.getElementById('assignStudentClassSelect');
            loadClasses(sel);
            new bootstrap.Modal(document.getElementById('assignStudentClassModal')).show();
        }

        async function submitAssignStudentClass() {
            const user_id = document.getElementById('assignStudentId').value;
            const class_id = document.getElementById('assignStudentClassSelect').value;
            const res = await fetch('/admin/api/assign_student_class', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id, class_id }) });
            const data = await res.json();
            alert(data.message);
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('assignStudentClassModal')).hide();
                loadUsers();
            }
        }

        function openAssignTeacherClass(userId) {
            document.getElementById('assignTeacherId').value = userId;
            const sel = document.getElementById('assignTeacherClassSelect');
            const roleSel = document.getElementById('assignTeacherRole');
            loadClasses(sel);
            roleSel.value = 'ç­å°å¸«';
            new bootstrap.Modal(document.getElementById('assignTeacherClassModal')).show();
        }

        async function submitAssignTeacherClass() {
            const teacher_id = document.getElementById('assignTeacherId').value;
            const class_id = document.getElementById('assignTeacherClassSelect').value;
            const role = document.getElementById('assignTeacherRole').value;
            const res = await fetch('/admin/api/assign_class_teacher', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ teacher_id, class_id, role }) });
            const data = await res.json();
            alert(data.message);
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('assignTeacherClassModal')).hide();
                loadUsers();
            }
        }
    </script>
</body>

</html>