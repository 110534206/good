<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>å¹³å°ç¯„æœ¬ç®¡ç†ä»‹é¢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            font-family: "Noto Sans TC", sans-serif;
            background: #f7f9fc;
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .upload-form {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¦ å¹³å°ç¯„æœ¬ç¶­è­·ä¸­å¿ƒ</h1>
        <p class="text-muted">
            ç§‘åŠ©å¯ä»¥åœ¨æ­¤ç®¡ç† Word æ–‡ä»¶ç¯„æœ¬ã€‚å­¸ç”Ÿå±¥æ­·ç”Ÿæˆæ™‚ï¼Œæœƒä½¿ç”¨æ­¤è™•è¨­å®šç‚º**ã€Œå•Ÿç”¨ä¸­ã€**çš„ç¯„æœ¬ï¼Œ**ç¯„æœ¬å…§å®¹ï¼ˆå¦‚æ ¸å¿ƒç§‘ç›®åˆ—è¡¨ï¼‰èˆ‡æ ¼å¼å°‡èˆ‡ç¯„æœ¬æª”æ¡ˆåŒæ­¥æ›´æ–°ã€‚**
        </p>

        <ul class="nav nav-tabs" id="templateTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="resume-tab" data-bs-toggle="tab" data-bs-target="#resume-pane" type="button" role="tab" data-type="resume">å¯¦ç¿’å±¥æ­·ç¯„æœ¬ (.docx)</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="preference-tab" data-bs-toggle="tab" data-bs-target="#preference-pane" type="button" role="tab" data-type="preference">å¿—é¡˜åºç¯„æœ¬ (.docx)</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="company-tab" data-bs-toggle="tab" data-bs-target="#company-pane" type="button" role="tab" data-type="company">å¯¦ç¿’å…¬å¸ä»‹ç´¹ç¯„æœ¬ (.docx)</button>
            </li>
        </ul>

        <div class="tab-content border border-top-0 p-3" id="templateTabContent">
            <div class="tab-pane fade show active" id="resume-pane" role="tabpanel" tabindex="0"></div>
            <div class="tab-pane fade" id="preference-pane" role="tabpanel" tabindex="0"></div>
            <div class="tab-pane fade" id="company-pane" role="tabpanel" tabindex="0"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const TEMPLATE_TYPES = ['resume', 'preference', 'company'];

        document.addEventListener('DOMContentLoaded', () => {
            // åˆå§‹åŒ–æ™‚è¼‰å…¥ç¬¬ä¸€å€‹ Tab çš„å…§å®¹
            renderTabContent('resume'); 
            
            // ç¶å®š Tab åˆ‡æ›äº‹ä»¶ï¼Œåœ¨åˆ‡æ›æ™‚æ¸²æŸ“å°æ‡‰çš„å…§å®¹
            const tabEl = document.getElementById('templateTabs');
            tabEl.addEventListener('shown.bs.tab', (event) => {
                const type = event.target.getAttribute('data-type');
                renderTabContent(type);
            });
        });
        
        // =======================================================
        // æ¸²æŸ“ Tab å…§å®¹çš„å‡½å¼
        // =======================================================
        function renderTabContent(type) {
            const pane = document.getElementById(`${type}-pane`);
            
            // æ¸²æŸ“ä¸Šå‚³è¡¨å–®å’Œæ­·å²åˆ—è¡¨çš„æ¡†æ¶
            pane.innerHTML = `
                <div class="card my-4">
                    <div class="card-header">ä¸Šå‚³æ–°çš„ ${type} ç¯„æœ¬ (.docx)</div>
                    <div class="card-body">
                        <form class="upload-form" data-type="${type}" enctype="multipart/form-data">
                            <div class="col-md-4">
                                <label for="displayName-${type}" class="form-label">ç¯„æœ¬åç¨± (æ–¹ä¾¿è­˜åˆ¥)</label>
                                <input type="text" class="form-control" id="displayName-${type}" name="display_name" required placeholder="ä¾‹å¦‚ï¼š114å¹´åº¦æœ€æ–°å±¥æ­·æ ¼å¼">
                            </div>
                            <div class="col-md-5">
                                <label for="fileInput-${type}" class="form-label">é¸æ“‡æª”æ¡ˆ</label>
                                <input class="form-control" type="file" id="fileInput-${type}" name="file" accept=".docx" required>
                                <input type="hidden" name="template_type" value="${type}">
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary w-100">ä¸Šå‚³ä¸¦æ–°å¢</button>
                            </div>
                        </form>
                    </div>
                </div>
                <h3>${type} æ­·å²ç‰ˆæœ¬</h3>
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>åç¨±</th>
                            <th>ä¸Šå‚³æ™‚é–“</th>
                            <th>ç‹€æ…‹</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="templateListBody-${type}">
                        <tr><td colspan="5" class="text-center text-muted">è¼‰å…¥ä¸­...</td></tr>
                    </tbody>
                </table>
            `;
            
            // ç¶å®šä¸Šå‚³è¡¨å–®äº‹ä»¶
            pane.querySelector('.upload-form').addEventListener('submit', handleUpload);
            // è¼‰å…¥æ­·å²ç‰ˆæœ¬
            loadTemplates(type);
        }

        // =======================================================
        // è™•ç†ç¯„æœ¬ä¸Šå‚³ (POST /api/admin/templates)
        // =======================================================
        async function handleUpload(e) {
            e.preventDefault();
            const form = e.target;
            const type = form.getAttribute('data-type');
            
            const formData = new FormData(form);

            try {
                const res = await fetch('/api/admin/templates', {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                
                alert(result.message);
                if (result.success) {
                    form.reset();
                    loadTemplates(type);
                }
            } catch (error) {
                alert('ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æª”æ¡ˆå¤§å°ã€‚');
            }
        }
        
        // =======================================================
        // è¼‰å…¥æ­·å²ç¯„æœ¬åˆ—è¡¨ (GET /api/admin/templates/<type>)
        // =======================================================
        async function loadTemplates(type) {
            const tbody = document.getElementById(`templateListBody-${type}`);
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">è¼‰å…¥ä¸­...</td></tr>';
            
            try {
                const res = await fetch(`/api/admin/templates/${type}`);
                const data = await res.json();
                
                tbody.innerHTML = '';
                if (data.success && data.templates && data.templates.length > 0) {
                    data.templates.forEach(t => {
                        const row = tbody.insertRow();
                        const statusHtml = t.is_active 
                            ? '<span class="badge bg-success">å•Ÿç”¨ä¸­</span>' 
                            : '<span class="badge bg-secondary">æœªå•Ÿç”¨</span>';
                        
                        // ç¢ºä¿æ—¥æœŸæ ¼å¼æ­£ç¢ºé¡¯ç¤º (åªéœ€æ—¥æœŸéƒ¨åˆ†)
                        const uploadDate = t.uploaded_at ? t.uploaded_at.split('T')[0] : '';

                        row.innerHTML = `
                            <td>${t.id}</td>
                            <td>${t.display_name}</td>
                            <td>${uploadDate}</td>
                            <td>${statusHtml}</td>
                            <td>
                                ${!t.is_active 
                                    ? `<button class="btn btn-sm btn-warning activate-btn me-2" data-id="${t.id}" data-type="${type}">åˆ‡æ›å•Ÿç”¨</button>` 
                                    : `<button class="btn btn-sm btn-secondary me-2" disabled>å·²å•Ÿç”¨</button>`}
                                <a href="/api/download_template/${t.id}" class="btn btn-sm btn-outline-info" target="_blank" title="ä¸‹è¼‰æ­¤ç‰ˆæœ¬">ä¸‹è¼‰</a>
                            </td>
                        `;
                    });
                    
                    // ç¶å®šå•Ÿç”¨æŒ‰éˆ•äº‹ä»¶
                    tbody.querySelectorAll('.activate-btn').forEach(btn => {
                        btn.addEventListener('click', handleActivate);
                    });
                    
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">å°šç„¡ç¯„æœ¬ç‰ˆæœ¬</td></tr>';
                }
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">è¼‰å…¥ç¯„æœ¬åˆ—è¡¨å¤±æ•—</td></tr>';
            }
        }
        
        // =======================================================
        // è™•ç†ç¯„æœ¬å•Ÿç”¨åˆ‡æ› (POST /api/admin/templates/activate)
        // =======================================================
        async function handleActivate(e) {
            const btn = e.target;
            const id = btn.getAttribute('data-id');
            const type = btn.getAttribute('data-type');
            
            if (!confirm(`ç¢ºèªå°‡ ${type} ç¯„æœ¬åˆ‡æ›åˆ° ID ${id} çš„ç‰ˆæœ¬å—ï¼Ÿæ­¤æ“ä½œæœƒç«‹å³ç”Ÿæ•ˆã€‚`)) return;

            try {
                const res = await fetch('/api/admin/templates/activate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id, template_type: type })
                });
                const result = await res.json();
                
                alert(result.message);
                if (result.success) {
                    loadTemplates(type); // é‡æ–°è¼‰å…¥ç•¶å‰ Tab å…§å®¹
                }
            } catch (error) {
                 alert('åˆ‡æ›å•Ÿç”¨å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
            }
        }
    </script>
</body>
</html>